<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Merge remote-tracking branch &#39;upstream/dev&#39; into dev - SE-Extended - SE Extended is a fork from the original SnapEnhance app offering an enhanced Snapchat experience
</title>
<link rel="icon" type="image/svg+xml" href="../../logo.png"/>
<link rel="alternate icon" href="../../favicon.png"/>
<link rel="alternate" type="application/atom+xml" title="SE-Extended Atom Feed" href="../atom.xml" />
<link rel="alternate" type="application/atom+xml" title="SE-Extended Atom Feed (tags)" href="../tags.xml" />
<link rel="stylesheet" type="text/css" href="../../style.css" />
<link rel="stylesheet" type="text/css" href="../../fonts.css" />
</head>
<body>
<div id="head"><table><tr><td><a class="logo" href="../../"><img src="../../logo.png" alt="" width="32" height="32" /></a></td><td><strong>SE-Extended</strong><span class="desc"> - SE Extended is a fork from the original SnapEnhance app offering an enhanced Snapchat experience
</span>
</td></tr></table>
<p><a href="../about.html">About</a> | <a href="../log.html">Log</a> | <a href="../files.html">Files</a> | <a href="../refs.html">Refs</a> | <a href="../file/.gitmodules.html">Submodules</a> | <a href="../file/LICENSE.html">License</a></p>
</div>
<hr/>
<div id="content">
<pre><b>commit</b> <a href="../commit/68c16fa0b7b7e2f8fd8638617dae298f0a0c5b04.html">68c16fa0b7b7e2f8fd8638617dae298f0a0c5b04</a>
<b>parent</b> <a href="../commit/a121fa96fea578d879a8908beab91c19abbb7d86.html">a121fa96fea578d879a8908beab91c19abbb7d86</a>
<b>Author:</b> Jacob Thomas &lt;<a href="mailto:41988041+bocajthomas@users.noreply.github.com">41988041+bocajthomas@users.noreply.github.com</a>&gt;
<b>Date:</b>   Fri, 19 Jul 2024 21:10:23 +0100

Merge remote-tracking branch &#39;upstream/dev&#39; into dev

<b>Diffstat:</b>
<table><tr><td class="M">M</td><td><a href="#h0">app/src/main/kotlin/me/rhunk/snapenhance/RemoteFileHandleManager.kt</a></td><td> | </td><td class="num">24</td><td><span class="i">++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h1">app/src/main/kotlin/me/rhunk/snapenhance/RemoteSharedLibraryManager.kt</a></td><td> | </td><td class="num">85</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="M">M</td><td><a href="#h2">app/src/main/kotlin/me/rhunk/snapenhance/RemoteSideContext.kt</a></td><td> | </td><td class="num">8</td><td><span class="i">++++++++</span><span class="d"></span></td></tr>
<tr><td class="M">M</td><td><a href="#h3">app/src/main/kotlin/me/rhunk/snapenhance/action/EnumQuickActions.kt</a></td><td> | </td><td class="num">4</td><td><span class="i">++++</span><span class="d"></span></td></tr>
<tr><td class="M">M</td><td><a href="#h4">app/src/main/kotlin/me/rhunk/snapenhance/storage/AppDatabase.kt</a></td><td> | </td><td class="num">13</td><td><span class="i">+++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h5">app/src/main/kotlin/me/rhunk/snapenhance/storage/Repositories.kt</a></td><td> | </td><td class="num">34</td><td><span class="i">++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h6">app/src/main/kotlin/me/rhunk/snapenhance/storage/Theming.kt</a></td><td> | </td><td class="num">126</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="M">M</td><td><a href="#h7">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/Routes.kt</a></td><td> | </td><td class="num">7</td><td><span class="i">+++++++</span><span class="d"></span></td></tr>
<tr><td class="M">M</td><td><a href="#h8">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/pages/LoggerHistoryRoot.kt</a></td><td> | </td><td class="num">10</td><td><span class="i">++</span><span class="d">--------</span></td></tr>
<tr><td class="A">A</td><td><a href="#h9">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/pages/ManageReposSection.kt</a></td><td> | </td><td class="num">191</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="M">M</td><td><a href="#h10">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/pages/features/FeaturesRootSection.kt</a></td><td> | </td><td class="num">43</td><td><span class="i">+++++++++++++++++</span><span class="d">--------------------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h11">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/pages/home/HomeSettings.kt</a></td><td> | </td><td class="num">5</td><td><span class="i">++++</span><span class="d">-</span></td></tr>
<tr><td class="M">M</td><td><a href="#h12">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/pages/scripting/ScriptingRootSection.kt</a></td><td> | </td><td class="num">12</td><td><span class="i">+++++++</span><span class="d">-----</span></td></tr>
<tr><td class="A">A</td><td><a href="#h13">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/pages/theming/EditThemeSection.kt</a></td><td> | </td><td class="num">394</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h14">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/pages/theming/ThemeCatalog.kt</a></td><td> | </td><td class="num">273</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h15">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/pages/theming/ThemingRoot.kt</a></td><td> | </td><td class="num">464</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="M">M</td><td><a href="#h16">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/pages/tracker/LogsTab.kt</a></td><td> | </td><td class="num">9</td><td><span class="i">++++++</span><span class="d">---</span></td></tr>
<tr><td class="M">M</td><td><a href="#h17">app/src/main/kotlin/me/rhunk/snapenhance/ui/setup/Requirements.kt</a></td><td> | </td><td class="num">22</td><td><span class="i">++++++</span><span class="d">----------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h18">app/src/main/kotlin/me/rhunk/snapenhance/ui/setup/SetupActivity.kt</a></td><td> | </td><td class="num">8</td><td><span class="i">++++</span><span class="d">----</span></td></tr>
<tr><td class="A">A</td><td><a href="#h19">app/src/main/kotlin/me/rhunk/snapenhance/ui/setup/screens/impl/SecurityScreen.kt</a></td><td> | </td><td class="num">87</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="M">M</td><td><a href="#h20">app/src/main/kotlin/me/rhunk/snapenhance/ui/util/AlertDialogs.kt</a></td><td> | </td><td class="num">34</td><td><span class="i">++++++++++++++++++++++++++</span><span class="d">--------</span></td></tr>
<tr><td class="A">A</td><td><a href="#h21">app/src/main/kotlin/me/rhunk/snapenhance/ui/util/ColorPicker.kt</a></td><td> | </td><td class="num">28</td><td><span class="i">++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="M">M</td><td><a href="#h22">common/src/main/kotlin/me/rhunk/snapenhance/common/bridge/BridgeFiles.kt</a></td><td> | </td><td class="num">7</td><td><span class="i">++++</span><span class="d">---</span></td></tr>
<tr><td class="M">M</td><td><a href="#h23">common/src/main/kotlin/me/rhunk/snapenhance/common/bridge/wrapper/LoggerWrapper.kt</a></td><td> | </td><td class="num">2</td><td><span class="i">+</span><span class="d">-</span></td></tr>
<tr><td class="M">M</td><td><a href="#h24">common/src/main/kotlin/me/rhunk/snapenhance/common/config/ModConfig.kt</a></td><td> | </td><td class="num">2</td><td><span class="i">+</span><span class="d">-</span></td></tr>
<tr><td class="M">M</td><td><a href="#h25">common/src/main/kotlin/me/rhunk/snapenhance/common/config/impl/Experimental.kt</a></td><td> | </td><td class="num">3</td><td><span class="i">+</span><span class="d">--</span></td></tr>
<tr><td class="A">A</td><td><a href="#h26">common/src/main/kotlin/me/rhunk/snapenhance/common/data/ThemingObjects.kt</a></td><td> | </td><td class="num">120</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h27">common/src/main/kotlin/me/rhunk/snapenhance/common/ui/TextFieldColors.kt</a></td><td> | </td><td class="num">17</td><td><span class="i">+++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="M">M</td><td><a href="#h28">common/src/main/kotlin/me/rhunk/snapenhance/common/util/ktx/AndroidCompatExtensions.kt</a></td><td> | </td><td class="num">19</td><td><span class="i">+++++++++++++++++</span><span class="d">--</span></td></tr>
<tr><td class="M">M</td><td><a href="#h29">core/src/main/kotlin/me/rhunk/snapenhance/core/ModContext.kt</a></td><td> | </td><td class="num">6</td><td><span class="i">++</span><span class="d">----</span></td></tr>
<tr><td class="M">M</td><td><a href="#h30">core/src/main/kotlin/me/rhunk/snapenhance/core/features/BridgeFileFeature.kt</a></td><td> | </td><td class="num">2</td><td><span class="i">+</span><span class="d">-</span></td></tr>
<tr><td class="M">M</td><td><a href="#h31">core/src/main/kotlin/me/rhunk/snapenhance/core/features/Feature.kt</a></td><td> | </td><td class="num">46</td><td><span class="i">++++++++++++++++++++++++++</span><span class="d">--------------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h32">core/src/main/kotlin/me/rhunk/snapenhance/core/features/FeatureManager.kt</a></td><td> | </td><td class="num">81</td><td><span class="i">+++++++++++++++++++++++++++</span><span class="d">-----------------------------------------------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h33">core/src/main/kotlin/me/rhunk/snapenhance/core/features/MessagingRuleFeature.kt</a></td><td> | </td><td class="num">2</td><td><span class="i">+</span><span class="d">-</span></td></tr>
<tr><td class="M">M</td><td><a href="#h34">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/COFOverride.kt</a></td><td> | </td><td class="num">4</td><td><span class="i">++</span><span class="d">--</span></td></tr>
<tr><td class="M">M</td><td><a href="#h35">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/ConfigurationOverride.kt</a></td><td> | </td><td class="num">4</td><td><span class="i">++</span><span class="d">--</span></td></tr>
<tr><td class="M">M</td><td><a href="#h36">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/FriendMutationObserver.kt</a></td><td> | </td><td class="num">4</td><td><span class="i">++</span><span class="d">--</span></td></tr>
<tr><td class="M">M</td><td><a href="#h37">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/MixerStories.kt</a></td><td> | </td><td class="num">4</td><td><span class="i">++</span><span class="d">--</span></td></tr>
<tr><td class="M">M</td><td><a href="#h38">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/OperaViewerParamsOverride.kt</a></td><td> | </td><td class="num">57</td><td><span class="i">+++++++++++++++++++++++++++++</span><span class="d">----------------------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h39">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/ScopeSync.kt</a></td><td> | </td><td class="num">3</td><td><span class="i">+</span><span class="d">--</span></td></tr>
<tr><td class="M">M</td><td><a href="#h40">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/downloader/MediaDownloader.kt</a></td><td> | </td><td class="num">76</td><td><span class="i">++++++++++++++++++++++++++++++++++++++</span><span class="d">--------------------------------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h41">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/downloader/ProfilePictureDownloader.kt</a></td><td> | </td><td class="num">83</td><td><span class="i">++++++++++++++++++++++++++++++++++++++++</span><span class="d">---------------------------------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h42">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/experiments/AccountSwitcher.kt</a></td><td> | </td><td class="num">29</td><td><span class="i">+++++++++++++</span><span class="d">----------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h43">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/experiments/AddFriendSourceSpoof.kt</a></td><td> | </td><td class="num">95</td><td><span class="i">++++++++++++++++++++++++++++++++++++++++</span><span class="d">---------------------------------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h44">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/experiments/AppLock.kt</a></td><td> | </td><td class="num">45</td><td><span class="i">+++++++++++++++++++++++</span><span class="d">----------------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h45">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/experiments/AutoOpenSnaps.kt</a></td><td> | </td><td class="num">3</td><td><span class="i">+</span><span class="d">--</span></td></tr>
<tr><td class="M">M</td><td><a href="#h46">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/experiments/BestFriendPinning.kt</a></td><td> | </td><td class="num">3</td><td><span class="i">+</span><span class="d">--</span></td></tr>
<tr><td class="M">M</td><td><a href="#h47">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/experiments/BetterLocation.kt</a></td><td> | </td><td class="num">3</td><td><span class="i">+</span><span class="d">--</span></td></tr>
<tr><td class="M">M</td><td><a href="#h48">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/experiments/BetterTranscript.kt</a></td><td> | </td><td class="num">98</td><td><span class="i">++++++++++++++++++++++++++++++++++++++++</span><span class="d">---------------------------------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h49">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/experiments/CallRecorder.kt</a></td><td> | </td><td class="num">3</td><td><span class="i">+</span><span class="d">--</span></td></tr>
<tr><td class="M">M</td><td><a href="#h50">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/experiments/ComposerHooks.kt</a></td><td> | </td><td class="num">3</td><td><span class="i">+</span><span class="d">--</span></td></tr>
<tr><td class="M">M</td><td><a href="#h51">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/experiments/ContextMenuFix.kt</a></td><td> | </td><td class="num">3</td><td><span class="i">+</span><span class="d">--</span></td></tr>
<tr><td class="M">M</td><td><a href="#h52">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/experiments/ConvertMessageLocally.kt</a></td><td> | </td><td class="num">15</td><td><span class="i">++++++++</span><span class="d">-------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h53">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/experiments/DeviceSpooferHook.kt</a></td><td> | </td><td class="num">3</td><td><span class="i">+</span><span class="d">--</span></td></tr>
<tr><td class="M">M</td><td><a href="#h54">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/experiments/EndToEndEncryption.kt</a></td><td> | </td><td class="num">401</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++</span><span class="d">----------------------------------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h55">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/experiments/InfiniteStoryBoost.kt</a></td><td> | </td><td class="num">21</td><td><span class="i">+++++++++++</span><span class="d">----------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h56">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/experiments/MediaFilePicker.kt</a></td><td> | </td><td class="num">321</td><td><span class="i">++++++++++++++++++++++++++++++++++++++++</span><span class="d">---------------------------------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h57">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/experiments/MeoPasscodeBypass.kt</a></td><td> | </td><td class="num">21</td><td><span class="i">+++++++++++</span><span class="d">----------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h58">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/experiments/NoFriendScoreDelay.kt</a></td><td> | </td><td class="num">21</td><td><span class="i">+++++++++++</span><span class="d">----------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h59">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/experiments/PreventForcedLogout.kt</a></td><td> | </td><td class="num">3</td><td><span class="i">+</span><span class="d">--</span></td></tr>
<tr><td class="M">M</td><td><a href="#h60">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/global/BypassVideoLengthRestriction.kt</a></td><td> | </td><td class="num">89</td><td><span class="i">++++++++++++++++++++++++++++++++++++++++</span><span class="d">---------------------------------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h61">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/global/DisableCustomTabs.kt</a></td><td> | </td><td class="num">15</td><td><span class="i">++++++++</span><span class="d">-------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h62">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/global/DisableMemoriesSnapFeed.kt</a></td><td> | </td><td class="num">22</td><td><span class="i">+++++++++++</span><span class="d">-----------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h63">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/global/DisableMetrics.kt</a></td><td> | </td><td class="num">3</td><td><span class="i">+</span><span class="d">--</span></td></tr>
<tr><td class="M">M</td><td><a href="#h64">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/global/DisableTelecomFramework.kt</a></td><td> | </td><td class="num">3</td><td><span class="i">+</span><span class="d">--</span></td></tr>
<tr><td class="M">M</td><td><a href="#h65">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/global/GooglePlayServicesDialogs.kt</a></td><td> | </td><td class="num">19</td><td><span class="i">++++++++++</span><span class="d">---------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h66">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/global/MediaUploadQualityOverride.kt</a></td><td> | </td><td class="num">3</td><td><span class="i">+</span><span class="d">--</span></td></tr>
<tr><td class="M">M</td><td><a href="#h67">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/global/SnapchatPlus.kt</a></td><td> | </td><td class="num">3</td><td><span class="i">+</span><span class="d">--</span></td></tr>
<tr><td class="M">M</td><td><a href="#h68">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/messaging/AutoMarkAsRead.kt</a></td><td> | </td><td class="num">3</td><td><span class="i">+</span><span class="d">--</span></td></tr>
<tr><td class="M">M</td><td><a href="#h69">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/messaging/AutoSave.kt</a></td><td> | </td><td class="num">57</td><td><span class="i">+++++++++++++++++++++++++++++</span><span class="d">----------------------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h70">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/messaging/BypassMessageActionRestrictions.kt</a></td><td> | </td><td class="num">15</td><td><span class="i">++++++++</span><span class="d">-------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h71">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/messaging/CallStartConfirmation.kt</a></td><td> | </td><td class="num">53</td><td><span class="i">+++++++++++++++++++++++++++</span><span class="d">--------------------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h72">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/messaging/DisableReplayInFF.kt</a></td><td> | </td><td class="num">19</td><td><span class="i">++++++++++</span><span class="d">---------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h73">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/messaging/Messaging.kt</a></td><td> | </td><td class="num">154</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++</span><span class="d">----------------------------------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h74">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/messaging/Notifications.kt</a></td><td> | </td><td class="num">5</td><td><span class="i">++</span><span class="d">---</span></td></tr>
<tr><td class="M">M</td><td><a href="#h75">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/messaging/PreventMessageSending.kt</a></td><td> | </td><td class="num">5</td><td><span class="i">++</span><span class="d">---</span></td></tr>
<tr><td class="M">M</td><td><a href="#h76">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/messaging/SendOverride.kt</a></td><td> | </td><td class="num">3</td><td><span class="i">+</span><span class="d">--</span></td></tr>
<tr><td class="M">M</td><td><a href="#h77">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/messaging/UnlimitedSnapViewTime.kt</a></td><td> | </td><td class="num">34</td><td><span class="i">+++++++++++++++++</span><span class="d">-----------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h78">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/spying/FriendTracker.kt</a></td><td> | </td><td class="num">3</td><td><span class="i">+</span><span class="d">--</span></td></tr>
<tr><td class="M">M</td><td><a href="#h79">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/spying/HalfSwipeNotifier.kt</a></td><td> | </td><td class="num">3</td><td><span class="i">+</span><span class="d">--</span></td></tr>
<tr><td class="M">M</td><td><a href="#h80">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/spying/MessageLogger.kt</a></td><td> | </td><td class="num">32</td><td><span class="i">++++++++++</span><span class="d">----------------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h81">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/spying/StealthMode.kt</a></td><td> | </td><td class="num">3</td><td><span class="i">+</span><span class="d">--</span></td></tr>
<tr><td class="M">M</td><td><a href="#h82">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/tweaks/BypassScreenshotDetection.kt</a></td><td> | </td><td class="num">5</td><td><span class="i">++</span><span class="d">---</span></td></tr>
<tr><td class="M">M</td><td><a href="#h83">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/tweaks/CameraTweaks.kt</a></td><td> | </td><td class="num">133</td><td><span class="i">++++++++++++++++++++++++++++++++++++++++</span><span class="d">---------------------------------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h84">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/tweaks/DisablePermissionRequests.kt</a></td><td> | </td><td class="num">3</td><td><span class="i">+</span><span class="d">--</span></td></tr>
<tr><td class="M">M</td><td><a href="#h85">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/tweaks/HideActiveMusic.kt</a></td><td> | </td><td class="num">11</td><td><span class="i">++++++</span><span class="d">-----</span></td></tr>
<tr><td class="M">M</td><td><a href="#h86">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/tweaks/PreventMessageListAutoScroll.kt</a></td><td> | </td><td class="num">89</td><td><span class="i">++++++++++++++++++++++++++++++++++++++++</span><span class="d">---------------------------------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h87">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/tweaks/RemoveGroupsLockedStatus.kt</a></td><td> | </td><td class="num">13</td><td><span class="i">+++++++</span><span class="d">------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h88">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/tweaks/UnsaveableMessages.kt</a></td><td> | </td><td class="num">4</td><td><span class="i">+</span><span class="d">---</span></td></tr>
<tr><td class="M">M</td><td><a href="#h89">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/ui/ClientBootstrapOverride.kt</a></td><td> | </td><td class="num">3</td><td><span class="i">+</span><span class="d">--</span></td></tr>
<tr><td class="M">M</td><td><a href="#h90">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/ui/ConversationToolbox.kt</a></td><td> | </td><td class="num">77</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++</span><span class="d">--------------------------------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h91">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/ui/CustomStreaksExpirationFormat.kt</a></td><td> | </td><td class="num">61</td><td><span class="i">+++++++++++++++++++++++++++++++</span><span class="d">------------------------------</span></td></tr>
<tr><td class="A">A</td><td><a href="#h92">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/ui/CustomTheming.kt</a></td><td> | </td><td class="num">131</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="D">D</td><td><a href="#h93">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/ui/CustomizeUI.kt</a></td><td> | </td><td class="num">523</td><td><span class="i"></span><span class="d">-------------------------------------------------------------------------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h94">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/ui/DefaultVolumeControls.kt</a></td><td> | </td><td class="num">15</td><td><span class="i">++++++++</span><span class="d">-------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h95">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/ui/DisableConfirmationDialogs.kt</a></td><td> | </td><td class="num">83</td><td><span class="i">++++++++++++++++++++++++++++++++++++++++</span><span class="d">---------------------------------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h96">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/ui/EditTextOverride.kt</a></td><td> | </td><td class="num">33</td><td><span class="i">+++++++++++++++++</span><span class="d">----------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h97">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/ui/FriendFeedMessagePreview.kt</a></td><td> | </td><td class="num">132</td><td><span class="i">++++++++++++++++++++++++++++++++++++++++</span><span class="d">---------------------------------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h98">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/ui/HideFriendFeedEntry.kt</a></td><td> | </td><td class="num">4</td><td><span class="i">++</span><span class="d">--</span></td></tr>
<tr><td class="M">M</td><td><a href="#h99">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/ui/HideQuickAddFriendFeed.kt</a></td><td> | </td><td class="num">19</td><td><span class="i">++++++++++</span><span class="d">---------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h100">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/ui/HideStreakRestore.kt</a></td><td> | </td><td class="num">3</td><td><span class="i">+</span><span class="d">--</span></td></tr>
<tr><td class="M">M</td><td><a href="#h101">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/ui/MessageIndicators.kt</a></td><td> | </td><td class="num">187</td><td><span class="i">++++++++++++++++++++++++++++++++++++++++</span><span class="d">---------------------------------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h102">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/ui/OldBitmojiSelfie.kt</a></td><td> | </td><td class="num">3</td><td><span class="i">+</span><span class="d">--</span></td></tr>
<tr><td class="M">M</td><td><a href="#h103">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/ui/PinConversations.kt</a></td><td> | </td><td class="num">5</td><td><span class="i">++</span><span class="d">---</span></td></tr>
<tr><td class="M">M</td><td><a href="#h104">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/ui/SnapPreview.kt</a></td><td> | </td><td class="num">69</td><td><span class="i">+++++++++++++++++++++++++++++++++</span><span class="d">------------------------------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h105">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/ui/SpotlightCommentsUsername.kt</a></td><td> | </td><td class="num">53</td><td><span class="i">+++++++++++++++++++++++++++</span><span class="d">--------------------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h106">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/ui/StealthModeIndicator.kt</a></td><td> | </td><td class="num">74</td><td><span class="i">++++++++++++++++++++++++++++++++++++++</span><span class="d">------------------------------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h107">core/src/main/kotlin/me/rhunk/snapenhance/core/ui/ViewAppearanceHelper.kt</a></td><td> | </td><td class="num">5</td><td><span class="i">+++</span><span class="d">--</span></td></tr>
<tr><td class="M">M</td><td><a href="#h108">core/src/main/kotlin/me/rhunk/snapenhance/core/ui/menu/MenuViewInjector.kt</a></td><td> | </td><td class="num">187</td><td><span class="i">++++++++++++++++++++++++++++++++++++++++</span><span class="d">---------------------------------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h109">core/src/main/kotlin/me/rhunk/snapenhance/core/ui/menu/impl/FriendFeedInfoMenu.kt</a></td><td> | </td><td class="num">5</td><td><span class="i">+++</span><span class="d">--</span></td></tr>
<tr><td class="M">M</td><td><a href="#h110">core/src/main/kotlin/me/rhunk/snapenhance/core/ui/menu/impl/OperaContextActionMenu.kt</a></td><td> | </td><td class="num">3</td><td><span class="i">++</span><span class="d">-</span></td></tr>
<tr><td class="M">M</td><td><a href="#h111">core/src/main/kotlin/me/rhunk/snapenhance/core/ui/menu/impl/SettingsGearInjector.kt</a></td><td> | </td><td class="num">5</td><td><span class="i">+++</span><span class="d">--</span></td></tr>
<tr><td class="M">M</td><td><a href="#h112">native/jni/src/common.h</a></td><td> | </td><td class="num">1</td><td><span class="i"></span><span class="d">-</span></td></tr>
<tr><td class="M">M</td><td><a href="#h113">native/jni/src/dobby_helper.h</a></td><td> | </td><td class="num">3</td><td><span class="i"></span><span class="d">---</span></td></tr>
<tr><td class="A">A</td><td><a href="#h114">native/jni/src/hooks/linker_hook.h</a></td><td> | </td><td class="num">55</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="M">M</td><td><a href="#h115">native/jni/src/library.cpp</a></td><td> | </td><td class="num">18</td><td><span class="i">++++</span><span class="d">--------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h116">native/jni/src/util.h</a></td><td> | </td><td class="num">40</td><td><span class="i"></span><span class="d">----------------------------------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h117">native/src/main/kotlin/me/rhunk/snapenhance/nativelib/NativeConfig.kt</a></td><td> | </td><td class="num">2</td><td><span class="i"></span><span class="d">--</span></td></tr>
<tr><td class="M">M</td><td><a href="#h118">native/src/main/kotlin/me/rhunk/snapenhance/nativelib/NativeLib.kt</a></td><td> | </td><td class="num">25</td><td><span class="i">+++++++++++++++++++</span><span class="d">------</span></td></tr>
</table></pre><pre>119 files changed, 3808 insertions(+), 2334 deletions(-)
<hr/><b>diff --git a/<a id="h0" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/RemoteFileHandleManager.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/RemoteFileHandleManager.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/RemoteFileHandleManager.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/RemoteFileHandleManager.kt</a></b>
<a href="#h0-0" id="h0-0" class="h">@@ -8,10 +8,28 @@ import me.rhunk.snapenhance.common.bridge.InternalFileHandleType
</a> import me.rhunk.snapenhance.common.bridge.wrapper.LocaleWrapper
 import me.rhunk.snapenhance.common.logger.AbstractLogger
 import me.rhunk.snapenhance.common.util.ktx.toParcelFileDescriptor
<a href="#h0-0-3" id="h0-0-3" class="i">+import me.rhunk.snapenhance.storage.getEnabledThemesContent
</a> import java.io.File
 import java.io.OutputStream
 
 
<a href="#h0-0-8" id="h0-0-8" class="i">+class ByteArrayFileHandle(
</a><a href="#h0-0-9" id="h0-0-9" class="i">+    private val context: RemoteSideContext,
</a><a href="#h0-0-10" id="h0-0-10" class="i">+    private val data: ByteArray
</a><a href="#h0-0-11" id="h0-0-11" class="i">+): FileHandle.Stub() {
</a><a href="#h0-0-12" id="h0-0-12" class="i">+    override fun exists() = true
</a><a href="#h0-0-13" id="h0-0-13" class="i">+    override fun create() = false
</a><a href="#h0-0-14" id="h0-0-14" class="i">+    override fun delete() = false
</a><a href="#h0-0-15" id="h0-0-15" class="i">+
</a><a href="#h0-0-16" id="h0-0-16" class="i">+    override fun open(mode: Int): ParcelFileDescriptor? {
</a><a href="#h0-0-17" id="h0-0-17" class="i">+        return runCatching {
</a><a href="#h0-0-18" id="h0-0-18" class="i">+            data.inputStream().toParcelFileDescriptor(context.coroutineScope)
</a><a href="#h0-0-19" id="h0-0-19" class="i">+        }.onFailure {
</a><a href="#h0-0-20" id="h0-0-20" class="i">+            context.log.error(&quot;Failed to open byte array file handle: ${it.message}&quot;, it)
</a><a href="#h0-0-21" id="h0-0-21" class="i">+        }.getOrNull()
</a><a href="#h0-0-22" id="h0-0-22" class="i">+    }
</a><a href="#h0-0-23" id="h0-0-23" class="i">+}
</a><a href="#h0-0-24" id="h0-0-24" class="i">+
</a> class LocalFileHandle(
     private val file: File
 ): FileHandle.Stub() {
<a href="#h0-1" id="h0-1" class="h">@@ -97,6 +115,12 @@ class RemoteFileHandleManager(
</a>                     &quot;composer/${name.substringAfterLast(&quot;/&quot;)}&quot;
                 )
             }
<a href="#h0-1-3" id="h0-1-3" class="i">+            FileHandleScope.THEME -&gt; {
</a><a href="#h0-1-4" id="h0-1-4" class="i">+                return ByteArrayFileHandle(
</a><a href="#h0-1-5" id="h0-1-5" class="i">+                    context,
</a><a href="#h0-1-6" id="h0-1-6" class="i">+                    context.gson.toJson(context.database.getEnabledThemesContent()).toByteArray(Charsets.UTF_8)
</a><a href="#h0-1-7" id="h0-1-7" class="i">+                )
</a><a href="#h0-1-8" id="h0-1-8" class="i">+            }
</a>             else -&gt; return null
         }
     }
<b>diff --git a/<a id="h1" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/RemoteSharedLibraryManager.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/RemoteSharedLibraryManager.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/RemoteSharedLibraryManager.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/RemoteSharedLibraryManager.kt</a></b>
<a href="#h1-0" id="h1-0" class="h">@@ -0,0 +1,84 @@
</a><a href="#h1-0-0" id="h1-0-0" class="i">+package me.rhunk.snapenhance
</a><a href="#h1-0-1" id="h1-0-1" class="i">+
</a><a href="#h1-0-2" id="h1-0-2" class="i">+import android.annotation.SuppressLint
</a><a href="#h1-0-3" id="h1-0-3" class="i">+import android.os.Build
</a><a href="#h1-0-4" id="h1-0-4" class="i">+import me.rhunk.snapenhance.common.bridge.InternalFileHandleType
</a><a href="#h1-0-5" id="h1-0-5" class="i">+import okhttp3.OkHttpClient
</a><a href="#h1-0-6" id="h1-0-6" class="i">+import okhttp3.Request
</a><a href="#h1-0-7" id="h1-0-7" class="i">+import java.io.File
</a><a href="#h1-0-8" id="h1-0-8" class="i">+
</a><a href="#h1-0-9" id="h1-0-9" class="i">+class RemoteSharedLibraryManager(
</a><a href="#h1-0-10" id="h1-0-10" class="i">+    private val remoteSideContext: RemoteSideContext
</a><a href="#h1-0-11" id="h1-0-11" class="i">+) {
</a><a href="#h1-0-12" id="h1-0-12" class="i">+    private val okHttpClient = OkHttpClient()
</a><a href="#h1-0-13" id="h1-0-13" class="i">+
</a><a href="#h1-0-14" id="h1-0-14" class="i">+    private fun getVersion(): String? {
</a><a href="#h1-0-15" id="h1-0-15" class="i">+        return runCatching {
</a><a href="#h1-0-16" id="h1-0-16" class="i">+            okHttpClient.newCall(
</a><a href="#h1-0-17" id="h1-0-17" class="i">+                Request.Builder()
</a><a href="#h1-0-18" id="h1-0-18" class="i">+                    .url(&quot;https://raw.githubusercontent.com/SnapEnhance/resources/main/sif/version&quot;)
</a><a href="#h1-0-19" id="h1-0-19" class="i">+                    .build()
</a><a href="#h1-0-20" id="h1-0-20" class="i">+            ).execute().use { response -&gt;
</a><a href="#h1-0-21" id="h1-0-21" class="i">+                if (!response.isSuccessful) {
</a><a href="#h1-0-22" id="h1-0-22" class="i">+                    return null
</a><a href="#h1-0-23" id="h1-0-23" class="i">+                }
</a><a href="#h1-0-24" id="h1-0-24" class="i">+                response.body.string()
</a><a href="#h1-0-25" id="h1-0-25" class="i">+            }
</a><a href="#h1-0-26" id="h1-0-26" class="i">+        }.getOrNull()
</a><a href="#h1-0-27" id="h1-0-27" class="i">+    }
</a><a href="#h1-0-28" id="h1-0-28" class="i">+
</a><a href="#h1-0-29" id="h1-0-29" class="i">+    private fun downloadLatest(outputFile: File): Boolean {
</a><a href="#h1-0-30" id="h1-0-30" class="i">+        val abi = Build.SUPPORTED_ABIS.firstOrNull() ?: return false
</a><a href="#h1-0-31" id="h1-0-31" class="i">+        val request = Request.Builder()
</a><a href="#h1-0-32" id="h1-0-32" class="i">+            .url(&quot;https://raw.githubusercontent.com/SnapEnhance/resources/main/sif/$abi.so&quot;)
</a><a href="#h1-0-33" id="h1-0-33" class="i">+            .build()
</a><a href="#h1-0-34" id="h1-0-34" class="i">+        runCatching {
</a><a href="#h1-0-35" id="h1-0-35" class="i">+            okHttpClient.newCall(request).execute().use { response -&gt;
</a><a href="#h1-0-36" id="h1-0-36" class="i">+                if (!response.isSuccessful) {
</a><a href="#h1-0-37" id="h1-0-37" class="i">+                    return false
</a><a href="#h1-0-38" id="h1-0-38" class="i">+                }
</a><a href="#h1-0-39" id="h1-0-39" class="i">+                response.body.byteStream().use { input -&gt;
</a><a href="#h1-0-40" id="h1-0-40" class="i">+                    outputFile.outputStream().use { output -&gt;
</a><a href="#h1-0-41" id="h1-0-41" class="i">+                        input.copyTo(output)
</a><a href="#h1-0-42" id="h1-0-42" class="i">+                    }
</a><a href="#h1-0-43" id="h1-0-43" class="i">+                }
</a><a href="#h1-0-44" id="h1-0-44" class="i">+                return true
</a><a href="#h1-0-45" id="h1-0-45" class="i">+            }
</a><a href="#h1-0-46" id="h1-0-46" class="i">+        }.onFailure {
</a><a href="#h1-0-47" id="h1-0-47" class="i">+            remoteSideContext.log.error(&quot;Failed to download latest sif&quot;, it)
</a><a href="#h1-0-48" id="h1-0-48" class="i">+        }
</a><a href="#h1-0-49" id="h1-0-49" class="i">+        return false
</a><a href="#h1-0-50" id="h1-0-50" class="i">+    }
</a><a href="#h1-0-51" id="h1-0-51" class="i">+
</a><a href="#h1-0-52" id="h1-0-52" class="i">+    @SuppressLint(&quot;ApplySharedPref&quot;)
</a><a href="#h1-0-53" id="h1-0-53" class="i">+    fun init() {
</a><a href="#h1-0-54" id="h1-0-54" class="i">+        val libraryFile = InternalFileHandleType.SIF.resolve(remoteSideContext.androidContext)
</a><a href="#h1-0-55" id="h1-0-55" class="i">+        val currentVersion = remoteSideContext.sharedPreferences.getString(&quot;sif&quot;, null)?.trim()
</a><a href="#h1-0-56" id="h1-0-56" class="i">+        if (currentVersion == null || currentVersion == &quot;false&quot;) {
</a><a href="#h1-0-57" id="h1-0-57" class="i">+            libraryFile.takeIf { it.exists() }?.delete()
</a><a href="#h1-0-58" id="h1-0-58" class="i">+            remoteSideContext.log.info(&quot;sif can&#39;t be loaded due to user preference&quot;)
</a><a href="#h1-0-59" id="h1-0-59" class="i">+            return
</a><a href="#h1-0-60" id="h1-0-60" class="i">+        }
</a><a href="#h1-0-61" id="h1-0-61" class="i">+        val latestVersion = getVersion()?.trim() ?: run {
</a><a href="#h1-0-62" id="h1-0-62" class="i">+            remoteSideContext.log.warn(&quot;Failed to get latest sif version&quot;)
</a><a href="#h1-0-63" id="h1-0-63" class="i">+            return
</a><a href="#h1-0-64" id="h1-0-64" class="i">+        }
</a><a href="#h1-0-65" id="h1-0-65" class="i">+
</a><a href="#h1-0-66" id="h1-0-66" class="i">+        if (currentVersion == latestVersion) {
</a><a href="#h1-0-67" id="h1-0-67" class="i">+            remoteSideContext.log.info(&quot;sif is up to date ($currentVersion)&quot;)
</a><a href="#h1-0-68" id="h1-0-68" class="i">+            return
</a><a href="#h1-0-69" id="h1-0-69" class="i">+        }
</a><a href="#h1-0-70" id="h1-0-70" class="i">+
</a><a href="#h1-0-71" id="h1-0-71" class="i">+        remoteSideContext.log.info(&quot;Updating sif from $currentVersion to $latestVersion&quot;)
</a><a href="#h1-0-72" id="h1-0-72" class="i">+        if (downloadLatest(libraryFile)) {
</a><a href="#h1-0-73" id="h1-0-73" class="i">+            remoteSideContext.sharedPreferences.edit().putString(&quot;sif&quot;, latestVersion).commit()
</a><a href="#h1-0-74" id="h1-0-74" class="i">+            remoteSideContext.shortToast(&quot;SIF updated to $latestVersion!&quot;)
</a><a href="#h1-0-75" id="h1-0-75" class="i">+            // force restart snapchat
</a><a href="#h1-0-76" id="h1-0-76" class="i">+            runCatching {
</a><a href="#h1-0-77" id="h1-0-77" class="i">+                remoteSideContext.config.configStateListener?.takeIf { it.asBinder().pingBinder() }?.onRestartRequired()
</a><a href="#h1-0-78" id="h1-0-78" class="i">+            }
</a><a href="#h1-0-79" id="h1-0-79" class="i">+        } else {
</a><a href="#h1-0-80" id="h1-0-80" class="i">+            remoteSideContext.log.warn(&quot;Failed to download latest sif&quot;)
</a><a href="#h1-0-81" id="h1-0-81" class="i">+        }
</a><a href="#h1-0-82" id="h1-0-82" class="i">+    }
</a><a href="#h1-0-83" id="h1-0-83" class="i">+}</a><a href="#h1-0-84" id="h1-0-84" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h2" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/RemoteSideContext.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/RemoteSideContext.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/RemoteSideContext.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/RemoteSideContext.kt</a></b>
<a href="#h2-0" id="h2-0" class="h">@@ -78,6 +78,7 @@ class RemoteSideContext(
</a>     val tracker = RemoteTracker(this)
     val accountStorage = RemoteAccountStorage(this)
     val locationManager = RemoteLocationManager(this)
<a href="#h2-0-3" id="h2-0-3" class="i">+    val remoteSharedLibraryManager = RemoteSharedLibraryManager(this)
</a> 
     //used to load bitmoji selfies and download previews
     val imageLoader by lazy {
<a href="#h2-1" id="h2-1" class="h">@@ -131,6 +132,9 @@ class RemoteSideContext(
</a>                         messageLogger.purgeTrackerLogs(it)
                     }
                 }
<a href="#h2-1-3" id="h2-1-3" class="i">+                coroutineScope.launch {
</a><a href="#h2-1-4" id="h2-1-4" class="i">+                    remoteSharedLibraryManager.init()
</a><a href="#h2-1-5" id="h2-1-5" class="i">+                }
</a>             }
         }.onFailure {
             log.error(&quot;Failed to load RemoteSideContext&quot;, it)
<a href="#h2-2" id="h2-2" class="h">@@ -212,6 +216,10 @@ class RemoteSideContext(
</a>             requirements = requirements or Requirements.MAPPINGS
         }
 
<a href="#h2-2-3" id="h2-2-3" class="i">+        /*if (sharedPreferences.getString(&quot;sif&quot;, null) == null) {
</a><a href="#h2-2-4" id="h2-2-4" class="i">+            requirements = requirements or Requirements.SIF
</a><a href="#h2-2-5" id="h2-2-5" class="i">+        }*/
</a><a href="#h2-2-6" id="h2-2-6" class="i">+
</a>         if (requirements == 0) return false
 
         val currentContext = activity ?: androidContext
<b>diff --git a/<a id="h3" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/action/EnumQuickActions.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/action/EnumQuickActions.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/action/EnumQuickActions.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/action/EnumQuickActions.kt</a></b>
<a href="#h3-0" id="h3-0" class="h">@@ -3,6 +3,7 @@ package me.rhunk.snapenhance.action
</a> import androidx.compose.material.icons.Icons
 import androidx.compose.material.icons.filled.FolderOpen
 import androidx.compose.material.icons.filled.History
<a href="#h3-0-3" id="h3-0-3" class="i">+import androidx.compose.material.icons.filled.Palette
</a> import androidx.compose.material.icons.filled.PersonSearch
 import androidx.compose.ui.graphics.vector.ImageVector
 import me.rhunk.snapenhance.ui.manager.Routes
<a href="#h3-1" id="h3-1" class="h">@@ -21,4 +22,7 @@ enum class EnumQuickActions(
</a>     LOGGER_HISTORY(&quot;logger_history&quot;, Icons.Default.History, {
         loggerHistory.navigateReset()
     }),
<a href="#h3-1-3" id="h3-1-3" class="i">+    THEMING(&quot;theming&quot;, Icons.Default.Palette, {
</a><a href="#h3-1-4" id="h3-1-4" class="i">+        theming.navigateReset()
</a><a href="#h3-1-5" id="h3-1-5" class="i">+    })
</a> } 
\ No newline at end of file
<b>diff --git a/<a id="h4" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/storage/AppDatabase.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/storage/AppDatabase.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/storage/AppDatabase.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/storage/AppDatabase.kt</a></b>
<a href="#h4-0" id="h4-0" class="h">@@ -89,6 +89,19 @@ class AppDatabase(
</a>                 &quot;longitude DOUBLE&quot;,
                 &quot;radius DOUBLE&quot;,
             ),
<a href="#h4-0-3" id="h4-0-3" class="i">+            &quot;themes&quot; to listOf(
</a><a href="#h4-0-4" id="h4-0-4" class="i">+                &quot;id INTEGER PRIMARY KEY AUTOINCREMENT&quot;,
</a><a href="#h4-0-5" id="h4-0-5" class="i">+                &quot;enabled BOOLEAN DEFAULT 0&quot;,
</a><a href="#h4-0-6" id="h4-0-6" class="i">+                &quot;name VARCHAR&quot;,
</a><a href="#h4-0-7" id="h4-0-7" class="i">+                &quot;description TEXT&quot;,
</a><a href="#h4-0-8" id="h4-0-8" class="i">+                &quot;version VARCHAR&quot;,
</a><a href="#h4-0-9" id="h4-0-9" class="i">+                &quot;author VARCHAR&quot;,
</a><a href="#h4-0-10" id="h4-0-10" class="i">+                &quot;updateUrl VARCHAR&quot;,
</a><a href="#h4-0-11" id="h4-0-11" class="i">+                &quot;content TEXT&quot;,
</a><a href="#h4-0-12" id="h4-0-12" class="i">+            ),
</a><a href="#h4-0-13" id="h4-0-13" class="i">+            &quot;repositories&quot; to listOf(
</a><a href="#h4-0-14" id="h4-0-14" class="i">+                &quot;url VARCHAR PRIMARY KEY&quot;,
</a><a href="#h4-0-15" id="h4-0-15" class="i">+            ),
</a>         ))
     }
 } 
\ No newline at end of file
<b>diff --git a/<a id="h5" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/storage/Repositories.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/storage/Repositories.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/storage/Repositories.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/storage/Repositories.kt</a></b>
<a href="#h5-0" id="h5-0" class="h">@@ -0,0 +1,34 @@
</a><a href="#h5-0-0" id="h5-0-0" class="i">+package me.rhunk.snapenhance.storage
</a><a href="#h5-0-1" id="h5-0-1" class="i">+
</a><a href="#h5-0-2" id="h5-0-2" class="i">+import android.content.ContentValues
</a><a href="#h5-0-3" id="h5-0-3" class="i">+import kotlinx.coroutines.asCoroutineDispatcher
</a><a href="#h5-0-4" id="h5-0-4" class="i">+import kotlinx.coroutines.runBlocking
</a><a href="#h5-0-5" id="h5-0-5" class="i">+import me.rhunk.snapenhance.common.util.ktx.getStringOrNull
</a><a href="#h5-0-6" id="h5-0-6" class="i">+
</a><a href="#h5-0-7" id="h5-0-7" class="i">+
</a><a href="#h5-0-8" id="h5-0-8" class="i">+fun AppDatabase.getRepositories(): List&lt;String&gt; {
</a><a href="#h5-0-9" id="h5-0-9" class="i">+    return runBlocking(executor.asCoroutineDispatcher()) {
</a><a href="#h5-0-10" id="h5-0-10" class="i">+        database.rawQuery(&quot;SELECT url FROM repositories&quot;, null).use { cursor -&gt;
</a><a href="#h5-0-11" id="h5-0-11" class="i">+            val repos = mutableListOf&lt;String&gt;()
</a><a href="#h5-0-12" id="h5-0-12" class="i">+            while (cursor.moveToNext()) {
</a><a href="#h5-0-13" id="h5-0-13" class="i">+                repos.add(cursor.getStringOrNull(&quot;url&quot;) ?: continue)
</a><a href="#h5-0-14" id="h5-0-14" class="i">+            }
</a><a href="#h5-0-15" id="h5-0-15" class="i">+            repos
</a><a href="#h5-0-16" id="h5-0-16" class="i">+        }
</a><a href="#h5-0-17" id="h5-0-17" class="i">+    }
</a><a href="#h5-0-18" id="h5-0-18" class="i">+}
</a><a href="#h5-0-19" id="h5-0-19" class="i">+
</a><a href="#h5-0-20" id="h5-0-20" class="i">+fun AppDatabase.removeRepo(url: String) {
</a><a href="#h5-0-21" id="h5-0-21" class="i">+    runBlocking(executor.asCoroutineDispatcher()) {
</a><a href="#h5-0-22" id="h5-0-22" class="i">+        database.delete(&quot;repositories&quot;, &quot;url = ?&quot;, arrayOf(url))
</a><a href="#h5-0-23" id="h5-0-23" class="i">+    }
</a><a href="#h5-0-24" id="h5-0-24" class="i">+}
</a><a href="#h5-0-25" id="h5-0-25" class="i">+
</a><a href="#h5-0-26" id="h5-0-26" class="i">+fun AppDatabase.addRepo(url: String) {
</a><a href="#h5-0-27" id="h5-0-27" class="i">+    runBlocking(executor.asCoroutineDispatcher()) {
</a><a href="#h5-0-28" id="h5-0-28" class="i">+        database.insert(&quot;repositories&quot;, null, ContentValues().apply {
</a><a href="#h5-0-29" id="h5-0-29" class="i">+            put(&quot;url&quot;, url)
</a><a href="#h5-0-30" id="h5-0-30" class="i">+        })
</a><a href="#h5-0-31" id="h5-0-31" class="i">+    }
</a><a href="#h5-0-32" id="h5-0-32" class="i">+}
</a><a href="#h5-0-33" id="h5-0-33" class="i">+
</a><b>diff --git a/<a id="h6" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/storage/Theming.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/storage/Theming.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/storage/Theming.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/storage/Theming.kt</a></b>
<a href="#h6-0" id="h6-0" class="h">@@ -0,0 +1,126 @@
</a><a href="#h6-0-0" id="h6-0-0" class="i">+package me.rhunk.snapenhance.storage
</a><a href="#h6-0-1" id="h6-0-1" class="i">+
</a><a href="#h6-0-2" id="h6-0-2" class="i">+import android.content.ContentValues
</a><a href="#h6-0-3" id="h6-0-3" class="i">+import kotlinx.coroutines.asCoroutineDispatcher
</a><a href="#h6-0-4" id="h6-0-4" class="i">+import kotlinx.coroutines.runBlocking
</a><a href="#h6-0-5" id="h6-0-5" class="i">+import me.rhunk.snapenhance.common.data.DatabaseTheme
</a><a href="#h6-0-6" id="h6-0-6" class="i">+import me.rhunk.snapenhance.common.data.DatabaseThemeContent
</a><a href="#h6-0-7" id="h6-0-7" class="i">+import me.rhunk.snapenhance.common.util.ktx.getIntOrNull
</a><a href="#h6-0-8" id="h6-0-8" class="i">+import me.rhunk.snapenhance.common.util.ktx.getStringOrNull
</a><a href="#h6-0-9" id="h6-0-9" class="i">+
</a><a href="#h6-0-10" id="h6-0-10" class="i">+
</a><a href="#h6-0-11" id="h6-0-11" class="i">+fun AppDatabase.getThemeList(): List&lt;DatabaseTheme&gt; {
</a><a href="#h6-0-12" id="h6-0-12" class="i">+    return runBlocking(executor.asCoroutineDispatcher()) {
</a><a href="#h6-0-13" id="h6-0-13" class="i">+        database.rawQuery(&quot;SELECT * FROM themes ORDER BY id DESC&quot;, null).use { cursor -&gt;
</a><a href="#h6-0-14" id="h6-0-14" class="i">+            val themes = mutableListOf&lt;DatabaseTheme&gt;()
</a><a href="#h6-0-15" id="h6-0-15" class="i">+            while (cursor.moveToNext()) {
</a><a href="#h6-0-16" id="h6-0-16" class="i">+                themes.add(
</a><a href="#h6-0-17" id="h6-0-17" class="i">+                    DatabaseTheme(
</a><a href="#h6-0-18" id="h6-0-18" class="i">+                        id = cursor.getIntOrNull(&quot;id&quot;) ?: continue,
</a><a href="#h6-0-19" id="h6-0-19" class="i">+                        enabled = cursor.getIntOrNull(&quot;enabled&quot;) == 1,
</a><a href="#h6-0-20" id="h6-0-20" class="i">+                        name = cursor.getStringOrNull(&quot;name&quot;) ?: continue,
</a><a href="#h6-0-21" id="h6-0-21" class="i">+                        description = cursor.getStringOrNull(&quot;description&quot;),
</a><a href="#h6-0-22" id="h6-0-22" class="i">+                        version = cursor.getStringOrNull(&quot;version&quot;),
</a><a href="#h6-0-23" id="h6-0-23" class="i">+                        author = cursor.getStringOrNull(&quot;author&quot;),
</a><a href="#h6-0-24" id="h6-0-24" class="i">+                        updateUrl = cursor.getStringOrNull(&quot;updateUrl&quot;)
</a><a href="#h6-0-25" id="h6-0-25" class="i">+                    )
</a><a href="#h6-0-26" id="h6-0-26" class="i">+                )
</a><a href="#h6-0-27" id="h6-0-27" class="i">+            }
</a><a href="#h6-0-28" id="h6-0-28" class="i">+            themes
</a><a href="#h6-0-29" id="h6-0-29" class="i">+        }
</a><a href="#h6-0-30" id="h6-0-30" class="i">+    }
</a><a href="#h6-0-31" id="h6-0-31" class="i">+}
</a><a href="#h6-0-32" id="h6-0-32" class="i">+
</a><a href="#h6-0-33" id="h6-0-33" class="i">+fun AppDatabase.getThemeInfo(id: Int): DatabaseTheme? {
</a><a href="#h6-0-34" id="h6-0-34" class="i">+    return runBlocking(executor.asCoroutineDispatcher()) {
</a><a href="#h6-0-35" id="h6-0-35" class="i">+        database.rawQuery(&quot;SELECT * FROM themes WHERE id = ?&quot;, arrayOf(id.toString())).use { cursor -&gt;
</a><a href="#h6-0-36" id="h6-0-36" class="i">+            if (!cursor.moveToFirst()) return@use null
</a><a href="#h6-0-37" id="h6-0-37" class="i">+            DatabaseTheme(
</a><a href="#h6-0-38" id="h6-0-38" class="i">+                id = cursor.getIntOrNull(&quot;id&quot;) ?: return@use null,
</a><a href="#h6-0-39" id="h6-0-39" class="i">+                enabled = cursor.getIntOrNull(&quot;enabled&quot;) == 1,
</a><a href="#h6-0-40" id="h6-0-40" class="i">+                name = cursor.getStringOrNull(&quot;name&quot;) ?: return@use null,
</a><a href="#h6-0-41" id="h6-0-41" class="i">+                description = cursor.getStringOrNull(&quot;description&quot;),
</a><a href="#h6-0-42" id="h6-0-42" class="i">+                version = cursor.getStringOrNull(&quot;version&quot;),
</a><a href="#h6-0-43" id="h6-0-43" class="i">+                author = cursor.getStringOrNull(&quot;author&quot;),
</a><a href="#h6-0-44" id="h6-0-44" class="i">+                updateUrl = cursor.getStringOrNull(&quot;updateUrl&quot;)
</a><a href="#h6-0-45" id="h6-0-45" class="i">+            )
</a><a href="#h6-0-46" id="h6-0-46" class="i">+        }
</a><a href="#h6-0-47" id="h6-0-47" class="i">+    }
</a><a href="#h6-0-48" id="h6-0-48" class="i">+}
</a><a href="#h6-0-49" id="h6-0-49" class="i">+
</a><a href="#h6-0-50" id="h6-0-50" class="i">+fun AppDatabase.getThemeIdByUpdateUrl(updateUrl: String): Int? {
</a><a href="#h6-0-51" id="h6-0-51" class="i">+    return runBlocking(executor.asCoroutineDispatcher()) {
</a><a href="#h6-0-52" id="h6-0-52" class="i">+        database.rawQuery(&quot;SELECT id FROM themes WHERE updateUrl = ?&quot;, arrayOf(updateUrl)).use { cursor -&gt;
</a><a href="#h6-0-53" id="h6-0-53" class="i">+            if (!cursor.moveToFirst()) return@use null
</a><a href="#h6-0-54" id="h6-0-54" class="i">+            cursor.getIntOrNull(&quot;id&quot;)
</a><a href="#h6-0-55" id="h6-0-55" class="i">+        }
</a><a href="#h6-0-56" id="h6-0-56" class="i">+    }
</a><a href="#h6-0-57" id="h6-0-57" class="i">+}
</a><a href="#h6-0-58" id="h6-0-58" class="i">+
</a><a href="#h6-0-59" id="h6-0-59" class="i">+fun AppDatabase.addOrUpdateTheme(theme: DatabaseTheme, themeId: Int? = null): Int {
</a><a href="#h6-0-60" id="h6-0-60" class="i">+    return runBlocking(executor.asCoroutineDispatcher()) {
</a><a href="#h6-0-61" id="h6-0-61" class="i">+        val contentValues = ContentValues().apply {
</a><a href="#h6-0-62" id="h6-0-62" class="i">+            put(&quot;enabled&quot;, if (theme.enabled) 1 else 0)
</a><a href="#h6-0-63" id="h6-0-63" class="i">+            put(&quot;name&quot;, theme.name)
</a><a href="#h6-0-64" id="h6-0-64" class="i">+            put(&quot;description&quot;, theme.description)
</a><a href="#h6-0-65" id="h6-0-65" class="i">+            put(&quot;version&quot;, theme.version)
</a><a href="#h6-0-66" id="h6-0-66" class="i">+            put(&quot;author&quot;, theme.author)
</a><a href="#h6-0-67" id="h6-0-67" class="i">+            put(&quot;updateUrl&quot;, theme.updateUrl)
</a><a href="#h6-0-68" id="h6-0-68" class="i">+        }
</a><a href="#h6-0-69" id="h6-0-69" class="i">+        if (themeId != null) {
</a><a href="#h6-0-70" id="h6-0-70" class="i">+            database.update(&quot;themes&quot;, contentValues, &quot;id = ?&quot;, arrayOf(themeId.toString()))
</a><a href="#h6-0-71" id="h6-0-71" class="i">+            return@runBlocking themeId
</a><a href="#h6-0-72" id="h6-0-72" class="i">+        }
</a><a href="#h6-0-73" id="h6-0-73" class="i">+        database.insert(&quot;themes&quot;, null, contentValues).toInt()
</a><a href="#h6-0-74" id="h6-0-74" class="i">+    }
</a><a href="#h6-0-75" id="h6-0-75" class="i">+}
</a><a href="#h6-0-76" id="h6-0-76" class="i">+
</a><a href="#h6-0-77" id="h6-0-77" class="i">+fun AppDatabase.setThemeState(id: Int, enabled: Boolean) {
</a><a href="#h6-0-78" id="h6-0-78" class="i">+    runBlocking(executor.asCoroutineDispatcher()) {
</a><a href="#h6-0-79" id="h6-0-79" class="i">+        database.update(&quot;themes&quot;, ContentValues().apply {
</a><a href="#h6-0-80" id="h6-0-80" class="i">+            put(&quot;enabled&quot;, if (enabled) 1 else 0)
</a><a href="#h6-0-81" id="h6-0-81" class="i">+        }, &quot;id = ?&quot;, arrayOf(id.toString()))
</a><a href="#h6-0-82" id="h6-0-82" class="i">+    }
</a><a href="#h6-0-83" id="h6-0-83" class="i">+}
</a><a href="#h6-0-84" id="h6-0-84" class="i">+
</a><a href="#h6-0-85" id="h6-0-85" class="i">+fun AppDatabase.deleteTheme(id: Int) {
</a><a href="#h6-0-86" id="h6-0-86" class="i">+    runBlocking(executor.asCoroutineDispatcher()) {
</a><a href="#h6-0-87" id="h6-0-87" class="i">+        database.delete(&quot;themes&quot;, &quot;id = ?&quot;, arrayOf(id.toString()))
</a><a href="#h6-0-88" id="h6-0-88" class="i">+    }
</a><a href="#h6-0-89" id="h6-0-89" class="i">+}
</a><a href="#h6-0-90" id="h6-0-90" class="i">+
</a><a href="#h6-0-91" id="h6-0-91" class="i">+
</a><a href="#h6-0-92" id="h6-0-92" class="i">+fun AppDatabase.getThemeContent(id: Int): DatabaseThemeContent? {
</a><a href="#h6-0-93" id="h6-0-93" class="i">+    return runBlocking(executor.asCoroutineDispatcher()) {
</a><a href="#h6-0-94" id="h6-0-94" class="i">+        database.rawQuery(&quot;SELECT content FROM themes WHERE id = ?&quot;, arrayOf(id.toString())).use { cursor -&gt;
</a><a href="#h6-0-95" id="h6-0-95" class="i">+            if (!cursor.moveToFirst()) return@use null
</a><a href="#h6-0-96" id="h6-0-96" class="i">+            runCatching {
</a><a href="#h6-0-97" id="h6-0-97" class="i">+                context.gson.fromJson(cursor.getStringOrNull(&quot;content&quot;), DatabaseThemeContent::class.java)
</a><a href="#h6-0-98" id="h6-0-98" class="i">+            }.getOrNull()
</a><a href="#h6-0-99" id="h6-0-99" class="i">+        }
</a><a href="#h6-0-100" id="h6-0-100" class="i">+    }
</a><a href="#h6-0-101" id="h6-0-101" class="i">+}
</a><a href="#h6-0-102" id="h6-0-102" class="i">+
</a><a href="#h6-0-103" id="h6-0-103" class="i">+
</a><a href="#h6-0-104" id="h6-0-104" class="i">+fun AppDatabase.getEnabledThemesContent(): List&lt;DatabaseThemeContent&gt; {
</a><a href="#h6-0-105" id="h6-0-105" class="i">+    return runBlocking(executor.asCoroutineDispatcher()) {
</a><a href="#h6-0-106" id="h6-0-106" class="i">+        database.rawQuery(&quot;SELECT content FROM themes WHERE enabled = 1&quot;, null).use { cursor -&gt;
</a><a href="#h6-0-107" id="h6-0-107" class="i">+            val themes = mutableListOf&lt;DatabaseThemeContent&gt;()
</a><a href="#h6-0-108" id="h6-0-108" class="i">+            while (cursor.moveToNext()) {
</a><a href="#h6-0-109" id="h6-0-109" class="i">+                runCatching {
</a><a href="#h6-0-110" id="h6-0-110" class="i">+                    themes.add(context.gson.fromJson(cursor.getStringOrNull(&quot;content&quot;), DatabaseThemeContent::class.java))
</a><a href="#h6-0-111" id="h6-0-111" class="i">+                }
</a><a href="#h6-0-112" id="h6-0-112" class="i">+            }
</a><a href="#h6-0-113" id="h6-0-113" class="i">+            themes
</a><a href="#h6-0-114" id="h6-0-114" class="i">+        }
</a><a href="#h6-0-115" id="h6-0-115" class="i">+    }
</a><a href="#h6-0-116" id="h6-0-116" class="i">+}
</a><a href="#h6-0-117" id="h6-0-117" class="i">+
</a><a href="#h6-0-118" id="h6-0-118" class="i">+
</a><a href="#h6-0-119" id="h6-0-119" class="i">+fun AppDatabase.setThemeContent(id: Int, content: DatabaseThemeContent) {
</a><a href="#h6-0-120" id="h6-0-120" class="i">+    runBlocking(executor.asCoroutineDispatcher()) {
</a><a href="#h6-0-121" id="h6-0-121" class="i">+        database.update(&quot;themes&quot;, ContentValues().apply {
</a><a href="#h6-0-122" id="h6-0-122" class="i">+            put(&quot;content&quot;, context.gson.toJson(content))
</a><a href="#h6-0-123" id="h6-0-123" class="i">+        }, &quot;id = ?&quot;, arrayOf(id.toString()))
</a><a href="#h6-0-124" id="h6-0-124" class="i">+    }
</a><a href="#h6-0-125" id="h6-0-125" class="i">+}
</a><b>diff --git a/<a id="h7" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/Routes.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/Routes.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/Routes.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/Routes.kt</a></b>
<a href="#h7-0" id="h7-0" class="h">@@ -24,6 +24,9 @@ import me.rhunk.snapenhance.ui.manager.pages.social.LoggedStories
</a> import me.rhunk.snapenhance.ui.manager.pages.social.ManageScope
 import me.rhunk.snapenhance.ui.manager.pages.social.MessagingPreview
 import me.rhunk.snapenhance.ui.manager.pages.social.SocialRootSection
<a href="#h7-0-3" id="h7-0-3" class="i">+import me.rhunk.snapenhance.ui.manager.pages.theming.EditThemeSection
</a><a href="#h7-0-4" id="h7-0-4" class="i">+import me.rhunk.snapenhance.ui.manager.pages.ManageReposSection
</a><a href="#h7-0-5" id="h7-0-5" class="i">+import me.rhunk.snapenhance.ui.manager.pages.theming.ThemingRoot
</a> import me.rhunk.snapenhance.ui.manager.pages.tracker.EditRule
 import me.rhunk.snapenhance.ui.manager.pages.tracker.FriendTrackerManagerRoot
 
<a href="#h7-1" id="h7-1" class="h">@@ -58,6 +61,10 @@ class Routes(
</a>     val editRule = route(RouteInfo(&quot;edit_rule/?rule_id={rule_id}&quot;), EditRule())
 
     val fileImports = route(RouteInfo(&quot;file_imports&quot;), FileImportsRoot()).parent(home)
<a href="#h7-1-3" id="h7-1-3" class="i">+    val theming = route(RouteInfo(&quot;theming&quot;), ThemingRoot()).parent(home)
</a><a href="#h7-1-4" id="h7-1-4" class="i">+    val editTheme = route(RouteInfo(&quot;edit_theme/?theme_id={theme_id}&quot;), EditThemeSection())
</a><a href="#h7-1-5" id="h7-1-5" class="i">+    val manageRepos = route(RouteInfo(&quot;manage_repos&quot;), ManageReposSection())
</a><a href="#h7-1-6" id="h7-1-6" class="i">+
</a>     val social = route(RouteInfo(&quot;social&quot;, icon = Icons.Default.Group, primary = true), SocialRootSection())
     val manageScope = route(RouteInfo(&quot;manage_scope/?scope={scope}&amp;id={id}&quot;), ManageScope()).parent(social)
     val messagingPreview = route(RouteInfo(&quot;messaging_preview/?scope={scope}&amp;id={id}&quot;), MessagingPreview()).parent(social)
<b>diff --git a/<a id="h8" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/pages/LoggerHistoryRoot.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/pages/LoggerHistoryRoot.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/pages/LoggerHistoryRoot.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/pages/LoggerHistoryRoot.kt</a></b>
<a href="#h8-0" id="h8-0" class="h">@@ -38,6 +38,7 @@ import me.rhunk.snapenhance.common.data.download.DownloadRequest
</a> import me.rhunk.snapenhance.common.data.download.MediaDownloadSource
 import me.rhunk.snapenhance.common.data.download.createNewFilePath
 import me.rhunk.snapenhance.common.ui.rememberAsyncMutableState
<a href="#h8-0-3" id="h8-0-3" class="i">+import me.rhunk.snapenhance.common.ui.transparentTextFieldColors
</a> import me.rhunk.snapenhance.common.util.ktx.copyToClipboard
 import me.rhunk.snapenhance.common.util.ktx.longHashCode
 import me.rhunk.snapenhance.common.util.protobuf.ProtoReader
<a href="#h8-1" id="h8-1" class="h">@@ -373,14 +374,7 @@ class LoggerHistoryRoot : Routes.Route() {
</a>                     .padding(end = 10.dp)
                     .height(70.dp),
                 singleLine = true,
<a href="#h8-1-3" id="h8-1-3" class="d">-                colors = TextFieldDefaults.colors(
</a><a href="#h8-1-4" id="h8-1-4" class="d">-                    unfocusedContainerColor = MaterialTheme.colorScheme.surface,
</a><a href="#h8-1-5" id="h8-1-5" class="d">-                    focusedContainerColor = MaterialTheme.colorScheme.surface,
</a><a href="#h8-1-6" id="h8-1-6" class="d">-                    focusedIndicatorColor = Color.Transparent,
</a><a href="#h8-1-7" id="h8-1-7" class="d">-                    unfocusedIndicatorColor = Color.Transparent,
</a><a href="#h8-1-8" id="h8-1-8" class="d">-                    disabledIndicatorColor = Color.Transparent,
</a><a href="#h8-1-9" id="h8-1-9" class="d">-                    cursorColor = MaterialTheme.colorScheme.primary
</a><a href="#h8-1-10" id="h8-1-10" class="d">-                )
</a><a href="#h8-1-11" id="h8-1-11" class="i">+                colors = transparentTextFieldColors()
</a>             )
 
             LaunchedEffect(Unit) {
<b>diff --git a/<a id="h9" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/pages/ManageReposSection.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/pages/ManageReposSection.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/pages/ManageReposSection.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/pages/ManageReposSection.kt</a></b>
<a href="#h9-0" id="h9-0" class="h">@@ -0,0 +1,190 @@
</a><a href="#h9-0-0" id="h9-0-0" class="i">+package me.rhunk.snapenhance.ui.manager.pages
</a><a href="#h9-0-1" id="h9-0-1" class="i">+
</a><a href="#h9-0-2" id="h9-0-2" class="i">+import androidx.compose.foundation.layout.*
</a><a href="#h9-0-3" id="h9-0-3" class="i">+import androidx.compose.foundation.lazy.LazyColumn
</a><a href="#h9-0-4" id="h9-0-4" class="i">+import androidx.compose.foundation.lazy.items
</a><a href="#h9-0-5" id="h9-0-5" class="i">+import androidx.compose.material.icons.Icons
</a><a href="#h9-0-6" id="h9-0-6" class="i">+import androidx.compose.material.icons.filled.Public
</a><a href="#h9-0-7" id="h9-0-7" class="i">+import androidx.compose.material3.*
</a><a href="#h9-0-8" id="h9-0-8" class="i">+import androidx.compose.runtime.*
</a><a href="#h9-0-9" id="h9-0-9" class="i">+import androidx.compose.ui.Modifier
</a><a href="#h9-0-10" id="h9-0-10" class="i">+import androidx.compose.ui.focus.FocusRequester
</a><a href="#h9-0-11" id="h9-0-11" class="i">+import androidx.compose.ui.focus.focusRequester
</a><a href="#h9-0-12" id="h9-0-12" class="i">+import androidx.compose.ui.layout.onGloballyPositioned
</a><a href="#h9-0-13" id="h9-0-13" class="i">+import androidx.compose.ui.text.font.FontWeight
</a><a href="#h9-0-14" id="h9-0-14" class="i">+import androidx.compose.ui.text.style.TextAlign
</a><a href="#h9-0-15" id="h9-0-15" class="i">+import androidx.compose.ui.text.style.TextOverflow
</a><a href="#h9-0-16" id="h9-0-16" class="i">+import androidx.compose.ui.unit.dp
</a><a href="#h9-0-17" id="h9-0-17" class="i">+import androidx.compose.ui.unit.sp
</a><a href="#h9-0-18" id="h9-0-18" class="i">+import androidx.core.net.toUri
</a><a href="#h9-0-19" id="h9-0-19" class="i">+import androidx.navigation.NavBackStackEntry
</a><a href="#h9-0-20" id="h9-0-20" class="i">+import kotlinx.coroutines.Dispatchers
</a><a href="#h9-0-21" id="h9-0-21" class="i">+import kotlinx.coroutines.launch
</a><a href="#h9-0-22" id="h9-0-22" class="i">+import me.rhunk.snapenhance.common.data.RepositoryIndex
</a><a href="#h9-0-23" id="h9-0-23" class="i">+import me.rhunk.snapenhance.common.ui.AsyncUpdateDispatcher
</a><a href="#h9-0-24" id="h9-0-24" class="i">+import me.rhunk.snapenhance.common.ui.rememberAsyncMutableStateList
</a><a href="#h9-0-25" id="h9-0-25" class="i">+import me.rhunk.snapenhance.common.util.ktx.copyToClipboard
</a><a href="#h9-0-26" id="h9-0-26" class="i">+import me.rhunk.snapenhance.common.util.ktx.getUrlFromClipboard
</a><a href="#h9-0-27" id="h9-0-27" class="i">+import me.rhunk.snapenhance.storage.addRepo
</a><a href="#h9-0-28" id="h9-0-28" class="i">+import me.rhunk.snapenhance.storage.getRepositories
</a><a href="#h9-0-29" id="h9-0-29" class="i">+import me.rhunk.snapenhance.storage.removeRepo
</a><a href="#h9-0-30" id="h9-0-30" class="i">+import me.rhunk.snapenhance.ui.manager.Routes
</a><a href="#h9-0-31" id="h9-0-31" class="i">+import okhttp3.OkHttpClient
</a><a href="#h9-0-32" id="h9-0-32" class="i">+
</a><a href="#h9-0-33" id="h9-0-33" class="i">+class ManageReposSection: Routes.Route() {
</a><a href="#h9-0-34" id="h9-0-34" class="i">+    private val updateDispatcher = AsyncUpdateDispatcher()
</a><a href="#h9-0-35" id="h9-0-35" class="i">+    private val okHttpClient by lazy { OkHttpClient() }
</a><a href="#h9-0-36" id="h9-0-36" class="i">+
</a><a href="#h9-0-37" id="h9-0-37" class="i">+    override val floatingActionButton: @Composable () -&gt; Unit = {
</a><a href="#h9-0-38" id="h9-0-38" class="i">+        var showAddDialog by remember { mutableStateOf(false) }
</a><a href="#h9-0-39" id="h9-0-39" class="i">+        ExtendedFloatingActionButton(onClick = {
</a><a href="#h9-0-40" id="h9-0-40" class="i">+            showAddDialog = true
</a><a href="#h9-0-41" id="h9-0-41" class="i">+        }) {
</a><a href="#h9-0-42" id="h9-0-42" class="i">+            Text(&quot;Add Repository&quot;)
</a><a href="#h9-0-43" id="h9-0-43" class="i">+        }
</a><a href="#h9-0-44" id="h9-0-44" class="i">+
</a><a href="#h9-0-45" id="h9-0-45" class="i">+        if (showAddDialog) {
</a><a href="#h9-0-46" id="h9-0-46" class="i">+            val coroutineScope = rememberCoroutineScope { Dispatchers.IO }
</a><a href="#h9-0-47" id="h9-0-47" class="i">+
</a><a href="#h9-0-48" id="h9-0-48" class="i">+            suspend fun addRepo(url: String) {
</a><a href="#h9-0-49" id="h9-0-49" class="i">+                var modifiedUrl = url;
</a><a href="#h9-0-50" id="h9-0-50" class="i">+
</a><a href="#h9-0-51" id="h9-0-51" class="i">+                if (url.startsWith(&quot;https://github.com/&quot;)) {
</a><a href="#h9-0-52" id="h9-0-52" class="i">+                    val splitUrl = modifiedUrl.removePrefix(&quot;https://github.com/&quot;).split(&quot;/&quot;)
</a><a href="#h9-0-53" id="h9-0-53" class="i">+                    val repoName = splitUrl[0] + &quot;/&quot; + splitUrl[1]
</a><a href="#h9-0-54" id="h9-0-54" class="i">+                    // fetch default branch
</a><a href="#h9-0-55" id="h9-0-55" class="i">+                    okHttpClient.newCall(
</a><a href="#h9-0-56" id="h9-0-56" class="i">+                        okhttp3.Request.Builder().url(&quot;https://api.github.com/repos/$repoName&quot;).build()
</a><a href="#h9-0-57" id="h9-0-57" class="i">+                    ).execute().use { response -&gt;
</a><a href="#h9-0-58" id="h9-0-58" class="i">+                        if (!response.isSuccessful) {
</a><a href="#h9-0-59" id="h9-0-59" class="i">+                            throw Exception(&quot;Failed to fetch default branch: ${response.code}&quot;)
</a><a href="#h9-0-60" id="h9-0-60" class="i">+                        }
</a><a href="#h9-0-61" id="h9-0-61" class="i">+                        val json = response.body.string()
</a><a href="#h9-0-62" id="h9-0-62" class="i">+                        val defaultBranch = context.gson.fromJson(json, Map::class.java)[&quot;default_branch&quot;] as String
</a><a href="#h9-0-63" id="h9-0-63" class="i">+                        context.log.info(&quot;Default branch for $repoName is $defaultBranch&quot;)
</a><a href="#h9-0-64" id="h9-0-64" class="i">+                        modifiedUrl = &quot;https://raw.githubusercontent.com/$repoName/$defaultBranch/&quot;
</a><a href="#h9-0-65" id="h9-0-65" class="i">+                    }
</a><a href="#h9-0-66" id="h9-0-66" class="i">+                }
</a><a href="#h9-0-67" id="h9-0-67" class="i">+
</a><a href="#h9-0-68" id="h9-0-68" class="i">+                val indexUri = modifiedUrl.toUri().buildUpon().appendPath(&quot;index.json&quot;).build()
</a><a href="#h9-0-69" id="h9-0-69" class="i">+                okHttpClient.newCall(
</a><a href="#h9-0-70" id="h9-0-70" class="i">+                    okhttp3.Request.Builder().url(indexUri.toString()).build()
</a><a href="#h9-0-71" id="h9-0-71" class="i">+                ).execute().use { response -&gt;
</a><a href="#h9-0-72" id="h9-0-72" class="i">+                    if (!response.isSuccessful) {
</a><a href="#h9-0-73" id="h9-0-73" class="i">+                        throw Exception(&quot;Failed to fetch index from $indexUri: ${response.code}&quot;)
</a><a href="#h9-0-74" id="h9-0-74" class="i">+                    }
</a><a href="#h9-0-75" id="h9-0-75" class="i">+                    runCatching {
</a><a href="#h9-0-76" id="h9-0-76" class="i">+                        val repoIndex = context.gson.fromJson(response.body.charStream(), RepositoryIndex::class.java).also {
</a><a href="#h9-0-77" id="h9-0-77" class="i">+                            context.log.info(&quot;repository index: $it&quot;)
</a><a href="#h9-0-78" id="h9-0-78" class="i">+                        }
</a><a href="#h9-0-79" id="h9-0-79" class="i">+
</a><a href="#h9-0-80" id="h9-0-80" class="i">+                        context.database.addRepo(modifiedUrl)
</a><a href="#h9-0-81" id="h9-0-81" class="i">+                        context.shortToast(&quot;Repository added successfully! $repoIndex&quot;)
</a><a href="#h9-0-82" id="h9-0-82" class="i">+                        showAddDialog = false
</a><a href="#h9-0-83" id="h9-0-83" class="i">+                        updateDispatcher.dispatch()
</a><a href="#h9-0-84" id="h9-0-84" class="i">+                    }.onFailure {
</a><a href="#h9-0-85" id="h9-0-85" class="i">+                        throw Exception(&quot;Failed to parse index from $indexUri&quot;)
</a><a href="#h9-0-86" id="h9-0-86" class="i">+                    }
</a><a href="#h9-0-87" id="h9-0-87" class="i">+                }
</a><a href="#h9-0-88" id="h9-0-88" class="i">+            }
</a><a href="#h9-0-89" id="h9-0-89" class="i">+
</a><a href="#h9-0-90" id="h9-0-90" class="i">+            var url by remember { mutableStateOf(&quot;&quot;) }
</a><a href="#h9-0-91" id="h9-0-91" class="i">+            var loading by remember { mutableStateOf(false) }
</a><a href="#h9-0-92" id="h9-0-92" class="i">+
</a><a href="#h9-0-93" id="h9-0-93" class="i">+            AlertDialog(onDismissRequest = {
</a><a href="#h9-0-94" id="h9-0-94" class="i">+                showAddDialog = false
</a><a href="#h9-0-95" id="h9-0-95" class="i">+            }, title = {
</a><a href="#h9-0-96" id="h9-0-96" class="i">+                Text(&quot;Add Repository URL&quot;)
</a><a href="#h9-0-97" id="h9-0-97" class="i">+            }, text = {
</a><a href="#h9-0-98" id="h9-0-98" class="i">+                val focusRequester = remember { FocusRequester() }
</a><a href="#h9-0-99" id="h9-0-99" class="i">+                OutlinedTextField(
</a><a href="#h9-0-100" id="h9-0-100" class="i">+                    modifier = Modifier
</a><a href="#h9-0-101" id="h9-0-101" class="i">+                        .fillMaxWidth()
</a><a href="#h9-0-102" id="h9-0-102" class="i">+                        .focusRequester(focusRequester)
</a><a href="#h9-0-103" id="h9-0-103" class="i">+                        .onGloballyPositioned {
</a><a href="#h9-0-104" id="h9-0-104" class="i">+                            focusRequester.requestFocus()
</a><a href="#h9-0-105" id="h9-0-105" class="i">+                        },
</a><a href="#h9-0-106" id="h9-0-106" class="i">+                    value = url,
</a><a href="#h9-0-107" id="h9-0-107" class="i">+                    onValueChange = {
</a><a href="#h9-0-108" id="h9-0-108" class="i">+                        url = it
</a><a href="#h9-0-109" id="h9-0-109" class="i">+                    }, label = {
</a><a href="#h9-0-110" id="h9-0-110" class="i">+                        Text(&quot;Repository URL&quot;)
</a><a href="#h9-0-111" id="h9-0-111" class="i">+                    }
</a><a href="#h9-0-112" id="h9-0-112" class="i">+                )
</a><a href="#h9-0-113" id="h9-0-113" class="i">+                LaunchedEffect(Unit) {
</a><a href="#h9-0-114" id="h9-0-114" class="i">+                    context.androidContext.getUrlFromClipboard()?.let {
</a><a href="#h9-0-115" id="h9-0-115" class="i">+                        url = it
</a><a href="#h9-0-116" id="h9-0-116" class="i">+                    }
</a><a href="#h9-0-117" id="h9-0-117" class="i">+                }
</a><a href="#h9-0-118" id="h9-0-118" class="i">+            }, confirmButton = {
</a><a href="#h9-0-119" id="h9-0-119" class="i">+                Button(
</a><a href="#h9-0-120" id="h9-0-120" class="i">+                    enabled = !loading,
</a><a href="#h9-0-121" id="h9-0-121" class="i">+                    onClick = {
</a><a href="#h9-0-122" id="h9-0-122" class="i">+                        loading = true;
</a><a href="#h9-0-123" id="h9-0-123" class="i">+                        coroutineScope.launch {
</a><a href="#h9-0-124" id="h9-0-124" class="i">+                            runCatching {
</a><a href="#h9-0-125" id="h9-0-125" class="i">+                                addRepo(url)
</a><a href="#h9-0-126" id="h9-0-126" class="i">+                            }.onFailure {
</a><a href="#h9-0-127" id="h9-0-127" class="i">+                                context.log.error(&quot;Failed to add repository&quot;, it)
</a><a href="#h9-0-128" id="h9-0-128" class="i">+                                context.shortToast(&quot;Failed to add repository: ${it.message}&quot;)
</a><a href="#h9-0-129" id="h9-0-129" class="i">+                            }
</a><a href="#h9-0-130" id="h9-0-130" class="i">+                            loading = false
</a><a href="#h9-0-131" id="h9-0-131" class="i">+                        }
</a><a href="#h9-0-132" id="h9-0-132" class="i">+                    }
</a><a href="#h9-0-133" id="h9-0-133" class="i">+                ) {
</a><a href="#h9-0-134" id="h9-0-134" class="i">+                    if (loading) {
</a><a href="#h9-0-135" id="h9-0-135" class="i">+                        CircularProgressIndicator(modifier = Modifier.size(24.dp))
</a><a href="#h9-0-136" id="h9-0-136" class="i">+                    } else {
</a><a href="#h9-0-137" id="h9-0-137" class="i">+                        Text(&quot;Add&quot;)
</a><a href="#h9-0-138" id="h9-0-138" class="i">+                    }
</a><a href="#h9-0-139" id="h9-0-139" class="i">+                }
</a><a href="#h9-0-140" id="h9-0-140" class="i">+            })
</a><a href="#h9-0-141" id="h9-0-141" class="i">+        }
</a><a href="#h9-0-142" id="h9-0-142" class="i">+    }
</a><a href="#h9-0-143" id="h9-0-143" class="i">+
</a><a href="#h9-0-144" id="h9-0-144" class="i">+    override val content: @Composable (NavBackStackEntry) -&gt; Unit = {
</a><a href="#h9-0-145" id="h9-0-145" class="i">+        val coroutineScope = rememberCoroutineScope()
</a><a href="#h9-0-146" id="h9-0-146" class="i">+        val repositories = rememberAsyncMutableStateList(defaultValue = listOf(), updateDispatcher = updateDispatcher) {
</a><a href="#h9-0-147" id="h9-0-147" class="i">+            context.database.getRepositories()
</a><a href="#h9-0-148" id="h9-0-148" class="i">+        }
</a><a href="#h9-0-149" id="h9-0-149" class="i">+
</a><a href="#h9-0-150" id="h9-0-150" class="i">+        LazyColumn(
</a><a href="#h9-0-151" id="h9-0-151" class="i">+            modifier = Modifier.fillMaxSize(),
</a><a href="#h9-0-152" id="h9-0-152" class="i">+            contentPadding = PaddingValues(8.dp),
</a><a href="#h9-0-153" id="h9-0-153" class="i">+        ) {
</a><a href="#h9-0-154" id="h9-0-154" class="i">+            item {
</a><a href="#h9-0-155" id="h9-0-155" class="i">+                if (repositories.isEmpty()) {
</a><a href="#h9-0-156" id="h9-0-156" class="i">+                    Text(&quot;No repositories added&quot;, modifier = Modifier
</a><a href="#h9-0-157" id="h9-0-157" class="i">+                        .padding(16.dp)
</a><a href="#h9-0-158" id="h9-0-158" class="i">+                        .fillMaxWidth(), fontSize = 15.sp, fontWeight = FontWeight.Light, textAlign = TextAlign.Center)
</a><a href="#h9-0-159" id="h9-0-159" class="i">+                }
</a><a href="#h9-0-160" id="h9-0-160" class="i">+            }
</a><a href="#h9-0-161" id="h9-0-161" class="i">+            items(repositories) { url -&gt;
</a><a href="#h9-0-162" id="h9-0-162" class="i">+                ElevatedCard(onClick = {
</a><a href="#h9-0-163" id="h9-0-163" class="i">+                    context.androidContext.copyToClipboard(url)
</a><a href="#h9-0-164" id="h9-0-164" class="i">+                }) {
</a><a href="#h9-0-165" id="h9-0-165" class="i">+                    Row(
</a><a href="#h9-0-166" id="h9-0-166" class="i">+                        modifier = Modifier
</a><a href="#h9-0-167" id="h9-0-167" class="i">+                            .fillMaxWidth()
</a><a href="#h9-0-168" id="h9-0-168" class="i">+                            .padding(8.dp),
</a><a href="#h9-0-169" id="h9-0-169" class="i">+                        horizontalArrangement = Arrangement.spacedBy(4.dp),
</a><a href="#h9-0-170" id="h9-0-170" class="i">+                        verticalAlignment = androidx.compose.ui.Alignment.CenterVertically
</a><a href="#h9-0-171" id="h9-0-171" class="i">+                    ) {
</a><a href="#h9-0-172" id="h9-0-172" class="i">+                        Icon(Icons.Default.Public, contentDescription = null)
</a><a href="#h9-0-173" id="h9-0-173" class="i">+                        Text(text = url, modifier = Modifier.weight(1f), overflow = TextOverflow.Ellipsis, maxLines = 4, fontSize = 15.sp, lineHeight = 15.sp)
</a><a href="#h9-0-174" id="h9-0-174" class="i">+                        Button(
</a><a href="#h9-0-175" id="h9-0-175" class="i">+                            onClick = {
</a><a href="#h9-0-176" id="h9-0-176" class="i">+                                context.database.removeRepo(url)
</a><a href="#h9-0-177" id="h9-0-177" class="i">+                                coroutineScope.launch {
</a><a href="#h9-0-178" id="h9-0-178" class="i">+                                    updateDispatcher.dispatch()
</a><a href="#h9-0-179" id="h9-0-179" class="i">+                                }
</a><a href="#h9-0-180" id="h9-0-180" class="i">+                            }
</a><a href="#h9-0-181" id="h9-0-181" class="i">+                        ) {
</a><a href="#h9-0-182" id="h9-0-182" class="i">+                            Text(&quot;Remove&quot;)
</a><a href="#h9-0-183" id="h9-0-183" class="i">+                        }
</a><a href="#h9-0-184" id="h9-0-184" class="i">+                    }
</a><a href="#h9-0-185" id="h9-0-185" class="i">+                }
</a><a href="#h9-0-186" id="h9-0-186" class="i">+            }
</a><a href="#h9-0-187" id="h9-0-187" class="i">+        }
</a><a href="#h9-0-188" id="h9-0-188" class="i">+    }
</a><a href="#h9-0-189" id="h9-0-189" class="i">+}</a><a href="#h9-0-190" id="h9-0-190" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h10" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/pages/features/FeaturesRootSection.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/pages/features/FeaturesRootSection.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/pages/features/FeaturesRootSection.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/pages/features/FeaturesRootSection.kt</a></b>
<a href="#h10-0" id="h10-0" class="h">@@ -40,6 +40,7 @@ import kotlinx.coroutines.delay
</a> import kotlinx.coroutines.launch
 import me.rhunk.snapenhance.common.config.*
 import me.rhunk.snapenhance.common.ui.rememberAsyncMutableStateList
<a href="#h10-0-3" id="h10-0-3" class="i">+import me.rhunk.snapenhance.common.ui.transparentTextFieldColors
</a> import me.rhunk.snapenhance.ui.manager.MainActivity
 import me.rhunk.snapenhance.ui.manager.Routes
 import me.rhunk.snapenhance.ui.util.*
<a href="#h10-1" id="h10-1" class="h">@@ -177,11 +178,15 @@ class FeaturesRootSection : Routes.Route() {
</a>                         .fillMaxWidth(),
                 ) {
                     LazyColumn(
<a href="#h10-1-3" id="h10-1-3" class="d">-                        modifier = Modifier.fillMaxWidth().padding(4.dp),
</a><a href="#h10-1-4" id="h10-1-4" class="i">+                        modifier = Modifier
</a><a href="#h10-1-5" id="h10-1-5" class="i">+                            .fillMaxWidth()
</a><a href="#h10-1-6" id="h10-1-6" class="i">+                            .padding(4.dp),
</a>                     ) {
                         item {
                             Column(
<a href="#h10-1-10" id="h10-1-10" class="d">-                                modifier = Modifier.fillMaxWidth().padding(16.dp),
</a><a href="#h10-1-11" id="h10-1-11" class="i">+                                modifier = Modifier
</a><a href="#h10-1-12" id="h10-1-12" class="i">+                                    .fillMaxWidth()
</a><a href="#h10-1-13" id="h10-1-13" class="i">+                                    .padding(16.dp),
</a>                                 horizontalAlignment = Alignment.CenterHorizontally
                             ) {
                                 Text(
<a href="#h10-2" id="h10-2" class="h">@@ -200,10 +205,13 @@ class FeaturesRootSection : Routes.Route() {
</a>                         }
                         items(files, key = { it.name }) { file -&gt;
                             Row(
<a href="#h10-2-3" id="h10-2-3" class="d">-                                modifier = Modifier.clickable {
</a><a href="#h10-2-4" id="h10-2-4" class="d">-                                    selectedFile = if (selectedFile == file.name) null else file.name
</a><a href="#h10-2-5" id="h10-2-5" class="d">-                                    propertyValue.setAny(selectedFile)
</a><a href="#h10-2-6" id="h10-2-6" class="d">-                                }.padding(5.dp),
</a><a href="#h10-2-7" id="h10-2-7" class="i">+                                modifier = Modifier
</a><a href="#h10-2-8" id="h10-2-8" class="i">+                                    .clickable {
</a><a href="#h10-2-9" id="h10-2-9" class="i">+                                        selectedFile =
</a><a href="#h10-2-10" id="h10-2-10" class="i">+                                            if (selectedFile == file.name) null else file.name
</a><a href="#h10-2-11" id="h10-2-11" class="i">+                                        propertyValue.setAny(selectedFile)
</a><a href="#h10-2-12" id="h10-2-12" class="i">+                                    }
</a><a href="#h10-2-13" id="h10-2-13" class="i">+                                    .padding(5.dp),
</a>                                 verticalAlignment = Alignment.CenterVertically
                             ) {
                                 Icon(Icons.Filled.AttachFile, contentDescription = null, modifier = Modifier.padding(5.dp))
<a href="#h10-3" id="h10-3" class="h">@@ -321,23 +329,13 @@ class FeaturesRootSection : Routes.Route() {
</a> 
             DataProcessors.Type.INT_COLOR -&gt; {
                 dialogComposable = {
<a href="#h10-3-3" id="h10-3-3" class="d">-                    alertDialogs.ColorPickerDialog(property) {
</a><a href="#h10-3-4" id="h10-3-4" class="i">+                    alertDialogs.ColorPickerPropertyDialog(property) {
</a>                         showDialog = false
                     }
                 }
 
                 registerDialogOnClickCallback().let { { it.invoke(true) } }.also {
<a href="#h10-3-10" id="h10-3-10" class="d">-                    val selectedColor = (propertyValue.getNullable() as? Int)?.let { Color(it) }
</a><a href="#h10-3-11" id="h10-3-11" class="d">-                    AlphaTile(
</a><a href="#h10-3-12" id="h10-3-12" class="d">-                        modifier = Modifier
</a><a href="#h10-3-13" id="h10-3-13" class="d">-                            .size(30.dp)
</a><a href="#h10-3-14" id="h10-3-14" class="d">-                            .border(2.dp, Color.White, shape = RoundedCornerShape(15.dp))
</a><a href="#h10-3-15" id="h10-3-15" class="d">-                            .clip(RoundedCornerShape(15.dp)),
</a><a href="#h10-3-16" id="h10-3-16" class="d">-                        selectedColor = selectedColor ?: Color.Transparent,
</a><a href="#h10-3-17" id="h10-3-17" class="d">-                        tileEvenColor = selectedColor?.let { Color(0xFFCBCBCB) } ?: Color.Transparent,
</a><a href="#h10-3-18" id="h10-3-18" class="d">-                        tileOddColor = selectedColor?.let { Color.White } ?: Color.Transparent,
</a><a href="#h10-3-19" id="h10-3-19" class="d">-                        tileSize = 8.dp,
</a><a href="#h10-3-20" id="h10-3-20" class="d">-                    )
</a><a href="#h10-3-21" id="h10-3-21" class="i">+                    CircularAlphaTile(selectedColor = (propertyValue.getNullable() as? Int)?.let { Color(it) })
</a>                 }
             }
 
<a href="#h10-4" id="h10-4" class="h">@@ -489,14 +487,7 @@ class FeaturesRootSection : Routes.Route() {
</a>                     .padding(end = 10.dp)
                     .height(70.dp),
                 singleLine = true,
<a href="#h10-4-3" id="h10-4-3" class="d">-                colors = TextFieldDefaults.colors(
</a><a href="#h10-4-4" id="h10-4-4" class="d">-                    unfocusedContainerColor = MaterialTheme.colorScheme.surface,
</a><a href="#h10-4-5" id="h10-4-5" class="d">-                    focusedContainerColor = MaterialTheme.colorScheme.surface,
</a><a href="#h10-4-6" id="h10-4-6" class="d">-                    focusedIndicatorColor = Color.Transparent,
</a><a href="#h10-4-7" id="h10-4-7" class="d">-                    unfocusedIndicatorColor = Color.Transparent,
</a><a href="#h10-4-8" id="h10-4-8" class="d">-                    disabledIndicatorColor = Color.Transparent,
</a><a href="#h10-4-9" id="h10-4-9" class="d">-                    cursorColor = MaterialTheme.colorScheme.primary
</a><a href="#h10-4-10" id="h10-4-10" class="d">-                )
</a><a href="#h10-4-11" id="h10-4-11" class="i">+                colors = transparentTextFieldColors()
</a>             )
         }
     }
<b>diff --git a/<a id="h11" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/pages/home/HomeSettings.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/pages/home/HomeSettings.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/pages/home/HomeSettings.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/pages/home/HomeSettings.kt</a></b>
<a href="#h11-0" id="h11-0" class="h">@@ -154,6 +154,9 @@ class HomeSettings : Routes.Route() {
</a>             RowAction(key = &quot;change_language&quot;) {
                 context.checkForRequirements(Requirements.LANGUAGE)
             }
<a href="#h11-0-3" id="h11-0-3" class="i">+            RowAction(key = &quot;security_features&quot;) {
</a><a href="#h11-0-4" id="h11-0-4" class="i">+                context.checkForRequirements(Requirements.SIF)
</a><a href="#h11-0-5" id="h11-0-5" class="i">+            }
</a>             RowTitle(title = translation[&quot;message_logger_title&quot;])
             ShiftedRow {
                 Column(
<a href="#h11-1" id="h11-1" class="h">@@ -284,7 +287,7 @@ class HomeSettings : Routes.Route() {
</a>                 ) {
                     PreferenceToggle(context.sharedPreferences, key = &quot;disable_feature_loading&quot;, text = &quot;Disable Feature Loading&quot;)
                     PreferenceToggle(context.sharedPreferences, key = &quot;disable_mapper&quot;, text = &quot;Disable Auto Mapper&quot;)
<a href="#h11-1-3" id="h11-1-3" class="d">-                    PreferenceToggle(context.sharedPreferences, key = &quot;force_native_load&quot;, text = &quot;Force Native Load&quot;)
</a><a href="#h11-1-4" id="h11-1-4" class="i">+                    PreferenceToggle(context.sharedPreferences, key = &quot;disable_sif&quot;, text = &quot;Disable Security Features&quot;)
</a>                 }
             }
             Spacer(modifier = Modifier.height(50.dp))
<b>diff --git a/<a id="h12" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/pages/scripting/ScriptingRootSection.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/pages/scripting/ScriptingRootSection.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/pages/scripting/ScriptingRootSection.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/pages/scripting/ScriptingRootSection.kt</a></b>
<a href="#h12-0" id="h12-0" class="h">@@ -22,11 +22,7 @@ import androidx.compose.ui.unit.dp
</a> import androidx.compose.ui.unit.sp
 import androidx.core.net.toUri
 import androidx.navigation.NavBackStackEntry
<a href="#h12-0-3" id="h12-0-3" class="d">-import kotlinx.coroutines.Dispatchers
</a><a href="#h12-0-4" id="h12-0-4" class="d">-import kotlinx.coroutines.asCoroutineDispatcher
</a><a href="#h12-0-5" id="h12-0-5" class="d">-import kotlinx.coroutines.delay
</a><a href="#h12-0-6" id="h12-0-6" class="d">-import kotlinx.coroutines.launch
</a><a href="#h12-0-7" id="h12-0-7" class="d">-import kotlinx.coroutines.withContext
</a><a href="#h12-0-8" id="h12-0-8" class="i">+import kotlinx.coroutines.*
</a> import me.rhunk.snapenhance.common.scripting.type.ModuleInfo
 import me.rhunk.snapenhance.common.scripting.ui.EnumScriptInterface
 import me.rhunk.snapenhance.common.scripting.ui.InterfaceManager
<a href="#h12-1" id="h12-1" class="h">@@ -34,6 +30,7 @@ import me.rhunk.snapenhance.common.scripting.ui.ScriptInterface
</a> import me.rhunk.snapenhance.common.ui.AsyncUpdateDispatcher
 import me.rhunk.snapenhance.common.ui.rememberAsyncMutableState
 import me.rhunk.snapenhance.common.ui.rememberAsyncUpdateDispatcher
<a href="#h12-1-3" id="h12-1-3" class="i">+import me.rhunk.snapenhance.common.util.ktx.getUrlFromClipboard
</a> import me.rhunk.snapenhance.storage.isScriptEnabled
 import me.rhunk.snapenhance.storage.setScriptEnabled
 import me.rhunk.snapenhance.ui.manager.Routes
<a href="#h12-2" id="h12-2" class="h">@@ -101,6 +98,11 @@ class ScriptingRootSection : Routes.Route() {
</a>                                 focusRequester.requestFocus()
                             }
                     )
<a href="#h12-2-3" id="h12-2-3" class="i">+                    LaunchedEffect(Unit) {
</a><a href="#h12-2-4" id="h12-2-4" class="i">+                        context.androidContext.getUrlFromClipboard()?.let {
</a><a href="#h12-2-5" id="h12-2-5" class="i">+                            url = it
</a><a href="#h12-2-6" id="h12-2-6" class="i">+                        }
</a><a href="#h12-2-7" id="h12-2-7" class="i">+                    }
</a>                     Spacer(modifier = Modifier.height(8.dp))
                     Button(
                         enabled = url.isNotBlank(),
<b>diff --git a/<a id="h13" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/pages/theming/EditThemeSection.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/pages/theming/EditThemeSection.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/pages/theming/EditThemeSection.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/pages/theming/EditThemeSection.kt</a></b>
<a href="#h13-0" id="h13-0" class="h">@@ -0,0 +1,393 @@
</a><a href="#h13-0-0" id="h13-0-0" class="i">+package me.rhunk.snapenhance.ui.manager.pages.theming
</a><a href="#h13-0-1" id="h13-0-1" class="i">+
</a><a href="#h13-0-2" id="h13-0-2" class="i">+import androidx.compose.foundation.ExperimentalFoundationApi
</a><a href="#h13-0-3" id="h13-0-3" class="i">+import androidx.compose.foundation.layout.*
</a><a href="#h13-0-4" id="h13-0-4" class="i">+import androidx.compose.foundation.lazy.LazyColumn
</a><a href="#h13-0-5" id="h13-0-5" class="i">+import androidx.compose.foundation.lazy.items
</a><a href="#h13-0-6" id="h13-0-6" class="i">+import androidx.compose.foundation.lazy.rememberLazyListState
</a><a href="#h13-0-7" id="h13-0-7" class="i">+import androidx.compose.material.icons.Icons
</a><a href="#h13-0-8" id="h13-0-8" class="i">+import androidx.compose.material.icons.filled.*
</a><a href="#h13-0-9" id="h13-0-9" class="i">+import androidx.compose.material3.*
</a><a href="#h13-0-10" id="h13-0-10" class="i">+import androidx.compose.runtime.*
</a><a href="#h13-0-11" id="h13-0-11" class="i">+import androidx.compose.ui.Alignment
</a><a href="#h13-0-12" id="h13-0-12" class="i">+import androidx.compose.ui.Modifier
</a><a href="#h13-0-13" id="h13-0-13" class="i">+import androidx.compose.ui.focus.FocusRequester
</a><a href="#h13-0-14" id="h13-0-14" class="i">+import androidx.compose.ui.focus.focusRequester
</a><a href="#h13-0-15" id="h13-0-15" class="i">+import androidx.compose.ui.graphics.Color
</a><a href="#h13-0-16" id="h13-0-16" class="i">+import androidx.compose.ui.graphics.toArgb
</a><a href="#h13-0-17" id="h13-0-17" class="i">+import androidx.compose.ui.text.font.FontWeight
</a><a href="#h13-0-18" id="h13-0-18" class="i">+import androidx.compose.ui.text.style.TextAlign
</a><a href="#h13-0-19" id="h13-0-19" class="i">+import androidx.compose.ui.text.style.TextOverflow
</a><a href="#h13-0-20" id="h13-0-20" class="i">+import androidx.compose.ui.unit.dp
</a><a href="#h13-0-21" id="h13-0-21" class="i">+import androidx.compose.ui.unit.sp
</a><a href="#h13-0-22" id="h13-0-22" class="i">+import androidx.navigation.NavBackStackEntry
</a><a href="#h13-0-23" id="h13-0-23" class="i">+import kotlinx.coroutines.Dispatchers
</a><a href="#h13-0-24" id="h13-0-24" class="i">+import kotlinx.coroutines.delay
</a><a href="#h13-0-25" id="h13-0-25" class="i">+import kotlinx.coroutines.launch
</a><a href="#h13-0-26" id="h13-0-26" class="i">+import kotlinx.coroutines.withContext
</a><a href="#h13-0-27" id="h13-0-27" class="i">+import me.rhunk.snapenhance.common.data.*
</a><a href="#h13-0-28" id="h13-0-28" class="i">+import me.rhunk.snapenhance.common.ui.rememberAsyncMutableState
</a><a href="#h13-0-29" id="h13-0-29" class="i">+import me.rhunk.snapenhance.common.ui.rememberAsyncMutableStateList
</a><a href="#h13-0-30" id="h13-0-30" class="i">+import me.rhunk.snapenhance.common.ui.transparentTextFieldColors
</a><a href="#h13-0-31" id="h13-0-31" class="i">+import me.rhunk.snapenhance.storage.*
</a><a href="#h13-0-32" id="h13-0-32" class="i">+import me.rhunk.snapenhance.ui.manager.Routes
</a><a href="#h13-0-33" id="h13-0-33" class="i">+import me.rhunk.snapenhance.ui.util.AlertDialogs
</a><a href="#h13-0-34" id="h13-0-34" class="i">+import me.rhunk.snapenhance.ui.util.CircularAlphaTile
</a><a href="#h13-0-35" id="h13-0-35" class="i">+import me.rhunk.snapenhance.ui.util.Dialog
</a><a href="#h13-0-36" id="h13-0-36" class="i">+
</a><a href="#h13-0-37" id="h13-0-37" class="i">+class EditThemeSection: Routes.Route() {
</a><a href="#h13-0-38" id="h13-0-38" class="i">+    private var saveCallback by mutableStateOf&lt;(() -&gt; Unit)?&gt;(null)
</a><a href="#h13-0-39" id="h13-0-39" class="i">+    private var addEntryCallback by mutableStateOf&lt;(key: String, initialColor: Int) -&gt; Unit&gt;({ _, _ -&gt; })
</a><a href="#h13-0-40" id="h13-0-40" class="i">+    private var deleteCallback by mutableStateOf&lt;(() -&gt; Unit)?&gt;(null)
</a><a href="#h13-0-41" id="h13-0-41" class="i">+    private var themeColors = mutableStateListOf&lt;ThemeColorEntry&gt;()
</a><a href="#h13-0-42" id="h13-0-42" class="i">+
</a><a href="#h13-0-43" id="h13-0-43" class="i">+    private val alertDialogs by lazy {
</a><a href="#h13-0-44" id="h13-0-44" class="i">+        AlertDialogs(context.translation)
</a><a href="#h13-0-45" id="h13-0-45" class="i">+    }
</a><a href="#h13-0-46" id="h13-0-46" class="i">+
</a><a href="#h13-0-47" id="h13-0-47" class="i">+    override val topBarActions: @Composable (RowScope.() -&gt; Unit) = {
</a><a href="#h13-0-48" id="h13-0-48" class="i">+        var deleteConfirmationDialog by remember { mutableStateOf(false) }
</a><a href="#h13-0-49" id="h13-0-49" class="i">+
</a><a href="#h13-0-50" id="h13-0-50" class="i">+        if (deleteConfirmationDialog) {
</a><a href="#h13-0-51" id="h13-0-51" class="i">+            Dialog(onDismissRequest = {
</a><a href="#h13-0-52" id="h13-0-52" class="i">+                deleteConfirmationDialog = false
</a><a href="#h13-0-53" id="h13-0-53" class="i">+            }) {
</a><a href="#h13-0-54" id="h13-0-54" class="i">+                alertDialogs.ConfirmDialog(
</a><a href="#h13-0-55" id="h13-0-55" class="i">+                    title = &quot;Delete Theme&quot;,
</a><a href="#h13-0-56" id="h13-0-56" class="i">+                    message = &quot;Are you sure you want to delete this theme?&quot;,
</a><a href="#h13-0-57" id="h13-0-57" class="i">+                    onConfirm = {
</a><a href="#h13-0-58" id="h13-0-58" class="i">+                        deleteCallback?.invoke()
</a><a href="#h13-0-59" id="h13-0-59" class="i">+                        deleteConfirmationDialog = false
</a><a href="#h13-0-60" id="h13-0-60" class="i">+                    },
</a><a href="#h13-0-61" id="h13-0-61" class="i">+                    onDismiss = {
</a><a href="#h13-0-62" id="h13-0-62" class="i">+                        deleteConfirmationDialog = false
</a><a href="#h13-0-63" id="h13-0-63" class="i">+                    }
</a><a href="#h13-0-64" id="h13-0-64" class="i">+                )
</a><a href="#h13-0-65" id="h13-0-65" class="i">+            }
</a><a href="#h13-0-66" id="h13-0-66" class="i">+        }
</a><a href="#h13-0-67" id="h13-0-67" class="i">+
</a><a href="#h13-0-68" id="h13-0-68" class="i">+        deleteCallback?.let {
</a><a href="#h13-0-69" id="h13-0-69" class="i">+            IconButton(onClick = {
</a><a href="#h13-0-70" id="h13-0-70" class="i">+                deleteConfirmationDialog = true
</a><a href="#h13-0-71" id="h13-0-71" class="i">+            }) {
</a><a href="#h13-0-72" id="h13-0-72" class="i">+                Icon(Icons.Default.Delete, contentDescription = null)
</a><a href="#h13-0-73" id="h13-0-73" class="i">+            }
</a><a href="#h13-0-74" id="h13-0-74" class="i">+        }
</a><a href="#h13-0-75" id="h13-0-75" class="i">+    }
</a><a href="#h13-0-76" id="h13-0-76" class="i">+
</a><a href="#h13-0-77" id="h13-0-77" class="i">+    @OptIn(ExperimentalFoundationApi::class)
</a><a href="#h13-0-78" id="h13-0-78" class="i">+    override val floatingActionButton: @Composable () -&gt; Unit = {
</a><a href="#h13-0-79" id="h13-0-79" class="i">+        Column(
</a><a href="#h13-0-80" id="h13-0-80" class="i">+            horizontalAlignment = Alignment.End,
</a><a href="#h13-0-81" id="h13-0-81" class="i">+            verticalArrangement = Arrangement.spacedBy(5.dp),
</a><a href="#h13-0-82" id="h13-0-82" class="i">+        ) {
</a><a href="#h13-0-83" id="h13-0-83" class="i">+            var addAttributeDialog by remember { mutableStateOf(false) }
</a><a href="#h13-0-84" id="h13-0-84" class="i">+            val attributesTranslation = remember { context.translation.getCategory(&quot;theming_attributes&quot;) }
</a><a href="#h13-0-85" id="h13-0-85" class="i">+
</a><a href="#h13-0-86" id="h13-0-86" class="i">+            if (addAttributeDialog) {
</a><a href="#h13-0-87" id="h13-0-87" class="i">+                AlertDialog(
</a><a href="#h13-0-88" id="h13-0-88" class="i">+                    title = { Text(&quot;Select an attribute to add&quot;) },
</a><a href="#h13-0-89" id="h13-0-89" class="i">+                    onDismissRequest = {
</a><a href="#h13-0-90" id="h13-0-90" class="i">+                        addAttributeDialog = false
</a><a href="#h13-0-91" id="h13-0-91" class="i">+                    },
</a><a href="#h13-0-92" id="h13-0-92" class="i">+                    confirmButton = {},
</a><a href="#h13-0-93" id="h13-0-93" class="i">+                    text = {
</a><a href="#h13-0-94" id="h13-0-94" class="i">+                        var filter by remember { mutableStateOf(&quot;&quot;) }
</a><a href="#h13-0-95" id="h13-0-95" class="i">+                        val attributes = rememberAsyncMutableStateList(defaultValue = listOf(), keys = arrayOf(filter)) {
</a><a href="#h13-0-96" id="h13-0-96" class="i">+                            AvailableThemingAttributes[ThemingAttributeType.COLOR]?.filter { key -&gt;
</a><a href="#h13-0-97" id="h13-0-97" class="i">+                                themeColors.none { it.key == key } &amp;&amp; (key.contains(filter, ignoreCase = true) || attributesTranslation.getOrNull(key)?.contains(filter, ignoreCase = true) == true)
</a><a href="#h13-0-98" id="h13-0-98" class="i">+                            } ?: emptyList()
</a><a href="#h13-0-99" id="h13-0-99" class="i">+                        }
</a><a href="#h13-0-100" id="h13-0-100" class="i">+
</a><a href="#h13-0-101" id="h13-0-101" class="i">+                        LazyColumn(
</a><a href="#h13-0-102" id="h13-0-102" class="i">+                            modifier = Modifier
</a><a href="#h13-0-103" id="h13-0-103" class="i">+                                .fillMaxHeight(0.7f)
</a><a href="#h13-0-104" id="h13-0-104" class="i">+                                .fillMaxWidth(),
</a><a href="#h13-0-105" id="h13-0-105" class="i">+                        ) {
</a><a href="#h13-0-106" id="h13-0-106" class="i">+                            stickyHeader {
</a><a href="#h13-0-107" id="h13-0-107" class="i">+                                TextField(
</a><a href="#h13-0-108" id="h13-0-108" class="i">+                                    modifier = Modifier.fillMaxWidth().padding(bottom = 5.dp),
</a><a href="#h13-0-109" id="h13-0-109" class="i">+                                    value = filter,
</a><a href="#h13-0-110" id="h13-0-110" class="i">+                                    onValueChange = { filter = it },
</a><a href="#h13-0-111" id="h13-0-111" class="i">+                                    label = { Text(&quot;Search&quot;) },
</a><a href="#h13-0-112" id="h13-0-112" class="i">+                                    colors = transparentTextFieldColors().copy(
</a><a href="#h13-0-113" id="h13-0-113" class="i">+                                        focusedContainerColor = MaterialTheme.colorScheme.surfaceBright,
</a><a href="#h13-0-114" id="h13-0-114" class="i">+                                        unfocusedContainerColor = MaterialTheme.colorScheme.surfaceBright
</a><a href="#h13-0-115" id="h13-0-115" class="i">+                                    )
</a><a href="#h13-0-116" id="h13-0-116" class="i">+                                )
</a><a href="#h13-0-117" id="h13-0-117" class="i">+                            }
</a><a href="#h13-0-118" id="h13-0-118" class="i">+                            item {
</a><a href="#h13-0-119" id="h13-0-119" class="i">+                                if (attributes.isEmpty()) {
</a><a href="#h13-0-120" id="h13-0-120" class="i">+                                    Text(&quot;No attributes&quot;)
</a><a href="#h13-0-121" id="h13-0-121" class="i">+                                }
</a><a href="#h13-0-122" id="h13-0-122" class="i">+                            }
</a><a href="#h13-0-123" id="h13-0-123" class="i">+                            items(attributes) { attribute -&gt;
</a><a href="#h13-0-124" id="h13-0-124" class="i">+                                Card(
</a><a href="#h13-0-125" id="h13-0-125" class="i">+                                    modifier = Modifier.padding(5.dp).fillMaxWidth(),
</a><a href="#h13-0-126" id="h13-0-126" class="i">+                                    onClick = {
</a><a href="#h13-0-127" id="h13-0-127" class="i">+                                        addEntryCallback(attribute, Color.White.toArgb())
</a><a href="#h13-0-128" id="h13-0-128" class="i">+                                        addAttributeDialog = false
</a><a href="#h13-0-129" id="h13-0-129" class="i">+                                    }
</a><a href="#h13-0-130" id="h13-0-130" class="i">+                                ) {
</a><a href="#h13-0-131" id="h13-0-131" class="i">+                                    val attributeTranslation = remember(attribute) {
</a><a href="#h13-0-132" id="h13-0-132" class="i">+                                        attributesTranslation.getOrNull(attribute)
</a><a href="#h13-0-133" id="h13-0-133" class="i">+                                    }
</a><a href="#h13-0-134" id="h13-0-134" class="i">+
</a><a href="#h13-0-135" id="h13-0-135" class="i">+                                    Column(
</a><a href="#h13-0-136" id="h13-0-136" class="i">+                                        modifier = Modifier.padding(8.dp)
</a><a href="#h13-0-137" id="h13-0-137" class="i">+                                    ) {
</a><a href="#h13-0-138" id="h13-0-138" class="i">+                                        Text(attributeTranslation ?: attribute, lineHeight = 15.sp)
</a><a href="#h13-0-139" id="h13-0-139" class="i">+                                        attributeTranslation?.let {
</a><a href="#h13-0-140" id="h13-0-140" class="i">+                                            Text(attribute, fontWeight = FontWeight.Light, fontSize = 10.sp, lineHeight = 15.sp)
</a><a href="#h13-0-141" id="h13-0-141" class="i">+                                        }
</a><a href="#h13-0-142" id="h13-0-142" class="i">+                                    }
</a><a href="#h13-0-143" id="h13-0-143" class="i">+                                }
</a><a href="#h13-0-144" id="h13-0-144" class="i">+                            }
</a><a href="#h13-0-145" id="h13-0-145" class="i">+                        }
</a><a href="#h13-0-146" id="h13-0-146" class="i">+                    }
</a><a href="#h13-0-147" id="h13-0-147" class="i">+                )
</a><a href="#h13-0-148" id="h13-0-148" class="i">+            }
</a><a href="#h13-0-149" id="h13-0-149" class="i">+
</a><a href="#h13-0-150" id="h13-0-150" class="i">+            FloatingActionButton(onClick = {
</a><a href="#h13-0-151" id="h13-0-151" class="i">+                addAttributeDialog = true
</a><a href="#h13-0-152" id="h13-0-152" class="i">+            }) {
</a><a href="#h13-0-153" id="h13-0-153" class="i">+                Icon(Icons.Default.Add, contentDescription = null)
</a><a href="#h13-0-154" id="h13-0-154" class="i">+            }
</a><a href="#h13-0-155" id="h13-0-155" class="i">+
</a><a href="#h13-0-156" id="h13-0-156" class="i">+            saveCallback?.let {
</a><a href="#h13-0-157" id="h13-0-157" class="i">+                FloatingActionButton(onClick = {
</a><a href="#h13-0-158" id="h13-0-158" class="i">+                    it()
</a><a href="#h13-0-159" id="h13-0-159" class="i">+                }) {
</a><a href="#h13-0-160" id="h13-0-160" class="i">+                    Icon(Icons.Default.Save, contentDescription = null)
</a><a href="#h13-0-161" id="h13-0-161" class="i">+                }
</a><a href="#h13-0-162" id="h13-0-162" class="i">+            }
</a><a href="#h13-0-163" id="h13-0-163" class="i">+        }
</a><a href="#h13-0-164" id="h13-0-164" class="i">+    }
</a><a href="#h13-0-165" id="h13-0-165" class="i">+
</a><a href="#h13-0-166" id="h13-0-166" class="i">+    override val content: @Composable (NavBackStackEntry) -&gt; Unit = {
</a><a href="#h13-0-167" id="h13-0-167" class="i">+        val coroutineScope = rememberCoroutineScope()
</a><a href="#h13-0-168" id="h13-0-168" class="i">+        val currentThemeId = remember { it.arguments?.getString(&quot;theme_id&quot;)?.toIntOrNull() }
</a><a href="#h13-0-169" id="h13-0-169" class="i">+
</a><a href="#h13-0-170" id="h13-0-170" class="i">+        LaunchedEffect(Unit) {
</a><a href="#h13-0-171" id="h13-0-171" class="i">+            themeColors.clear()
</a><a href="#h13-0-172" id="h13-0-172" class="i">+        }
</a><a href="#h13-0-173" id="h13-0-173" class="i">+
</a><a href="#h13-0-174" id="h13-0-174" class="i">+        var themeName by remember { mutableStateOf(&quot;&quot;) }
</a><a href="#h13-0-175" id="h13-0-175" class="i">+        var themeDescription by remember { mutableStateOf(&quot;&quot;) }
</a><a href="#h13-0-176" id="h13-0-176" class="i">+        var themeVersion by remember { mutableStateOf(&quot;1.0.0&quot;) }
</a><a href="#h13-0-177" id="h13-0-177" class="i">+        var themeAuthor by remember { mutableStateOf(&quot;&quot;) }
</a><a href="#h13-0-178" id="h13-0-178" class="i">+        var themeUpdateUrl by remember { mutableStateOf(&quot;&quot;) }
</a><a href="#h13-0-179" id="h13-0-179" class="i">+
</a><a href="#h13-0-180" id="h13-0-180" class="i">+        val themeInfo by rememberAsyncMutableState(defaultValue = null) {
</a><a href="#h13-0-181" id="h13-0-181" class="i">+            currentThemeId?.let { themeId -&gt;
</a><a href="#h13-0-182" id="h13-0-182" class="i">+                context.database.getThemeInfo(themeId)?.also { theme -&gt;
</a><a href="#h13-0-183" id="h13-0-183" class="i">+                    themeName = theme.name
</a><a href="#h13-0-184" id="h13-0-184" class="i">+                    themeDescription = theme.description ?: &quot;&quot;
</a><a href="#h13-0-185" id="h13-0-185" class="i">+                    theme.version?.let { themeVersion = it }
</a><a href="#h13-0-186" id="h13-0-186" class="i">+                    themeAuthor = theme.author ?: &quot;&quot;
</a><a href="#h13-0-187" id="h13-0-187" class="i">+                    themeUpdateUrl = theme.updateUrl ?: &quot;&quot;
</a><a href="#h13-0-188" id="h13-0-188" class="i">+                }
</a><a href="#h13-0-189" id="h13-0-189" class="i">+            }
</a><a href="#h13-0-190" id="h13-0-190" class="i">+        }
</a><a href="#h13-0-191" id="h13-0-191" class="i">+
</a><a href="#h13-0-192" id="h13-0-192" class="i">+        val lazyListState = rememberLazyListState()
</a><a href="#h13-0-193" id="h13-0-193" class="i">+
</a><a href="#h13-0-194" id="h13-0-194" class="i">+        rememberAsyncMutableState(defaultValue = DatabaseThemeContent(), keys = arrayOf(themeInfo)) {
</a><a href="#h13-0-195" id="h13-0-195" class="i">+            currentThemeId?.let {
</a><a href="#h13-0-196" id="h13-0-196" class="i">+                context.database.getThemeContent(it)?.also { content -&gt;
</a><a href="#h13-0-197" id="h13-0-197" class="i">+                    themeColors.clear()
</a><a href="#h13-0-198" id="h13-0-198" class="i">+                    themeColors.addAll(content.colors)
</a><a href="#h13-0-199" id="h13-0-199" class="i">+                    withContext(Dispatchers.Main) {
</a><a href="#h13-0-200" id="h13-0-200" class="i">+                        lazyListState.scrollToItem(themeColors.size)
</a><a href="#h13-0-201" id="h13-0-201" class="i">+                    }
</a><a href="#h13-0-202" id="h13-0-202" class="i">+                }
</a><a href="#h13-0-203" id="h13-0-203" class="i">+            } ?: DatabaseThemeContent()
</a><a href="#h13-0-204" id="h13-0-204" class="i">+        }
</a><a href="#h13-0-205" id="h13-0-205" class="i">+
</a><a href="#h13-0-206" id="h13-0-206" class="i">+        if (themeName.isNotBlank()) {
</a><a href="#h13-0-207" id="h13-0-207" class="i">+            saveCallback = {
</a><a href="#h13-0-208" id="h13-0-208" class="i">+                coroutineScope.launch(Dispatchers.IO) {
</a><a href="#h13-0-209" id="h13-0-209" class="i">+                    val theme = DatabaseTheme(
</a><a href="#h13-0-210" id="h13-0-210" class="i">+                        id = currentThemeId ?: -1,
</a><a href="#h13-0-211" id="h13-0-211" class="i">+                        enabled = themeInfo?.enabled ?: false,
</a><a href="#h13-0-212" id="h13-0-212" class="i">+                        name = themeName,
</a><a href="#h13-0-213" id="h13-0-213" class="i">+                        description = themeDescription,
</a><a href="#h13-0-214" id="h13-0-214" class="i">+                        version = themeVersion,
</a><a href="#h13-0-215" id="h13-0-215" class="i">+                        author = themeAuthor,
</a><a href="#h13-0-216" id="h13-0-216" class="i">+                        updateUrl = themeUpdateUrl
</a><a href="#h13-0-217" id="h13-0-217" class="i">+                    )
</a><a href="#h13-0-218" id="h13-0-218" class="i">+                    val themeId = context.database.addOrUpdateTheme(theme, currentThemeId)
</a><a href="#h13-0-219" id="h13-0-219" class="i">+                    context.database.setThemeContent(themeId, DatabaseThemeContent(
</a><a href="#h13-0-220" id="h13-0-220" class="i">+                        colors = themeColors
</a><a href="#h13-0-221" id="h13-0-221" class="i">+                    ))
</a><a href="#h13-0-222" id="h13-0-222" class="i">+                    withContext(Dispatchers.Main) {
</a><a href="#h13-0-223" id="h13-0-223" class="i">+                        routes.theming.navigateReload()
</a><a href="#h13-0-224" id="h13-0-224" class="i">+                    }
</a><a href="#h13-0-225" id="h13-0-225" class="i">+                }
</a><a href="#h13-0-226" id="h13-0-226" class="i">+            }
</a><a href="#h13-0-227" id="h13-0-227" class="i">+        } else {
</a><a href="#h13-0-228" id="h13-0-228" class="i">+            saveCallback = null
</a><a href="#h13-0-229" id="h13-0-229" class="i">+        }
</a><a href="#h13-0-230" id="h13-0-230" class="i">+
</a><a href="#h13-0-231" id="h13-0-231" class="i">+        LaunchedEffect(Unit) {
</a><a href="#h13-0-232" id="h13-0-232" class="i">+            deleteCallback = null
</a><a href="#h13-0-233" id="h13-0-233" class="i">+            if (currentThemeId != null) {
</a><a href="#h13-0-234" id="h13-0-234" class="i">+                deleteCallback = {
</a><a href="#h13-0-235" id="h13-0-235" class="i">+                    coroutineScope.launch(Dispatchers.IO) {
</a><a href="#h13-0-236" id="h13-0-236" class="i">+                        context.database.deleteTheme(currentThemeId)
</a><a href="#h13-0-237" id="h13-0-237" class="i">+                        withContext(Dispatchers.Main) {
</a><a href="#h13-0-238" id="h13-0-238" class="i">+                            routes.theming.navigateReload()
</a><a href="#h13-0-239" id="h13-0-239" class="i">+                        }
</a><a href="#h13-0-240" id="h13-0-240" class="i">+                    }
</a><a href="#h13-0-241" id="h13-0-241" class="i">+                }
</a><a href="#h13-0-242" id="h13-0-242" class="i">+            }
</a><a href="#h13-0-243" id="h13-0-243" class="i">+            addEntryCallback = { key, initialColor -&gt;
</a><a href="#h13-0-244" id="h13-0-244" class="i">+                coroutineScope.launch(Dispatchers.Main) {
</a><a href="#h13-0-245" id="h13-0-245" class="i">+                    themeColors.add(ThemeColorEntry(key, initialColor))
</a><a href="#h13-0-246" id="h13-0-246" class="i">+                    delay(100)
</a><a href="#h13-0-247" id="h13-0-247" class="i">+                    lazyListState.scrollToItem(themeColors.size)
</a><a href="#h13-0-248" id="h13-0-248" class="i">+                }
</a><a href="#h13-0-249" id="h13-0-249" class="i">+            }
</a><a href="#h13-0-250" id="h13-0-250" class="i">+        }
</a><a href="#h13-0-251" id="h13-0-251" class="i">+
</a><a href="#h13-0-252" id="h13-0-252" class="i">+        var moreOptionsExpanded by remember { mutableStateOf(false) }
</a><a href="#h13-0-253" id="h13-0-253" class="i">+
</a><a href="#h13-0-254" id="h13-0-254" class="i">+        Column(
</a><a href="#h13-0-255" id="h13-0-255" class="i">+            modifier = Modifier.fillMaxSize(),
</a><a href="#h13-0-256" id="h13-0-256" class="i">+            verticalArrangement = Arrangement.spacedBy(8.dp)
</a><a href="#h13-0-257" id="h13-0-257" class="i">+        ) {
</a><a href="#h13-0-258" id="h13-0-258" class="i">+            Row(
</a><a href="#h13-0-259" id="h13-0-259" class="i">+                verticalAlignment = Alignment.CenterVertically,
</a><a href="#h13-0-260" id="h13-0-260" class="i">+            ) {
</a><a href="#h13-0-261" id="h13-0-261" class="i">+                val focusRequester = remember { FocusRequester() }
</a><a href="#h13-0-262" id="h13-0-262" class="i">+
</a><a href="#h13-0-263" id="h13-0-263" class="i">+                TextField(
</a><a href="#h13-0-264" id="h13-0-264" class="i">+                    modifier = Modifier.weight(1f).focusRequester(focusRequester),
</a><a href="#h13-0-265" id="h13-0-265" class="i">+                    value = themeName,
</a><a href="#h13-0-266" id="h13-0-266" class="i">+                    onValueChange = { themeName = it },
</a><a href="#h13-0-267" id="h13-0-267" class="i">+                    label = { Text(&quot;Theme Name&quot;) },
</a><a href="#h13-0-268" id="h13-0-268" class="i">+                    colors = transparentTextFieldColors(),
</a><a href="#h13-0-269" id="h13-0-269" class="i">+                    singleLine = true,
</a><a href="#h13-0-270" id="h13-0-270" class="i">+                )
</a><a href="#h13-0-271" id="h13-0-271" class="i">+                LaunchedEffect(Unit) {
</a><a href="#h13-0-272" id="h13-0-272" class="i">+                    if (currentThemeId == null) {
</a><a href="#h13-0-273" id="h13-0-273" class="i">+                        delay(200)
</a><a href="#h13-0-274" id="h13-0-274" class="i">+                        focusRequester.requestFocus()
</a><a href="#h13-0-275" id="h13-0-275" class="i">+                    }
</a><a href="#h13-0-276" id="h13-0-276" class="i">+                }
</a><a href="#h13-0-277" id="h13-0-277" class="i">+                IconButton(
</a><a href="#h13-0-278" id="h13-0-278" class="i">+                    modifier = Modifier.padding(4.dp),
</a><a href="#h13-0-279" id="h13-0-279" class="i">+                    onClick = {
</a><a href="#h13-0-280" id="h13-0-280" class="i">+                        moreOptionsExpanded = !moreOptionsExpanded
</a><a href="#h13-0-281" id="h13-0-281" class="i">+                    }
</a><a href="#h13-0-282" id="h13-0-282" class="i">+                ) {
</a><a href="#h13-0-283" id="h13-0-283" class="i">+                    Icon(if (moreOptionsExpanded) Icons.Default.KeyboardArrowUp else Icons.Default.KeyboardArrowDown, contentDescription = null)
</a><a href="#h13-0-284" id="h13-0-284" class="i">+                }
</a><a href="#h13-0-285" id="h13-0-285" class="i">+            }
</a><a href="#h13-0-286" id="h13-0-286" class="i">+
</a><a href="#h13-0-287" id="h13-0-287" class="i">+            if (moreOptionsExpanded) {
</a><a href="#h13-0-288" id="h13-0-288" class="i">+                TextField(
</a><a href="#h13-0-289" id="h13-0-289" class="i">+                    modifier = Modifier.fillMaxWidth(),
</a><a href="#h13-0-290" id="h13-0-290" class="i">+                    maxLines = 3,
</a><a href="#h13-0-291" id="h13-0-291" class="i">+                    value = themeDescription,
</a><a href="#h13-0-292" id="h13-0-292" class="i">+                    onValueChange = { themeDescription = it },
</a><a href="#h13-0-293" id="h13-0-293" class="i">+                    label = { Text(&quot;Description&quot;) },
</a><a href="#h13-0-294" id="h13-0-294" class="i">+                    colors = transparentTextFieldColors()
</a><a href="#h13-0-295" id="h13-0-295" class="i">+                )
</a><a href="#h13-0-296" id="h13-0-296" class="i">+                TextField(
</a><a href="#h13-0-297" id="h13-0-297" class="i">+                    modifier = Modifier.fillMaxWidth(),
</a><a href="#h13-0-298" id="h13-0-298" class="i">+                    singleLine = true,
</a><a href="#h13-0-299" id="h13-0-299" class="i">+                    value = themeVersion,
</a><a href="#h13-0-300" id="h13-0-300" class="i">+                    onValueChange = { themeVersion = it },
</a><a href="#h13-0-301" id="h13-0-301" class="i">+                    label = { Text(&quot;Version&quot;) },
</a><a href="#h13-0-302" id="h13-0-302" class="i">+                    colors = transparentTextFieldColors()
</a><a href="#h13-0-303" id="h13-0-303" class="i">+                )
</a><a href="#h13-0-304" id="h13-0-304" class="i">+                TextField(
</a><a href="#h13-0-305" id="h13-0-305" class="i">+                    modifier = Modifier.fillMaxWidth(),
</a><a href="#h13-0-306" id="h13-0-306" class="i">+                    singleLine = true,
</a><a href="#h13-0-307" id="h13-0-307" class="i">+                    value = themeAuthor,
</a><a href="#h13-0-308" id="h13-0-308" class="i">+                    onValueChange = { themeAuthor = it },
</a><a href="#h13-0-309" id="h13-0-309" class="i">+                    label = { Text(&quot;Author&quot;) },
</a><a href="#h13-0-310" id="h13-0-310" class="i">+                    colors = transparentTextFieldColors()
</a><a href="#h13-0-311" id="h13-0-311" class="i">+                )
</a><a href="#h13-0-312" id="h13-0-312" class="i">+                TextField(
</a><a href="#h13-0-313" id="h13-0-313" class="i">+                    modifier = Modifier.fillMaxWidth(),
</a><a href="#h13-0-314" id="h13-0-314" class="i">+                    singleLine = true,
</a><a href="#h13-0-315" id="h13-0-315" class="i">+                    value = themeUpdateUrl,
</a><a href="#h13-0-316" id="h13-0-316" class="i">+                    onValueChange = { themeUpdateUrl = it },
</a><a href="#h13-0-317" id="h13-0-317" class="i">+                    label = { Text(&quot;Update URL&quot;) },
</a><a href="#h13-0-318" id="h13-0-318" class="i">+                    colors = transparentTextFieldColors()
</a><a href="#h13-0-319" id="h13-0-319" class="i">+                )
</a><a href="#h13-0-320" id="h13-0-320" class="i">+            }
</a><a href="#h13-0-321" id="h13-0-321" class="i">+
</a><a href="#h13-0-322" id="h13-0-322" class="i">+            LazyColumn(
</a><a href="#h13-0-323" id="h13-0-323" class="i">+                modifier = Modifier.fillMaxWidth(),
</a><a href="#h13-0-324" id="h13-0-324" class="i">+                state = lazyListState,
</a><a href="#h13-0-325" id="h13-0-325" class="i">+                contentPadding = PaddingValues(10.dp),
</a><a href="#h13-0-326" id="h13-0-326" class="i">+                verticalArrangement = Arrangement.spacedBy(4.dp),
</a><a href="#h13-0-327" id="h13-0-327" class="i">+                reverseLayout = true,
</a><a href="#h13-0-328" id="h13-0-328" class="i">+            ) {
</a><a href="#h13-0-329" id="h13-0-329" class="i">+                item {
</a><a href="#h13-0-330" id="h13-0-330" class="i">+                    Spacer(modifier = Modifier.height(150.dp))
</a><a href="#h13-0-331" id="h13-0-331" class="i">+                }
</a><a href="#h13-0-332" id="h13-0-332" class="i">+                items(themeColors) { colorEntry -&gt;
</a><a href="#h13-0-333" id="h13-0-333" class="i">+                    var showEditColorDialog by remember { mutableStateOf(false) }
</a><a href="#h13-0-334" id="h13-0-334" class="i">+                    var currentColor by remember { mutableIntStateOf(colorEntry.value) }
</a><a href="#h13-0-335" id="h13-0-335" class="i">+
</a><a href="#h13-0-336" id="h13-0-336" class="i">+                    ElevatedCard(
</a><a href="#h13-0-337" id="h13-0-337" class="i">+                        modifier = Modifier
</a><a href="#h13-0-338" id="h13-0-338" class="i">+                            .fillMaxWidth(),
</a><a href="#h13-0-339" id="h13-0-339" class="i">+                        onClick = {
</a><a href="#h13-0-340" id="h13-0-340" class="i">+                            showEditColorDialog = true
</a><a href="#h13-0-341" id="h13-0-341" class="i">+                        }
</a><a href="#h13-0-342" id="h13-0-342" class="i">+                    ) {
</a><a href="#h13-0-343" id="h13-0-343" class="i">+                        Row(
</a><a href="#h13-0-344" id="h13-0-344" class="i">+                            modifier = Modifier
</a><a href="#h13-0-345" id="h13-0-345" class="i">+                                .padding(4.dp)
</a><a href="#h13-0-346" id="h13-0-346" class="i">+                                .fillMaxWidth(),
</a><a href="#h13-0-347" id="h13-0-347" class="i">+                            verticalAlignment = Alignment.CenterVertically
</a><a href="#h13-0-348" id="h13-0-348" class="i">+                        ) {
</a><a href="#h13-0-349" id="h13-0-349" class="i">+                            Icon(Icons.Default.Colorize, contentDescription = null, modifier = Modifier.padding(8.dp))
</a><a href="#h13-0-350" id="h13-0-350" class="i">+                            Column(
</a><a href="#h13-0-351" id="h13-0-351" class="i">+                                modifier = Modifier.weight(1f)
</a><a href="#h13-0-352" id="h13-0-352" class="i">+                            ) {
</a><a href="#h13-0-353" id="h13-0-353" class="i">+                                val translation = remember(colorEntry.key) { context.translation.getOrNull(&quot;theming_attributes.${colorEntry.key}&quot;) }
</a><a href="#h13-0-354" id="h13-0-354" class="i">+                                Text(text = translation ?: colorEntry.key, overflow = TextOverflow.Ellipsis, maxLines = 1, lineHeight = 15.sp)
</a><a href="#h13-0-355" id="h13-0-355" class="i">+                                translation?.let {
</a><a href="#h13-0-356" id="h13-0-356" class="i">+                                    Text(text = colorEntry.key, fontSize = 10.sp, fontWeight = FontWeight.Light, overflow = TextOverflow.Ellipsis, maxLines = 1, lineHeight = 15.sp)
</a><a href="#h13-0-357" id="h13-0-357" class="i">+                                }
</a><a href="#h13-0-358" id="h13-0-358" class="i">+                            }
</a><a href="#h13-0-359" id="h13-0-359" class="i">+                            CircularAlphaTile(selectedColor = Color(currentColor))
</a><a href="#h13-0-360" id="h13-0-360" class="i">+                        }
</a><a href="#h13-0-361" id="h13-0-361" class="i">+                    }
</a><a href="#h13-0-362" id="h13-0-362" class="i">+
</a><a href="#h13-0-363" id="h13-0-363" class="i">+                    if (showEditColorDialog) {
</a><a href="#h13-0-364" id="h13-0-364" class="i">+                        Dialog(onDismissRequest = { showEditColorDialog = false }) {
</a><a href="#h13-0-365" id="h13-0-365" class="i">+                            alertDialogs.ColorPickerDialog(
</a><a href="#h13-0-366" id="h13-0-366" class="i">+                                initialColor = Color(currentColor),
</a><a href="#h13-0-367" id="h13-0-367" class="i">+                                setProperty = {
</a><a href="#h13-0-368" id="h13-0-368" class="i">+                                    if (it == null) {
</a><a href="#h13-0-369" id="h13-0-369" class="i">+                                        themeColors.remove(colorEntry)
</a><a href="#h13-0-370" id="h13-0-370" class="i">+                                        return@ColorPickerDialog
</a><a href="#h13-0-371" id="h13-0-371" class="i">+                                    }
</a><a href="#h13-0-372" id="h13-0-372" class="i">+                                    currentColor = it.toArgb()
</a><a href="#h13-0-373" id="h13-0-373" class="i">+                                    colorEntry.value = currentColor
</a><a href="#h13-0-374" id="h13-0-374" class="i">+                                },
</a><a href="#h13-0-375" id="h13-0-375" class="i">+                                dismiss = {
</a><a href="#h13-0-376" id="h13-0-376" class="i">+                                    showEditColorDialog = false
</a><a href="#h13-0-377" id="h13-0-377" class="i">+                                }
</a><a href="#h13-0-378" id="h13-0-378" class="i">+                            )
</a><a href="#h13-0-379" id="h13-0-379" class="i">+                        }
</a><a href="#h13-0-380" id="h13-0-380" class="i">+                    }
</a><a href="#h13-0-381" id="h13-0-381" class="i">+                }
</a><a href="#h13-0-382" id="h13-0-382" class="i">+                item {
</a><a href="#h13-0-383" id="h13-0-383" class="i">+                    if (themeColors.isEmpty()) {
</a><a href="#h13-0-384" id="h13-0-384" class="i">+                        Text(&quot;No colors added yet&quot;, modifier = Modifier
</a><a href="#h13-0-385" id="h13-0-385" class="i">+                            .fillMaxWidth()
</a><a href="#h13-0-386" id="h13-0-386" class="i">+                            .padding(8.dp), fontWeight = FontWeight.Light, textAlign = TextAlign.Center)
</a><a href="#h13-0-387" id="h13-0-387" class="i">+                    }
</a><a href="#h13-0-388" id="h13-0-388" class="i">+                }
</a><a href="#h13-0-389" id="h13-0-389" class="i">+            }
</a><a href="#h13-0-390" id="h13-0-390" class="i">+        }
</a><a href="#h13-0-391" id="h13-0-391" class="i">+    }
</a><a href="#h13-0-392" id="h13-0-392" class="i">+}</a><a href="#h13-0-393" id="h13-0-393" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h14" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/pages/theming/ThemeCatalog.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/pages/theming/ThemeCatalog.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/pages/theming/ThemeCatalog.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/pages/theming/ThemeCatalog.kt</a></b>
<a href="#h14-0" id="h14-0" class="h">@@ -0,0 +1,272 @@
</a><a href="#h14-0-0" id="h14-0-0" class="i">+package me.rhunk.snapenhance.ui.manager.pages.theming
</a><a href="#h14-0-1" id="h14-0-1" class="i">+
</a><a href="#h14-0-2" id="h14-0-2" class="i">+import android.net.Uri
</a><a href="#h14-0-3" id="h14-0-3" class="i">+import androidx.compose.foundation.layout.*
</a><a href="#h14-0-4" id="h14-0-4" class="i">+import androidx.compose.foundation.lazy.LazyColumn
</a><a href="#h14-0-5" id="h14-0-5" class="i">+import androidx.compose.foundation.lazy.items
</a><a href="#h14-0-6" id="h14-0-6" class="i">+import androidx.compose.material.icons.Icons
</a><a href="#h14-0-7" id="h14-0-7" class="i">+import androidx.compose.material.icons.filled.Palette
</a><a href="#h14-0-8" id="h14-0-8" class="i">+import androidx.compose.material3.*
</a><a href="#h14-0-9" id="h14-0-9" class="i">+import androidx.compose.runtime.*
</a><a href="#h14-0-10" id="h14-0-10" class="i">+import androidx.compose.ui.Alignment
</a><a href="#h14-0-11" id="h14-0-11" class="i">+import androidx.compose.ui.Modifier
</a><a href="#h14-0-12" id="h14-0-12" class="i">+import androidx.compose.ui.text.font.FontWeight
</a><a href="#h14-0-13" id="h14-0-13" class="i">+import androidx.compose.ui.text.style.TextAlign
</a><a href="#h14-0-14" id="h14-0-14" class="i">+import androidx.compose.ui.text.style.TextOverflow
</a><a href="#h14-0-15" id="h14-0-15" class="i">+import androidx.compose.ui.unit.dp
</a><a href="#h14-0-16" id="h14-0-16" class="i">+import androidx.compose.ui.unit.sp
</a><a href="#h14-0-17" id="h14-0-17" class="i">+import androidx.core.net.toUri
</a><a href="#h14-0-18" id="h14-0-18" class="i">+import kotlinx.coroutines.*
</a><a href="#h14-0-19" id="h14-0-19" class="i">+import me.rhunk.snapenhance.common.data.RepositoryIndex
</a><a href="#h14-0-20" id="h14-0-20" class="i">+import me.rhunk.snapenhance.common.ui.AsyncUpdateDispatcher
</a><a href="#h14-0-21" id="h14-0-21" class="i">+import me.rhunk.snapenhance.common.ui.rememberAsyncMutableState
</a><a href="#h14-0-22" id="h14-0-22" class="i">+import me.rhunk.snapenhance.common.ui.rememberAsyncMutableStateList
</a><a href="#h14-0-23" id="h14-0-23" class="i">+import me.rhunk.snapenhance.storage.getThemeList
</a><a href="#h14-0-24" id="h14-0-24" class="i">+import me.rhunk.snapenhance.storage.getRepositories
</a><a href="#h14-0-25" id="h14-0-25" class="i">+import me.rhunk.snapenhance.storage.getThemeIdByUpdateUrl
</a><a href="#h14-0-26" id="h14-0-26" class="i">+import me.rhunk.snapenhance.ui.util.pullrefresh.PullRefreshIndicator
</a><a href="#h14-0-27" id="h14-0-27" class="i">+import me.rhunk.snapenhance.ui.util.pullrefresh.pullRefresh
</a><a href="#h14-0-28" id="h14-0-28" class="i">+import me.rhunk.snapenhance.ui.util.pullrefresh.rememberPullRefreshState
</a><a href="#h14-0-29" id="h14-0-29" class="i">+import okhttp3.Request
</a><a href="#h14-0-30" id="h14-0-30" class="i">+
</a><a href="#h14-0-31" id="h14-0-31" class="i">+
</a><a href="#h14-0-32" id="h14-0-32" class="i">+private val cachedRepoIndexes = mutableStateMapOf&lt;String, RepositoryIndex&gt;()
</a><a href="#h14-0-33" id="h14-0-33" class="i">+private val cacheReloadDispatcher = AsyncUpdateDispatcher()
</a><a href="#h14-0-34" id="h14-0-34" class="i">+
</a><a href="#h14-0-35" id="h14-0-35" class="i">+@Composable
</a><a href="#h14-0-36" id="h14-0-36" class="i">+fun ThemeCatalog(root: ThemingRoot) {
</a><a href="#h14-0-37" id="h14-0-37" class="i">+    val context = remember { root.context }
</a><a href="#h14-0-38" id="h14-0-38" class="i">+    val coroutineScope = rememberCoroutineScope { Dispatchers.IO }
</a><a href="#h14-0-39" id="h14-0-39" class="i">+
</a><a href="#h14-0-40" id="h14-0-40" class="i">+    fun fetchRepoIndexes(): Map&lt;String, RepositoryIndex&gt;? {
</a><a href="#h14-0-41" id="h14-0-41" class="i">+        val indexes = mutableMapOf&lt;String, RepositoryIndex&gt;()
</a><a href="#h14-0-42" id="h14-0-42" class="i">+
</a><a href="#h14-0-43" id="h14-0-43" class="i">+        context.database.getRepositories().forEach { rootUri -&gt;
</a><a href="#h14-0-44" id="h14-0-44" class="i">+            val indexUri = rootUri.toUri().buildUpon().appendPath(&quot;index.json&quot;).build()
</a><a href="#h14-0-45" id="h14-0-45" class="i">+
</a><a href="#h14-0-46" id="h14-0-46" class="i">+            runCatching {
</a><a href="#h14-0-47" id="h14-0-47" class="i">+                root.okHttpClient.newCall(
</a><a href="#h14-0-48" id="h14-0-48" class="i">+                    Request.Builder().url(indexUri.toString()).build()
</a><a href="#h14-0-49" id="h14-0-49" class="i">+                ).execute().use { response -&gt;
</a><a href="#h14-0-50" id="h14-0-50" class="i">+                    if (!response.isSuccessful) {
</a><a href="#h14-0-51" id="h14-0-51" class="i">+                        context.log.error(&quot;Failed to fetch theme index from $indexUri: ${response.code}&quot;)
</a><a href="#h14-0-52" id="h14-0-52" class="i">+                        context.shortToast(&quot;Failed to fetch index of $indexUri&quot;)
</a><a href="#h14-0-53" id="h14-0-53" class="i">+                        return@forEach
</a><a href="#h14-0-54" id="h14-0-54" class="i">+                    }
</a><a href="#h14-0-55" id="h14-0-55" class="i">+
</a><a href="#h14-0-56" id="h14-0-56" class="i">+                    runCatching {
</a><a href="#h14-0-57" id="h14-0-57" class="i">+                        indexes[rootUri] = context.gson.fromJson(response.body.charStream(), RepositoryIndex::class.java)
</a><a href="#h14-0-58" id="h14-0-58" class="i">+                    }.onFailure {
</a><a href="#h14-0-59" id="h14-0-59" class="i">+                        context.log.error(&quot;Failed to parse theme index from $indexUri&quot;, it)
</a><a href="#h14-0-60" id="h14-0-60" class="i">+                        context.shortToast(&quot;Failed to parse index of $indexUri&quot;)
</a><a href="#h14-0-61" id="h14-0-61" class="i">+                    }
</a><a href="#h14-0-62" id="h14-0-62" class="i">+                }
</a><a href="#h14-0-63" id="h14-0-63" class="i">+            }.onFailure {
</a><a href="#h14-0-64" id="h14-0-64" class="i">+                context.log.error(&quot;Failed to fetch theme index from $indexUri&quot;, it)
</a><a href="#h14-0-65" id="h14-0-65" class="i">+                context.shortToast(&quot;Failed to fetch index of $indexUri&quot;)
</a><a href="#h14-0-66" id="h14-0-66" class="i">+            }
</a><a href="#h14-0-67" id="h14-0-67" class="i">+        }
</a><a href="#h14-0-68" id="h14-0-68" class="i">+
</a><a href="#h14-0-69" id="h14-0-69" class="i">+        return indexes
</a><a href="#h14-0-70" id="h14-0-70" class="i">+    }
</a><a href="#h14-0-71" id="h14-0-71" class="i">+
</a><a href="#h14-0-72" id="h14-0-72" class="i">+    suspend fun installTheme(themeUri: Uri) {
</a><a href="#h14-0-73" id="h14-0-73" class="i">+        root.okHttpClient.newCall(
</a><a href="#h14-0-74" id="h14-0-74" class="i">+            Request.Builder().url(themeUri.toString()).build()
</a><a href="#h14-0-75" id="h14-0-75" class="i">+        ).execute().use { response -&gt;
</a><a href="#h14-0-76" id="h14-0-76" class="i">+            if (!response.isSuccessful) {
</a><a href="#h14-0-77" id="h14-0-77" class="i">+                context.log.error(&quot;Failed to fetch theme from $themeUri: ${response.code}&quot;)
</a><a href="#h14-0-78" id="h14-0-78" class="i">+                context.shortToast(&quot;Failed to fetch theme from $themeUri&quot;)
</a><a href="#h14-0-79" id="h14-0-79" class="i">+                return
</a><a href="#h14-0-80" id="h14-0-80" class="i">+            }
</a><a href="#h14-0-81" id="h14-0-81" class="i">+
</a><a href="#h14-0-82" id="h14-0-82" class="i">+            val themeContent = response.body.bytes().toString(Charsets.UTF_8)
</a><a href="#h14-0-83" id="h14-0-83" class="i">+            root.importTheme(themeContent, themeUri.toString())
</a><a href="#h14-0-84" id="h14-0-84" class="i">+        }
</a><a href="#h14-0-85" id="h14-0-85" class="i">+    }
</a><a href="#h14-0-86" id="h14-0-86" class="i">+
</a><a href="#h14-0-87" id="h14-0-87" class="i">+    var isRefreshing by remember { mutableStateOf(false) }
</a><a href="#h14-0-88" id="h14-0-88" class="i">+
</a><a href="#h14-0-89" id="h14-0-89" class="i">+    suspend fun refreshCachedIndexes() {
</a><a href="#h14-0-90" id="h14-0-90" class="i">+        isRefreshing = true
</a><a href="#h14-0-91" id="h14-0-91" class="i">+        coroutineScope {
</a><a href="#h14-0-92" id="h14-0-92" class="i">+            launch(Dispatchers.IO) {
</a><a href="#h14-0-93" id="h14-0-93" class="i">+                fetchRepoIndexes()?.let {
</a><a href="#h14-0-94" id="h14-0-94" class="i">+                    context.log.verbose(&quot;Fetched ${it.size} theme indexes&quot;)
</a><a href="#h14-0-95" id="h14-0-95" class="i">+                    it.forEach { (t, u) -&gt;
</a><a href="#h14-0-96" id="h14-0-96" class="i">+                        context.log.verbose(&quot;Fetched theme index from $t with ${u.themes.size} themes&quot;)
</a><a href="#h14-0-97" id="h14-0-97" class="i">+                    }
</a><a href="#h14-0-98" id="h14-0-98" class="i">+                    synchronized(cachedRepoIndexes) {
</a><a href="#h14-0-99" id="h14-0-99" class="i">+                        cachedRepoIndexes.clear()
</a><a href="#h14-0-100" id="h14-0-100" class="i">+                        cachedRepoIndexes += it
</a><a href="#h14-0-101" id="h14-0-101" class="i">+                    }
</a><a href="#h14-0-102" id="h14-0-102" class="i">+                    cacheReloadDispatcher.dispatch()
</a><a href="#h14-0-103" id="h14-0-103" class="i">+                    delay(600)
</a><a href="#h14-0-104" id="h14-0-104" class="i">+                    isRefreshing = false
</a><a href="#h14-0-105" id="h14-0-105" class="i">+                }
</a><a href="#h14-0-106" id="h14-0-106" class="i">+            }
</a><a href="#h14-0-107" id="h14-0-107" class="i">+        }
</a><a href="#h14-0-108" id="h14-0-108" class="i">+    }
</a><a href="#h14-0-109" id="h14-0-109" class="i">+
</a><a href="#h14-0-110" id="h14-0-110" class="i">+    val installedThemes = rememberAsyncMutableStateList(defaultValue = listOf(), updateDispatcher = root.localReloadDispatcher, keys = arrayOf(cachedRepoIndexes)) {
</a><a href="#h14-0-111" id="h14-0-111" class="i">+        context.database.getThemeList()
</a><a href="#h14-0-112" id="h14-0-112" class="i">+    }
</a><a href="#h14-0-113" id="h14-0-113" class="i">+
</a><a href="#h14-0-114" id="h14-0-114" class="i">+    val remoteThemes by rememberAsyncMutableState(defaultValue = listOf(), updateDispatcher = cacheReloadDispatcher, keys = arrayOf(root.searchFilter.value)) {
</a><a href="#h14-0-115" id="h14-0-115" class="i">+        cachedRepoIndexes.entries.flatMap {
</a><a href="#h14-0-116" id="h14-0-116" class="i">+            it.value.themes.map { theme -&gt; it.key to theme }
</a><a href="#h14-0-117" id="h14-0-117" class="i">+        }.let {
</a><a href="#h14-0-118" id="h14-0-118" class="i">+            val filter = root.searchFilter.value
</a><a href="#h14-0-119" id="h14-0-119" class="i">+            if (filter.isNotBlank()) {
</a><a href="#h14-0-120" id="h14-0-120" class="i">+                it.filter { (_, theme) -&gt;
</a><a href="#h14-0-121" id="h14-0-121" class="i">+                    theme.name.contains(filter, ignoreCase = true) || theme.description?.contains(filter, ignoreCase = true) == true
</a><a href="#h14-0-122" id="h14-0-122" class="i">+                }
</a><a href="#h14-0-123" id="h14-0-123" class="i">+            } else it
</a><a href="#h14-0-124" id="h14-0-124" class="i">+        }
</a><a href="#h14-0-125" id="h14-0-125" class="i">+    }
</a><a href="#h14-0-126" id="h14-0-126" class="i">+
</a><a href="#h14-0-127" id="h14-0-127" class="i">+    LaunchedEffect(Unit) {
</a><a href="#h14-0-128" id="h14-0-128" class="i">+        if (cachedRepoIndexes.isNotEmpty()) return@LaunchedEffect
</a><a href="#h14-0-129" id="h14-0-129" class="i">+        isRefreshing = true
</a><a href="#h14-0-130" id="h14-0-130" class="i">+        coroutineScope.launch {
</a><a href="#h14-0-131" id="h14-0-131" class="i">+            refreshCachedIndexes()
</a><a href="#h14-0-132" id="h14-0-132" class="i">+        }
</a><a href="#h14-0-133" id="h14-0-133" class="i">+    }
</a><a href="#h14-0-134" id="h14-0-134" class="i">+
</a><a href="#h14-0-135" id="h14-0-135" class="i">+    val pullRefreshState = rememberPullRefreshState(isRefreshing, onRefresh = {
</a><a href="#h14-0-136" id="h14-0-136" class="i">+        coroutineScope.launch {
</a><a href="#h14-0-137" id="h14-0-137" class="i">+            refreshCachedIndexes()
</a><a href="#h14-0-138" id="h14-0-138" class="i">+        }
</a><a href="#h14-0-139" id="h14-0-139" class="i">+    })
</a><a href="#h14-0-140" id="h14-0-140" class="i">+
</a><a href="#h14-0-141" id="h14-0-141" class="i">+    Box(
</a><a href="#h14-0-142" id="h14-0-142" class="i">+        modifier = Modifier.fillMaxSize()
</a><a href="#h14-0-143" id="h14-0-143" class="i">+    ) {
</a><a href="#h14-0-144" id="h14-0-144" class="i">+        LazyColumn(
</a><a href="#h14-0-145" id="h14-0-145" class="i">+            modifier = Modifier
</a><a href="#h14-0-146" id="h14-0-146" class="i">+                .fillMaxSize()
</a><a href="#h14-0-147" id="h14-0-147" class="i">+                .pullRefresh(pullRefreshState),
</a><a href="#h14-0-148" id="h14-0-148" class="i">+            contentPadding = PaddingValues(8.dp)
</a><a href="#h14-0-149" id="h14-0-149" class="i">+        ) {
</a><a href="#h14-0-150" id="h14-0-150" class="i">+            item {
</a><a href="#h14-0-151" id="h14-0-151" class="i">+                if (remoteThemes.isEmpty()) {
</a><a href="#h14-0-152" id="h14-0-152" class="i">+                    Text(
</a><a href="#h14-0-153" id="h14-0-153" class="i">+                        text = &quot;No themes available&quot;,
</a><a href="#h14-0-154" id="h14-0-154" class="i">+                        modifier = Modifier
</a><a href="#h14-0-155" id="h14-0-155" class="i">+                            .padding(16.dp)
</a><a href="#h14-0-156" id="h14-0-156" class="i">+                            .fillMaxWidth(),
</a><a href="#h14-0-157" id="h14-0-157" class="i">+                        textAlign = TextAlign.Center,
</a><a href="#h14-0-158" id="h14-0-158" class="i">+                        fontSize = 15.sp,
</a><a href="#h14-0-159" id="h14-0-159" class="i">+                        fontWeight = FontWeight.Light
</a><a href="#h14-0-160" id="h14-0-160" class="i">+                    )
</a><a href="#h14-0-161" id="h14-0-161" class="i">+                }
</a><a href="#h14-0-162" id="h14-0-162" class="i">+            }
</a><a href="#h14-0-163" id="h14-0-163" class="i">+            items(remoteThemes, key = { it.first + it.second.hashCode() }) { (_, themeManifest) -&gt;
</a><a href="#h14-0-164" id="h14-0-164" class="i">+                val themeUri = remember {
</a><a href="#h14-0-165" id="h14-0-165" class="i">+                    cachedRepoIndexes.entries.find { it.value.themes.contains(themeManifest) }?.key?.toUri()?.buildUpon()?.appendPath(themeManifest.filepath)?.build()
</a><a href="#h14-0-166" id="h14-0-166" class="i">+                }
</a><a href="#h14-0-167" id="h14-0-167" class="i">+
</a><a href="#h14-0-168" id="h14-0-168" class="i">+                val hasUpdate by rememberAsyncMutableState(defaultValue = false, keys = arrayOf(themeManifest)) {
</a><a href="#h14-0-169" id="h14-0-169" class="i">+                    installedThemes.takeIf { themeUri != null }?.find { it.updateUrl == themeUri.toString() }?.let { installedTheme -&gt;
</a><a href="#h14-0-170" id="h14-0-170" class="i">+                        installedTheme.version != themeManifest.version
</a><a href="#h14-0-171" id="h14-0-171" class="i">+                    } ?: false
</a><a href="#h14-0-172" id="h14-0-172" class="i">+                }
</a><a href="#h14-0-173" id="h14-0-173" class="i">+
</a><a href="#h14-0-174" id="h14-0-174" class="i">+                var isInstalling by rememberAsyncMutableState(defaultValue = false, keys = arrayOf(themeManifest)) {
</a><a href="#h14-0-175" id="h14-0-175" class="i">+                    false
</a><a href="#h14-0-176" id="h14-0-176" class="i">+                }
</a><a href="#h14-0-177" id="h14-0-177" class="i">+
</a><a href="#h14-0-178" id="h14-0-178" class="i">+                var isInstalled by rememberAsyncMutableState(defaultValue = true, keys = arrayOf(themeManifest)) {
</a><a href="#h14-0-179" id="h14-0-179" class="i">+                    context.database.getThemeIdByUpdateUrl(themeUri.toString()) != null
</a><a href="#h14-0-180" id="h14-0-180" class="i">+                }
</a><a href="#h14-0-181" id="h14-0-181" class="i">+
</a><a href="#h14-0-182" id="h14-0-182" class="i">+                ElevatedCard(onClick = {
</a><a href="#h14-0-183" id="h14-0-183" class="i">+                    //TODO: Show theme details
</a><a href="#h14-0-184" id="h14-0-184" class="i">+                }) {
</a><a href="#h14-0-185" id="h14-0-185" class="i">+                    Row(
</a><a href="#h14-0-186" id="h14-0-186" class="i">+                        modifier = Modifier
</a><a href="#h14-0-187" id="h14-0-187" class="i">+                            .fillMaxWidth()
</a><a href="#h14-0-188" id="h14-0-188" class="i">+                            .padding(8.dp),
</a><a href="#h14-0-189" id="h14-0-189" class="i">+                        verticalAlignment = Alignment.CenterVertically
</a><a href="#h14-0-190" id="h14-0-190" class="i">+                    ) {
</a><a href="#h14-0-191" id="h14-0-191" class="i">+                        Icon(Icons.Default.Palette, contentDescription = null, modifier = Modifier.padding(16.dp))
</a><a href="#h14-0-192" id="h14-0-192" class="i">+                        Column(
</a><a href="#h14-0-193" id="h14-0-193" class="i">+                            modifier = Modifier.weight(1f),
</a><a href="#h14-0-194" id="h14-0-194" class="i">+                            verticalArrangement = Arrangement.Center
</a><a href="#h14-0-195" id="h14-0-195" class="i">+                        ) {
</a><a href="#h14-0-196" id="h14-0-196" class="i">+                            Row(
</a><a href="#h14-0-197" id="h14-0-197" class="i">+                                horizontalArrangement = Arrangement.spacedBy(4.dp),
</a><a href="#h14-0-198" id="h14-0-198" class="i">+                                verticalAlignment = Alignment.Bottom
</a><a href="#h14-0-199" id="h14-0-199" class="i">+                            ) {
</a><a href="#h14-0-200" id="h14-0-200" class="i">+                                Text(
</a><a href="#h14-0-201" id="h14-0-201" class="i">+                                    text = themeManifest.name,
</a><a href="#h14-0-202" id="h14-0-202" class="i">+                                    maxLines = 1,
</a><a href="#h14-0-203" id="h14-0-203" class="i">+                                    overflow = TextOverflow.Ellipsis,
</a><a href="#h14-0-204" id="h14-0-204" class="i">+                                )
</a><a href="#h14-0-205" id="h14-0-205" class="i">+                                themeManifest.author?.let {
</a><a href="#h14-0-206" id="h14-0-206" class="i">+                                    Text(
</a><a href="#h14-0-207" id="h14-0-207" class="i">+                                        text = &quot;by $it&quot;,
</a><a href="#h14-0-208" id="h14-0-208" class="i">+                                        maxLines = 1,
</a><a href="#h14-0-209" id="h14-0-209" class="i">+                                        fontSize = 10.sp,
</a><a href="#h14-0-210" id="h14-0-210" class="i">+                                        fontWeight = FontWeight.Light,
</a><a href="#h14-0-211" id="h14-0-211" class="i">+                                        overflow = TextOverflow.Ellipsis,
</a><a href="#h14-0-212" id="h14-0-212" class="i">+                                    )
</a><a href="#h14-0-213" id="h14-0-213" class="i">+                                }
</a><a href="#h14-0-214" id="h14-0-214" class="i">+                            }
</a><a href="#h14-0-215" id="h14-0-215" class="i">+                            themeManifest.description?.let {
</a><a href="#h14-0-216" id="h14-0-216" class="i">+                                Text(
</a><a href="#h14-0-217" id="h14-0-217" class="i">+                                    text = it,
</a><a href="#h14-0-218" id="h14-0-218" class="i">+                                    fontSize = 12.sp,
</a><a href="#h14-0-219" id="h14-0-219" class="i">+                                    maxLines = 3,
</a><a href="#h14-0-220" id="h14-0-220" class="i">+                                    overflow = TextOverflow.Ellipsis,
</a><a href="#h14-0-221" id="h14-0-221" class="i">+                                )
</a><a href="#h14-0-222" id="h14-0-222" class="i">+                            }
</a><a href="#h14-0-223" id="h14-0-223" class="i">+                            if (hasUpdate) {
</a><a href="#h14-0-224" id="h14-0-224" class="i">+                                Text(
</a><a href="#h14-0-225" id="h14-0-225" class="i">+                                    text = &quot;Version ${themeManifest.version} available&quot;,
</a><a href="#h14-0-226" id="h14-0-226" class="i">+                                    fontWeight = FontWeight.Bold
</a><a href="#h14-0-227" id="h14-0-227" class="i">+                                )
</a><a href="#h14-0-228" id="h14-0-228" class="i">+                            }
</a><a href="#h14-0-229" id="h14-0-229" class="i">+                        }
</a><a href="#h14-0-230" id="h14-0-230" class="i">+                        Row(
</a><a href="#h14-0-231" id="h14-0-231" class="i">+                            verticalAlignment = Alignment.CenterVertically
</a><a href="#h14-0-232" id="h14-0-232" class="i">+                        ) {
</a><a href="#h14-0-233" id="h14-0-233" class="i">+                            if (isInstalling) {
</a><a href="#h14-0-234" id="h14-0-234" class="i">+                                CircularProgressIndicator(modifier = Modifier.size(24.dp), strokeWidth = 2.dp)
</a><a href="#h14-0-235" id="h14-0-235" class="i">+                            } else {
</a><a href="#h14-0-236" id="h14-0-236" class="i">+                                Button(
</a><a href="#h14-0-237" id="h14-0-237" class="i">+                                    enabled = !isInstalled || hasUpdate,
</a><a href="#h14-0-238" id="h14-0-238" class="i">+                                    onClick = {
</a><a href="#h14-0-239" id="h14-0-239" class="i">+                                        isInstalling = true
</a><a href="#h14-0-240" id="h14-0-240" class="i">+                                        context.coroutineScope.launch {
</a><a href="#h14-0-241" id="h14-0-241" class="i">+                                            runCatching {
</a><a href="#h14-0-242" id="h14-0-242" class="i">+                                                installTheme(themeUri ?: throw IllegalStateException(&quot;Failed to get theme URI&quot;))
</a><a href="#h14-0-243" id="h14-0-243" class="i">+                                                isInstalled = true
</a><a href="#h14-0-244" id="h14-0-244" class="i">+                                            }.onFailure {
</a><a href="#h14-0-245" id="h14-0-245" class="i">+                                                context.log.error(&quot;Failed to install theme ${themeManifest.name}&quot;, it)
</a><a href="#h14-0-246" id="h14-0-246" class="i">+                                                context.shortToast(&quot;Failed to install theme ${themeManifest.name}. ${it.message}&quot;)
</a><a href="#h14-0-247" id="h14-0-247" class="i">+                                            }
</a><a href="#h14-0-248" id="h14-0-248" class="i">+                                            isInstalling = false
</a><a href="#h14-0-249" id="h14-0-249" class="i">+                                        }
</a><a href="#h14-0-250" id="h14-0-250" class="i">+                                    }
</a><a href="#h14-0-251" id="h14-0-251" class="i">+                                ) {
</a><a href="#h14-0-252" id="h14-0-252" class="i">+                                    if (hasUpdate) {
</a><a href="#h14-0-253" id="h14-0-253" class="i">+                                        Text(&quot;Update&quot;)
</a><a href="#h14-0-254" id="h14-0-254" class="i">+                                    } else {
</a><a href="#h14-0-255" id="h14-0-255" class="i">+                                        Text(if (isInstalled) &quot;Installed&quot; else &quot;Install&quot;)
</a><a href="#h14-0-256" id="h14-0-256" class="i">+                                    }
</a><a href="#h14-0-257" id="h14-0-257" class="i">+                                }
</a><a href="#h14-0-258" id="h14-0-258" class="i">+                            }
</a><a href="#h14-0-259" id="h14-0-259" class="i">+                        }
</a><a href="#h14-0-260" id="h14-0-260" class="i">+                    }
</a><a href="#h14-0-261" id="h14-0-261" class="i">+                }
</a><a href="#h14-0-262" id="h14-0-262" class="i">+            }
</a><a href="#h14-0-263" id="h14-0-263" class="i">+        }
</a><a href="#h14-0-264" id="h14-0-264" class="i">+
</a><a href="#h14-0-265" id="h14-0-265" class="i">+        PullRefreshIndicator(
</a><a href="#h14-0-266" id="h14-0-266" class="i">+            refreshing = isRefreshing,
</a><a href="#h14-0-267" id="h14-0-267" class="i">+            state = pullRefreshState,
</a><a href="#h14-0-268" id="h14-0-268" class="i">+            modifier = Modifier.align(Alignment.TopCenter)
</a><a href="#h14-0-269" id="h14-0-269" class="i">+        )
</a><a href="#h14-0-270" id="h14-0-270" class="i">+    }
</a><a href="#h14-0-271" id="h14-0-271" class="i">+}</a><a href="#h14-0-272" id="h14-0-272" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h15" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/pages/theming/ThemingRoot.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/pages/theming/ThemingRoot.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/pages/theming/ThemingRoot.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/pages/theming/ThemingRoot.kt</a></b>
<a href="#h15-0" id="h15-0" class="h">@@ -0,0 +1,463 @@
</a><a href="#h15-0-0" id="h15-0-0" class="i">+package me.rhunk.snapenhance.ui.manager.pages.theming
</a><a href="#h15-0-1" id="h15-0-1" class="i">+
</a><a href="#h15-0-2" id="h15-0-2" class="i">+import androidx.compose.foundation.ExperimentalFoundationApi
</a><a href="#h15-0-3" id="h15-0-3" class="i">+import androidx.compose.foundation.clickable
</a><a href="#h15-0-4" id="h15-0-4" class="i">+import androidx.compose.foundation.layout.*
</a><a href="#h15-0-5" id="h15-0-5" class="i">+import androidx.compose.foundation.lazy.LazyColumn
</a><a href="#h15-0-6" id="h15-0-6" class="i">+import androidx.compose.foundation.lazy.items
</a><a href="#h15-0-7" id="h15-0-7" class="i">+import androidx.compose.foundation.pager.HorizontalPager
</a><a href="#h15-0-8" id="h15-0-8" class="i">+import androidx.compose.foundation.pager.rememberPagerState
</a><a href="#h15-0-9" id="h15-0-9" class="i">+import androidx.compose.material.icons.Icons
</a><a href="#h15-0-10" id="h15-0-10" class="i">+import androidx.compose.material.icons.filled.*
</a><a href="#h15-0-11" id="h15-0-11" class="i">+import androidx.compose.material3.*
</a><a href="#h15-0-12" id="h15-0-12" class="i">+import androidx.compose.runtime.*
</a><a href="#h15-0-13" id="h15-0-13" class="i">+import androidx.compose.ui.Alignment
</a><a href="#h15-0-14" id="h15-0-14" class="i">+import androidx.compose.ui.Modifier
</a><a href="#h15-0-15" id="h15-0-15" class="i">+import androidx.compose.ui.focus.FocusRequester
</a><a href="#h15-0-16" id="h15-0-16" class="i">+import androidx.compose.ui.focus.focusRequester
</a><a href="#h15-0-17" id="h15-0-17" class="i">+import androidx.compose.ui.layout.onGloballyPositioned
</a><a href="#h15-0-18" id="h15-0-18" class="i">+import androidx.compose.ui.text.font.FontWeight
</a><a href="#h15-0-19" id="h15-0-19" class="i">+import androidx.compose.ui.text.style.TextAlign
</a><a href="#h15-0-20" id="h15-0-20" class="i">+import androidx.compose.ui.text.style.TextOverflow
</a><a href="#h15-0-21" id="h15-0-21" class="i">+import androidx.compose.ui.unit.dp
</a><a href="#h15-0-22" id="h15-0-22" class="i">+import androidx.compose.ui.unit.sp
</a><a href="#h15-0-23" id="h15-0-23" class="i">+import androidx.core.net.toUri
</a><a href="#h15-0-24" id="h15-0-24" class="i">+import androidx.navigation.NavBackStackEntry
</a><a href="#h15-0-25" id="h15-0-25" class="i">+import kotlinx.coroutines.Dispatchers
</a><a href="#h15-0-26" id="h15-0-26" class="i">+import kotlinx.coroutines.launch
</a><a href="#h15-0-27" id="h15-0-27" class="i">+import kotlinx.coroutines.withContext
</a><a href="#h15-0-28" id="h15-0-28" class="i">+import me.rhunk.snapenhance.common.data.DatabaseTheme
</a><a href="#h15-0-29" id="h15-0-29" class="i">+import me.rhunk.snapenhance.common.data.DatabaseThemeContent
</a><a href="#h15-0-30" id="h15-0-30" class="i">+import me.rhunk.snapenhance.common.data.ExportedTheme
</a><a href="#h15-0-31" id="h15-0-31" class="i">+import me.rhunk.snapenhance.common.ui.AsyncUpdateDispatcher
</a><a href="#h15-0-32" id="h15-0-32" class="i">+import me.rhunk.snapenhance.common.ui.rememberAsyncMutableStateList
</a><a href="#h15-0-33" id="h15-0-33" class="i">+import me.rhunk.snapenhance.common.ui.transparentTextFieldColors
</a><a href="#h15-0-34" id="h15-0-34" class="i">+import me.rhunk.snapenhance.common.util.ktx.getUrlFromClipboard
</a><a href="#h15-0-35" id="h15-0-35" class="i">+import me.rhunk.snapenhance.storage.*
</a><a href="#h15-0-36" id="h15-0-36" class="i">+import me.rhunk.snapenhance.ui.manager.Routes
</a><a href="#h15-0-37" id="h15-0-37" class="i">+import me.rhunk.snapenhance.ui.util.ActivityLauncherHelper
</a><a href="#h15-0-38" id="h15-0-38" class="i">+import me.rhunk.snapenhance.ui.util.openFile
</a><a href="#h15-0-39" id="h15-0-39" class="i">+import me.rhunk.snapenhance.ui.util.pagerTabIndicatorOffset
</a><a href="#h15-0-40" id="h15-0-40" class="i">+import me.rhunk.snapenhance.ui.util.saveFile
</a><a href="#h15-0-41" id="h15-0-41" class="i">+import okhttp3.OkHttpClient
</a><a href="#h15-0-42" id="h15-0-42" class="i">+
</a><a href="#h15-0-43" id="h15-0-43" class="i">+class ThemingRoot: Routes.Route() {
</a><a href="#h15-0-44" id="h15-0-44" class="i">+    val localReloadDispatcher = AsyncUpdateDispatcher()
</a><a href="#h15-0-45" id="h15-0-45" class="i">+    private lateinit var activityLauncherHelper: ActivityLauncherHelper
</a><a href="#h15-0-46" id="h15-0-46" class="i">+
</a><a href="#h15-0-47" id="h15-0-47" class="i">+    private var currentPage by mutableIntStateOf(0)
</a><a href="#h15-0-48" id="h15-0-48" class="i">+    val okHttpClient by lazy { OkHttpClient() }
</a><a href="#h15-0-49" id="h15-0-49" class="i">+    val searchFilter = mutableStateOf(&quot;&quot;)
</a><a href="#h15-0-50" id="h15-0-50" class="i">+
</a><a href="#h15-0-51" id="h15-0-51" class="i">+
</a><a href="#h15-0-52" id="h15-0-52" class="i">+    private fun exportTheme(theme: DatabaseTheme) {
</a><a href="#h15-0-53" id="h15-0-53" class="i">+        context.coroutineScope.launch {
</a><a href="#h15-0-54" id="h15-0-54" class="i">+            val exportedTheme = theme.toExportedTheme(context.database.getThemeContent(theme.id) ?: DatabaseThemeContent())
</a><a href="#h15-0-55" id="h15-0-55" class="i">+
</a><a href="#h15-0-56" id="h15-0-56" class="i">+            activityLauncherHelper.saveFile(theme.name.replace(&quot; &quot;, &quot;_&quot;).lowercase() + &quot;.json&quot;) { uri -&gt;
</a><a href="#h15-0-57" id="h15-0-57" class="i">+                runCatching {
</a><a href="#h15-0-58" id="h15-0-58" class="i">+                    context.androidContext.contentResolver.openOutputStream(uri.toUri())?.use { outputStream -&gt;
</a><a href="#h15-0-59" id="h15-0-59" class="i">+                        outputStream.write(context.gson.toJson(exportedTheme).toByteArray())
</a><a href="#h15-0-60" id="h15-0-60" class="i">+                        outputStream.flush()
</a><a href="#h15-0-61" id="h15-0-61" class="i">+                    }
</a><a href="#h15-0-62" id="h15-0-62" class="i">+                    context.shortToast(&quot;Theme exported successfully&quot;)
</a><a href="#h15-0-63" id="h15-0-63" class="i">+                }.onFailure {
</a><a href="#h15-0-64" id="h15-0-64" class="i">+                    context.log.error(&quot;Failed to save theme&quot;, it)
</a><a href="#h15-0-65" id="h15-0-65" class="i">+                    context.longToast(&quot;Failed to export theme! Check logs for more details&quot;)
</a><a href="#h15-0-66" id="h15-0-66" class="i">+                }
</a><a href="#h15-0-67" id="h15-0-67" class="i">+            }
</a><a href="#h15-0-68" id="h15-0-68" class="i">+        }
</a><a href="#h15-0-69" id="h15-0-69" class="i">+    }
</a><a href="#h15-0-70" id="h15-0-70" class="i">+
</a><a href="#h15-0-71" id="h15-0-71" class="i">+    private fun duplicateTheme(theme: DatabaseTheme) {
</a><a href="#h15-0-72" id="h15-0-72" class="i">+        context.coroutineScope.launch {
</a><a href="#h15-0-73" id="h15-0-73" class="i">+            val themeId = context.database.addOrUpdateTheme(theme.copy(
</a><a href="#h15-0-74" id="h15-0-74" class="i">+                updateUrl = null
</a><a href="#h15-0-75" id="h15-0-75" class="i">+            ))
</a><a href="#h15-0-76" id="h15-0-76" class="i">+            context.database.setThemeContent(themeId, context.database.getThemeContent(theme.id) ?: DatabaseThemeContent())
</a><a href="#h15-0-77" id="h15-0-77" class="i">+            context.shortToast(&quot;Theme duplicated successfully&quot;)
</a><a href="#h15-0-78" id="h15-0-78" class="i">+            withContext(Dispatchers.Main) {
</a><a href="#h15-0-79" id="h15-0-79" class="i">+                localReloadDispatcher.dispatch()
</a><a href="#h15-0-80" id="h15-0-80" class="i">+            }
</a><a href="#h15-0-81" id="h15-0-81" class="i">+        }
</a><a href="#h15-0-82" id="h15-0-82" class="i">+    }
</a><a href="#h15-0-83" id="h15-0-83" class="i">+
</a><a href="#h15-0-84" id="h15-0-84" class="i">+    suspend fun importTheme(content: String, updateUrl: String? = null) {
</a><a href="#h15-0-85" id="h15-0-85" class="i">+        val theme = context.gson.fromJson(content, ExportedTheme::class.java)
</a><a href="#h15-0-86" id="h15-0-86" class="i">+        val existingTheme = updateUrl?.let {
</a><a href="#h15-0-87" id="h15-0-87" class="i">+            context.database.getThemeIdByUpdateUrl(it)
</a><a href="#h15-0-88" id="h15-0-88" class="i">+        }?.let {
</a><a href="#h15-0-89" id="h15-0-89" class="i">+            context.database.getThemeInfo(it)
</a><a href="#h15-0-90" id="h15-0-90" class="i">+        }
</a><a href="#h15-0-91" id="h15-0-91" class="i">+        val databaseTheme = theme.toDatabaseTheme(
</a><a href="#h15-0-92" id="h15-0-92" class="i">+            updateUrl = updateUrl,
</a><a href="#h15-0-93" id="h15-0-93" class="i">+            enabled = existingTheme?.enabled ?: false
</a><a href="#h15-0-94" id="h15-0-94" class="i">+        )
</a><a href="#h15-0-95" id="h15-0-95" class="i">+
</a><a href="#h15-0-96" id="h15-0-96" class="i">+        val themeId = context.database.addOrUpdateTheme(
</a><a href="#h15-0-97" id="h15-0-97" class="i">+            themeId = existingTheme?.id,
</a><a href="#h15-0-98" id="h15-0-98" class="i">+            theme = databaseTheme
</a><a href="#h15-0-99" id="h15-0-99" class="i">+        )
</a><a href="#h15-0-100" id="h15-0-100" class="i">+
</a><a href="#h15-0-101" id="h15-0-101" class="i">+        context.database.setThemeContent(themeId, theme.content)
</a><a href="#h15-0-102" id="h15-0-102" class="i">+        context.shortToast(&quot;Theme imported successfully&quot;)
</a><a href="#h15-0-103" id="h15-0-103" class="i">+        withContext(Dispatchers.Main) {
</a><a href="#h15-0-104" id="h15-0-104" class="i">+            localReloadDispatcher.dispatch()
</a><a href="#h15-0-105" id="h15-0-105" class="i">+        }
</a><a href="#h15-0-106" id="h15-0-106" class="i">+    }
</a><a href="#h15-0-107" id="h15-0-107" class="i">+
</a><a href="#h15-0-108" id="h15-0-108" class="i">+    private fun importTheme() {
</a><a href="#h15-0-109" id="h15-0-109" class="i">+        activityLauncherHelper.openFile { uri -&gt;
</a><a href="#h15-0-110" id="h15-0-110" class="i">+            context.coroutineScope.launch {
</a><a href="#h15-0-111" id="h15-0-111" class="i">+                runCatching {
</a><a href="#h15-0-112" id="h15-0-112" class="i">+                    val themeJson = context.androidContext.contentResolver.openInputStream(uri.toUri())?.bufferedReader().use {
</a><a href="#h15-0-113" id="h15-0-113" class="i">+                        it?.readText()
</a><a href="#h15-0-114" id="h15-0-114" class="i">+                    } ?: throw Exception(&quot;Failed to read file&quot;)
</a><a href="#h15-0-115" id="h15-0-115" class="i">+
</a><a href="#h15-0-116" id="h15-0-116" class="i">+                    importTheme(themeJson)
</a><a href="#h15-0-117" id="h15-0-117" class="i">+                }.onFailure {
</a><a href="#h15-0-118" id="h15-0-118" class="i">+                    context.log.error(&quot;Failed to import theme&quot;, it)
</a><a href="#h15-0-119" id="h15-0-119" class="i">+                    context.longToast(&quot;Failed to import theme! Check logs for more details&quot;)
</a><a href="#h15-0-120" id="h15-0-120" class="i">+                }
</a><a href="#h15-0-121" id="h15-0-121" class="i">+            }
</a><a href="#h15-0-122" id="h15-0-122" class="i">+        }
</a><a href="#h15-0-123" id="h15-0-123" class="i">+    }
</a><a href="#h15-0-124" id="h15-0-124" class="i">+
</a><a href="#h15-0-125" id="h15-0-125" class="i">+    private suspend fun importFromURL(url: String) {
</a><a href="#h15-0-126" id="h15-0-126" class="i">+        val result = okHttpClient.newCall(
</a><a href="#h15-0-127" id="h15-0-127" class="i">+            okhttp3.Request.Builder()
</a><a href="#h15-0-128" id="h15-0-128" class="i">+                .url(url)
</a><a href="#h15-0-129" id="h15-0-129" class="i">+                .build()
</a><a href="#h15-0-130" id="h15-0-130" class="i">+        ).execute()
</a><a href="#h15-0-131" id="h15-0-131" class="i">+
</a><a href="#h15-0-132" id="h15-0-132" class="i">+        if (!result.isSuccessful) {
</a><a href="#h15-0-133" id="h15-0-133" class="i">+            throw Exception(&quot;Failed to fetch theme from URL ${result.message}&quot;)
</a><a href="#h15-0-134" id="h15-0-134" class="i">+        }
</a><a href="#h15-0-135" id="h15-0-135" class="i">+
</a><a href="#h15-0-136" id="h15-0-136" class="i">+        importTheme(result.body.string(), url)
</a><a href="#h15-0-137" id="h15-0-137" class="i">+    }
</a><a href="#h15-0-138" id="h15-0-138" class="i">+
</a><a href="#h15-0-139" id="h15-0-139" class="i">+    override val init: () -&gt; Unit = {
</a><a href="#h15-0-140" id="h15-0-140" class="i">+        activityLauncherHelper = ActivityLauncherHelper(context.activity!!)
</a><a href="#h15-0-141" id="h15-0-141" class="i">+    }
</a><a href="#h15-0-142" id="h15-0-142" class="i">+
</a><a href="#h15-0-143" id="h15-0-143" class="i">+    override val topBarActions: @Composable (RowScope.() -&gt; Unit) = {
</a><a href="#h15-0-144" id="h15-0-144" class="i">+        var showSearchBar by remember { mutableStateOf(false) }
</a><a href="#h15-0-145" id="h15-0-145" class="i">+        val focusRequester = remember { FocusRequester() }
</a><a href="#h15-0-146" id="h15-0-146" class="i">+
</a><a href="#h15-0-147" id="h15-0-147" class="i">+        Row(
</a><a href="#h15-0-148" id="h15-0-148" class="i">+            verticalAlignment = Alignment.CenterVertically
</a><a href="#h15-0-149" id="h15-0-149" class="i">+        ) {
</a><a href="#h15-0-150" id="h15-0-150" class="i">+            if (showSearchBar) {
</a><a href="#h15-0-151" id="h15-0-151" class="i">+                OutlinedTextField(
</a><a href="#h15-0-152" id="h15-0-152" class="i">+                    value = searchFilter.value,
</a><a href="#h15-0-153" id="h15-0-153" class="i">+                    onValueChange = { searchFilter.value = it },
</a><a href="#h15-0-154" id="h15-0-154" class="i">+                    placeholder = { Text(&quot;Search&quot;) },
</a><a href="#h15-0-155" id="h15-0-155" class="i">+                    modifier = Modifier
</a><a href="#h15-0-156" id="h15-0-156" class="i">+                        .weight(1f)
</a><a href="#h15-0-157" id="h15-0-157" class="i">+                        .focusRequester(focusRequester)
</a><a href="#h15-0-158" id="h15-0-158" class="i">+                        .onGloballyPositioned {
</a><a href="#h15-0-159" id="h15-0-159" class="i">+                            focusRequester.requestFocus()
</a><a href="#h15-0-160" id="h15-0-160" class="i">+                        },
</a><a href="#h15-0-161" id="h15-0-161" class="i">+                    colors = transparentTextFieldColors()
</a><a href="#h15-0-162" id="h15-0-162" class="i">+                )
</a><a href="#h15-0-163" id="h15-0-163" class="i">+                DisposableEffect(Unit) {
</a><a href="#h15-0-164" id="h15-0-164" class="i">+                    onDispose {
</a><a href="#h15-0-165" id="h15-0-165" class="i">+                        searchFilter.value = &quot;&quot;
</a><a href="#h15-0-166" id="h15-0-166" class="i">+                    }
</a><a href="#h15-0-167" id="h15-0-167" class="i">+                }
</a><a href="#h15-0-168" id="h15-0-168" class="i">+            }
</a><a href="#h15-0-169" id="h15-0-169" class="i">+            IconButton(onClick = {
</a><a href="#h15-0-170" id="h15-0-170" class="i">+                showSearchBar = !showSearchBar
</a><a href="#h15-0-171" id="h15-0-171" class="i">+            }) {
</a><a href="#h15-0-172" id="h15-0-172" class="i">+                Icon(if (showSearchBar) Icons.Default.Close else Icons.Default.Search, contentDescription = null)
</a><a href="#h15-0-173" id="h15-0-173" class="i">+            }
</a><a href="#h15-0-174" id="h15-0-174" class="i">+        }
</a><a href="#h15-0-175" id="h15-0-175" class="i">+    }
</a><a href="#h15-0-176" id="h15-0-176" class="i">+
</a><a href="#h15-0-177" id="h15-0-177" class="i">+    override val floatingActionButton: @Composable () -&gt; Unit = {
</a><a href="#h15-0-178" id="h15-0-178" class="i">+        var showImportFromUrlDialog by remember { mutableStateOf(false) }
</a><a href="#h15-0-179" id="h15-0-179" class="i">+
</a><a href="#h15-0-180" id="h15-0-180" class="i">+        if (showImportFromUrlDialog) {
</a><a href="#h15-0-181" id="h15-0-181" class="i">+            var url by remember { mutableStateOf(&quot;&quot;) }
</a><a href="#h15-0-182" id="h15-0-182" class="i">+            var loading by remember { mutableStateOf(false) }
</a><a href="#h15-0-183" id="h15-0-183" class="i">+
</a><a href="#h15-0-184" id="h15-0-184" class="i">+            AlertDialog(
</a><a href="#h15-0-185" id="h15-0-185" class="i">+                onDismissRequest = { showImportFromUrlDialog = false },
</a><a href="#h15-0-186" id="h15-0-186" class="i">+                title = { Text(&quot;Import theme from URL&quot;) },
</a><a href="#h15-0-187" id="h15-0-187" class="i">+                text = {
</a><a href="#h15-0-188" id="h15-0-188" class="i">+                    val focusRequester = remember { FocusRequester() }
</a><a href="#h15-0-189" id="h15-0-189" class="i">+                    TextField(
</a><a href="#h15-0-190" id="h15-0-190" class="i">+                        value = url,
</a><a href="#h15-0-191" id="h15-0-191" class="i">+                        onValueChange = { url = it },
</a><a href="#h15-0-192" id="h15-0-192" class="i">+                        label = { Text(&quot;URL&quot;) },
</a><a href="#h15-0-193" id="h15-0-193" class="i">+                        modifier = Modifier
</a><a href="#h15-0-194" id="h15-0-194" class="i">+                            .fillMaxWidth()
</a><a href="#h15-0-195" id="h15-0-195" class="i">+                            .focusRequester(focusRequester)
</a><a href="#h15-0-196" id="h15-0-196" class="i">+                            .onGloballyPositioned {
</a><a href="#h15-0-197" id="h15-0-197" class="i">+                                focusRequester.requestFocus()
</a><a href="#h15-0-198" id="h15-0-198" class="i">+                            }
</a><a href="#h15-0-199" id="h15-0-199" class="i">+                    )
</a><a href="#h15-0-200" id="h15-0-200" class="i">+                    LaunchedEffect(Unit) {
</a><a href="#h15-0-201" id="h15-0-201" class="i">+                        context.androidContext.getUrlFromClipboard()?.let {
</a><a href="#h15-0-202" id="h15-0-202" class="i">+                            url = it
</a><a href="#h15-0-203" id="h15-0-203" class="i">+                        }
</a><a href="#h15-0-204" id="h15-0-204" class="i">+                    }
</a><a href="#h15-0-205" id="h15-0-205" class="i">+                },
</a><a href="#h15-0-206" id="h15-0-206" class="i">+                confirmButton = {
</a><a href="#h15-0-207" id="h15-0-207" class="i">+                    Button(
</a><a href="#h15-0-208" id="h15-0-208" class="i">+                        enabled = url.isNotBlank() &amp;&amp; !loading,
</a><a href="#h15-0-209" id="h15-0-209" class="i">+                        onClick = {
</a><a href="#h15-0-210" id="h15-0-210" class="i">+                            loading = true
</a><a href="#h15-0-211" id="h15-0-211" class="i">+                            context.coroutineScope.launch {
</a><a href="#h15-0-212" id="h15-0-212" class="i">+                                runCatching {
</a><a href="#h15-0-213" id="h15-0-213" class="i">+                                    importFromURL(url)
</a><a href="#h15-0-214" id="h15-0-214" class="i">+                                    withContext(Dispatchers.Main) {
</a><a href="#h15-0-215" id="h15-0-215" class="i">+                                        showImportFromUrlDialog = false
</a><a href="#h15-0-216" id="h15-0-216" class="i">+                                    }
</a><a href="#h15-0-217" id="h15-0-217" class="i">+                                }.onFailure {
</a><a href="#h15-0-218" id="h15-0-218" class="i">+                                    context.log.error(&quot;Failed to import theme&quot;, it)
</a><a href="#h15-0-219" id="h15-0-219" class="i">+                                    context.longToast(&quot;Failed to import theme! ${it.message}&quot;)
</a><a href="#h15-0-220" id="h15-0-220" class="i">+                                }
</a><a href="#h15-0-221" id="h15-0-221" class="i">+                                withContext(Dispatchers.Main) {
</a><a href="#h15-0-222" id="h15-0-222" class="i">+                                    loading = false
</a><a href="#h15-0-223" id="h15-0-223" class="i">+                                }
</a><a href="#h15-0-224" id="h15-0-224" class="i">+                            }
</a><a href="#h15-0-225" id="h15-0-225" class="i">+                        },
</a><a href="#h15-0-226" id="h15-0-226" class="i">+                        modifier = Modifier.fillMaxWidth()
</a><a href="#h15-0-227" id="h15-0-227" class="i">+                    ) {
</a><a href="#h15-0-228" id="h15-0-228" class="i">+                        Text(&quot;Import&quot;)
</a><a href="#h15-0-229" id="h15-0-229" class="i">+                    }
</a><a href="#h15-0-230" id="h15-0-230" class="i">+                }
</a><a href="#h15-0-231" id="h15-0-231" class="i">+            )
</a><a href="#h15-0-232" id="h15-0-232" class="i">+        }
</a><a href="#h15-0-233" id="h15-0-233" class="i">+        Column(
</a><a href="#h15-0-234" id="h15-0-234" class="i">+            horizontalAlignment = Alignment.End
</a><a href="#h15-0-235" id="h15-0-235" class="i">+        ) {
</a><a href="#h15-0-236" id="h15-0-236" class="i">+            when (currentPage) {
</a><a href="#h15-0-237" id="h15-0-237" class="i">+                0 -&gt; {
</a><a href="#h15-0-238" id="h15-0-238" class="i">+                    ExtendedFloatingActionButton(
</a><a href="#h15-0-239" id="h15-0-239" class="i">+                        onClick = {
</a><a href="#h15-0-240" id="h15-0-240" class="i">+                            routes.editTheme.navigate()
</a><a href="#h15-0-241" id="h15-0-241" class="i">+                        },
</a><a href="#h15-0-242" id="h15-0-242" class="i">+                        icon = {
</a><a href="#h15-0-243" id="h15-0-243" class="i">+                            Icon(Icons.Default.Add, contentDescription = null)
</a><a href="#h15-0-244" id="h15-0-244" class="i">+                        },
</a><a href="#h15-0-245" id="h15-0-245" class="i">+                        text = {
</a><a href="#h15-0-246" id="h15-0-246" class="i">+                            Text(&quot;New theme&quot;)
</a><a href="#h15-0-247" id="h15-0-247" class="i">+                        }
</a><a href="#h15-0-248" id="h15-0-248" class="i">+                    )
</a><a href="#h15-0-249" id="h15-0-249" class="i">+                    Spacer(modifier = Modifier.height(8.dp))
</a><a href="#h15-0-250" id="h15-0-250" class="i">+                    ExtendedFloatingActionButton(
</a><a href="#h15-0-251" id="h15-0-251" class="i">+                        onClick = {
</a><a href="#h15-0-252" id="h15-0-252" class="i">+                            importTheme()
</a><a href="#h15-0-253" id="h15-0-253" class="i">+                        },
</a><a href="#h15-0-254" id="h15-0-254" class="i">+                        icon = {
</a><a href="#h15-0-255" id="h15-0-255" class="i">+                            Icon(Icons.Default.Upload, contentDescription = null)
</a><a href="#h15-0-256" id="h15-0-256" class="i">+                        },
</a><a href="#h15-0-257" id="h15-0-257" class="i">+                        text = {
</a><a href="#h15-0-258" id="h15-0-258" class="i">+                            Text(&quot;Import from file&quot;)
</a><a href="#h15-0-259" id="h15-0-259" class="i">+                        }
</a><a href="#h15-0-260" id="h15-0-260" class="i">+                    )
</a><a href="#h15-0-261" id="h15-0-261" class="i">+                    Spacer(modifier = Modifier.height(8.dp))
</a><a href="#h15-0-262" id="h15-0-262" class="i">+                    ExtendedFloatingActionButton(
</a><a href="#h15-0-263" id="h15-0-263" class="i">+                        onClick = { showImportFromUrlDialog = true },
</a><a href="#h15-0-264" id="h15-0-264" class="i">+                        icon = {
</a><a href="#h15-0-265" id="h15-0-265" class="i">+                            Icon(Icons.Default.Link, contentDescription = null)
</a><a href="#h15-0-266" id="h15-0-266" class="i">+                        },
</a><a href="#h15-0-267" id="h15-0-267" class="i">+                        text = {
</a><a href="#h15-0-268" id="h15-0-268" class="i">+                            Text(&quot;Import from URL&quot;)
</a><a href="#h15-0-269" id="h15-0-269" class="i">+                        }
</a><a href="#h15-0-270" id="h15-0-270" class="i">+                    )
</a><a href="#h15-0-271" id="h15-0-271" class="i">+                }
</a><a href="#h15-0-272" id="h15-0-272" class="i">+                1 -&gt; {
</a><a href="#h15-0-273" id="h15-0-273" class="i">+                    ExtendedFloatingActionButton(
</a><a href="#h15-0-274" id="h15-0-274" class="i">+                        onClick = {
</a><a href="#h15-0-275" id="h15-0-275" class="i">+                            routes.manageRepos.navigate()
</a><a href="#h15-0-276" id="h15-0-276" class="i">+                        },
</a><a href="#h15-0-277" id="h15-0-277" class="i">+                        icon = {
</a><a href="#h15-0-278" id="h15-0-278" class="i">+                            Icon(Icons.Default.Public, contentDescription = null)
</a><a href="#h15-0-279" id="h15-0-279" class="i">+                        },
</a><a href="#h15-0-280" id="h15-0-280" class="i">+                        text = {
</a><a href="#h15-0-281" id="h15-0-281" class="i">+                            Text(&quot;Manage repositories&quot;)
</a><a href="#h15-0-282" id="h15-0-282" class="i">+                        }
</a><a href="#h15-0-283" id="h15-0-283" class="i">+                    )
</a><a href="#h15-0-284" id="h15-0-284" class="i">+                }
</a><a href="#h15-0-285" id="h15-0-285" class="i">+            }
</a><a href="#h15-0-286" id="h15-0-286" class="i">+        }
</a><a href="#h15-0-287" id="h15-0-287" class="i">+    }
</a><a href="#h15-0-288" id="h15-0-288" class="i">+
</a><a href="#h15-0-289" id="h15-0-289" class="i">+    @Composable
</a><a href="#h15-0-290" id="h15-0-290" class="i">+    private fun InstalledThemes() {
</a><a href="#h15-0-291" id="h15-0-291" class="i">+        val themes = rememberAsyncMutableStateList(defaultValue = listOf(), updateDispatcher = localReloadDispatcher, keys = arrayOf(searchFilter.value)) {
</a><a href="#h15-0-292" id="h15-0-292" class="i">+            context.database.getThemeList().let {
</a><a href="#h15-0-293" id="h15-0-293" class="i">+                val filter = searchFilter.value
</a><a href="#h15-0-294" id="h15-0-294" class="i">+                if (filter.isNotBlank()) {
</a><a href="#h15-0-295" id="h15-0-295" class="i">+                    it.filter { theme -&gt;
</a><a href="#h15-0-296" id="h15-0-296" class="i">+                        theme.name.contains(filter, ignoreCase = true) ||
</a><a href="#h15-0-297" id="h15-0-297" class="i">+                        theme.author?.contains(filter, ignoreCase = true) == true ||
</a><a href="#h15-0-298" id="h15-0-298" class="i">+                        theme.description?.contains(filter, ignoreCase = true) == true
</a><a href="#h15-0-299" id="h15-0-299" class="i">+                    }
</a><a href="#h15-0-300" id="h15-0-300" class="i">+                } else it
</a><a href="#h15-0-301" id="h15-0-301" class="i">+            }
</a><a href="#h15-0-302" id="h15-0-302" class="i">+        }
</a><a href="#h15-0-303" id="h15-0-303" class="i">+
</a><a href="#h15-0-304" id="h15-0-304" class="i">+        LazyColumn(
</a><a href="#h15-0-305" id="h15-0-305" class="i">+            modifier = Modifier
</a><a href="#h15-0-306" id="h15-0-306" class="i">+                .fillMaxSize()
</a><a href="#h15-0-307" id="h15-0-307" class="i">+                .padding(2.dp),
</a><a href="#h15-0-308" id="h15-0-308" class="i">+            verticalArrangement = Arrangement.spacedBy(5.dp)
</a><a href="#h15-0-309" id="h15-0-309" class="i">+        ) {
</a><a href="#h15-0-310" id="h15-0-310" class="i">+            item {
</a><a href="#h15-0-311" id="h15-0-311" class="i">+                if (themes.isEmpty()) {
</a><a href="#h15-0-312" id="h15-0-312" class="i">+                    Text(
</a><a href="#h15-0-313" id="h15-0-313" class="i">+                        text = translation[&quot;no_themes_hint&quot;],
</a><a href="#h15-0-314" id="h15-0-314" class="i">+                        modifier = Modifier
</a><a href="#h15-0-315" id="h15-0-315" class="i">+                            .padding(16.dp)
</a><a href="#h15-0-316" id="h15-0-316" class="i">+                            .fillMaxWidth(),
</a><a href="#h15-0-317" id="h15-0-317" class="i">+                        textAlign = TextAlign.Center,
</a><a href="#h15-0-318" id="h15-0-318" class="i">+                        fontSize = 15.sp,
</a><a href="#h15-0-319" id="h15-0-319" class="i">+                        fontWeight = FontWeight.Light
</a><a href="#h15-0-320" id="h15-0-320" class="i">+                    )
</a><a href="#h15-0-321" id="h15-0-321" class="i">+                }
</a><a href="#h15-0-322" id="h15-0-322" class="i">+            }
</a><a href="#h15-0-323" id="h15-0-323" class="i">+            items(themes, key = { it.id }) { theme -&gt;
</a><a href="#h15-0-324" id="h15-0-324" class="i">+                var showSettings by remember(theme) { mutableStateOf(false) }
</a><a href="#h15-0-325" id="h15-0-325" class="i">+
</a><a href="#h15-0-326" id="h15-0-326" class="i">+                ElevatedCard(
</a><a href="#h15-0-327" id="h15-0-327" class="i">+                    modifier = Modifier
</a><a href="#h15-0-328" id="h15-0-328" class="i">+                        .fillMaxWidth()
</a><a href="#h15-0-329" id="h15-0-329" class="i">+                        .clickable {
</a><a href="#h15-0-330" id="h15-0-330" class="i">+                            routes.editTheme.navigate {
</a><a href="#h15-0-331" id="h15-0-331" class="i">+                                this[&quot;theme_id&quot;] = theme.id.toString()
</a><a href="#h15-0-332" id="h15-0-332" class="i">+                            }
</a><a href="#h15-0-333" id="h15-0-333" class="i">+                        }
</a><a href="#h15-0-334" id="h15-0-334" class="i">+                        .padding(8.dp)
</a><a href="#h15-0-335" id="h15-0-335" class="i">+                ) {
</a><a href="#h15-0-336" id="h15-0-336" class="i">+                    Row(
</a><a href="#h15-0-337" id="h15-0-337" class="i">+                        modifier = Modifier
</a><a href="#h15-0-338" id="h15-0-338" class="i">+                            .padding(8.dp)
</a><a href="#h15-0-339" id="h15-0-339" class="i">+                            .fillMaxWidth(),
</a><a href="#h15-0-340" id="h15-0-340" class="i">+                        verticalAlignment = Alignment.CenterVertically
</a><a href="#h15-0-341" id="h15-0-341" class="i">+                    ) {
</a><a href="#h15-0-342" id="h15-0-342" class="i">+                        Icon(
</a><a href="#h15-0-343" id="h15-0-343" class="i">+                            Icons.Default.Palette, contentDescription = null, modifier = Modifier.padding(5.dp))
</a><a href="#h15-0-344" id="h15-0-344" class="i">+                        Column(
</a><a href="#h15-0-345" id="h15-0-345" class="i">+                            modifier = Modifier
</a><a href="#h15-0-346" id="h15-0-346" class="i">+                                .weight(1f)
</a><a href="#h15-0-347" id="h15-0-347" class="i">+                                .padding(8.dp),
</a><a href="#h15-0-348" id="h15-0-348" class="i">+                        ) {
</a><a href="#h15-0-349" id="h15-0-349" class="i">+                            Text(text = theme.name, fontWeight = FontWeight.Bold, fontSize = 18.sp, lineHeight = 20.sp)
</a><a href="#h15-0-350" id="h15-0-350" class="i">+                            theme.author?.takeIf { it.isNotBlank() }?.let {
</a><a href="#h15-0-351" id="h15-0-351" class="i">+                                Text(text = &quot;by $it&quot;, lineHeight = 15.sp, fontWeight = FontWeight.Light, fontSize = 12.sp)
</a><a href="#h15-0-352" id="h15-0-352" class="i">+                            }
</a><a href="#h15-0-353" id="h15-0-353" class="i">+                        }
</a><a href="#h15-0-354" id="h15-0-354" class="i">+
</a><a href="#h15-0-355" id="h15-0-355" class="i">+                        Row(
</a><a href="#h15-0-356" id="h15-0-356" class="i">+                            horizontalArrangement = Arrangement.spacedBy(5.dp),
</a><a href="#h15-0-357" id="h15-0-357" class="i">+                        ) {
</a><a href="#h15-0-358" id="h15-0-358" class="i">+                            var state by remember { mutableStateOf(theme.enabled) }
</a><a href="#h15-0-359" id="h15-0-359" class="i">+
</a><a href="#h15-0-360" id="h15-0-360" class="i">+                            IconButton(onClick = {
</a><a href="#h15-0-361" id="h15-0-361" class="i">+                                showSettings = true
</a><a href="#h15-0-362" id="h15-0-362" class="i">+                            }) {
</a><a href="#h15-0-363" id="h15-0-363" class="i">+                                Icon(Icons.Default.Settings, contentDescription = null)
</a><a href="#h15-0-364" id="h15-0-364" class="i">+                            }
</a><a href="#h15-0-365" id="h15-0-365" class="i">+
</a><a href="#h15-0-366" id="h15-0-366" class="i">+                            Switch(checked = state, onCheckedChange = {
</a><a href="#h15-0-367" id="h15-0-367" class="i">+                                state = it
</a><a href="#h15-0-368" id="h15-0-368" class="i">+                                context.database.setThemeState(theme.id, it)
</a><a href="#h15-0-369" id="h15-0-369" class="i">+                            })
</a><a href="#h15-0-370" id="h15-0-370" class="i">+                        }
</a><a href="#h15-0-371" id="h15-0-371" class="i">+                    }
</a><a href="#h15-0-372" id="h15-0-372" class="i">+                }
</a><a href="#h15-0-373" id="h15-0-373" class="i">+
</a><a href="#h15-0-374" id="h15-0-374" class="i">+                if (showSettings) {
</a><a href="#h15-0-375" id="h15-0-375" class="i">+                    val actionsRow = remember {
</a><a href="#h15-0-376" id="h15-0-376" class="i">+                        mapOf(
</a><a href="#h15-0-377" id="h15-0-377" class="i">+                            (&quot;Duplicate&quot; to Icons.Default.ContentCopy) to { duplicateTheme(theme) },
</a><a href="#h15-0-378" id="h15-0-378" class="i">+                            (&quot;Export&quot; to Icons.Default.Download) to { exportTheme(theme) }
</a><a href="#h15-0-379" id="h15-0-379" class="i">+                        )
</a><a href="#h15-0-380" id="h15-0-380" class="i">+                    }
</a><a href="#h15-0-381" id="h15-0-381" class="i">+                    AlertDialog(
</a><a href="#h15-0-382" id="h15-0-382" class="i">+                        onDismissRequest = { showSettings = false },
</a><a href="#h15-0-383" id="h15-0-383" class="i">+                        title = { Text(&quot;Theme settings&quot;) },
</a><a href="#h15-0-384" id="h15-0-384" class="i">+                        text = {
</a><a href="#h15-0-385" id="h15-0-385" class="i">+                            Column(
</a><a href="#h15-0-386" id="h15-0-386" class="i">+                                modifier = Modifier.fillMaxWidth(),
</a><a href="#h15-0-387" id="h15-0-387" class="i">+                            ) {
</a><a href="#h15-0-388" id="h15-0-388" class="i">+                                actionsRow.forEach { entry -&gt;
</a><a href="#h15-0-389" id="h15-0-389" class="i">+                                    Row(
</a><a href="#h15-0-390" id="h15-0-390" class="i">+                                        modifier = Modifier
</a><a href="#h15-0-391" id="h15-0-391" class="i">+                                            .fillMaxWidth()
</a><a href="#h15-0-392" id="h15-0-392" class="i">+                                            .clickable {
</a><a href="#h15-0-393" id="h15-0-393" class="i">+                                                showSettings = false
</a><a href="#h15-0-394" id="h15-0-394" class="i">+                                                entry.value()
</a><a href="#h15-0-395" id="h15-0-395" class="i">+                                            },
</a><a href="#h15-0-396" id="h15-0-396" class="i">+                                        verticalAlignment = Alignment.CenterVertically
</a><a href="#h15-0-397" id="h15-0-397" class="i">+                                    ) {
</a><a href="#h15-0-398" id="h15-0-398" class="i">+                                        Icon(entry.key.second, contentDescription = null, modifier = Modifier.padding(16.dp))
</a><a href="#h15-0-399" id="h15-0-399" class="i">+                                        Spacer(modifier = Modifier.width(5.dp))
</a><a href="#h15-0-400" id="h15-0-400" class="i">+                                        Text(entry.key.first)
</a><a href="#h15-0-401" id="h15-0-401" class="i">+                                    }
</a><a href="#h15-0-402" id="h15-0-402" class="i">+                                }
</a><a href="#h15-0-403" id="h15-0-403" class="i">+                            }
</a><a href="#h15-0-404" id="h15-0-404" class="i">+                        },
</a><a href="#h15-0-405" id="h15-0-405" class="i">+                        confirmButton = {}
</a><a href="#h15-0-406" id="h15-0-406" class="i">+                    )
</a><a href="#h15-0-407" id="h15-0-407" class="i">+                }
</a><a href="#h15-0-408" id="h15-0-408" class="i">+            }
</a><a href="#h15-0-409" id="h15-0-409" class="i">+            item {
</a><a href="#h15-0-410" id="h15-0-410" class="i">+                Spacer(modifier = Modifier.height(100.dp))
</a><a href="#h15-0-411" id="h15-0-411" class="i">+            }
</a><a href="#h15-0-412" id="h15-0-412" class="i">+        }
</a><a href="#h15-0-413" id="h15-0-413" class="i">+    }
</a><a href="#h15-0-414" id="h15-0-414" class="i">+
</a><a href="#h15-0-415" id="h15-0-415" class="i">+
</a><a href="#h15-0-416" id="h15-0-416" class="i">+    @OptIn(ExperimentalFoundationApi::class)
</a><a href="#h15-0-417" id="h15-0-417" class="i">+    override val content: @Composable (NavBackStackEntry) -&gt; Unit = {
</a><a href="#h15-0-418" id="h15-0-418" class="i">+        val coroutineScope = rememberCoroutineScope()
</a><a href="#h15-0-419" id="h15-0-419" class="i">+        val titles = remember { listOf(&quot;Installed Themes&quot;, &quot;Catalog&quot;) }
</a><a href="#h15-0-420" id="h15-0-420" class="i">+        val pagerState = rememberPagerState { titles.size }
</a><a href="#h15-0-421" id="h15-0-421" class="i">+        currentPage = pagerState.currentPage
</a><a href="#h15-0-422" id="h15-0-422" class="i">+
</a><a href="#h15-0-423" id="h15-0-423" class="i">+        Column {
</a><a href="#h15-0-424" id="h15-0-424" class="i">+            TabRow(selectedTabIndex = pagerState.currentPage, indicator = { tabPositions -&gt;
</a><a href="#h15-0-425" id="h15-0-425" class="i">+                TabRowDefaults.SecondaryIndicator(
</a><a href="#h15-0-426" id="h15-0-426" class="i">+                    Modifier.pagerTabIndicatorOffset(
</a><a href="#h15-0-427" id="h15-0-427" class="i">+                        pagerState = pagerState,
</a><a href="#h15-0-428" id="h15-0-428" class="i">+                        tabPositions = tabPositions
</a><a href="#h15-0-429" id="h15-0-429" class="i">+                    )
</a><a href="#h15-0-430" id="h15-0-430" class="i">+                )
</a><a href="#h15-0-431" id="h15-0-431" class="i">+            }) {
</a><a href="#h15-0-432" id="h15-0-432" class="i">+                titles.forEachIndexed { index, title -&gt;
</a><a href="#h15-0-433" id="h15-0-433" class="i">+                    Tab(
</a><a href="#h15-0-434" id="h15-0-434" class="i">+                        selected = pagerState.currentPage == index,
</a><a href="#h15-0-435" id="h15-0-435" class="i">+                        onClick = {
</a><a href="#h15-0-436" id="h15-0-436" class="i">+                            coroutineScope.launch {
</a><a href="#h15-0-437" id="h15-0-437" class="i">+                                pagerState.animateScrollToPage(index)
</a><a href="#h15-0-438" id="h15-0-438" class="i">+                            }
</a><a href="#h15-0-439" id="h15-0-439" class="i">+                        },
</a><a href="#h15-0-440" id="h15-0-440" class="i">+                        text = {
</a><a href="#h15-0-441" id="h15-0-441" class="i">+                            Text(
</a><a href="#h15-0-442" id="h15-0-442" class="i">+                                text = title,
</a><a href="#h15-0-443" id="h15-0-443" class="i">+                                maxLines = 2,
</a><a href="#h15-0-444" id="h15-0-444" class="i">+                                overflow = TextOverflow.Ellipsis
</a><a href="#h15-0-445" id="h15-0-445" class="i">+                            )
</a><a href="#h15-0-446" id="h15-0-446" class="i">+                        }
</a><a href="#h15-0-447" id="h15-0-447" class="i">+                    )
</a><a href="#h15-0-448" id="h15-0-448" class="i">+                }
</a><a href="#h15-0-449" id="h15-0-449" class="i">+            }
</a><a href="#h15-0-450" id="h15-0-450" class="i">+
</a><a href="#h15-0-451" id="h15-0-451" class="i">+            HorizontalPager(
</a><a href="#h15-0-452" id="h15-0-452" class="i">+                modifier = Modifier.weight(1f),
</a><a href="#h15-0-453" id="h15-0-453" class="i">+                state = pagerState
</a><a href="#h15-0-454" id="h15-0-454" class="i">+            ) { page -&gt;
</a><a href="#h15-0-455" id="h15-0-455" class="i">+                when (page) {
</a><a href="#h15-0-456" id="h15-0-456" class="i">+                    0 -&gt; InstalledThemes()
</a><a href="#h15-0-457" id="h15-0-457" class="i">+                    1 -&gt; ThemeCatalog(this@ThemingRoot)
</a><a href="#h15-0-458" id="h15-0-458" class="i">+                }
</a><a href="#h15-0-459" id="h15-0-459" class="i">+            }
</a><a href="#h15-0-460" id="h15-0-460" class="i">+        }
</a><a href="#h15-0-461" id="h15-0-461" class="i">+    }
</a><a href="#h15-0-462" id="h15-0-462" class="i">+}</a><a href="#h15-0-463" id="h15-0-463" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h16" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/pages/tracker/LogsTab.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/pages/tracker/LogsTab.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/pages/tracker/LogsTab.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/pages/tracker/LogsTab.kt</a></b>
<a href="#h16-0" id="h16-0" class="h">@@ -74,9 +74,12 @@ fun LogsTab(
</a> 
     suspend fun loadNewLogs() {
         withContext(Dispatchers.IO) {
<a href="#h16-0-3" id="h16-0-3" class="d">-            logs.addAll(getPaginatedLogs(pageIndex).apply {
</a><a href="#h16-0-4" id="h16-0-4" class="d">-                pageIndex += 1
</a><a href="#h16-0-5" id="h16-0-5" class="d">-            })
</a><a href="#h16-0-6" id="h16-0-6" class="i">+            getPaginatedLogs(pageIndex).let {
</a><a href="#h16-0-7" id="h16-0-7" class="i">+                withContext(Dispatchers.Main) {
</a><a href="#h16-0-8" id="h16-0-8" class="i">+                    logs.addAll(it)
</a><a href="#h16-0-9" id="h16-0-9" class="i">+                    pageIndex += 1
</a><a href="#h16-0-10" id="h16-0-10" class="i">+                }
</a><a href="#h16-0-11" id="h16-0-11" class="i">+            }
</a>         }
     }
 
<b>diff --git a/<a id="h17" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/setup/Requirements.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/setup/Requirements.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/setup/Requirements.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/setup/Requirements.kt</a></b>
<a href="#h17-0" id="h17-0" class="h">@@ -1,21 +1,11 @@
</a> package me.rhunk.snapenhance.ui.setup
 
 object Requirements {
<a href="#h17-0-3" id="h17-0-3" class="d">-    const val FIRST_RUN = 0b00001
</a><a href="#h17-0-4" id="h17-0-4" class="d">-    const val LANGUAGE = 0b00010
</a><a href="#h17-0-5" id="h17-0-5" class="d">-    const val MAPPINGS = 0b00100
</a><a href="#h17-0-6" id="h17-0-6" class="d">-    const val SAVE_FOLDER = 0b01000
</a><a href="#h17-0-7" id="h17-0-7" class="d">-    const val GRANT_PERMISSIONS = 0b10000
</a><a href="#h17-0-8" id="h17-0-8" class="d">-
</a><a href="#h17-0-9" id="h17-0-9" class="d">-    fun getName(requirement: Int): String {
</a><a href="#h17-0-10" id="h17-0-10" class="d">-        return when (requirement) {
</a><a href="#h17-0-11" id="h17-0-11" class="d">-            FIRST_RUN -&gt; &quot;FIRST_RUN&quot;
</a><a href="#h17-0-12" id="h17-0-12" class="d">-            LANGUAGE -&gt; &quot;LANGUAGE&quot;
</a><a href="#h17-0-13" id="h17-0-13" class="d">-            MAPPINGS -&gt; &quot;MAPPINGS&quot;
</a><a href="#h17-0-14" id="h17-0-14" class="d">-            SAVE_FOLDER -&gt; &quot;SAVE_FOLDER&quot;
</a><a href="#h17-0-15" id="h17-0-15" class="d">-            GRANT_PERMISSIONS -&gt; &quot;GRANT_PERMISSIONS&quot;
</a><a href="#h17-0-16" id="h17-0-16" class="d">-            else -&gt; &quot;UNKNOWN&quot;
</a><a href="#h17-0-17" id="h17-0-17" class="d">-        }
</a><a href="#h17-0-18" id="h17-0-18" class="d">-    }
</a><a href="#h17-0-19" id="h17-0-19" class="i">+    const val FIRST_RUN = 0b000001
</a><a href="#h17-0-20" id="h17-0-20" class="i">+    const val LANGUAGE = 0b000010
</a><a href="#h17-0-21" id="h17-0-21" class="i">+    const val MAPPINGS = 0b000100
</a><a href="#h17-0-22" id="h17-0-22" class="i">+    const val SAVE_FOLDER = 0b001000
</a><a href="#h17-0-23" id="h17-0-23" class="i">+    const val GRANT_PERMISSIONS = 0b010000
</a><a href="#h17-0-24" id="h17-0-24" class="i">+    const val SIF = 0b100000
</a> }
 
<b>diff --git a/<a id="h18" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/setup/SetupActivity.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/setup/SetupActivity.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/setup/SetupActivity.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/setup/SetupActivity.kt</a></b>
<a href="#h18-0" id="h18-0" class="h">@@ -29,10 +29,7 @@ import androidx.navigation.compose.rememberNavController
</a> import me.rhunk.snapenhance.SharedContextHolder
 import me.rhunk.snapenhance.common.ui.AppMaterialTheme
 import me.rhunk.snapenhance.ui.setup.screens.SetupScreen
<a href="#h18-0-3" id="h18-0-3" class="d">-import me.rhunk.snapenhance.ui.setup.screens.impl.MappingsScreen
</a><a href="#h18-0-4" id="h18-0-4" class="d">-import me.rhunk.snapenhance.ui.setup.screens.impl.PermissionsScreen
</a><a href="#h18-0-5" id="h18-0-5" class="d">-import me.rhunk.snapenhance.ui.setup.screens.impl.PickLanguageScreen
</a><a href="#h18-0-6" id="h18-0-6" class="d">-import me.rhunk.snapenhance.ui.setup.screens.impl.SaveFolderScreen
</a><a href="#h18-0-7" id="h18-0-7" class="i">+import me.rhunk.snapenhance.ui.setup.screens.impl.*
</a> 
 
 class SetupActivity : ComponentActivity() {
<a href="#h18-1" id="h18-1" class="h">@@ -69,6 +66,9 @@ class SetupActivity : ComponentActivity() {
</a>             if (isFirstRun || hasRequirement(Requirements.MAPPINGS)) {
                 add(MappingsScreen().apply { route = &quot;mappings&quot; })
             }
<a href="#h18-1-3" id="h18-1-3" class="i">+            /*if (isFirstRun || hasRequirement(Requirements.SIF)) {
</a><a href="#h18-1-4" id="h18-1-4" class="i">+                add(SecurityScreen().apply { route = &quot;security&quot; })
</a><a href="#h18-1-5" id="h18-1-5" class="i">+            }*/
</a>         }
 
         // If there are no required screens, we can just finish the activity
<b>diff --git a/<a id="h19" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/setup/screens/impl/SecurityScreen.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/setup/screens/impl/SecurityScreen.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/setup/screens/impl/SecurityScreen.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/setup/screens/impl/SecurityScreen.kt</a></b>
<a href="#h19-0" id="h19-0" class="h">@@ -0,0 +1,86 @@
</a><a href="#h19-0-0" id="h19-0-0" class="i">+package me.rhunk.snapenhance.ui.setup.screens.impl
</a><a href="#h19-0-1" id="h19-0-1" class="i">+
</a><a href="#h19-0-2" id="h19-0-2" class="i">+import androidx.compose.foundation.layout.*
</a><a href="#h19-0-3" id="h19-0-3" class="i">+import androidx.compose.material.icons.Icons
</a><a href="#h19-0-4" id="h19-0-4" class="i">+import androidx.compose.material.icons.filled.WarningAmber
</a><a href="#h19-0-5" id="h19-0-5" class="i">+import androidx.compose.material3.*
</a><a href="#h19-0-6" id="h19-0-6" class="i">+import androidx.compose.runtime.*
</a><a href="#h19-0-7" id="h19-0-7" class="i">+import androidx.compose.ui.Alignment
</a><a href="#h19-0-8" id="h19-0-8" class="i">+import androidx.compose.ui.Modifier
</a><a href="#h19-0-9" id="h19-0-9" class="i">+import androidx.compose.ui.text.font.FontWeight
</a><a href="#h19-0-10" id="h19-0-10" class="i">+import androidx.compose.ui.unit.dp
</a><a href="#h19-0-11" id="h19-0-11" class="i">+import androidx.compose.ui.unit.sp
</a><a href="#h19-0-12" id="h19-0-12" class="i">+import kotlinx.coroutines.launch
</a><a href="#h19-0-13" id="h19-0-13" class="i">+import me.rhunk.snapenhance.ui.setup.screens.SetupScreen
</a><a href="#h19-0-14" id="h19-0-14" class="i">+
</a><a href="#h19-0-15" id="h19-0-15" class="i">+class SecurityScreen : SetupScreen() {
</a><a href="#h19-0-16" id="h19-0-16" class="i">+    @Composable
</a><a href="#h19-0-17" id="h19-0-17" class="i">+    override fun Content() {
</a><a href="#h19-0-18" id="h19-0-18" class="i">+        Icon(
</a><a href="#h19-0-19" id="h19-0-19" class="i">+            imageVector = Icons.Default.WarningAmber,
</a><a href="#h19-0-20" id="h19-0-20" class="i">+            contentDescription = null,
</a><a href="#h19-0-21" id="h19-0-21" class="i">+            modifier = Modifier.padding(16.dp).size(30.dp),
</a><a href="#h19-0-22" id="h19-0-22" class="i">+        )
</a><a href="#h19-0-23" id="h19-0-23" class="i">+
</a><a href="#h19-0-24" id="h19-0-24" class="i">+        DialogText(
</a><a href="#h19-0-25" id="h19-0-25" class="i">+            &quot;Since Snapchat has implemented additional security measures against third-party applications such as SnapEnhance, we offer a non-opensource solution that reduces the risk of banning and prevents Snapchat from detecting SnapEnhance. &quot; +
</a><a href="#h19-0-26" id="h19-0-26" class="i">+                    &quot;\nPlease note that this solution does not provide a ban bypass or spoofer for anything, and does not take any personal data or communicate with the network.&quot; +
</a><a href="#h19-0-27" id="h19-0-27" class="i">+                    &quot;\nWe also encourage you to use official signed builds to avoid compromising the security of your account.&quot; +
</a><a href="#h19-0-28" id="h19-0-28" class="i">+            &quot;\nIf you&#39;re having trouble using the solution, or are experiencing crashes, join the Telegram Group for help: https://t.me/snapenhance_chat&quot;
</a><a href="#h19-0-29" id="h19-0-29" class="i">+        )
</a><a href="#h19-0-30" id="h19-0-30" class="i">+
</a><a href="#h19-0-31" id="h19-0-31" class="i">+        var denyDialog by remember { mutableStateOf(false) }
</a><a href="#h19-0-32" id="h19-0-32" class="i">+
</a><a href="#h19-0-33" id="h19-0-33" class="i">+        if (denyDialog) {
</a><a href="#h19-0-34" id="h19-0-34" class="i">+            AlertDialog(
</a><a href="#h19-0-35" id="h19-0-35" class="i">+                onDismissRequest = {
</a><a href="#h19-0-36" id="h19-0-36" class="i">+                    denyDialog = false
</a><a href="#h19-0-37" id="h19-0-37" class="i">+                },
</a><a href="#h19-0-38" id="h19-0-38" class="i">+                text = {
</a><a href="#h19-0-39" id="h19-0-39" class="i">+                    Text(&quot;Are you sure you don&#39;t want to use this solution? You can always change this later in the settings in the SnapEnhance app.&quot;)
</a><a href="#h19-0-40" id="h19-0-40" class="i">+                },
</a><a href="#h19-0-41" id="h19-0-41" class="i">+                dismissButton = {
</a><a href="#h19-0-42" id="h19-0-42" class="i">+                    Button(onClick = {
</a><a href="#h19-0-43" id="h19-0-43" class="i">+                        denyDialog = false
</a><a href="#h19-0-44" id="h19-0-44" class="i">+                    }) {
</a><a href="#h19-0-45" id="h19-0-45" class="i">+                        Text(&quot;Go back&quot;)
</a><a href="#h19-0-46" id="h19-0-46" class="i">+                    }
</a><a href="#h19-0-47" id="h19-0-47" class="i">+                },
</a><a href="#h19-0-48" id="h19-0-48" class="i">+                confirmButton = {
</a><a href="#h19-0-49" id="h19-0-49" class="i">+                    Button(onClick = {
</a><a href="#h19-0-50" id="h19-0-50" class="i">+                        context.sharedPreferences.edit().putString(&quot;sif&quot;, &quot;false&quot;).apply()
</a><a href="#h19-0-51" id="h19-0-51" class="i">+                        goNext()
</a><a href="#h19-0-52" id="h19-0-52" class="i">+                    }) {
</a><a href="#h19-0-53" id="h19-0-53" class="i">+                        Text(&quot;Yes, I&#39;m sure&quot;)
</a><a href="#h19-0-54" id="h19-0-54" class="i">+                    }
</a><a href="#h19-0-55" id="h19-0-55" class="i">+                }
</a><a href="#h19-0-56" id="h19-0-56" class="i">+            )
</a><a href="#h19-0-57" id="h19-0-57" class="i">+        }
</a><a href="#h19-0-58" id="h19-0-58" class="i">+
</a><a href="#h19-0-59" id="h19-0-59" class="i">+        Column (
</a><a href="#h19-0-60" id="h19-0-60" class="i">+            modifier = Modifier.padding(16.dp),
</a><a href="#h19-0-61" id="h19-0-61" class="i">+            horizontalAlignment = Alignment.CenterHorizontally,
</a><a href="#h19-0-62" id="h19-0-62" class="i">+            verticalArrangement = Arrangement.spacedBy(10.dp)
</a><a href="#h19-0-63" id="h19-0-63" class="i">+        ) {
</a><a href="#h19-0-64" id="h19-0-64" class="i">+            Button(
</a><a href="#h19-0-65" id="h19-0-65" class="i">+                onClick = {
</a><a href="#h19-0-66" id="h19-0-66" class="i">+                    context.coroutineScope.launch {
</a><a href="#h19-0-67" id="h19-0-67" class="i">+                        context.sharedPreferences.edit().putString(&quot;sif&quot;, &quot;&quot;).commit()
</a><a href="#h19-0-68" id="h19-0-68" class="i">+                        context.remoteSharedLibraryManager.init()
</a><a href="#h19-0-69" id="h19-0-69" class="i">+                    }
</a><a href="#h19-0-70" id="h19-0-70" class="i">+                    goNext()
</a><a href="#h19-0-71" id="h19-0-71" class="i">+                }
</a><a href="#h19-0-72" id="h19-0-72" class="i">+            ) {
</a><a href="#h19-0-73" id="h19-0-73" class="i">+                Text(&quot;Accept and continue&quot;, fontSize = 18.sp, fontWeight = FontWeight.Bold)
</a><a href="#h19-0-74" id="h19-0-74" class="i">+            }
</a><a href="#h19-0-75" id="h19-0-75" class="i">+            Button(
</a><a href="#h19-0-76" id="h19-0-76" class="i">+                colors = ButtonDefaults.buttonColors(containerColor = MaterialTheme.colorScheme.error),
</a><a href="#h19-0-77" id="h19-0-77" class="i">+                onClick = {
</a><a href="#h19-0-78" id="h19-0-78" class="i">+                    denyDialog = true
</a><a href="#h19-0-79" id="h19-0-79" class="i">+                }
</a><a href="#h19-0-80" id="h19-0-80" class="i">+            ) {
</a><a href="#h19-0-81" id="h19-0-81" class="i">+                Text(&quot;I don&#39;t want to use this solution&quot;)
</a><a href="#h19-0-82" id="h19-0-82" class="i">+            }
</a><a href="#h19-0-83" id="h19-0-83" class="i">+        }
</a><a href="#h19-0-84" id="h19-0-84" class="i">+    }
</a><a href="#h19-0-85" id="h19-0-85" class="i">+}</a><a href="#h19-0-86" id="h19-0-86" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h20" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/util/AlertDialogs.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/util/AlertDialogs.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/util/AlertDialogs.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/util/AlertDialogs.kt</a></b>
<a href="#h20-0" id="h20-0" class="h">@@ -360,12 +360,11 @@ class AlertDialogs(
</a> 
     @Composable
     fun ColorPickerDialog(
<a href="#h20-0-3" id="h20-0-3" class="d">-        property: PropertyPair&lt;*&gt;,
</a><a href="#h20-0-4" id="h20-0-4" class="d">-        dismiss: () -&gt; Unit = {},
</a><a href="#h20-0-5" id="h20-0-5" class="i">+        initialColor: Color?,
</a><a href="#h20-0-6" id="h20-0-6" class="i">+        setProperty: (Color?) -&gt; Unit,
</a><a href="#h20-0-7" id="h20-0-7" class="i">+        dismiss: () -&gt; Unit
</a>     ) {
<a href="#h20-0-9" id="h20-0-9" class="d">-        var currentColor by remember {
</a><a href="#h20-0-10" id="h20-0-10" class="d">-            mutableStateOf((property.value.getNullable() as? Int)?.let { Color(it) })
</a><a href="#h20-0-11" id="h20-0-11" class="d">-        }
</a><a href="#h20-0-12" id="h20-0-12" class="i">+        var currentColor by remember { mutableStateOf(initialColor) }
</a> 
         DefaultDialogCard {
             val controller = remember { ColorPickerController().apply {
<a href="#h20-1" id="h20-1" class="h">@@ -389,7 +388,7 @@ class AlertDialogs(
</a>                         runCatching {
                             currentColor = Color(android.graphics.Color.parseColor(&quot;#$value&quot;)).also {
                                 controller.selectByColor(it, true)
<a href="#h20-1-3" id="h20-1-3" class="d">-                                property.value.setAny(it.toArgb())
</a><a href="#h20-1-4" id="h20-1-4" class="i">+                                setProperty(it)
</a>                             }
                         }.onFailure {
                             currentColor = null
<a href="#h20-2" id="h20-2" class="h">@@ -417,7 +416,7 @@ class AlertDialogs(
</a>                     if (!it.fromUser) return@HsvColorPicker
                     currentColor = it.color
                     colorHexValue = Integer.toHexString(it.color.toArgb())
<a href="#h20-2-3" id="h20-2-3" class="d">-                    property.value.setAny(it.color.toArgb())
</a><a href="#h20-2-4" id="h20-2-4" class="i">+                    setProperty(it.color)
</a>                 }
             )
             AlphaSlider(
<a href="#h20-3" id="h20-3" class="h">@@ -450,7 +449,7 @@ class AlertDialogs(
</a>                     controller = controller
                 )
                 IconButton(onClick = {
<a href="#h20-3-3" id="h20-3-3" class="d">-                    property.value.setAny(null)
</a><a href="#h20-3-4" id="h20-3-4" class="i">+                    setProperty(null)
</a>                     dismiss()
                 }) {
                     Icon(
<a href="#h20-4" id="h20-4" class="h">@@ -464,6 +463,25 @@ class AlertDialogs(
</a>     }
 
     @Composable
<a href="#h20-4-3" id="h20-4-3" class="i">+    fun ColorPickerPropertyDialog(
</a><a href="#h20-4-4" id="h20-4-4" class="i">+        property: PropertyPair&lt;*&gt;,
</a><a href="#h20-4-5" id="h20-4-5" class="i">+        dismiss: () -&gt; Unit = {},
</a><a href="#h20-4-6" id="h20-4-6" class="i">+    ) {
</a><a href="#h20-4-7" id="h20-4-7" class="i">+        var currentColor by remember {
</a><a href="#h20-4-8" id="h20-4-8" class="i">+            mutableStateOf((property.value.getNullable() as? Int)?.let { Color(it) })
</a><a href="#h20-4-9" id="h20-4-9" class="i">+        }
</a><a href="#h20-4-10" id="h20-4-10" class="i">+
</a><a href="#h20-4-11" id="h20-4-11" class="i">+        ColorPickerDialog(
</a><a href="#h20-4-12" id="h20-4-12" class="i">+            initialColor = currentColor,
</a><a href="#h20-4-13" id="h20-4-13" class="i">+            setProperty = {
</a><a href="#h20-4-14" id="h20-4-14" class="i">+                currentColor = it
</a><a href="#h20-4-15" id="h20-4-15" class="i">+                property.value.setAny(it?.toArgb())
</a><a href="#h20-4-16" id="h20-4-16" class="i">+            },
</a><a href="#h20-4-17" id="h20-4-17" class="i">+            dismiss = dismiss
</a><a href="#h20-4-18" id="h20-4-18" class="i">+        )
</a><a href="#h20-4-19" id="h20-4-19" class="i">+    }
</a><a href="#h20-4-20" id="h20-4-20" class="i">+
</a><a href="#h20-4-21" id="h20-4-21" class="i">+    @Composable
</a>     fun ChooseLocationDialog(
         property: PropertyPair&lt;*&gt;,
         marker: MutableState&lt;Marker?&gt; = remember { mutableStateOf(null) },
<b>diff --git a/<a id="h21" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/util/ColorPicker.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/util/ColorPicker.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/util/ColorPicker.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/util/ColorPicker.kt</a></b>
<a href="#h21-0" id="h21-0" class="h">@@ -0,0 +1,27 @@
</a><a href="#h21-0-0" id="h21-0-0" class="i">+package me.rhunk.snapenhance.ui.util
</a><a href="#h21-0-1" id="h21-0-1" class="i">+
</a><a href="#h21-0-2" id="h21-0-2" class="i">+import androidx.compose.foundation.border
</a><a href="#h21-0-3" id="h21-0-3" class="i">+import androidx.compose.foundation.layout.size
</a><a href="#h21-0-4" id="h21-0-4" class="i">+import androidx.compose.foundation.shape.RoundedCornerShape
</a><a href="#h21-0-5" id="h21-0-5" class="i">+import androidx.compose.runtime.Composable
</a><a href="#h21-0-6" id="h21-0-6" class="i">+import androidx.compose.ui.Modifier
</a><a href="#h21-0-7" id="h21-0-7" class="i">+import androidx.compose.ui.draw.clip
</a><a href="#h21-0-8" id="h21-0-8" class="i">+import androidx.compose.ui.graphics.Color
</a><a href="#h21-0-9" id="h21-0-9" class="i">+import androidx.compose.ui.unit.dp
</a><a href="#h21-0-10" id="h21-0-10" class="i">+import com.github.skydoves.colorpicker.compose.AlphaTile
</a><a href="#h21-0-11" id="h21-0-11" class="i">+
</a><a href="#h21-0-12" id="h21-0-12" class="i">+@Composable
</a><a href="#h21-0-13" id="h21-0-13" class="i">+fun CircularAlphaTile(
</a><a href="#h21-0-14" id="h21-0-14" class="i">+    selectedColor: Color?,
</a><a href="#h21-0-15" id="h21-0-15" class="i">+) {
</a><a href="#h21-0-16" id="h21-0-16" class="i">+    AlphaTile(
</a><a href="#h21-0-17" id="h21-0-17" class="i">+        modifier = Modifier
</a><a href="#h21-0-18" id="h21-0-18" class="i">+            .size(30.dp)
</a><a href="#h21-0-19" id="h21-0-19" class="i">+            .border(2.dp, Color.White, shape = RoundedCornerShape(15.dp))
</a><a href="#h21-0-20" id="h21-0-20" class="i">+            .clip(RoundedCornerShape(15.dp)),
</a><a href="#h21-0-21" id="h21-0-21" class="i">+        selectedColor = selectedColor ?: Color.Transparent,
</a><a href="#h21-0-22" id="h21-0-22" class="i">+        tileEvenColor = selectedColor?.let { Color(0xFFCBCBCB) } ?: Color.Transparent,
</a><a href="#h21-0-23" id="h21-0-23" class="i">+        tileOddColor = selectedColor?.let { Color.White } ?: Color.Transparent,
</a><a href="#h21-0-24" id="h21-0-24" class="i">+        tileSize = 8.dp,
</a><a href="#h21-0-25" id="h21-0-25" class="i">+    )
</a><a href="#h21-0-26" id="h21-0-26" class="i">+}</a><a href="#h21-0-27" id="h21-0-27" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h22" href="../file/common/src/main/kotlin/me/rhunk/snapenhance/common/bridge/BridgeFiles.kt.html">common/src/main/kotlin/me/rhunk/snapenhance/common/bridge/BridgeFiles.kt</a> b/<a href="../file/common/src/main/kotlin/me/rhunk/snapenhance/common/bridge/BridgeFiles.kt.html">common/src/main/kotlin/me/rhunk/snapenhance/common/bridge/BridgeFiles.kt</a></b>
<a href="#h22-0" id="h22-0" class="h">@@ -16,7 +16,8 @@ enum class FileHandleScope(
</a>     INTERNAL(&quot;internal&quot;),
     LOCALE(&quot;locale&quot;),
     USER_IMPORT(&quot;user_import&quot;),
<a href="#h22-0-3" id="h22-0-3" class="d">-    COMPOSER(&quot;composer&quot;);
</a><a href="#h22-0-4" id="h22-0-4" class="i">+    COMPOSER(&quot;composer&quot;),
</a><a href="#h22-0-5" id="h22-0-5" class="i">+    THEME(&quot;theme&quot;);
</a> 
     companion object {
         fun fromValue(name: String): FileHandleScope? = entries.find { it.key == name }
<a href="#h22-1" id="h22-1" class="h">@@ -31,8 +32,8 @@ enum class InternalFileHandleType(
</a>     CONFIG(&quot;config&quot;, &quot;config.json&quot;),
     MAPPINGS(&quot;mappings&quot;, &quot;mappings.json&quot;),
     MESSAGE_LOGGER(&quot;message_logger&quot;, &quot;message_logger.db&quot;, isDatabase = true),
<a href="#h22-1-3" id="h22-1-3" class="d">-    PINNED_BEST_FRIEND(&quot;pinned_best_friend&quot;, &quot;pinned_best_friend.txt&quot;);
</a><a href="#h22-1-4" id="h22-1-4" class="d">-
</a><a href="#h22-1-5" id="h22-1-5" class="i">+    PINNED_BEST_FRIEND(&quot;pinned_best_friend&quot;, &quot;pinned_best_friend.txt&quot;),
</a><a href="#h22-1-6" id="h22-1-6" class="i">+    SIF(&quot;sif&quot;, &quot;libsif.so&quot;);
</a> 
     fun resolve(context: Context): File = if (isDatabase) {
         context.getDatabasePath(fileName)
<b>diff --git a/<a id="h23" href="../file/common/src/main/kotlin/me/rhunk/snapenhance/common/bridge/wrapper/LoggerWrapper.kt.html">common/src/main/kotlin/me/rhunk/snapenhance/common/bridge/wrapper/LoggerWrapper.kt</a> b/<a href="../file/common/src/main/kotlin/me/rhunk/snapenhance/common/bridge/wrapper/LoggerWrapper.kt.html">common/src/main/kotlin/me/rhunk/snapenhance/common/bridge/wrapper/LoggerWrapper.kt</a></b>
<a href="#h23-0" id="h23-0" class="h">@@ -39,7 +39,7 @@ class ConversationInfo(
</a>     val usernames: List&lt;String&gt;
 )
 
<a href="#h23-0-3" id="h23-0-3" class="d">-class TrackerLog(
</a><a href="#h23-0-4" id="h23-0-4" class="i">+data class TrackerLog(
</a>     val id: Int,
     val timestamp: Long,
     val conversationId: String,
<b>diff --git a/<a id="h24" href="../file/common/src/main/kotlin/me/rhunk/snapenhance/common/config/ModConfig.kt.html">common/src/main/kotlin/me/rhunk/snapenhance/common/config/ModConfig.kt</a> b/<a href="../file/common/src/main/kotlin/me/rhunk/snapenhance/common/config/ModConfig.kt.html">common/src/main/kotlin/me/rhunk/snapenhance/common/config/ModConfig.kt</a></b>
<a href="#h24-0" id="h24-0" class="h">@@ -107,7 +107,7 @@ class ModConfig(
</a>         val oldConfig = runCatching { fileWrapper.readBytes().toString(Charsets.UTF_8) }.getOrNull()
         fileWrapper.writeBytes(exportToString().toByteArray(Charsets.UTF_8))
 
<a href="#h24-0-3" id="h24-0-3" class="d">-        configStateListener?.also {
</a><a href="#h24-0-4" id="h24-0-4" class="i">+        configStateListener?.takeIf { it.asBinder().pingBinder() }?.also {
</a>             runCatching {
                 compareDiff(createRootConfig().apply {
                     fromJson(gson.fromJson(oldConfig ?: return@runCatching, JsonObject::class.java))
<b>diff --git a/<a id="h25" href="../file/common/src/main/kotlin/me/rhunk/snapenhance/common/config/impl/Experimental.kt.html">common/src/main/kotlin/me/rhunk/snapenhance/common/config/impl/Experimental.kt</a> b/<a href="../file/common/src/main/kotlin/me/rhunk/snapenhance/common/config/impl/Experimental.kt.html">common/src/main/kotlin/me/rhunk/snapenhance/common/config/impl/Experimental.kt</a></b>
<a href="#h25-0" id="h25-0" class="h">@@ -31,7 +31,7 @@ class Experimental : ConfigContainer() {
</a>         val composerLogs = boolean(&quot;composer_logs&quot;)
     }
 
<a href="#h25-0-3" id="h25-0-3" class="d">-    class NativeHooks : ConfigContainer(hasGlobalState = true) {
</a><a href="#h25-0-4" id="h25-0-4" class="i">+    class NativeHooks : ConfigContainer() {
</a>         val composerHooks = container(&quot;composer_hooks&quot;, ComposerHooksConfig()) { requireRestart() }
         val disableBitmoji = boolean(&quot;disable_bitmoji&quot;)
         val customEmojiFont = string(&quot;custom_emoji_font&quot;) {
<a href="#h25-1" id="h25-1" class="h">@@ -40,7 +40,6 @@ class Experimental : ConfigContainer() {
</a>             addFlags(ConfigFlag.USER_IMPORT)
             filenameFilter = { it.endsWith(&quot;.ttf&quot;) }
         }
<a href="#h25-1-3" id="h25-1-3" class="d">-        val remapExecutable = boolean(&quot;remap_executable&quot;) { requireRestart(); addNotices(FeatureNotice.INTERNAL_BEHAVIOR, FeatureNotice.UNSTABLE) }
</a>     }
 
     class E2EEConfig : ConfigContainer(hasGlobalState = true) {
<b>diff --git a/<a id="h26" href="../file/common/src/main/kotlin/me/rhunk/snapenhance/common/data/ThemingObjects.kt.html">common/src/main/kotlin/me/rhunk/snapenhance/common/data/ThemingObjects.kt</a> b/<a href="../file/common/src/main/kotlin/me/rhunk/snapenhance/common/data/ThemingObjects.kt.html">common/src/main/kotlin/me/rhunk/snapenhance/common/data/ThemingObjects.kt</a></b>
<a href="#h26-0" id="h26-0" class="h">@@ -0,0 +1,120 @@
</a><a href="#h26-0-0" id="h26-0-0" class="i">+package me.rhunk.snapenhance.common.data
</a><a href="#h26-0-1" id="h26-0-1" class="i">+
</a><a href="#h26-0-2" id="h26-0-2" class="i">+import android.os.Parcelable
</a><a href="#h26-0-3" id="h26-0-3" class="i">+import com.google.gson.annotations.SerializedName
</a><a href="#h26-0-4" id="h26-0-4" class="i">+import kotlinx.parcelize.Parcelize
</a><a href="#h26-0-5" id="h26-0-5" class="i">+
</a><a href="#h26-0-6" id="h26-0-6" class="i">+
</a><a href="#h26-0-7" id="h26-0-7" class="i">+@Parcelize
</a><a href="#h26-0-8" id="h26-0-8" class="i">+data class ThemeColorEntry(
</a><a href="#h26-0-9" id="h26-0-9" class="i">+    @SerializedName(&quot;key&quot;)
</a><a href="#h26-0-10" id="h26-0-10" class="i">+    val key: String,
</a><a href="#h26-0-11" id="h26-0-11" class="i">+    @SerializedName(&quot;value&quot;)
</a><a href="#h26-0-12" id="h26-0-12" class="i">+    var value: Int,
</a><a href="#h26-0-13" id="h26-0-13" class="i">+): Parcelable
</a><a href="#h26-0-14" id="h26-0-14" class="i">+
</a><a href="#h26-0-15" id="h26-0-15" class="i">+@Parcelize
</a><a href="#h26-0-16" id="h26-0-16" class="i">+data class DatabaseThemeContent(
</a><a href="#h26-0-17" id="h26-0-17" class="i">+    @SerializedName(&quot;colors&quot;)
</a><a href="#h26-0-18" id="h26-0-18" class="i">+    val colors: List&lt;ThemeColorEntry&gt; = emptyList(),
</a><a href="#h26-0-19" id="h26-0-19" class="i">+): Parcelable
</a><a href="#h26-0-20" id="h26-0-20" class="i">+
</a><a href="#h26-0-21" id="h26-0-21" class="i">+data class DatabaseTheme(
</a><a href="#h26-0-22" id="h26-0-22" class="i">+    val id: Int,
</a><a href="#h26-0-23" id="h26-0-23" class="i">+    val enabled: Boolean,
</a><a href="#h26-0-24" id="h26-0-24" class="i">+    val name: String,
</a><a href="#h26-0-25" id="h26-0-25" class="i">+    val description: String?,
</a><a href="#h26-0-26" id="h26-0-26" class="i">+    val version: String?,
</a><a href="#h26-0-27" id="h26-0-27" class="i">+    val author: String?,
</a><a href="#h26-0-28" id="h26-0-28" class="i">+    val updateUrl: String?,
</a><a href="#h26-0-29" id="h26-0-29" class="i">+) {
</a><a href="#h26-0-30" id="h26-0-30" class="i">+    fun toExportedTheme(content: DatabaseThemeContent): ExportedTheme {
</a><a href="#h26-0-31" id="h26-0-31" class="i">+        return ExportedTheme(
</a><a href="#h26-0-32" id="h26-0-32" class="i">+            name = name,
</a><a href="#h26-0-33" id="h26-0-33" class="i">+            description = description,
</a><a href="#h26-0-34" id="h26-0-34" class="i">+            version = version,
</a><a href="#h26-0-35" id="h26-0-35" class="i">+            author = author,
</a><a href="#h26-0-36" id="h26-0-36" class="i">+            content = content,
</a><a href="#h26-0-37" id="h26-0-37" class="i">+        )
</a><a href="#h26-0-38" id="h26-0-38" class="i">+    }
</a><a href="#h26-0-39" id="h26-0-39" class="i">+}
</a><a href="#h26-0-40" id="h26-0-40" class="i">+
</a><a href="#h26-0-41" id="h26-0-41" class="i">+data class ExportedTheme(
</a><a href="#h26-0-42" id="h26-0-42" class="i">+    val name: String,
</a><a href="#h26-0-43" id="h26-0-43" class="i">+    val description: String?,
</a><a href="#h26-0-44" id="h26-0-44" class="i">+    val version: String?,
</a><a href="#h26-0-45" id="h26-0-45" class="i">+    val author: String?,
</a><a href="#h26-0-46" id="h26-0-46" class="i">+    val content: DatabaseThemeContent,
</a><a href="#h26-0-47" id="h26-0-47" class="i">+) {
</a><a href="#h26-0-48" id="h26-0-48" class="i">+    fun toDatabaseTheme(id: Int = -1, updateUrl: String? = null, enabled: Boolean = false): DatabaseTheme {
</a><a href="#h26-0-49" id="h26-0-49" class="i">+        return DatabaseTheme(
</a><a href="#h26-0-50" id="h26-0-50" class="i">+            id = id,
</a><a href="#h26-0-51" id="h26-0-51" class="i">+            enabled = enabled,
</a><a href="#h26-0-52" id="h26-0-52" class="i">+            name = name,
</a><a href="#h26-0-53" id="h26-0-53" class="i">+            description = description,
</a><a href="#h26-0-54" id="h26-0-54" class="i">+            version = version,
</a><a href="#h26-0-55" id="h26-0-55" class="i">+            author = author,
</a><a href="#h26-0-56" id="h26-0-56" class="i">+            updateUrl = updateUrl,
</a><a href="#h26-0-57" id="h26-0-57" class="i">+        )
</a><a href="#h26-0-58" id="h26-0-58" class="i">+    }
</a><a href="#h26-0-59" id="h26-0-59" class="i">+}
</a><a href="#h26-0-60" id="h26-0-60" class="i">+
</a><a href="#h26-0-61" id="h26-0-61" class="i">+data class RepositoryThemeManifest(
</a><a href="#h26-0-62" id="h26-0-62" class="i">+    val name: String,
</a><a href="#h26-0-63" id="h26-0-63" class="i">+    val author: String?,
</a><a href="#h26-0-64" id="h26-0-64" class="i">+    val description: String?,
</a><a href="#h26-0-65" id="h26-0-65" class="i">+    val version: String?,
</a><a href="#h26-0-66" id="h26-0-66" class="i">+    val filepath: String,
</a><a href="#h26-0-67" id="h26-0-67" class="i">+)
</a><a href="#h26-0-68" id="h26-0-68" class="i">+
</a><a href="#h26-0-69" id="h26-0-69" class="i">+data class RepositoryIndex(
</a><a href="#h26-0-70" id="h26-0-70" class="i">+    val themes: List&lt;RepositoryThemeManifest&gt; = emptyList(),
</a><a href="#h26-0-71" id="h26-0-71" class="i">+)
</a><a href="#h26-0-72" id="h26-0-72" class="i">+
</a><a href="#h26-0-73" id="h26-0-73" class="i">+enum class ThemingAttributeType {
</a><a href="#h26-0-74" id="h26-0-74" class="i">+    COLOR
</a><a href="#h26-0-75" id="h26-0-75" class="i">+}
</a><a href="#h26-0-76" id="h26-0-76" class="i">+
</a><a href="#h26-0-77" id="h26-0-77" class="i">+val AvailableThemingAttributes = mapOf(
</a><a href="#h26-0-78" id="h26-0-78" class="i">+    ThemingAttributeType.COLOR to listOf(
</a><a href="#h26-0-79" id="h26-0-79" class="i">+        &quot;sigColorTextPrimary&quot;,
</a><a href="#h26-0-80" id="h26-0-80" class="i">+        &quot;sigColorBackgroundSurface&quot;,
</a><a href="#h26-0-81" id="h26-0-81" class="i">+        &quot;sigColorBackgroundMain&quot;,
</a><a href="#h26-0-82" id="h26-0-82" class="i">+        &quot;actionSheetBackgroundDrawable&quot;,
</a><a href="#h26-0-83" id="h26-0-83" class="i">+        &quot;actionSheetRoundedBackgroundDrawable&quot;,
</a><a href="#h26-0-84" id="h26-0-84" class="i">+        &quot;sigColorChatChat&quot;,
</a><a href="#h26-0-85" id="h26-0-85" class="i">+        &quot;sigColorChatPendingSending&quot;,
</a><a href="#h26-0-86" id="h26-0-86" class="i">+        &quot;sigColorChatSnapWithSound&quot;,
</a><a href="#h26-0-87" id="h26-0-87" class="i">+        &quot;sigColorChatSnapWithoutSound&quot;,
</a><a href="#h26-0-88" id="h26-0-88" class="i">+        &quot;sigExceptionColorCameraGridLines&quot;,
</a><a href="#h26-0-89" id="h26-0-89" class="i">+        &quot;listDivider&quot;,
</a><a href="#h26-0-90" id="h26-0-90" class="i">+        &quot;listBackgroundDrawable&quot;,
</a><a href="#h26-0-91" id="h26-0-91" class="i">+        &quot;sigColorIconPrimary&quot;,
</a><a href="#h26-0-92" id="h26-0-92" class="i">+        &quot;actionSheetDescriptionTextColor&quot;,
</a><a href="#h26-0-93" id="h26-0-93" class="i">+        &quot;ringColor&quot;,
</a><a href="#h26-0-94" id="h26-0-94" class="i">+        &quot;sigColorIconSecondary&quot;,
</a><a href="#h26-0-95" id="h26-0-95" class="i">+        &quot;itemShapeFillColor&quot;,
</a><a href="#h26-0-96" id="h26-0-96" class="i">+        &quot;ringStartColor&quot;,
</a><a href="#h26-0-97" id="h26-0-97" class="i">+        &quot;sigColorLayoutPlaceholder&quot;,
</a><a href="#h26-0-98" id="h26-0-98" class="i">+        &quot;scButtonColor&quot;,
</a><a href="#h26-0-99" id="h26-0-99" class="i">+        &quot;recipientPillBackgroundDrawable&quot;,
</a><a href="#h26-0-100" id="h26-0-100" class="i">+        &quot;boxBackgroundColor&quot;,
</a><a href="#h26-0-101" id="h26-0-101" class="i">+        &quot;editTextColor&quot;,
</a><a href="#h26-0-102" id="h26-0-102" class="i">+        &quot;chipBackgroundColor&quot;,
</a><a href="#h26-0-103" id="h26-0-103" class="i">+        &quot;recipientInputStyle&quot;,
</a><a href="#h26-0-104" id="h26-0-104" class="i">+        &quot;rangeFillColor&quot;,
</a><a href="#h26-0-105" id="h26-0-105" class="i">+        &quot;pstsIndicatorColor&quot;,
</a><a href="#h26-0-106" id="h26-0-106" class="i">+        &quot;pstsTabBackground&quot;,
</a><a href="#h26-0-107" id="h26-0-107" class="i">+        &quot;pstsDividerColor&quot;,
</a><a href="#h26-0-108" id="h26-0-108" class="i">+        &quot;tabTextColor&quot;,
</a><a href="#h26-0-109" id="h26-0-109" class="i">+        &quot;statusBarForeground&quot;,
</a><a href="#h26-0-110" id="h26-0-110" class="i">+        &quot;statusBarBackground&quot;,
</a><a href="#h26-0-111" id="h26-0-111" class="i">+        &quot;strokeColor&quot;,
</a><a href="#h26-0-112" id="h26-0-112" class="i">+        &quot;storyReplayViewRingColor&quot;,
</a><a href="#h26-0-113" id="h26-0-113" class="i">+        &quot;sigColorButtonPrimary&quot;,
</a><a href="#h26-0-114" id="h26-0-114" class="i">+        &quot;sigColorBaseAppYellow&quot;,
</a><a href="#h26-0-115" id="h26-0-115" class="i">+        &quot;sigColorBackgroundSurfaceTranslucent&quot;,
</a><a href="#h26-0-116" id="h26-0-116" class="i">+        &quot;sigColorStoryRingFriendsFeedStoryRing&quot;,
</a><a href="#h26-0-117" id="h26-0-117" class="i">+        &quot;sigColorStoryRingDiscoverTabThumbnailStoryRing&quot;,
</a><a href="#h26-0-118" id="h26-0-118" class="i">+    )
</a><a href="#h26-0-119" id="h26-0-119" class="i">+)
</a><b>diff --git a/<a id="h27" href="../file/common/src/main/kotlin/me/rhunk/snapenhance/common/ui/TextFieldColors.kt.html">common/src/main/kotlin/me/rhunk/snapenhance/common/ui/TextFieldColors.kt</a> b/<a href="../file/common/src/main/kotlin/me/rhunk/snapenhance/common/ui/TextFieldColors.kt.html">common/src/main/kotlin/me/rhunk/snapenhance/common/ui/TextFieldColors.kt</a></b>
<a href="#h27-0" id="h27-0" class="h">@@ -0,0 +1,17 @@
</a><a href="#h27-0-0" id="h27-0-0" class="i">+package me.rhunk.snapenhance.common.ui
</a><a href="#h27-0-1" id="h27-0-1" class="i">+
</a><a href="#h27-0-2" id="h27-0-2" class="i">+import androidx.compose.material3.MaterialTheme
</a><a href="#h27-0-3" id="h27-0-3" class="i">+import androidx.compose.material3.TextFieldDefaults
</a><a href="#h27-0-4" id="h27-0-4" class="i">+import androidx.compose.runtime.Composable
</a><a href="#h27-0-5" id="h27-0-5" class="i">+import androidx.compose.ui.graphics.Color
</a><a href="#h27-0-6" id="h27-0-6" class="i">+
</a><a href="#h27-0-7" id="h27-0-7" class="i">+
</a><a href="#h27-0-8" id="h27-0-8" class="i">+@Composable
</a><a href="#h27-0-9" id="h27-0-9" class="i">+fun transparentTextFieldColors() = TextFieldDefaults.colors(
</a><a href="#h27-0-10" id="h27-0-10" class="i">+    unfocusedContainerColor = MaterialTheme.colorScheme.surface,
</a><a href="#h27-0-11" id="h27-0-11" class="i">+    focusedContainerColor = MaterialTheme.colorScheme.surface,
</a><a href="#h27-0-12" id="h27-0-12" class="i">+    focusedIndicatorColor = Color.Transparent,
</a><a href="#h27-0-13" id="h27-0-13" class="i">+    unfocusedIndicatorColor = Color.Transparent,
</a><a href="#h27-0-14" id="h27-0-14" class="i">+    disabledIndicatorColor = Color.Transparent,
</a><a href="#h27-0-15" id="h27-0-15" class="i">+    cursorColor = MaterialTheme.colorScheme.primary
</a><a href="#h27-0-16" id="h27-0-16" class="i">+)
</a><b>diff --git a/<a id="h28" href="../file/common/src/main/kotlin/me/rhunk/snapenhance/common/util/ktx/AndroidCompatExtensions.kt.html">common/src/main/kotlin/me/rhunk/snapenhance/common/util/ktx/AndroidCompatExtensions.kt</a> b/<a href="../file/common/src/main/kotlin/me/rhunk/snapenhance/common/util/ktx/AndroidCompatExtensions.kt.html">common/src/main/kotlin/me/rhunk/snapenhance/common/util/ktx/AndroidCompatExtensions.kt</a></b>
<a href="#h28-0" id="h28-0" class="h">@@ -20,8 +20,23 @@ fun PackageManager.getApplicationInfoCompat(packageName: String, flags: Int) =
</a>     }
 
 fun Context.copyToClipboard(data: String, label: String = &quot;Copied Text&quot;) {
<a href="#h28-0-3" id="h28-0-3" class="d">-    getSystemService(android.content.ClipboardManager::class.java).setPrimaryClip(
</a><a href="#h28-0-4" id="h28-0-4" class="d">-        ClipData.newPlainText(label, data))
</a><a href="#h28-0-5" id="h28-0-5" class="i">+    runCatching {
</a><a href="#h28-0-6" id="h28-0-6" class="i">+        getSystemService(android.content.ClipboardManager::class.java).setPrimaryClip(
</a><a href="#h28-0-7" id="h28-0-7" class="i">+            ClipData.newPlainText(label, data))
</a><a href="#h28-0-8" id="h28-0-8" class="i">+    }
</a><a href="#h28-0-9" id="h28-0-9" class="i">+}
</a><a href="#h28-0-10" id="h28-0-10" class="i">+
</a><a href="#h28-0-11" id="h28-0-11" class="i">+fun Context.getTextFromClipboard(): String? {
</a><a href="#h28-0-12" id="h28-0-12" class="i">+    return runCatching {
</a><a href="#h28-0-13" id="h28-0-13" class="i">+        getSystemService(android.content.ClipboardManager::class.java).primaryClip
</a><a href="#h28-0-14" id="h28-0-14" class="i">+            ?.takeIf { it.itemCount &gt; 0 }
</a><a href="#h28-0-15" id="h28-0-15" class="i">+            ?.getItemAt(0)
</a><a href="#h28-0-16" id="h28-0-16" class="i">+            ?.text?.toString()
</a><a href="#h28-0-17" id="h28-0-17" class="i">+    }.getOrNull()
</a><a href="#h28-0-18" id="h28-0-18" class="i">+}
</a><a href="#h28-0-19" id="h28-0-19" class="i">+
</a><a href="#h28-0-20" id="h28-0-20" class="i">+fun Context.getUrlFromClipboard(): String? {
</a><a href="#h28-0-21" id="h28-0-21" class="i">+    return getTextFromClipboard()?.takeIf { it.startsWith(&quot;http&quot;) }
</a> }
 
 fun InputStream.toParcelFileDescriptor(coroutineScope: CoroutineScope): ParcelFileDescriptor {
<b>diff --git a/<a id="h29" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/ModContext.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/ModContext.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/ModContext.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/ModContext.kt</a></b>
<a href="#h29-0" id="h29-0" class="h">@@ -79,7 +79,7 @@ class ModContext(
</a>     }
 
     fun runOnUiThread(runnable: () -&gt; Unit) {
<a href="#h29-0-3" id="h29-0-3" class="d">-        if (Looper.myLooper() == Looper.getMainLooper()) {
</a><a href="#h29-0-4" id="h29-0-4" class="i">+        if (Looper.getMainLooper().isCurrentThread) {
</a>             runnable()
             return
         }
<a href="#h29-1" id="h29-1" class="h">@@ -95,7 +95,7 @@ class ModContext(
</a>             runCatching {
                 runnable()
             }.onFailure {
<a href="#h29-1-3" id="h29-1-3" class="d">-                longToast(&quot;Async task failed &quot; + it.message)
</a><a href="#h29-1-4" id="h29-1-4" class="i">+                longToast(&quot;Async task failed: &quot; + it.message)
</a>                 log.error(&quot;Async task failed&quot;, it)
             }
         }
<a href="#h29-2" id="h29-2" class="h">@@ -153,13 +153,11 @@ class ModContext(
</a>     }
 
     fun reloadNativeConfig() {
<a href="#h29-2-3" id="h29-2-3" class="d">-        if (config.experimental.nativeHooks.globalState != true) return
</a>         native.loadNativeConfig(
             NativeConfig(
                 disableBitmoji = config.experimental.nativeHooks.disableBitmoji.get(),
                 disableMetrics = config.global.disableMetrics.get(),
                 composerHooks = config.experimental.nativeHooks.composerHooks.globalState == true,
<a href="#h29-2-9" id="h29-2-9" class="d">-                remapExecutable = config.experimental.nativeHooks.remapExecutable.get(),
</a>                 customEmojiFontPath = getCustomEmojiFontPath(this)
             )
         )
<b>diff --git a/<a id="h30" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/BridgeFileFeature.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/BridgeFileFeature.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/BridgeFileFeature.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/BridgeFileFeature.kt</a></b>
<a href="#h30-0" id="h30-0" class="h">@@ -9,7 +9,7 @@ import java.io.BufferedReader
</a> import java.io.InputStreamReader
 import java.nio.charset.StandardCharsets
 
<a href="#h30-0-3" id="h30-0-3" class="d">-abstract class BridgeFileFeature(name: String, private val bridgeFileType: InternalFileHandleType, loadParams: Int) : Feature(name, loadParams) {
</a><a href="#h30-0-4" id="h30-0-4" class="i">+abstract class BridgeFileFeature(name: String, private val bridgeFileType: InternalFileHandleType) : Feature(name) {
</a>     private val fileLines = mutableListOf&lt;String&gt;()
     private val fileWrapper by mappedLazyBridge(LazyBridgeValue({ context.fileHandlerManager.getFileHandle(FileHandleScope.INTERNAL.key, bridgeFileType.key)!! }), map = { it.toWrapper() })
 
<b>diff --git a/<a id="h31" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/Feature.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/Feature.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/Feature.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/Feature.kt</a></b>
<a href="#h31-0" id="h31-0" class="h">@@ -1,33 +1,39 @@
</a> package me.rhunk.snapenhance.core.features
 
<a href="#h31-0-2" id="h31-0-2" class="i">+import android.app.Activity
</a><a href="#h31-0-3" id="h31-0-3" class="i">+import kotlinx.coroutines.launch
</a> import me.rhunk.snapenhance.core.ModContext
 
 abstract class Feature(
<a href="#h31-0-7" id="h31-0-7" class="d">-    val featureKey: String,
</a><a href="#h31-0-8" id="h31-0-8" class="d">-    val loadParams: Int = FeatureLoadParams.INIT_SYNC
</a><a href="#h31-0-9" id="h31-0-9" class="i">+    val key: String
</a> ) {
     lateinit var context: ModContext
<a href="#h31-0-12" id="h31-0-12" class="i">+    lateinit var registerNextActivityCallback: ((Activity) -&gt; Unit) -&gt; Unit
</a><a href="#h31-0-13" id="h31-0-13" class="i">+
</a><a href="#h31-0-14" id="h31-0-14" class="i">+    protected fun defer(block: () -&gt; Unit) {
</a><a href="#h31-0-15" id="h31-0-15" class="i">+        context.coroutineScope.launch {
</a><a href="#h31-0-16" id="h31-0-16" class="i">+            runCatching {
</a><a href="#h31-0-17" id="h31-0-17" class="i">+                block()
</a><a href="#h31-0-18" id="h31-0-18" class="i">+            }.onFailure {
</a><a href="#h31-0-19" id="h31-0-19" class="i">+                context.log.error(&quot;Failed to run onNextActivityCreate callback&quot;, it)
</a><a href="#h31-0-20" id="h31-0-20" class="i">+            }
</a><a href="#h31-0-21" id="h31-0-21" class="i">+        }
</a><a href="#h31-0-22" id="h31-0-22" class="i">+    }
</a> 
<a href="#h31-0-24" id="h31-0-24" class="d">-    /**
</a><a href="#h31-0-25" id="h31-0-25" class="d">-     * called on the main thread when the mod initialize
</a><a href="#h31-0-26" id="h31-0-26" class="d">-     */
</a><a href="#h31-0-27" id="h31-0-27" class="d">-    open fun init() {}
</a><a href="#h31-0-28" id="h31-0-28" class="d">-
</a><a href="#h31-0-29" id="h31-0-29" class="d">-    /**
</a><a href="#h31-0-30" id="h31-0-30" class="d">-     * called on a dedicated thread when the mod initialize
</a><a href="#h31-0-31" id="h31-0-31" class="d">-     */
</a><a href="#h31-0-32" id="h31-0-32" class="d">-    open fun asyncInit() {}
</a><a href="#h31-0-33" id="h31-0-33" class="d">-
</a><a href="#h31-0-34" id="h31-0-34" class="d">-    /**
</a><a href="#h31-0-35" id="h31-0-35" class="d">-     * called when the Snapchat Activity is created
</a><a href="#h31-0-36" id="h31-0-36" class="d">-     */
</a><a href="#h31-0-37" id="h31-0-37" class="d">-    open fun onActivityCreate() {}
</a><a href="#h31-0-38" id="h31-0-38" class="i">+    protected fun onNextActivityCreate(defer: Boolean = false, block: (Activity) -&gt; Unit) {
</a><a href="#h31-0-39" id="h31-0-39" class="i">+        if (defer) {
</a><a href="#h31-0-40" id="h31-0-40" class="i">+            registerNextActivityCallback {
</a><a href="#h31-0-41" id="h31-0-41" class="i">+                defer {
</a><a href="#h31-0-42" id="h31-0-42" class="i">+                    block(it)
</a><a href="#h31-0-43" id="h31-0-43" class="i">+                }
</a><a href="#h31-0-44" id="h31-0-44" class="i">+            }
</a><a href="#h31-0-45" id="h31-0-45" class="i">+            return
</a><a href="#h31-0-46" id="h31-0-46" class="i">+        }
</a><a href="#h31-0-47" id="h31-0-47" class="i">+        registerNextActivityCallback(block)
</a><a href="#h31-0-48" id="h31-0-48" class="i">+    }
</a> 
<a href="#h31-0-50" id="h31-0-50" class="i">+    open fun init() {}
</a> 
<a href="#h31-0-52" id="h31-0-52" class="d">-    /**
</a><a href="#h31-0-53" id="h31-0-53" class="d">-     * called on a dedicated thread when the Snapchat Activity is created
</a><a href="#h31-0-54" id="h31-0-54" class="d">-     */
</a><a href="#h31-0-55" id="h31-0-55" class="d">-    open fun asyncOnActivityCreate() {}
</a> 
     protected fun findClass(name: String): Class&lt;*&gt; {
         return context.androidContext.classLoader.loadClass(name)
<b>diff --git a/<a id="h32" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/FeatureManager.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/FeatureManager.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/FeatureManager.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/FeatureManager.kt</a></b>
<a href="#h32-0" id="h32-0" class="h">@@ -1,5 +1,6 @@
</a> package me.rhunk.snapenhance.core.features
 
<a href="#h32-0-2" id="h32-0-2" class="i">+import android.app.Activity
</a> import kotlinx.coroutines.Dispatchers
 import kotlinx.coroutines.launch
 import kotlinx.coroutines.runBlocking
<a href="#h32-1" id="h32-1" class="h">@@ -25,6 +26,7 @@ class FeatureManager(
</a>     private val context: ModContext
 ) {
     private val features = mutableMapOf&lt;KClass&lt;out Feature&gt;, Feature&gt;()
<a href="#h32-1-3" id="h32-1-3" class="i">+    private val onActivityCreateListeners = mutableListOf&lt;(Activity) -&gt; Unit&gt;()
</a> 
     private fun register(vararg featureList: Feature) {
         if (context.bridgeClient.getDebugProp(&quot;disable_feature_loading&quot;) == &quot;true&quot;) {
<a href="#h32-2" id="h32-2" class="h">@@ -37,11 +39,12 @@ class FeatureManager(
</a>                 launch(Dispatchers.IO) {
                     runCatching {
                         feature.context = context
<a href="#h32-2-3" id="h32-2-3" class="i">+                        feature.registerNextActivityCallback = { block -&gt; onActivityCreateListeners.add(block) }
</a>                         synchronized(features) {
                             features[feature::class] = feature
                         }
                     }.onFailure {
<a href="#h32-2-8" id="h32-2-8" class="d">-                        CoreLogger.xposedLog(&quot;Failed to register feature ${feature.featureKey}&quot;, it)
</a><a href="#h32-2-9" id="h32-2-9" class="i">+                        CoreLogger.xposedLog(&quot;Failed to register feature ${feature.key}&quot;, it)
</a>                     }
                 }
             }
<a href="#h32-3" id="h32-3" class="h">@@ -119,7 +122,7 @@ class FeatureManager(
</a>             AccountSwitcher(),
             RemoveGroupsLockedStatus(),
             BypassMessageActionRestrictions(),
<a href="#h32-3-3" id="h32-3-3" class="d">-            CustomizeUI(),
</a><a href="#h32-3-4" id="h32-3-4" class="i">+            CustomTheming(),
</a>             BetterLocation(),
             MediaFilePicker(),
             HideActiveMusic(),
<a href="#h32-4" id="h32-4" class="h">@@ -132,65 +135,35 @@ class FeatureManager(
</a>             DisableTelecomFramework(),
             BetterTranscript(),
         )
<a href="#h32-4-3" id="h32-4-3" class="d">-        initializeFeatures()
</a><a href="#h32-4-4" id="h32-4-4" class="d">-    }
</a><a href="#h32-4-5" id="h32-4-5" class="d">-
</a><a href="#h32-4-6" id="h32-4-6" class="d">-    private inline fun tryInit(feature: Feature, crossinline block: () -&gt; Unit) {
</a><a href="#h32-4-7" id="h32-4-7" class="d">-        runCatching {
</a><a href="#h32-4-8" id="h32-4-8" class="d">-            block()
</a><a href="#h32-4-9" id="h32-4-9" class="d">-        }.onFailure {
</a><a href="#h32-4-10" id="h32-4-10" class="d">-            context.log.error(&quot;Failed to init feature ${feature.featureKey}&quot;, it)
</a><a href="#h32-4-11" id="h32-4-11" class="d">-            context.longToast(&quot;Failed to init feature ${feature.featureKey}! Check logcat for more details.&quot;)
</a><a href="#h32-4-12" id="h32-4-12" class="d">-        }
</a><a href="#h32-4-13" id="h32-4-13" class="d">-    }
</a><a href="#h32-4-14" id="h32-4-14" class="d">-
</a><a href="#h32-4-15" id="h32-4-15" class="d">-    private fun initFeatures(
</a><a href="#h32-4-16" id="h32-4-16" class="d">-        syncParam: Int,
</a><a href="#h32-4-17" id="h32-4-17" class="d">-        asyncParam: Int,
</a><a href="#h32-4-18" id="h32-4-18" class="d">-        syncAction: (Feature) -&gt; Unit,
</a><a href="#h32-4-19" id="h32-4-19" class="d">-        asyncAction: (Feature) -&gt; Unit
</a><a href="#h32-4-20" id="h32-4-20" class="d">-    ) {
</a> 
         features.values.toList().forEach { feature -&gt;
<a href="#h32-4-23" id="h32-4-23" class="d">-            if (feature.loadParams and syncParam != 0) {
</a><a href="#h32-4-24" id="h32-4-24" class="d">-                tryInit(feature) {
</a><a href="#h32-4-25" id="h32-4-25" class="d">-                    syncAction(feature)
</a><a href="#h32-4-26" id="h32-4-26" class="i">+            runCatching {
</a><a href="#h32-4-27" id="h32-4-27" class="i">+                measureTimeMillis {
</a><a href="#h32-4-28" id="h32-4-28" class="i">+                    feature.init()
</a><a href="#h32-4-29" id="h32-4-29" class="i">+                }.also {
</a><a href="#h32-4-30" id="h32-4-30" class="i">+                    context.log.verbose(&quot;Feature ${feature.key} initialized in $it ms&quot;)
</a>                 }
<a href="#h32-4-32" id="h32-4-32" class="i">+            }.onFailure {
</a><a href="#h32-4-33" id="h32-4-33" class="i">+                context.log.error(&quot;Failed to init feature ${feature.key}&quot;, it)
</a><a href="#h32-4-34" id="h32-4-34" class="i">+                context.longToast(&quot;Failed to init feature ${feature.key}! Check logcat for more details.&quot;)
</a>             }
<a href="#h32-4-36" id="h32-4-36" class="d">-            if (feature.loadParams and asyncParam != 0) {
</a><a href="#h32-4-37" id="h32-4-37" class="d">-                context.coroutineScope.launch {
</a><a href="#h32-4-38" id="h32-4-38" class="d">-                    tryInit(feature) {
</a><a href="#h32-4-39" id="h32-4-39" class="d">-                        asyncAction(feature)
</a><a href="#h32-4-40" id="h32-4-40" class="d">-                    }
</a><a href="#h32-4-41" id="h32-4-41" class="d">-                }
</a><a href="#h32-4-42" id="h32-4-42" class="d">-            }
</a><a href="#h32-4-43" id="h32-4-43" class="d">-        }
</a><a href="#h32-4-44" id="h32-4-44" class="d">-    }
</a><a href="#h32-4-45" id="h32-4-45" class="d">-
</a><a href="#h32-4-46" id="h32-4-46" class="d">-    private fun initializeFeatures() {
</a><a href="#h32-4-47" id="h32-4-47" class="d">-        //TODO: async called when all features are initiated ?
</a><a href="#h32-4-48" id="h32-4-48" class="d">-        measureTimeMillis {
</a><a href="#h32-4-49" id="h32-4-49" class="d">-            initFeatures(
</a><a href="#h32-4-50" id="h32-4-50" class="d">-                FeatureLoadParams.INIT_SYNC,
</a><a href="#h32-4-51" id="h32-4-51" class="d">-                FeatureLoadParams.INIT_ASYNC,
</a><a href="#h32-4-52" id="h32-4-52" class="d">-                Feature::init,
</a><a href="#h32-4-53" id="h32-4-53" class="d">-                Feature::asyncInit
</a><a href="#h32-4-54" id="h32-4-54" class="d">-            )
</a><a href="#h32-4-55" id="h32-4-55" class="d">-        }.also {
</a><a href="#h32-4-56" id="h32-4-56" class="d">-            context.log.verbose(&quot;feature manager init took $it ms&quot;)
</a>         }
     }
 
<a href="#h32-4-60" id="h32-4-60" class="d">-    fun onActivityCreate() {
</a><a href="#h32-4-61" id="h32-4-61" class="d">-        measureTimeMillis {
</a><a href="#h32-4-62" id="h32-4-62" class="d">-            initFeatures(
</a><a href="#h32-4-63" id="h32-4-63" class="d">-                FeatureLoadParams.ACTIVITY_CREATE_SYNC,
</a><a href="#h32-4-64" id="h32-4-64" class="d">-                FeatureLoadParams.ACTIVITY_CREATE_ASYNC,
</a><a href="#h32-4-65" id="h32-4-65" class="d">-                Feature::onActivityCreate,
</a><a href="#h32-4-66" id="h32-4-66" class="d">-                Feature::asyncOnActivityCreate
</a><a href="#h32-4-67" id="h32-4-67" class="d">-            )
</a><a href="#h32-4-68" id="h32-4-68" class="d">-        }.also {
</a><a href="#h32-4-69" id="h32-4-69" class="d">-            context.log.verbose(&quot;feature manager onActivityCreate took $it ms&quot;)
</a><a href="#h32-4-70" id="h32-4-70" class="i">+    fun onActivityCreate(activity: Activity) {
</a><a href="#h32-4-71" id="h32-4-71" class="i">+        context.log.verbose(&quot;Activity created: ${activity.javaClass.simpleName}&quot;)
</a><a href="#h32-4-72" id="h32-4-72" class="i">+        onActivityCreateListeners.toList().also {
</a><a href="#h32-4-73" id="h32-4-73" class="i">+            onActivityCreateListeners.clear()
</a><a href="#h32-4-74" id="h32-4-74" class="i">+        }.forEach { activityListener -&gt;
</a><a href="#h32-4-75" id="h32-4-75" class="i">+            measureTimeMillis {
</a><a href="#h32-4-76" id="h32-4-76" class="i">+                runCatching {
</a><a href="#h32-4-77" id="h32-4-77" class="i">+                    activityListener(activity)
</a><a href="#h32-4-78" id="h32-4-78" class="i">+                }.onFailure {
</a><a href="#h32-4-79" id="h32-4-79" class="i">+                    context.log.error(&quot;Failed to run activity listener ${activityListener::class.simpleName}&quot;, it)
</a><a href="#h32-4-80" id="h32-4-80" class="i">+                }
</a><a href="#h32-4-81" id="h32-4-81" class="i">+            }.also {
</a><a href="#h32-4-82" id="h32-4-82" class="i">+                context.log.verbose(&quot;Activity listener ${activityListener::class.simpleName} executed in $it ms&quot;)
</a><a href="#h32-4-83" id="h32-4-83" class="i">+            }
</a>         }
     }
 }
<b>diff --git a/<a id="h33" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/MessagingRuleFeature.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/MessagingRuleFeature.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/MessagingRuleFeature.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/MessagingRuleFeature.kt</a></b>
<a href="#h33-0" id="h33-0" class="h">@@ -3,7 +3,7 @@ package me.rhunk.snapenhance.core.features
</a> import me.rhunk.snapenhance.common.data.MessagingRuleType
 import me.rhunk.snapenhance.common.data.RuleState
 
<a href="#h33-0-3" id="h33-0-3" class="d">-abstract class MessagingRuleFeature(name: String, val ruleType: MessagingRuleType, loadParams: Int = 0) : Feature(name, loadParams) {
</a><a href="#h33-0-4" id="h33-0-4" class="i">+abstract class MessagingRuleFeature(name: String, val ruleType: MessagingRuleType) : Feature(name) {
</a>     private val listeners = mutableListOf&lt;(String, Boolean) -&gt; Unit&gt;()
 
     fun addStateListener(listener: (conversationId: String, newState: Boolean) -&gt; Unit) {
<b>diff --git a/<a id="h34" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/COFOverride.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/COFOverride.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/COFOverride.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/COFOverride.kt</a></b>
<a href="#h34-0" id="h34-0" class="h">@@ -1,7 +1,7 @@
</a> package me.rhunk.snapenhance.core.features.impl
 
 import me.rhunk.snapenhance.core.features.Feature
<a href="#h34-0-3" id="h34-0-3" class="d">-import me.rhunk.snapenhance.core.features.FeatureLoadParams
</a><a href="#h34-0-4" id="h34-0-4" class="i">+
</a> import me.rhunk.snapenhance.core.util.dataBuilder
 import me.rhunk.snapenhance.core.util.hook.HookStage
 import me.rhunk.snapenhance.core.util.hook.hook
<a href="#h34-1" id="h34-1" class="h">@@ -9,7 +9,7 @@ import me.rhunk.snapenhance.core.util.ktx.getObjectField
</a> import me.rhunk.snapenhance.mapper.impl.COFObservableMapper
 import java.lang.reflect.Method
 
<a href="#h34-1-3" id="h34-1-3" class="d">-class COFOverride : Feature(&quot;COF Override&quot;, loadParams = FeatureLoadParams.INIT_SYNC) {
</a><a href="#h34-1-4" id="h34-1-4" class="i">+class COFOverride : Feature(&quot;COF Override&quot;) {
</a>     var hasActionMenuV2 = false
 
     override fun init() {
<b>diff --git a/<a id="h35" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/ConfigurationOverride.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/ConfigurationOverride.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/ConfigurationOverride.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/ConfigurationOverride.kt</a></b>
<a href="#h35-0" id="h35-0" class="h">@@ -2,7 +2,7 @@ package me.rhunk.snapenhance.core.features.impl
</a> 
 import de.robv.android.xposed.XposedHelpers
 import me.rhunk.snapenhance.core.features.Feature
<a href="#h35-0-3" id="h35-0-3" class="d">-import me.rhunk.snapenhance.core.features.FeatureLoadParams
</a><a href="#h35-0-4" id="h35-0-4" class="i">+
</a> import me.rhunk.snapenhance.core.util.hook.HookStage
 import me.rhunk.snapenhance.core.util.hook.Hooker
 import me.rhunk.snapenhance.core.util.hook.hook
<a href="#h35-1" id="h35-1" class="h">@@ -22,7 +22,7 @@ data class ConfigFilter(
</a>     val isAppExperiment: Boolean?
 )
 
<a href="#h35-1-3" id="h35-1-3" class="d">-class ConfigurationOverride : Feature(&quot;Configuration Override&quot;, loadParams = FeatureLoadParams.INIT_SYNC) {
</a><a href="#h35-1-4" id="h35-1-4" class="i">+class ConfigurationOverride : Feature(&quot;Configuration Override&quot;) {
</a>     override fun init() {
         context.mappings.useMapper(CompositeConfigurationProviderMapper::class) {
             fun getConfigKeyInfo(key: Any?) = runCatching {
<b>diff --git a/<a id="h36" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/FriendMutationObserver.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/FriendMutationObserver.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/FriendMutationObserver.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/FriendMutationObserver.kt</a></b>
<a href="#h36-0" id="h36-0" class="h">@@ -10,12 +10,12 @@ import me.rhunk.snapenhance.common.data.FriendLinkType
</a> import me.rhunk.snapenhance.common.database.impl.FriendInfo
 import me.rhunk.snapenhance.core.event.events.impl.NetworkApiRequestEvent
 import me.rhunk.snapenhance.core.features.Feature
<a href="#h36-0-3" id="h36-0-3" class="d">-import me.rhunk.snapenhance.core.features.FeatureLoadParams
</a><a href="#h36-0-4" id="h36-0-4" class="i">+
</a> import me.rhunk.snapenhance.core.util.EvictingMap
 import java.io.InputStreamReader
 import java.util.Calendar
 
<a href="#h36-0-9" id="h36-0-9" class="d">-class FriendMutationObserver: Feature(&quot;FriendMutationObserver&quot;, loadParams = FeatureLoadParams.INIT_SYNC) {
</a><a href="#h36-0-10" id="h36-0-10" class="i">+class FriendMutationObserver: Feature(&quot;FriendMutationObserver&quot;) {
</a>     private val translation by lazy { context.translation.getCategory(&quot;friend_mutation_observer&quot;) }
     private val addSourceCache = EvictingMap&lt;String, String&gt;(500)
 
<b>diff --git a/<a id="h37" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/MixerStories.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/MixerStories.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/MixerStories.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/MixerStories.kt</a></b>
<a href="#h37-0" id="h37-0" class="h">@@ -7,13 +7,13 @@ import me.rhunk.snapenhance.common.data.StoryData
</a> import me.rhunk.snapenhance.common.util.protobuf.ProtoEditor
 import me.rhunk.snapenhance.core.event.events.impl.NetworkApiRequestEvent
 import me.rhunk.snapenhance.core.features.Feature
<a href="#h37-0-3" id="h37-0-3" class="d">-import me.rhunk.snapenhance.core.features.FeatureLoadParams
</a><a href="#h37-0-4" id="h37-0-4" class="i">+
</a> import java.nio.ByteBuffer
 import kotlin.coroutines.suspendCoroutine
 import kotlin.io.encoding.Base64
 import kotlin.io.encoding.ExperimentalEncodingApi
 
<a href="#h37-0-10" id="h37-0-10" class="d">-class MixerStories : Feature(&quot;MixerStories&quot;, loadParams = FeatureLoadParams.INIT_SYNC) {
</a><a href="#h37-0-11" id="h37-0-11" class="i">+class MixerStories : Feature(&quot;MixerStories&quot;) {
</a>     @OptIn(ExperimentalEncodingApi::class)
     override fun init() {
         val disableDiscoverSections by context.config.global.disableStorySections
<b>diff --git a/<a id="h38" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/OperaViewerParamsOverride.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/OperaViewerParamsOverride.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/OperaViewerParamsOverride.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/OperaViewerParamsOverride.kt</a></b>
<a href="#h38-0" id="h38-0" class="h">@@ -1,12 +1,11 @@
</a> package me.rhunk.snapenhance.core.features.impl
 
 import me.rhunk.snapenhance.core.features.Feature
<a href="#h38-0-3" id="h38-0-3" class="d">-import me.rhunk.snapenhance.core.features.FeatureLoadParams
</a> import me.rhunk.snapenhance.core.util.hook.HookStage
 import me.rhunk.snapenhance.core.util.hook.hook
 import me.rhunk.snapenhance.mapper.impl.OperaViewerParamsMapper
 
<a href="#h38-0-8" id="h38-0-8" class="d">-class OperaViewerParamsOverride : Feature(&quot;OperaViewerParamsOverride&quot;, loadParams = FeatureLoadParams.ACTIVITY_CREATE_SYNC) {
</a><a href="#h38-0-9" id="h38-0-9" class="i">+class OperaViewerParamsOverride : Feature(&quot;OperaViewerParamsOverride&quot;) {
</a>     var currentPlaybackRate = 1.0F
 
     data class OverrideKey(
<a href="#h38-1" id="h38-1" class="h">@@ -19,7 +18,7 @@ class OperaViewerParamsOverride : Feature(&quot;OperaViewerParamsOverride&quot;, loadParam
</a>         val value: (key: OverrideKey, value: Any?) -&gt; Any?
     )
 
<a href="#h38-1-3" id="h38-1-3" class="d">-    override fun onActivityCreate() {
</a><a href="#h38-1-4" id="h38-1-4" class="i">+    override fun init() {
</a>         val overrideMap = mutableMapOf&lt;String, Override&gt;()
 
         fun overrideParam(key: String, filter: (value: Any?) -&gt; Boolean, value: (overrideKey: OverrideKey, value: Any?) -&gt; Any?) {
<a href="#h38-2" id="h38-2" class="h">@@ -44,37 +43,39 @@ class OperaViewerParamsOverride : Feature(&quot;OperaViewerParamsOverride&quot;, loadParam
</a>             })
         }
 
<a href="#h38-2-3" id="h38-2-3" class="d">-        context.mappings.useMapper(OperaViewerParamsMapper::class) {
</a><a href="#h38-2-4" id="h38-2-4" class="d">-            fun overrideParamResult(paramKey: Any, value: Any?): Any? {
</a><a href="#h38-2-5" id="h38-2-5" class="d">-                val fields = paramKey::class.java.fields
</a><a href="#h38-2-6" id="h38-2-6" class="d">-                val key = OverrideKey(
</a><a href="#h38-2-7" id="h38-2-7" class="d">-                    name = fields.firstOrNull {
</a><a href="#h38-2-8" id="h38-2-8" class="d">-                        it.type == String::class.java
</a><a href="#h38-2-9" id="h38-2-9" class="d">-                    }?.get(paramKey)?.toString() ?: return value,
</a><a href="#h38-2-10" id="h38-2-10" class="d">-                    defaultValue = fields.firstOrNull {
</a><a href="#h38-2-11" id="h38-2-11" class="d">-                        it.type == Object::class.java
</a><a href="#h38-2-12" id="h38-2-12" class="d">-                    }?.get(paramKey)
</a><a href="#h38-2-13" id="h38-2-13" class="d">-                )
</a><a href="#h38-2-14" id="h38-2-14" class="i">+        onNextActivityCreate {
</a><a href="#h38-2-15" id="h38-2-15" class="i">+            context.mappings.useMapper(OperaViewerParamsMapper::class) {
</a><a href="#h38-2-16" id="h38-2-16" class="i">+                fun overrideParamResult(paramKey: Any, value: Any?): Any? {
</a><a href="#h38-2-17" id="h38-2-17" class="i">+                    val fields = paramKey::class.java.fields
</a><a href="#h38-2-18" id="h38-2-18" class="i">+                    val key = OverrideKey(
</a><a href="#h38-2-19" id="h38-2-19" class="i">+                        name = fields.firstOrNull {
</a><a href="#h38-2-20" id="h38-2-20" class="i">+                            it.type == String::class.java
</a><a href="#h38-2-21" id="h38-2-21" class="i">+                        }?.get(paramKey)?.toString() ?: return value,
</a><a href="#h38-2-22" id="h38-2-22" class="i">+                        defaultValue = fields.firstOrNull {
</a><a href="#h38-2-23" id="h38-2-23" class="i">+                            it.type == Object::class.java
</a><a href="#h38-2-24" id="h38-2-24" class="i">+                        }?.get(paramKey)
</a><a href="#h38-2-25" id="h38-2-25" class="i">+                    )
</a> 
<a href="#h38-2-27" id="h38-2-27" class="d">-                overrideMap[key.name]?.let { override -&gt;
</a><a href="#h38-2-28" id="h38-2-28" class="d">-                    if (override.filter(value)) {
</a><a href="#h38-2-29" id="h38-2-29" class="d">-                        runCatching {
</a><a href="#h38-2-30" id="h38-2-30" class="d">-                            return override.value(key, value)
</a><a href="#h38-2-31" id="h38-2-31" class="d">-                        }.onFailure {
</a><a href="#h38-2-32" id="h38-2-32" class="d">-                            context.log.error(&quot;Failed to override param $key&quot;, it)
</a><a href="#h38-2-33" id="h38-2-33" class="i">+                    overrideMap[key.name]?.let { override -&gt;
</a><a href="#h38-2-34" id="h38-2-34" class="i">+                        if (override.filter(value)) {
</a><a href="#h38-2-35" id="h38-2-35" class="i">+                            runCatching {
</a><a href="#h38-2-36" id="h38-2-36" class="i">+                                return override.value(key, value)
</a><a href="#h38-2-37" id="h38-2-37" class="i">+                            }.onFailure {
</a><a href="#h38-2-38" id="h38-2-38" class="i">+                                context.log.error(&quot;Failed to override param $key&quot;, it)
</a><a href="#h38-2-39" id="h38-2-39" class="i">+                            }
</a>                         }
                     }
<a href="#h38-2-42" id="h38-2-42" class="d">-                }
</a> 
<a href="#h38-2-44" id="h38-2-44" class="d">-                return value
</a><a href="#h38-2-45" id="h38-2-45" class="d">-            }
</a><a href="#h38-2-46" id="h38-2-46" class="i">+                    return value
</a><a href="#h38-2-47" id="h38-2-47" class="i">+                }
</a> 
<a href="#h38-2-49" id="h38-2-49" class="d">-            classReference.get()?.hook(getMethod.get()!!, HookStage.AFTER) { param -&gt;
</a><a href="#h38-2-50" id="h38-2-50" class="d">-                param.setResult(overrideParamResult(param.arg(0), param.getResult()))
</a><a href="#h38-2-51" id="h38-2-51" class="d">-            }
</a><a href="#h38-2-52" id="h38-2-52" class="i">+                classReference.get()?.hook(getMethod.get()!!, HookStage.AFTER) { param -&gt;
</a><a href="#h38-2-53" id="h38-2-53" class="i">+                    param.setResult(overrideParamResult(param.arg(0), param.getResult()))
</a><a href="#h38-2-54" id="h38-2-54" class="i">+                }
</a> 
<a href="#h38-2-56" id="h38-2-56" class="d">-            classReference.get()?.hook(getOrDefaultMethod.get()!!, HookStage.AFTER) { param -&gt;
</a><a href="#h38-2-57" id="h38-2-57" class="d">-                param.setResult(overrideParamResult(param.arg(0), param.getResult()))
</a><a href="#h38-2-58" id="h38-2-58" class="i">+                classReference.get()?.hook(getOrDefaultMethod.get()!!, HookStage.AFTER) { param -&gt;
</a><a href="#h38-2-59" id="h38-2-59" class="i">+                    param.setResult(overrideParamResult(param.arg(0), param.getResult()))
</a><a href="#h38-2-60" id="h38-2-60" class="i">+                }
</a>             }
         }
     }
<b>diff --git a/<a id="h39" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/ScopeSync.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/ScopeSync.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/ScopeSync.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/ScopeSync.kt</a></b>
<a href="#h39-0" id="h39-0" class="h">@@ -7,9 +7,8 @@ import me.rhunk.snapenhance.common.data.ContentType
</a> import me.rhunk.snapenhance.common.data.SocialScope
 import me.rhunk.snapenhance.core.event.events.impl.SendMessageWithContentEvent
 import me.rhunk.snapenhance.core.features.Feature
<a href="#h39-0-3" id="h39-0-3" class="d">-import me.rhunk.snapenhance.core.features.FeatureLoadParams
</a> 
<a href="#h39-0-5" id="h39-0-5" class="d">-class ScopeSync : Feature(&quot;Scope Sync&quot;, loadParams = FeatureLoadParams.INIT_SYNC) {
</a><a href="#h39-0-6" id="h39-0-6" class="i">+class ScopeSync : Feature(&quot;Scope Sync&quot;) {
</a>     companion object {
         private const val DELAY_BEFORE_SYNC = 2000L
     }
<b>diff --git a/<a id="h40" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/downloader/MediaDownloader.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/downloader/MediaDownloader.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/downloader/MediaDownloader.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/downloader/MediaDownloader.kt</a></b>
<a href="#h40-0" id="h40-0" class="h">@@ -31,7 +31,6 @@ import me.rhunk.snapenhance.common.util.snap.MediaDownloaderHelper
</a> import me.rhunk.snapenhance.common.util.snap.RemoteMediaResolver
 import me.rhunk.snapenhance.core.DownloadManagerClient
 import me.rhunk.snapenhance.core.SnapEnhance
<a href="#h40-0-3" id="h40-0-3" class="d">-import me.rhunk.snapenhance.core.features.FeatureLoadParams
</a> import me.rhunk.snapenhance.core.features.MessagingRuleFeature
 import me.rhunk.snapenhance.core.features.impl.downloader.decoder.DecodedAttachment
 import me.rhunk.snapenhance.core.features.impl.downloader.decoder.MessageDecoder
<a href="#h40-1" id="h40-1" class="h">@@ -64,8 +63,7 @@ class SnapChapterInfo(
</a> )
 
 
<a href="#h40-1-3" id="h40-1-3" class="d">-@OptIn(ExperimentalEncodingApi::class)
</a><a href="#h40-1-4" id="h40-1-4" class="d">-class MediaDownloader : MessagingRuleFeature(&quot;MediaDownloader&quot;, MessagingRuleType.AUTO_DOWNLOAD, loadParams = FeatureLoadParams.ACTIVITY_CREATE_ASYNC) {
</a><a href="#h40-1-5" id="h40-1-5" class="i">+class MediaDownloader : MessagingRuleFeature(&quot;MediaDownloader&quot;, MessagingRuleType.AUTO_DOWNLOAD) {
</a>     private var lastSeenMediaInfoMap: MutableMap&lt;SplitMediaAssetType, MediaInfo&gt;? = null
     var lastSeenMapParams: ParamMap? = null
         private set
<a href="#h40-2" id="h40-2" class="h">@@ -487,50 +485,52 @@ class MediaDownloader : MessagingRuleFeature(&quot;MediaDownloader&quot;, MessagingRuleTyp
</a>         return options.any { keyFilter == null || it.contains(keyFilter, true) }
     }
 
<a href="#h40-2-3" id="h40-2-3" class="d">-    override fun asyncOnActivityCreate() {
</a><a href="#h40-2-4" id="h40-2-4" class="d">-        context.mappings.useMapper(OperaPageViewControllerMapper::class) {
</a><a href="#h40-2-5" id="h40-2-5" class="d">-            val onOperaViewStateCallback: (HookAdapter) -&gt; Unit = onOperaViewStateCallback@{ param -&gt;
</a><a href="#h40-2-6" id="h40-2-6" class="d">-                val viewState = (param.thisObject() as Any).getObjectField(viewStateField.get()!!).toString()
</a><a href="#h40-2-7" id="h40-2-7" class="d">-                if (viewState != &quot;FULLY_DISPLAYED&quot;) {
</a><a href="#h40-2-8" id="h40-2-8" class="d">-                    return@onOperaViewStateCallback
</a><a href="#h40-2-9" id="h40-2-9" class="d">-                }
</a><a href="#h40-2-10" id="h40-2-10" class="d">-                val operaLayerList = (param.thisObject() as Any).getObjectField(layerListField.get()!!) as ArrayList&lt;*&gt;
</a><a href="#h40-2-11" id="h40-2-11" class="d">-                val mediaParamMap: ParamMap = operaLayerList.map { Layer(it) }.first().paramMap
</a><a href="#h40-2-12" id="h40-2-12" class="i">+    override fun init() {
</a><a href="#h40-2-13" id="h40-2-13" class="i">+        onNextActivityCreate {
</a><a href="#h40-2-14" id="h40-2-14" class="i">+            context.mappings.useMapper(OperaPageViewControllerMapper::class) {
</a><a href="#h40-2-15" id="h40-2-15" class="i">+                val onOperaViewStateCallback: (HookAdapter) -&gt; Unit = onOperaViewStateCallback@{ param -&gt;
</a><a href="#h40-2-16" id="h40-2-16" class="i">+                    val viewState = (param.thisObject() as Any).getObjectField(viewStateField.get()!!).toString()
</a><a href="#h40-2-17" id="h40-2-17" class="i">+                    if (viewState != &quot;FULLY_DISPLAYED&quot;) {
</a><a href="#h40-2-18" id="h40-2-18" class="i">+                        return@onOperaViewStateCallback
</a><a href="#h40-2-19" id="h40-2-19" class="i">+                    }
</a><a href="#h40-2-20" id="h40-2-20" class="i">+                    val operaLayerList = (param.thisObject() as Any).getObjectField(layerListField.get()!!) as ArrayList&lt;*&gt;
</a><a href="#h40-2-21" id="h40-2-21" class="i">+                    val mediaParamMap: ParamMap = operaLayerList.map { Layer(it) }.first().paramMap
</a> 
<a href="#h40-2-23" id="h40-2-23" class="d">-                if (!mediaParamMap.containsKey(&quot;image_media_info&quot;) &amp;&amp; !mediaParamMap.containsKey(&quot;video_media_info_list&quot;))
</a><a href="#h40-2-24" id="h40-2-24" class="d">-                    return@onOperaViewStateCallback
</a><a href="#h40-2-25" id="h40-2-25" class="i">+                    if (!mediaParamMap.containsKey(&quot;image_media_info&quot;) &amp;&amp; !mediaParamMap.containsKey(&quot;video_media_info_list&quot;))
</a><a href="#h40-2-26" id="h40-2-26" class="i">+                        return@onOperaViewStateCallback
</a> 
<a href="#h40-2-28" id="h40-2-28" class="d">-                val mediaInfoMap = mutableMapOf&lt;SplitMediaAssetType, MediaInfo&gt;()
</a><a href="#h40-2-29" id="h40-2-29" class="d">-                val isVideo = mediaParamMap.containsKey(&quot;video_media_info_list&quot;)
</a><a href="#h40-2-30" id="h40-2-30" class="i">+                    val mediaInfoMap = mutableMapOf&lt;SplitMediaAssetType, MediaInfo&gt;()
</a><a href="#h40-2-31" id="h40-2-31" class="i">+                    val isVideo = mediaParamMap.containsKey(&quot;video_media_info_list&quot;)
</a> 
<a href="#h40-2-33" id="h40-2-33" class="d">-                mediaInfoMap[SplitMediaAssetType.ORIGINAL] = MediaInfo(
</a><a href="#h40-2-34" id="h40-2-34" class="d">-                    (if (isVideo) mediaParamMap[&quot;video_media_info_list&quot;] else mediaParamMap[&quot;image_media_info&quot;])!!
</a><a href="#h40-2-35" id="h40-2-35" class="d">-                )
</a><a href="#h40-2-36" id="h40-2-36" class="i">+                    mediaInfoMap[SplitMediaAssetType.ORIGINAL] = MediaInfo(
</a><a href="#h40-2-37" id="h40-2-37" class="i">+                        (if (isVideo) mediaParamMap[&quot;video_media_info_list&quot;] else mediaParamMap[&quot;image_media_info&quot;])!!
</a><a href="#h40-2-38" id="h40-2-38" class="i">+                    )
</a> 
<a href="#h40-2-40" id="h40-2-40" class="d">-                if (context.config.downloader.mergeOverlays.get() &amp;&amp; mediaParamMap.containsKey(&quot;overlay_image_media_info&quot;)) {
</a><a href="#h40-2-41" id="h40-2-41" class="d">-                    mediaInfoMap[SplitMediaAssetType.OVERLAY] =
</a><a href="#h40-2-42" id="h40-2-42" class="d">-                        MediaInfo(mediaParamMap[&quot;overlay_image_media_info&quot;]!!)
</a><a href="#h40-2-43" id="h40-2-43" class="d">-                }
</a><a href="#h40-2-44" id="h40-2-44" class="d">-                lastSeenMapParams = mediaParamMap
</a><a href="#h40-2-45" id="h40-2-45" class="d">-                lastSeenMediaInfoMap = mediaInfoMap
</a><a href="#h40-2-46" id="h40-2-46" class="i">+                    if (context.config.downloader.mergeOverlays.get() &amp;&amp; mediaParamMap.containsKey(&quot;overlay_image_media_info&quot;)) {
</a><a href="#h40-2-47" id="h40-2-47" class="i">+                        mediaInfoMap[SplitMediaAssetType.OVERLAY] =
</a><a href="#h40-2-48" id="h40-2-48" class="i">+                            MediaInfo(mediaParamMap[&quot;overlay_image_media_info&quot;]!!)
</a><a href="#h40-2-49" id="h40-2-49" class="i">+                    }
</a><a href="#h40-2-50" id="h40-2-50" class="i">+                    lastSeenMapParams = mediaParamMap
</a><a href="#h40-2-51" id="h40-2-51" class="i">+                    lastSeenMediaInfoMap = mediaInfoMap
</a> 
<a href="#h40-2-53" id="h40-2-53" class="d">-                if (!canAutoDownload()) return@onOperaViewStateCallback
</a><a href="#h40-2-54" id="h40-2-54" class="i">+                    if (!canAutoDownload()) return@onOperaViewStateCallback
</a> 
<a href="#h40-2-56" id="h40-2-56" class="d">-                context.executeAsync {
</a><a href="#h40-2-57" id="h40-2-57" class="d">-                    runCatching {
</a><a href="#h40-2-58" id="h40-2-58" class="d">-                        handleOperaMedia(mediaParamMap, mediaInfoMap, false)
</a><a href="#h40-2-59" id="h40-2-59" class="d">-                    }.onFailure {
</a><a href="#h40-2-60" id="h40-2-60" class="d">-                        context.log.error(&quot;Failed to handle opera media&quot;, it)
</a><a href="#h40-2-61" id="h40-2-61" class="d">-                        context.longToast(it.message)
</a><a href="#h40-2-62" id="h40-2-62" class="i">+                    context.executeAsync {
</a><a href="#h40-2-63" id="h40-2-63" class="i">+                        runCatching {
</a><a href="#h40-2-64" id="h40-2-64" class="i">+                            handleOperaMedia(mediaParamMap, mediaInfoMap, false)
</a><a href="#h40-2-65" id="h40-2-65" class="i">+                        }.onFailure {
</a><a href="#h40-2-66" id="h40-2-66" class="i">+                            context.log.error(&quot;Failed to handle opera media&quot;, it)
</a><a href="#h40-2-67" id="h40-2-67" class="i">+                            context.longToast(it.message)
</a><a href="#h40-2-68" id="h40-2-68" class="i">+                        }
</a>                     }
                 }
<a href="#h40-2-71" id="h40-2-71" class="d">-            }
</a> 
<a href="#h40-2-73" id="h40-2-73" class="d">-            arrayOf(onDisplayStateChange, onDisplayStateChangeGesture).forEach { methodName -&gt;
</a><a href="#h40-2-74" id="h40-2-74" class="d">-                classReference.get()?.hook(
</a><a href="#h40-2-75" id="h40-2-75" class="d">-                    methodName.get() ?: return@forEach,
</a><a href="#h40-2-76" id="h40-2-76" class="d">-                    HookStage.AFTER, onOperaViewStateCallback
</a><a href="#h40-2-77" id="h40-2-77" class="d">-                )
</a><a href="#h40-2-78" id="h40-2-78" class="i">+                arrayOf(onDisplayStateChange, onDisplayStateChangeGesture).forEach { methodName -&gt;
</a><a href="#h40-2-79" id="h40-2-79" class="i">+                    classReference.get()?.hook(
</a><a href="#h40-2-80" id="h40-2-80" class="i">+                        methodName.get() ?: return@forEach,
</a><a href="#h40-2-81" id="h40-2-81" class="i">+                        HookStage.AFTER, onOperaViewStateCallback
</a><a href="#h40-2-82" id="h40-2-82" class="i">+                    )
</a><a href="#h40-2-83" id="h40-2-83" class="i">+                }
</a>             }
         }
     }
<b>diff --git a/<a id="h41" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/downloader/ProfilePictureDownloader.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/downloader/ProfilePictureDownloader.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/downloader/ProfilePictureDownloader.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/downloader/ProfilePictureDownloader.kt</a></b>
<a href="#h41-0" id="h41-0" class="h">@@ -7,61 +7,62 @@ import me.rhunk.snapenhance.common.util.protobuf.ProtoReader
</a> import me.rhunk.snapenhance.core.event.events.impl.AddViewEvent
 import me.rhunk.snapenhance.core.event.events.impl.NetworkApiRequestEvent
 import me.rhunk.snapenhance.core.features.Feature
<a href="#h41-0-3" id="h41-0-3" class="d">-import me.rhunk.snapenhance.core.features.FeatureLoadParams
</a> import me.rhunk.snapenhance.core.ui.ViewAppearanceHelper
 
<a href="#h41-0-6" id="h41-0-6" class="d">-class ProfilePictureDownloader : Feature(&quot;ProfilePictureDownloader&quot;, loadParams = FeatureLoadParams.ACTIVITY_CREATE_ASYNC) {
</a><a href="#h41-0-7" id="h41-0-7" class="i">+class ProfilePictureDownloader : Feature(&quot;ProfilePictureDownloader&quot;) {
</a>     @SuppressLint(&quot;SetTextI18n&quot;)
<a href="#h41-0-9" id="h41-0-9" class="d">-    override fun asyncOnActivityCreate() {
</a><a href="#h41-0-10" id="h41-0-10" class="i">+    override fun init() {
</a>         if (!context.config.downloader.downloadProfilePictures.get()) return
 
         var friendUsername: String? = null
         var backgroundUrl: String? = null
         var avatarUrl: String? = null
 
<a href="#h41-0-17" id="h41-0-17" class="d">-        context.event.subscribe(AddViewEvent::class) { event -&gt;
</a><a href="#h41-0-18" id="h41-0-18" class="d">-            if (event.view::class.java.name != &quot;com.snap.unifiedpublicprofile.UnifiedPublicProfileView&quot;) return@subscribe
</a><a href="#h41-0-19" id="h41-0-19" class="i">+        onNextActivityCreate(defer = true) {
</a><a href="#h41-0-20" id="h41-0-20" class="i">+            context.event.subscribe(AddViewEvent::class) { event -&gt;
</a><a href="#h41-0-21" id="h41-0-21" class="i">+                if (event.view::class.java.name != &quot;com.snap.unifiedpublicprofile.UnifiedPublicProfileView&quot;) return@subscribe
</a> 
<a href="#h41-0-23" id="h41-0-23" class="d">-            event.parent.addView(Button(event.parent.context).apply {
</a><a href="#h41-0-24" id="h41-0-24" class="d">-                text = this@ProfilePictureDownloader.context.translation[&quot;profile_picture_downloader.button&quot;]
</a><a href="#h41-0-25" id="h41-0-25" class="d">-                layoutParams = RelativeLayout.LayoutParams(RelativeLayout.LayoutParams.WRAP_CONTENT, RelativeLayout.LayoutParams.WRAP_CONTENT).apply {
</a><a href="#h41-0-26" id="h41-0-26" class="d">-                    setMargins(0, 200, 0, 0)
</a><a href="#h41-0-27" id="h41-0-27" class="d">-                }
</a><a href="#h41-0-28" id="h41-0-28" class="d">-                setOnClickListener {
</a><a href="#h41-0-29" id="h41-0-29" class="d">-                    ViewAppearanceHelper.newAlertDialogBuilder(
</a><a href="#h41-0-30" id="h41-0-30" class="d">-                        this@ProfilePictureDownloader.context.mainActivity!!
</a><a href="#h41-0-31" id="h41-0-31" class="d">-                    ).apply {
</a><a href="#h41-0-32" id="h41-0-32" class="d">-                        setTitle(this@ProfilePictureDownloader.context.translation[&quot;profile_picture_downloader.title&quot;])
</a><a href="#h41-0-33" id="h41-0-33" class="d">-                        val choices = mutableMapOf&lt;String, String&gt;()
</a><a href="#h41-0-34" id="h41-0-34" class="d">-                        backgroundUrl?.let { choices[&quot;background_option&quot;] = it }
</a><a href="#h41-0-35" id="h41-0-35" class="d">-                        avatarUrl?.let { choices[&quot;avatar_option&quot;] = it }
</a><a href="#h41-0-36" id="h41-0-36" class="i">+                event.parent.addView(Button(event.parent.context).apply {
</a><a href="#h41-0-37" id="h41-0-37" class="i">+                    text = this@ProfilePictureDownloader.context.translation[&quot;profile_picture_downloader.button&quot;]
</a><a href="#h41-0-38" id="h41-0-38" class="i">+                    layoutParams = RelativeLayout.LayoutParams(RelativeLayout.LayoutParams.WRAP_CONTENT, RelativeLayout.LayoutParams.WRAP_CONTENT).apply {
</a><a href="#h41-0-39" id="h41-0-39" class="i">+                        setMargins(0, 200, 0, 0)
</a><a href="#h41-0-40" id="h41-0-40" class="i">+                    }
</a><a href="#h41-0-41" id="h41-0-41" class="i">+                    setOnClickListener {
</a><a href="#h41-0-42" id="h41-0-42" class="i">+                        ViewAppearanceHelper.newAlertDialogBuilder(
</a><a href="#h41-0-43" id="h41-0-43" class="i">+                            this@ProfilePictureDownloader.context.mainActivity!!
</a><a href="#h41-0-44" id="h41-0-44" class="i">+                        ).apply {
</a><a href="#h41-0-45" id="h41-0-45" class="i">+                            setTitle(this@ProfilePictureDownloader.context.translation[&quot;profile_picture_downloader.title&quot;])
</a><a href="#h41-0-46" id="h41-0-46" class="i">+                            val choices = mutableMapOf&lt;String, String&gt;()
</a><a href="#h41-0-47" id="h41-0-47" class="i">+                            backgroundUrl?.let { choices[&quot;background_option&quot;] = it }
</a><a href="#h41-0-48" id="h41-0-48" class="i">+                            avatarUrl?.let { choices[&quot;avatar_option&quot;] = it }
</a> 
<a href="#h41-0-50" id="h41-0-50" class="d">-                        setItems(choices.keys.map {
</a><a href="#h41-0-51" id="h41-0-51" class="d">-                            this@ProfilePictureDownloader.context.translation[&quot;profile_picture_downloader.$it&quot;]
</a><a href="#h41-0-52" id="h41-0-52" class="d">-                        }.toTypedArray()) { _, which -&gt;
</a><a href="#h41-0-53" id="h41-0-53" class="d">-                            runCatching {
</a><a href="#h41-0-54" id="h41-0-54" class="d">-                                this@ProfilePictureDownloader.context.feature(MediaDownloader::class).downloadProfilePicture(
</a><a href="#h41-0-55" id="h41-0-55" class="d">-                                    choices.values.elementAt(which),
</a><a href="#h41-0-56" id="h41-0-56" class="d">-                                    friendUsername!!
</a><a href="#h41-0-57" id="h41-0-57" class="d">-                                )
</a><a href="#h41-0-58" id="h41-0-58" class="d">-                            }.onFailure {
</a><a href="#h41-0-59" id="h41-0-59" class="d">-                                this@ProfilePictureDownloader.context.log.error(&quot;Failed to download profile picture&quot;, it)
</a><a href="#h41-0-60" id="h41-0-60" class="i">+                            setItems(choices.keys.map {
</a><a href="#h41-0-61" id="h41-0-61" class="i">+                                this@ProfilePictureDownloader.context.translation[&quot;profile_picture_downloader.$it&quot;]
</a><a href="#h41-0-62" id="h41-0-62" class="i">+                            }.toTypedArray()) { _, which -&gt;
</a><a href="#h41-0-63" id="h41-0-63" class="i">+                                runCatching {
</a><a href="#h41-0-64" id="h41-0-64" class="i">+                                    this@ProfilePictureDownloader.context.feature(MediaDownloader::class).downloadProfilePicture(
</a><a href="#h41-0-65" id="h41-0-65" class="i">+                                        choices.values.elementAt(which),
</a><a href="#h41-0-66" id="h41-0-66" class="i">+                                        friendUsername!!
</a><a href="#h41-0-67" id="h41-0-67" class="i">+                                    )
</a><a href="#h41-0-68" id="h41-0-68" class="i">+                                }.onFailure {
</a><a href="#h41-0-69" id="h41-0-69" class="i">+                                    this@ProfilePictureDownloader.context.log.error(&quot;Failed to download profile picture&quot;, it)
</a><a href="#h41-0-70" id="h41-0-70" class="i">+                                }
</a>                             }
<a href="#h41-0-72" id="h41-0-72" class="d">-                        }
</a><a href="#h41-0-73" id="h41-0-73" class="d">-                    }.show()
</a><a href="#h41-0-74" id="h41-0-74" class="d">-                }
</a><a href="#h41-0-75" id="h41-0-75" class="d">-            })
</a><a href="#h41-0-76" id="h41-0-76" class="d">-        }
</a><a href="#h41-0-77" id="h41-0-77" class="i">+                        }.show()
</a><a href="#h41-0-78" id="h41-0-78" class="i">+                    }
</a><a href="#h41-0-79" id="h41-0-79" class="i">+                })
</a><a href="#h41-0-80" id="h41-0-80" class="i">+            }
</a> 
 
<a href="#h41-0-83" id="h41-0-83" class="d">-        context.event.subscribe(NetworkApiRequestEvent::class) { event -&gt;
</a><a href="#h41-0-84" id="h41-0-84" class="d">-            if (!event.url.endsWith(&quot;/rpc/getPublicProfile&quot;)) return@subscribe
</a><a href="#h41-0-85" id="h41-0-85" class="d">-            event.onSuccess {  buffer -&gt;
</a><a href="#h41-0-86" id="h41-0-86" class="d">-                ProtoReader(buffer ?: return@onSuccess).followPath(1, 1, 2) {
</a><a href="#h41-0-87" id="h41-0-87" class="d">-                    friendUsername = getString(2) ?: return@followPath
</a><a href="#h41-0-88" id="h41-0-88" class="d">-                    followPath(4) {
</a><a href="#h41-0-89" id="h41-0-89" class="d">-                        backgroundUrl = getString(2)
</a><a href="#h41-0-90" id="h41-0-90" class="d">-                        avatarUrl = getString(100)
</a><a href="#h41-0-91" id="h41-0-91" class="i">+            context.event.subscribe(NetworkApiRequestEvent::class) { event -&gt;
</a><a href="#h41-0-92" id="h41-0-92" class="i">+                if (!event.url.endsWith(&quot;/rpc/getPublicProfile&quot;)) return@subscribe
</a><a href="#h41-0-93" id="h41-0-93" class="i">+                event.onSuccess {  buffer -&gt;
</a><a href="#h41-0-94" id="h41-0-94" class="i">+                    ProtoReader(buffer ?: return@onSuccess).followPath(1, 1, 2) {
</a><a href="#h41-0-95" id="h41-0-95" class="i">+                        friendUsername = getString(2) ?: return@followPath
</a><a href="#h41-0-96" id="h41-0-96" class="i">+                        followPath(4) {
</a><a href="#h41-0-97" id="h41-0-97" class="i">+                            backgroundUrl = getString(2)
</a><a href="#h41-0-98" id="h41-0-98" class="i">+                            avatarUrl = getString(100)
</a><a href="#h41-0-99" id="h41-0-99" class="i">+                        }
</a>                     }
                 }
             }
<b>diff --git a/<a id="h42" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/experiments/AccountSwitcher.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/experiments/AccountSwitcher.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/experiments/AccountSwitcher.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/experiments/AccountSwitcher.kt</a></b>
<a href="#h42-0" id="h42-0" class="h">@@ -36,7 +36,6 @@ import me.rhunk.snapenhance.common.util.snap.MediaDownloaderHelper
</a> import me.rhunk.snapenhance.core.event.events.impl.ActivityResultEvent
 import me.rhunk.snapenhance.core.event.events.impl.AddViewEvent
 import me.rhunk.snapenhance.core.features.Feature
<a href="#h42-0-3" id="h42-0-3" class="d">-import me.rhunk.snapenhance.core.features.FeatureLoadParams
</a> import me.rhunk.snapenhance.core.util.hook.HookStage
 import me.rhunk.snapenhance.core.util.hook.hook
 import me.rhunk.snapenhance.core.util.ktx.getId
<a href="#h42-1" id="h42-1" class="h">@@ -47,7 +46,7 @@ import java.util.zip.ZipInputStream
</a> import java.util.zip.ZipOutputStream
 import kotlin.random.Random
 
<a href="#h42-1-3" id="h42-1-3" class="d">-class AccountSwitcher: Feature(&quot;Account Switcher&quot;, loadParams = FeatureLoadParams.INIT_SYNC or FeatureLoadParams.ACTIVITY_CREATE_SYNC) {
</a><a href="#h42-1-4" id="h42-1-4" class="i">+class AccountSwitcher: Feature(&quot;Account Switcher&quot;) {
</a>     private var exportCallback: Pair&lt;Int, String&gt;? = null // requestCode -&gt; userId
     private var importRequestCode: Int? = null
 
<a href="#h42-2" id="h42-2" class="h">@@ -425,25 +424,23 @@ class AccountSwitcher: Feature(&quot;Account Switcher&quot;, loadParams = FeatureLoadParam
</a>         mainDbShmFile?.delete()
     }
 
<a href="#h42-2-3" id="h42-2-3" class="d">-    override fun onActivityCreate() {
</a><a href="#h42-2-4" id="h42-2-4" class="i">+    @SuppressLint(&quot;SetTextI18n&quot;)
</a><a href="#h42-2-5" id="h42-2-5" class="i">+    override fun init() {
</a>         if (context.config.experimental.accountSwitcher.globalState != true) return
 
<a href="#h42-2-8" id="h42-2-8" class="d">-        val hovaHeaderSearchIcon = context.mainActivity!!.resources.getId(&quot;hova_header_search_icon&quot;)
</a><a href="#h42-2-9" id="h42-2-9" class="i">+        onNextActivityCreate {
</a><a href="#h42-2-10" id="h42-2-10" class="i">+            val hovaHeaderSearchIcon = context.resources.getId(&quot;hova_header_search_icon&quot;)
</a> 
<a href="#h42-2-12" id="h42-2-12" class="d">-        context.event.subscribe(AddViewEvent::class) { event -&gt;
</a><a href="#h42-2-13" id="h42-2-13" class="d">-            if (event.view.id != hovaHeaderSearchIcon) return@subscribe
</a><a href="#h42-2-14" id="h42-2-14" class="i">+            context.event.subscribe(AddViewEvent::class) { event -&gt;
</a><a href="#h42-2-15" id="h42-2-15" class="i">+                if (event.view.id != hovaHeaderSearchIcon) return@subscribe
</a> 
<a href="#h42-2-17" id="h42-2-17" class="d">-            event.view.setOnLongClickListener {
</a><a href="#h42-2-18" id="h42-2-18" class="d">-                context.mainActivity!!.vibrateLongPress()
</a><a href="#h42-2-19" id="h42-2-19" class="d">-                showManagementPopup()
</a><a href="#h42-2-20" id="h42-2-20" class="d">-                false
</a><a href="#h42-2-21" id="h42-2-21" class="i">+                event.view.setOnLongClickListener {
</a><a href="#h42-2-22" id="h42-2-22" class="i">+                    context.mainActivity!!.vibrateLongPress()
</a><a href="#h42-2-23" id="h42-2-23" class="i">+                    showManagementPopup()
</a><a href="#h42-2-24" id="h42-2-24" class="i">+                    false
</a><a href="#h42-2-25" id="h42-2-25" class="i">+                }
</a>             }
         }
<a href="#h42-2-28" id="h42-2-28" class="d">-    }
</a><a href="#h42-2-29" id="h42-2-29" class="d">-
</a><a href="#h42-2-30" id="h42-2-30" class="d">-    @SuppressLint(&quot;SetTextI18n&quot;)
</a><a href="#h42-2-31" id="h42-2-31" class="d">-    override fun init() {
</a><a href="#h42-2-32" id="h42-2-32" class="d">-        if (context.config.experimental.accountSwitcher.globalState != true) return
</a> 
         context.event.subscribe(ActivityResultEvent::class) { event -&gt;
             if (importRequestCode == event.requestCode) {
<a href="#h42-3" id="h42-3" class="h">@@ -501,7 +498,7 @@ class AccountSwitcher: Feature(&quot;Account Switcher&quot;, loadParams = FeatureLoadParam
</a>         }
 
         findClass(&quot;com.snap.identity.loginsignup.ui.LoginSignupActivity&quot;).apply {
<a href="#h42-3-3" id="h42-3-3" class="d">-            hook(&quot;onPostCreate&quot;, HookStage.AFTER) { param -&gt;
</a><a href="#h42-3-4" id="h42-3-4" class="i">+            hook(&quot;onPostCreate&quot;, HookStage.AFTER) {
</a>                 context.mainActivity!!.findViewById&lt;FrameLayout&gt;(android.R.id.content).addView(createComposeView(context.mainActivity!!) {
                     Row(
                         modifier = Modifier.fillMaxWidth(),
<b>diff --git a/<a id="h43" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/experiments/AddFriendSourceSpoof.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/experiments/AddFriendSourceSpoof.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/experiments/AddFriendSourceSpoof.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/experiments/AddFriendSourceSpoof.kt</a></b>
<a href="#h43-0" id="h43-0" class="h">@@ -4,68 +4,69 @@ import me.rhunk.snapenhance.common.data.FriendAddSource
</a> import me.rhunk.snapenhance.common.util.protobuf.ProtoEditor
 import me.rhunk.snapenhance.core.event.events.impl.UnaryCallEvent
 import me.rhunk.snapenhance.core.features.Feature
<a href="#h43-0-3" id="h43-0-3" class="d">-import me.rhunk.snapenhance.core.features.FeatureLoadParams
</a> import me.rhunk.snapenhance.core.util.hook.HookStage
 import me.rhunk.snapenhance.core.util.hook.hookConstructor
 import me.rhunk.snapenhance.mapper.impl.FriendRelationshipChangerMapper
 
<a href="#h43-0-8" id="h43-0-8" class="d">-class AddFriendSourceSpoof : Feature(&quot;AddFriendSourceSpoof&quot;, loadParams = FeatureLoadParams.ACTIVITY_CREATE_SYNC) {
</a><a href="#h43-0-9" id="h43-0-9" class="i">+class AddFriendSourceSpoof : Feature(&quot;AddFriendSourceSpoof&quot;) {
</a>     var friendRelationshipChangerInstance: Any? = null
         private set
 
<a href="#h43-0-13" id="h43-0-13" class="d">-    override fun onActivityCreate() {
</a><a href="#h43-0-14" id="h43-0-14" class="d">-        context.mappings.useMapper(FriendRelationshipChangerMapper::class) {
</a><a href="#h43-0-15" id="h43-0-15" class="d">-            classReference.get()?.hookConstructor(HookStage.AFTER) { param -&gt;
</a><a href="#h43-0-16" id="h43-0-16" class="d">-                friendRelationshipChangerInstance = param.thisObject()
</a><a href="#h43-0-17" id="h43-0-17" class="i">+    override fun init() {
</a><a href="#h43-0-18" id="h43-0-18" class="i">+        onNextActivityCreate {
</a><a href="#h43-0-19" id="h43-0-19" class="i">+            context.mappings.useMapper(FriendRelationshipChangerMapper::class) {
</a><a href="#h43-0-20" id="h43-0-20" class="i">+                classReference.get()?.hookConstructor(HookStage.AFTER) { param -&gt;
</a><a href="#h43-0-21" id="h43-0-21" class="i">+                    friendRelationshipChangerInstance = param.thisObject()
</a><a href="#h43-0-22" id="h43-0-22" class="i">+                }
</a>             }
<a href="#h43-0-24" id="h43-0-24" class="d">-        }
</a><a href="#h43-0-25" id="h43-0-25" class="d">-
</a><a href="#h43-0-26" id="h43-0-26" class="d">-        context.event.subscribe(UnaryCallEvent::class) { event -&gt;
</a><a href="#h43-0-27" id="h43-0-27" class="d">-            if (event.uri != &quot;/snapchat.friending.server.FriendAction/AddFriends&quot;) return@subscribe
</a><a href="#h43-0-28" id="h43-0-28" class="d">-            val spoofedSource = context.config.experimental.addFriendSourceSpoof.getNullable() ?: return@subscribe
</a><a href="#h43-0-29" id="h43-0-29" class="d">-            event.buffer = ProtoEditor(event.buffer).apply {
</a><a href="#h43-0-30" id="h43-0-30" class="d">-                edit {
</a><a href="#h43-0-31" id="h43-0-31" class="d">-                    fun setPage(value: String) {
</a><a href="#h43-0-32" id="h43-0-32" class="d">-                        remove(1)
</a><a href="#h43-0-33" id="h43-0-33" class="d">-                        addString(1, value)
</a><a href="#h43-0-34" id="h43-0-34" class="d">-                    }
</a> 
<a href="#h43-0-36" id="h43-0-36" class="d">-                    editEach(2) {
</a><a href="#h43-0-37" id="h43-0-37" class="d">-                        remove(3) // remove suggestion token
</a><a href="#h43-0-38" id="h43-0-38" class="d">-                        fun setSource(source: FriendAddSource) {
</a><a href="#h43-0-39" id="h43-0-39" class="d">-                            remove(2)
</a><a href="#h43-0-40" id="h43-0-40" class="d">-                            addVarInt(2, source.id)
</a><a href="#h43-0-41" id="h43-0-41" class="i">+            context.event.subscribe(UnaryCallEvent::class) { event -&gt;
</a><a href="#h43-0-42" id="h43-0-42" class="i">+                if (event.uri != &quot;/snapchat.friending.server.FriendAction/AddFriends&quot;) return@subscribe
</a><a href="#h43-0-43" id="h43-0-43" class="i">+                val spoofedSource = context.config.experimental.addFriendSourceSpoof.getNullable() ?: return@subscribe
</a><a href="#h43-0-44" id="h43-0-44" class="i">+                event.buffer = ProtoEditor(event.buffer).apply {
</a><a href="#h43-0-45" id="h43-0-45" class="i">+                    edit {
</a><a href="#h43-0-46" id="h43-0-46" class="i">+                        fun setPage(value: String) {
</a><a href="#h43-0-47" id="h43-0-47" class="i">+                            remove(1)
</a><a href="#h43-0-48" id="h43-0-48" class="i">+                            addString(1, value)
</a>                         }
 
<a href="#h43-0-51" id="h43-0-51" class="d">-                        when (spoofedSource) {
</a><a href="#h43-0-52" id="h43-0-52" class="d">-                            &quot;added_by_group_chat&quot; -&gt; {
</a><a href="#h43-0-53" id="h43-0-53" class="d">-                                setPage(&quot;group_profile&quot;)
</a><a href="#h43-0-54" id="h43-0-54" class="d">-                                setSource(FriendAddSource.GROUP_CHAT)
</a><a href="#h43-0-55" id="h43-0-55" class="d">-                            }
</a><a href="#h43-0-56" id="h43-0-56" class="d">-                            &quot;added_by_username&quot; -&gt; {
</a><a href="#h43-0-57" id="h43-0-57" class="d">-                                setPage(&quot;search&quot;)
</a><a href="#h43-0-58" id="h43-0-58" class="d">-                                setSource(FriendAddSource.USERNAME)
</a><a href="#h43-0-59" id="h43-0-59" class="d">-                            }
</a><a href="#h43-0-60" id="h43-0-60" class="d">-                            &quot;added_by_qr_code&quot; -&gt; {
</a><a href="#h43-0-61" id="h43-0-61" class="d">-                                setPage(&quot;scan_snapcode&quot;)
</a><a href="#h43-0-62" id="h43-0-62" class="d">-                                setSource(FriendAddSource.QR_CODE)
</a><a href="#h43-0-63" id="h43-0-63" class="i">+                        editEach(2) {
</a><a href="#h43-0-64" id="h43-0-64" class="i">+                            remove(3) // remove suggestion token
</a><a href="#h43-0-65" id="h43-0-65" class="i">+                            fun setSource(source: FriendAddSource) {
</a><a href="#h43-0-66" id="h43-0-66" class="i">+                                remove(2)
</a><a href="#h43-0-67" id="h43-0-67" class="i">+                                addVarInt(2, source.id)
</a>                             }
<a href="#h43-0-69" id="h43-0-69" class="d">-                            &quot;added_by_mention&quot; -&gt; {
</a><a href="#h43-0-70" id="h43-0-70" class="d">-                                setPage(&quot;context_card&quot;)
</a><a href="#h43-0-71" id="h43-0-71" class="d">-                                setSource(FriendAddSource.MENTION)
</a><a href="#h43-0-72" id="h43-0-72" class="d">-                            }
</a><a href="#h43-0-73" id="h43-0-73" class="d">-                            &quot;added_by_community&quot; -&gt; {
</a><a href="#h43-0-74" id="h43-0-74" class="d">-                                setPage(&quot;profile&quot;)
</a><a href="#h43-0-75" id="h43-0-75" class="d">-                                setSource(FriendAddSource.COMMUNITY)
</a><a href="#h43-0-76" id="h43-0-76" class="d">-                            }
</a><a href="#h43-0-77" id="h43-0-77" class="d">-                            &quot;added_by_quick_add&quot; -&gt; {
</a><a href="#h43-0-78" id="h43-0-78" class="d">-                                setPage(&quot;add_friends_button_on_top_bar_on_friends_feed&quot;)
</a><a href="#h43-0-79" id="h43-0-79" class="d">-                                setSource(FriendAddSource.SUGGESTED)
</a><a href="#h43-0-80" id="h43-0-80" class="i">+
</a><a href="#h43-0-81" id="h43-0-81" class="i">+                            when (spoofedSource) {
</a><a href="#h43-0-82" id="h43-0-82" class="i">+                                &quot;added_by_group_chat&quot; -&gt; {
</a><a href="#h43-0-83" id="h43-0-83" class="i">+                                    setPage(&quot;group_profile&quot;)
</a><a href="#h43-0-84" id="h43-0-84" class="i">+                                    setSource(FriendAddSource.GROUP_CHAT)
</a><a href="#h43-0-85" id="h43-0-85" class="i">+                                }
</a><a href="#h43-0-86" id="h43-0-86" class="i">+                                &quot;added_by_username&quot; -&gt; {
</a><a href="#h43-0-87" id="h43-0-87" class="i">+                                    setPage(&quot;search&quot;)
</a><a href="#h43-0-88" id="h43-0-88" class="i">+                                    setSource(FriendAddSource.USERNAME)
</a><a href="#h43-0-89" id="h43-0-89" class="i">+                                }
</a><a href="#h43-0-90" id="h43-0-90" class="i">+                                &quot;added_by_qr_code&quot; -&gt; {
</a><a href="#h43-0-91" id="h43-0-91" class="i">+                                    setPage(&quot;scan_snapcode&quot;)
</a><a href="#h43-0-92" id="h43-0-92" class="i">+                                    setSource(FriendAddSource.QR_CODE)
</a><a href="#h43-0-93" id="h43-0-93" class="i">+                                }
</a><a href="#h43-0-94" id="h43-0-94" class="i">+                                &quot;added_by_mention&quot; -&gt; {
</a><a href="#h43-0-95" id="h43-0-95" class="i">+                                    setPage(&quot;context_card&quot;)
</a><a href="#h43-0-96" id="h43-0-96" class="i">+                                    setSource(FriendAddSource.MENTION)
</a><a href="#h43-0-97" id="h43-0-97" class="i">+                                }
</a><a href="#h43-0-98" id="h43-0-98" class="i">+                                &quot;added_by_community&quot; -&gt; {
</a><a href="#h43-0-99" id="h43-0-99" class="i">+                                    setPage(&quot;profile&quot;)
</a><a href="#h43-0-100" id="h43-0-100" class="i">+                                    setSource(FriendAddSource.COMMUNITY)
</a><a href="#h43-0-101" id="h43-0-101" class="i">+                                }
</a><a href="#h43-0-102" id="h43-0-102" class="i">+                                &quot;added_by_quick_add&quot; -&gt; {
</a><a href="#h43-0-103" id="h43-0-103" class="i">+                                    setPage(&quot;add_friends_button_on_top_bar_on_friends_feed&quot;)
</a><a href="#h43-0-104" id="h43-0-104" class="i">+                                    setSource(FriendAddSource.SUGGESTED)
</a><a href="#h43-0-105" id="h43-0-105" class="i">+                                }
</a>                             }
                         }
                     }
<a href="#h43-0-109" id="h43-0-109" class="d">-                }
</a><a href="#h43-0-110" id="h43-0-110" class="d">-            }.toByteArray()
</a><a href="#h43-0-111" id="h43-0-111" class="i">+                }.toByteArray()
</a><a href="#h43-0-112" id="h43-0-112" class="i">+            }
</a>         }
     }
 } 
\ No newline at end of file
<b>diff --git a/<a id="h44" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/experiments/AppLock.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/experiments/AppLock.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/experiments/AppLock.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/experiments/AppLock.kt</a></b>
<a href="#h44-0" id="h44-0" class="h">@@ -31,7 +31,6 @@ import me.rhunk.snapenhance.common.ui.AppMaterialTheme
</a> import me.rhunk.snapenhance.common.ui.createComposeView
 import me.rhunk.snapenhance.core.event.events.impl.ActivityResultEvent
 import me.rhunk.snapenhance.core.features.Feature
<a href="#h44-0-3" id="h44-0-3" class="d">-import me.rhunk.snapenhance.core.features.FeatureLoadParams
</a> import me.rhunk.snapenhance.core.ui.addForegroundDrawable
 import me.rhunk.snapenhance.core.ui.children
 import me.rhunk.snapenhance.core.ui.removeForegroundDrawable
<a href="#h44-1" id="h44-1" class="h">@@ -39,7 +38,7 @@ import me.rhunk.snapenhance.core.util.hook.HookStage
</a> import me.rhunk.snapenhance.core.util.hook.hook
 import kotlin.random.Random
 
<a href="#h44-1-3" id="h44-1-3" class="d">-class AppLock : Feature(&quot;AppLock&quot;, loadParams = FeatureLoadParams.ACTIVITY_CREATE_SYNC) {
</a><a href="#h44-1-4" id="h44-1-4" class="i">+class AppLock : Feature(&quot;AppLock&quot;) {
</a>     private var isUnlockRequested = false
 
     private val rootContentView get() = context.mainActivity!!.findViewById&lt;FrameLayout&gt;(android.R.id.content)
<a href="#h44-2" id="h44-2" class="h">@@ -122,32 +121,34 @@ class AppLock : Feature(&quot;AppLock&quot;, loadParams = FeatureLoadParams.ACTIVITY_CREAT
</a>         }
     }
 
<a href="#h44-2-3" id="h44-2-3" class="d">-    override fun onActivityCreate() {
</a><a href="#h44-2-4" id="h44-2-4" class="i">+    override fun init() {
</a>         if (context.config.experimental.appLock.globalState != true) return
 
<a href="#h44-2-7" id="h44-2-7" class="d">-        Activity::class.java.apply {
</a><a href="#h44-2-8" id="h44-2-8" class="d">-            if (context.config.experimental.appLock.lockOnResume.get()) {
</a><a href="#h44-2-9" id="h44-2-9" class="d">-                hook(&quot;onResume&quot;, HookStage.BEFORE) { param -&gt;
</a><a href="#h44-2-10" id="h44-2-10" class="d">-                    if (param.thisObject&lt;Activity&gt;().packageName != Constants.SNAPCHAT_PACKAGE_NAME) return@hook
</a><a href="#h44-2-11" id="h44-2-11" class="d">-                    if (isUnlockRequested) return@hook
</a><a href="#h44-2-12" id="h44-2-12" class="d">-                    lock(prompt = true)
</a><a href="#h44-2-13" id="h44-2-13" class="d">-                }
</a><a href="#h44-2-14" id="h44-2-14" class="d">-                hook(&quot;onPause&quot;, HookStage.BEFORE) { param -&gt;
</a><a href="#h44-2-15" id="h44-2-15" class="d">-                    if (param.thisObject&lt;Activity&gt;().packageName != Constants.SNAPCHAT_PACKAGE_NAME) return@hook
</a><a href="#h44-2-16" id="h44-2-16" class="d">-                    if (isUnlockRequested) return@hook
</a><a href="#h44-2-17" id="h44-2-17" class="d">-                    hideRootView()
</a><a href="#h44-2-18" id="h44-2-18" class="i">+        onNextActivityCreate {
</a><a href="#h44-2-19" id="h44-2-19" class="i">+            Activity::class.java.apply {
</a><a href="#h44-2-20" id="h44-2-20" class="i">+                if (context.config.experimental.appLock.lockOnResume.get()) {
</a><a href="#h44-2-21" id="h44-2-21" class="i">+                    hook(&quot;onResume&quot;, HookStage.BEFORE) { param -&gt;
</a><a href="#h44-2-22" id="h44-2-22" class="i">+                        if (param.thisObject&lt;Activity&gt;().packageName != Constants.SNAPCHAT_PACKAGE_NAME) return@hook
</a><a href="#h44-2-23" id="h44-2-23" class="i">+                        if (isUnlockRequested) return@hook
</a><a href="#h44-2-24" id="h44-2-24" class="i">+                        lock(prompt = true)
</a><a href="#h44-2-25" id="h44-2-25" class="i">+                    }
</a><a href="#h44-2-26" id="h44-2-26" class="i">+                    hook(&quot;onPause&quot;, HookStage.BEFORE) { param -&gt;
</a><a href="#h44-2-27" id="h44-2-27" class="i">+                        if (param.thisObject&lt;Activity&gt;().packageName != Constants.SNAPCHAT_PACKAGE_NAME) return@hook
</a><a href="#h44-2-28" id="h44-2-28" class="i">+                        if (isUnlockRequested) return@hook
</a><a href="#h44-2-29" id="h44-2-29" class="i">+                        hideRootView()
</a><a href="#h44-2-30" id="h44-2-30" class="i">+                    }
</a>                 }
             }
<a href="#h44-2-33" id="h44-2-33" class="d">-        }
</a> 
<a href="#h44-2-35" id="h44-2-35" class="d">-        context.event.subscribe(ActivityResultEvent::class) { event -&gt;
</a><a href="#h44-2-36" id="h44-2-36" class="d">-            if (event.requestCode != requestCode) return@subscribe
</a><a href="#h44-2-37" id="h44-2-37" class="d">-            if (event.resultCode == Activity.RESULT_OK) {
</a><a href="#h44-2-38" id="h44-2-38" class="d">-                unlock()
</a><a href="#h44-2-39" id="h44-2-39" class="d">-                return@subscribe
</a><a href="#h44-2-40" id="h44-2-40" class="i">+            context.event.subscribe(ActivityResultEvent::class) { event -&gt;
</a><a href="#h44-2-41" id="h44-2-41" class="i">+                if (event.requestCode != requestCode) return@subscribe
</a><a href="#h44-2-42" id="h44-2-42" class="i">+                if (event.resultCode == Activity.RESULT_OK) {
</a><a href="#h44-2-43" id="h44-2-43" class="i">+                    unlock()
</a><a href="#h44-2-44" id="h44-2-44" class="i">+                    return@subscribe
</a><a href="#h44-2-45" id="h44-2-45" class="i">+                }
</a><a href="#h44-2-46" id="h44-2-46" class="i">+                lock(prompt = false)
</a>             }
<a href="#h44-2-48" id="h44-2-48" class="d">-            lock(prompt = false)
</a><a href="#h44-2-49" id="h44-2-49" class="i">+            lock()
</a>         }
<a href="#h44-2-51" id="h44-2-51" class="d">-        lock()
</a>     }
 } 
\ No newline at end of file
<b>diff --git a/<a id="h45" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/experiments/AutoOpenSnaps.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/experiments/AutoOpenSnaps.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/experiments/AutoOpenSnaps.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/experiments/AutoOpenSnaps.kt</a></b>
<a href="#h45-0" id="h45-0" class="h">@@ -11,7 +11,6 @@ import me.rhunk.snapenhance.common.data.ContentType
</a> import me.rhunk.snapenhance.common.data.MessageUpdate
 import me.rhunk.snapenhance.common.data.MessagingRuleType
 import me.rhunk.snapenhance.core.event.events.impl.BuildMessageEvent
<a href="#h45-0-3" id="h45-0-3" class="d">-import me.rhunk.snapenhance.core.features.FeatureLoadParams
</a> import me.rhunk.snapenhance.core.features.MessagingRuleFeature
 import me.rhunk.snapenhance.core.features.impl.messaging.Messaging
 import java.util.concurrent.atomic.AtomicInteger
<a href="#h45-1" id="h45-1" class="h">@@ -19,7 +18,7 @@ import kotlin.coroutines.resume
</a> import kotlin.coroutines.suspendCoroutine
 import kotlin.random.Random
 
<a href="#h45-1-3" id="h45-1-3" class="d">-class AutoOpenSnaps: MessagingRuleFeature(&quot;Auto Open Snaps&quot;, MessagingRuleType.AUTO_OPEN_SNAPS, loadParams = FeatureLoadParams.INIT_SYNC) {
</a><a href="#h45-1-4" id="h45-1-4" class="i">+class AutoOpenSnaps: MessagingRuleFeature(&quot;Auto Open Snaps&quot;, MessagingRuleType.AUTO_OPEN_SNAPS) {
</a>     private val snapQueue = MutableSharedFlow&lt;Pair&lt;String, Long&gt;&gt;()
     private var snapQueueSize = AtomicInteger(0)
     private val openedSnaps = mutableListOf&lt;Long&gt;()
<b>diff --git a/<a id="h46" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/experiments/BestFriendPinning.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/experiments/BestFriendPinning.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/experiments/BestFriendPinning.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/experiments/BestFriendPinning.kt</a></b>
<a href="#h46-0" id="h46-0" class="h">@@ -12,13 +12,12 @@ import me.rhunk.snapenhance.common.util.protobuf.ProtoReader
</a> import me.rhunk.snapenhance.core.event.events.impl.NetworkApiRequestEvent
 import me.rhunk.snapenhance.core.event.events.impl.UnaryCallEvent
 import me.rhunk.snapenhance.core.features.BridgeFileFeature
<a href="#h46-0-3" id="h46-0-3" class="d">-import me.rhunk.snapenhance.core.features.FeatureLoadParams
</a> import me.rhunk.snapenhance.core.ui.triggerRootCloseTouchEvent
 import java.io.InputStreamReader
 import java.nio.ByteBuffer
 import java.util.UUID
 
<a href="#h46-0-9" id="h46-0-9" class="d">-class BestFriendPinning: BridgeFileFeature(&quot;Best Friend Pinning&quot;, InternalFileHandleType.PINNED_BEST_FRIEND, loadParams = FeatureLoadParams.INIT_SYNC) {
</a><a href="#h46-0-10" id="h46-0-10" class="i">+class BestFriendPinning: BridgeFileFeature(&quot;Best Friend Pinning&quot;, InternalFileHandleType.PINNED_BEST_FRIEND) {
</a>     private fun updatePinnedBestFriendStatus() {
         lines().firstOrNull()?.trim()?.let {
             context.database.updatePinnedBestFriendStatus(it.substring(0, 36), &quot;number_one_bf_for_two_months&quot;)
<b>diff --git a/<a id="h47" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/experiments/BetterLocation.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/experiments/BetterLocation.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/experiments/BetterLocation.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/experiments/BetterLocation.kt</a></b>
<a href="#h47-0" id="h47-0" class="h">@@ -25,7 +25,6 @@ import me.rhunk.snapenhance.common.util.protobuf.ProtoReader
</a> import me.rhunk.snapenhance.core.event.events.impl.AddViewEvent
 import me.rhunk.snapenhance.core.event.events.impl.UnaryCallEvent
 import me.rhunk.snapenhance.core.features.Feature
<a href="#h47-0-3" id="h47-0-3" class="d">-import me.rhunk.snapenhance.core.features.FeatureLoadParams
</a> import me.rhunk.snapenhance.core.util.RandomWalking
 import me.rhunk.snapenhance.core.util.hook.HookStage
 import me.rhunk.snapenhance.core.util.hook.hook
<a href="#h47-1" id="h47-1" class="h">@@ -44,7 +43,7 @@ data class FriendLocation(
</a>     val localityPieces: List&lt;String&gt;
 )
 
<a href="#h47-1-3" id="h47-1-3" class="d">-class BetterLocation : Feature(&quot;Better Location&quot;, loadParams = FeatureLoadParams.INIT_SYNC) {
</a><a href="#h47-1-4" id="h47-1-4" class="i">+class BetterLocation : Feature(&quot;Better Location&quot;) {
</a>     private val locationHistory = mutableMapOf&lt;String, FriendLocation&gt;()
 
     private val walkRadius by lazy {
<b>diff --git a/<a id="h48" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/experiments/BetterTranscript.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/experiments/BetterTranscript.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/experiments/BetterTranscript.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/experiments/BetterTranscript.kt</a></b>
<a href="#h48-0" id="h48-0" class="h">@@ -5,7 +5,6 @@ import me.rhunk.snapenhance.common.util.TranscriptApi
</a> import me.rhunk.snapenhance.common.util.protobuf.ProtoEditor
 import me.rhunk.snapenhance.core.event.events.impl.BuildMessageEvent
 import me.rhunk.snapenhance.core.features.Feature
<a href="#h48-0-3" id="h48-0-3" class="d">-import me.rhunk.snapenhance.core.features.FeatureLoadParams
</a> import me.rhunk.snapenhance.core.util.dataBuilder
 import me.rhunk.snapenhance.core.util.hook.HookStage
 import me.rhunk.snapenhance.core.util.hook.hook
<a href="#h48-1" id="h48-1" class="h">@@ -15,62 +14,65 @@ import okhttp3.RequestBody.Companion.toRequestBody
</a> import java.lang.reflect.Method
 import java.nio.ByteBuffer
 
<a href="#h48-1-3" id="h48-1-3" class="d">-class BetterTranscript: Feature(&quot;Better Transcript&quot;, loadParams = FeatureLoadParams.ACTIVITY_CREATE_SYNC) {
</a><a href="#h48-1-4" id="h48-1-4" class="i">+class BetterTranscript: Feature(&quot;Better Transcript&quot;) {
</a>     val transcriptApi by lazy { TranscriptApi() }
 
<a href="#h48-1-7" id="h48-1-7" class="d">-    override fun onActivityCreate() {
</a><a href="#h48-1-8" id="h48-1-8" class="i">+    override fun init() {
</a>         if (context.config.experimental.betterTranscript.globalState != true) return
<a href="#h48-1-10" id="h48-1-10" class="d">-        val config = context.config.experimental.betterTranscript
</a><a href="#h48-1-11" id="h48-1-11" class="d">-        val preferredTranscriptionLang = config.preferredTranscriptionLang.getNullable()?.takeIf {
</a><a href="#h48-1-12" id="h48-1-12" class="d">-            it.isNotBlank()
</a><a href="#h48-1-13" id="h48-1-13" class="d">-        }
</a> 
<a href="#h48-1-15" id="h48-1-15" class="d">-        if (config.forceTranscription.get()) {
</a><a href="#h48-1-16" id="h48-1-16" class="d">-            context.event.subscribe(BuildMessageEvent::class, priority = 104) { event -&gt;
</a><a href="#h48-1-17" id="h48-1-17" class="d">-                if (event.message.messageContent?.contentType != ContentType.NOTE) return@subscribe
</a><a href="#h48-1-18" id="h48-1-18" class="d">-                event.message.messageContent!!.content = ProtoEditor(event.message.messageContent!!.content!!).apply {
</a><a href="#h48-1-19" id="h48-1-19" class="d">-                    edit(6, 1) {
</a><a href="#h48-1-20" id="h48-1-20" class="d">-                        if (firstOrNull(3) == null) {
</a><a href="#h48-1-21" id="h48-1-21" class="d">-                            addString(3, context.getConfigLocale())
</a><a href="#h48-1-22" id="h48-1-22" class="d">-                        }
</a><a href="#h48-1-23" id="h48-1-23" class="d">-                    }
</a><a href="#h48-1-24" id="h48-1-24" class="d">-                }.toByteArray()
</a><a href="#h48-1-25" id="h48-1-25" class="i">+        onNextActivityCreate {
</a><a href="#h48-1-26" id="h48-1-26" class="i">+            val config = context.config.experimental.betterTranscript
</a><a href="#h48-1-27" id="h48-1-27" class="i">+            val preferredTranscriptionLang = config.preferredTranscriptionLang.getNullable()?.takeIf {
</a><a href="#h48-1-28" id="h48-1-28" class="i">+                it.isNotBlank()
</a>             }
<a href="#h48-1-30" id="h48-1-30" class="d">-        }
</a> 
<a href="#h48-1-32" id="h48-1-32" class="d">-        findClass(&quot;com.snapchat.client.voiceml.IVoiceMLSDK\$CppProxy&quot;).hook(&quot;asrTranscribe&quot;, HookStage.BEFORE) { param -&gt;
</a><a href="#h48-1-33" id="h48-1-33" class="d">-            if (config.enhancedTranscript.get()) {
</a><a href="#h48-1-34" id="h48-1-34" class="d">-                val buffer = param.arg&lt;ByteBuffer&gt;(2).let {
</a><a href="#h48-1-35" id="h48-1-35" class="d">-                    it.rewind()
</a><a href="#h48-1-36" id="h48-1-36" class="d">-                    ByteArray(it.remaining()).also { it1 -&gt; it.get(it1); it.rewind() }
</a><a href="#h48-1-37" id="h48-1-37" class="i">+            if (config.forceTranscription.get()) {
</a><a href="#h48-1-38" id="h48-1-38" class="i">+                context.event.subscribe(BuildMessageEvent::class, priority = 104) { event -&gt;
</a><a href="#h48-1-39" id="h48-1-39" class="i">+                    if (event.message.messageContent?.contentType != ContentType.NOTE) return@subscribe
</a><a href="#h48-1-40" id="h48-1-40" class="i">+                    event.message.messageContent!!.content = ProtoEditor(event.message.messageContent!!.content!!).apply {
</a><a href="#h48-1-41" id="h48-1-41" class="i">+                        edit(6, 1) {
</a><a href="#h48-1-42" id="h48-1-42" class="i">+                            if (firstOrNull(3) == null) {
</a><a href="#h48-1-43" id="h48-1-43" class="i">+                                addString(3, context.getConfigLocale())
</a><a href="#h48-1-44" id="h48-1-44" class="i">+                            }
</a><a href="#h48-1-45" id="h48-1-45" class="i">+                        }
</a><a href="#h48-1-46" id="h48-1-46" class="i">+                    }.toByteArray()
</a>                 }
<a href="#h48-1-48" id="h48-1-48" class="d">-                val result = runCatching {
</a><a href="#h48-1-49" id="h48-1-49" class="d">-                    transcriptApi.transcribe(
</a><a href="#h48-1-50" id="h48-1-50" class="d">-                        buffer.toRequestBody(),
</a><a href="#h48-1-51" id="h48-1-51" class="d">-                        lang = config.preferredTranscriptionLang.getNullable()?.takeIf {
</a><a href="#h48-1-52" id="h48-1-52" class="d">-                            it.isNotBlank()
</a><a href="#h48-1-53" id="h48-1-53" class="d">-                        }?.uppercase()
</a><a href="#h48-1-54" id="h48-1-54" class="d">-                    )
</a><a href="#h48-1-55" id="h48-1-55" class="d">-                }.onFailure {
</a><a href="#h48-1-56" id="h48-1-56" class="d">-                    context.log.error(&quot;Failed to transcribe audio&quot;, it)
</a><a href="#h48-1-57" id="h48-1-57" class="d">-                    context.shortToast(&quot;Failed to transcribe audio! Check logcat for more details.&quot;)
</a><a href="#h48-1-58" id="h48-1-58" class="d">-                }.getOrNull()
</a><a href="#h48-1-59" id="h48-1-59" class="i">+            }
</a> 
<a href="#h48-1-61" id="h48-1-61" class="d">-                param.setResult(
</a><a href="#h48-1-62" id="h48-1-62" class="d">-                    (param.method() as Method).returnType.dataBuilder {
</a><a href="#h48-1-63" id="h48-1-63" class="d">-                        set(&quot;mError&quot;, result == null)
</a><a href="#h48-1-64" id="h48-1-64" class="d">-                        set(&quot;mNlpResponses&quot;, ArrayList&lt;Any&gt;())
</a><a href="#h48-1-65" id="h48-1-65" class="d">-                        set(&quot;mWordInfo&quot;, ArrayList&lt;Any&gt;())
</a><a href="#h48-1-66" id="h48-1-66" class="d">-                        set(&quot;mTranscription&quot;, result)
</a><a href="#h48-1-67" id="h48-1-67" class="i">+            findClass(&quot;com.snapchat.client.voiceml.IVoiceMLSDK\$CppProxy&quot;).hook(&quot;asrTranscribe&quot;, HookStage.BEFORE) { param -&gt;
</a><a href="#h48-1-68" id="h48-1-68" class="i">+                if (config.enhancedTranscript.get()) {
</a><a href="#h48-1-69" id="h48-1-69" class="i">+                    val buffer = param.arg&lt;ByteBuffer&gt;(2).let {
</a><a href="#h48-1-70" id="h48-1-70" class="i">+                        it.rewind()
</a><a href="#h48-1-71" id="h48-1-71" class="i">+                        ByteArray(it.remaining()).also { it1 -&gt; it.get(it1); it.rewind() }
</a><a href="#h48-1-72" id="h48-1-72" class="i">+                    }
</a><a href="#h48-1-73" id="h48-1-73" class="i">+                    val result = runCatching {
</a><a href="#h48-1-74" id="h48-1-74" class="i">+                        transcriptApi.transcribe(
</a><a href="#h48-1-75" id="h48-1-75" class="i">+                            buffer.toRequestBody(),
</a><a href="#h48-1-76" id="h48-1-76" class="i">+                            lang = config.preferredTranscriptionLang.getNullable()?.takeIf {
</a><a href="#h48-1-77" id="h48-1-77" class="i">+                                it.isNotBlank()
</a><a href="#h48-1-78" id="h48-1-78" class="i">+                            }?.uppercase()
</a><a href="#h48-1-79" id="h48-1-79" class="i">+                        )
</a><a href="#h48-1-80" id="h48-1-80" class="i">+                    }.onFailure {
</a><a href="#h48-1-81" id="h48-1-81" class="i">+                        context.log.error(&quot;Failed to transcribe audio&quot;, it)
</a><a href="#h48-1-82" id="h48-1-82" class="i">+                        context.shortToast(&quot;Failed to transcribe audio! Check logcat for more details.&quot;)
</a><a href="#h48-1-83" id="h48-1-83" class="i">+                    }.getOrNull()
</a><a href="#h48-1-84" id="h48-1-84" class="i">+
</a><a href="#h48-1-85" id="h48-1-85" class="i">+                    param.setResult(
</a><a href="#h48-1-86" id="h48-1-86" class="i">+                        (param.method() as Method).returnType.dataBuilder {
</a><a href="#h48-1-87" id="h48-1-87" class="i">+                            set(&quot;mError&quot;, result == null)
</a><a href="#h48-1-88" id="h48-1-88" class="i">+                            set(&quot;mNlpResponses&quot;, ArrayList&lt;Any&gt;())
</a><a href="#h48-1-89" id="h48-1-89" class="i">+                            set(&quot;mWordInfo&quot;, ArrayList&lt;Any&gt;())
</a><a href="#h48-1-90" id="h48-1-90" class="i">+                            set(&quot;mTranscription&quot;, result)
</a><a href="#h48-1-91" id="h48-1-91" class="i">+                        }
</a><a href="#h48-1-92" id="h48-1-92" class="i">+                    )
</a><a href="#h48-1-93" id="h48-1-93" class="i">+                    return@hook
</a><a href="#h48-1-94" id="h48-1-94" class="i">+                }
</a><a href="#h48-1-95" id="h48-1-95" class="i">+                preferredTranscriptionLang?.lowercase()?.let {
</a><a href="#h48-1-96" id="h48-1-96" class="i">+                    val asrConfig = param.arg&lt;Any&gt;(1)
</a><a href="#h48-1-97" id="h48-1-97" class="i">+                    asrConfig.getObjectFieldOrNull(&quot;mBaseConfig&quot;)?.apply {
</a><a href="#h48-1-98" id="h48-1-98" class="i">+                        setObjectField(&quot;mLanguageModel&quot;, it)
</a><a href="#h48-1-99" id="h48-1-99" class="i">+                        setObjectField(&quot;mUiLanguage&quot;, it)
</a>                     }
<a href="#h48-1-101" id="h48-1-101" class="d">-                )
</a><a href="#h48-1-102" id="h48-1-102" class="d">-                return@hook
</a><a href="#h48-1-103" id="h48-1-103" class="d">-            }
</a><a href="#h48-1-104" id="h48-1-104" class="d">-            preferredTranscriptionLang?.lowercase()?.let {
</a><a href="#h48-1-105" id="h48-1-105" class="d">-                val asrConfig = param.arg&lt;Any&gt;(1)
</a><a href="#h48-1-106" id="h48-1-106" class="d">-                asrConfig.getObjectFieldOrNull(&quot;mBaseConfig&quot;)?.apply {
</a><a href="#h48-1-107" id="h48-1-107" class="d">-                    setObjectField(&quot;mLanguageModel&quot;, it)
</a><a href="#h48-1-108" id="h48-1-108" class="d">-                    setObjectField(&quot;mUiLanguage&quot;, it)
</a>                 }
             }
         }
<b>diff --git a/<a id="h49" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/experiments/CallRecorder.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/experiments/CallRecorder.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/experiments/CallRecorder.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/experiments/CallRecorder.kt</a></b>
<a href="#h49-0" id="h49-0" class="h">@@ -8,7 +8,6 @@ import kotlinx.coroutines.withTimeoutOrNull
</a> import me.rhunk.snapenhance.common.data.download.AudioStreamFormat
 import me.rhunk.snapenhance.common.data.download.MediaDownloadSource
 import me.rhunk.snapenhance.core.features.Feature
<a href="#h49-0-3" id="h49-0-3" class="d">-import me.rhunk.snapenhance.core.features.FeatureLoadParams
</a> import me.rhunk.snapenhance.core.features.impl.downloader.MediaDownloader
 import me.rhunk.snapenhance.core.util.hook.HookStage
 import me.rhunk.snapenhance.core.util.hook.hook
<a href="#h49-1" id="h49-1" class="h">@@ -23,7 +22,7 @@ import java.util.UUID
</a> import java.util.concurrent.ConcurrentHashMap
 import java.util.concurrent.CopyOnWriteArrayList
 
<a href="#h49-1-3" id="h49-1-3" class="d">-class CallRecorder : Feature(&quot;Call Recorder&quot;, loadParams = FeatureLoadParams.INIT_SYNC) {
</a><a href="#h49-1-4" id="h49-1-4" class="i">+class CallRecorder : Feature(&quot;Call Recorder&quot;) {
</a>     private val httpServer = HttpServer(
         timeout = Integer.MAX_VALUE
     )
<b>diff --git a/<a id="h50" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/experiments/ComposerHooks.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/experiments/ComposerHooks.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/experiments/ComposerHooks.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/experiments/ComposerHooks.kt</a></b>
<a href="#h50-0" id="h50-0" class="h">@@ -25,7 +25,6 @@ import me.rhunk.snapenhance.common.ui.AppMaterialTheme
</a> import me.rhunk.snapenhance.common.ui.createComposeAlertDialog
 import me.rhunk.snapenhance.common.ui.createComposeView
 import me.rhunk.snapenhance.core.features.Feature
<a href="#h50-0-3" id="h50-0-3" class="d">-import me.rhunk.snapenhance.core.features.FeatureLoadParams
</a> import me.rhunk.snapenhance.core.features.impl.downloader.MediaDownloader
 import me.rhunk.snapenhance.core.util.hook.HookStage
 import me.rhunk.snapenhance.core.util.hook.Hooker
<a href="#h50-1" id="h50-1" class="h">@@ -36,7 +35,7 @@ import java.lang.reflect.Proxy
</a> import kotlin.math.absoluteValue
 import kotlin.random.Random
 
<a href="#h50-1-3" id="h50-1-3" class="d">-class ComposerHooks: Feature(&quot;ComposerHooks&quot;, loadParams = FeatureLoadParams.INIT_SYNC) {
</a><a href="#h50-1-4" id="h50-1-4" class="i">+class ComposerHooks: Feature(&quot;ComposerHooks&quot;) {
</a>     private val config by lazy { context.config.experimental.nativeHooks.composerHooks }
     private val getImportsFunctionName = Random.nextLong().absoluteValue.toString(16)
 
<b>diff --git a/<a id="h51" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/experiments/ContextMenuFix.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/experiments/ContextMenuFix.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/experiments/ContextMenuFix.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/experiments/ContextMenuFix.kt</a></b>
<a href="#h51-0" id="h51-0" class="h">@@ -2,10 +2,9 @@ package me.rhunk.snapenhance.core.features.impl.experiments
</a> 
 import me.rhunk.snapenhance.core.event.events.impl.UnaryCallEvent
 import me.rhunk.snapenhance.core.features.Feature
<a href="#h51-0-3" id="h51-0-3" class="d">-import me.rhunk.snapenhance.core.features.FeatureLoadParams
</a> import java.nio.ByteBuffer
 
<a href="#h51-0-6" id="h51-0-6" class="d">-class ContextMenuFix: Feature(&quot;Context Menu Fix&quot;, loadParams = FeatureLoadParams.INIT_SYNC) {
</a><a href="#h51-0-7" id="h51-0-7" class="i">+class ContextMenuFix: Feature(&quot;Context Menu Fix&quot;) {
</a>     override fun init() {
         if (!context.config.experimental.contextMenuFix.get()) return
         context.event.subscribe(UnaryCallEvent::class) { event -&gt;
<b>diff --git a/<a id="h52" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/experiments/ConvertMessageLocally.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/experiments/ConvertMessageLocally.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/experiments/ConvertMessageLocally.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/experiments/ConvertMessageLocally.kt</a></b>
<a href="#h52-0" id="h52-0" class="h">@@ -5,13 +5,12 @@ import me.rhunk.snapenhance.common.util.protobuf.ProtoReader
</a> import me.rhunk.snapenhance.common.util.protobuf.ProtoWriter
 import me.rhunk.snapenhance.core.event.events.impl.BuildMessageEvent
 import me.rhunk.snapenhance.core.features.Feature
<a href="#h52-0-3" id="h52-0-3" class="d">-import me.rhunk.snapenhance.core.features.FeatureLoadParams
</a> import me.rhunk.snapenhance.core.features.impl.messaging.Messaging
 import me.rhunk.snapenhance.core.ui.ViewAppearanceHelper
 import me.rhunk.snapenhance.core.wrapper.impl.Message
 import me.rhunk.snapenhance.core.wrapper.impl.MessageContent
 
<a href="#h52-0-9" id="h52-0-9" class="d">-class ConvertMessageLocally : Feature(&quot;Convert Message Edit&quot;, loadParams = FeatureLoadParams.ACTIVITY_CREATE_SYNC) {
</a><a href="#h52-0-10" id="h52-0-10" class="i">+class ConvertMessageLocally : Feature(&quot;Convert Message Edit&quot;) {
</a>     private val messageCache = mutableMapOf&lt;Long, MessageContent&gt;()
 
     private fun dispatchMessageEdit(message: Message, restore: Boolean = false) {
<a href="#h52-1" id="h52-1" class="h">@@ -64,11 +63,13 @@ class ConvertMessageLocally : Feature(&quot;Convert Message Edit&quot;, loadParams = Featu
</a>         }.show()
     }
 
<a href="#h52-1-3" id="h52-1-3" class="d">-    override fun onActivityCreate() {
</a><a href="#h52-1-4" id="h52-1-4" class="d">-        context.event.subscribe(BuildMessageEvent::class, priority = 2) {
</a><a href="#h52-1-5" id="h52-1-5" class="d">-            val clientMessageId = it.message.messageDescriptor?.messageId ?: return@subscribe
</a><a href="#h52-1-6" id="h52-1-6" class="d">-            if (!messageCache.containsKey(clientMessageId)) return@subscribe
</a><a href="#h52-1-7" id="h52-1-7" class="d">-            it.message.messageContent = messageCache[clientMessageId]
</a><a href="#h52-1-8" id="h52-1-8" class="i">+    override fun init() {
</a><a href="#h52-1-9" id="h52-1-9" class="i">+        onNextActivityCreate {
</a><a href="#h52-1-10" id="h52-1-10" class="i">+            context.event.subscribe(BuildMessageEvent::class, priority = 2) {
</a><a href="#h52-1-11" id="h52-1-11" class="i">+                val clientMessageId = it.message.messageDescriptor?.messageId ?: return@subscribe
</a><a href="#h52-1-12" id="h52-1-12" class="i">+                if (!messageCache.containsKey(clientMessageId)) return@subscribe
</a><a href="#h52-1-13" id="h52-1-13" class="i">+                it.message.messageContent = messageCache[clientMessageId]
</a><a href="#h52-1-14" id="h52-1-14" class="i">+            }
</a>         }
     }
 } 
\ No newline at end of file
<b>diff --git a/<a id="h53" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/experiments/DeviceSpooferHook.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/experiments/DeviceSpooferHook.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/experiments/DeviceSpooferHook.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/experiments/DeviceSpooferHook.kt</a></b>
<a href="#h53-0" id="h53-0" class="h">@@ -7,12 +7,11 @@ import android.net.Network
</a> import android.net.NetworkCapabilities
 import android.os.Build
 import me.rhunk.snapenhance.core.features.Feature
<a href="#h53-0-3" id="h53-0-3" class="d">-import me.rhunk.snapenhance.core.features.FeatureLoadParams
</a> import me.rhunk.snapenhance.core.util.LSPatchUpdater
 import me.rhunk.snapenhance.core.util.hook.HookStage
 import me.rhunk.snapenhance.core.util.hook.hook
 
<a href="#h53-0-8" id="h53-0-8" class="d">-class DeviceSpooferHook: Feature(&quot;device_spoofer&quot;, loadParams = FeatureLoadParams.INIT_SYNC)  {
</a><a href="#h53-0-9" id="h53-0-9" class="i">+class DeviceSpooferHook: Feature(&quot;Device Spoofer&quot;)  {
</a> 	private fun hookInstallerPackageName() {
 		context.androidContext.packageManager::class.java.hook(&quot;getInstallerPackageName&quot;, HookStage.BEFORE) { param -&gt;
 			param.setResult(&quot;com.android.vending&quot;)
<b>diff --git a/<a id="h54" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/experiments/EndToEndEncryption.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/experiments/EndToEndEncryption.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/experiments/EndToEndEncryption.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/experiments/EndToEndEncryption.kt</a></b>
<a href="#h54-0" id="h54-0" class="h">@@ -33,7 +33,6 @@ import me.rhunk.snapenhance.core.event.events.impl.BindViewEvent
</a> import me.rhunk.snapenhance.core.event.events.impl.BuildMessageEvent
 import me.rhunk.snapenhance.core.event.events.impl.NativeUnaryCallEvent
 import me.rhunk.snapenhance.core.event.events.impl.SendMessageWithContentEvent
<a href="#h54-0-3" id="h54-0-3" class="d">-import me.rhunk.snapenhance.core.features.FeatureLoadParams
</a> import me.rhunk.snapenhance.core.features.MessagingRuleFeature
 import me.rhunk.snapenhance.core.features.impl.ui.ConversationToolbox
 import me.rhunk.snapenhance.core.ui.ViewAppearanceHelper
<a href="#h54-1" id="h54-1" class="h">@@ -55,8 +54,7 @@ import kotlin.random.Random
</a> 
 class EndToEndEncryption : MessagingRuleFeature(
     &quot;EndToEndEncryption&quot;,
<a href="#h54-1-3" id="h54-1-3" class="d">-    MessagingRuleType.E2E_ENCRYPTION,
</a><a href="#h54-1-4" id="h54-1-4" class="d">-    loadParams = FeatureLoadParams.ACTIVITY_CREATE_SYNC or FeatureLoadParams.INIT_SYNC or FeatureLoadParams.INIT_ASYNC
</a><a href="#h54-1-5" id="h54-1-5" class="i">+    MessagingRuleType.E2E_ENCRYPTION
</a> ) {
     val isEnabled get() = context.config.experimental.e2eEncryption.globalState == true
     private val e2eeInterface by lazyBridge { context.bridgeClient.getE2eeInterface() }
<a href="#h54-2" id="h54-2" class="h">@@ -174,96 +172,223 @@ class EndToEndEncryption : MessagingRuleFeature(
</a>     }
 
     @SuppressLint(&quot;SetTextI18n&quot;, &quot;DiscouragedApi&quot;)
<a href="#h54-2-3" id="h54-2-3" class="d">-    override fun onActivityCreate() {
</a><a href="#h54-2-4" id="h54-2-4" class="i">+    override fun init() {
</a>         if (!isEnabled) return
 
<a href="#h54-2-7" id="h54-2-7" class="d">-        context.feature(ConversationToolbox::class).addComposable(translation[&quot;confirmation_dialogs.title&quot;], filter = {
</a><a href="#h54-2-8" id="h54-2-8" class="d">-            context.database.getDMOtherParticipant(it) != null
</a><a href="#h54-2-9" id="h54-2-9" class="d">-        }) { dialog, conversationId -&gt;
</a><a href="#h54-2-10" id="h54-2-10" class="d">-            val friendId = remember {
</a><a href="#h54-2-11" id="h54-2-11" class="d">-                context.database.getDMOtherParticipant(conversationId)
</a><a href="#h54-2-12" id="h54-2-12" class="d">-            } ?: return@addComposable
</a><a href="#h54-2-13" id="h54-2-13" class="d">-            val fingerprint = remember {
</a><a href="#h54-2-14" id="h54-2-14" class="d">-                runCatching {
</a><a href="#h54-2-15" id="h54-2-15" class="d">-                    e2eeInterface.getSecretFingerprint(friendId)
</a><a href="#h54-2-16" id="h54-2-16" class="d">-                }.getOrNull()
</a><a href="#h54-2-17" id="h54-2-17" class="d">-            }
</a><a href="#h54-2-18" id="h54-2-18" class="d">-            if (fingerprint != null) {
</a><a href="#h54-2-19" id="h54-2-19" class="d">-                Text(translation.format(&quot;toolbox.shared_key_fingerprint&quot;, &quot;fingerprint&quot; to fingerprint))
</a><a href="#h54-2-20" id="h54-2-20" class="d">-            } else {
</a><a href="#h54-2-21" id="h54-2-21" class="d">-                Text(translation[&quot;toolbox.no_shared_key&quot;])
</a><a href="#h54-2-22" id="h54-2-22" class="d">-            }
</a><a href="#h54-2-23" id="h54-2-23" class="d">-            Spacer(modifier = Modifier.height(10.dp))
</a><a href="#h54-2-24" id="h54-2-24" class="d">-            Button(onClick = {
</a><a href="#h54-2-25" id="h54-2-25" class="d">-                dialog.dismiss()
</a><a href="#h54-2-26" id="h54-2-26" class="d">-                warnKeyOverwrite(friendId) {
</a><a href="#h54-2-27" id="h54-2-27" class="d">-                    askForKeys(conversationId)
</a><a href="#h54-2-28" id="h54-2-28" class="i">+        context.mappings.useMapper(CallbackMapper::class) {
</a><a href="#h54-2-29" id="h54-2-29" class="i">+            callbacks.getClass(&quot;ConversationManagerDelegate&quot;)?.hook(&quot;onSendComplete&quot;, HookStage.BEFORE) { param -&gt;
</a><a href="#h54-2-30" id="h54-2-30" class="i">+                val sendMessageResult = param.arg&lt;Any&gt;(0)
</a><a href="#h54-2-31" id="h54-2-31" class="i">+                val messageDestinations = MessageDestinations(sendMessageResult.getObjectField(&quot;mCompletedDestinations&quot;) ?: return@hook)
</a><a href="#h54-2-32" id="h54-2-32" class="i">+                if (messageDestinations.mPhoneNumbers?.isNotEmpty() == true || messageDestinations.stories?.isNotEmpty() == true) return@hook
</a><a href="#h54-2-33" id="h54-2-33" class="i">+
</a><a href="#h54-2-34" id="h54-2-34" class="i">+                val completedConversationDestinations = sendMessageResult.getObjectField(&quot;mCompletedConversationDestinations&quot;) as? ArrayList&lt;*&gt; ?: return@hook
</a><a href="#h54-2-35" id="h54-2-35" class="i">+                val messageIds = completedConversationDestinations.filter { getState(SnapUUID(it.getObjectField(&quot;mConversationId&quot;)).toString()) }.mapNotNull {
</a><a href="#h54-2-36" id="h54-2-36" class="i">+                    it.getObjectFieldOrNull(&quot;mMessageId&quot;) as? Long
</a>                 }
<a href="#h54-2-38" id="h54-2-38" class="d">-            }) {
</a><a href="#h54-2-39" id="h54-2-39" class="d">-                Text(translation[&quot;toolbox.initiate_exchange_button&quot;])
</a><a href="#h54-2-40" id="h54-2-40" class="i">+
</a><a href="#h54-2-41" id="h54-2-41" class="i">+                encryptedMessages.addAll(messageIds)
</a>             }
         }
 
<a href="#h54-2-45" id="h54-2-45" class="d">-        val encryptedMessageIndicator by context.config.experimental.e2eEncryption.encryptedMessageIndicator
</a><a href="#h54-2-46" id="h54-2-46" class="d">-
</a><a href="#h54-2-47" id="h54-2-47" class="d">-        val specialCard = Random.nextLong().toString(16)
</a><a href="#h54-2-48" id="h54-2-48" class="i">+        context.event.subscribe(BuildMessageEvent::class, priority = 0) { event -&gt;
</a><a href="#h54-2-49" id="h54-2-49" class="i">+            val message = event.message
</a><a href="#h54-2-50" id="h54-2-50" class="i">+            val conversationId = message.messageDescriptor!!.conversationId.toString()
</a><a href="#h54-2-51" id="h54-2-51" class="i">+            val isMessageCommitted = message.messageState == MessageState.COMMITTED
</a><a href="#h54-2-52" id="h54-2-52" class="i">+            messageHook(
</a><a href="#h54-2-53" id="h54-2-53" class="i">+                conversationId = conversationId,
</a><a href="#h54-2-54" id="h54-2-54" class="i">+                messageId = message.messageDescriptor!!.messageId!!,
</a><a href="#h54-2-55" id="h54-2-55" class="i">+                senderId = message.senderId.toString(),
</a><a href="#h54-2-56" id="h54-2-56" class="i">+                messageContent = message.messageContent!!,
</a><a href="#h54-2-57" id="h54-2-57" class="i">+                committed = isMessageCommitted
</a><a href="#h54-2-58" id="h54-2-58" class="i">+            )
</a> 
<a href="#h54-2-60" id="h54-2-60" class="d">-        context.event.subscribe(BindViewEvent::class) { event -&gt;
</a><a href="#h54-2-61" id="h54-2-61" class="d">-            event.chatMessage { conversationId, messageId -&gt;
</a><a href="#h54-2-62" id="h54-2-62" class="d">-                val viewGroup = event.view.parent as? ViewGroup ?: return@subscribe
</a><a href="#h54-2-63" id="h54-2-63" class="i">+            message.messageContent!!.instanceNonNull()
</a><a href="#h54-2-64" id="h54-2-64" class="i">+                .getObjectField(&quot;mQuotedMessage&quot;)
</a><a href="#h54-2-65" id="h54-2-65" class="i">+                ?.getObjectField(&quot;mContent&quot;)
</a><a href="#h54-2-66" id="h54-2-66" class="i">+                ?.also { quotedMessage -&gt;
</a><a href="#h54-2-67" id="h54-2-67" class="i">+                    messageHook(
</a><a href="#h54-2-68" id="h54-2-68" class="i">+                        conversationId = conversationId,
</a><a href="#h54-2-69" id="h54-2-69" class="i">+                        messageId = quotedMessage.getObjectField(&quot;mMessageId&quot;)?.toString()?.toLong() ?: return@also,
</a><a href="#h54-2-70" id="h54-2-70" class="i">+                        senderId = SnapUUID(quotedMessage.getObjectField(&quot;mSenderId&quot;)).toString(),
</a><a href="#h54-2-71" id="h54-2-71" class="i">+                        messageContent = MessageContent(quotedMessage),
</a><a href="#h54-2-72" id="h54-2-72" class="i">+                        committed = isMessageCommitted
</a><a href="#h54-2-73" id="h54-2-73" class="i">+                    )
</a><a href="#h54-2-74" id="h54-2-74" class="i">+                }
</a><a href="#h54-2-75" id="h54-2-75" class="i">+        }
</a> 
<a href="#h54-2-77" id="h54-2-77" class="d">-                viewGroup.findViewWithTag&lt;View&gt;(specialCard)?.also {
</a><a href="#h54-2-78" id="h54-2-78" class="d">-                    viewGroup.removeView(it)
</a><a href="#h54-2-79" id="h54-2-79" class="i">+        onNextActivityCreate(defer = true) {
</a><a href="#h54-2-80" id="h54-2-80" class="i">+            context.feature(ConversationToolbox::class).addComposable(translation[&quot;confirmation_dialogs.title&quot;], filter = {
</a><a href="#h54-2-81" id="h54-2-81" class="i">+                context.database.getDMOtherParticipant(it) != null
</a><a href="#h54-2-82" id="h54-2-82" class="i">+            }) { dialog, conversationId -&gt;
</a><a href="#h54-2-83" id="h54-2-83" class="i">+                val friendId = remember {
</a><a href="#h54-2-84" id="h54-2-84" class="i">+                    context.database.getDMOtherParticipant(conversationId)
</a><a href="#h54-2-85" id="h54-2-85" class="i">+                } ?: return@addComposable
</a><a href="#h54-2-86" id="h54-2-86" class="i">+                val fingerprint = remember {
</a><a href="#h54-2-87" id="h54-2-87" class="i">+                    runCatching {
</a><a href="#h54-2-88" id="h54-2-88" class="i">+                        e2eeInterface.getSecretFingerprint(friendId)
</a><a href="#h54-2-89" id="h54-2-89" class="i">+                    }.getOrNull()
</a><a href="#h54-2-90" id="h54-2-90" class="i">+                }
</a><a href="#h54-2-91" id="h54-2-91" class="i">+                if (fingerprint != null) {
</a><a href="#h54-2-92" id="h54-2-92" class="i">+                    Text(translation.format(&quot;toolbox.shared_key_fingerprint&quot;, &quot;fingerprint&quot; to fingerprint))
</a><a href="#h54-2-93" id="h54-2-93" class="i">+                } else {
</a><a href="#h54-2-94" id="h54-2-94" class="i">+                    Text(translation[&quot;toolbox.no_shared_key&quot;])
</a><a href="#h54-2-95" id="h54-2-95" class="i">+                }
</a><a href="#h54-2-96" id="h54-2-96" class="i">+                Spacer(modifier = Modifier.height(10.dp))
</a><a href="#h54-2-97" id="h54-2-97" class="i">+                Button(onClick = {
</a><a href="#h54-2-98" id="h54-2-98" class="i">+                    dialog.dismiss()
</a><a href="#h54-2-99" id="h54-2-99" class="i">+                    warnKeyOverwrite(friendId) {
</a><a href="#h54-2-100" id="h54-2-100" class="i">+                        askForKeys(conversationId)
</a><a href="#h54-2-101" id="h54-2-101" class="i">+                    }
</a><a href="#h54-2-102" id="h54-2-102" class="i">+                }) {
</a><a href="#h54-2-103" id="h54-2-103" class="i">+                    Text(translation[&quot;toolbox.initiate_exchange_button&quot;])
</a>                 }
<a href="#h54-2-105" id="h54-2-105" class="i">+            }
</a> 
<a href="#h54-2-107" id="h54-2-107" class="d">-                if (encryptedMessageIndicator) {
</a><a href="#h54-2-108" id="h54-2-108" class="d">-                    viewGroup.removeForegroundDrawable(&quot;encryptedMessage&quot;)
</a><a href="#h54-2-109" id="h54-2-109" class="i">+            val encryptedMessageIndicator by context.config.experimental.e2eEncryption.encryptedMessageIndicator
</a> 
<a href="#h54-2-111" id="h54-2-111" class="d">-                    if (encryptedMessages.contains(messageId.toLong())) {
</a><a href="#h54-2-112" id="h54-2-112" class="d">-                        viewGroup.addForegroundDrawable(&quot;encryptedMessage&quot;, ShapeDrawable(object: Shape() {
</a><a href="#h54-2-113" id="h54-2-113" class="d">-                            override fun draw(canvas: Canvas, paint: Paint) {
</a><a href="#h54-2-114" id="h54-2-114" class="d">-                                paint.textSize = 20f
</a><a href="#h54-2-115" id="h54-2-115" class="d">-                                canvas.drawText(&quot;\uD83D\uDD12&quot;, 0f, canvas.height / 2f, paint)
</a><a href="#h54-2-116" id="h54-2-116" class="d">-                            }
</a><a href="#h54-2-117" id="h54-2-117" class="d">-                        }))
</a><a href="#h54-2-118" id="h54-2-118" class="i">+            val specialCard = Random.nextLong().toString(16)
</a><a href="#h54-2-119" id="h54-2-119" class="i">+
</a><a href="#h54-2-120" id="h54-2-120" class="i">+            context.event.subscribe(BindViewEvent::class) { event -&gt;
</a><a href="#h54-2-121" id="h54-2-121" class="i">+                event.chatMessage { conversationId, messageId -&gt;
</a><a href="#h54-2-122" id="h54-2-122" class="i">+                    val viewGroup = event.view.parent as? ViewGroup ?: return@subscribe
</a><a href="#h54-2-123" id="h54-2-123" class="i">+
</a><a href="#h54-2-124" id="h54-2-124" class="i">+                    viewGroup.findViewWithTag&lt;View&gt;(specialCard)?.also {
</a><a href="#h54-2-125" id="h54-2-125" class="i">+                        viewGroup.removeView(it)
</a>                     }
<a href="#h54-2-127" id="h54-2-127" class="d">-                }
</a> 
<a href="#h54-2-129" id="h54-2-129" class="d">-                val secret = secretResponses[messageId.toLong()]
</a><a href="#h54-2-130" id="h54-2-130" class="d">-                val publicKey = pkRequests[messageId.toLong()]
</a><a href="#h54-2-131" id="h54-2-131" class="i">+                    if (encryptedMessageIndicator) {
</a><a href="#h54-2-132" id="h54-2-132" class="i">+                        viewGroup.removeForegroundDrawable(&quot;encryptedMessage&quot;)
</a> 
<a href="#h54-2-134" id="h54-2-134" class="d">-                if (publicKey != null || secret != null) {
</a><a href="#h54-2-135" id="h54-2-135" class="d">-                    viewGroup.addView(createComposeView(context.mainActivity!!) {
</a><a href="#h54-2-136" id="h54-2-136" class="d">-                        Card(
</a><a href="#h54-2-137" id="h54-2-137" class="d">-                            modifier = Modifier.fillMaxWidth().padding(8.dp),
</a><a href="#h54-2-138" id="h54-2-138" class="d">-                            onClick = {
</a><a href="#h54-2-139" id="h54-2-139" class="d">-                                if (publicKey != null) {
</a><a href="#h54-2-140" id="h54-2-140" class="d">-                                    handlePublicKeyRequest(conversationId, publicKey)
</a><a href="#h54-2-141" id="h54-2-141" class="i">+                        if (encryptedMessages.contains(messageId.toLong())) {
</a><a href="#h54-2-142" id="h54-2-142" class="i">+                            viewGroup.addForegroundDrawable(&quot;encryptedMessage&quot;, ShapeDrawable(object: Shape() {
</a><a href="#h54-2-143" id="h54-2-143" class="i">+                                override fun draw(canvas: Canvas, paint: Paint) {
</a><a href="#h54-2-144" id="h54-2-144" class="i">+                                    paint.textSize = 20f
</a><a href="#h54-2-145" id="h54-2-145" class="i">+                                    canvas.drawText(&quot;\uD83D\uDD12&quot;, 0f, canvas.height / 2f, paint)
</a>                                 }
<a href="#h54-2-147" id="h54-2-147" class="d">-                                if (secret != null) {
</a><a href="#h54-2-148" id="h54-2-148" class="d">-                                    handleSecretResponse(conversationId, secret)
</a><a href="#h54-2-149" id="h54-2-149" class="i">+                            }))
</a><a href="#h54-2-150" id="h54-2-150" class="i">+                        }
</a><a href="#h54-2-151" id="h54-2-151" class="i">+                    }
</a><a href="#h54-2-152" id="h54-2-152" class="i">+
</a><a href="#h54-2-153" id="h54-2-153" class="i">+                    val secret = secretResponses[messageId.toLong()]
</a><a href="#h54-2-154" id="h54-2-154" class="i">+                    val publicKey = pkRequests[messageId.toLong()]
</a><a href="#h54-2-155" id="h54-2-155" class="i">+
</a><a href="#h54-2-156" id="h54-2-156" class="i">+                    if (publicKey != null || secret != null) {
</a><a href="#h54-2-157" id="h54-2-157" class="i">+                        viewGroup.addView(createComposeView(context.mainActivity!!) {
</a><a href="#h54-2-158" id="h54-2-158" class="i">+                            Card(
</a><a href="#h54-2-159" id="h54-2-159" class="i">+                                modifier = Modifier.fillMaxWidth().padding(8.dp),
</a><a href="#h54-2-160" id="h54-2-160" class="i">+                                onClick = {
</a><a href="#h54-2-161" id="h54-2-161" class="i">+                                    if (publicKey != null) {
</a><a href="#h54-2-162" id="h54-2-162" class="i">+                                        handlePublicKeyRequest(conversationId, publicKey)
</a><a href="#h54-2-163" id="h54-2-163" class="i">+                                    }
</a><a href="#h54-2-164" id="h54-2-164" class="i">+                                    if (secret != null) {
</a><a href="#h54-2-165" id="h54-2-165" class="i">+                                        handleSecretResponse(conversationId, secret)
</a><a href="#h54-2-166" id="h54-2-166" class="i">+                                    }
</a>                                 }
<a href="#h54-2-168" id="h54-2-168" class="d">-                            }
</a><a href="#h54-2-169" id="h54-2-169" class="d">-                        ) {
</a><a href="#h54-2-170" id="h54-2-170" class="d">-                            Box(
</a><a href="#h54-2-171" id="h54-2-171" class="d">-                                modifier = Modifier.fillMaxWidth().padding(5.dp),
</a><a href="#h54-2-172" id="h54-2-172" class="d">-                                contentAlignment = Alignment.Center
</a>                             ) {
<a href="#h54-2-174" id="h54-2-174" class="d">-                                if (publicKey != null) {
</a><a href="#h54-2-175" id="h54-2-175" class="d">-                                    Text(translation[&quot;accept_public_key_button&quot;])
</a><a href="#h54-2-176" id="h54-2-176" class="d">-                                }
</a><a href="#h54-2-177" id="h54-2-177" class="d">-                                if (secret != null) {
</a><a href="#h54-2-178" id="h54-2-178" class="d">-                                    Text(translation[&quot;accept_secret_button&quot;])
</a><a href="#h54-2-179" id="h54-2-179" class="i">+                                Box(
</a><a href="#h54-2-180" id="h54-2-180" class="i">+                                    modifier = Modifier.fillMaxWidth().padding(5.dp),
</a><a href="#h54-2-181" id="h54-2-181" class="i">+                                    contentAlignment = Alignment.Center
</a><a href="#h54-2-182" id="h54-2-182" class="i">+                                ) {
</a><a href="#h54-2-183" id="h54-2-183" class="i">+                                    if (publicKey != null) {
</a><a href="#h54-2-184" id="h54-2-184" class="i">+                                        Text(translation[&quot;accept_public_key_button&quot;])
</a><a href="#h54-2-185" id="h54-2-185" class="i">+                                    }
</a><a href="#h54-2-186" id="h54-2-186" class="i">+                                    if (secret != null) {
</a><a href="#h54-2-187" id="h54-2-187" class="i">+                                        Text(translation[&quot;accept_secret_button&quot;])
</a><a href="#h54-2-188" id="h54-2-188" class="i">+                                    }
</a>                                 }
                             }
<a href="#h54-2-191" id="h54-2-191" class="i">+                        }.apply {
</a><a href="#h54-2-192" id="h54-2-192" class="i">+                            tag = specialCard
</a><a href="#h54-2-193" id="h54-2-193" class="i">+                            layoutParams = ViewGroup.LayoutParams(
</a><a href="#h54-2-194" id="h54-2-194" class="i">+                                ViewGroup.LayoutParams.MATCH_PARENT,
</a><a href="#h54-2-195" id="h54-2-195" class="i">+                                ViewGroup.LayoutParams.WRAP_CONTENT,
</a><a href="#h54-2-196" id="h54-2-196" class="i">+                            )
</a><a href="#h54-2-197" id="h54-2-197" class="i">+                        })
</a><a href="#h54-2-198" id="h54-2-198" class="i">+                    }
</a><a href="#h54-2-199" id="h54-2-199" class="i">+                }
</a><a href="#h54-2-200" id="h54-2-200" class="i">+            }
</a><a href="#h54-2-201" id="h54-2-201" class="i">+        }
</a><a href="#h54-2-202" id="h54-2-202" class="i">+
</a><a href="#h54-2-203" id="h54-2-203" class="i">+        defer {
</a><a href="#h54-2-204" id="h54-2-204" class="i">+            val forceMessageEncryption by context.config.experimental.e2eEncryption.forceMessageEncryption
</a><a href="#h54-2-205" id="h54-2-205" class="i">+
</a><a href="#h54-2-206" id="h54-2-206" class="i">+            context.mappings.useMapper(CallbackMapper::class) {
</a><a href="#h54-2-207" id="h54-2-207" class="i">+                callbacks.getClass(&quot;UploadDelegate&quot;)?.hook(&quot;uploadMedia&quot;, HookStage.BEFORE) { param -&gt;
</a><a href="#h54-2-208" id="h54-2-208" class="i">+                    val messageDestinations = MessageDestinations(param.arg(1))
</a><a href="#h54-2-209" id="h54-2-209" class="i">+                    val uploadCallback = param.arg&lt;Any&gt;(2)
</a><a href="#h54-2-210" id="h54-2-210" class="i">+                    val e2eeConversations = messageDestinations.getEndToEndConversations()
</a><a href="#h54-2-211" id="h54-2-211" class="i">+                    if (e2eeConversations.isEmpty()) return@hook
</a><a href="#h54-2-212" id="h54-2-212" class="i">+
</a><a href="#h54-2-213" id="h54-2-213" class="i">+                    if (messageDestinations.conversations!!.size != e2eeConversations.size || messageDestinations.stories?.isNotEmpty() == true) {
</a><a href="#h54-2-214" id="h54-2-214" class="i">+                        context.log.debug(&quot;skipping encryption&quot;)
</a><a href="#h54-2-215" id="h54-2-215" class="i">+                        return@hook
</a><a href="#h54-2-216" id="h54-2-216" class="i">+                    }
</a><a href="#h54-2-217" id="h54-2-217" class="i">+
</a><a href="#h54-2-218" id="h54-2-218" class="i">+                    Hooker.hookObjectMethod(uploadCallback::class.java, uploadCallback, &quot;onUploadFinished&quot;, HookStage.BEFORE) { methodParam -&gt;
</a><a href="#h54-2-219" id="h54-2-219" class="i">+                        val messageContent = MessageContent(methodParam.arg(1))
</a><a href="#h54-2-220" id="h54-2-220" class="i">+                        runCatching {
</a><a href="#h54-2-221" id="h54-2-221" class="i">+                            messageContent.content = ProtoWriter().apply {
</a><a href="#h54-2-222" id="h54-2-222" class="i">+                                writeEncryptedMessage(e2eeConversations.map { getE2EParticipants(it) }.flatten().distinct(), messageContent.content!!)
</a><a href="#h54-2-223" id="h54-2-223" class="i">+                            }.toByteArray()
</a><a href="#h54-2-224" id="h54-2-224" class="i">+                        }.onFailure {
</a><a href="#h54-2-225" id="h54-2-225" class="i">+                            context.log.error(&quot;Failed to encrypt message&quot;, it)
</a><a href="#h54-2-226" id="h54-2-226" class="i">+                            context.longToast(translation[&quot;encryption_failed_toast&quot;])
</a><a href="#h54-2-227" id="h54-2-227" class="i">+                        }
</a><a href="#h54-2-228" id="h54-2-228" class="i">+                    }
</a><a href="#h54-2-229" id="h54-2-229" class="i">+                }
</a><a href="#h54-2-230" id="h54-2-230" class="i">+            }
</a><a href="#h54-2-231" id="h54-2-231" class="i">+
</a><a href="#h54-2-232" id="h54-2-232" class="i">+            // trick to disable fidelius encryption
</a><a href="#h54-2-233" id="h54-2-233" class="i">+            context.event.subscribe(SendMessageWithContentEvent::class) { event -&gt;
</a><a href="#h54-2-234" id="h54-2-234" class="i">+                val messageContent = event.messageContent
</a><a href="#h54-2-235" id="h54-2-235" class="i">+                val destinations = event.destinations
</a><a href="#h54-2-236" id="h54-2-236" class="i">+
</a><a href="#h54-2-237" id="h54-2-237" class="i">+                val e2eeConversations = destinations.getEndToEndConversations().takeIf { it.isNotEmpty() } ?: return@subscribe
</a><a href="#h54-2-238" id="h54-2-238" class="i">+
</a><a href="#h54-2-239" id="h54-2-239" class="i">+                if (e2eeConversations.size != destinations.conversations!!.size || destinations.stories?.isNotEmpty() == true) {
</a><a href="#h54-2-240" id="h54-2-240" class="i">+                    if (!forceMessageEncryption) return@subscribe
</a><a href="#h54-2-241" id="h54-2-241" class="i">+                    context.longToast(translation[&quot;unencrypted_conversation_send_failure_toast&quot;])
</a><a href="#h54-2-242" id="h54-2-242" class="i">+                    event.canceled = true
</a><a href="#h54-2-243" id="h54-2-243" class="i">+                    return@subscribe
</a><a href="#h54-2-244" id="h54-2-244" class="i">+                }
</a><a href="#h54-2-245" id="h54-2-245" class="i">+
</a><a href="#h54-2-246" id="h54-2-246" class="i">+                if (!NativeLib.initialized) {
</a><a href="#h54-2-247" id="h54-2-247" class="i">+                    context.longToast(translation[&quot;native_hooks_send_failure_toast&quot;])
</a><a href="#h54-2-248" id="h54-2-248" class="i">+                    event.canceled = true
</a><a href="#h54-2-249" id="h54-2-249" class="i">+                    return@subscribe
</a><a href="#h54-2-250" id="h54-2-250" class="i">+                }
</a><a href="#h54-2-251" id="h54-2-251" class="i">+
</a><a href="#h54-2-252" id="h54-2-252" class="i">+                event.addInvokeLater {
</a><a href="#h54-2-253" id="h54-2-253" class="i">+                    if (event.messageContent.localMediaReferences?.isEmpty() == true) {
</a><a href="#h54-2-254" id="h54-2-254" class="i">+                        runCatching {
</a><a href="#h54-2-255" id="h54-2-255" class="i">+                            event.messageContent.content = ProtoWriter().apply {
</a><a href="#h54-2-256" id="h54-2-256" class="i">+                                writeEncryptedMessage(e2eeConversations.map { getE2EParticipants(it) }.flatten().distinct(), messageContent.content!!)
</a><a href="#h54-2-257" id="h54-2-257" class="i">+                            }.toByteArray()
</a><a href="#h54-2-258" id="h54-2-258" class="i">+                        }.onFailure {
</a><a href="#h54-2-259" id="h54-2-259" class="i">+                            context.log.error(&quot;Failed to encrypt message&quot;, it)
</a><a href="#h54-2-260" id="h54-2-260" class="i">+                            context.longToast(translation[&quot;encryption_failed_toast&quot;])
</a>                         }
<a href="#h54-2-262" id="h54-2-262" class="d">-                    }.apply {
</a><a href="#h54-2-263" id="h54-2-263" class="d">-                        tag = specialCard
</a><a href="#h54-2-264" id="h54-2-264" class="d">-                        layoutParams = ViewGroup.LayoutParams(
</a><a href="#h54-2-265" id="h54-2-265" class="d">-                            ViewGroup.LayoutParams.MATCH_PARENT,
</a><a href="#h54-2-266" id="h54-2-266" class="d">-                            ViewGroup.LayoutParams.WRAP_CONTENT,
</a><a href="#h54-2-267" id="h54-2-267" class="d">-                        )
</a><a href="#h54-2-268" id="h54-2-268" class="d">-                    })
</a><a href="#h54-2-269" id="h54-2-269" class="i">+                    }
</a><a href="#h54-2-270" id="h54-2-270" class="i">+
</a><a href="#h54-2-271" id="h54-2-271" class="i">+                    if (event.messageContent.contentType == ContentType.SNAP) {
</a><a href="#h54-2-272" id="h54-2-272" class="i">+                        event.messageContent.contentType = ContentType.EXTERNAL_MEDIA
</a><a href="#h54-2-273" id="h54-2-273" class="i">+                    }
</a><a href="#h54-2-274" id="h54-2-274" class="i">+                }
</a><a href="#h54-2-275" id="h54-2-275" class="i">+            }
</a><a href="#h54-2-276" id="h54-2-276" class="i">+
</a><a href="#h54-2-277" id="h54-2-277" class="i">+            context.event.subscribe(NativeUnaryCallEvent::class) { event -&gt;
</a><a href="#h54-2-278" id="h54-2-278" class="i">+                if (event.uri != &quot;/messagingcoreservice.MessagingCoreService/CreateContentMessage&quot;) return@subscribe
</a><a href="#h54-2-279" id="h54-2-279" class="i">+                val protoReader = ProtoReader(event.buffer)
</a><a href="#h54-2-280" id="h54-2-280" class="i">+                val messageReader = protoReader.followPath(4) ?: return@subscribe
</a><a href="#h54-2-281" id="h54-2-281" class="i">+
</a><a href="#h54-2-282" id="h54-2-282" class="i">+                if (messageReader.getVarInt(4, 2, 1, 5) == 1L) {
</a><a href="#h54-2-283" id="h54-2-283" class="i">+                    event.buffer = ProtoEditor(event.buffer).apply {
</a><a href="#h54-2-284" id="h54-2-284" class="i">+                        edit(4) {
</a><a href="#h54-2-285" id="h54-2-285" class="i">+                            remove(2)
</a><a href="#h54-2-286" id="h54-2-286" class="i">+                            addVarInt(2, ContentType.SNAP.id)
</a><a href="#h54-2-287" id="h54-2-287" class="i">+                            context.log.verbose(&quot;fixed snap content type&quot;)
</a><a href="#h54-2-288" id="h54-2-288" class="i">+                        }
</a><a href="#h54-2-289" id="h54-2-289" class="i">+                    }.toByteArray()
</a>                 }
             }
         }
<a href="#h54-3" id="h54-3" class="h">@@ -440,135 +565,5 @@ class EndToEndEncryption : MessagingRuleFeature(
</a>         return conversations!!.filter { getState(it.toString()) &amp;&amp; getE2EParticipants(it.toString()).isNotEmpty() }.map { it.toString() }
     }
 
<a href="#h54-3-3" id="h54-3-3" class="d">-    override fun asyncInit() {
</a><a href="#h54-3-4" id="h54-3-4" class="d">-        if (!isEnabled) return
</a><a href="#h54-3-5" id="h54-3-5" class="d">-        val forceMessageEncryption by context.config.experimental.e2eEncryption.forceMessageEncryption
</a><a href="#h54-3-6" id="h54-3-6" class="d">-
</a><a href="#h54-3-7" id="h54-3-7" class="d">-        context.mappings.useMapper(CallbackMapper::class) {
</a><a href="#h54-3-8" id="h54-3-8" class="d">-            callbacks.getClass(&quot;UploadDelegate&quot;)?.hook(&quot;uploadMedia&quot;, HookStage.BEFORE) { param -&gt;
</a><a href="#h54-3-9" id="h54-3-9" class="d">-                val messageDestinations = MessageDestinations(param.arg(1))
</a><a href="#h54-3-10" id="h54-3-10" class="d">-                val uploadCallback = param.arg&lt;Any&gt;(2)
</a><a href="#h54-3-11" id="h54-3-11" class="d">-                val e2eeConversations = messageDestinations.getEndToEndConversations()
</a><a href="#h54-3-12" id="h54-3-12" class="d">-                if (e2eeConversations.isEmpty()) return@hook
</a><a href="#h54-3-13" id="h54-3-13" class="d">-
</a><a href="#h54-3-14" id="h54-3-14" class="d">-                if (messageDestinations.conversations!!.size != e2eeConversations.size || messageDestinations.stories?.isNotEmpty() == true) {
</a><a href="#h54-3-15" id="h54-3-15" class="d">-                    context.log.debug(&quot;skipping encryption&quot;)
</a><a href="#h54-3-16" id="h54-3-16" class="d">-                    return@hook
</a><a href="#h54-3-17" id="h54-3-17" class="d">-                }
</a><a href="#h54-3-18" id="h54-3-18" class="d">-
</a><a href="#h54-3-19" id="h54-3-19" class="d">-                Hooker.hookObjectMethod(uploadCallback::class.java, uploadCallback, &quot;onUploadFinished&quot;, HookStage.BEFORE) { methodParam -&gt;
</a><a href="#h54-3-20" id="h54-3-20" class="d">-                    val messageContent = MessageContent(methodParam.arg(1))
</a><a href="#h54-3-21" id="h54-3-21" class="d">-                    runCatching {
</a><a href="#h54-3-22" id="h54-3-22" class="d">-                        messageContent.content = ProtoWriter().apply {
</a><a href="#h54-3-23" id="h54-3-23" class="d">-                            writeEncryptedMessage(e2eeConversations.map { getE2EParticipants(it) }.flatten().distinct(), messageContent.content!!)
</a><a href="#h54-3-24" id="h54-3-24" class="d">-                        }.toByteArray()
</a><a href="#h54-3-25" id="h54-3-25" class="d">-                    }.onFailure {
</a><a href="#h54-3-26" id="h54-3-26" class="d">-                        context.log.error(&quot;Failed to encrypt message&quot;, it)
</a><a href="#h54-3-27" id="h54-3-27" class="d">-                        context.longToast(translation[&quot;encryption_failed_toast&quot;])
</a><a href="#h54-3-28" id="h54-3-28" class="d">-                    }
</a><a href="#h54-3-29" id="h54-3-29" class="d">-                }
</a><a href="#h54-3-30" id="h54-3-30" class="d">-            }
</a><a href="#h54-3-31" id="h54-3-31" class="d">-        }
</a><a href="#h54-3-32" id="h54-3-32" class="d">-
</a><a href="#h54-3-33" id="h54-3-33" class="d">-        // trick to disable fidelius encryption
</a><a href="#h54-3-34" id="h54-3-34" class="d">-        context.event.subscribe(SendMessageWithContentEvent::class) { event -&gt;
</a><a href="#h54-3-35" id="h54-3-35" class="d">-            val messageContent = event.messageContent
</a><a href="#h54-3-36" id="h54-3-36" class="d">-            val destinations = event.destinations
</a><a href="#h54-3-37" id="h54-3-37" class="d">-
</a><a href="#h54-3-38" id="h54-3-38" class="d">-            val e2eeConversations = destinations.getEndToEndConversations().takeIf { it.isNotEmpty() } ?: return@subscribe
</a><a href="#h54-3-39" id="h54-3-39" class="d">-
</a><a href="#h54-3-40" id="h54-3-40" class="d">-            if (e2eeConversations.size != destinations.conversations!!.size || destinations.stories?.isNotEmpty() == true) {
</a><a href="#h54-3-41" id="h54-3-41" class="d">-                if (!forceMessageEncryption) return@subscribe
</a><a href="#h54-3-42" id="h54-3-42" class="d">-                context.longToast(translation[&quot;unencrypted_conversation_send_failure_toast&quot;])
</a><a href="#h54-3-43" id="h54-3-43" class="d">-                event.canceled = true
</a><a href="#h54-3-44" id="h54-3-44" class="d">-                return@subscribe
</a><a href="#h54-3-45" id="h54-3-45" class="d">-            }
</a><a href="#h54-3-46" id="h54-3-46" class="d">-
</a><a href="#h54-3-47" id="h54-3-47" class="d">-            if (!NativeLib.initialized) {
</a><a href="#h54-3-48" id="h54-3-48" class="d">-                context.longToast(translation[&quot;native_hooks_send_failure_toast&quot;])
</a><a href="#h54-3-49" id="h54-3-49" class="d">-                event.canceled = true
</a><a href="#h54-3-50" id="h54-3-50" class="d">-                return@subscribe
</a><a href="#h54-3-51" id="h54-3-51" class="d">-            }
</a><a href="#h54-3-52" id="h54-3-52" class="d">-
</a><a href="#h54-3-53" id="h54-3-53" class="d">-            event.addInvokeLater {
</a><a href="#h54-3-54" id="h54-3-54" class="d">-                if (event.messageContent.localMediaReferences?.isEmpty() == true) {
</a><a href="#h54-3-55" id="h54-3-55" class="d">-                    runCatching {
</a><a href="#h54-3-56" id="h54-3-56" class="d">-                        event.messageContent.content = ProtoWriter().apply {
</a><a href="#h54-3-57" id="h54-3-57" class="d">-                            writeEncryptedMessage(e2eeConversations.map { getE2EParticipants(it) }.flatten().distinct(), messageContent.content!!)
</a><a href="#h54-3-58" id="h54-3-58" class="d">-                        }.toByteArray()
</a><a href="#h54-3-59" id="h54-3-59" class="d">-                    }.onFailure {
</a><a href="#h54-3-60" id="h54-3-60" class="d">-                        context.log.error(&quot;Failed to encrypt message&quot;, it)
</a><a href="#h54-3-61" id="h54-3-61" class="d">-                        context.longToast(translation[&quot;encryption_failed_toast&quot;])
</a><a href="#h54-3-62" id="h54-3-62" class="d">-                    }
</a><a href="#h54-3-63" id="h54-3-63" class="d">-                }
</a><a href="#h54-3-64" id="h54-3-64" class="d">-
</a><a href="#h54-3-65" id="h54-3-65" class="d">-                if (event.messageContent.contentType == ContentType.SNAP) {
</a><a href="#h54-3-66" id="h54-3-66" class="d">-                    event.messageContent.contentType = ContentType.EXTERNAL_MEDIA
</a><a href="#h54-3-67" id="h54-3-67" class="d">-                }
</a><a href="#h54-3-68" id="h54-3-68" class="d">-            }
</a><a href="#h54-3-69" id="h54-3-69" class="d">-        }
</a><a href="#h54-3-70" id="h54-3-70" class="d">-
</a><a href="#h54-3-71" id="h54-3-71" class="d">-        context.event.subscribe(NativeUnaryCallEvent::class) { event -&gt;
</a><a href="#h54-3-72" id="h54-3-72" class="d">-            if (event.uri != &quot;/messagingcoreservice.MessagingCoreService/CreateContentMessage&quot;) return@subscribe
</a><a href="#h54-3-73" id="h54-3-73" class="d">-            val protoReader = ProtoReader(event.buffer)
</a><a href="#h54-3-74" id="h54-3-74" class="d">-            val messageReader = protoReader.followPath(4) ?: return@subscribe
</a><a href="#h54-3-75" id="h54-3-75" class="d">-
</a><a href="#h54-3-76" id="h54-3-76" class="d">-            if (messageReader.getVarInt(4, 2, 1, 5) == 1L) {
</a><a href="#h54-3-77" id="h54-3-77" class="d">-                event.buffer = ProtoEditor(event.buffer).apply {
</a><a href="#h54-3-78" id="h54-3-78" class="d">-                    edit(4) {
</a><a href="#h54-3-79" id="h54-3-79" class="d">-                        remove(2)
</a><a href="#h54-3-80" id="h54-3-80" class="d">-                        addVarInt(2, ContentType.SNAP.id)
</a><a href="#h54-3-81" id="h54-3-81" class="d">-                        context.log.verbose(&quot;fixed snap content type&quot;)
</a><a href="#h54-3-82" id="h54-3-82" class="d">-                    }
</a><a href="#h54-3-83" id="h54-3-83" class="d">-                }.toByteArray()
</a><a href="#h54-3-84" id="h54-3-84" class="d">-            }
</a><a href="#h54-3-85" id="h54-3-85" class="d">-        }
</a><a href="#h54-3-86" id="h54-3-86" class="d">-    }
</a><a href="#h54-3-87" id="h54-3-87" class="d">-
</a><a href="#h54-3-88" id="h54-3-88" class="d">-    override fun init() {
</a><a href="#h54-3-89" id="h54-3-89" class="d">-        if (!isEnabled) return
</a><a href="#h54-3-90" id="h54-3-90" class="d">-
</a><a href="#h54-3-91" id="h54-3-91" class="d">-        context.mappings.useMapper(CallbackMapper::class) {
</a><a href="#h54-3-92" id="h54-3-92" class="d">-            callbacks.getClass(&quot;ConversationManagerDelegate&quot;)?.hook(&quot;onSendComplete&quot;, HookStage.BEFORE) { param -&gt;
</a><a href="#h54-3-93" id="h54-3-93" class="d">-                val sendMessageResult = param.arg&lt;Any&gt;(0)
</a><a href="#h54-3-94" id="h54-3-94" class="d">-                val messageDestinations = MessageDestinations(sendMessageResult.getObjectField(&quot;mCompletedDestinations&quot;) ?: return@hook)
</a><a href="#h54-3-95" id="h54-3-95" class="d">-                if (messageDestinations.mPhoneNumbers?.isNotEmpty() == true || messageDestinations.stories?.isNotEmpty() == true) return@hook
</a><a href="#h54-3-96" id="h54-3-96" class="d">-
</a><a href="#h54-3-97" id="h54-3-97" class="d">-                val completedConversationDestinations = sendMessageResult.getObjectField(&quot;mCompletedConversationDestinations&quot;) as? ArrayList&lt;*&gt; ?: return@hook
</a><a href="#h54-3-98" id="h54-3-98" class="d">-                val messageIds = completedConversationDestinations.filter { getState(SnapUUID(it.getObjectField(&quot;mConversationId&quot;)).toString()) }.mapNotNull {
</a><a href="#h54-3-99" id="h54-3-99" class="d">-                    it.getObjectFieldOrNull(&quot;mMessageId&quot;) as? Long
</a><a href="#h54-3-100" id="h54-3-100" class="d">-                }
</a><a href="#h54-3-101" id="h54-3-101" class="d">-
</a><a href="#h54-3-102" id="h54-3-102" class="d">-                encryptedMessages.addAll(messageIds)
</a><a href="#h54-3-103" id="h54-3-103" class="d">-            }
</a><a href="#h54-3-104" id="h54-3-104" class="d">-        }
</a><a href="#h54-3-105" id="h54-3-105" class="d">-
</a><a href="#h54-3-106" id="h54-3-106" class="d">-        context.event.subscribe(BuildMessageEvent::class, priority = 0) { event -&gt;
</a><a href="#h54-3-107" id="h54-3-107" class="d">-            val message = event.message
</a><a href="#h54-3-108" id="h54-3-108" class="d">-            val conversationId = message.messageDescriptor!!.conversationId.toString()
</a><a href="#h54-3-109" id="h54-3-109" class="d">-            val isMessageCommitted = message.messageState == MessageState.COMMITTED
</a><a href="#h54-3-110" id="h54-3-110" class="d">-            messageHook(
</a><a href="#h54-3-111" id="h54-3-111" class="d">-                conversationId = conversationId,
</a><a href="#h54-3-112" id="h54-3-112" class="d">-                messageId = message.messageDescriptor!!.messageId!!,
</a><a href="#h54-3-113" id="h54-3-113" class="d">-                senderId = message.senderId.toString(),
</a><a href="#h54-3-114" id="h54-3-114" class="d">-                messageContent = message.messageContent!!,
</a><a href="#h54-3-115" id="h54-3-115" class="d">-                committed = isMessageCommitted
</a><a href="#h54-3-116" id="h54-3-116" class="d">-            )
</a><a href="#h54-3-117" id="h54-3-117" class="d">-
</a><a href="#h54-3-118" id="h54-3-118" class="d">-            message.messageContent!!.instanceNonNull()
</a><a href="#h54-3-119" id="h54-3-119" class="d">-                .getObjectField(&quot;mQuotedMessage&quot;)
</a><a href="#h54-3-120" id="h54-3-120" class="d">-                ?.getObjectField(&quot;mContent&quot;)
</a><a href="#h54-3-121" id="h54-3-121" class="d">-                ?.also { quotedMessage -&gt;
</a><a href="#h54-3-122" id="h54-3-122" class="d">-                messageHook(
</a><a href="#h54-3-123" id="h54-3-123" class="d">-                    conversationId = conversationId,
</a><a href="#h54-3-124" id="h54-3-124" class="d">-                    messageId = quotedMessage.getObjectField(&quot;mMessageId&quot;)?.toString()?.toLong() ?: return@also,
</a><a href="#h54-3-125" id="h54-3-125" class="d">-                    senderId = SnapUUID(quotedMessage.getObjectField(&quot;mSenderId&quot;)).toString(),
</a><a href="#h54-3-126" id="h54-3-126" class="d">-                    messageContent = MessageContent(quotedMessage),
</a><a href="#h54-3-127" id="h54-3-127" class="d">-                    committed = isMessageCommitted
</a><a href="#h54-3-128" id="h54-3-128" class="d">-                )
</a><a href="#h54-3-129" id="h54-3-129" class="d">-            }
</a><a href="#h54-3-130" id="h54-3-130" class="d">-        }
</a><a href="#h54-3-131" id="h54-3-131" class="d">-    }
</a><a href="#h54-3-132" id="h54-3-132" class="d">-
</a>     override fun getRuleState() = RuleState.WHITELIST
 } 
\ No newline at end of file
<b>diff --git a/<a id="h55" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/experiments/InfiniteStoryBoost.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/experiments/InfiniteStoryBoost.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/experiments/InfiniteStoryBoost.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/experiments/InfiniteStoryBoost.kt</a></b>
<a href="#h55-0" id="h55-0" class="h">@@ -1,22 +1,23 @@
</a> package me.rhunk.snapenhance.core.features.impl.experiments
 
 import me.rhunk.snapenhance.core.features.Feature
<a href="#h55-0-3" id="h55-0-3" class="d">-import me.rhunk.snapenhance.core.features.FeatureLoadParams
</a> import me.rhunk.snapenhance.core.util.hook.HookStage
 import me.rhunk.snapenhance.core.util.hook.hookConstructor
 import me.rhunk.snapenhance.mapper.impl.StoryBoostStateMapper
 
<a href="#h55-0-8" id="h55-0-8" class="d">-class InfiniteStoryBoost : Feature(&quot;InfiniteStoryBoost&quot;, loadParams = FeatureLoadParams.ACTIVITY_CREATE_ASYNC) {
</a><a href="#h55-0-9" id="h55-0-9" class="d">-    override fun asyncOnActivityCreate() {
</a><a href="#h55-0-10" id="h55-0-10" class="i">+class InfiniteStoryBoost : Feature(&quot;InfiniteStoryBoost&quot;) {
</a><a href="#h55-0-11" id="h55-0-11" class="i">+    override fun init() {
</a>         if (!context.config.experimental.infiniteStoryBoost.get()) return
 
<a href="#h55-0-14" id="h55-0-14" class="d">-        context.mappings.useMapper(StoryBoostStateMapper::class) {
</a><a href="#h55-0-15" id="h55-0-15" class="d">-            classReference.get()?.hookConstructor(HookStage.BEFORE) { param -&gt;
</a><a href="#h55-0-16" id="h55-0-16" class="d">-                val startTimeMillis = param.arg&lt;Long&gt;(1)
</a><a href="#h55-0-17" id="h55-0-17" class="d">-                //reset timestamp if it&#39;s more than 24 hours
</a><a href="#h55-0-18" id="h55-0-18" class="d">-                if (System.currentTimeMillis() - startTimeMillis &gt; 86400000) {
</a><a href="#h55-0-19" id="h55-0-19" class="d">-                    param.setArg(1, 0)
</a><a href="#h55-0-20" id="h55-0-20" class="d">-                    param.setArg(2, 0)
</a><a href="#h55-0-21" id="h55-0-21" class="i">+        onNextActivityCreate(defer = true) {
</a><a href="#h55-0-22" id="h55-0-22" class="i">+            context.mappings.useMapper(StoryBoostStateMapper::class) {
</a><a href="#h55-0-23" id="h55-0-23" class="i">+                classReference.get()?.hookConstructor(HookStage.BEFORE) { param -&gt;
</a><a href="#h55-0-24" id="h55-0-24" class="i">+                    val startTimeMillis = param.arg&lt;Long&gt;(1)
</a><a href="#h55-0-25" id="h55-0-25" class="i">+                    //reset timestamp if it&#39;s more than 24 hours
</a><a href="#h55-0-26" id="h55-0-26" class="i">+                    if (System.currentTimeMillis() - startTimeMillis &gt; 86400000) {
</a><a href="#h55-0-27" id="h55-0-27" class="i">+                        param.setArg(1, 0)
</a><a href="#h55-0-28" id="h55-0-28" class="i">+                        param.setArg(2, 0)
</a><a href="#h55-0-29" id="h55-0-29" class="i">+                    }
</a>                 }
             }
         }
<b>diff --git a/<a id="h56" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/experiments/MediaFilePicker.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/experiments/MediaFilePicker.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/experiments/MediaFilePicker.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/experiments/MediaFilePicker.kt</a></b>
<a href="#h56-0" id="h56-0" class="h">@@ -31,7 +31,6 @@ import me.rhunk.snapenhance.common.util.ktx.getTypeArguments
</a> import me.rhunk.snapenhance.core.event.events.impl.ActivityResultEvent
 import me.rhunk.snapenhance.core.event.events.impl.AddViewEvent
 import me.rhunk.snapenhance.core.features.Feature
<a href="#h56-0-3" id="h56-0-3" class="d">-import me.rhunk.snapenhance.core.features.FeatureLoadParams
</a> import me.rhunk.snapenhance.core.ui.ViewAppearanceHelper
 import me.rhunk.snapenhance.core.util.dataBuilder
 import me.rhunk.snapenhance.core.util.hook.HookStage
<a href="#h56-1" id="h56-1" class="h">@@ -41,198 +40,200 @@ import java.io.InputStream
</a> import java.lang.reflect.Method
 import kotlin.random.Random
 
<a href="#h56-1-3" id="h56-1-3" class="d">-class MediaFilePicker : Feature(&quot;Media File Picker&quot;, loadParams = FeatureLoadParams.ACTIVITY_CREATE_SYNC) {
</a><a href="#h56-1-4" id="h56-1-4" class="i">+class MediaFilePicker : Feature(&quot;Media File Picker&quot;) {
</a>     var lastMediaDuration: Long? = null
         private set
 
     @SuppressLint(&quot;Recycle&quot;)
<a href="#h56-1-9" id="h56-1-9" class="d">-    override fun onActivityCreate() {
</a><a href="#h56-1-10" id="h56-1-10" class="i">+    override fun init() {
</a>         if (!context.config.experimental.mediaFilePicker.get()) return
 
<a href="#h56-1-13" id="h56-1-13" class="d">-        lateinit var chatMediaDrawerActionHandler: Any
</a><a href="#h56-1-14" id="h56-1-14" class="d">-        lateinit var sendItemsMethod: Method
</a><a href="#h56-1-15" id="h56-1-15" class="d">-
</a><a href="#h56-1-16" id="h56-1-16" class="d">-        findClass(&quot;com.snap.composer.memories.ChatMediaDrawer&quot;).genericSuperclass?.getTypeArguments()?.getOrNull(1)?.apply {
</a><a href="#h56-1-17" id="h56-1-17" class="d">-            methods.first {
</a><a href="#h56-1-18" id="h56-1-18" class="d">-                it.parameterTypes.size == 1 &amp;&amp; it.parameterTypes[0].name.endsWith(&quot;ChatMediaDrawerActionHandler&quot;)
</a><a href="#h56-1-19" id="h56-1-19" class="d">-            }.also { method -&gt;
</a><a href="#h56-1-20" id="h56-1-20" class="d">-                sendItemsMethod = method.parameterTypes[0].methods.first { it.name == &quot;sendItems&quot; }
</a><a href="#h56-1-21" id="h56-1-21" class="d">-            }.hook(HookStage.AFTER) {
</a><a href="#h56-1-22" id="h56-1-22" class="d">-                chatMediaDrawerActionHandler = it.arg(0)
</a><a href="#h56-1-23" id="h56-1-23" class="i">+        onNextActivityCreate(defer = true) {
</a><a href="#h56-1-24" id="h56-1-24" class="i">+            lateinit var chatMediaDrawerActionHandler: Any
</a><a href="#h56-1-25" id="h56-1-25" class="i">+            lateinit var sendItemsMethod: Method
</a><a href="#h56-1-26" id="h56-1-26" class="i">+
</a><a href="#h56-1-27" id="h56-1-27" class="i">+            findClass(&quot;com.snap.composer.memories.ChatMediaDrawer&quot;).genericSuperclass?.getTypeArguments()?.getOrNull(1)?.apply {
</a><a href="#h56-1-28" id="h56-1-28" class="i">+                methods.first {
</a><a href="#h56-1-29" id="h56-1-29" class="i">+                    it.parameterTypes.size == 1 &amp;&amp; it.parameterTypes[0].name.endsWith(&quot;ChatMediaDrawerActionHandler&quot;)
</a><a href="#h56-1-30" id="h56-1-30" class="i">+                }.also { method -&gt;
</a><a href="#h56-1-31" id="h56-1-31" class="i">+                    sendItemsMethod = method.parameterTypes[0].methods.first { it.name == &quot;sendItems&quot; }
</a><a href="#h56-1-32" id="h56-1-32" class="i">+                }.hook(HookStage.AFTER) {
</a><a href="#h56-1-33" id="h56-1-33" class="i">+                    chatMediaDrawerActionHandler = it.arg(0)
</a><a href="#h56-1-34" id="h56-1-34" class="i">+                }
</a>             }
<a href="#h56-1-36" id="h56-1-36" class="d">-        }
</a> 
<a href="#h56-1-38" id="h56-1-38" class="d">-        var requestCode: Int? = null
</a><a href="#h56-1-39" id="h56-1-39" class="d">-        var firstVideoId: Long? = null
</a><a href="#h56-1-40" id="h56-1-40" class="d">-        var mediaInputStream: InputStream? = null
</a><a href="#h56-1-41" id="h56-1-41" class="i">+            var requestCode: Int? = null
</a><a href="#h56-1-42" id="h56-1-42" class="i">+            var firstVideoId: Long? = null
</a><a href="#h56-1-43" id="h56-1-43" class="i">+            var mediaInputStream: InputStream? = null
</a> 
<a href="#h56-1-45" id="h56-1-45" class="d">-        ContentResolver::class.java.apply {
</a><a href="#h56-1-46" id="h56-1-46" class="d">-            hook(&quot;query&quot;, HookStage.AFTER) { param -&gt;
</a><a href="#h56-1-47" id="h56-1-47" class="d">-                val uri = param.arg&lt;Uri&gt;(0)
</a><a href="#h56-1-48" id="h56-1-48" class="d">-                if (!uri.toString().endsWith(firstVideoId.toString())) return@hook
</a><a href="#h56-1-49" id="h56-1-49" class="i">+            ContentResolver::class.java.apply {
</a><a href="#h56-1-50" id="h56-1-50" class="i">+                hook(&quot;query&quot;, HookStage.AFTER) { param -&gt;
</a><a href="#h56-1-51" id="h56-1-51" class="i">+                    val uri = param.arg&lt;Uri&gt;(0)
</a><a href="#h56-1-52" id="h56-1-52" class="i">+                    if (!uri.toString().endsWith(firstVideoId.toString())) return@hook
</a> 
<a href="#h56-1-54" id="h56-1-54" class="d">-                param.setResult(object: CursorWrapper(param.getResult() as Cursor) {
</a><a href="#h56-1-55" id="h56-1-55" class="d">-                    override fun getLong(columnIndex: Int): Long {
</a><a href="#h56-1-56" id="h56-1-56" class="d">-                        if (getColumnName(columnIndex) == &quot;duration&quot;) {
</a><a href="#h56-1-57" id="h56-1-57" class="d">-                            return lastMediaDuration ?: -1
</a><a href="#h56-1-58" id="h56-1-58" class="i">+                    param.setResult(object: CursorWrapper(param.getResult() as Cursor) {
</a><a href="#h56-1-59" id="h56-1-59" class="i">+                        override fun getLong(columnIndex: Int): Long {
</a><a href="#h56-1-60" id="h56-1-60" class="i">+                            if (getColumnName(columnIndex) == &quot;duration&quot;) {
</a><a href="#h56-1-61" id="h56-1-61" class="i">+                                return lastMediaDuration ?: -1
</a><a href="#h56-1-62" id="h56-1-62" class="i">+                            }
</a><a href="#h56-1-63" id="h56-1-63" class="i">+                            return super.getLong(columnIndex)
</a>                         }
<a href="#h56-1-65" id="h56-1-65" class="d">-                        return super.getLong(columnIndex)
</a><a href="#h56-1-66" id="h56-1-66" class="i">+                    })
</a><a href="#h56-1-67" id="h56-1-67" class="i">+                }
</a><a href="#h56-1-68" id="h56-1-68" class="i">+                hook(&quot;openInputStream&quot;, HookStage.BEFORE) { param -&gt;
</a><a href="#h56-1-69" id="h56-1-69" class="i">+                    val uri = param.arg&lt;Uri&gt;(0)
</a><a href="#h56-1-70" id="h56-1-70" class="i">+                    if (uri.toString().endsWith(firstVideoId.toString())) {
</a><a href="#h56-1-71" id="h56-1-71" class="i">+                        param.setResult(mediaInputStream)
</a><a href="#h56-1-72" id="h56-1-72" class="i">+                        mediaInputStream = null
</a>                     }
<a href="#h56-1-74" id="h56-1-74" class="d">-                })
</a><a href="#h56-1-75" id="h56-1-75" class="d">-            }
</a><a href="#h56-1-76" id="h56-1-76" class="d">-            hook(&quot;openInputStream&quot;, HookStage.BEFORE) { param -&gt;
</a><a href="#h56-1-77" id="h56-1-77" class="d">-                val uri = param.arg&lt;Uri&gt;(0)
</a><a href="#h56-1-78" id="h56-1-78" class="d">-                if (uri.toString().endsWith(firstVideoId.toString())) {
</a><a href="#h56-1-79" id="h56-1-79" class="d">-                    param.setResult(mediaInputStream)
</a><a href="#h56-1-80" id="h56-1-80" class="d">-                    mediaInputStream = null
</a>                 }
             }
<a href="#h56-1-83" id="h56-1-83" class="d">-        }
</a> 
<a href="#h56-1-85" id="h56-1-85" class="d">-        context.event.subscribe(ActivityResultEvent::class) { event -&gt;
</a><a href="#h56-1-86" id="h56-1-86" class="d">-            if (event.requestCode != requestCode || event.resultCode != Activity.RESULT_OK) return@subscribe
</a><a href="#h56-1-87" id="h56-1-87" class="d">-            requestCode = null
</a><a href="#h56-1-88" id="h56-1-88" class="d">-
</a><a href="#h56-1-89" id="h56-1-89" class="d">-            firstVideoId = context.androidContext.contentResolver.query(
</a><a href="#h56-1-90" id="h56-1-90" class="d">-                MediaStore.Video.Media.EXTERNAL_CONTENT_URI,
</a><a href="#h56-1-91" id="h56-1-91" class="d">-                arrayOf(MediaStore.Video.Media._ID),
</a><a href="#h56-1-92" id="h56-1-92" class="d">-                null,
</a><a href="#h56-1-93" id="h56-1-93" class="d">-                null,
</a><a href="#h56-1-94" id="h56-1-94" class="d">-                &quot;${MediaStore.Video.Media.DATE_TAKEN} DESC&quot;
</a><a href="#h56-1-95" id="h56-1-95" class="d">-            )?.use { cursor -&gt;
</a><a href="#h56-1-96" id="h56-1-96" class="d">-                if (cursor.moveToFirst()) {
</a><a href="#h56-1-97" id="h56-1-97" class="d">-                    cursor.getLongOrNull(&quot;_id&quot;)
</a><a href="#h56-1-98" id="h56-1-98" class="d">-                } else {
</a><a href="#h56-1-99" id="h56-1-99" class="d">-                    null
</a><a href="#h56-1-100" id="h56-1-100" class="i">+            context.event.subscribe(ActivityResultEvent::class) { event -&gt;
</a><a href="#h56-1-101" id="h56-1-101" class="i">+                if (event.requestCode != requestCode || event.resultCode != Activity.RESULT_OK) return@subscribe
</a><a href="#h56-1-102" id="h56-1-102" class="i">+                requestCode = null
</a><a href="#h56-1-103" id="h56-1-103" class="i">+
</a><a href="#h56-1-104" id="h56-1-104" class="i">+                firstVideoId = context.androidContext.contentResolver.query(
</a><a href="#h56-1-105" id="h56-1-105" class="i">+                    MediaStore.Video.Media.EXTERNAL_CONTENT_URI,
</a><a href="#h56-1-106" id="h56-1-106" class="i">+                    arrayOf(MediaStore.Video.Media._ID),
</a><a href="#h56-1-107" id="h56-1-107" class="i">+                    null,
</a><a href="#h56-1-108" id="h56-1-108" class="i">+                    null,
</a><a href="#h56-1-109" id="h56-1-109" class="i">+                    &quot;${MediaStore.Video.Media.DATE_TAKEN} DESC&quot;
</a><a href="#h56-1-110" id="h56-1-110" class="i">+                )?.use { cursor -&gt;
</a><a href="#h56-1-111" id="h56-1-111" class="i">+                    if (cursor.moveToFirst()) {
</a><a href="#h56-1-112" id="h56-1-112" class="i">+                        cursor.getLongOrNull(&quot;_id&quot;)
</a><a href="#h56-1-113" id="h56-1-113" class="i">+                    } else {
</a><a href="#h56-1-114" id="h56-1-114" class="i">+                        null
</a><a href="#h56-1-115" id="h56-1-115" class="i">+                    }
</a>                 }
<a href="#h56-1-117" id="h56-1-117" class="d">-            }
</a> 
<a href="#h56-1-119" id="h56-1-119" class="d">-            if (firstVideoId == null) {
</a><a href="#h56-1-120" id="h56-1-120" class="d">-                context.inAppOverlay.showStatusToast(
</a><a href="#h56-1-121" id="h56-1-121" class="d">-                    Icons.Default.Upload,
</a><a href="#h56-1-122" id="h56-1-122" class="d">-                    &quot;Must have a video in gallery to upload.&quot;
</a><a href="#h56-1-123" id="h56-1-123" class="d">-                )
</a><a href="#h56-1-124" id="h56-1-124" class="d">-                return@subscribe
</a><a href="#h56-1-125" id="h56-1-125" class="d">-            }
</a><a href="#h56-1-126" id="h56-1-126" class="i">+                if (firstVideoId == null) {
</a><a href="#h56-1-127" id="h56-1-127" class="i">+                    context.inAppOverlay.showStatusToast(
</a><a href="#h56-1-128" id="h56-1-128" class="i">+                        Icons.Default.Upload,
</a><a href="#h56-1-129" id="h56-1-129" class="i">+                        &quot;Must have a video in gallery to upload.&quot;
</a><a href="#h56-1-130" id="h56-1-130" class="i">+                    )
</a><a href="#h56-1-131" id="h56-1-131" class="i">+                    return@subscribe
</a><a href="#h56-1-132" id="h56-1-132" class="i">+                }
</a> 
<a href="#h56-1-134" id="h56-1-134" class="d">-            fun sendMedia() {
</a><a href="#h56-1-135" id="h56-1-135" class="d">-                sendItemsMethod.invoke(chatMediaDrawerActionHandler, listOf&lt;Any&gt;(), listOf(
</a><a href="#h56-1-136" id="h56-1-136" class="d">-                    sendItemsMethod.genericParameterTypes[1].getTypeArguments().first().dataBuilder {
</a><a href="#h56-1-137" id="h56-1-137" class="d">-                        from(&quot;_item&quot;) {
</a><a href="#h56-1-138" id="h56-1-138" class="d">-                            set(&quot;_cameraRollSource&quot;, &quot;Snapchat&quot;)
</a><a href="#h56-1-139" id="h56-1-139" class="d">-                            set(&quot;_contentUri&quot;, &quot;&quot;)
</a><a href="#h56-1-140" id="h56-1-140" class="d">-                            set(&quot;_durationMs&quot;, 0.0)
</a><a href="#h56-1-141" id="h56-1-141" class="d">-                            set(&quot;_disabled&quot;, false)
</a><a href="#h56-1-142" id="h56-1-142" class="d">-                            set(&quot;_imageRotation&quot;, 0.0)
</a><a href="#h56-1-143" id="h56-1-143" class="d">-                            set(&quot;_width&quot;, 1080.0)
</a><a href="#h56-1-144" id="h56-1-144" class="d">-                            set(&quot;_height&quot;, 1920.0)
</a><a href="#h56-1-145" id="h56-1-145" class="d">-                            set(&quot;_timestampMs&quot;, System.currentTimeMillis().toDouble())
</a><a href="#h56-1-146" id="h56-1-146" class="d">-                            from(&quot;_itemId&quot;) {
</a><a href="#h56-1-147" id="h56-1-147" class="d">-                                set(&quot;_itemId&quot;, firstVideoId.toString())
</a><a href="#h56-1-148" id="h56-1-148" class="d">-                                set(&quot;_type&quot;, &quot;VIDEO&quot;)
</a><a href="#h56-1-149" id="h56-1-149" class="i">+                fun sendMedia() {
</a><a href="#h56-1-150" id="h56-1-150" class="i">+                    sendItemsMethod.invoke(chatMediaDrawerActionHandler, listOf&lt;Any&gt;(), listOf(
</a><a href="#h56-1-151" id="h56-1-151" class="i">+                        sendItemsMethod.genericParameterTypes[1].getTypeArguments().first().dataBuilder {
</a><a href="#h56-1-152" id="h56-1-152" class="i">+                            from(&quot;_item&quot;) {
</a><a href="#h56-1-153" id="h56-1-153" class="i">+                                set(&quot;_cameraRollSource&quot;, &quot;Snapchat&quot;)
</a><a href="#h56-1-154" id="h56-1-154" class="i">+                                set(&quot;_contentUri&quot;, &quot;&quot;)
</a><a href="#h56-1-155" id="h56-1-155" class="i">+                                set(&quot;_durationMs&quot;, 0.0)
</a><a href="#h56-1-156" id="h56-1-156" class="i">+                                set(&quot;_disabled&quot;, false)
</a><a href="#h56-1-157" id="h56-1-157" class="i">+                                set(&quot;_imageRotation&quot;, 0.0)
</a><a href="#h56-1-158" id="h56-1-158" class="i">+                                set(&quot;_width&quot;, 1080.0)
</a><a href="#h56-1-159" id="h56-1-159" class="i">+                                set(&quot;_height&quot;, 1920.0)
</a><a href="#h56-1-160" id="h56-1-160" class="i">+                                set(&quot;_timestampMs&quot;, System.currentTimeMillis().toDouble())
</a><a href="#h56-1-161" id="h56-1-161" class="i">+                                from(&quot;_itemId&quot;) {
</a><a href="#h56-1-162" id="h56-1-162" class="i">+                                    set(&quot;_itemId&quot;, firstVideoId.toString())
</a><a href="#h56-1-163" id="h56-1-163" class="i">+                                    set(&quot;_type&quot;, &quot;VIDEO&quot;)
</a><a href="#h56-1-164" id="h56-1-164" class="i">+                                }
</a>                             }
<a href="#h56-1-166" id="h56-1-166" class="i">+                            set(&quot;_order&quot;, 0.0)
</a>                         }
<a href="#h56-1-168" id="h56-1-168" class="d">-                        set(&quot;_order&quot;, 0.0)
</a><a href="#h56-1-169" id="h56-1-169" class="d">-                    }
</a><a href="#h56-1-170" id="h56-1-170" class="d">-                ))
</a><a href="#h56-1-171" id="h56-1-171" class="d">-            }
</a><a href="#h56-1-172" id="h56-1-172" class="i">+                    ))
</a><a href="#h56-1-173" id="h56-1-173" class="i">+                }
</a> 
<a href="#h56-1-175" id="h56-1-175" class="d">-            fun startConversation(audioOnly: Boolean) {
</a><a href="#h56-1-176" id="h56-1-176" class="d">-                context.coroutineScope.launch {
</a><a href="#h56-1-177" id="h56-1-177" class="d">-                    lastMediaDuration = MediaPlayer().run {
</a><a href="#h56-1-178" id="h56-1-178" class="d">-                        setDataSource(context.androidContext, event.intent.data!!)
</a><a href="#h56-1-179" id="h56-1-179" class="d">-                        prepare()
</a><a href="#h56-1-180" id="h56-1-180" class="d">-                        duration.toLong().also {
</a><a href="#h56-1-181" id="h56-1-181" class="d">-                            release()
</a><a href="#h56-1-182" id="h56-1-182" class="i">+                fun startConversation(audioOnly: Boolean) {
</a><a href="#h56-1-183" id="h56-1-183" class="i">+                    context.coroutineScope.launch {
</a><a href="#h56-1-184" id="h56-1-184" class="i">+                        lastMediaDuration = MediaPlayer().run {
</a><a href="#h56-1-185" id="h56-1-185" class="i">+                            setDataSource(context.androidContext, event.intent.data!!)
</a><a href="#h56-1-186" id="h56-1-186" class="i">+                            prepare()
</a><a href="#h56-1-187" id="h56-1-187" class="i">+                            duration.toLong().also {
</a><a href="#h56-1-188" id="h56-1-188" class="i">+                                release()
</a><a href="#h56-1-189" id="h56-1-189" class="i">+                            }
</a>                         }
<a href="#h56-1-191" id="h56-1-191" class="d">-                    }
</a> 
<a href="#h56-1-193" id="h56-1-193" class="d">-                    context.inAppOverlay.showStatusToast(Icons.Default.Crop, &quot;Converting media...&quot;, durationMs = 3000)
</a><a href="#h56-1-194" id="h56-1-194" class="d">-                    val pfd = context.bridgeClient.convertMedia(
</a><a href="#h56-1-195" id="h56-1-195" class="d">-                        context.androidContext.contentResolver.openFileDescriptor(event.intent.data!!, &quot;r&quot;)!!,
</a><a href="#h56-1-196" id="h56-1-196" class="d">-                        &quot;m4a&quot;,
</a><a href="#h56-1-197" id="h56-1-197" class="d">-                        &quot;m4a&quot;,
</a><a href="#h56-1-198" id="h56-1-198" class="d">-                        &quot;aac&quot;,
</a><a href="#h56-1-199" id="h56-1-199" class="d">-                        if (!audioOnly) &quot;libx264&quot; else null
</a><a href="#h56-1-200" id="h56-1-200" class="d">-                    )
</a><a href="#h56-1-201" id="h56-1-201" class="d">-
</a><a href="#h56-1-202" id="h56-1-202" class="d">-                    if (pfd == null) {
</a><a href="#h56-1-203" id="h56-1-203" class="d">-                        context.inAppOverlay.showStatusToast(Icons.Default.Error, &quot;Failed to convert media.&quot;)
</a><a href="#h56-1-204" id="h56-1-204" class="d">-                        return@launch
</a><a href="#h56-1-205" id="h56-1-205" class="d">-                    }
</a><a href="#h56-1-206" id="h56-1-206" class="i">+                        context.inAppOverlay.showStatusToast(Icons.Default.Crop, &quot;Converting media...&quot;, durationMs = 3000)
</a><a href="#h56-1-207" id="h56-1-207" class="i">+                        val pfd = context.bridgeClient.convertMedia(
</a><a href="#h56-1-208" id="h56-1-208" class="i">+                            context.androidContext.contentResolver.openFileDescriptor(event.intent.data!!, &quot;r&quot;)!!,
</a><a href="#h56-1-209" id="h56-1-209" class="i">+                            &quot;m4a&quot;,
</a><a href="#h56-1-210" id="h56-1-210" class="i">+                            &quot;m4a&quot;,
</a><a href="#h56-1-211" id="h56-1-211" class="i">+                            &quot;aac&quot;,
</a><a href="#h56-1-212" id="h56-1-212" class="i">+                            if (!audioOnly) &quot;libx264&quot; else null
</a><a href="#h56-1-213" id="h56-1-213" class="i">+                        )
</a><a href="#h56-1-214" id="h56-1-214" class="i">+
</a><a href="#h56-1-215" id="h56-1-215" class="i">+                        if (pfd == null) {
</a><a href="#h56-1-216" id="h56-1-216" class="i">+                            context.inAppOverlay.showStatusToast(Icons.Default.Error, &quot;Failed to convert media.&quot;)
</a><a href="#h56-1-217" id="h56-1-217" class="i">+                            return@launch
</a><a href="#h56-1-218" id="h56-1-218" class="i">+                        }
</a> 
<a href="#h56-1-220" id="h56-1-220" class="d">-                    context.inAppOverlay.showStatusToast(Icons.Default.CheckCircleOutline, &quot;Media converted successfully.&quot;)
</a><a href="#h56-1-221" id="h56-1-221" class="i">+                        context.inAppOverlay.showStatusToast(Icons.Default.CheckCircleOutline, &quot;Media converted successfully.&quot;)
</a> 
<a href="#h56-1-223" id="h56-1-223" class="d">-                    runCatching {
</a><a href="#h56-1-224" id="h56-1-224" class="d">-                        mediaInputStream = ParcelFileDescriptor.AutoCloseInputStream(pfd)
</a><a href="#h56-1-225" id="h56-1-225" class="d">-                        sendMedia()
</a><a href="#h56-1-226" id="h56-1-226" class="d">-                    }.onFailure {
</a><a href="#h56-1-227" id="h56-1-227" class="d">-                        mediaInputStream = null
</a><a href="#h56-1-228" id="h56-1-228" class="d">-                        context.log.error(it)
</a><a href="#h56-1-229" id="h56-1-229" class="d">-                        context.inAppOverlay.showStatusToast(Icons.Default.Error, &quot;Failed to send media.&quot;)
</a><a href="#h56-1-230" id="h56-1-230" class="i">+                        runCatching {
</a><a href="#h56-1-231" id="h56-1-231" class="i">+                            mediaInputStream = ParcelFileDescriptor.AutoCloseInputStream(pfd)
</a><a href="#h56-1-232" id="h56-1-232" class="i">+                            sendMedia()
</a><a href="#h56-1-233" id="h56-1-233" class="i">+                        }.onFailure {
</a><a href="#h56-1-234" id="h56-1-234" class="i">+                            mediaInputStream = null
</a><a href="#h56-1-235" id="h56-1-235" class="i">+                            context.log.error(it)
</a><a href="#h56-1-236" id="h56-1-236" class="i">+                            context.inAppOverlay.showStatusToast(Icons.Default.Error, &quot;Failed to send media.&quot;)
</a><a href="#h56-1-237" id="h56-1-237" class="i">+                        }
</a>                     }
                 }
<a href="#h56-1-240" id="h56-1-240" class="d">-            }
</a><a href="#h56-1-241" id="h56-1-241" class="d">-
</a><a href="#h56-1-242" id="h56-1-242" class="d">-            val isAudio = context.androidContext.contentResolver.getType(event.intent.data!!)!!.startsWith(&quot;audio/&quot;)
</a> 
<a href="#h56-1-244" id="h56-1-244" class="d">-            if (isAudio || context.config.messaging.galleryMediaSendOverride.getNullable() == null) {
</a><a href="#h56-1-245" id="h56-1-245" class="d">-                startConversation(isAudio)
</a><a href="#h56-1-246" id="h56-1-246" class="d">-                return@subscribe
</a><a href="#h56-1-247" id="h56-1-247" class="d">-            }
</a><a href="#h56-1-248" id="h56-1-248" class="i">+                val isAudio = context.androidContext.contentResolver.getType(event.intent.data!!)!!.startsWith(&quot;audio/&quot;)
</a> 
<a href="#h56-1-250" id="h56-1-250" class="d">-            ViewAppearanceHelper.newAlertDialogBuilder(context.mainActivity!!)
</a><a href="#h56-1-251" id="h56-1-251" class="d">-                .setTitle(&quot;Convert video file&quot;)
</a><a href="#h56-1-252" id="h56-1-252" class="d">-                .setItems(arrayOf(&quot;Send as video/audio&quot;, &quot;Send as audio only&quot;)) { _, which -&gt;
</a><a href="#h56-1-253" id="h56-1-253" class="d">-                    startConversation(which == 1)
</a><a href="#h56-1-254" id="h56-1-254" class="i">+                if (isAudio || context.config.messaging.galleryMediaSendOverride.getNullable() == null) {
</a><a href="#h56-1-255" id="h56-1-255" class="i">+                    startConversation(isAudio)
</a><a href="#h56-1-256" id="h56-1-256" class="i">+                    return@subscribe
</a>                 }
<a href="#h56-1-258" id="h56-1-258" class="d">-                .setNegativeButton(&quot;Cancel&quot;) { dialog, _ -&gt; dialog.dismiss() }.show()
</a><a href="#h56-1-259" id="h56-1-259" class="d">-        }
</a> 
<a href="#h56-1-261" id="h56-1-261" class="d">-        val buttonTag = Random.nextInt(0, 65535)
</a><a href="#h56-1-262" id="h56-1-262" class="d">-
</a><a href="#h56-1-263" id="h56-1-263" class="d">-        context.event.subscribe(AddViewEvent::class) { event -&gt;
</a><a href="#h56-1-264" id="h56-1-264" class="d">-            if (event.parent.id != context.resources.getId(&quot;chat_drawer_container&quot;) || !event.view::class.java.name.endsWith(&quot;ChatMediaDrawer&quot;)) return@subscribe
</a><a href="#h56-1-265" id="h56-1-265" class="d">-
</a><a href="#h56-1-266" id="h56-1-266" class="d">-            event.view.addOnAttachStateChangeListener(object: View.OnAttachStateChangeListener {
</a><a href="#h56-1-267" id="h56-1-267" class="d">-                override fun onViewAttachedToWindow(v: View) {
</a><a href="#h56-1-268" id="h56-1-268" class="d">-                    if (event.parent.findViewWithTag&lt;View&gt;(buttonTag)?.run {
</a><a href="#h56-1-269" id="h56-1-269" class="d">-                        visibility = View.VISIBLE
</a><a href="#h56-1-270" id="h56-1-270" class="d">-                        bringToFront()
</a><a href="#h56-1-271" id="h56-1-271" class="d">-                    } != null) return
</a><a href="#h56-1-272" id="h56-1-272" class="d">-                    event.parent.addView(
</a><a href="#h56-1-273" id="h56-1-273" class="d">-                        createComposeView(context.mainActivity!!) {
</a><a href="#h56-1-274" id="h56-1-274" class="d">-                            Row(
</a><a href="#h56-1-275" id="h56-1-275" class="d">-                                modifier = Modifier.fillMaxWidth(),
</a><a href="#h56-1-276" id="h56-1-276" class="d">-                                horizontalArrangement = Arrangement.End
</a><a href="#h56-1-277" id="h56-1-277" class="d">-                            ) {
</a><a href="#h56-1-278" id="h56-1-278" class="d">-                                FilledIconButton(onClick = {
</a><a href="#h56-1-279" id="h56-1-279" class="d">-                                    requestCode = Random.nextInt(0, 65535)
</a><a href="#h56-1-280" id="h56-1-280" class="d">-                                    this@MediaFilePicker.context.mainActivity!!.startActivityForResult(
</a><a href="#h56-1-281" id="h56-1-281" class="d">-                                        Intent(Intent.ACTION_OPEN_DOCUMENT).apply {
</a><a href="#h56-1-282" id="h56-1-282" class="d">-                                            addCategory(Intent.CATEGORY_OPENABLE)
</a><a href="#h56-1-283" id="h56-1-283" class="d">-                                            type = &quot;video/*&quot;
</a><a href="#h56-1-284" id="h56-1-284" class="d">-                                            putExtra(Intent.EXTRA_MIME_TYPES, arrayOf(&quot;video/*&quot;, &quot;audio/*&quot;))
</a><a href="#h56-1-285" id="h56-1-285" class="d">-                                        },
</a><a href="#h56-1-286" id="h56-1-286" class="d">-                                        requestCode!!
</a><a href="#h56-1-287" id="h56-1-287" class="d">-                                    )
</a><a href="#h56-1-288" id="h56-1-288" class="d">-                                }) {
</a><a href="#h56-1-289" id="h56-1-289" class="d">-                                    Icon(Icons.Default.Upload, &quot;Upload media&quot;)
</a><a href="#h56-1-290" id="h56-1-290" class="i">+                ViewAppearanceHelper.newAlertDialogBuilder(context.mainActivity!!)
</a><a href="#h56-1-291" id="h56-1-291" class="i">+                    .setTitle(&quot;Convert video file&quot;)
</a><a href="#h56-1-292" id="h56-1-292" class="i">+                    .setItems(arrayOf(&quot;Send as video/audio&quot;, &quot;Send as audio only&quot;)) { _, which -&gt;
</a><a href="#h56-1-293" id="h56-1-293" class="i">+                        startConversation(which == 1)
</a><a href="#h56-1-294" id="h56-1-294" class="i">+                    }
</a><a href="#h56-1-295" id="h56-1-295" class="i">+                    .setNegativeButton(&quot;Cancel&quot;) { dialog, _ -&gt; dialog.dismiss() }.show()
</a><a href="#h56-1-296" id="h56-1-296" class="i">+            }
</a><a href="#h56-1-297" id="h56-1-297" class="i">+
</a><a href="#h56-1-298" id="h56-1-298" class="i">+            val buttonTag = Random.nextInt(0, 65535)
</a><a href="#h56-1-299" id="h56-1-299" class="i">+
</a><a href="#h56-1-300" id="h56-1-300" class="i">+            context.event.subscribe(AddViewEvent::class) { event -&gt;
</a><a href="#h56-1-301" id="h56-1-301" class="i">+                if (event.parent.id != context.resources.getId(&quot;chat_drawer_container&quot;) || !event.view::class.java.name.endsWith(&quot;ChatMediaDrawer&quot;)) return@subscribe
</a><a href="#h56-1-302" id="h56-1-302" class="i">+
</a><a href="#h56-1-303" id="h56-1-303" class="i">+                event.view.addOnAttachStateChangeListener(object: View.OnAttachStateChangeListener {
</a><a href="#h56-1-304" id="h56-1-304" class="i">+                    override fun onViewAttachedToWindow(v: View) {
</a><a href="#h56-1-305" id="h56-1-305" class="i">+                        if (event.parent.findViewWithTag&lt;View&gt;(buttonTag)?.run {
</a><a href="#h56-1-306" id="h56-1-306" class="i">+                                visibility = View.VISIBLE
</a><a href="#h56-1-307" id="h56-1-307" class="i">+                                bringToFront()
</a><a href="#h56-1-308" id="h56-1-308" class="i">+                            } != null) return
</a><a href="#h56-1-309" id="h56-1-309" class="i">+                        event.parent.addView(
</a><a href="#h56-1-310" id="h56-1-310" class="i">+                            createComposeView(context.mainActivity!!) {
</a><a href="#h56-1-311" id="h56-1-311" class="i">+                                Row(
</a><a href="#h56-1-312" id="h56-1-312" class="i">+                                    modifier = Modifier.fillMaxWidth(),
</a><a href="#h56-1-313" id="h56-1-313" class="i">+                                    horizontalArrangement = Arrangement.End
</a><a href="#h56-1-314" id="h56-1-314" class="i">+                                ) {
</a><a href="#h56-1-315" id="h56-1-315" class="i">+                                    FilledIconButton(onClick = {
</a><a href="#h56-1-316" id="h56-1-316" class="i">+                                        requestCode = Random.nextInt(0, 65535)
</a><a href="#h56-1-317" id="h56-1-317" class="i">+                                        this@MediaFilePicker.context.mainActivity!!.startActivityForResult(
</a><a href="#h56-1-318" id="h56-1-318" class="i">+                                            Intent(Intent.ACTION_OPEN_DOCUMENT).apply {
</a><a href="#h56-1-319" id="h56-1-319" class="i">+                                                addCategory(Intent.CATEGORY_OPENABLE)
</a><a href="#h56-1-320" id="h56-1-320" class="i">+                                                type = &quot;video/*&quot;
</a><a href="#h56-1-321" id="h56-1-321" class="i">+                                                putExtra(Intent.EXTRA_MIME_TYPES, arrayOf(&quot;video/*&quot;, &quot;audio/*&quot;))
</a><a href="#h56-1-322" id="h56-1-322" class="i">+                                            },
</a><a href="#h56-1-323" id="h56-1-323" class="i">+                                            requestCode!!
</a><a href="#h56-1-324" id="h56-1-324" class="i">+                                        )
</a><a href="#h56-1-325" id="h56-1-325" class="i">+                                    }) {
</a><a href="#h56-1-326" id="h56-1-326" class="i">+                                        Icon(Icons.Default.Upload, &quot;Upload media&quot;)
</a><a href="#h56-1-327" id="h56-1-327" class="i">+                                    }
</a>                                 }
<a href="#h56-1-329" id="h56-1-329" class="i">+                            }.apply {
</a><a href="#h56-1-330" id="h56-1-330" class="i">+                                tag = buttonTag
</a><a href="#h56-1-331" id="h56-1-331" class="i">+                                layoutParams = FrameLayout.LayoutParams(
</a><a href="#h56-1-332" id="h56-1-332" class="i">+                                    ViewGroup.LayoutParams.MATCH_PARENT,
</a><a href="#h56-1-333" id="h56-1-333" class="i">+                                    ViewGroup.LayoutParams.WRAP_CONTENT
</a><a href="#h56-1-334" id="h56-1-334" class="i">+                                )
</a>                             }
<a href="#h56-1-336" id="h56-1-336" class="d">-                        }.apply {
</a><a href="#h56-1-337" id="h56-1-337" class="d">-                            tag = buttonTag
</a><a href="#h56-1-338" id="h56-1-338" class="d">-                            layoutParams = FrameLayout.LayoutParams(
</a><a href="#h56-1-339" id="h56-1-339" class="d">-                                ViewGroup.LayoutParams.MATCH_PARENT,
</a><a href="#h56-1-340" id="h56-1-340" class="d">-                                ViewGroup.LayoutParams.WRAP_CONTENT
</a><a href="#h56-1-341" id="h56-1-341" class="d">-                            )
</a><a href="#h56-1-342" id="h56-1-342" class="d">-                        }
</a><a href="#h56-1-343" id="h56-1-343" class="d">-                    )
</a><a href="#h56-1-344" id="h56-1-344" class="d">-                }
</a><a href="#h56-1-345" id="h56-1-345" class="d">-                override fun onViewDetachedFromWindow(v: View) {
</a><a href="#h56-1-346" id="h56-1-346" class="d">-                    event.parent.findViewWithTag&lt;View&gt;(buttonTag)?.visibility = View.GONE
</a><a href="#h56-1-347" id="h56-1-347" class="d">-                }
</a><a href="#h56-1-348" id="h56-1-348" class="d">-            })
</a><a href="#h56-1-349" id="h56-1-349" class="i">+                        )
</a><a href="#h56-1-350" id="h56-1-350" class="i">+                    }
</a><a href="#h56-1-351" id="h56-1-351" class="i">+                    override fun onViewDetachedFromWindow(v: View) {
</a><a href="#h56-1-352" id="h56-1-352" class="i">+                        event.parent.findViewWithTag&lt;View&gt;(buttonTag)?.visibility = View.GONE
</a><a href="#h56-1-353" id="h56-1-353" class="i">+                    }
</a><a href="#h56-1-354" id="h56-1-354" class="i">+                })
</a><a href="#h56-1-355" id="h56-1-355" class="i">+            }
</a>         }
     }
 } 
\ No newline at end of file
<b>diff --git a/<a id="h57" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/experiments/MeoPasscodeBypass.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/experiments/MeoPasscodeBypass.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/experiments/MeoPasscodeBypass.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/experiments/MeoPasscodeBypass.kt</a></b>
<a href="#h57-0" id="h57-0" class="h">@@ -1,22 +1,23 @@
</a> package me.rhunk.snapenhance.core.features.impl.experiments
 
 import me.rhunk.snapenhance.core.features.Feature
<a href="#h57-0-3" id="h57-0-3" class="d">-import me.rhunk.snapenhance.core.features.FeatureLoadParams
</a> import me.rhunk.snapenhance.core.util.hook.HookStage
 import me.rhunk.snapenhance.core.util.hook.hook
 import me.rhunk.snapenhance.mapper.impl.BCryptClassMapper
 
<a href="#h57-0-8" id="h57-0-8" class="d">-class MeoPasscodeBypass : Feature(&quot;Meo Passcode Bypass&quot;, loadParams = FeatureLoadParams.ACTIVITY_CREATE_ASYNC) {
</a><a href="#h57-0-9" id="h57-0-9" class="d">-    override fun asyncOnActivityCreate() {
</a><a href="#h57-0-10" id="h57-0-10" class="i">+class MeoPasscodeBypass : Feature(&quot;Meo Passcode Bypass&quot;) {
</a><a href="#h57-0-11" id="h57-0-11" class="i">+    override fun init() {
</a>         if (!context.config.experimental.meoPasscodeBypass.get()) return
 
<a href="#h57-0-14" id="h57-0-14" class="d">-        context.mappings.useMapper(BCryptClassMapper::class) {
</a><a href="#h57-0-15" id="h57-0-15" class="d">-            classReference.get()?.hook(
</a><a href="#h57-0-16" id="h57-0-16" class="d">-                hashMethod.get()!!,
</a><a href="#h57-0-17" id="h57-0-17" class="d">-                HookStage.BEFORE,
</a><a href="#h57-0-18" id="h57-0-18" class="d">-            ) { param -&gt;
</a><a href="#h57-0-19" id="h57-0-19" class="d">-                //set the hash to the result of the method
</a><a href="#h57-0-20" id="h57-0-20" class="d">-                param.setResult(param.arg(1))
</a><a href="#h57-0-21" id="h57-0-21" class="i">+        onNextActivityCreate(defer = true) {
</a><a href="#h57-0-22" id="h57-0-22" class="i">+            context.mappings.useMapper(BCryptClassMapper::class) {
</a><a href="#h57-0-23" id="h57-0-23" class="i">+                classReference.get()?.hook(
</a><a href="#h57-0-24" id="h57-0-24" class="i">+                    hashMethod.get()!!,
</a><a href="#h57-0-25" id="h57-0-25" class="i">+                    HookStage.BEFORE,
</a><a href="#h57-0-26" id="h57-0-26" class="i">+                ) { param -&gt;
</a><a href="#h57-0-27" id="h57-0-27" class="i">+                    //set the hash to the result of the method
</a><a href="#h57-0-28" id="h57-0-28" class="i">+                    param.setResult(param.arg(1))
</a><a href="#h57-0-29" id="h57-0-29" class="i">+                }
</a>             }
         }
     }
<b>diff --git a/<a id="h58" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/experiments/NoFriendScoreDelay.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/experiments/NoFriendScoreDelay.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/experiments/NoFriendScoreDelay.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/experiments/NoFriendScoreDelay.kt</a></b>
<a href="#h58-0" id="h58-0" class="h">@@ -1,24 +1,25 @@
</a> package me.rhunk.snapenhance.core.features.impl.experiments
 
 import me.rhunk.snapenhance.core.features.Feature
<a href="#h58-0-3" id="h58-0-3" class="d">-import me.rhunk.snapenhance.core.features.FeatureLoadParams
</a> import me.rhunk.snapenhance.core.util.hook.HookStage
 import me.rhunk.snapenhance.core.util.hook.hookConstructor
 import me.rhunk.snapenhance.mapper.impl.ScoreUpdateMapper
 import kotlin.time.Duration.Companion.days
 import kotlin.time.Duration.Companion.minutes
 
<a href="#h58-0-10" id="h58-0-10" class="d">-class NoFriendScoreDelay : Feature(&quot;NoFriendScoreDelay&quot;, loadParams = FeatureLoadParams.ACTIVITY_CREATE_SYNC) {
</a><a href="#h58-0-11" id="h58-0-11" class="d">-    override fun onActivityCreate() {
</a><a href="#h58-0-12" id="h58-0-12" class="i">+class NoFriendScoreDelay : Feature(&quot;NoFriendScoreDelay&quot;) {
</a><a href="#h58-0-13" id="h58-0-13" class="i">+    override fun init() {
</a>         if (!context.config.experimental.noFriendScoreDelay.get()) return
 
<a href="#h58-0-16" id="h58-0-16" class="d">-        context.mappings.useMapper(ScoreUpdateMapper::class) {
</a><a href="#h58-0-17" id="h58-0-17" class="d">-            classReference.get()?.hookConstructor(HookStage.BEFORE) { param -&gt;
</a><a href="#h58-0-18" id="h58-0-18" class="d">-                param.args().indexOfFirst {
</a><a href="#h58-0-19" id="h58-0-19" class="d">-                    val longValue = it.toString().toLongOrNull() ?: return@indexOfFirst false
</a><a href="#h58-0-20" id="h58-0-20" class="d">-                    longValue &gt; 30.minutes.inWholeMilliseconds &amp;&amp; longValue &lt; 10.days.inWholeMilliseconds
</a><a href="#h58-0-21" id="h58-0-21" class="d">-                }.takeIf { it != -1 }?.let { index -&gt;
</a><a href="#h58-0-22" id="h58-0-22" class="d">-                    param.setArg(index, 0)
</a><a href="#h58-0-23" id="h58-0-23" class="i">+        onNextActivityCreate {
</a><a href="#h58-0-24" id="h58-0-24" class="i">+            context.mappings.useMapper(ScoreUpdateMapper::class) {
</a><a href="#h58-0-25" id="h58-0-25" class="i">+                classReference.get()?.hookConstructor(HookStage.BEFORE) { param -&gt;
</a><a href="#h58-0-26" id="h58-0-26" class="i">+                    param.args().indexOfFirst {
</a><a href="#h58-0-27" id="h58-0-27" class="i">+                        val longValue = it.toString().toLongOrNull() ?: return@indexOfFirst false
</a><a href="#h58-0-28" id="h58-0-28" class="i">+                        longValue &gt; 30.minutes.inWholeMilliseconds &amp;&amp; longValue &lt; 10.days.inWholeMilliseconds
</a><a href="#h58-0-29" id="h58-0-29" class="i">+                    }.takeIf { it != -1 }?.let { index -&gt;
</a><a href="#h58-0-30" id="h58-0-30" class="i">+                        param.setArg(index, 0)
</a><a href="#h58-0-31" id="h58-0-31" class="i">+                    }
</a>                 }
             }
         }
<b>diff --git a/<a id="h59" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/experiments/PreventForcedLogout.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/experiments/PreventForcedLogout.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/experiments/PreventForcedLogout.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/experiments/PreventForcedLogout.kt</a></b>
<a href="#h59-0" id="h59-0" class="h">@@ -2,11 +2,10 @@ package me.rhunk.snapenhance.core.features.impl.experiments
</a> 
 import android.content.Intent
 import me.rhunk.snapenhance.core.features.Feature
<a href="#h59-0-3" id="h59-0-3" class="d">-import me.rhunk.snapenhance.core.features.FeatureLoadParams
</a> import me.rhunk.snapenhance.core.util.hook.HookStage
 import me.rhunk.snapenhance.core.util.hook.hook
 
<a href="#h59-0-7" id="h59-0-7" class="d">-class PreventForcedLogout : Feature(&quot;Prevent Forced Logout&quot;, loadParams = FeatureLoadParams.INIT_SYNC) {
</a><a href="#h59-0-8" id="h59-0-8" class="i">+class PreventForcedLogout : Feature(&quot;Prevent Forced Logout&quot;) {
</a>     override fun init() {
         if (!context.config.experimental.preventForcedLogout.get()) return
         findClass(&quot;com.snap.identity.service.ForcedLogoutBroadcastReceiver&quot;).hook(&quot;onReceive&quot;, HookStage.BEFORE) { param -&gt;
<b>diff --git a/<a id="h60" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/global/BypassVideoLengthRestriction.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/global/BypassVideoLengthRestriction.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/global/BypassVideoLengthRestriction.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/global/BypassVideoLengthRestriction.kt</a></b>
<a href="#h60-0" id="h60-0" class="h">@@ -5,7 +5,6 @@ import android.os.FileObserver
</a> import com.google.gson.JsonParser
 import me.rhunk.snapenhance.core.event.events.impl.SendMessageWithContentEvent
 import me.rhunk.snapenhance.core.features.Feature
<a href="#h60-0-3" id="h60-0-3" class="d">-import me.rhunk.snapenhance.core.features.FeatureLoadParams
</a> import me.rhunk.snapenhance.core.util.hook.HookStage
 import me.rhunk.snapenhance.core.util.hook.hookConstructor
 import me.rhunk.snapenhance.core.util.ktx.setObjectField
<a href="#h60-1" id="h60-1" class="h">@@ -13,63 +12,65 @@ import me.rhunk.snapenhance.mapper.impl.DefaultMediaItemMapper
</a> import java.io.File
 
 class BypassVideoLengthRestriction :
<a href="#h60-1-3" id="h60-1-3" class="d">-    Feature(&quot;BypassVideoLengthRestriction&quot;, loadParams = FeatureLoadParams.ACTIVITY_CREATE_ASYNC) {
</a><a href="#h60-1-4" id="h60-1-4" class="i">+    Feature(&quot;BypassVideoLengthRestriction&quot;) {
</a>     private lateinit var fileObserver: FileObserver
 
<a href="#h60-1-7" id="h60-1-7" class="d">-    override fun asyncOnActivityCreate() {
</a><a href="#h60-1-8" id="h60-1-8" class="d">-        val mode = context.config.global.bypassVideoLengthRestriction.getNullable()
</a><a href="#h60-1-9" id="h60-1-9" class="i">+    override fun init() {
</a><a href="#h60-1-10" id="h60-1-10" class="i">+        onNextActivityCreate(defer = true) {
</a><a href="#h60-1-11" id="h60-1-11" class="i">+            val mode = context.config.global.bypassVideoLengthRestriction.getNullable()
</a> 
<a href="#h60-1-13" id="h60-1-13" class="d">-        if (mode == &quot;single&quot;) {
</a><a href="#h60-1-14" id="h60-1-14" class="d">-            //fix black videos when story is posted
</a><a href="#h60-1-15" id="h60-1-15" class="d">-            if (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.Q) {
</a><a href="#h60-1-16" id="h60-1-16" class="d">-                val postedStorySnapFolder =
</a><a href="#h60-1-17" id="h60-1-17" class="d">-                    File(context.androidContext.filesDir, &quot;file_manager/posted_story_snap&quot;)
</a><a href="#h60-1-18" id="h60-1-18" class="i">+            if (mode == &quot;single&quot;) {
</a><a href="#h60-1-19" id="h60-1-19" class="i">+                //fix black videos when story is posted
</a><a href="#h60-1-20" id="h60-1-20" class="i">+                if (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.Q) {
</a><a href="#h60-1-21" id="h60-1-21" class="i">+                    val postedStorySnapFolder =
</a><a href="#h60-1-22" id="h60-1-22" class="i">+                        File(context.androidContext.filesDir, &quot;file_manager/posted_story_snap&quot;)
</a> 
<a href="#h60-1-24" id="h60-1-24" class="d">-                fileObserver = (object : FileObserver(postedStorySnapFolder, MOVED_TO) {
</a><a href="#h60-1-25" id="h60-1-25" class="d">-                    override fun onEvent(event: Int, path: String?) {
</a><a href="#h60-1-26" id="h60-1-26" class="d">-                        if (event != MOVED_TO || path?.endsWith(&quot;posted_story_snap.2&quot;) != true) return
</a><a href="#h60-1-27" id="h60-1-27" class="d">-                        fileObserver.stopWatching()
</a><a href="#h60-1-28" id="h60-1-28" class="i">+                    fileObserver = (object : FileObserver(postedStorySnapFolder, MOVED_TO) {
</a><a href="#h60-1-29" id="h60-1-29" class="i">+                        override fun onEvent(event: Int, path: String?) {
</a><a href="#h60-1-30" id="h60-1-30" class="i">+                            if (event != MOVED_TO || path?.endsWith(&quot;posted_story_snap.2&quot;) != true) return
</a><a href="#h60-1-31" id="h60-1-31" class="i">+                            fileObserver.stopWatching()
</a> 
<a href="#h60-1-33" id="h60-1-33" class="d">-                        val file = File(postedStorySnapFolder, path)
</a><a href="#h60-1-34" id="h60-1-34" class="d">-                        runCatching {
</a><a href="#h60-1-35" id="h60-1-35" class="d">-                            val fileContent = JsonParser.parseReader(file.reader()).asJsonObject
</a><a href="#h60-1-36" id="h60-1-36" class="d">-                            if (fileContent[&quot;timerOrDuration&quot;].asLong &lt; 0) file.delete()
</a><a href="#h60-1-37" id="h60-1-37" class="d">-                        }.onFailure {
</a><a href="#h60-1-38" id="h60-1-38" class="d">-                            context.log.error(&quot;Failed to read story metadata file&quot;, it)
</a><a href="#h60-1-39" id="h60-1-39" class="i">+                            val file = File(postedStorySnapFolder, path)
</a><a href="#h60-1-40" id="h60-1-40" class="i">+                            runCatching {
</a><a href="#h60-1-41" id="h60-1-41" class="i">+                                val fileContent = JsonParser.parseReader(file.reader()).asJsonObject
</a><a href="#h60-1-42" id="h60-1-42" class="i">+                                if (fileContent[&quot;timerOrDuration&quot;].asLong &lt; 0) file.delete()
</a><a href="#h60-1-43" id="h60-1-43" class="i">+                            }.onFailure {
</a><a href="#h60-1-44" id="h60-1-44" class="i">+                                context.log.error(&quot;Failed to read story metadata file&quot;, it)
</a><a href="#h60-1-45" id="h60-1-45" class="i">+                            }
</a>                         }
<a href="#h60-1-47" id="h60-1-47" class="d">-                    }
</a><a href="#h60-1-48" id="h60-1-48" class="d">-                })
</a><a href="#h60-1-49" id="h60-1-49" class="i">+                    })
</a> 
<a href="#h60-1-51" id="h60-1-51" class="d">-                context.event.subscribe(SendMessageWithContentEvent::class) { event -&gt;
</a><a href="#h60-1-52" id="h60-1-52" class="d">-                    if (event.destinations.stories!!.isEmpty()) return@subscribe
</a><a href="#h60-1-53" id="h60-1-53" class="d">-                    fileObserver.startWatching()
</a><a href="#h60-1-54" id="h60-1-54" class="i">+                    context.event.subscribe(SendMessageWithContentEvent::class) { event -&gt;
</a><a href="#h60-1-55" id="h60-1-55" class="i">+                        if (event.destinations.stories!!.isEmpty()) return@subscribe
</a><a href="#h60-1-56" id="h60-1-56" class="i">+                        fileObserver.startWatching()
</a><a href="#h60-1-57" id="h60-1-57" class="i">+                    }
</a>                 }
<a href="#h60-1-59" id="h60-1-59" class="d">-            }
</a> 
<a href="#h60-1-61" id="h60-1-61" class="d">-            context.mappings.useMapper(DefaultMediaItemMapper::class) {
</a><a href="#h60-1-62" id="h60-1-62" class="d">-                defaultMediaItem.getAsClass()?.hookConstructor(HookStage.BEFORE) { param -&gt;
</a><a href="#h60-1-63" id="h60-1-63" class="d">-                    //set the video length argument
</a><a href="#h60-1-64" id="h60-1-64" class="d">-                    param.setArg(5, -1L)
</a><a href="#h60-1-65" id="h60-1-65" class="i">+                context.mappings.useMapper(DefaultMediaItemMapper::class) {
</a><a href="#h60-1-66" id="h60-1-66" class="i">+                    defaultMediaItem.getAsClass()?.hookConstructor(HookStage.BEFORE) { param -&gt;
</a><a href="#h60-1-67" id="h60-1-67" class="i">+                        //set the video length argument
</a><a href="#h60-1-68" id="h60-1-68" class="i">+                        param.setArg(5, -1L)
</a><a href="#h60-1-69" id="h60-1-69" class="i">+                    }
</a>                 }
             }
<a href="#h60-1-72" id="h60-1-72" class="d">-        }
</a> 
<a href="#h60-1-74" id="h60-1-74" class="d">-        //TODO: allow split from any source
</a><a href="#h60-1-75" id="h60-1-75" class="d">-        if (mode == &quot;split&quot;) {
</a><a href="#h60-1-76" id="h60-1-76" class="d">-            // memories grid
</a><a href="#h60-1-77" id="h60-1-77" class="d">-            context.mappings.useMapper(DefaultMediaItemMapper::class) {
</a><a href="#h60-1-78" id="h60-1-78" class="d">-                cameraRollMediaId.getAsClass()?.hookConstructor(HookStage.AFTER) { param -&gt;
</a><a href="#h60-1-79" id="h60-1-79" class="d">-                    //set the durationMs field
</a><a href="#h60-1-80" id="h60-1-80" class="d">-                    param.thisObject&lt;Any&gt;()
</a><a href="#h60-1-81" id="h60-1-81" class="d">-                        .setObjectField(durationMsField.get()!!, -1L)
</a><a href="#h60-1-82" id="h60-1-82" class="i">+            //TODO: allow split from any source
</a><a href="#h60-1-83" id="h60-1-83" class="i">+            if (mode == &quot;split&quot;) {
</a><a href="#h60-1-84" id="h60-1-84" class="i">+                // memories grid
</a><a href="#h60-1-85" id="h60-1-85" class="i">+                context.mappings.useMapper(DefaultMediaItemMapper::class) {
</a><a href="#h60-1-86" id="h60-1-86" class="i">+                    cameraRollMediaId.getAsClass()?.hookConstructor(HookStage.AFTER) { param -&gt;
</a><a href="#h60-1-87" id="h60-1-87" class="i">+                        //set the durationMs field
</a><a href="#h60-1-88" id="h60-1-88" class="i">+                        param.thisObject&lt;Any&gt;()
</a><a href="#h60-1-89" id="h60-1-89" class="i">+                            .setObjectField(durationMsField.get()!!, -1L)
</a><a href="#h60-1-90" id="h60-1-90" class="i">+                    }
</a>                 }
<a href="#h60-1-92" id="h60-1-92" class="d">-            }
</a> 
<a href="#h60-1-94" id="h60-1-94" class="d">-            // chat camera roll grid
</a><a href="#h60-1-95" id="h60-1-95" class="d">-            findClass(&quot;com.snap.composer.memories.MemoriesPickerVideoDurationConfig&quot;).hookConstructor(HookStage.AFTER) { param -&gt;
</a><a href="#h60-1-96" id="h60-1-96" class="d">-                param.thisObject&lt;Any&gt;().apply {
</a><a href="#h60-1-97" id="h60-1-97" class="d">-                    setObjectField(&quot;_maxSingleItemDurationMs&quot;, null)
</a><a href="#h60-1-98" id="h60-1-98" class="d">-                    setObjectField(&quot;_maxTotalDurationMs&quot;, null)
</a><a href="#h60-1-99" id="h60-1-99" class="i">+                // chat camera roll grid
</a><a href="#h60-1-100" id="h60-1-100" class="i">+                findClass(&quot;com.snap.composer.memories.MemoriesPickerVideoDurationConfig&quot;).hookConstructor(HookStage.AFTER) { param -&gt;
</a><a href="#h60-1-101" id="h60-1-101" class="i">+                    param.thisObject&lt;Any&gt;().apply {
</a><a href="#h60-1-102" id="h60-1-102" class="i">+                        setObjectField(&quot;_maxSingleItemDurationMs&quot;, null)
</a><a href="#h60-1-103" id="h60-1-103" class="i">+                        setObjectField(&quot;_maxTotalDurationMs&quot;, null)
</a><a href="#h60-1-104" id="h60-1-104" class="i">+                    }
</a>                 }
             }
         }
<b>diff --git a/<a id="h61" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/global/DisableCustomTabs.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/global/DisableCustomTabs.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/global/DisableCustomTabs.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/global/DisableCustomTabs.kt</a></b>
<a href="#h61-0" id="h61-0" class="h">@@ -2,17 +2,18 @@ package me.rhunk.snapenhance.core.features.impl.global
</a> 
 import android.content.Intent
 import me.rhunk.snapenhance.core.features.Feature
<a href="#h61-0-3" id="h61-0-3" class="d">-import me.rhunk.snapenhance.core.features.FeatureLoadParams
</a> import me.rhunk.snapenhance.core.util.hook.HookStage
 import me.rhunk.snapenhance.core.util.hook.hook
 
<a href="#h61-0-7" id="h61-0-7" class="d">-class DisableCustomTabs: Feature(&quot;Disable Custom Tabs&quot;, loadParams = FeatureLoadParams.ACTIVITY_CREATE_SYNC) {
</a><a href="#h61-0-8" id="h61-0-8" class="d">-    override fun onActivityCreate() {
</a><a href="#h61-0-9" id="h61-0-9" class="i">+class DisableCustomTabs: Feature(&quot;Disable Custom Tabs&quot;) {
</a><a href="#h61-0-10" id="h61-0-10" class="i">+    override fun init() {
</a>         if (!context.config.global.disableCustomTabs.get()) return
<a href="#h61-0-12" id="h61-0-12" class="d">-        context.mainActivity!!.packageManager.javaClass.hook(&quot;resolveService&quot;, HookStage.BEFORE) { param -&gt;
</a><a href="#h61-0-13" id="h61-0-13" class="d">-            val intent = param.arg&lt;Intent&gt;(0)
</a><a href="#h61-0-14" id="h61-0-14" class="d">-            if (intent.action == &quot;android.support.customtabs.action.CustomTabsService&quot;) {
</a><a href="#h61-0-15" id="h61-0-15" class="d">-                param.setResult(null)
</a><a href="#h61-0-16" id="h61-0-16" class="i">+        onNextActivityCreate { activity -&gt;
</a><a href="#h61-0-17" id="h61-0-17" class="i">+            activity.packageManager.javaClass.hook(&quot;resolveService&quot;, HookStage.BEFORE) { param -&gt;
</a><a href="#h61-0-18" id="h61-0-18" class="i">+                val intent = param.arg&lt;Intent&gt;(0)
</a><a href="#h61-0-19" id="h61-0-19" class="i">+                if (intent.action == &quot;android.support.customtabs.action.CustomTabsService&quot;) {
</a><a href="#h61-0-20" id="h61-0-20" class="i">+                    param.setResult(null)
</a><a href="#h61-0-21" id="h61-0-21" class="i">+                }
</a>             }
         }
     }
<b>diff --git a/<a id="h62" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/global/DisableMemoriesSnapFeed.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/global/DisableMemoriesSnapFeed.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/global/DisableMemoriesSnapFeed.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/global/DisableMemoriesSnapFeed.kt</a></b>
<a href="#h62-0" id="h62-0" class="h">@@ -1,24 +1,24 @@
</a> package me.rhunk.snapenhance.core.features.impl.global
 
 import me.rhunk.snapenhance.core.features.Feature
<a href="#h62-0-3" id="h62-0-3" class="d">-import me.rhunk.snapenhance.core.features.FeatureLoadParams
</a> import me.rhunk.snapenhance.core.util.hook.HookStage
 import me.rhunk.snapenhance.core.util.hook.hook
 import me.rhunk.snapenhance.mapper.impl.MemoriesPresenterMapper
 
<a href="#h62-0-8" id="h62-0-8" class="d">-class DisableMemoriesSnapFeed : Feature(&quot;Disable Memories Snap Feed&quot;, loadParams = FeatureLoadParams.ACTIVITY_CREATE_SYNC) {
</a><a href="#h62-0-9" id="h62-0-9" class="d">-    override fun onActivityCreate() {
</a><a href="#h62-0-10" id="h62-0-10" class="i">+class DisableMemoriesSnapFeed : Feature(&quot;Disable Memories Snap Feed&quot;) {
</a><a href="#h62-0-11" id="h62-0-11" class="i">+    override fun init() {
</a>         if (!context.config.global.disableMemoriesSnapFeed.get()) return
<a href="#h62-0-13" id="h62-0-13" class="i">+        onNextActivityCreate {
</a><a href="#h62-0-14" id="h62-0-14" class="i">+            context.mappings.useMapper(MemoriesPresenterMapper::class) {
</a><a href="#h62-0-15" id="h62-0-15" class="i">+                classReference.get()?.apply {
</a><a href="#h62-0-16" id="h62-0-16" class="i">+                    val getNameMethod = getMethod(&quot;getName&quot;) ?: return@apply
</a> 
<a href="#h62-0-18" id="h62-0-18" class="d">-        context.mappings.useMapper(MemoriesPresenterMapper::class) {
</a><a href="#h62-0-19" id="h62-0-19" class="d">-            classReference.get()?.apply {
</a><a href="#h62-0-20" id="h62-0-20" class="d">-                val getNameMethod = getMethod(&quot;getName&quot;) ?: return@apply
</a><a href="#h62-0-21" id="h62-0-21" class="i">+                    hook(onNavigationEventMethod.get()!!, HookStage.BEFORE) { param -&gt;
</a><a href="#h62-0-22" id="h62-0-22" class="i">+                        val instance = param.thisObject&lt;Any&gt;()
</a> 
<a href="#h62-0-24" id="h62-0-24" class="d">-                hook(onNavigationEventMethod.get()!!, HookStage.BEFORE) { param -&gt;
</a><a href="#h62-0-25" id="h62-0-25" class="d">-                    val instance = param.thisObject&lt;Any&gt;()
</a><a href="#h62-0-26" id="h62-0-26" class="d">-
</a><a href="#h62-0-27" id="h62-0-27" class="d">-                    if (getNameMethod.invoke(instance) == &quot;MemoriesAsyncPresenterFragmentSubscriber&quot;) {
</a><a href="#h62-0-28" id="h62-0-28" class="d">-                        param.setResult(null)
</a><a href="#h62-0-29" id="h62-0-29" class="i">+                        if (getNameMethod.invoke(instance) == &quot;MemoriesAsyncPresenterFragmentSubscriber&quot;) {
</a><a href="#h62-0-30" id="h62-0-30" class="i">+                            param.setResult(null)
</a><a href="#h62-0-31" id="h62-0-31" class="i">+                        }
</a>                     }
                 }
             }
<b>diff --git a/<a id="h63" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/global/DisableMetrics.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/global/DisableMetrics.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/global/DisableMetrics.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/global/DisableMetrics.kt</a></b>
<a href="#h63-0" id="h63-0" class="h">@@ -4,9 +4,8 @@ import me.rhunk.snapenhance.common.util.protobuf.ProtoReader
</a> import me.rhunk.snapenhance.core.event.events.impl.NetworkApiRequestEvent
 import me.rhunk.snapenhance.core.event.events.impl.UnaryCallEvent
 import me.rhunk.snapenhance.core.features.Feature
<a href="#h63-0-3" id="h63-0-3" class="d">-import me.rhunk.snapenhance.core.features.FeatureLoadParams
</a> 
<a href="#h63-0-5" id="h63-0-5" class="d">-class DisableMetrics : Feature(&quot;DisableMetrics&quot;, loadParams = FeatureLoadParams.INIT_SYNC) {
</a><a href="#h63-0-6" id="h63-0-6" class="i">+class DisableMetrics : Feature(&quot;DisableMetrics&quot;) {
</a>     override fun init() {
         if (!context.config.global.disableMetrics.get()) return
 
<b>diff --git a/<a id="h64" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/global/DisableTelecomFramework.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/global/DisableTelecomFramework.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/global/DisableTelecomFramework.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/global/DisableTelecomFramework.kt</a></b>
<a href="#h64-0" id="h64-0" class="h">@@ -2,11 +2,10 @@ package me.rhunk.snapenhance.core.features.impl.global
</a> 
 import android.content.ContextWrapper
 import me.rhunk.snapenhance.core.features.Feature
<a href="#h64-0-3" id="h64-0-3" class="d">-import me.rhunk.snapenhance.core.features.FeatureLoadParams
</a> import me.rhunk.snapenhance.core.util.hook.HookStage
 import me.rhunk.snapenhance.core.util.hook.hook
 
<a href="#h64-0-7" id="h64-0-7" class="d">-class DisableTelecomFramework: Feature(&quot;Disable Telecom Framework&quot;, loadParams = FeatureLoadParams.INIT_SYNC) {
</a><a href="#h64-0-8" id="h64-0-8" class="i">+class DisableTelecomFramework: Feature(&quot;Disable Telecom Framework&quot;) {
</a>     override fun init() {
         if (!context.config.global.disableTelecomFramework.get()) return
 
<b>diff --git a/<a id="h65" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/global/GooglePlayServicesDialogs.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/global/GooglePlayServicesDialogs.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/global/GooglePlayServicesDialogs.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/global/GooglePlayServicesDialogs.kt</a></b>
<a href="#h65-0" id="h65-0" class="h">@@ -2,21 +2,22 @@ package me.rhunk.snapenhance.core.features.impl.global
</a> 
 import android.app.AlertDialog
 import me.rhunk.snapenhance.core.features.Feature
<a href="#h65-0-3" id="h65-0-3" class="d">-import me.rhunk.snapenhance.core.features.FeatureLoadParams
</a> import me.rhunk.snapenhance.core.util.hook.HookStage
 import me.rhunk.snapenhance.core.util.hook.hook
 import java.lang.reflect.Modifier
 
<a href="#h65-0-8" id="h65-0-8" class="d">-class GooglePlayServicesDialogs : Feature(&quot;Disable GMS Dialogs&quot;, loadParams = FeatureLoadParams.ACTIVITY_CREATE_ASYNC) {
</a><a href="#h65-0-9" id="h65-0-9" class="d">-    override fun asyncOnActivityCreate() {
</a><a href="#h65-0-10" id="h65-0-10" class="i">+class GooglePlayServicesDialogs : Feature(&quot;Disable GMS Dialogs&quot;) {
</a><a href="#h65-0-11" id="h65-0-11" class="i">+    override fun init() {
</a>         if (!context.config.global.disableGooglePlayDialogs.get()) return
 
<a href="#h65-0-14" id="h65-0-14" class="d">-        findClass(&quot;com.google.android.gms.common.GoogleApiAvailability&quot;).methods
</a><a href="#h65-0-15" id="h65-0-15" class="d">-            .first { Modifier.isStatic(it.modifiers) &amp;&amp; it.returnType == AlertDialog::class.java }.let { method -&gt;
</a><a href="#h65-0-16" id="h65-0-16" class="d">-            method.hook(HookStage.BEFORE) { param -&gt;
</a><a href="#h65-0-17" id="h65-0-17" class="d">-                context.log.verbose(&quot;GoogleApiAvailability.showErrorDialogFragment() called, returning null&quot;)
</a><a href="#h65-0-18" id="h65-0-18" class="d">-                param.setResult(null)
</a><a href="#h65-0-19" id="h65-0-19" class="d">-            }
</a><a href="#h65-0-20" id="h65-0-20" class="i">+        onNextActivityCreate(defer = true) {
</a><a href="#h65-0-21" id="h65-0-21" class="i">+            findClass(&quot;com.google.android.gms.common.GoogleApiAvailability&quot;).methods
</a><a href="#h65-0-22" id="h65-0-22" class="i">+                .first { Modifier.isStatic(it.modifiers) &amp;&amp; it.returnType == AlertDialog::class.java }.let { method -&gt;
</a><a href="#h65-0-23" id="h65-0-23" class="i">+                    method.hook(HookStage.BEFORE) { param -&gt;
</a><a href="#h65-0-24" id="h65-0-24" class="i">+                        context.log.verbose(&quot;GoogleApiAvailability.showErrorDialogFragment() called, returning null&quot;)
</a><a href="#h65-0-25" id="h65-0-25" class="i">+                        param.setResult(null)
</a><a href="#h65-0-26" id="h65-0-26" class="i">+                    }
</a><a href="#h65-0-27" id="h65-0-27" class="i">+                }
</a>         }
     }
 } 
\ No newline at end of file
<b>diff --git a/<a id="h66" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/global/MediaUploadQualityOverride.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/global/MediaUploadQualityOverride.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/global/MediaUploadQualityOverride.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/global/MediaUploadQualityOverride.kt</a></b>
<a href="#h66-0" id="h66-0" class="h">@@ -2,13 +2,12 @@ package me.rhunk.snapenhance.core.features.impl.global
</a> 
 import android.graphics.Bitmap
 import me.rhunk.snapenhance.core.features.Feature
<a href="#h66-0-3" id="h66-0-3" class="d">-import me.rhunk.snapenhance.core.features.FeatureLoadParams
</a> import me.rhunk.snapenhance.core.util.hook.HookStage
 import me.rhunk.snapenhance.core.util.hook.hook
 import me.rhunk.snapenhance.mapper.impl.MediaQualityLevelProviderMapper
 import java.lang.reflect.Method
 
<a href="#h66-0-9" id="h66-0-9" class="d">-class MediaUploadQualityOverride : Feature(&quot;Media Upload Quality Override&quot;, loadParams = FeatureLoadParams.INIT_SYNC) {
</a><a href="#h66-0-10" id="h66-0-10" class="i">+class MediaUploadQualityOverride : Feature(&quot;Media Upload Quality Override&quot;) {
</a>     override fun init() {
         if (context.config.global.mediaUploadQualityConfig.forceVideoUploadSourceQuality.get()) {
             context.mappings.useMapper(MediaQualityLevelProviderMapper::class) {
<b>diff --git a/<a id="h67" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/global/SnapchatPlus.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/global/SnapchatPlus.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/global/SnapchatPlus.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/global/SnapchatPlus.kt</a></b>
<a href="#h67-0" id="h67-0" class="h">@@ -1,7 +1,6 @@
</a> package me.rhunk.snapenhance.core.features.impl.global
 
 import me.rhunk.snapenhance.core.features.Feature
<a href="#h67-0-3" id="h67-0-3" class="d">-import me.rhunk.snapenhance.core.features.FeatureLoadParams
</a> import me.rhunk.snapenhance.core.util.hook.HookStage
 import me.rhunk.snapenhance.core.util.hook.hook
 import me.rhunk.snapenhance.core.util.hook.hookConstructor
<a href="#h67-1" id="h67-1" class="h">@@ -9,7 +8,7 @@ import me.rhunk.snapenhance.core.util.ktx.getObjectField
</a> import me.rhunk.snapenhance.core.util.ktx.setObjectField
 import me.rhunk.snapenhance.mapper.impl.PlusSubscriptionMapper
 
<a href="#h67-1-3" id="h67-1-3" class="d">-class SnapchatPlus: Feature(&quot;SnapchatPlus&quot;, loadParams = FeatureLoadParams.INIT_SYNC) {
</a><a href="#h67-1-4" id="h67-1-4" class="i">+class SnapchatPlus: Feature(&quot;SnapchatPlus&quot;) {
</a>     private val originalSubscriptionTime = (System.currentTimeMillis() - 7776000000L)
     private val expirationTimeMillis = (System.currentTimeMillis() + 15552000000L)
 
<b>diff --git a/<a id="h68" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/messaging/AutoMarkAsRead.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/messaging/AutoMarkAsRead.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/messaging/AutoMarkAsRead.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/messaging/AutoMarkAsRead.kt</a></b>
<a href="#h68-0" id="h68-0" class="h">@@ -11,7 +11,6 @@ import me.rhunk.snapenhance.common.data.ContentType
</a> import me.rhunk.snapenhance.common.data.MessageUpdate
 import me.rhunk.snapenhance.core.event.events.impl.SendMessageWithContentEvent
 import me.rhunk.snapenhance.core.features.Feature
<a href="#h68-0-3" id="h68-0-3" class="d">-import me.rhunk.snapenhance.core.features.FeatureLoadParams
</a> import me.rhunk.snapenhance.core.features.impl.spying.StealthMode
 import me.rhunk.snapenhance.core.ui.ViewAppearanceHelper
 import me.rhunk.snapenhance.core.util.ktx.getObjectFieldOrNull
<a href="#h68-1" id="h68-1" class="h">@@ -19,7 +18,7 @@ import kotlin.coroutines.resume
</a> import kotlin.coroutines.suspendCoroutine
 import kotlin.random.Random
 
<a href="#h68-1-3" id="h68-1-3" class="d">-class AutoMarkAsRead : Feature(&quot;Auto Mark As Read&quot;, loadParams = FeatureLoadParams.INIT_SYNC) {
</a><a href="#h68-1-4" id="h68-1-4" class="i">+class AutoMarkAsRead : Feature(&quot;Auto Mark As Read&quot;) {
</a>     val canMarkConversationAsRead by lazy { context.config.messaging.autoMarkAsRead.get().contains(&quot;conversation_read&quot;) }
 
     fun markConversationsAsRead(conversationIds: List&lt;String&gt;) {
<b>diff --git a/<a id="h69" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/messaging/AutoSave.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/messaging/AutoSave.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/messaging/AutoSave.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/messaging/AutoSave.kt</a></b>
<a href="#h69-0" id="h69-0" class="h">@@ -4,7 +4,6 @@ import me.rhunk.snapenhance.common.data.MessageState
</a> import me.rhunk.snapenhance.common.data.MessageUpdate
 import me.rhunk.snapenhance.common.data.MessagingRuleType
 import me.rhunk.snapenhance.core.event.events.impl.ConversationUpdateEvent
<a href="#h69-0-3" id="h69-0-3" class="d">-import me.rhunk.snapenhance.core.features.FeatureLoadParams
</a> import me.rhunk.snapenhance.core.features.MessagingRuleFeature
 import me.rhunk.snapenhance.core.features.impl.spying.MessageLogger
 import me.rhunk.snapenhance.core.features.impl.spying.StealthMode
<a href="#h69-1" id="h69-1" class="h">@@ -16,7 +15,7 @@ import me.rhunk.snapenhance.core.wrapper.impl.SnapUUID
</a> import me.rhunk.snapenhance.mapper.impl.CallbackMapper
 import java.util.concurrent.Executors
 
<a href="#h69-1-3" id="h69-1-3" class="d">-class AutoSave : MessagingRuleFeature(&quot;Auto Save&quot;, MessagingRuleType.AUTO_SAVE, loadParams = FeatureLoadParams.ACTIVITY_CREATE_ASYNC) {
</a><a href="#h69-1-4" id="h69-1-4" class="i">+class AutoSave : MessagingRuleFeature(&quot;Auto Save&quot;, MessagingRuleType.AUTO_SAVE) {
</a>     private val asyncSaveExecutorService = Executors.newSingleThreadExecutor()
 
     private val messageLogger by lazy { context.feature(MessageLogger::class) }
<a href="#h69-2" id="h69-2" class="h">@@ -68,37 +67,39 @@ class AutoSave : MessagingRuleFeature(&quot;Auto Save&quot;, MessagingRuleType.AUTO_SAVE, 
</a>         return canUseRule(targetConversationId)
     }
 
<a href="#h69-2-3" id="h69-2-3" class="d">-    override fun asyncOnActivityCreate() {
</a><a href="#h69-2-4" id="h69-2-4" class="d">-        // called when enter in a conversation
</a><a href="#h69-2-5" id="h69-2-5" class="d">-        context.mappings.useMapper(CallbackMapper::class) {
</a><a href="#h69-2-6" id="h69-2-6" class="d">-            callbacks.getClass(&quot;FetchConversationWithMessagesCallback&quot;)?.hook(
</a><a href="#h69-2-7" id="h69-2-7" class="d">-                &quot;onFetchConversationWithMessagesComplete&quot;,
</a><a href="#h69-2-8" id="h69-2-8" class="d">-                HookStage.BEFORE,
</a><a href="#h69-2-9" id="h69-2-9" class="d">-                { autoSaveFilter.isNotEmpty() }
</a><a href="#h69-2-10" id="h69-2-10" class="d">-            ) { param -&gt;
</a><a href="#h69-2-11" id="h69-2-11" class="d">-                val conversationId = SnapUUID(param.arg&lt;Any&gt;(0).getObjectField(&quot;mConversationId&quot;)!!)
</a><a href="#h69-2-12" id="h69-2-12" class="d">-                if (!canSaveInConversation(conversationId.toString())) return@hook
</a><a href="#h69-2-13" id="h69-2-13" class="d">-
</a><a href="#h69-2-14" id="h69-2-14" class="d">-                val messages = param.arg&lt;List&lt;Any&gt;&gt;(1).map { Message(it) }
</a><a href="#h69-2-15" id="h69-2-15" class="d">-                messages.forEach {
</a><a href="#h69-2-16" id="h69-2-16" class="d">-                    if (!canSaveMessage(it)) return@forEach
</a><a href="#h69-2-17" id="h69-2-17" class="d">-                    asyncSaveExecutorService.submit {
</a><a href="#h69-2-18" id="h69-2-18" class="d">-                        saveMessage(conversationId.toString(), it)
</a><a href="#h69-2-19" id="h69-2-19" class="i">+    override fun init() {
</a><a href="#h69-2-20" id="h69-2-20" class="i">+        onNextActivityCreate(defer = true) {
</a><a href="#h69-2-21" id="h69-2-21" class="i">+            // called when enter in a conversation
</a><a href="#h69-2-22" id="h69-2-22" class="i">+            context.mappings.useMapper(CallbackMapper::class) {
</a><a href="#h69-2-23" id="h69-2-23" class="i">+                callbacks.getClass(&quot;FetchConversationWithMessagesCallback&quot;)?.hook(
</a><a href="#h69-2-24" id="h69-2-24" class="i">+                    &quot;onFetchConversationWithMessagesComplete&quot;,
</a><a href="#h69-2-25" id="h69-2-25" class="i">+                    HookStage.BEFORE,
</a><a href="#h69-2-26" id="h69-2-26" class="i">+                    { autoSaveFilter.isNotEmpty() }
</a><a href="#h69-2-27" id="h69-2-27" class="i">+                ) { param -&gt;
</a><a href="#h69-2-28" id="h69-2-28" class="i">+                    val conversationId = SnapUUID(param.arg&lt;Any&gt;(0).getObjectField(&quot;mConversationId&quot;)!!)
</a><a href="#h69-2-29" id="h69-2-29" class="i">+                    if (!canSaveInConversation(conversationId.toString())) return@hook
</a><a href="#h69-2-30" id="h69-2-30" class="i">+
</a><a href="#h69-2-31" id="h69-2-31" class="i">+                    val messages = param.arg&lt;List&lt;Any&gt;&gt;(1).map { Message(it) }
</a><a href="#h69-2-32" id="h69-2-32" class="i">+                    messages.forEach {
</a><a href="#h69-2-33" id="h69-2-33" class="i">+                        if (!canSaveMessage(it)) return@forEach
</a><a href="#h69-2-34" id="h69-2-34" class="i">+                        asyncSaveExecutorService.submit {
</a><a href="#h69-2-35" id="h69-2-35" class="i">+                            saveMessage(conversationId.toString(), it)
</a><a href="#h69-2-36" id="h69-2-36" class="i">+                        }
</a>                     }
                 }
             }
<a href="#h69-2-40" id="h69-2-40" class="d">-        }
</a> 
<a href="#h69-2-42" id="h69-2-42" class="d">-        context.event.subscribe(
</a><a href="#h69-2-43" id="h69-2-43" class="d">-            ConversationUpdateEvent::class,
</a><a href="#h69-2-44" id="h69-2-44" class="d">-            { autoSaveFilter.isNotEmpty() }
</a><a href="#h69-2-45" id="h69-2-45" class="d">-        ) { event -&gt;
</a><a href="#h69-2-46" id="h69-2-46" class="d">-            if (!canSaveInConversation(event.conversationId)) return@subscribe
</a><a href="#h69-2-47" id="h69-2-47" class="i">+            context.event.subscribe(
</a><a href="#h69-2-48" id="h69-2-48" class="i">+                ConversationUpdateEvent::class,
</a><a href="#h69-2-49" id="h69-2-49" class="i">+                { autoSaveFilter.isNotEmpty() }
</a><a href="#h69-2-50" id="h69-2-50" class="i">+            ) { event -&gt;
</a><a href="#h69-2-51" id="h69-2-51" class="i">+                if (!canSaveInConversation(event.conversationId)) return@subscribe
</a> 
<a href="#h69-2-53" id="h69-2-53" class="d">-            event.messages.forEach { message -&gt;
</a><a href="#h69-2-54" id="h69-2-54" class="d">-                if (!canSaveMessage(message)) return@forEach
</a><a href="#h69-2-55" id="h69-2-55" class="d">-                asyncSaveExecutorService.submit {
</a><a href="#h69-2-56" id="h69-2-56" class="d">-                    saveMessage(event.conversationId, message)
</a><a href="#h69-2-57" id="h69-2-57" class="i">+                event.messages.forEach { message -&gt;
</a><a href="#h69-2-58" id="h69-2-58" class="i">+                    if (!canSaveMessage(message)) return@forEach
</a><a href="#h69-2-59" id="h69-2-59" class="i">+                    asyncSaveExecutorService.submit {
</a><a href="#h69-2-60" id="h69-2-60" class="i">+                        saveMessage(event.conversationId, message)
</a><a href="#h69-2-61" id="h69-2-61" class="i">+                    }
</a>                 }
             }
         }
<b>diff --git a/<a id="h70" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/messaging/BypassMessageActionRestrictions.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/messaging/BypassMessageActionRestrictions.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/messaging/BypassMessageActionRestrictions.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/messaging/BypassMessageActionRestrictions.kt</a></b>
<a href="#h70-0" id="h70-0" class="h">@@ -2,15 +2,16 @@ package me.rhunk.snapenhance.core.features.impl.messaging
</a> 
 import me.rhunk.snapenhance.core.event.events.impl.BuildMessageEvent
 import me.rhunk.snapenhance.core.features.Feature
<a href="#h70-0-3" id="h70-0-3" class="d">-import me.rhunk.snapenhance.core.features.FeatureLoadParams
</a> 
<a href="#h70-0-5" id="h70-0-5" class="d">-class BypassMessageActionRestrictions : Feature(&quot;Bypass Message Action Restrictions&quot;, loadParams = FeatureLoadParams.ACTIVITY_CREATE_SYNC) {
</a><a href="#h70-0-6" id="h70-0-6" class="d">-    override fun onActivityCreate() {
</a><a href="#h70-0-7" id="h70-0-7" class="i">+class BypassMessageActionRestrictions : Feature(&quot;Bypass Message Action Restrictions&quot;) {
</a><a href="#h70-0-8" id="h70-0-8" class="i">+    override fun init() {
</a>         if (!context.config.messaging.bypassMessageActionRestrictions.get()) return
<a href="#h70-0-10" id="h70-0-10" class="d">-        context.event.subscribe(BuildMessageEvent::class, priority = 102) { event -&gt;
</a><a href="#h70-0-11" id="h70-0-11" class="d">-            event.message.messageMetadata?.apply {
</a><a href="#h70-0-12" id="h70-0-12" class="d">-                isSaveable = true
</a><a href="#h70-0-13" id="h70-0-13" class="d">-                isReactable = true
</a><a href="#h70-0-14" id="h70-0-14" class="i">+        onNextActivityCreate {
</a><a href="#h70-0-15" id="h70-0-15" class="i">+            context.event.subscribe(BuildMessageEvent::class, priority = 102) { event -&gt;
</a><a href="#h70-0-16" id="h70-0-16" class="i">+                event.message.messageMetadata?.apply {
</a><a href="#h70-0-17" id="h70-0-17" class="i">+                    isSaveable = true
</a><a href="#h70-0-18" id="h70-0-18" class="i">+                    isReactable = true
</a><a href="#h70-0-19" id="h70-0-19" class="i">+                }
</a>             }
         }
     }
<b>diff --git a/<a id="h71" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/messaging/CallStartConfirmation.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/messaging/CallStartConfirmation.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/messaging/CallStartConfirmation.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/messaging/CallStartConfirmation.kt</a></b>
<a href="#h71-0" id="h71-0" class="h">@@ -5,7 +5,6 @@ import android.view.MotionEvent
</a> import android.view.View
 import android.view.ViewGroup
 import me.rhunk.snapenhance.core.features.Feature
<a href="#h71-0-3" id="h71-0-3" class="d">-import me.rhunk.snapenhance.core.features.FeatureLoadParams
</a> import me.rhunk.snapenhance.core.ui.ViewAppearanceHelper
 import me.rhunk.snapenhance.core.ui.children
 import me.rhunk.snapenhance.core.util.hook.HookAdapter
<a href="#h71-1" id="h71-1" class="h">@@ -13,7 +12,7 @@ import me.rhunk.snapenhance.core.util.hook.HookStage
</a> import me.rhunk.snapenhance.core.util.hook.hook
 import me.rhunk.snapenhance.core.util.ktx.getId
 
<a href="#h71-1-3" id="h71-1-3" class="d">-class CallStartConfirmation : Feature(&quot;CallStartConfirmation&quot;, loadParams = FeatureLoadParams.ACTIVITY_CREATE_SYNC) {
</a><a href="#h71-1-4" id="h71-1-4" class="i">+class CallStartConfirmation : Feature(&quot;CallStartConfirmation&quot;) {
</a>     private fun hookTouchEvent(param: HookAdapter, motionEvent: MotionEvent, onConfirm: () -&gt; Unit) {
         if (motionEvent.action != MotionEvent.ACTION_UP) return
         param.setResult(true)
<a href="#h71-2" id="h71-2" class="h">@@ -26,37 +25,39 @@ class CallStartConfirmation : Feature(&quot;CallStartConfirmation&quot;, loadParams = Feat
</a>     }
 
     @SuppressLint(&quot;DiscouragedApi&quot;)
<a href="#h71-2-3" id="h71-2-3" class="d">-    override fun onActivityCreate() {
</a><a href="#h71-2-4" id="h71-2-4" class="i">+    override fun init() {
</a>         if (!context.config.messaging.callStartConfirmation.get()) return
 
<a href="#h71-2-7" id="h71-2-7" class="d">-        val callButtonsStub = context.resources.getId(&quot;call_buttons_stub&quot;)
</a><a href="#h71-2-8" id="h71-2-8" class="i">+        onNextActivityCreate {
</a><a href="#h71-2-9" id="h71-2-9" class="i">+            val callButtonsStub = context.resources.getId(&quot;call_buttons_stub&quot;)
</a> 
<a href="#h71-2-11" id="h71-2-11" class="d">-        findClass(&quot;com.snap.composer.views.ComposerRootView&quot;).hook(&quot;dispatchTouchEvent&quot;, HookStage.BEFORE) { param -&gt;
</a><a href="#h71-2-12" id="h71-2-12" class="d">-            val view = param.thisObject() as? ViewGroup ?: return@hook
</a><a href="#h71-2-13" id="h71-2-13" class="d">-            if (view.id != callButtonsStub) return@hook
</a><a href="#h71-2-14" id="h71-2-14" class="d">-            val childComposerView = view.getChildAt(0) as? ViewGroup ?: return@hook
</a><a href="#h71-2-15" id="h71-2-15" class="d">-            // check if the child composer view contains 2 call buttons
</a><a href="#h71-2-16" id="h71-2-16" class="d">-            if (childComposerView.children().count {
</a><a href="#h71-2-17" id="h71-2-17" class="d">-                it::class.java == childComposerView::class.java
</a><a href="#h71-2-18" id="h71-2-18" class="d">-            } != 2) return@hook
</a><a href="#h71-2-19" id="h71-2-19" class="d">-            hookTouchEvent(param, param.arg(0)) {
</a><a href="#h71-2-20" id="h71-2-20" class="d">-                param.invokeOriginal()
</a><a href="#h71-2-21" id="h71-2-21" class="i">+            findClass(&quot;com.snap.composer.views.ComposerRootView&quot;).hook(&quot;dispatchTouchEvent&quot;, HookStage.BEFORE) { param -&gt;
</a><a href="#h71-2-22" id="h71-2-22" class="i">+                val view = param.thisObject() as? ViewGroup ?: return@hook
</a><a href="#h71-2-23" id="h71-2-23" class="i">+                if (view.id != callButtonsStub) return@hook
</a><a href="#h71-2-24" id="h71-2-24" class="i">+                val childComposerView = view.getChildAt(0) as? ViewGroup ?: return@hook
</a><a href="#h71-2-25" id="h71-2-25" class="i">+                // check if the child composer view contains 2 call buttons
</a><a href="#h71-2-26" id="h71-2-26" class="i">+                if (childComposerView.children().count {
</a><a href="#h71-2-27" id="h71-2-27" class="i">+                        it::class.java == childComposerView::class.java
</a><a href="#h71-2-28" id="h71-2-28" class="i">+                    } != 2) return@hook
</a><a href="#h71-2-29" id="h71-2-29" class="i">+                hookTouchEvent(param, param.arg(0)) {
</a><a href="#h71-2-30" id="h71-2-30" class="i">+                    param.invokeOriginal()
</a><a href="#h71-2-31" id="h71-2-31" class="i">+                }
</a>             }
<a href="#h71-2-33" id="h71-2-33" class="d">-        }
</a> 
<a href="#h71-2-35" id="h71-2-35" class="d">-        val callButton1 = context.resources.getId(&quot;friend_action_button3&quot;)
</a><a href="#h71-2-36" id="h71-2-36" class="d">-        val callButton2 = context.resources.getId(&quot;friend_action_button4&quot;)
</a><a href="#h71-2-37" id="h71-2-37" class="i">+            val callButton1 = context.resources.getId(&quot;friend_action_button3&quot;)
</a><a href="#h71-2-38" id="h71-2-38" class="i">+            val callButton2 = context.resources.getId(&quot;friend_action_button4&quot;)
</a> 
<a href="#h71-2-40" id="h71-2-40" class="d">-        findClass(&quot;com.snap.ui.view.stackdraw.StackDrawLayout&quot;).hook(&quot;onTouchEvent&quot;, HookStage.BEFORE) { param -&gt;
</a><a href="#h71-2-41" id="h71-2-41" class="d">-            val view = param.thisObject&lt;View&gt;()
</a><a href="#h71-2-42" id="h71-2-42" class="d">-            if (view.id != callButton1 &amp;&amp; view.id != callButton2) return@hook
</a><a href="#h71-2-43" id="h71-2-43" class="i">+            findClass(&quot;com.snap.ui.view.stackdraw.StackDrawLayout&quot;).hook(&quot;onTouchEvent&quot;, HookStage.BEFORE) { param -&gt;
</a><a href="#h71-2-44" id="h71-2-44" class="i">+                val view = param.thisObject&lt;View&gt;()
</a><a href="#h71-2-45" id="h71-2-45" class="i">+                if (view.id != callButton1 &amp;&amp; view.id != callButton2) return@hook
</a> 
<a href="#h71-2-47" id="h71-2-47" class="d">-            hookTouchEvent(param, param.arg(0)) {
</a><a href="#h71-2-48" id="h71-2-48" class="d">-                arrayOf(
</a><a href="#h71-2-49" id="h71-2-49" class="d">-                    MotionEvent.obtain(0, 0, MotionEvent.ACTION_DOWN, 0f, 0f, 0),
</a><a href="#h71-2-50" id="h71-2-50" class="d">-                    MotionEvent.obtain(0, 0, MotionEvent.ACTION_UP, 0f, 0f, 0)
</a><a href="#h71-2-51" id="h71-2-51" class="d">-                ).forEach {
</a><a href="#h71-2-52" id="h71-2-52" class="d">-                    param.invokeOriginal(arrayOf(it))
</a><a href="#h71-2-53" id="h71-2-53" class="i">+                hookTouchEvent(param, param.arg(0)) {
</a><a href="#h71-2-54" id="h71-2-54" class="i">+                    arrayOf(
</a><a href="#h71-2-55" id="h71-2-55" class="i">+                        MotionEvent.obtain(0, 0, MotionEvent.ACTION_DOWN, 0f, 0f, 0),
</a><a href="#h71-2-56" id="h71-2-56" class="i">+                        MotionEvent.obtain(0, 0, MotionEvent.ACTION_UP, 0f, 0f, 0)
</a><a href="#h71-2-57" id="h71-2-57" class="i">+                    ).forEach {
</a><a href="#h71-2-58" id="h71-2-58" class="i">+                        param.invokeOriginal(arrayOf(it))
</a><a href="#h71-2-59" id="h71-2-59" class="i">+                    }
</a>                 }
             }
         }
<b>diff --git a/<a id="h72" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/messaging/DisableReplayInFF.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/messaging/DisableReplayInFF.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/messaging/DisableReplayInFF.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/messaging/DisableReplayInFF.kt</a></b>
<a href="#h72-0" id="h72-0" class="h">@@ -1,22 +1,23 @@
</a> package me.rhunk.snapenhance.core.features.impl.messaging
 
 import me.rhunk.snapenhance.core.features.Feature
<a href="#h72-0-3" id="h72-0-3" class="d">-import me.rhunk.snapenhance.core.features.FeatureLoadParams
</a> import me.rhunk.snapenhance.core.util.hook.HookStage
 import me.rhunk.snapenhance.core.util.hook.hookConstructor
 import me.rhunk.snapenhance.core.util.ktx.getObjectField
 import me.rhunk.snapenhance.core.util.ktx.setEnumField
 
<a href="#h72-0-9" id="h72-0-9" class="d">-class DisableReplayInFF : Feature(&quot;DisableReplayInFF&quot;, loadParams = FeatureLoadParams.ACTIVITY_CREATE_ASYNC) {
</a><a href="#h72-0-10" id="h72-0-10" class="d">-    override fun asyncOnActivityCreate() {
</a><a href="#h72-0-11" id="h72-0-11" class="i">+class DisableReplayInFF : Feature(&quot;DisableReplayInFF&quot;) {
</a><a href="#h72-0-12" id="h72-0-12" class="i">+    override fun init() {
</a>         val state by context.config.messaging.disableReplayInFF
 
<a href="#h72-0-15" id="h72-0-15" class="d">-        findClass(&quot;com.snapchat.client.messaging.InteractionInfo&quot;)
</a><a href="#h72-0-16" id="h72-0-16" class="d">-            .hookConstructor(HookStage.AFTER, { state }) { param -&gt;
</a><a href="#h72-0-17" id="h72-0-17" class="d">-            val instance = param.thisObject&lt;Any&gt;()
</a><a href="#h72-0-18" id="h72-0-18" class="d">-            if (instance.getObjectField(&quot;mLongPressActionState&quot;).toString() == &quot;REQUEST_SNAP_REPLAY&quot;) {
</a><a href="#h72-0-19" id="h72-0-19" class="d">-                instance.setEnumField(&quot;mLongPressActionState&quot;, &quot;SHOW_CONVERSATION_ACTION_MENU&quot;)
</a><a href="#h72-0-20" id="h72-0-20" class="d">-            }
</a><a href="#h72-0-21" id="h72-0-21" class="i">+        onNextActivityCreate(defer = true) {
</a><a href="#h72-0-22" id="h72-0-22" class="i">+            findClass(&quot;com.snapchat.client.messaging.InteractionInfo&quot;)
</a><a href="#h72-0-23" id="h72-0-23" class="i">+                .hookConstructor(HookStage.AFTER, { state }) { param -&gt;
</a><a href="#h72-0-24" id="h72-0-24" class="i">+                    val instance = param.thisObject&lt;Any&gt;()
</a><a href="#h72-0-25" id="h72-0-25" class="i">+                    if (instance.getObjectField(&quot;mLongPressActionState&quot;).toString() == &quot;REQUEST_SNAP_REPLAY&quot;) {
</a><a href="#h72-0-26" id="h72-0-26" class="i">+                        instance.setEnumField(&quot;mLongPressActionState&quot;, &quot;SHOW_CONVERSATION_ACTION_MENU&quot;)
</a><a href="#h72-0-27" id="h72-0-27" class="i">+                    }
</a><a href="#h72-0-28" id="h72-0-28" class="i">+                }
</a>         }
     }
 } 
\ No newline at end of file
<b>diff --git a/<a id="h73" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/messaging/Messaging.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/messaging/Messaging.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/messaging/Messaging.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/messaging/Messaging.kt</a></b>
<a href="#h73-0" id="h73-0" class="h">@@ -7,7 +7,6 @@ import me.rhunk.snapenhance.common.ReceiversConfig
</a> import me.rhunk.snapenhance.core.event.events.impl.ConversationUpdateEvent
 import me.rhunk.snapenhance.core.event.events.impl.OnSnapInteractionEvent
 import me.rhunk.snapenhance.core.features.Feature
<a href="#h73-0-3" id="h73-0-3" class="d">-import me.rhunk.snapenhance.core.features.FeatureLoadParams
</a> import me.rhunk.snapenhance.core.features.impl.spying.StealthMode
 import me.rhunk.snapenhance.core.util.EvictingMap
 import me.rhunk.snapenhance.core.util.hook.HookStage
<a href="#h73-1" id="h73-1" class="h">@@ -25,7 +24,7 @@ import me.rhunk.snapenhance.mapper.impl.FriendsFeedEventDispatcherMapper
</a> import java.util.UUID
 import java.util.concurrent.Future
 
<a href="#h73-1-3" id="h73-1-3" class="d">-class Messaging : Feature(&quot;Messaging&quot;, loadParams = FeatureLoadParams.ACTIVITY_CREATE_SYNC or FeatureLoadParams.INIT_ASYNC or FeatureLoadParams.INIT_SYNC) {
</a><a href="#h73-1-4" id="h73-1-4" class="i">+class Messaging : Feature(&quot;Messaging&quot;) {
</a>     var conversationManager: ConversationManager? = null
         private set
     private var conversationManagerDelegate: Any? = null
<a href="#h73-2" id="h73-2" class="h">@@ -48,6 +47,7 @@ class Messaging : Feature(&quot;Messaging&quot;, loadParams = FeatureLoadParams.ACTIVITY_C
</a>     }
 
     override fun init() {
<a href="#h73-2-3" id="h73-2-3" class="i">+        val stealthMode = context.feature(StealthMode::class)
</a>         context.classCache.conversationManager.hookConstructor(HookStage.BEFORE) { param -&gt;
             conversationManager = ConversationManager(context, param.thisObject())
             context.messagingBridge.triggerSessionStart()
<a href="#h73-3" id="h73-3" class="h">@@ -83,6 +83,80 @@ class Messaging : Feature(&quot;Messaging&quot;, loadParams = FeatureLoadParams.ACTIVITY_C
</a>                 }
             }
         }
<a href="#h73-3-3" id="h73-3-3" class="i">+
</a><a href="#h73-3-4" id="h73-3-4" class="i">+        defer {
</a><a href="#h73-3-5" id="h73-3-5" class="i">+            arrayOf(&quot;activate&quot;, &quot;deactivate&quot;, &quot;processTypingActivity&quot;).forEach { hook -&gt;
</a><a href="#h73-3-6" id="h73-3-6" class="i">+                context.classCache.presenceSession.hook(hook, HookStage.BEFORE, {
</a><a href="#h73-3-7" id="h73-3-7" class="i">+                    context.config.messaging.hideBitmojiPresence.get() || stealthMode.canUseRule(openedConversationUUID.toString())
</a><a href="#h73-3-8" id="h73-3-8" class="i">+                }) {
</a><a href="#h73-3-9" id="h73-3-9" class="i">+                    it.setResult(null)
</a><a href="#h73-3-10" id="h73-3-10" class="i">+                }
</a><a href="#h73-3-11" id="h73-3-11" class="i">+            }
</a><a href="#h73-3-12" id="h73-3-12" class="i">+
</a><a href="#h73-3-13" id="h73-3-13" class="i">+            context.classCache.presenceSession.hook(&quot;startPeeking&quot;, HookStage.BEFORE, {
</a><a href="#h73-3-14" id="h73-3-14" class="i">+                context.config.messaging.hidePeekAPeek.get() || stealthMode.canUseRule(openedConversationUUID.toString())
</a><a href="#h73-3-15" id="h73-3-15" class="i">+            }) { it.setResult(null) }
</a><a href="#h73-3-16" id="h73-3-16" class="i">+
</a><a href="#h73-3-17" id="h73-3-17" class="i">+            //get last opened snap for media downloader
</a><a href="#h73-3-18" id="h73-3-18" class="i">+            context.event.subscribe(OnSnapInteractionEvent::class) { event -&gt;
</a><a href="#h73-3-19" id="h73-3-19" class="i">+                openedConversationUUID = event.conversationId
</a><a href="#h73-3-20" id="h73-3-20" class="i">+                lastFocusedMessageId = event.messageId
</a><a href="#h73-3-21" id="h73-3-21" class="i">+            }
</a><a href="#h73-3-22" id="h73-3-22" class="i">+
</a><a href="#h73-3-23" id="h73-3-23" class="i">+            context.classCache.conversationManager.hook(&quot;fetchMessage&quot;, HookStage.BEFORE) { param -&gt;
</a><a href="#h73-3-24" id="h73-3-24" class="i">+                val conversationId = SnapUUID(param.arg(0)).toString()
</a><a href="#h73-3-25" id="h73-3-25" class="i">+                if (openedConversationUUID?.toString() == conversationId) {
</a><a href="#h73-3-26" id="h73-3-26" class="i">+                    lastFocusedMessageId = param.arg(1)
</a><a href="#h73-3-27" id="h73-3-27" class="i">+                }
</a><a href="#h73-3-28" id="h73-3-28" class="i">+            }
</a><a href="#h73-3-29" id="h73-3-29" class="i">+
</a><a href="#h73-3-30" id="h73-3-30" class="i">+            context.classCache.conversationManager.hook(&quot;sendTypingNotification&quot;, HookStage.BEFORE, {
</a><a href="#h73-3-31" id="h73-3-31" class="i">+                context.config.messaging.hideTypingNotifications.get() || stealthMode.canUseRule(openedConversationUUID.toString())
</a><a href="#h73-3-32" id="h73-3-32" class="i">+            }) {
</a><a href="#h73-3-33" id="h73-3-33" class="i">+                it.setResult(null)
</a><a href="#h73-3-34" id="h73-3-34" class="i">+            }
</a><a href="#h73-3-35" id="h73-3-35" class="i">+        }
</a><a href="#h73-3-36" id="h73-3-36" class="i">+
</a><a href="#h73-3-37" id="h73-3-37" class="i">+        onNextActivityCreate {
</a><a href="#h73-3-38" id="h73-3-38" class="i">+            context.mappings.useMapper(FriendsFeedEventDispatcherMapper::class) {
</a><a href="#h73-3-39" id="h73-3-39" class="i">+                classReference.getAsClass()?.hook(&quot;onItemLongPress&quot;, HookStage.BEFORE) { param -&gt;
</a><a href="#h73-3-40" id="h73-3-40" class="i">+                    val viewItemContainer = param.arg&lt;Any&gt;(0)
</a><a href="#h73-3-41" id="h73-3-41" class="i">+                    val viewItem = viewItemContainer.getObjectField(viewModelField.get()!!).toString()
</a><a href="#h73-3-42" id="h73-3-42" class="i">+                    val conversationId = viewItem.substringAfter(&quot;conversationId: &quot;).substring(0, 36).also {
</a><a href="#h73-3-43" id="h73-3-43" class="i">+                        if (it.startsWith(&quot;null&quot;)) return@hook
</a><a href="#h73-3-44" id="h73-3-44" class="i">+                    }
</a><a href="#h73-3-45" id="h73-3-45" class="i">+                    lastFocusedConversationId = conversationId
</a><a href="#h73-3-46" id="h73-3-46" class="i">+                    lastFocusedConversationType = context.database.getConversationType(conversationId) ?: 0
</a><a href="#h73-3-47" id="h73-3-47" class="i">+                }
</a><a href="#h73-3-48" id="h73-3-48" class="i">+            }
</a><a href="#h73-3-49" id="h73-3-49" class="i">+
</a><a href="#h73-3-50" id="h73-3-50" class="i">+            context.classCache.feedEntry.hookConstructor(HookStage.AFTER) { param -&gt;
</a><a href="#h73-3-51" id="h73-3-51" class="i">+                val instance = param.thisObject&lt;Any&gt;()
</a><a href="#h73-3-52" id="h73-3-52" class="i">+                val interactionInfo = instance.getObjectFieldOrNull(&quot;mInteractionInfo&quot;) ?: return@hookConstructor
</a><a href="#h73-3-53" id="h73-3-53" class="i">+                val messages = (interactionInfo.getObjectFieldOrNull(&quot;mMessages&quot;) as? List&lt;*&gt;)?.map { Message(it) } ?: return@hookConstructor
</a><a href="#h73-3-54" id="h73-3-54" class="i">+                val conversationId = SnapUUID(instance.getObjectFieldOrNull(&quot;mConversationId&quot;) ?: return@hookConstructor).toString()
</a><a href="#h73-3-55" id="h73-3-55" class="i">+                val myUserId = context.database.myUserId
</a><a href="#h73-3-56" id="h73-3-56" class="i">+
</a><a href="#h73-3-57" id="h73-3-57" class="i">+                feedCachedSnapMessages[conversationId] = messages.filter { msg -&gt;
</a><a href="#h73-3-58" id="h73-3-58" class="i">+                    msg.messageMetadata?.openedBy?.none { it.toString() == myUserId } == true
</a><a href="#h73-3-59" id="h73-3-59" class="i">+                }.sortedBy { it.orderKey }.mapNotNull { it.messageDescriptor?.messageId }
</a><a href="#h73-3-60" id="h73-3-60" class="i">+            }
</a><a href="#h73-3-61" id="h73-3-61" class="i">+
</a><a href="#h73-3-62" id="h73-3-62" class="i">+            context.classCache.conversationManager.apply {
</a><a href="#h73-3-63" id="h73-3-63" class="i">+                hook(&quot;enterConversation&quot;, HookStage.BEFORE) { param -&gt;
</a><a href="#h73-3-64" id="h73-3-64" class="i">+                    openedConversationUUID = SnapUUID(param.arg(0))
</a><a href="#h73-3-65" id="h73-3-65" class="i">+                    if (context.config.messaging.bypassMessageRetentionPolicy.get()) {
</a><a href="#h73-3-66" id="h73-3-66" class="i">+                        val callback = param.argNullable&lt;Any&gt;(2) ?: return@hook
</a><a href="#h73-3-67" id="h73-3-67" class="i">+                        callback::class.java.methods.firstOrNull { it.name == &quot;onSuccess&quot; }?.invoke(callback)
</a><a href="#h73-3-68" id="h73-3-68" class="i">+                        param.setResult(null)
</a><a href="#h73-3-69" id="h73-3-69" class="i">+                    }
</a><a href="#h73-3-70" id="h73-3-70" class="i">+                }
</a><a href="#h73-3-71" id="h73-3-71" class="i">+
</a><a href="#h73-3-72" id="h73-3-72" class="i">+                hook(&quot;exitConversation&quot;, HookStage.BEFORE) {
</a><a href="#h73-3-73" id="h73-3-73" class="i">+                    openedConversationUUID = null
</a><a href="#h73-3-74" id="h73-3-74" class="i">+                }
</a><a href="#h73-3-75" id="h73-3-75" class="i">+            }
</a><a href="#h73-3-76" id="h73-3-76" class="i">+        }
</a>     }
 
     fun getFeedCachedMessageIds(conversationId: String) = feedCachedSnapMessages[conversationId]
<a href="#h73-4" id="h73-4" class="h">@@ -116,82 +190,6 @@ class Messaging : Feature(&quot;Messaging&quot;, loadParams = FeatureLoadParams.ACTIVITY_C
</a>         }
     }
 
<a href="#h73-4-3" id="h73-4-3" class="d">-    override fun onActivityCreate() {
</a><a href="#h73-4-4" id="h73-4-4" class="d">-        context.mappings.useMapper(FriendsFeedEventDispatcherMapper::class) {
</a><a href="#h73-4-5" id="h73-4-5" class="d">-            classReference.getAsClass()?.hook(&quot;onItemLongPress&quot;, HookStage.BEFORE) { param -&gt;
</a><a href="#h73-4-6" id="h73-4-6" class="d">-                val viewItemContainer = param.arg&lt;Any&gt;(0)
</a><a href="#h73-4-7" id="h73-4-7" class="d">-                val viewItem = viewItemContainer.getObjectField(viewModelField.get()!!).toString()
</a><a href="#h73-4-8" id="h73-4-8" class="d">-                val conversationId = viewItem.substringAfter(&quot;conversationId: &quot;).substring(0, 36).also {
</a><a href="#h73-4-9" id="h73-4-9" class="d">-                    if (it.startsWith(&quot;null&quot;)) return@hook
</a><a href="#h73-4-10" id="h73-4-10" class="d">-                }
</a><a href="#h73-4-11" id="h73-4-11" class="d">-                lastFocusedConversationId = conversationId
</a><a href="#h73-4-12" id="h73-4-12" class="d">-                lastFocusedConversationType = context.database.getConversationType(conversationId) ?: 0
</a><a href="#h73-4-13" id="h73-4-13" class="d">-            }
</a><a href="#h73-4-14" id="h73-4-14" class="d">-        }
</a><a href="#h73-4-15" id="h73-4-15" class="d">-
</a><a href="#h73-4-16" id="h73-4-16" class="d">-        context.classCache.feedEntry.hookConstructor(HookStage.AFTER) { param -&gt;
</a><a href="#h73-4-17" id="h73-4-17" class="d">-            val instance = param.thisObject&lt;Any&gt;()
</a><a href="#h73-4-18" id="h73-4-18" class="d">-            val interactionInfo = instance.getObjectFieldOrNull(&quot;mInteractionInfo&quot;) ?: return@hookConstructor
</a><a href="#h73-4-19" id="h73-4-19" class="d">-            val messages = (interactionInfo.getObjectFieldOrNull(&quot;mMessages&quot;) as? List&lt;*&gt;)?.map { Message(it) } ?: return@hookConstructor
</a><a href="#h73-4-20" id="h73-4-20" class="d">-            val conversationId = SnapUUID(instance.getObjectFieldOrNull(&quot;mConversationId&quot;) ?: return@hookConstructor).toString()
</a><a href="#h73-4-21" id="h73-4-21" class="d">-            val myUserId = context.database.myUserId
</a><a href="#h73-4-22" id="h73-4-22" class="d">-
</a><a href="#h73-4-23" id="h73-4-23" class="d">-            feedCachedSnapMessages[conversationId] = messages.filter { msg -&gt;
</a><a href="#h73-4-24" id="h73-4-24" class="d">-                msg.messageMetadata?.openedBy?.none { it.toString() == myUserId } == true
</a><a href="#h73-4-25" id="h73-4-25" class="d">-            }.sortedBy { it.orderKey }.mapNotNull { it.messageDescriptor?.messageId }
</a><a href="#h73-4-26" id="h73-4-26" class="d">-        }
</a><a href="#h73-4-27" id="h73-4-27" class="d">-
</a><a href="#h73-4-28" id="h73-4-28" class="d">-        context.classCache.conversationManager.apply {
</a><a href="#h73-4-29" id="h73-4-29" class="d">-            hook(&quot;enterConversation&quot;, HookStage.BEFORE) { param -&gt;
</a><a href="#h73-4-30" id="h73-4-30" class="d">-                openedConversationUUID = SnapUUID(param.arg(0))
</a><a href="#h73-4-31" id="h73-4-31" class="d">-                if (context.config.messaging.bypassMessageRetentionPolicy.get()) {
</a><a href="#h73-4-32" id="h73-4-32" class="d">-                    val callback = param.argNullable&lt;Any&gt;(2) ?: return@hook
</a><a href="#h73-4-33" id="h73-4-33" class="d">-                    callback::class.java.methods.firstOrNull { it.name == &quot;onSuccess&quot; }?.invoke(callback)
</a><a href="#h73-4-34" id="h73-4-34" class="d">-                    param.setResult(null)
</a><a href="#h73-4-35" id="h73-4-35" class="d">-                }
</a><a href="#h73-4-36" id="h73-4-36" class="d">-            }
</a><a href="#h73-4-37" id="h73-4-37" class="d">-
</a><a href="#h73-4-38" id="h73-4-38" class="d">-            hook(&quot;exitConversation&quot;, HookStage.BEFORE) {
</a><a href="#h73-4-39" id="h73-4-39" class="d">-                openedConversationUUID = null
</a><a href="#h73-4-40" id="h73-4-40" class="d">-            }
</a><a href="#h73-4-41" id="h73-4-41" class="d">-        }
</a><a href="#h73-4-42" id="h73-4-42" class="d">-    }
</a><a href="#h73-4-43" id="h73-4-43" class="d">-
</a><a href="#h73-4-44" id="h73-4-44" class="d">-    override fun asyncInit() {
</a><a href="#h73-4-45" id="h73-4-45" class="d">-        val stealthMode = context.feature(StealthMode::class)
</a><a href="#h73-4-46" id="h73-4-46" class="d">-
</a><a href="#h73-4-47" id="h73-4-47" class="d">-        arrayOf(&quot;activate&quot;, &quot;deactivate&quot;, &quot;processTypingActivity&quot;).forEach { hook -&gt;
</a><a href="#h73-4-48" id="h73-4-48" class="d">-            context.classCache.presenceSession.hook(hook, HookStage.BEFORE, {
</a><a href="#h73-4-49" id="h73-4-49" class="d">-                context.config.messaging.hideBitmojiPresence.get() || stealthMode.canUseRule(openedConversationUUID.toString())
</a><a href="#h73-4-50" id="h73-4-50" class="d">-            }) {
</a><a href="#h73-4-51" id="h73-4-51" class="d">-                it.setResult(null)
</a><a href="#h73-4-52" id="h73-4-52" class="d">-            }
</a><a href="#h73-4-53" id="h73-4-53" class="d">-        }
</a><a href="#h73-4-54" id="h73-4-54" class="d">-
</a><a href="#h73-4-55" id="h73-4-55" class="d">-        context.classCache.presenceSession.hook(&quot;startPeeking&quot;, HookStage.BEFORE, {
</a><a href="#h73-4-56" id="h73-4-56" class="d">-            context.config.messaging.hidePeekAPeek.get() || stealthMode.canUseRule(openedConversationUUID.toString())
</a><a href="#h73-4-57" id="h73-4-57" class="d">-        }) { it.setResult(null) }
</a><a href="#h73-4-58" id="h73-4-58" class="d">-
</a><a href="#h73-4-59" id="h73-4-59" class="d">-        //get last opened snap for media downloader
</a><a href="#h73-4-60" id="h73-4-60" class="d">-        context.event.subscribe(OnSnapInteractionEvent::class) { event -&gt;
</a><a href="#h73-4-61" id="h73-4-61" class="d">-            openedConversationUUID = event.conversationId
</a><a href="#h73-4-62" id="h73-4-62" class="d">-            lastFocusedMessageId = event.messageId
</a><a href="#h73-4-63" id="h73-4-63" class="d">-        }
</a><a href="#h73-4-64" id="h73-4-64" class="d">-
</a><a href="#h73-4-65" id="h73-4-65" class="d">-        context.classCache.conversationManager.hook(&quot;fetchMessage&quot;, HookStage.BEFORE) { param -&gt;
</a><a href="#h73-4-66" id="h73-4-66" class="d">-            val conversationId = SnapUUID(param.arg(0)).toString()
</a><a href="#h73-4-67" id="h73-4-67" class="d">-            if (openedConversationUUID?.toString() == conversationId) {
</a><a href="#h73-4-68" id="h73-4-68" class="d">-                lastFocusedMessageId = param.arg(1)
</a><a href="#h73-4-69" id="h73-4-69" class="d">-            }
</a><a href="#h73-4-70" id="h73-4-70" class="d">-        }
</a><a href="#h73-4-71" id="h73-4-71" class="d">-
</a><a href="#h73-4-72" id="h73-4-72" class="d">-        context.classCache.conversationManager.hook(&quot;sendTypingNotification&quot;, HookStage.BEFORE, {
</a><a href="#h73-4-73" id="h73-4-73" class="d">-            context.config.messaging.hideTypingNotifications.get() || stealthMode.canUseRule(openedConversationUUID.toString())
</a><a href="#h73-4-74" id="h73-4-74" class="d">-        }) {
</a><a href="#h73-4-75" id="h73-4-75" class="d">-            it.setResult(null)
</a><a href="#h73-4-76" id="h73-4-76" class="d">-        }
</a><a href="#h73-4-77" id="h73-4-77" class="d">-    }
</a><a href="#h73-4-78" id="h73-4-78" class="d">-
</a>     fun fetchSnapchatterInfos(userIds: List&lt;String&gt;): List&lt;Snapchatter&gt; {
         val identity = identityDelegate ?: return emptyList()
         val snapUUIDs = userIds.map {
<b>diff --git a/<a id="h74" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/messaging/Notifications.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/messaging/Notifications.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/messaging/Notifications.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/messaging/Notifications.kt</a></b>
<a href="#h74-0" id="h74-0" class="h">@@ -23,7 +23,6 @@ import me.rhunk.snapenhance.common.util.snap.MediaDownloaderHelper
</a> import me.rhunk.snapenhance.common.util.snap.SnapWidgetBroadcastReceiverHelper
 import me.rhunk.snapenhance.core.event.events.impl.SnapWidgetBroadcastReceiveEvent
 import me.rhunk.snapenhance.core.features.Feature
<a href="#h74-0-3" id="h74-0-3" class="d">-import me.rhunk.snapenhance.core.features.FeatureLoadParams
</a> import me.rhunk.snapenhance.core.features.impl.FriendMutationObserver
 import me.rhunk.snapenhance.core.features.impl.downloader.MediaDownloader
 import me.rhunk.snapenhance.core.features.impl.downloader.decoder.AttachmentType
<a href="#h74-1" id="h74-1" class="h">@@ -39,7 +38,7 @@ import me.rhunk.snapenhance.core.wrapper.impl.SnapUUID
</a> import okhttp3.RequestBody.Companion.toRequestBody
 import kotlin.coroutines.suspendCoroutine
 
<a href="#h74-1-3" id="h74-1-3" class="d">-class Notifications : Feature(&quot;Notifications&quot;, loadParams = FeatureLoadParams.INIT_SYNC) {
</a><a href="#h74-1-4" id="h74-1-4" class="i">+class Notifications : Feature(&quot;Notifications&quot;) {
</a>     inner class NotificationData(
         val tag: String?,
         val id: Int,
<a href="#h74-2" id="h74-2" class="h">@@ -301,7 +300,7 @@ class Notifications : Feature(&quot;Notifications&quot;, loadParams = FeatureLoadParams.IN
</a>                     )
                 }
             }.onFailure {
<a href="#h74-2-3" id="h74-2-3" class="d">-                context.log.warn(&quot;Failed to set notification group key: ${it.stackTraceToString()}&quot;, featureKey)
</a><a href="#h74-2-4" id="h74-2-4" class="i">+                context.log.warn(&quot;Failed to set notification group key: ${it.stackTraceToString()}&quot;, key)
</a>             }
         }
 
<b>diff --git a/<a id="h75" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/messaging/PreventMessageSending.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/messaging/PreventMessageSending.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/messaging/PreventMessageSending.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/messaging/PreventMessageSending.kt</a></b>
<a href="#h75-0" id="h75-0" class="h">@@ -5,12 +5,11 @@ import me.rhunk.snapenhance.common.util.protobuf.ProtoEditor
</a> import me.rhunk.snapenhance.core.event.events.impl.NativeUnaryCallEvent
 import me.rhunk.snapenhance.core.event.events.impl.SendMessageWithContentEvent
 import me.rhunk.snapenhance.core.features.Feature
<a href="#h75-0-3" id="h75-0-3" class="d">-import me.rhunk.snapenhance.core.features.FeatureLoadParams
</a> import me.rhunk.snapenhance.core.util.hook.HookStage
 import me.rhunk.snapenhance.core.util.hook.hook
 
<a href="#h75-0-7" id="h75-0-7" class="d">-class PreventMessageSending : Feature(&quot;Prevent message sending&quot;, loadParams = FeatureLoadParams.ACTIVITY_CREATE_ASYNC) {
</a><a href="#h75-0-8" id="h75-0-8" class="d">-    override fun asyncOnActivityCreate() {
</a><a href="#h75-0-9" id="h75-0-9" class="i">+class PreventMessageSending : Feature(&quot;Prevent message sending&quot;) {
</a><a href="#h75-0-10" id="h75-0-10" class="i">+    override fun init() {
</a>         val preventMessageSending by context.config.messaging.preventMessageSending
 
         context.event.subscribe(NativeUnaryCallEvent::class, { preventMessageSending.contains(&quot;snap_replay&quot;) }) { event -&gt;
<b>diff --git a/<a id="h76" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/messaging/SendOverride.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/messaging/SendOverride.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/messaging/SendOverride.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/messaging/SendOverride.kt</a></b>
<a href="#h76-0" id="h76-0" class="h">@@ -8,14 +8,13 @@ import me.rhunk.snapenhance.common.util.protobuf.ProtoReader
</a> import me.rhunk.snapenhance.core.event.events.impl.NativeUnaryCallEvent
 import me.rhunk.snapenhance.core.event.events.impl.SendMessageWithContentEvent
 import me.rhunk.snapenhance.core.features.Feature
<a href="#h76-0-3" id="h76-0-3" class="d">-import me.rhunk.snapenhance.core.features.FeatureLoadParams
</a> import me.rhunk.snapenhance.core.features.impl.experiments.MediaFilePicker
 import me.rhunk.snapenhance.core.messaging.MessageSender
 import me.rhunk.snapenhance.core.ui.ViewAppearanceHelper
 import me.rhunk.snapenhance.nativelib.NativeLib
 import java.util.Locale
 
<a href="#h76-0-10" id="h76-0-10" class="d">-class SendOverride : Feature(&quot;Send Override&quot;, loadParams = FeatureLoadParams.INIT_SYNC) {
</a><a href="#h76-0-11" id="h76-0-11" class="i">+class SendOverride : Feature(&quot;Send Override&quot;) {
</a>     private var isLastSnapSavable = false
     private val typeNames by lazy {
         mutableListOf(&quot;ORIGINAL&quot;, &quot;SNAP&quot;, &quot;NOTE&quot;).also {
<b>diff --git a/<a id="h77" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/messaging/UnlimitedSnapViewTime.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/messaging/UnlimitedSnapViewTime.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/messaging/UnlimitedSnapViewTime.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/messaging/UnlimitedSnapViewTime.kt</a></b>
<a href="#h77-0" id="h77-0" class="h">@@ -6,27 +6,27 @@ import me.rhunk.snapenhance.common.util.protobuf.ProtoEditor
</a> import me.rhunk.snapenhance.common.util.protobuf.ProtoReader
 import me.rhunk.snapenhance.core.event.events.impl.BuildMessageEvent
 import me.rhunk.snapenhance.core.features.Feature
<a href="#h77-0-3" id="h77-0-3" class="d">-import me.rhunk.snapenhance.core.features.FeatureLoadParams
</a> 
<a href="#h77-0-5" id="h77-0-5" class="d">-class UnlimitedSnapViewTime :
</a><a href="#h77-0-6" id="h77-0-6" class="d">-    Feature(&quot;UnlimitedSnapViewTime&quot;, loadParams = FeatureLoadParams.ACTIVITY_CREATE_SYNC) {
</a><a href="#h77-0-7" id="h77-0-7" class="d">-    override fun onActivityCreate() {
</a><a href="#h77-0-8" id="h77-0-8" class="d">-        val state by context.config.messaging.unlimitedSnapViewTime
</a><a href="#h77-0-9" id="h77-0-9" class="i">+class UnlimitedSnapViewTime : Feature(&quot;UnlimitedSnapViewTime&quot;) {
</a><a href="#h77-0-10" id="h77-0-10" class="i">+    override fun init() {
</a><a href="#h77-0-11" id="h77-0-11" class="i">+        onNextActivityCreate {
</a><a href="#h77-0-12" id="h77-0-12" class="i">+            val state by context.config.messaging.unlimitedSnapViewTime
</a> 
<a href="#h77-0-14" id="h77-0-14" class="d">-        context.event.subscribe(BuildMessageEvent::class, { state }, priority = 101) { event -&gt;
</a><a href="#h77-0-15" id="h77-0-15" class="d">-            if (event.message.messageState != MessageState.COMMITTED) return@subscribe
</a><a href="#h77-0-16" id="h77-0-16" class="d">-            if (event.message.messageContent!!.contentType != ContentType.SNAP) return@subscribe
</a><a href="#h77-0-17" id="h77-0-17" class="i">+            context.event.subscribe(BuildMessageEvent::class, { state }, priority = 101) { event -&gt;
</a><a href="#h77-0-18" id="h77-0-18" class="i">+                if (event.message.messageState != MessageState.COMMITTED) return@subscribe
</a><a href="#h77-0-19" id="h77-0-19" class="i">+                if (event.message.messageContent!!.contentType != ContentType.SNAP) return@subscribe
</a> 
<a href="#h77-0-21" id="h77-0-21" class="d">-            val messageContent = event.message.messageContent
</a><a href="#h77-0-22" id="h77-0-22" class="i">+                val messageContent = event.message.messageContent
</a> 
<a href="#h77-0-24" id="h77-0-24" class="d">-            val mediaAttributes = ProtoReader(messageContent!!.content!!).followPath(11, 5, 2) ?: return@subscribe
</a><a href="#h77-0-25" id="h77-0-25" class="d">-            if (mediaAttributes.contains(6)) return@subscribe
</a><a href="#h77-0-26" id="h77-0-26" class="d">-            messageContent.content = ProtoEditor(messageContent.content!!).apply {
</a><a href="#h77-0-27" id="h77-0-27" class="d">-                edit(11, 5, 2) {
</a><a href="#h77-0-28" id="h77-0-28" class="d">-                    remove(8)
</a><a href="#h77-0-29" id="h77-0-29" class="d">-                    addBuffer(6, byteArrayOf())
</a><a href="#h77-0-30" id="h77-0-30" class="d">-                }
</a><a href="#h77-0-31" id="h77-0-31" class="d">-            }.toByteArray()
</a><a href="#h77-0-32" id="h77-0-32" class="i">+                val mediaAttributes = ProtoReader(messageContent!!.content!!).followPath(11, 5, 2) ?: return@subscribe
</a><a href="#h77-0-33" id="h77-0-33" class="i">+                if (mediaAttributes.contains(6)) return@subscribe
</a><a href="#h77-0-34" id="h77-0-34" class="i">+                messageContent.content = ProtoEditor(messageContent.content!!).apply {
</a><a href="#h77-0-35" id="h77-0-35" class="i">+                    edit(11, 5, 2) {
</a><a href="#h77-0-36" id="h77-0-36" class="i">+                        remove(8)
</a><a href="#h77-0-37" id="h77-0-37" class="i">+                        addBuffer(6, byteArrayOf())
</a><a href="#h77-0-38" id="h77-0-38" class="i">+                    }
</a><a href="#h77-0-39" id="h77-0-39" class="i">+                }.toByteArray()
</a><a href="#h77-0-40" id="h77-0-40" class="i">+            }
</a>         }
     }
 }
<b>diff --git a/<a id="h78" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/spying/FriendTracker.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/spying/FriendTracker.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/spying/FriendTracker.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/spying/FriendTracker.kt</a></b>
<a href="#h78-0" id="h78-0" class="h">@@ -12,7 +12,6 @@ import me.rhunk.snapenhance.common.util.lazyBridge
</a> import me.rhunk.snapenhance.common.util.protobuf.ProtoReader
 import me.rhunk.snapenhance.common.util.toParcelable
 import me.rhunk.snapenhance.core.features.Feature
<a href="#h78-0-3" id="h78-0-3" class="d">-import me.rhunk.snapenhance.core.features.FeatureLoadParams
</a> import me.rhunk.snapenhance.core.features.impl.messaging.Messaging
 import me.rhunk.snapenhance.core.util.hook.HookStage
 import me.rhunk.snapenhance.core.util.hook.hook
<a href="#h78-1" id="h78-1" class="h">@@ -23,7 +22,7 @@ import me.rhunk.snapenhance.nativelib.NativeLib
</a> import java.lang.reflect.Method
 import java.nio.ByteBuffer
 
<a href="#h78-1-3" id="h78-1-3" class="d">-class FriendTracker : Feature(&quot;Friend Tracker&quot;, loadParams = FeatureLoadParams.INIT_SYNC) {
</a><a href="#h78-1-4" id="h78-1-4" class="i">+class FriendTracker : Feature(&quot;Friend Tracker&quot;) {
</a>     private val conversationPresenceState = mutableMapOf&lt;String, MutableMap&lt;String, FriendPresenceState?&gt;&gt;() // conversationId -&gt; (userId -&gt; state)
     private val tracker by lazyBridge { context.bridgeClient.getTracker() }
     private val notificationManager by lazy { context.androidContext.getSystemService(NotificationManager::class.java).apply {
<b>diff --git a/<a id="h79" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/spying/HalfSwipeNotifier.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/spying/HalfSwipeNotifier.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/spying/HalfSwipeNotifier.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/spying/HalfSwipeNotifier.kt</a></b>
<a href="#h79-0" id="h79-0" class="h">@@ -6,7 +6,6 @@ import android.app.NotificationManager
</a> import android.app.PendingIntent
 import me.rhunk.snapenhance.common.Constants
 import me.rhunk.snapenhance.core.features.Feature
<a href="#h79-0-3" id="h79-0-3" class="d">-import me.rhunk.snapenhance.core.features.FeatureLoadParams
</a> import me.rhunk.snapenhance.core.util.hook.HookStage
 import me.rhunk.snapenhance.core.util.hook.hook
 import me.rhunk.snapenhance.core.util.hook.hookConstructor
<a href="#h79-1" id="h79-1" class="h">@@ -16,7 +15,7 @@ import me.rhunk.snapenhance.mapper.impl.CallbackMapper
</a> import java.util.concurrent.ConcurrentHashMap
 import kotlin.time.Duration.Companion.milliseconds
 
<a href="#h79-1-3" id="h79-1-3" class="d">-class HalfSwipeNotifier : Feature(&quot;Half Swipe Notifier&quot;, loadParams = FeatureLoadParams.INIT_SYNC) {
</a><a href="#h79-1-4" id="h79-1-4" class="i">+class HalfSwipeNotifier : Feature(&quot;Half Swipe Notifier&quot;) {
</a>     private val peekingConversations = ConcurrentHashMap&lt;String, List&lt;String&gt;&gt;()
     private val startPeekingTimestamps = ConcurrentHashMap&lt;String, Long&gt;()
 
<b>diff --git a/<a id="h80" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/spying/MessageLogger.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/spying/MessageLogger.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/spying/MessageLogger.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/spying/MessageLogger.kt</a></b>
<a href="#h80-0" id="h80-0" class="h">@@ -18,18 +18,13 @@ import me.rhunk.snapenhance.common.util.protobuf.ProtoReader
</a> import me.rhunk.snapenhance.core.event.events.impl.BindViewEvent
 import me.rhunk.snapenhance.core.event.events.impl.BuildMessageEvent
 import me.rhunk.snapenhance.core.features.Feature
<a href="#h80-0-3" id="h80-0-3" class="d">-import me.rhunk.snapenhance.core.features.FeatureLoadParams
</a> import me.rhunk.snapenhance.core.ui.addForegroundDrawable
 import me.rhunk.snapenhance.core.ui.removeForegroundDrawable
 import me.rhunk.snapenhance.core.util.EvictingMap
 import java.util.concurrent.Executors
 import kotlin.system.measureTimeMillis
 
<a href="#h80-0-10" id="h80-0-10" class="d">-class MessageLogger : Feature(&quot;MessageLogger&quot;,
</a><a href="#h80-0-11" id="h80-0-11" class="d">-    loadParams = FeatureLoadParams.INIT_SYNC or
</a><a href="#h80-0-12" id="h80-0-12" class="d">-        FeatureLoadParams.ACTIVITY_CREATE_SYNC or
</a><a href="#h80-0-13" id="h80-0-13" class="d">-        FeatureLoadParams.ACTIVITY_CREATE_ASYNC
</a><a href="#h80-0-14" id="h80-0-14" class="d">-) {
</a><a href="#h80-0-15" id="h80-0-15" class="i">+class MessageLogger : Feature(&quot;MessageLogger&quot;) {
</a>     companion object {
         const val PREFETCH_MESSAGE_COUNT = 20
         const val PREFETCH_FEED_COUNT = 20
<a href="#h80-1" id="h80-1" class="h">@@ -96,23 +91,20 @@ class MessageLogger : Feature(&quot;MessageLogger&quot;,
</a>         return computeMessageIdentifier(conversationId, serverMessageId)
     }
 
<a href="#h80-1-3" id="h80-1-3" class="d">-    override fun asyncOnActivityCreate() {
</a><a href="#h80-1-4" id="h80-1-4" class="d">-        if (!isEnabled || !context.database.hasArroyo()) {
</a><a href="#h80-1-5" id="h80-1-5" class="d">-            return
</a><a href="#h80-1-6" id="h80-1-6" class="d">-        }
</a><a href="#h80-1-7" id="h80-1-7" class="d">-
</a><a href="#h80-1-8" id="h80-1-8" class="d">-        measureTimeMillis {
</a><a href="#h80-1-9" id="h80-1-9" class="d">-            val conversationIds = context.database.getFeedEntries(PREFETCH_FEED_COUNT).map { it.key!! }
</a><a href="#h80-1-10" id="h80-1-10" class="d">-            if (conversationIds.isEmpty()) return@measureTimeMillis
</a><a href="#h80-1-11" id="h80-1-11" class="d">-            fetchedMessages.addAll(loggerInterface.getLoggedIds(conversationIds.toTypedArray(), PREFETCH_MESSAGE_COUNT).toList())
</a><a href="#h80-1-12" id="h80-1-12" class="d">-        }.also { context.log.verbose(&quot;Loaded ${fetchedMessages.size} cached messages in ${it}ms&quot;) }
</a><a href="#h80-1-13" id="h80-1-13" class="d">-    }
</a><a href="#h80-1-14" id="h80-1-14" class="d">-
</a>     override fun init() {
         if (!isEnabled) return
         val keepMyOwnMessages = context.config.messaging.messageLogger.keepMyOwnMessages.get()
         val messageFilter by context.config.messaging.messageLogger.messageFilter
 
<a href="#h80-1-20" id="h80-1-20" class="i">+        onNextActivityCreate(defer = true) {
</a><a href="#h80-1-21" id="h80-1-21" class="i">+            if (!context.database.hasArroyo()) return@onNextActivityCreate
</a><a href="#h80-1-22" id="h80-1-22" class="i">+            measureTimeMillis {
</a><a href="#h80-1-23" id="h80-1-23" class="i">+                val conversationIds = context.database.getFeedEntries(PREFETCH_FEED_COUNT).map { it.key!! }
</a><a href="#h80-1-24" id="h80-1-24" class="i">+                if (conversationIds.isEmpty()) return@measureTimeMillis
</a><a href="#h80-1-25" id="h80-1-25" class="i">+                fetchedMessages.addAll(loggerInterface.getLoggedIds(conversationIds.toTypedArray(), PREFETCH_MESSAGE_COUNT).toList())
</a><a href="#h80-1-26" id="h80-1-26" class="i">+            }.also { context.log.verbose(&quot;Loaded ${fetchedMessages.size} cached messages in ${it}ms&quot;) }
</a><a href="#h80-1-27" id="h80-1-27" class="i">+        }
</a><a href="#h80-1-28" id="h80-1-28" class="i">+
</a>         context.event.subscribe(BuildMessageEvent::class, priority = 1) { event -&gt;
             val messageInstance = event.message.instanceNonNull()
             if (event.message.messageState != MessageState.COMMITTED) return@subscribe
<a href="#h80-2" id="h80-2" class="h">@@ -183,10 +175,6 @@ class MessageLogger : Feature(&quot;MessageLogger&quot;,
</a> 
             deletedMessageCache[uniqueMessageIdentifier] = deletedMessageObject
         }
<a href="#h80-2-3" id="h80-2-3" class="d">-    }
</a><a href="#h80-2-4" id="h80-2-4" class="d">-
</a><a href="#h80-2-5" id="h80-2-5" class="d">-    override fun onActivityCreate() {
</a><a href="#h80-2-6" id="h80-2-6" class="d">-        if (!isEnabled) return
</a> 
         context.event.subscribe(BindViewEvent::class) { event -&gt;
             event.chatMessage { conversationId, messageId -&gt;
<b>diff --git a/<a id="h81" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/spying/StealthMode.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/spying/StealthMode.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/spying/StealthMode.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/spying/StealthMode.kt</a></b>
<a href="#h81-0" id="h81-0" class="h">@@ -2,14 +2,13 @@ package me.rhunk.snapenhance.core.features.impl.spying
</a> 
 import me.rhunk.snapenhance.common.data.MessagingRuleType
 import me.rhunk.snapenhance.core.event.events.impl.OnSnapInteractionEvent
<a href="#h81-0-3" id="h81-0-3" class="d">-import me.rhunk.snapenhance.core.features.FeatureLoadParams
</a> import me.rhunk.snapenhance.core.features.MessagingRuleFeature
 import me.rhunk.snapenhance.core.util.hook.HookStage
 import me.rhunk.snapenhance.core.util.hook.hook
 import me.rhunk.snapenhance.core.wrapper.impl.SnapUUID
 import java.util.concurrent.CopyOnWriteArraySet
 
<a href="#h81-0-10" id="h81-0-10" class="d">-class StealthMode : MessagingRuleFeature(&quot;StealthMode&quot;, MessagingRuleType.STEALTH, loadParams = FeatureLoadParams.INIT_SYNC) {
</a><a href="#h81-0-11" id="h81-0-11" class="i">+class StealthMode : MessagingRuleFeature(&quot;StealthMode&quot;, MessagingRuleType.STEALTH) {
</a>     private val displayedMessageQueue = CopyOnWriteArraySet&lt;Long&gt;()
 
     fun addDisplayedMessageException(clientMessageId: Long) {
<b>diff --git a/<a id="h82" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/tweaks/BypassScreenshotDetection.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/tweaks/BypassScreenshotDetection.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/tweaks/BypassScreenshotDetection.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/tweaks/BypassScreenshotDetection.kt</a></b>
<a href="#h82-0" id="h82-0" class="h">@@ -5,12 +5,11 @@ import android.content.ContentResolver
</a> import android.database.ContentObserver
 import android.net.Uri
 import me.rhunk.snapenhance.core.features.Feature
<a href="#h82-0-3" id="h82-0-3" class="d">-import me.rhunk.snapenhance.core.features.FeatureLoadParams
</a> import me.rhunk.snapenhance.core.util.hook.HookStage
 import me.rhunk.snapenhance.core.util.hook.hook
 
<a href="#h82-0-7" id="h82-0-7" class="d">-class BypassScreenshotDetection : Feature(&quot;BypassScreenshotDetection&quot;, loadParams = FeatureLoadParams.ACTIVITY_CREATE_SYNC) {
</a><a href="#h82-0-8" id="h82-0-8" class="d">-    override fun onActivityCreate() {
</a><a href="#h82-0-9" id="h82-0-9" class="i">+class BypassScreenshotDetection : Feature(&quot;BypassScreenshotDetection&quot;) {
</a><a href="#h82-0-10" id="h82-0-10" class="i">+    override fun init() {
</a>         if (!context.config.messaging.bypassScreenshotDetection.get()) return
         Activity::class.java.hook(&quot;registerScreenCaptureCallback&quot;, HookStage.BEFORE) { param -&gt;
             param.setResult(null)
<b>diff --git a/<a id="h83" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/tweaks/CameraTweaks.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/tweaks/CameraTweaks.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/tweaks/CameraTweaks.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/tweaks/CameraTweaks.kt</a></b>
<a href="#h83-0" id="h83-0" class="h">@@ -12,100 +12,101 @@ import android.media.Image
</a> import android.media.ImageReader
 import android.util.Range
 import me.rhunk.snapenhance.core.features.Feature
<a href="#h83-0-3" id="h83-0-3" class="d">-import me.rhunk.snapenhance.core.features.FeatureLoadParams
</a> import me.rhunk.snapenhance.core.util.hook.HookStage
 import me.rhunk.snapenhance.core.util.hook.hook
 import me.rhunk.snapenhance.core.util.ktx.setObjectField
 import java.io.ByteArrayOutputStream
 import java.nio.ByteBuffer
 
<a href="#h83-0-10" id="h83-0-10" class="d">-class CameraTweaks : Feature(&quot;Camera Tweaks&quot;, loadParams = FeatureLoadParams.ACTIVITY_CREATE_SYNC) {
</a><a href="#h83-0-11" id="h83-0-11" class="i">+class CameraTweaks : Feature(&quot;Camera Tweaks&quot;) {
</a> 
     private fun parseResolution(resolution: String): IntArray? {
         return runCatching { resolution.split(&quot;x&quot;).map { it.toInt() }.toIntArray() }.getOrNull()
     }
 
     @SuppressLint(&quot;MissingPermission&quot;, &quot;DiscouragedApi&quot;)
<a href="#h83-0-18" id="h83-0-18" class="d">-    override fun onActivityCreate() {
</a><a href="#h83-0-19" id="h83-0-19" class="d">-        val config = context.config.camera
</a><a href="#h83-0-20" id="h83-0-20" class="d">-
</a><a href="#h83-0-21" id="h83-0-21" class="d">-        val frontCameraId = runCatching { context.androidContext.getSystemService(CameraManager::class.java).run {
</a><a href="#h83-0-22" id="h83-0-22" class="d">-            cameraIdList.firstOrNull { getCameraCharacteristics(it).get(CameraCharacteristics.LENS_FACING) == CameraCharacteristics.LENS_FACING_FRONT }
</a><a href="#h83-0-23" id="h83-0-23" class="d">-        } }.getOrNull()
</a><a href="#h83-0-24" id="h83-0-24" class="d">-
</a><a href="#h83-0-25" id="h83-0-25" class="d">-        if (config.disableCameras.get().isNotEmpty() &amp;&amp; frontCameraId != null) {
</a><a href="#h83-0-26" id="h83-0-26" class="d">-            ContextWrapper::class.java.hook(&quot;checkPermission&quot;, HookStage.BEFORE) { param -&gt;
</a><a href="#h83-0-27" id="h83-0-27" class="d">-                val permission = param.arg&lt;String&gt;(0)
</a><a href="#h83-0-28" id="h83-0-28" class="d">-                if (permission == Manifest.permission.CAMERA) {
</a><a href="#h83-0-29" id="h83-0-29" class="d">-                    param.setResult(PackageManager.PERMISSION_GRANTED)
</a><a href="#h83-0-30" id="h83-0-30" class="i">+    override fun init() {
</a><a href="#h83-0-31" id="h83-0-31" class="i">+        onNextActivityCreate {
</a><a href="#h83-0-32" id="h83-0-32" class="i">+            val config = context.config.camera
</a><a href="#h83-0-33" id="h83-0-33" class="i">+
</a><a href="#h83-0-34" id="h83-0-34" class="i">+            val frontCameraId = runCatching { context.androidContext.getSystemService(CameraManager::class.java).run {
</a><a href="#h83-0-35" id="h83-0-35" class="i">+                cameraIdList.firstOrNull { getCameraCharacteristics(it).get(CameraCharacteristics.LENS_FACING) == CameraCharacteristics.LENS_FACING_FRONT }
</a><a href="#h83-0-36" id="h83-0-36" class="i">+            } }.getOrNull()
</a><a href="#h83-0-37" id="h83-0-37" class="i">+
</a><a href="#h83-0-38" id="h83-0-38" class="i">+            if (config.disableCameras.get().isNotEmpty() &amp;&amp; frontCameraId != null) {
</a><a href="#h83-0-39" id="h83-0-39" class="i">+                ContextWrapper::class.java.hook(&quot;checkPermission&quot;, HookStage.BEFORE) { param -&gt;
</a><a href="#h83-0-40" id="h83-0-40" class="i">+                    val permission = param.arg&lt;String&gt;(0)
</a><a href="#h83-0-41" id="h83-0-41" class="i">+                    if (permission == Manifest.permission.CAMERA) {
</a><a href="#h83-0-42" id="h83-0-42" class="i">+                        param.setResult(PackageManager.PERMISSION_GRANTED)
</a><a href="#h83-0-43" id="h83-0-43" class="i">+                    }
</a>                 }
             }
<a href="#h83-0-46" id="h83-0-46" class="d">-        }
</a> 
<a href="#h83-0-48" id="h83-0-48" class="d">-        var isLastCameraFront = false
</a><a href="#h83-0-49" id="h83-0-49" class="i">+            var isLastCameraFront = false
</a> 
<a href="#h83-0-51" id="h83-0-51" class="d">-        CameraManager::class.java.hook(&quot;openCamera&quot;, HookStage.BEFORE) { param -&gt;
</a><a href="#h83-0-52" id="h83-0-52" class="d">-            val cameraManager = param.thisObject() as? CameraManager ?: return@hook
</a><a href="#h83-0-53" id="h83-0-53" class="d">-            val cameraId = param.arg&lt;String&gt;(0)
</a><a href="#h83-0-54" id="h83-0-54" class="d">-            val disabledCameras = config.disableCameras.get()
</a><a href="#h83-0-55" id="h83-0-55" class="i">+            CameraManager::class.java.hook(&quot;openCamera&quot;, HookStage.BEFORE) { param -&gt;
</a><a href="#h83-0-56" id="h83-0-56" class="i">+                val cameraManager = param.thisObject() as? CameraManager ?: return@hook
</a><a href="#h83-0-57" id="h83-0-57" class="i">+                val cameraId = param.arg&lt;String&gt;(0)
</a><a href="#h83-0-58" id="h83-0-58" class="i">+                val disabledCameras = config.disableCameras.get()
</a> 
<a href="#h83-0-60" id="h83-0-60" class="d">-            if (disabledCameras.size &gt;= 2) {
</a><a href="#h83-0-61" id="h83-0-61" class="d">-                param.setResult(null)
</a><a href="#h83-0-62" id="h83-0-62" class="d">-                return@hook
</a><a href="#h83-0-63" id="h83-0-63" class="d">-            }
</a><a href="#h83-0-64" id="h83-0-64" class="i">+                if (disabledCameras.size &gt;= 2) {
</a><a href="#h83-0-65" id="h83-0-65" class="i">+                    param.setResult(null)
</a><a href="#h83-0-66" id="h83-0-66" class="i">+                    return@hook
</a><a href="#h83-0-67" id="h83-0-67" class="i">+                }
</a> 
<a href="#h83-0-69" id="h83-0-69" class="d">-            isLastCameraFront = cameraId == frontCameraId
</a><a href="#h83-0-70" id="h83-0-70" class="i">+                isLastCameraFront = cameraId == frontCameraId
</a> 
<a href="#h83-0-72" id="h83-0-72" class="d">-            if (disabledCameras.size != 1) return@hook
</a><a href="#h83-0-73" id="h83-0-73" class="i">+                if (disabledCameras.size != 1) return@hook
</a> 
<a href="#h83-0-75" id="h83-0-75" class="d">-            // trick to replace unwanted camera with another one
</a><a href="#h83-0-76" id="h83-0-76" class="d">-            if ((disabledCameras.contains(&quot;front&quot;) &amp;&amp; isLastCameraFront) || (disabledCameras.contains(&quot;back&quot;) &amp;&amp; !isLastCameraFront)) {
</a><a href="#h83-0-77" id="h83-0-77" class="d">-                param.setArg(0, cameraManager.cameraIdList.filterNot { it == cameraId }.firstOrNull() ?: return@hook)
</a><a href="#h83-0-78" id="h83-0-78" class="d">-                isLastCameraFront = !isLastCameraFront
</a><a href="#h83-0-79" id="h83-0-79" class="i">+                // trick to replace unwanted camera with another one
</a><a href="#h83-0-80" id="h83-0-80" class="i">+                if ((disabledCameras.contains(&quot;front&quot;) &amp;&amp; isLastCameraFront) || (disabledCameras.contains(&quot;back&quot;) &amp;&amp; !isLastCameraFront)) {
</a><a href="#h83-0-81" id="h83-0-81" class="i">+                    param.setArg(0, cameraManager.cameraIdList.filterNot { it == cameraId }.firstOrNull() ?: return@hook)
</a><a href="#h83-0-82" id="h83-0-82" class="i">+                    isLastCameraFront = !isLastCameraFront
</a><a href="#h83-0-83" id="h83-0-83" class="i">+                }
</a>             }
<a href="#h83-0-85" id="h83-0-85" class="d">-        }
</a><a href="#h83-0-86" id="h83-0-86" class="d">-
</a><a href="#h83-0-87" id="h83-0-87" class="d">-        ImageReader::class.java.hook(&quot;newInstance&quot;, HookStage.BEFORE) { param -&gt;
</a><a href="#h83-0-88" id="h83-0-88" class="d">-            val captureResolutionConfig = config.customResolution.getNullable()?.takeIf { it.isNotEmpty() }?.let { parseResolution(it) }
</a><a href="#h83-0-89" id="h83-0-89" class="d">-                ?: (if (isLastCameraFront) config.overrideFrontResolution.getNullable() else config.overrideBackResolution.getNullable())?.let { parseResolution(it) } ?: return@hook
</a><a href="#h83-0-90" id="h83-0-90" class="d">-            param.setArg(0, captureResolutionConfig[0])
</a><a href="#h83-0-91" id="h83-0-91" class="d">-            param.setArg(1, captureResolutionConfig[1])
</a><a href="#h83-0-92" id="h83-0-92" class="d">-        }
</a> 
<a href="#h83-0-94" id="h83-0-94" class="d">-        CameraCharacteristics::class.java.hook(&quot;get&quot;, HookStage.AFTER)  { param -&gt;
</a><a href="#h83-0-95" id="h83-0-95" class="d">-            val key = param.argNullable&lt;Key&lt;*&gt;&gt;(0) ?: return@hook
</a><a href="#h83-0-96" id="h83-0-96" class="i">+            ImageReader::class.java.hook(&quot;newInstance&quot;, HookStage.BEFORE) { param -&gt;
</a><a href="#h83-0-97" id="h83-0-97" class="i">+                val captureResolutionConfig = config.customResolution.getNullable()?.takeIf { it.isNotEmpty() }?.let { parseResolution(it) }
</a><a href="#h83-0-98" id="h83-0-98" class="i">+                    ?: (if (isLastCameraFront) config.overrideFrontResolution.getNullable() else config.overrideBackResolution.getNullable())?.let { parseResolution(it) } ?: return@hook
</a><a href="#h83-0-99" id="h83-0-99" class="i">+                param.setArg(0, captureResolutionConfig[0])
</a><a href="#h83-0-100" id="h83-0-100" class="i">+                param.setArg(1, captureResolutionConfig[1])
</a><a href="#h83-0-101" id="h83-0-101" class="i">+            }
</a> 
<a href="#h83-0-103" id="h83-0-103" class="d">-            if (key == CameraCharacteristics.LENS_FACING) {
</a><a href="#h83-0-104" id="h83-0-104" class="d">-                val disabledCameras = config.disableCameras.get()
</a><a href="#h83-0-105" id="h83-0-105" class="d">-                //FIXME: unexpected behavior when app is resumed
</a><a href="#h83-0-106" id="h83-0-106" class="d">-                if (disabledCameras.size == 1) {
</a><a href="#h83-0-107" id="h83-0-107" class="d">-                    val isFrontCamera = param.getResult() as? Int == CameraCharacteristics.LENS_FACING_FRONT
</a><a href="#h83-0-108" id="h83-0-108" class="d">-                    if ((disabledCameras.contains(&quot;front&quot;) &amp;&amp; isFrontCamera) || (disabledCameras.contains(&quot;back&quot;) &amp;&amp; !isFrontCamera)) {
</a><a href="#h83-0-109" id="h83-0-109" class="d">-                        param.setResult(if (isFrontCamera) CameraCharacteristics.LENS_FACING_BACK else CameraCharacteristics.LENS_FACING_FRONT)
</a><a href="#h83-0-110" id="h83-0-110" class="i">+            CameraCharacteristics::class.java.hook(&quot;get&quot;, HookStage.AFTER)  { param -&gt;
</a><a href="#h83-0-111" id="h83-0-111" class="i">+                val key = param.argNullable&lt;Key&lt;*&gt;&gt;(0) ?: return@hook
</a><a href="#h83-0-112" id="h83-0-112" class="i">+
</a><a href="#h83-0-113" id="h83-0-113" class="i">+                if (key == CameraCharacteristics.LENS_FACING) {
</a><a href="#h83-0-114" id="h83-0-114" class="i">+                    val disabledCameras = config.disableCameras.get()
</a><a href="#h83-0-115" id="h83-0-115" class="i">+                    //FIXME: unexpected behavior when app is resumed
</a><a href="#h83-0-116" id="h83-0-116" class="i">+                    if (disabledCameras.size == 1) {
</a><a href="#h83-0-117" id="h83-0-117" class="i">+                        val isFrontCamera = param.getResult() as? Int == CameraCharacteristics.LENS_FACING_FRONT
</a><a href="#h83-0-118" id="h83-0-118" class="i">+                        if ((disabledCameras.contains(&quot;front&quot;) &amp;&amp; isFrontCamera) || (disabledCameras.contains(&quot;back&quot;) &amp;&amp; !isFrontCamera)) {
</a><a href="#h83-0-119" id="h83-0-119" class="i">+                            param.setResult(if (isFrontCamera) CameraCharacteristics.LENS_FACING_BACK else CameraCharacteristics.LENS_FACING_FRONT)
</a><a href="#h83-0-120" id="h83-0-120" class="i">+                        }
</a>                     }
                 }
<a href="#h83-0-123" id="h83-0-123" class="d">-            }
</a> 
<a href="#h83-0-125" id="h83-0-125" class="d">-            if (key == CameraCharacteristics.CONTROL_AE_AVAILABLE_TARGET_FPS_RANGES) {
</a><a href="#h83-0-126" id="h83-0-126" class="d">-                val isFrontCamera = param.invokeOriginal(
</a><a href="#h83-0-127" id="h83-0-127" class="d">-                    arrayOf(CameraCharacteristics.LENS_FACING)
</a><a href="#h83-0-128" id="h83-0-128" class="d">-                ) == CameraCharacteristics.LENS_FACING_FRONT
</a><a href="#h83-0-129" id="h83-0-129" class="d">-                val customFrameRate = (if (isFrontCamera) config.frontCustomFrameRate.getNullable() else config.backCustomFrameRate.getNullable())?.toIntOrNull() ?: return@hook
</a><a href="#h83-0-130" id="h83-0-130" class="d">-                param.setResult(arrayOf(Range(customFrameRate, customFrameRate)))
</a><a href="#h83-0-131" id="h83-0-131" class="i">+                if (key == CameraCharacteristics.CONTROL_AE_AVAILABLE_TARGET_FPS_RANGES) {
</a><a href="#h83-0-132" id="h83-0-132" class="i">+                    val isFrontCamera = param.invokeOriginal(
</a><a href="#h83-0-133" id="h83-0-133" class="i">+                        arrayOf(CameraCharacteristics.LENS_FACING)
</a><a href="#h83-0-134" id="h83-0-134" class="i">+                    ) == CameraCharacteristics.LENS_FACING_FRONT
</a><a href="#h83-0-135" id="h83-0-135" class="i">+                    val customFrameRate = (if (isFrontCamera) config.frontCustomFrameRate.getNullable() else config.backCustomFrameRate.getNullable())?.toIntOrNull() ?: return@hook
</a><a href="#h83-0-136" id="h83-0-136" class="i">+                    param.setResult(arrayOf(Range(customFrameRate, customFrameRate)))
</a><a href="#h83-0-137" id="h83-0-137" class="i">+                }
</a>             }
<a href="#h83-0-139" id="h83-0-139" class="d">-        }
</a> 
<a href="#h83-0-141" id="h83-0-141" class="d">-        if (config.blackPhotos.get()) {
</a><a href="#h83-0-142" id="h83-0-142" class="d">-            findClass(&quot;android.media.ImageReader\$SurfaceImage&quot;).hook(&quot;getPlanes&quot;, HookStage.AFTER) { param -&gt;
</a><a href="#h83-0-143" id="h83-0-143" class="d">-                val image = param.thisObject() as? Image ?: return@hook
</a><a href="#h83-0-144" id="h83-0-144" class="d">-                val planes = param.getResult() as? Array&lt;*&gt; ?: return@hook
</a><a href="#h83-0-145" id="h83-0-145" class="d">-                val output = ByteArrayOutputStream()
</a><a href="#h83-0-146" id="h83-0-146" class="d">-                Bitmap.createBitmap(image.width, image.height, Bitmap.Config.ARGB_8888).apply {
</a><a href="#h83-0-147" id="h83-0-147" class="d">-                    compress(Bitmap.CompressFormat.JPEG, 100, output)
</a><a href="#h83-0-148" id="h83-0-148" class="d">-                    recycle()
</a><a href="#h83-0-149" id="h83-0-149" class="d">-                }
</a><a href="#h83-0-150" id="h83-0-150" class="d">-                planes.filterNotNull().forEach { plane -&gt;
</a><a href="#h83-0-151" id="h83-0-151" class="d">-                    plane.setObjectField(&quot;mBuffer&quot;, ByteBuffer.wrap(output.toByteArray()))
</a><a href="#h83-0-152" id="h83-0-152" class="i">+            if (config.blackPhotos.get()) {
</a><a href="#h83-0-153" id="h83-0-153" class="i">+                findClass(&quot;android.media.ImageReader\$SurfaceImage&quot;).hook(&quot;getPlanes&quot;, HookStage.AFTER) { param -&gt;
</a><a href="#h83-0-154" id="h83-0-154" class="i">+                    val image = param.thisObject() as? Image ?: return@hook
</a><a href="#h83-0-155" id="h83-0-155" class="i">+                    val planes = param.getResult() as? Array&lt;*&gt; ?: return@hook
</a><a href="#h83-0-156" id="h83-0-156" class="i">+                    val output = ByteArrayOutputStream()
</a><a href="#h83-0-157" id="h83-0-157" class="i">+                    Bitmap.createBitmap(image.width, image.height, Bitmap.Config.ARGB_8888).apply {
</a><a href="#h83-0-158" id="h83-0-158" class="i">+                        compress(Bitmap.CompressFormat.JPEG, 100, output)
</a><a href="#h83-0-159" id="h83-0-159" class="i">+                        recycle()
</a><a href="#h83-0-160" id="h83-0-160" class="i">+                    }
</a><a href="#h83-0-161" id="h83-0-161" class="i">+                    planes.filterNotNull().forEach { plane -&gt;
</a><a href="#h83-0-162" id="h83-0-162" class="i">+                        plane.setObjectField(&quot;mBuffer&quot;, ByteBuffer.wrap(output.toByteArray()))
</a><a href="#h83-0-163" id="h83-0-163" class="i">+                    }
</a>                 }
             }
         }
<b>diff --git a/<a id="h84" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/tweaks/DisablePermissionRequests.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/tweaks/DisablePermissionRequests.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/tweaks/DisablePermissionRequests.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/tweaks/DisablePermissionRequests.kt</a></b>
<a href="#h84-0" id="h84-0" class="h">@@ -4,11 +4,10 @@ import android.content.ContextWrapper
</a> import android.content.pm.PackageManager
 import me.rhunk.snapenhance.common.config.impl.Global
 import me.rhunk.snapenhance.core.features.Feature
<a href="#h84-0-3" id="h84-0-3" class="d">-import me.rhunk.snapenhance.core.features.FeatureLoadParams
</a> import me.rhunk.snapenhance.core.util.hook.HookStage
 import me.rhunk.snapenhance.core.util.hook.hook
 
<a href="#h84-0-7" id="h84-0-7" class="d">-class DisablePermissionRequests : Feature(&quot;Disable Permission Requests&quot;, loadParams = FeatureLoadParams.INIT_SYNC) {
</a><a href="#h84-0-8" id="h84-0-8" class="i">+class DisablePermissionRequests : Feature(&quot;Disable Permission Requests&quot;) {
</a>     override fun init() {
         val deniedPermissions by context.config.global.disablePermissionRequests
         if (deniedPermissions.isEmpty()) return
<b>diff --git a/<a id="h85" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/tweaks/HideActiveMusic.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/tweaks/HideActiveMusic.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/tweaks/HideActiveMusic.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/tweaks/HideActiveMusic.kt</a></b>
<a href="#h85-0" id="h85-0" class="h">@@ -2,15 +2,16 @@ package me.rhunk.snapenhance.core.features.impl.tweaks
</a> 
 import android.media.AudioManager
 import me.rhunk.snapenhance.core.features.Feature
<a href="#h85-0-3" id="h85-0-3" class="d">-import me.rhunk.snapenhance.core.features.FeatureLoadParams
</a> import me.rhunk.snapenhance.core.util.hook.HookStage
 import me.rhunk.snapenhance.core.util.hook.hook
 
<a href="#h85-0-7" id="h85-0-7" class="d">-class HideActiveMusic: Feature(&quot;Hide Active Music&quot;, loadParams = FeatureLoadParams.ACTIVITY_CREATE_SYNC) {
</a><a href="#h85-0-8" id="h85-0-8" class="d">-    override fun onActivityCreate() {
</a><a href="#h85-0-9" id="h85-0-9" class="i">+class HideActiveMusic: Feature(&quot;Hide Active Music&quot;) {
</a><a href="#h85-0-10" id="h85-0-10" class="i">+    override fun init() {
</a>         if (!context.config.global.hideActiveMusic.get()) return
<a href="#h85-0-12" id="h85-0-12" class="d">-        AudioManager::class.java.hook(&quot;isMusicActive&quot;, HookStage.BEFORE) {
</a><a href="#h85-0-13" id="h85-0-13" class="d">-            it.setResult(false)
</a><a href="#h85-0-14" id="h85-0-14" class="i">+        onNextActivityCreate {
</a><a href="#h85-0-15" id="h85-0-15" class="i">+            AudioManager::class.java.hook(&quot;isMusicActive&quot;, HookStage.BEFORE) {
</a><a href="#h85-0-16" id="h85-0-16" class="i">+                it.setResult(false)
</a><a href="#h85-0-17" id="h85-0-17" class="i">+            }
</a>         }
     }
 } 
\ No newline at end of file
<b>diff --git a/<a id="h86" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/tweaks/PreventMessageListAutoScroll.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/tweaks/PreventMessageListAutoScroll.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/tweaks/PreventMessageListAutoScroll.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/tweaks/PreventMessageListAutoScroll.kt</a></b>
<a href="#h86-0" id="h86-0" class="h">@@ -4,73 +4,74 @@ import android.view.View
</a> import me.rhunk.snapenhance.core.event.events.impl.BindViewEvent
 import me.rhunk.snapenhance.core.event.events.impl.ConversationUpdateEvent
 import me.rhunk.snapenhance.core.features.Feature
<a href="#h86-0-3" id="h86-0-3" class="d">-import me.rhunk.snapenhance.core.features.FeatureLoadParams
</a> import me.rhunk.snapenhance.core.util.hook.HookStage
 import me.rhunk.snapenhance.core.util.hook.hook
 import me.rhunk.snapenhance.core.wrapper.impl.SnapUUID
 
<a href="#h86-0-8" id="h86-0-8" class="d">-class PreventMessageListAutoScroll : Feature(&quot;PreventMessageListAutoScroll&quot;, loadParams = FeatureLoadParams.ACTIVITY_CREATE_SYNC) {
</a><a href="#h86-0-9" id="h86-0-9" class="i">+class PreventMessageListAutoScroll : Feature(&quot;PreventMessageListAutoScroll&quot;) {
</a>     private var openedConversationId: String? = null
     private val focusedMessages = mutableMapOf&lt;View, Long&gt;()
     private var firstFocusedMessageId: Long? = null
     private val delayedMessageUpdates = mutableListOf&lt;() -&gt; Unit&gt;()
 
<a href="#h86-0-15" id="h86-0-15" class="d">-    override fun onActivityCreate() {
</a><a href="#h86-0-16" id="h86-0-16" class="i">+    override fun init() {
</a>         if (!context.config.userInterface.preventMessageListAutoScroll.get()) return
 
<a href="#h86-0-19" id="h86-0-19" class="d">-        context.event.subscribe(ConversationUpdateEvent::class) { event -&gt;
</a><a href="#h86-0-20" id="h86-0-20" class="d">-            val updatedMessage = event.messages.firstOrNull() ?: return@subscribe
</a><a href="#h86-0-21" id="h86-0-21" class="d">-            if (openedConversationId != updatedMessage.messageDescriptor?.conversationId.toString()) return@subscribe
</a><a href="#h86-0-22" id="h86-0-22" class="i">+        onNextActivityCreate {
</a><a href="#h86-0-23" id="h86-0-23" class="i">+            context.event.subscribe(ConversationUpdateEvent::class) { event -&gt;
</a><a href="#h86-0-24" id="h86-0-24" class="i">+                val updatedMessage = event.messages.firstOrNull() ?: return@subscribe
</a><a href="#h86-0-25" id="h86-0-25" class="i">+                if (openedConversationId != updatedMessage.messageDescriptor?.conversationId.toString()) return@subscribe
</a> 
<a href="#h86-0-27" id="h86-0-27" class="d">-            // cancel if the message is already in focus
</a><a href="#h86-0-28" id="h86-0-28" class="d">-            if (focusedMessages.entries.any { entry -&gt; entry.value == updatedMessage.messageDescriptor?.messageId &amp;&amp; entry.key.isAttachedToWindow }) return@subscribe
</a><a href="#h86-0-29" id="h86-0-29" class="i">+                // cancel if the message is already in focus
</a><a href="#h86-0-30" id="h86-0-30" class="i">+                if (focusedMessages.entries.any { entry -&gt; entry.value == updatedMessage.messageDescriptor?.messageId &amp;&amp; entry.key.isAttachedToWindow }) return@subscribe
</a> 
<a href="#h86-0-32" id="h86-0-32" class="d">-            val conversationLastMessages = context.database.getMessagesFromConversationId(
</a><a href="#h86-0-33" id="h86-0-33" class="d">-                openedConversationId.toString(),
</a><a href="#h86-0-34" id="h86-0-34" class="d">-                4
</a><a href="#h86-0-35" id="h86-0-35" class="d">-            ) ?: return@subscribe
</a><a href="#h86-0-36" id="h86-0-36" class="i">+                val conversationLastMessages = context.database.getMessagesFromConversationId(
</a><a href="#h86-0-37" id="h86-0-37" class="i">+                    openedConversationId.toString(),
</a><a href="#h86-0-38" id="h86-0-38" class="i">+                    4
</a><a href="#h86-0-39" id="h86-0-39" class="i">+                ) ?: return@subscribe
</a> 
<a href="#h86-0-41" id="h86-0-41" class="d">-            if (conversationLastMessages.none {
</a><a href="#h86-0-42" id="h86-0-42" class="d">-                    focusedMessages.entries.any { entry -&gt; entry.value == it.clientMessageId.toLong() &amp;&amp; entry.key.isAttachedToWindow }
</a><a href="#h86-0-43" id="h86-0-43" class="d">-                }) {
</a><a href="#h86-0-44" id="h86-0-44" class="d">-                synchronized(delayedMessageUpdates) {
</a><a href="#h86-0-45" id="h86-0-45" class="d">-                    if (firstFocusedMessageId == null) firstFocusedMessageId = conversationLastMessages.lastOrNull()?.clientMessageId?.toLong()
</a><a href="#h86-0-46" id="h86-0-46" class="d">-                    delayedMessageUpdates.add {
</a><a href="#h86-0-47" id="h86-0-47" class="d">-                        event.adapter.invokeOriginal()
</a><a href="#h86-0-48" id="h86-0-48" class="i">+                if (conversationLastMessages.none {
</a><a href="#h86-0-49" id="h86-0-49" class="i">+                        focusedMessages.entries.any { entry -&gt; entry.value == it.clientMessageId.toLong() &amp;&amp; entry.key.isAttachedToWindow }
</a><a href="#h86-0-50" id="h86-0-50" class="i">+                    }) {
</a><a href="#h86-0-51" id="h86-0-51" class="i">+                    synchronized(delayedMessageUpdates) {
</a><a href="#h86-0-52" id="h86-0-52" class="i">+                        if (firstFocusedMessageId == null) firstFocusedMessageId = conversationLastMessages.lastOrNull()?.clientMessageId?.toLong()
</a><a href="#h86-0-53" id="h86-0-53" class="i">+                        delayedMessageUpdates.add {
</a><a href="#h86-0-54" id="h86-0-54" class="i">+                            event.adapter.invokeOriginal()
</a><a href="#h86-0-55" id="h86-0-55" class="i">+                        }
</a>                     }
<a href="#h86-0-57" id="h86-0-57" class="i">+                    event.adapter.setResult(null)
</a>                 }
<a href="#h86-0-59" id="h86-0-59" class="d">-                event.adapter.setResult(null)
</a>             }
<a href="#h86-0-61" id="h86-0-61" class="d">-        }
</a> 
<a href="#h86-0-63" id="h86-0-63" class="d">-        context.classCache.conversationManager.apply {
</a><a href="#h86-0-64" id="h86-0-64" class="d">-            hook(&quot;enterConversation&quot;, HookStage.BEFORE) { param -&gt;
</a><a href="#h86-0-65" id="h86-0-65" class="d">-                openedConversationId = SnapUUID(param.arg(0)).toString()
</a><a href="#h86-0-66" id="h86-0-66" class="d">-            }
</a><a href="#h86-0-67" id="h86-0-67" class="d">-            hook(&quot;exitConversation&quot;, HookStage.BEFORE) {
</a><a href="#h86-0-68" id="h86-0-68" class="d">-                openedConversationId = null
</a><a href="#h86-0-69" id="h86-0-69" class="d">-                firstFocusedMessageId = null
</a><a href="#h86-0-70" id="h86-0-70" class="d">-                synchronized(focusedMessages) {
</a><a href="#h86-0-71" id="h86-0-71" class="d">-                    focusedMessages.clear()
</a><a href="#h86-0-72" id="h86-0-72" class="i">+            context.classCache.conversationManager.apply {
</a><a href="#h86-0-73" id="h86-0-73" class="i">+                hook(&quot;enterConversation&quot;, HookStage.BEFORE) { param -&gt;
</a><a href="#h86-0-74" id="h86-0-74" class="i">+                    openedConversationId = SnapUUID(param.arg(0)).toString()
</a>                 }
<a href="#h86-0-76" id="h86-0-76" class="d">-                synchronized(delayedMessageUpdates) {
</a><a href="#h86-0-77" id="h86-0-77" class="d">-                    delayedMessageUpdates.clear()
</a><a href="#h86-0-78" id="h86-0-78" class="i">+                hook(&quot;exitConversation&quot;, HookStage.BEFORE) {
</a><a href="#h86-0-79" id="h86-0-79" class="i">+                    openedConversationId = null
</a><a href="#h86-0-80" id="h86-0-80" class="i">+                    firstFocusedMessageId = null
</a><a href="#h86-0-81" id="h86-0-81" class="i">+                    synchronized(focusedMessages) {
</a><a href="#h86-0-82" id="h86-0-82" class="i">+                        focusedMessages.clear()
</a><a href="#h86-0-83" id="h86-0-83" class="i">+                    }
</a><a href="#h86-0-84" id="h86-0-84" class="i">+                    synchronized(delayedMessageUpdates) {
</a><a href="#h86-0-85" id="h86-0-85" class="i">+                        delayedMessageUpdates.clear()
</a><a href="#h86-0-86" id="h86-0-86" class="i">+                    }
</a>                 }
             }
<a href="#h86-0-89" id="h86-0-89" class="d">-        }
</a> 
<a href="#h86-0-91" id="h86-0-91" class="d">-        context.event.subscribe(BindViewEvent::class) { event -&gt;
</a><a href="#h86-0-92" id="h86-0-92" class="d">-            event.chatMessage { conversationId, messageId -&gt;
</a><a href="#h86-0-93" id="h86-0-93" class="d">-                if (conversationId != openedConversationId) return@chatMessage
</a><a href="#h86-0-94" id="h86-0-94" class="d">-                synchronized(focusedMessages) {
</a><a href="#h86-0-95" id="h86-0-95" class="d">-                    focusedMessages[event.view] = messageId.toLong()
</a><a href="#h86-0-96" id="h86-0-96" class="d">-                }
</a><a href="#h86-0-97" id="h86-0-97" class="i">+            context.event.subscribe(BindViewEvent::class) { event -&gt;
</a><a href="#h86-0-98" id="h86-0-98" class="i">+                event.chatMessage { conversationId, messageId -&gt;
</a><a href="#h86-0-99" id="h86-0-99" class="i">+                    if (conversationId != openedConversationId) return@chatMessage
</a><a href="#h86-0-100" id="h86-0-100" class="i">+                    synchronized(focusedMessages) {
</a><a href="#h86-0-101" id="h86-0-101" class="i">+                        focusedMessages[event.view] = messageId.toLong()
</a><a href="#h86-0-102" id="h86-0-102" class="i">+                    }
</a> 
<a href="#h86-0-104" id="h86-0-104" class="d">-                if (delayedMessageUpdates.isNotEmpty() &amp;&amp; focusedMessages.entries.any { entry -&gt; entry.value == firstFocusedMessageId &amp;&amp; entry.key.isAttachedToWindow }) {
</a><a href="#h86-0-105" id="h86-0-105" class="d">-                    delayedMessageUpdates.apply {
</a><a href="#h86-0-106" id="h86-0-106" class="d">-                        synchronized(this) {
</a><a href="#h86-0-107" id="h86-0-107" class="d">-                            removeIf { it(); true }
</a><a href="#h86-0-108" id="h86-0-108" class="d">-                            firstFocusedMessageId = null
</a><a href="#h86-0-109" id="h86-0-109" class="i">+                    if (delayedMessageUpdates.isNotEmpty() &amp;&amp; focusedMessages.entries.any { entry -&gt; entry.value == firstFocusedMessageId &amp;&amp; entry.key.isAttachedToWindow }) {
</a><a href="#h86-0-110" id="h86-0-110" class="i">+                        delayedMessageUpdates.apply {
</a><a href="#h86-0-111" id="h86-0-111" class="i">+                            synchronized(this) {
</a><a href="#h86-0-112" id="h86-0-112" class="i">+                                removeIf { it(); true }
</a><a href="#h86-0-113" id="h86-0-113" class="i">+                                firstFocusedMessageId = null
</a><a href="#h86-0-114" id="h86-0-114" class="i">+                            }
</a>                         }
                     }
                 }
<b>diff --git a/<a id="h87" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/tweaks/RemoveGroupsLockedStatus.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/tweaks/RemoveGroupsLockedStatus.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/tweaks/RemoveGroupsLockedStatus.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/tweaks/RemoveGroupsLockedStatus.kt</a></b>
<a href="#h87-0" id="h87-0" class="h">@@ -1,17 +1,18 @@
</a> package me.rhunk.snapenhance.core.features.impl.tweaks
 
 import me.rhunk.snapenhance.core.features.Feature
<a href="#h87-0-3" id="h87-0-3" class="d">-import me.rhunk.snapenhance.core.features.FeatureLoadParams
</a> import me.rhunk.snapenhance.core.util.dataBuilder
 import me.rhunk.snapenhance.core.util.hook.HookStage
 import me.rhunk.snapenhance.core.util.hook.hookConstructor
 
<a href="#h87-0-8" id="h87-0-8" class="d">-class RemoveGroupsLockedStatus : Feature(&quot;Remove Groups Locked Status&quot;, loadParams = FeatureLoadParams.ACTIVITY_CREATE_SYNC) {
</a><a href="#h87-0-9" id="h87-0-9" class="d">-    override fun onActivityCreate() {
</a><a href="#h87-0-10" id="h87-0-10" class="i">+class RemoveGroupsLockedStatus : Feature(&quot;Remove Groups Locked Status&quot;) {
</a><a href="#h87-0-11" id="h87-0-11" class="i">+    override fun init() {
</a>         if (!context.config.messaging.removeGroupsLockedStatus.get()) return
<a href="#h87-0-13" id="h87-0-13" class="d">-        context.classCache.conversation.hookConstructor(HookStage.AFTER) { param -&gt;
</a><a href="#h87-0-14" id="h87-0-14" class="d">-            param.thisObject&lt;Any&gt;().dataBuilder {
</a><a href="#h87-0-15" id="h87-0-15" class="d">-                set(&quot;mLockedState&quot;, &quot;UNLOCKED&quot;)
</a><a href="#h87-0-16" id="h87-0-16" class="i">+        onNextActivityCreate(defer = true) {
</a><a href="#h87-0-17" id="h87-0-17" class="i">+            context.classCache.conversation.hookConstructor(HookStage.AFTER) { param -&gt;
</a><a href="#h87-0-18" id="h87-0-18" class="i">+                param.thisObject&lt;Any&gt;().dataBuilder {
</a><a href="#h87-0-19" id="h87-0-19" class="i">+                    set(&quot;mLockedState&quot;, &quot;UNLOCKED&quot;)
</a><a href="#h87-0-20" id="h87-0-20" class="i">+                }
</a>             }
         }
     }
<b>diff --git a/<a id="h88" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/tweaks/UnsaveableMessages.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/tweaks/UnsaveableMessages.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/tweaks/UnsaveableMessages.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/tweaks/UnsaveableMessages.kt</a></b>
<a href="#h88-0" id="h88-0" class="h">@@ -5,14 +5,12 @@ import me.rhunk.snapenhance.common.data.MessagingRuleType
</a> import me.rhunk.snapenhance.common.util.protobuf.ProtoEditor
 import me.rhunk.snapenhance.common.util.protobuf.ProtoReader
 import me.rhunk.snapenhance.core.event.events.impl.NativeUnaryCallEvent
<a href="#h88-0-3" id="h88-0-3" class="d">-import me.rhunk.snapenhance.core.features.FeatureLoadParams
</a> import me.rhunk.snapenhance.core.features.MessagingRuleFeature
 import me.rhunk.snapenhance.core.wrapper.impl.SnapUUID
 
 class UnsaveableMessages : MessagingRuleFeature(
     &quot;Unsaveable Messages&quot;,
<a href="#h88-0-9" id="h88-0-9" class="d">-    MessagingRuleType.UNSAVEABLE_MESSAGES,
</a><a href="#h88-0-10" id="h88-0-10" class="d">-    loadParams = FeatureLoadParams.INIT_SYNC
</a><a href="#h88-0-11" id="h88-0-11" class="i">+    MessagingRuleType.UNSAVEABLE_MESSAGES
</a> ) {
     override fun init() {
         if (context.config.rules.getRuleState(MessagingRuleType.UNSAVEABLE_MESSAGES) == null) return
<b>diff --git a/<a id="h89" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/ui/ClientBootstrapOverride.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/ui/ClientBootstrapOverride.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/ui/ClientBootstrapOverride.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/ui/ClientBootstrapOverride.kt</a></b>
<a href="#h89-0" id="h89-0" class="h">@@ -2,11 +2,10 @@ package me.rhunk.snapenhance.core.features.impl.ui
</a> 
 import me.rhunk.snapenhance.common.config.impl.UserInterfaceTweaks
 import me.rhunk.snapenhance.core.features.Feature
<a href="#h89-0-3" id="h89-0-3" class="d">-import me.rhunk.snapenhance.core.features.FeatureLoadParams
</a> import java.io.File
 
 
<a href="#h89-0-7" id="h89-0-7" class="d">-class ClientBootstrapOverride: Feature(&quot;ClientBootstrapOverride&quot;, loadParams = FeatureLoadParams.INIT_SYNC) {
</a><a href="#h89-0-8" id="h89-0-8" class="i">+class ClientBootstrapOverride: Feature(&quot;ClientBootstrapOverride&quot;) {
</a> 
     private val clientBootstrapFolder by lazy { File(context.androidContext.filesDir, &quot;client-bootstrap&quot;) }
 
<b>diff --git a/<a id="h90" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/ui/ConversationToolbox.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/ui/ConversationToolbox.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/ui/ConversationToolbox.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/ui/ConversationToolbox.kt</a></b>
<a href="#h90-0" id="h90-0" class="h">@@ -34,7 +34,6 @@ import me.rhunk.snapenhance.common.scripting.ui.ScriptInterface
</a> import me.rhunk.snapenhance.common.ui.createComposeAlertDialog
 import me.rhunk.snapenhance.core.event.events.impl.AddViewEvent
 import me.rhunk.snapenhance.core.features.Feature
<a href="#h90-0-3" id="h90-0-3" class="d">-import me.rhunk.snapenhance.core.features.FeatureLoadParams
</a> import me.rhunk.snapenhance.core.features.impl.messaging.Messaging
 import me.rhunk.snapenhance.core.util.ktx.getId
 
<a href="#h90-1" id="h90-1" class="h">@@ -45,7 +44,7 @@ data class ComposableMenu(
</a>     val composable: @Composable (alertDialog: AlertDialog, conversationId: String) -&gt; Unit,
 )
 
<a href="#h90-1-3" id="h90-1-3" class="d">-class ConversationToolbox : Feature(&quot;Conversation Toolbox&quot;, loadParams = FeatureLoadParams.ACTIVITY_CREATE_SYNC) {
</a><a href="#h90-1-4" id="h90-1-4" class="i">+class ConversationToolbox : Feature(&quot;Conversation Toolbox&quot;) {
</a>     private val composableList = mutableListOf&lt;ComposableMenu&gt;()
     private val expandedComposableCache = mutableStateMapOf&lt;String, Boolean&gt;()
 
<a href="#h90-2" id="h90-2" class="h">@@ -56,49 +55,51 @@ class ConversationToolbox : Feature(&quot;Conversation Toolbox&quot;, loadParams = Feature
</a>     }
 
     @SuppressLint(&quot;SetTextI18n&quot;)
<a href="#h90-2-3" id="h90-2-3" class="d">-    override fun onActivityCreate() {
</a><a href="#h90-2-4" id="h90-2-4" class="d">-        val defaultInputBarId = context.resources.getId(&quot;default_input_bar&quot;)
</a><a href="#h90-2-5" id="h90-2-5" class="i">+    override fun init() {
</a><a href="#h90-2-6" id="h90-2-6" class="i">+        onNextActivityCreate {
</a><a href="#h90-2-7" id="h90-2-7" class="i">+            val defaultInputBarId = context.resources.getId(&quot;default_input_bar&quot;)
</a> 
<a href="#h90-2-9" id="h90-2-9" class="d">-        context.event.subscribe(AddViewEvent::class) { event -&gt;
</a><a href="#h90-2-10" id="h90-2-10" class="d">-            if (event.view.id != defaultInputBarId) return@subscribe
</a><a href="#h90-2-11" id="h90-2-11" class="d">-            if (composableList.isEmpty()) return@subscribe
</a><a href="#h90-2-12" id="h90-2-12" class="i">+            context.event.subscribe(AddViewEvent::class) { event -&gt;
</a><a href="#h90-2-13" id="h90-2-13" class="i">+                if (event.view.id != defaultInputBarId) return@subscribe
</a><a href="#h90-2-14" id="h90-2-14" class="i">+                if (composableList.isEmpty()) return@subscribe
</a> 
<a href="#h90-2-16" id="h90-2-16" class="d">-            (event.view as ViewGroup).addView(FrameLayout(event.view.context).apply {
</a><a href="#h90-2-17" id="h90-2-17" class="d">-                layoutParams = LinearLayout.LayoutParams(
</a><a href="#h90-2-18" id="h90-2-18" class="d">-                    ViewGroup.LayoutParams.WRAP_CONTENT,
</a><a href="#h90-2-19" id="h90-2-19" class="d">-                    (52 * context.resources.displayMetrics.density).toInt(),
</a><a href="#h90-2-20" id="h90-2-20" class="d">-                ).apply {
</a><a href="#h90-2-21" id="h90-2-21" class="d">-                    gravity = Gravity.BOTTOM
</a><a href="#h90-2-22" id="h90-2-22" class="d">-                }
</a><a href="#h90-2-23" id="h90-2-23" class="d">-                setPadding(25, 0, 25, 0)
</a><a href="#h90-2-24" id="h90-2-24" class="d">-
</a><a href="#h90-2-25" id="h90-2-25" class="d">-                addView(TextView(event.view.context).apply {
</a><a href="#h90-2-26" id="h90-2-26" class="d">-                    layoutParams = FrameLayout.LayoutParams(
</a><a href="#h90-2-27" id="h90-2-27" class="d">-                        ViewGroup.LayoutParams.WRAP_CONTENT,
</a><a href="#h90-2-28" id="h90-2-28" class="i">+                (event.view as ViewGroup).addView(FrameLayout(event.view.context).apply {
</a><a href="#h90-2-29" id="h90-2-29" class="i">+                    layoutParams = LinearLayout.LayoutParams(
</a>                         ViewGroup.LayoutParams.WRAP_CONTENT,
<a href="#h90-2-31" id="h90-2-31" class="i">+                        (52 * context.resources.displayMetrics.density).toInt(),
</a>                     ).apply {
<a href="#h90-2-33" id="h90-2-33" class="d">-                        gravity = Gravity.CENTER_VERTICAL
</a><a href="#h90-2-34" id="h90-2-34" class="i">+                        gravity = Gravity.BOTTOM
</a>                     }
<a href="#h90-2-36" id="h90-2-36" class="d">-                    setOnClickListener {
</a><a href="#h90-2-37" id="h90-2-37" class="d">-                        openToolbox()
</a><a href="#h90-2-38" id="h90-2-38" class="d">-                    }
</a><a href="#h90-2-39" id="h90-2-39" class="d">-                    textSize = 21f
</a><a href="#h90-2-40" id="h90-2-40" class="d">-                    text = &quot;\uD83E\uDDF0&quot;
</a><a href="#h90-2-41" id="h90-2-41" class="i">+                    setPadding(25, 0, 25, 0)
</a><a href="#h90-2-42" id="h90-2-42" class="i">+
</a><a href="#h90-2-43" id="h90-2-43" class="i">+                    addView(TextView(event.view.context).apply {
</a><a href="#h90-2-44" id="h90-2-44" class="i">+                        layoutParams = FrameLayout.LayoutParams(
</a><a href="#h90-2-45" id="h90-2-45" class="i">+                            ViewGroup.LayoutParams.WRAP_CONTENT,
</a><a href="#h90-2-46" id="h90-2-46" class="i">+                            ViewGroup.LayoutParams.WRAP_CONTENT,
</a><a href="#h90-2-47" id="h90-2-47" class="i">+                        ).apply {
</a><a href="#h90-2-48" id="h90-2-48" class="i">+                            gravity = Gravity.CENTER_VERTICAL
</a><a href="#h90-2-49" id="h90-2-49" class="i">+                        }
</a><a href="#h90-2-50" id="h90-2-50" class="i">+                        setOnClickListener {
</a><a href="#h90-2-51" id="h90-2-51" class="i">+                            openToolbox()
</a><a href="#h90-2-52" id="h90-2-52" class="i">+                        }
</a><a href="#h90-2-53" id="h90-2-53" class="i">+                        textSize = 21f
</a><a href="#h90-2-54" id="h90-2-54" class="i">+                        text = &quot;\uD83E\uDDF0&quot;
</a><a href="#h90-2-55" id="h90-2-55" class="i">+                    })
</a>                 })
<a href="#h90-2-57" id="h90-2-57" class="d">-            })
</a><a href="#h90-2-58" id="h90-2-58" class="d">-        }
</a><a href="#h90-2-59" id="h90-2-59" class="i">+            }
</a> 
<a href="#h90-2-61" id="h90-2-61" class="d">-        context.scriptRuntime.eachModule {
</a><a href="#h90-2-62" id="h90-2-62" class="d">-            val interfaceManager = getBinding(InterfaceManager::class)?.takeIf {
</a><a href="#h90-2-63" id="h90-2-63" class="d">-                it.hasInterface(EnumScriptInterface.CONVERSATION_TOOLBOX)
</a><a href="#h90-2-64" id="h90-2-64" class="d">-            } ?: return@eachModule
</a><a href="#h90-2-65" id="h90-2-65" class="d">-            addComposable(&quot;\uD83D\uDCDC ${moduleInfo.displayName}&quot;) { alertDialog, conversationId -&gt;
</a><a href="#h90-2-66" id="h90-2-66" class="d">-                ScriptInterface(remember {
</a><a href="#h90-2-67" id="h90-2-67" class="d">-                    interfaceManager.buildInterface(EnumScriptInterface.CONVERSATION_TOOLBOX, mapOf(
</a><a href="#h90-2-68" id="h90-2-68" class="d">-                        &quot;alertDialog&quot; to alertDialog,
</a><a href="#h90-2-69" id="h90-2-69" class="d">-                        &quot;conversationId&quot; to conversationId,
</a><a href="#h90-2-70" id="h90-2-70" class="d">-                    ))
</a><a href="#h90-2-71" id="h90-2-71" class="d">-                } ?: return@addComposable)
</a><a href="#h90-2-72" id="h90-2-72" class="i">+            context.scriptRuntime.eachModule {
</a><a href="#h90-2-73" id="h90-2-73" class="i">+                val interfaceManager = getBinding(InterfaceManager::class)?.takeIf {
</a><a href="#h90-2-74" id="h90-2-74" class="i">+                    it.hasInterface(EnumScriptInterface.CONVERSATION_TOOLBOX)
</a><a href="#h90-2-75" id="h90-2-75" class="i">+                } ?: return@eachModule
</a><a href="#h90-2-76" id="h90-2-76" class="i">+                addComposable(&quot;\uD83D\uDCDC ${moduleInfo.displayName}&quot;) { alertDialog, conversationId -&gt;
</a><a href="#h90-2-77" id="h90-2-77" class="i">+                    ScriptInterface(remember {
</a><a href="#h90-2-78" id="h90-2-78" class="i">+                        interfaceManager.buildInterface(EnumScriptInterface.CONVERSATION_TOOLBOX, mapOf(
</a><a href="#h90-2-79" id="h90-2-79" class="i">+                            &quot;alertDialog&quot; to alertDialog,
</a><a href="#h90-2-80" id="h90-2-80" class="i">+                            &quot;conversationId&quot; to conversationId,
</a><a href="#h90-2-81" id="h90-2-81" class="i">+                        ))
</a><a href="#h90-2-82" id="h90-2-82" class="i">+                    } ?: return@addComposable)
</a><a href="#h90-2-83" id="h90-2-83" class="i">+                }
</a>             }
         }
     }
<b>diff --git a/<a id="h91" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/ui/CustomStreaksExpirationFormat.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/ui/CustomStreaksExpirationFormat.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/ui/CustomStreaksExpirationFormat.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/ui/CustomStreaksExpirationFormat.kt</a></b>
<a href="#h91-0" id="h91-0" class="h">@@ -1,53 +1,54 @@
</a> package me.rhunk.snapenhance.core.features.impl.ui
 
 import me.rhunk.snapenhance.core.features.Feature
<a href="#h91-0-3" id="h91-0-3" class="d">-import me.rhunk.snapenhance.core.features.FeatureLoadParams
</a> import me.rhunk.snapenhance.core.util.hook.HookStage
 import me.rhunk.snapenhance.core.util.hook.hook
 import me.rhunk.snapenhance.core.util.ktx.getObjectField
 import me.rhunk.snapenhance.mapper.impl.StreaksExpirationMapper
 import kotlin.time.Duration.Companion.milliseconds
 
<a href="#h91-0-10" id="h91-0-10" class="d">-class CustomStreaksExpirationFormat: Feature(&quot;CustomStreaksExpirationFormat&quot;, loadParams = FeatureLoadParams.ACTIVITY_CREATE_SYNC) {
</a><a href="#h91-0-11" id="h91-0-11" class="i">+class CustomStreaksExpirationFormat: Feature(&quot;CustomStreaksExpirationFormat&quot;) {
</a>     private fun Long.padZero(): String {
         return this.toString().padStart(2, &#39;0&#39;)
     }
 
<a href="#h91-0-16" id="h91-0-16" class="d">-    override fun onActivityCreate() {
</a><a href="#h91-0-17" id="h91-0-17" class="d">-        val expirationFormat by context.config.experimental.customStreaksExpirationFormat
</a><a href="#h91-0-18" id="h91-0-18" class="d">-        if (expirationFormat.isNotEmpty() || context.config.userInterface.streakExpirationInfo.get()) {
</a><a href="#h91-0-19" id="h91-0-19" class="d">-            context.mappings.useMapper(StreaksExpirationMapper::class) {
</a><a href="#h91-0-20" id="h91-0-20" class="d">-                runCatching {
</a><a href="#h91-0-21" id="h91-0-21" class="d">-                    simpleStreaksFormatterClass.getAsClass()?.hook(formatSimpleStreaksTextMethod.get() ?: return@useMapper, HookStage.BEFORE) { param -&gt;
</a><a href="#h91-0-22" id="h91-0-22" class="d">-                        param.setResult(null)
</a><a href="#h91-0-23" id="h91-0-23" class="i">+    override fun init() {
</a><a href="#h91-0-24" id="h91-0-24" class="i">+        onNextActivityCreate {
</a><a href="#h91-0-25" id="h91-0-25" class="i">+            val expirationFormat by context.config.experimental.customStreaksExpirationFormat
</a><a href="#h91-0-26" id="h91-0-26" class="i">+            if (expirationFormat.isNotEmpty() || context.config.userInterface.streakExpirationInfo.get()) {
</a><a href="#h91-0-27" id="h91-0-27" class="i">+                context.mappings.useMapper(StreaksExpirationMapper::class) {
</a><a href="#h91-0-28" id="h91-0-28" class="i">+                    runCatching {
</a><a href="#h91-0-29" id="h91-0-29" class="i">+                        simpleStreaksFormatterClass.getAsClass()?.hook(formatSimpleStreaksTextMethod.get() ?: return@useMapper, HookStage.BEFORE) { param -&gt;
</a><a href="#h91-0-30" id="h91-0-30" class="i">+                            param.setResult(null)
</a><a href="#h91-0-31" id="h91-0-31" class="i">+                        }
</a><a href="#h91-0-32" id="h91-0-32" class="i">+                    }.onFailure {
</a><a href="#h91-0-33" id="h91-0-33" class="i">+                        context.log.warn(&quot;Failed to hook simpleStreaksFormatterClass : &quot; + it.message)
</a>                     }
<a href="#h91-0-35" id="h91-0-35" class="d">-                }.onFailure {
</a><a href="#h91-0-36" id="h91-0-36" class="d">-                    context.log.warn(&quot;Failed to hook simpleStreaksFormatterClass : &quot; + it.message)
</a>                 }
             }
<a href="#h91-0-39" id="h91-0-39" class="d">-        }
</a><a href="#h91-0-40" id="h91-0-40" class="d">-        if (expirationFormat.isEmpty()) return
</a><a href="#h91-0-41" id="h91-0-41" class="i">+            if (expirationFormat.isEmpty()) return@onNextActivityCreate
</a> 
<a href="#h91-0-43" id="h91-0-43" class="d">-        context.mappings.useMapper(StreaksExpirationMapper::class) {
</a><a href="#h91-0-44" id="h91-0-44" class="d">-            streaksFormatterClass.getAsClass()?.hook(formatStreaksTextMethod.get() ?: return@useMapper, HookStage.AFTER) { param -&gt;
</a><a href="#h91-0-45" id="h91-0-45" class="d">-                val streaksCount = param.argNullable(2) ?: 0
</a><a href="#h91-0-46" id="h91-0-46" class="d">-                val streaksExpiration = param.argNullable&lt;Any&gt;(3) ?: return@hook
</a><a href="#h91-0-47" id="h91-0-47" class="i">+            context.mappings.useMapper(StreaksExpirationMapper::class) {
</a><a href="#h91-0-48" id="h91-0-48" class="i">+                streaksFormatterClass.getAsClass()?.hook(formatStreaksTextMethod.get() ?: return@useMapper, HookStage.AFTER) { param -&gt;
</a><a href="#h91-0-49" id="h91-0-49" class="i">+                    val streaksCount = param.argNullable(2) ?: 0
</a><a href="#h91-0-50" id="h91-0-50" class="i">+                    val streaksExpiration = param.argNullable&lt;Any&gt;(3) ?: return@hook
</a> 
<a href="#h91-0-52" id="h91-0-52" class="d">-                val hourGlassTimeRemaining = streaksExpiration.getObjectField(hourGlassTimeRemainingField.get() ?: return@hook) as? Long ?: return@hook
</a><a href="#h91-0-53" id="h91-0-53" class="d">-                val expirationTime = streaksExpiration.getObjectField(expirationTimeField.get() ?: return@hook) as? Long ?: return@hook
</a><a href="#h91-0-54" id="h91-0-54" class="d">-                val delta = (expirationTime - System.currentTimeMillis()).milliseconds
</a><a href="#h91-0-55" id="h91-0-55" class="i">+                    val hourGlassTimeRemaining = streaksExpiration.getObjectField(hourGlassTimeRemainingField.get() ?: return@hook) as? Long ?: return@hook
</a><a href="#h91-0-56" id="h91-0-56" class="i">+                    val expirationTime = streaksExpiration.getObjectField(expirationTimeField.get() ?: return@hook) as? Long ?: return@hook
</a><a href="#h91-0-57" id="h91-0-57" class="i">+                    val delta = (expirationTime - System.currentTimeMillis()).milliseconds
</a> 
<a href="#h91-0-59" id="h91-0-59" class="d">-                val hourGlassEmoji = if (delta.inWholeMilliseconds in 1..hourGlassTimeRemaining) if (expirationTime % 2 == 0L) &quot;\u23F3&quot; else &quot;\u231B&quot; else &quot;&quot;
</a><a href="#h91-0-60" id="h91-0-60" class="i">+                    val hourGlassEmoji = if (delta.inWholeMilliseconds in 1..hourGlassTimeRemaining) if (expirationTime % 2 == 0L) &quot;\u23F3&quot; else &quot;\u231B&quot; else &quot;&quot;
</a> 
<a href="#h91-0-62" id="h91-0-62" class="d">-                param.setResult(expirationFormat
</a><a href="#h91-0-63" id="h91-0-63" class="d">-                    .replace(&quot;%c&quot;, streaksCount.toString())
</a><a href="#h91-0-64" id="h91-0-64" class="d">-                    .replace(&quot;%e&quot;, hourGlassEmoji)
</a><a href="#h91-0-65" id="h91-0-65" class="d">-                    .replace(&quot;%d&quot;, delta.inWholeDays.toString())
</a><a href="#h91-0-66" id="h91-0-66" class="d">-                    .replace(&quot;%h&quot;, (delta.inWholeHours % 24).padZero())
</a><a href="#h91-0-67" id="h91-0-67" class="d">-                    .replace(&quot;%m&quot;, (delta.inWholeMinutes % 60).padZero())
</a><a href="#h91-0-68" id="h91-0-68" class="d">-                    .replace(&quot;%s&quot;, (delta.inWholeSeconds % 60).padZero())
</a><a href="#h91-0-69" id="h91-0-69" class="d">-                    .replace(&quot;%w&quot;, delta.toString())
</a><a href="#h91-0-70" id="h91-0-70" class="d">-                )
</a><a href="#h91-0-71" id="h91-0-71" class="i">+                    param.setResult(expirationFormat
</a><a href="#h91-0-72" id="h91-0-72" class="i">+                        .replace(&quot;%c&quot;, streaksCount.toString())
</a><a href="#h91-0-73" id="h91-0-73" class="i">+                        .replace(&quot;%e&quot;, hourGlassEmoji)
</a><a href="#h91-0-74" id="h91-0-74" class="i">+                        .replace(&quot;%d&quot;, delta.inWholeDays.toString())
</a><a href="#h91-0-75" id="h91-0-75" class="i">+                        .replace(&quot;%h&quot;, (delta.inWholeHours % 24).padZero())
</a><a href="#h91-0-76" id="h91-0-76" class="i">+                        .replace(&quot;%m&quot;, (delta.inWholeMinutes % 60).padZero())
</a><a href="#h91-0-77" id="h91-0-77" class="i">+                        .replace(&quot;%s&quot;, (delta.inWholeSeconds % 60).padZero())
</a><a href="#h91-0-78" id="h91-0-78" class="i">+                        .replace(&quot;%w&quot;, delta.toString())
</a><a href="#h91-0-79" id="h91-0-79" class="i">+                    )
</a><a href="#h91-0-80" id="h91-0-80" class="i">+                }
</a>             }
         }
     }
<b>diff --git a/<a id="h92" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/ui/CustomTheming.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/ui/CustomTheming.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/ui/CustomTheming.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/ui/CustomTheming.kt</a></b>
<a href="#h92-0" id="h92-0" class="h">@@ -0,0 +1,130 @@
</a><a href="#h92-0-0" id="h92-0-0" class="i">+package me.rhunk.snapenhance.core.features.impl.ui
</a><a href="#h92-0-1" id="h92-0-1" class="i">+
</a><a href="#h92-0-2" id="h92-0-2" class="i">+import android.content.res.TypedArray
</a><a href="#h92-0-3" id="h92-0-3" class="i">+import android.os.Build
</a><a href="#h92-0-4" id="h92-0-4" class="i">+import android.os.ParcelFileDescriptor
</a><a href="#h92-0-5" id="h92-0-5" class="i">+import android.os.ParcelFileDescriptor.AutoCloseInputStream
</a><a href="#h92-0-6" id="h92-0-6" class="i">+import android.util.TypedValue
</a><a href="#h92-0-7" id="h92-0-7" class="i">+import androidx.compose.material3.dynamicDarkColorScheme
</a><a href="#h92-0-8" id="h92-0-8" class="i">+import androidx.compose.ui.graphics.toArgb
</a><a href="#h92-0-9" id="h92-0-9" class="i">+import com.google.gson.reflect.TypeToken
</a><a href="#h92-0-10" id="h92-0-10" class="i">+import me.rhunk.snapenhance.common.bridge.FileHandleScope
</a><a href="#h92-0-11" id="h92-0-11" class="i">+import me.rhunk.snapenhance.common.data.DatabaseThemeContent
</a><a href="#h92-0-12" id="h92-0-12" class="i">+import me.rhunk.snapenhance.core.features.Feature
</a><a href="#h92-0-13" id="h92-0-13" class="i">+import me.rhunk.snapenhance.core.util.hook.HookStage
</a><a href="#h92-0-14" id="h92-0-14" class="i">+import me.rhunk.snapenhance.core.util.hook.hook
</a><a href="#h92-0-15" id="h92-0-15" class="i">+import me.rhunk.snapenhance.core.util.ktx.getIdentifier
</a><a href="#h92-0-16" id="h92-0-16" class="i">+import me.rhunk.snapenhance.core.util.ktx.getObjectField
</a><a href="#h92-0-17" id="h92-0-17" class="i">+
</a><a href="#h92-0-18" id="h92-0-18" class="i">+class CustomTheming: Feature(&quot;Custom Theming&quot;) {
</a><a href="#h92-0-19" id="h92-0-19" class="i">+    private fun getAttribute(name: String): Int {
</a><a href="#h92-0-20" id="h92-0-20" class="i">+        return context.resources.getIdentifier(name, &quot;attr&quot;)
</a><a href="#h92-0-21" id="h92-0-21" class="i">+    }
</a><a href="#h92-0-22" id="h92-0-22" class="i">+
</a><a href="#h92-0-23" id="h92-0-23" class="i">+    private fun parseAttributeList(vararg attributes: Pair&lt;String, Number&gt;): Map&lt;Int, Int&gt; {
</a><a href="#h92-0-24" id="h92-0-24" class="i">+        return attributes.toMap().mapKeys {
</a><a href="#h92-0-25" id="h92-0-25" class="i">+            getAttribute(it.key)
</a><a href="#h92-0-26" id="h92-0-26" class="i">+        }.filterKeys { it != 0 }.mapValues {
</a><a href="#h92-0-27" id="h92-0-27" class="i">+            it.value.toInt()
</a><a href="#h92-0-28" id="h92-0-28" class="i">+        }
</a><a href="#h92-0-29" id="h92-0-29" class="i">+    }
</a><a href="#h92-0-30" id="h92-0-30" class="i">+
</a><a href="#h92-0-31" id="h92-0-31" class="i">+    override fun init() {
</a><a href="#h92-0-32" id="h92-0-32" class="i">+        val customThemeName = context.config.userInterface.customTheme.getNullable() ?: return
</a><a href="#h92-0-33" id="h92-0-33" class="i">+        var currentTheme = mapOf&lt;Int, Int&gt;() // resource id -&gt; color
</a><a href="#h92-0-34" id="h92-0-34" class="i">+
</a><a href="#h92-0-35" id="h92-0-35" class="i">+        if (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.S) {
</a><a href="#h92-0-36" id="h92-0-36" class="i">+            val colorScheme = dynamicDarkColorScheme(context.androidContext)
</a><a href="#h92-0-37" id="h92-0-37" class="i">+            val light = customThemeName == &quot;material_you_light&quot;
</a><a href="#h92-0-38" id="h92-0-38" class="i">+            val surfaceVariant = (if (light) colorScheme.surfaceVariant else colorScheme.onSurfaceVariant).toArgb()
</a><a href="#h92-0-39" id="h92-0-39" class="i">+            val background = (if (light) colorScheme.onBackground else colorScheme.background).toArgb()
</a><a href="#h92-0-40" id="h92-0-40" class="i">+
</a><a href="#h92-0-41" id="h92-0-41" class="i">+            currentTheme = parseAttributeList(
</a><a href="#h92-0-42" id="h92-0-42" class="i">+                &quot;sigColorTextPrimary&quot; to surfaceVariant,
</a><a href="#h92-0-43" id="h92-0-43" class="i">+                &quot;sigColorChatChat&quot; to surfaceVariant,
</a><a href="#h92-0-44" id="h92-0-44" class="i">+                &quot;sigColorChatPendingSending&quot; to surfaceVariant,
</a><a href="#h92-0-45" id="h92-0-45" class="i">+                &quot;sigColorChatSnapWithSound&quot; to surfaceVariant,
</a><a href="#h92-0-46" id="h92-0-46" class="i">+                &quot;sigColorChatSnapWithoutSound&quot; to surfaceVariant,
</a><a href="#h92-0-47" id="h92-0-47" class="i">+                &quot;sigColorBackgroundMain&quot; to background,
</a><a href="#h92-0-48" id="h92-0-48" class="i">+                &quot;sigColorBackgroundSurface&quot; to background,
</a><a href="#h92-0-49" id="h92-0-49" class="i">+                &quot;listDivider&quot; to colorScheme.onPrimary.copy(alpha = 0.12f).toArgb(),
</a><a href="#h92-0-50" id="h92-0-50" class="i">+                &quot;actionSheetBackgroundDrawable&quot; to background,
</a><a href="#h92-0-51" id="h92-0-51" class="i">+                &quot;actionSheetRoundedBackgroundDrawable&quot; to background,
</a><a href="#h92-0-52" id="h92-0-52" class="i">+                &quot;sigExceptionColorCameraGridLines&quot; to background,
</a><a href="#h92-0-53" id="h92-0-53" class="i">+            )
</a><a href="#h92-0-54" id="h92-0-54" class="i">+        }
</a><a href="#h92-0-55" id="h92-0-55" class="i">+
</a><a href="#h92-0-56" id="h92-0-56" class="i">+        if (customThemeName == &quot;amoled_dark_mode&quot;) {
</a><a href="#h92-0-57" id="h92-0-57" class="i">+            currentTheme = parseAttributeList(
</a><a href="#h92-0-58" id="h92-0-58" class="i">+                &quot;sigColorTextPrimary&quot; to 0xFFFFFFFF,
</a><a href="#h92-0-59" id="h92-0-59" class="i">+                &quot;sigColorChatChat&quot; to 0xFFFFFFFF,
</a><a href="#h92-0-60" id="h92-0-60" class="i">+                &quot;sigColorChatPendingSending&quot; to 0xFFFFFFFF,
</a><a href="#h92-0-61" id="h92-0-61" class="i">+                &quot;sigColorChatSnapWithSound&quot; to 0xFFFFFFFF,
</a><a href="#h92-0-62" id="h92-0-62" class="i">+                &quot;sigColorChatSnapWithoutSound&quot; to 0xFFFFFFFF,
</a><a href="#h92-0-63" id="h92-0-63" class="i">+                &quot;sigColorBackgroundMain&quot; to 0xFF000000,
</a><a href="#h92-0-64" id="h92-0-64" class="i">+                &quot;sigColorBackgroundSurface&quot; to 0xFF000000,
</a><a href="#h92-0-65" id="h92-0-65" class="i">+                &quot;listDivider&quot; to 0xFF000000,
</a><a href="#h92-0-66" id="h92-0-66" class="i">+                &quot;actionSheetBackgroundDrawable&quot; to 0xFF000000,
</a><a href="#h92-0-67" id="h92-0-67" class="i">+                &quot;actionSheetRoundedBackgroundDrawable&quot; to 0xFF000000,
</a><a href="#h92-0-68" id="h92-0-68" class="i">+                &quot;sigExceptionColorCameraGridLines&quot; to 0xFF000000,
</a><a href="#h92-0-69" id="h92-0-69" class="i">+            )
</a><a href="#h92-0-70" id="h92-0-70" class="i">+        }
</a><a href="#h92-0-71" id="h92-0-71" class="i">+
</a><a href="#h92-0-72" id="h92-0-72" class="i">+        if (customThemeName == &quot;custom&quot;) {
</a><a href="#h92-0-73" id="h92-0-73" class="i">+            val availableThemes = context.fileHandlerManager.getFileHandle(FileHandleScope.THEME.key, &quot;&quot;)?.open(ParcelFileDescriptor.MODE_READ_ONLY)?.use { pfd -&gt;
</a><a href="#h92-0-74" id="h92-0-74" class="i">+                AutoCloseInputStream(pfd).use { it.readBytes() }
</a><a href="#h92-0-75" id="h92-0-75" class="i">+            }?.let {
</a><a href="#h92-0-76" id="h92-0-76" class="i">+                context.gson.fromJson(it.toString(Charsets.UTF_8), object: TypeToken&lt;List&lt;DatabaseThemeContent&gt;&gt;() {})
</a><a href="#h92-0-77" id="h92-0-77" class="i">+            } ?: run {
</a><a href="#h92-0-78" id="h92-0-78" class="i">+                context.log.verbose(&quot;no custom themes found&quot;)
</a><a href="#h92-0-79" id="h92-0-79" class="i">+                return
</a><a href="#h92-0-80" id="h92-0-80" class="i">+            }
</a><a href="#h92-0-81" id="h92-0-81" class="i">+
</a><a href="#h92-0-82" id="h92-0-82" class="i">+            val customThemeColors = mutableMapOf&lt;Int, Int&gt;()
</a><a href="#h92-0-83" id="h92-0-83" class="i">+
</a><a href="#h92-0-84" id="h92-0-84" class="i">+            context.log.verbose(&quot;loading ${availableThemes.size} custom themes&quot;)
</a><a href="#h92-0-85" id="h92-0-85" class="i">+
</a><a href="#h92-0-86" id="h92-0-86" class="i">+            availableThemes.forEach { themeContent -&gt;
</a><a href="#h92-0-87" id="h92-0-87" class="i">+                themeContent.colors.forEach colors@{ colorEntry -&gt;
</a><a href="#h92-0-88" id="h92-0-88" class="i">+                    customThemeColors[getAttribute(colorEntry.key).takeIf { it != 0 }.also {
</a><a href="#h92-0-89" id="h92-0-89" class="i">+                        if (it == null) {
</a><a href="#h92-0-90" id="h92-0-90" class="i">+                            context.log.warn(&quot;unknown color attribute: ${colorEntry.key}&quot;)
</a><a href="#h92-0-91" id="h92-0-91" class="i">+                        }
</a><a href="#h92-0-92" id="h92-0-92" class="i">+                    } ?: return@colors] = colorEntry.value
</a><a href="#h92-0-93" id="h92-0-93" class="i">+                }
</a><a href="#h92-0-94" id="h92-0-94" class="i">+            }
</a><a href="#h92-0-95" id="h92-0-95" class="i">+
</a><a href="#h92-0-96" id="h92-0-96" class="i">+            currentTheme = customThemeColors
</a><a href="#h92-0-97" id="h92-0-97" class="i">+
</a><a href="#h92-0-98" id="h92-0-98" class="i">+            context.log.verbose(&quot;loaded ${customThemeColors.size} custom theme colors&quot;)
</a><a href="#h92-0-99" id="h92-0-99" class="i">+        }
</a><a href="#h92-0-100" id="h92-0-100" class="i">+
</a><a href="#h92-0-101" id="h92-0-101" class="i">+        onNextActivityCreate {
</a><a href="#h92-0-102" id="h92-0-102" class="i">+            if (currentTheme.isEmpty()) return@onNextActivityCreate
</a><a href="#h92-0-103" id="h92-0-103" class="i">+
</a><a href="#h92-0-104" id="h92-0-104" class="i">+            context.androidContext.theme.javaClass.getMethod(&quot;obtainStyledAttributes&quot;, IntArray::class.java).hook(
</a><a href="#h92-0-105" id="h92-0-105" class="i">+                HookStage.AFTER) { param -&gt;
</a><a href="#h92-0-106" id="h92-0-106" class="i">+                val array = param.arg&lt;IntArray&gt;(0)
</a><a href="#h92-0-107" id="h92-0-107" class="i">+                val customColor = (currentTheme[array[0]] as? Number)?.toInt() ?: return@hook
</a><a href="#h92-0-108" id="h92-0-108" class="i">+
</a><a href="#h92-0-109" id="h92-0-109" class="i">+                val result = param.getResult() as TypedArray
</a><a href="#h92-0-110" id="h92-0-110" class="i">+                val typedArrayData = result.getObjectField(&quot;mData&quot;) as IntArray
</a><a href="#h92-0-111" id="h92-0-111" class="i">+
</a><a href="#h92-0-112" id="h92-0-112" class="i">+                when (val attributeType = result.getType(0)) {
</a><a href="#h92-0-113" id="h92-0-113" class="i">+                    TypedValue.TYPE_INT_COLOR_ARGB8, TypedValue.TYPE_INT_COLOR_RGB8, TypedValue.TYPE_INT_COLOR_ARGB4, TypedValue.TYPE_INT_COLOR_RGB4 -&gt; {
</a><a href="#h92-0-114" id="h92-0-114" class="i">+                        typedArrayData[1] = customColor // index + STYLE_DATA
</a><a href="#h92-0-115" id="h92-0-115" class="i">+                    }
</a><a href="#h92-0-116" id="h92-0-116" class="i">+                    TypedValue.TYPE_STRING -&gt; {
</a><a href="#h92-0-117" id="h92-0-117" class="i">+                        val stringValue = result.getString(0)
</a><a href="#h92-0-118" id="h92-0-118" class="i">+                        if (stringValue?.endsWith(&quot;.xml&quot;) == true) {
</a><a href="#h92-0-119" id="h92-0-119" class="i">+                            typedArrayData[0] = TypedValue.TYPE_INT_COLOR_ARGB4 // STYLE_TYPE
</a><a href="#h92-0-120" id="h92-0-120" class="i">+                            typedArrayData[1] = customColor // STYLE_DATA
</a><a href="#h92-0-121" id="h92-0-121" class="i">+                            typedArrayData[5] = 0; // STYLE_DENSITY
</a><a href="#h92-0-122" id="h92-0-122" class="i">+                        }
</a><a href="#h92-0-123" id="h92-0-123" class="i">+                    }
</a><a href="#h92-0-124" id="h92-0-124" class="i">+                    else -&gt; context.log.warn(&quot;unknown attribute type: ${attributeType.toString(16)}&quot;)
</a><a href="#h92-0-125" id="h92-0-125" class="i">+                }
</a><a href="#h92-0-126" id="h92-0-126" class="i">+            }
</a><a href="#h92-0-127" id="h92-0-127" class="i">+        }
</a><a href="#h92-0-128" id="h92-0-128" class="i">+    }
</a><a href="#h92-0-129" id="h92-0-129" class="i">+}</a><a href="#h92-0-130" id="h92-0-130" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h93" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/ui/CustomizeUI.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/ui/CustomizeUI.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/ui/CustomizeUI.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/ui/CustomizeUI.kt</a></b>
<a href="#h93-0" id="h93-0" class="h">@@ -1,523 +0,0 @@
</a><a href="#h93-0-0" id="h93-0-0" class="d">-package me.rhunk.snapenhance.core.features.impl.ui
</a><a href="#h93-0-1" id="h93-0-1" class="d">-
</a><a href="#h93-0-2" id="h93-0-2" class="d">-import android.content.res.TypedArray
</a><a href="#h93-0-3" id="h93-0-3" class="d">-import android.graphics.drawable.ColorDrawable
</a><a href="#h93-0-4" id="h93-0-4" class="d">-import android.os.Build
</a><a href="#h93-0-5" id="h93-0-5" class="d">-import android.util.TypedValue
</a><a href="#h93-0-6" id="h93-0-6" class="d">-import androidx.compose.material3.dynamicDarkColorScheme
</a><a href="#h93-0-7" id="h93-0-7" class="d">-import androidx.compose.ui.graphics.toArgb
</a><a href="#h93-0-8" id="h93-0-8" class="d">-import me.rhunk.snapenhance.core.features.Feature
</a><a href="#h93-0-9" id="h93-0-9" class="d">-import me.rhunk.snapenhance.core.features.FeatureLoadParams
</a><a href="#h93-0-10" id="h93-0-10" class="d">-import me.rhunk.snapenhance.core.util.hook.HookStage
</a><a href="#h93-0-11" id="h93-0-11" class="d">-import me.rhunk.snapenhance.core.util.hook.Hooker
</a><a href="#h93-0-12" id="h93-0-12" class="d">-import me.rhunk.snapenhance.core.util.hook.hook
</a><a href="#h93-0-13" id="h93-0-13" class="d">-import me.rhunk.snapenhance.core.util.ktx.getIdentifier
</a><a href="#h93-0-14" id="h93-0-14" class="d">-
</a><a href="#h93-0-15" id="h93-0-15" class="d">-class CustomizeUI: Feature(&quot;Customize UI&quot;, loadParams = FeatureLoadParams.ACTIVITY_CREATE_SYNC) {
</a><a href="#h93-0-16" id="h93-0-16" class="d">-    private fun getAttribute(name: String): Int {
</a><a href="#h93-0-17" id="h93-0-17" class="d">-        return context.resources.getIdentifier(name, &quot;attr&quot;)
</a><a href="#h93-0-18" id="h93-0-18" class="d">-    }
</a><a href="#h93-0-19" id="h93-0-19" class="d">-
</a><a href="#h93-0-20" id="h93-0-20" class="d">-    override fun onActivityCreate() {
</a><a href="#h93-0-21" id="h93-0-21" class="d">-        val customizeUIConfig = context.config.userInterface.customizeUi
</a><a href="#h93-0-22" id="h93-0-22" class="d">-        val themePicker = customizeUIConfig.themePicker.getNullable() ?: return
</a><a href="#h93-0-23" id="h93-0-23" class="d">-        val colorsConfig = context.config.userInterface.customizeUi.colors
</a><a href="#h93-0-24" id="h93-0-24" class="d">-        val experimentalColors = context.config.experimental.experimentalColors
</a><a href="#h93-0-25" id="h93-0-25" class="d">-        val isColorDebug = customizeUIConfig.colorsDebug.get()
</a><a href="#h93-0-26" id="h93-0-26" class="d">-        
</a><a href="#h93-0-27" id="h93-0-27" class="d">-        if (themePicker == &quot;custom&quot;) {
</a><a href="#h93-0-28" id="h93-0-28" class="d">-            themes.clear()
</a><a href="#h93-0-29" id="h93-0-29" class="d">-            themes[themePicker] = mapOf(
</a><a href="#h93-0-30" id="h93-0-30" class="d">-                &quot;sigColorTextPrimary&quot; to colorsConfig.textColor.getNullable(),
</a><a href="#h93-0-31" id="h93-0-31" class="d">-                &quot;sigColorChatChat&quot; to colorsConfig.chatChatTextColor.getNullable(),
</a><a href="#h93-0-32" id="h93-0-32" class="d">-                &quot;sigColorChatPendingSending&quot; to  colorsConfig.pendingSendingTextColor.getNullable(),
</a><a href="#h93-0-33" id="h93-0-33" class="d">-                &quot;sigColorChatSnapWithSound&quot; to colorsConfig.snapWithSoundTextColor.getNullable(),
</a><a href="#h93-0-34" id="h93-0-34" class="d">-                &quot;sigColorChatSnapWithoutSound&quot; to colorsConfig.snapWithoutSoundTextColor.getNullable(),
</a><a href="#h93-0-35" id="h93-0-35" class="d">-                &quot;sigColorBackgroundMain&quot; to colorsConfig.backgroundColor.getNullable(),
</a><a href="#h93-0-36" id="h93-0-36" class="d">-                &quot;listDivider&quot; to colorsConfig.friendFeedConversationsLineColor.getNullable(),
</a><a href="#h93-0-37" id="h93-0-37" class="d">-                &quot;sigColorBackgroundSurface&quot; to colorsConfig.backgroundColorSurface.getNullable(),
</a><a href="#h93-0-38" id="h93-0-38" class="d">-                &quot;actionSheetBackgroundDrawable&quot; to colorsConfig.actionMenuBackgroundColor.getNullable(),
</a><a href="#h93-0-39" id="h93-0-39" class="d">-                &quot;actionSheetRoundedBackgroundDrawable&quot; to colorsConfig.actionMenuRoundBackgroundColor.getNullable(),
</a><a href="#h93-0-40" id="h93-0-40" class="d">-                &quot;sigExceptionColorCameraGridLines&quot; to colorsConfig.cameraGridLines.getNullable(),
</a><a href="#h93-0-41" id="h93-0-41" class="d">-                &quot;listBackgroundDrawable&quot; to colorsConfig.listBackgroundDrawable.getNullable(),
</a><a href="#h93-0-42" id="h93-0-42" class="d">-                &quot;sigColorIconPrimary&quot; to colorsConfig.sigColorIconPrimary.getNullable(),
</a><a href="#h93-0-43" id="h93-0-43" class="d">-                &quot;actionSheetDescriptionTextColor&quot; to colorsConfig.actionSheetDescriptionTextColor.getNullable(),
</a><a href="#h93-0-44" id="h93-0-44" class="d">-                &quot;ringColor&quot; to experimentalColors.ringColor.getNullable(),
</a><a href="#h93-0-45" id="h93-0-45" class="d">-                &quot;sigColorIconSecondary&quot; to experimentalColors.sigColorIconSecondary.getNullable(),
</a><a href="#h93-0-46" id="h93-0-46" class="d">-                &quot;itemShapeFillColor&quot; to experimentalColors.itemShapeFillColor.getNullable(),
</a><a href="#h93-0-47" id="h93-0-47" class="d">-                &quot;ringStartColor&quot; to experimentalColors.ringStartColor.getNullable(),
</a><a href="#h93-0-48" id="h93-0-48" class="d">-                &quot;sigColorLayoutPlaceholder&quot; to experimentalColors.sigColorLayoutPlaceholder.getNullable(),
</a><a href="#h93-0-49" id="h93-0-49" class="d">-                &quot;scButtonColor&quot; to experimentalColors.scButtonColor.getNullable(),
</a><a href="#h93-0-50" id="h93-0-50" class="d">-                &quot;recipientPillBackgroundDrawable&quot; to experimentalColors.recipientPillBackgroundDrawable.getNullable(),
</a><a href="#h93-0-51" id="h93-0-51" class="d">-                &quot;boxBackgroundColor&quot; to experimentalColors.boxBackgroundColor.getNullable(),
</a><a href="#h93-0-52" id="h93-0-52" class="d">-                &quot;editTextColor&quot; to experimentalColors.editTextColor.getNullable(),
</a><a href="#h93-0-53" id="h93-0-53" class="d">-                &quot;chipBackgroundColor&quot; to experimentalColors.chipBackgroundColor.getNullable(),
</a><a href="#h93-0-54" id="h93-0-54" class="d">-                &quot;recipientInputStyle&quot; to experimentalColors.recipientInputStyle.getNullable(),
</a><a href="#h93-0-55" id="h93-0-55" class="d">-                &quot;rangeFillColor&quot; to experimentalColors.rangeFillColor.getNullable(),
</a><a href="#h93-0-56" id="h93-0-56" class="d">-                &quot;pstsIndicatorColor&quot; to experimentalColors.pstsIndicatorColor.getNullable(),
</a><a href="#h93-0-57" id="h93-0-57" class="d">-                &quot;pstsTabBackground&quot; to experimentalColors.pstsTabBackground.getNullable(),
</a><a href="#h93-0-58" id="h93-0-58" class="d">-                &quot;pstsDividerColor&quot; to experimentalColors.pstsDividerColor.getNullable(),
</a><a href="#h93-0-59" id="h93-0-59" class="d">-                &quot;tabTextColor&quot; to experimentalColors.tabTextColor.getNullable(),
</a><a href="#h93-0-60" id="h93-0-60" class="d">-                &quot;statusBarForeground&quot; to experimentalColors.statusBarForeground.getNullable(),
</a><a href="#h93-0-61" id="h93-0-61" class="d">-                &quot;statusBarBackground&quot; to experimentalColors.statusBarBackground.getNullable(),
</a><a href="#h93-0-62" id="h93-0-62" class="d">-                &quot;strokeColor&quot; to experimentalColors.strokeColor.getNullable(),
</a><a href="#h93-0-63" id="h93-0-63" class="d">-                &quot;storyReplayViewRingColor&quot; to experimentalColors.storyReplayViewRingColor.getNullable(),
</a><a href="#h93-0-64" id="h93-0-64" class="d">-                &quot;sigColorButtonPrimary&quot; to experimentalColors.sigColorButtonPrimary.getNullable(),
</a><a href="#h93-0-65" id="h93-0-65" class="d">-                &quot;sigColorBaseAppYellow&quot; to experimentalColors.sigColorBaseAppYellow.getNullable(),
</a><a href="#h93-0-66" id="h93-0-66" class="d">-                &quot;sigColorBackgroundSurfaceTranslucent&quot; to experimentalColors.sigColorBackgroundSurfaceTranslucent.getNullable(),
</a><a href="#h93-0-67" id="h93-0-67" class="d">-                &quot;sigColorStoryRingFriendsFeedStoryRing&quot; to experimentalColors.sigColorStoryRingFriendsFeedStoryRing.getNullable(),
</a><a href="#h93-0-68" id="h93-0-68" class="d">-                &quot;sigColorStoryRingDiscoverTabThumbnailStoryRing&quot; to experimentalColors.sigColorStoryRingDiscoverTabThumbnailStoryRing.getNullable(),
</a><a href="#h93-0-69" id="h93-0-69" class="d">-            ).filterValues { it != null }.map { (key, value) -&gt;
</a><a href="#h93-0-70" id="h93-0-70" class="d">-                getAttribute(key) to value!!
</a><a href="#h93-0-71" id="h93-0-71" class="d">-            }.toMap()
</a><a href="#h93-0-72" id="h93-0-72" class="d">-        } 
</a><a href="#h93-0-73" id="h93-0-73" class="d">-        if (themePicker == &quot;material_you_light&quot; || themePicker == &quot;material_you_dark&quot;) {
</a><a href="#h93-0-74" id="h93-0-74" class="d">-            if (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.S) {
</a><a href="#h93-0-75" id="h93-0-75" class="d">-                val colorScheme = dynamicDarkColorScheme(context.androidContext)
</a><a href="#h93-0-76" id="h93-0-76" class="d">-                val light = themePicker == &quot;material_you_light&quot;
</a><a href="#h93-0-77" id="h93-0-77" class="d">-                themes.clear()
</a><a href="#h93-0-78" id="h93-0-78" class="d">-                val surfaceVariant = (if (light) colorScheme.surfaceVariant else colorScheme.onSurfaceVariant).toArgb()
</a><a href="#h93-0-79" id="h93-0-79" class="d">-                val background = (if (light) colorScheme.onBackground else colorScheme.background).toArgb()
</a><a href="#h93-0-80" id="h93-0-80" class="d">-
</a><a href="#h93-0-81" id="h93-0-81" class="d">-                themes[themePicker] = mapOf(
</a><a href="#h93-0-82" id="h93-0-82" class="d">-                    &quot;sigColorTextPrimary&quot; to surfaceVariant,
</a><a href="#h93-0-83" id="h93-0-83" class="d">-                    &quot;sigColorChatChat&quot; to surfaceVariant,
</a><a href="#h93-0-84" id="h93-0-84" class="d">-                    &quot;sigColorChatPendingSending&quot; to surfaceVariant,
</a><a href="#h93-0-85" id="h93-0-85" class="d">-                    &quot;sigColorChatSnapWithSound&quot; to surfaceVariant,
</a><a href="#h93-0-86" id="h93-0-86" class="d">-                    &quot;sigColorChatSnapWithoutSound&quot; to surfaceVariant,
</a><a href="#h93-0-87" id="h93-0-87" class="d">-                    &quot;sigColorBackgroundMain&quot; to background,
</a><a href="#h93-0-88" id="h93-0-88" class="d">-                    &quot;sigColorBackgroundSurface&quot; to background,
</a><a href="#h93-0-89" id="h93-0-89" class="d">-                    &quot;listDivider&quot; to colorScheme.onPrimary.copy(alpha = 0.12f).toArgb(),
</a><a href="#h93-0-90" id="h93-0-90" class="d">-                    &quot;actionSheetBackgroundDrawable&quot; to background,
</a><a href="#h93-0-91" id="h93-0-91" class="d">-                    &quot;actionSheetRoundedBackgroundDrawable&quot; to background,
</a><a href="#h93-0-92" id="h93-0-92" class="d">-                    &quot;sigExceptionColorCameraGridLines&quot; to background,
</a><a href="#h93-0-93" id="h93-0-93" class="d">-                ).map { getAttribute(it.key) to it.value }.toMap()
</a><a href="#h93-0-94" id="h93-0-94" class="d">-            }
</a><a href="#h93-0-95" id="h93-0-95" class="d">-        }
</a><a href="#h93-0-96" id="h93-0-96" class="d">-
</a><a href="#h93-0-97" id="h93-0-97" class="d">-        context.androidContext.theme.javaClass.getMethod(&quot;obtainStyledAttributes&quot;, IntArray::class.java).hook(
</a><a href="#h93-0-98" id="h93-0-98" class="d">-            HookStage.AFTER) { param -&gt;
</a><a href="#h93-0-99" id="h93-0-99" class="d">-            val array = param.arg&lt;IntArray&gt;(0)
</a><a href="#h93-0-100" id="h93-0-100" class="d">-            val result = param.getResult() as TypedArray
</a><a href="#h93-0-101" id="h93-0-101" class="d">-            if(isColorDebug) {
</a><a href="#h93-0-102" id="h93-0-102" class="d">-                context.log.verbose(context.resources.getResourceName(array[0]))
</a><a href="#h93-0-103" id="h93-0-103" class="d">-            }
</a><a href="#h93-0-104" id="h93-0-104" class="d">-
</a><a href="#h93-0-105" id="h93-0-105" class="d">-            fun ephemeralHook(methodName: String, content: Any) {
</a><a href="#h93-0-106" id="h93-0-106" class="d">-                Hooker.ephemeralHookObjectMethod(result::class.java, result, methodName, HookStage.BEFORE) {
</a><a href="#h93-0-107" id="h93-0-107" class="d">-                    it.setResult(content)
</a><a href="#h93-0-108" id="h93-0-108" class="d">-                }
</a><a href="#h93-0-109" id="h93-0-109" class="d">-            }
</a><a href="#h93-0-110" id="h93-0-110" class="d">-
</a><a href="#h93-0-111" id="h93-0-111" class="d">-            themes[themePicker]?.get(array[0])?.let { value -&gt;
</a><a href="#h93-0-112" id="h93-0-112" class="d">-                when (val attributeType = result.getType(0)) {
</a><a href="#h93-0-113" id="h93-0-113" class="d">-                    TypedValue.TYPE_INT_COLOR_ARGB8, TypedValue.TYPE_INT_COLOR_RGB8, TypedValue.TYPE_INT_COLOR_ARGB4, TypedValue.TYPE_INT_COLOR_RGB4 -&gt; {
</a><a href="#h93-0-114" id="h93-0-114" class="d">-                        ephemeralHook(&quot;getColor&quot;, (value as Number).toInt())
</a><a href="#h93-0-115" id="h93-0-115" class="d">-                    }
</a><a href="#h93-0-116" id="h93-0-116" class="d">-                    TypedValue.TYPE_STRING -&gt; {
</a><a href="#h93-0-117" id="h93-0-117" class="d">-                        val stringValue = result.getString(0)
</a><a href="#h93-0-118" id="h93-0-118" class="d">-                        if (stringValue?.endsWith(&quot;.xml&quot;) == true) {
</a><a href="#h93-0-119" id="h93-0-119" class="d">-                            ephemeralHook(&quot;getDrawable&quot;, ColorDrawable((value as Number).toInt()))
</a><a href="#h93-0-120" id="h93-0-120" class="d">-                        }
</a><a href="#h93-0-121" id="h93-0-121" class="d">-                    }
</a><a href="#h93-0-122" id="h93-0-122" class="d">-                    else -&gt; context.log.warn(&quot;unknown attribute type: ${attributeType.toString(16)}&quot;)
</a><a href="#h93-0-123" id="h93-0-123" class="d">-                }
</a><a href="#h93-0-124" id="h93-0-124" class="d">-            }
</a><a href="#h93-0-125" id="h93-0-125" class="d">-        }
</a><a href="#h93-0-126" id="h93-0-126" class="d">-    }
</a><a href="#h93-0-127" id="h93-0-127" class="d">-
</a><a href="#h93-0-128" id="h93-0-128" class="d">-    private val themes by lazy {
</a><a href="#h93-0-129" id="h93-0-129" class="d">-       mapOf(
</a><a href="#h93-0-130" id="h93-0-130" class="d">-           &quot;amoled_dark_mode&quot; to mapOf(
</a><a href="#h93-0-131" id="h93-0-131" class="d">-               &quot;sigColorTextPrimary&quot; to 0xFFFFFFFF,
</a><a href="#h93-0-132" id="h93-0-132" class="d">-               &quot;sigColorBackgroundMain&quot; to 0xFF000000,
</a><a href="#h93-0-133" id="h93-0-133" class="d">-               &quot;sigColorBackgroundSurface&quot; to 0xFF000000,
</a><a href="#h93-0-134" id="h93-0-134" class="d">-               &quot;listDivider&quot; to 0xFF000000,
</a><a href="#h93-0-135" id="h93-0-135" class="d">-               &quot;actionSheetBackgroundDrawable&quot; to 0xFF000000,
</a><a href="#h93-0-136" id="h93-0-136" class="d">-               &quot;actionSheetRoundedBackgroundDrawable&quot; to 0xFF000000
</a><a href="#h93-0-137" id="h93-0-137" class="d">-           ),
</a><a href="#h93-0-138" id="h93-0-138" class="d">-           &quot;light_blue&quot; to mapOf(
</a><a href="#h93-0-139" id="h93-0-139" class="d">-               &quot;sigColorTextPrimary&quot; to 0xFF03BAFC,
</a><a href="#h93-0-140" id="h93-0-140" class="d">-               &quot;sigColorBackgroundMain&quot; to 0xFFBDE6FF,
</a><a href="#h93-0-141" id="h93-0-141" class="d">-               &quot;sigColorBackgroundSurface&quot; to 0xFF78DBFF,
</a><a href="#h93-0-142" id="h93-0-142" class="d">-               &quot;listDivider&quot; to 0xFFBDE6FF,
</a><a href="#h93-0-143" id="h93-0-143" class="d">-               &quot;actionSheetBackgroundDrawable&quot; to 0xFF78DBFF,
</a><a href="#h93-0-144" id="h93-0-144" class="d">-               &quot;sigColorChatChat&quot; to 0xFF08D6FF,
</a><a href="#h93-0-145" id="h93-0-145" class="d">-               &quot;sigColorChatPendingSending&quot; to 0xFF08D6FF,
</a><a href="#h93-0-146" id="h93-0-146" class="d">-               &quot;sigColorChatSnapWithSound&quot; to 0xFF08D6FF,
</a><a href="#h93-0-147" id="h93-0-147" class="d">-               &quot;sigColorChatSnapWithoutSound&quot; to 0xFF08D6FF,
</a><a href="#h93-0-148" id="h93-0-148" class="d">-               &quot;sigExceptionColorCameraGridLines&quot; to 0xFF08D6FF
</a><a href="#h93-0-149" id="h93-0-149" class="d">-           ),
</a><a href="#h93-0-150" id="h93-0-150" class="d">-           &quot;dark_blue&quot; to mapOf(
</a><a href="#h93-0-151" id="h93-0-151" class="d">-               &quot;sigColorTextPrimary&quot; to 0xFF98C2FD,
</a><a href="#h93-0-152" id="h93-0-152" class="d">-               &quot;sigColorBackgroundMain&quot; to 0xFF192744,
</a><a href="#h93-0-153" id="h93-0-153" class="d">-               &quot;sigColorBackgroundSurface&quot; to 0xFF192744,
</a><a href="#h93-0-154" id="h93-0-154" class="d">-               &quot;actionSheetBackgroundDrawable&quot; to 0xFF192744,
</a><a href="#h93-0-155" id="h93-0-155" class="d">-               &quot;sigColorChatChat&quot; to 0xFF98C2FD,
</a><a href="#h93-0-156" id="h93-0-156" class="d">-               &quot;sigColorChatPendingSending&quot; to 0xFF98C2FD,
</a><a href="#h93-0-157" id="h93-0-157" class="d">-               &quot;sigColorChatSnapWithSound&quot; to 0xFF98C2FD,
</a><a href="#h93-0-158" id="h93-0-158" class="d">-               &quot;sigColorChatSnapWithoutSound&quot; to 0xFF98C2FD,
</a><a href="#h93-0-159" id="h93-0-159" class="d">-               &quot;sigExceptionColorCameraGridLines&quot; to 0xFF192744
</a><a href="#h93-0-160" id="h93-0-160" class="d">-           ),
</a><a href="#h93-0-161" id="h93-0-161" class="d">-           &quot;midnight_slate&quot; to mapOf(
</a><a href="#h93-0-162" id="h93-0-162" class="d">-               &quot;sigColorTextPrimary&quot; to 0xFFFFFFFF,
</a><a href="#h93-0-163" id="h93-0-163" class="d">-               &quot;sigColorBackgroundMain&quot; to 0xFF1F2833,
</a><a href="#h93-0-164" id="h93-0-164" class="d">-               &quot;sigColorBackgroundSurface&quot; to 0xFF1F2833,
</a><a href="#h93-0-165" id="h93-0-165" class="d">-               &quot;actionSheetBackgroundDrawable&quot; to 0xFF2C3E50,
</a><a href="#h93-0-166" id="h93-0-166" class="d">-               &quot;actionSheetRoundedBackgroundDrawable&quot; to 0xFF34495E,
</a><a href="#h93-0-167" id="h93-0-167" class="d">-               &quot;listDivider&quot; to 0xFF1F2833,
</a><a href="#h93-0-168" id="h93-0-168" class="d">-               &quot;sigColorChatChat&quot; to 0xFFFFFF00,
</a><a href="#h93-0-169" id="h93-0-169" class="d">-               &quot;sigColorChatPendingSending&quot; to 0xFF00FFFF,
</a><a href="#h93-0-170" id="h93-0-170" class="d">-               &quot;sigColorChatSnapWithSound&quot; to 0xFFFF9800,
</a><a href="#h93-0-171" id="h93-0-171" class="d">-               &quot;sigColorChatSnapWithoutSound&quot; to 0xFF00E676,
</a><a href="#h93-0-172" id="h93-0-172" class="d">-               &quot;sigExceptionColorCameraGridLines&quot; to 0xFFFFFFFF,
</a><a href="#h93-0-173" id="h93-0-173" class="d">-               &quot;sigColorIconPrimary&quot; to 0xFFFFFF00
</a><a href="#h93-0-174" id="h93-0-174" class="d">-           ),
</a><a href="#h93-0-175" id="h93-0-175" class="d">-           &quot;earthy_autumn&quot; to mapOf(
</a><a href="#h93-0-176" id="h93-0-176" class="d">-               &quot;sigColorTextPrimary&quot; to 0xFFF7CAC9,
</a><a href="#h93-0-177" id="h93-0-177" class="d">-               &quot;sigColorBackgroundMain&quot; to 0xFF800000,
</a><a href="#h93-0-178" id="h93-0-178" class="d">-               &quot;sigColorBackgroundSurface&quot; to 0xFF800000,
</a><a href="#h93-0-179" id="h93-0-179" class="d">-               &quot;actionSheetBackgroundDrawable&quot; to 0xFF800000,
</a><a href="#h93-0-180" id="h93-0-180" class="d">-               &quot;sigColorChatChat&quot; to 0xFFF7CAC9,
</a><a href="#h93-0-181" id="h93-0-181" class="d">-               &quot;sigColorChatPendingSending&quot; to 0xFFF7CAC9,
</a><a href="#h93-0-182" id="h93-0-182" class="d">-               &quot;sigColorChatSnapWithSound&quot; to 0xFFF7CAC9,
</a><a href="#h93-0-183" id="h93-0-183" class="d">-               &quot;sigColorChatSnapWithoutSound&quot; to 0xFFF7CAC9,
</a><a href="#h93-0-184" id="h93-0-184" class="d">-               &quot;sigExceptionColorCameraGridLines&quot; to 0xFF800000
</a><a href="#h93-0-185" id="h93-0-185" class="d">-           ),
</a><a href="#h93-0-186" id="h93-0-186" class="d">-           &quot;mint_chocolate&quot; to mapOf(
</a><a href="#h93-0-187" id="h93-0-187" class="d">-               &quot;sigColorTextPrimary&quot; to 0xFFFFFFFF,
</a><a href="#h93-0-188" id="h93-0-188" class="d">-               &quot;sigColorBackgroundMain&quot; to 0xFF98FF98,
</a><a href="#h93-0-189" id="h93-0-189" class="d">-               &quot;sigColorBackgroundSurface&quot; to 0xFF98FF98,
</a><a href="#h93-0-190" id="h93-0-190" class="d">-               &quot;actionSheetBackgroundDrawable&quot; to 0xFF98FF98,
</a><a href="#h93-0-191" id="h93-0-191" class="d">-               &quot;sigColorChatChat&quot; to 0xFFFFFFFF,
</a><a href="#h93-0-192" id="h93-0-192" class="d">-               &quot;sigColorChatPendingSending&quot; to 0xFFFFFFFF,
</a><a href="#h93-0-193" id="h93-0-193" class="d">-               &quot;sigColorChatSnapWithSound&quot; to 0xFFFFFFFF,
</a><a href="#h93-0-194" id="h93-0-194" class="d">-               &quot;sigColorChatSnapWithoutSound&quot; to 0xFFFFFFFF,
</a><a href="#h93-0-195" id="h93-0-195" class="d">-               &quot;sigExceptionColorCameraGridLines&quot; to 0xFF98FF98
</a><a href="#h93-0-196" id="h93-0-196" class="d">-           ),
</a><a href="#h93-0-197" id="h93-0-197" class="d">-           &quot;ginger_snap&quot; to mapOf(
</a><a href="#h93-0-198" id="h93-0-198" class="d">-               &quot;sigColorTextPrimary&quot; to 0xFFFFFFFF,
</a><a href="#h93-0-199" id="h93-0-199" class="d">-               &quot;sigColorBackgroundMain&quot; to 0xFFC6893A,
</a><a href="#h93-0-200" id="h93-0-200" class="d">-               &quot;sigColorBackgroundSurface&quot; to 0xFFC6893A,
</a><a href="#h93-0-201" id="h93-0-201" class="d">-               &quot;actionSheetBackgroundDrawable&quot; to 0xFFC6893A,
</a><a href="#h93-0-202" id="h93-0-202" class="d">-               &quot;sigColorChatChat&quot; to 0xFFFFFFFF,
</a><a href="#h93-0-203" id="h93-0-203" class="d">-               &quot;sigColorChatPendingSending&quot; to 0xFFFFFFFF,
</a><a href="#h93-0-204" id="h93-0-204" class="d">-               &quot;sigColorChatSnapWithSound&quot; to 0xFFFFFFFF,
</a><a href="#h93-0-205" id="h93-0-205" class="d">-               &quot;sigColorChatSnapWithoutSound&quot; to 0xFFFFFFFF,
</a><a href="#h93-0-206" id="h93-0-206" class="d">-               &quot;sigExceptionColorCameraGridLines&quot; to 0xFFC6893A
</a><a href="#h93-0-207" id="h93-0-207" class="d">-           ),
</a><a href="#h93-0-208" id="h93-0-208" class="d">-           &quot;lemon_meringue&quot; to mapOf(
</a><a href="#h93-0-209" id="h93-0-209" class="d">-               &quot;sigColorTextPrimary&quot; to 0xFF000000,
</a><a href="#h93-0-210" id="h93-0-210" class="d">-               &quot;sigColorBackgroundMain&quot; to 0xFFFCFFE7,
</a><a href="#h93-0-211" id="h93-0-211" class="d">-               &quot;sigColorBackgroundSurface&quot; to 0xFFFCFFE7,
</a><a href="#h93-0-212" id="h93-0-212" class="d">-               &quot;actionSheetBackgroundDrawable&quot; to 0xFFFCFFE7,
</a><a href="#h93-0-213" id="h93-0-213" class="d">-               &quot;sigColorChatChat&quot; to 0xFF000000,
</a><a href="#h93-0-214" id="h93-0-214" class="d">-               &quot;sigColorChatPendingSending&quot; to 0xFF000000,
</a><a href="#h93-0-215" id="h93-0-215" class="d">-               &quot;sigColorChatSnapWithSound&quot; to 0xFF000000,
</a><a href="#h93-0-216" id="h93-0-216" class="d">-               &quot;sigColorChatSnapWithoutSound&quot; to 0xFF000000,
</a><a href="#h93-0-217" id="h93-0-217" class="d">-               &quot;sigExceptionColorCameraGridLines&quot; to 0xFFFCFFE7
</a><a href="#h93-0-218" id="h93-0-218" class="d">-           ),
</a><a href="#h93-0-219" id="h93-0-219" class="d">-           &quot;lava_flow&quot; to mapOf(
</a><a href="#h93-0-220" id="h93-0-220" class="d">-               &quot;sigColorTextPrimary&quot; to 0xFFFFCC00,
</a><a href="#h93-0-221" id="h93-0-221" class="d">-               &quot;sigColorBackgroundMain&quot; to 0xFFC70039,
</a><a href="#h93-0-222" id="h93-0-222" class="d">-               &quot;sigColorBackgroundSurface&quot; to 0xFFC70039,
</a><a href="#h93-0-223" id="h93-0-223" class="d">-               &quot;actionSheetBackgroundDrawable&quot; to 0xFFC70039,
</a><a href="#h93-0-224" id="h93-0-224" class="d">-               &quot;sigColorChatChat&quot; to 0xFFFFCC00,
</a><a href="#h93-0-225" id="h93-0-225" class="d">-               &quot;sigColorChatPendingSending&quot; to 0xFFFFCC00,
</a><a href="#h93-0-226" id="h93-0-226" class="d">-               &quot;sigColorChatSnapWithSound&quot; to 0xFFFFCC00,
</a><a href="#h93-0-227" id="h93-0-227" class="d">-               &quot;sigColorChatSnapWithoutSound&quot; to 0xFFFFCC00,
</a><a href="#h93-0-228" id="h93-0-228" class="d">-               &quot;sigExceptionColorCameraGridLines&quot; to 0xFFC70039
</a><a href="#h93-0-229" id="h93-0-229" class="d">-           ),
</a><a href="#h93-0-230" id="h93-0-230" class="d">-           &quot;ocean_fog&quot; to mapOf(
</a><a href="#h93-0-231" id="h93-0-231" class="d">-               &quot;sigColorTextPrimary&quot; to 0xFF333333,
</a><a href="#h93-0-232" id="h93-0-232" class="d">-               &quot;sigColorBackgroundMain&quot; to 0xFFB0C4DE,
</a><a href="#h93-0-233" id="h93-0-233" class="d">-               &quot;sigColorBackgroundSurface&quot; to 0xFFB0C4DE,
</a><a href="#h93-0-234" id="h93-0-234" class="d">-               &quot;actionSheetBackgroundDrawable&quot; to 0xFFB0C4DE,
</a><a href="#h93-0-235" id="h93-0-235" class="d">-               &quot;sigColorChatChat&quot; to 0xFF333333,
</a><a href="#h93-0-236" id="h93-0-236" class="d">-               &quot;sigColorChatPendingSending&quot; to 0xFF333333,
</a><a href="#h93-0-237" id="h93-0-237" class="d">-               &quot;sigColorChatSnapWithSound&quot; to 0xFF333333,
</a><a href="#h93-0-238" id="h93-0-238" class="d">-               &quot;sigColorChatSnapWithoutSound&quot; to 0xFF333333,
</a><a href="#h93-0-239" id="h93-0-239" class="d">-               &quot;sigExceptionColorCameraGridLines&quot; to 0xFFB0C4DE
</a><a href="#h93-0-240" id="h93-0-240" class="d">-           ),
</a><a href="#h93-0-241" id="h93-0-241" class="d">-           &quot;alien_landscape&quot; to mapOf(
</a><a href="#h93-0-242" id="h93-0-242" class="d">-               &quot;sigColorTextPrimary&quot; to 0xFFFFFFFF,
</a><a href="#h93-0-243" id="h93-0-243" class="d">-               &quot;sigColorBackgroundMain&quot; to 0xFF9B59B6,
</a><a href="#h93-0-244" id="h93-0-244" class="d">-               &quot;sigColorBackgroundSurface&quot; to 0xFF9B59B6,
</a><a href="#h93-0-245" id="h93-0-245" class="d">-               &quot;actionSheetBackgroundDrawable&quot; to 0xFF9B59B6,
</a><a href="#h93-0-246" id="h93-0-246" class="d">-               &quot;sigColorChatChat&quot; to 0xFFFFFFFF,
</a><a href="#h93-0-247" id="h93-0-247" class="d">-               &quot;sigColorChatPendingSending&quot; to 0xFFFFFFFF,
</a><a href="#h93-0-248" id="h93-0-248" class="d">-               &quot;sigColorChatSnapWithSound&quot; to 0xFFFFFFFF,
</a><a href="#h93-0-249" id="h93-0-249" class="d">-               &quot;sigColorChatSnapWithoutSound&quot; to 0xFFFFFFFF,
</a><a href="#h93-0-250" id="h93-0-250" class="d">-               &quot;sigExceptionColorCameraGridLines&quot; to 0xFF9B59B6
</a><a href="#h93-0-251" id="h93-0-251" class="d">-           ),
</a><a href="#h93-0-252" id="h93-0-252" class="d">-           &quot;watercolor_wash&quot; to mapOf(
</a><a href="#h93-0-253" id="h93-0-253" class="d">-               &quot;sigColorTextPrimary&quot; to 0xFF3F51B5,
</a><a href="#h93-0-254" id="h93-0-254" class="d">-               &quot;sigColorBackgroundMain&quot; to 0xFFFFF5F3,
</a><a href="#h93-0-255" id="h93-0-255" class="d">-               &quot;sigColorBackgroundSurface&quot; to 0xFFFFF5F3,
</a><a href="#h93-0-256" id="h93-0-256" class="d">-               &quot;actionSheetBackgroundDrawable&quot; to 0xFFFFF5F3,
</a><a href="#h93-0-257" id="h93-0-257" class="d">-               &quot;sigColorChatChat&quot; to 0xFF3F51B5,
</a><a href="#h93-0-258" id="h93-0-258" class="d">-               &quot;sigColorChatPendingSending&quot; to 0xFF3F51B5,
</a><a href="#h93-0-259" id="h93-0-259" class="d">-               &quot;sigColorChatSnapWithSound&quot; to 0xFF3F51B5,
</a><a href="#h93-0-260" id="h93-0-260" class="d">-               &quot;sigColorChatSnapWithoutSound&quot; to 0xFF3F51B5,
</a><a href="#h93-0-261" id="h93-0-261" class="d">-               &quot;sigExceptionColorCameraGridLines&quot; to 0xFFFFF5F3
</a><a href="#h93-0-262" id="h93-0-262" class="d">-           ),
</a><a href="#h93-0-263" id="h93-0-263" class="d">-           &quot;zesty_lemon&quot; to mapOf(
</a><a href="#h93-0-264" id="h93-0-264" class="d">-               &quot;sigColorTextPrimary&quot; to 0xFF222222,
</a><a href="#h93-0-265" id="h93-0-265" class="d">-               &quot;sigColorBackgroundMain&quot; to 0xFFFFFFE0,
</a><a href="#h93-0-266" id="h93-0-266" class="d">-               &quot;sigColorBackgroundSurface&quot; to 0xFFFFFFE0,
</a><a href="#h93-0-267" id="h93-0-267" class="d">-               &quot;actionSheetBackgroundDrawable&quot; to 0xFFFFFFE0,
</a><a href="#h93-0-268" id="h93-0-268" class="d">-               &quot;sigColorChatChat&quot; to 0xFF222222,
</a><a href="#h93-0-269" id="h93-0-269" class="d">-               &quot;sigColorChatPendingSending&quot; to 0xFF222222,
</a><a href="#h93-0-270" id="h93-0-270" class="d">-               &quot;sigColorChatSnapWithSound&quot; to 0xFF222222,
</a><a href="#h93-0-271" id="h93-0-271" class="d">-               &quot;sigColorChatSnapWithoutSound&quot; to 0xFF222222,
</a><a href="#h93-0-272" id="h93-0-272" class="d">-               &quot;sigExceptionColorCameraGridLines&quot; to 0xFFFFFFE0
</a><a href="#h93-0-273" id="h93-0-273" class="d">-           ),
</a><a href="#h93-0-274" id="h93-0-274" class="d">-           &quot;tropical_paradise&quot; to mapOf(
</a><a href="#h93-0-275" id="h93-0-275" class="d">-               &quot;sigColorTextPrimary&quot; to 0xFF000000,
</a><a href="#h93-0-276" id="h93-0-276" class="d">-               &quot;sigColorBackgroundMain&quot; to 0xFFD3FFCE,
</a><a href="#h93-0-277" id="h93-0-277" class="d">-               &quot;sigColorBackgroundSurface&quot; to 0xFFD3FFCE,
</a><a href="#h93-0-278" id="h93-0-278" class="d">-               &quot;actionSheetBackgroundDrawable&quot; to 0xFFD3FFCE,
</a><a href="#h93-0-279" id="h93-0-279" class="d">-               &quot;sigColorChatChat&quot; to 0xFF000000,
</a><a href="#h93-0-280" id="h93-0-280" class="d">-               &quot;sigColorChatPendingSending&quot; to 0xFF000000,
</a><a href="#h93-0-281" id="h93-0-281" class="d">-               &quot;sigColorChatSnapWithSound&quot; to 0xFF000000,
</a><a href="#h93-0-282" id="h93-0-282" class="d">-               &quot;sigColorChatSnapWithoutSound&quot; to 0xFF000000,
</a><a href="#h93-0-283" id="h93-0-283" class="d">-               &quot;sigExceptionColorCameraGridLines&quot; to 0xFFD3FFCE
</a><a href="#h93-0-284" id="h93-0-284" class="d">-           ),
</a><a href="#h93-0-285" id="h93-0-285" class="d">-           &quot;industrial_chic&quot; to mapOf(
</a><a href="#h93-0-286" id="h93-0-286" class="d">-               &quot;sigColorTextPrimary&quot; to 0xFF424242,
</a><a href="#h93-0-287" id="h93-0-287" class="d">-               &quot;sigColorBackgroundMain&quot; to 0xFFEEEEEE,
</a><a href="#h93-0-288" id="h93-0-288" class="d">-               &quot;sigColorBackgroundSurface&quot; to 0xFFEEEEEE,
</a><a href="#h93-0-289" id="h93-0-289" class="d">-               &quot;actionSheetBackgroundDrawable&quot; to 0xFFEEEEEE,
</a><a href="#h93-0-290" id="h93-0-290" class="d">-               &quot;sigColorChatChat&quot; to 0xFF424242,
</a><a href="#h93-0-291" id="h93-0-291" class="d">-               &quot;sigColorChatPendingSending&quot; to 0xFF424242,
</a><a href="#h93-0-292" id="h93-0-292" class="d">-               &quot;sigColorChatSnapWithSound&quot; to 0xFF424242,
</a><a href="#h93-0-293" id="h93-0-293" class="d">-               &quot;sigColorChatSnapWithoutSound&quot; to 0xFF424242,
</a><a href="#h93-0-294" id="h93-0-294" class="d">-               &quot;sigExceptionColorCameraGridLines&quot; to 0xFFEEEEEE
</a><a href="#h93-0-295" id="h93-0-295" class="d">-           ),
</a><a href="#h93-0-296" id="h93-0-296" class="d">-           &quot;cherry_bomb&quot; to mapOf(
</a><a href="#h93-0-297" id="h93-0-297" class="d">-               &quot;sigColorTextPrimary&quot; to 0xFFFFFFFF,
</a><a href="#h93-0-298" id="h93-0-298" class="d">-               &quot;sigColorBackgroundMain&quot; to 0xFFC24641,
</a><a href="#h93-0-299" id="h93-0-299" class="d">-               &quot;sigColorBackgroundSurface&quot; to 0xFFC24641,
</a><a href="#h93-0-300" id="h93-0-300" class="d">-               &quot;actionSheetBackgroundDrawable&quot; to 0xFFC24641,
</a><a href="#h93-0-301" id="h93-0-301" class="d">-               &quot;sigColorChatChat&quot; to 0xFFFFFFFF,
</a><a href="#h93-0-302" id="h93-0-302" class="d">-               &quot;sigColorChatPendingSending&quot; to 0xFFFFFFFF,
</a><a href="#h93-0-303" id="h93-0-303" class="d">-               &quot;sigColorChatSnapWithSound&quot; to 0xFFFFFFFF,
</a><a href="#h93-0-304" id="h93-0-304" class="d">-               &quot;sigColorChatSnapWithoutSound&quot; to 0xFFFFFFFF,
</a><a href="#h93-0-305" id="h93-0-305" class="d">-               &quot;sigExceptionColorCameraGridLines&quot; to 0xFFC24641
</a><a href="#h93-0-306" id="h93-0-306" class="d">-           ),
</a><a href="#h93-0-307" id="h93-0-307" class="d">-           &quot;woodland_mystery&quot; to mapOf(
</a><a href="#h93-0-308" id="h93-0-308" class="d">-               &quot;sigColorTextPrimary&quot; to 0xFFC2C2F0,
</a><a href="#h93-0-309" id="h93-0-309" class="d">-               &quot;sigColorBackgroundMain&quot; to 0xFF333333,
</a><a href="#h93-0-310" id="h93-0-310" class="d">-               &quot;sigColorBackgroundSurface&quot; to 0xFF333333,
</a><a href="#h93-0-311" id="h93-0-311" class="d">-               &quot;actionSheetBackgroundDrawable&quot; to 0xFF333333,
</a><a href="#h93-0-312" id="h93-0-312" class="d">-               &quot;sigColorChatChat&quot; to 0xFFC2C2F0,
</a><a href="#h93-0-313" id="h93-0-313" class="d">-               &quot;sigColorChatPendingSending&quot; to 0xFFC2C2F0,
</a><a href="#h93-0-314" id="h93-0-314" class="d">-               &quot;sigColorChatSnapWithSound&quot; to 0xFFC2C2F0,
</a><a href="#h93-0-315" id="h93-0-315" class="d">-               &quot;sigColorChatSnapWithoutSound&quot; to 0xFFC2C2F0,
</a><a href="#h93-0-316" id="h93-0-316" class="d">-               &quot;sigExceptionColorCameraGridLines&quot; to 0xFF333333
</a><a href="#h93-0-317" id="h93-0-317" class="d">-           ),
</a><a href="#h93-0-318" id="h93-0-318" class="d">-           &quot;galaxy_glitter&quot; to mapOf(
</a><a href="#h93-0-319" id="h93-0-319" class="d">-               &quot;sigColorTextPrimary&quot; to 0xFFFFFFFF,
</a><a href="#h93-0-320" id="h93-0-320" class="d">-               &quot;sigColorBackgroundMain&quot; to 0xFF2F4F4F,
</a><a href="#h93-0-321" id="h93-0-321" class="d">-               &quot;sigColorBackgroundSurface&quot; to 0xFF2F4F4F,
</a><a href="#h93-0-322" id="h93-0-322" class="d">-               &quot;actionSheetBackgroundDrawable&quot; to 0xFF2F4F4F,
</a><a href="#h93-0-323" id="h93-0-323" class="d">-               &quot;sigColorChatChat&quot; to 0xFFFFFFFF,
</a><a href="#h93-0-324" id="h93-0-324" class="d">-               &quot;sigColorChatPendingSending&quot; to 0xFFFFFFFF,
</a><a href="#h93-0-325" id="h93-0-325" class="d">-               &quot;sigColorChatSnapWithSound&quot; to 0xFFFFFFFF,
</a><a href="#h93-0-326" id="h93-0-326" class="d">-               &quot;sigColorChatSnapWithoutSound&quot; to 0xFFFFFFFF,
</a><a href="#h93-0-327" id="h93-0-327" class="d">-               &quot;sigExceptionColorCameraGridLines&quot; to 0xFF2F4F4F
</a><a href="#h93-0-328" id="h93-0-328" class="d">-           ),
</a><a href="#h93-0-329" id="h93-0-329" class="d">-           &quot;creamy_vanilla&quot; to mapOf(
</a><a href="#h93-0-330" id="h93-0-330" class="d">-               &quot;sigColorTextPrimary&quot; to 0xFF333333,
</a><a href="#h93-0-331" id="h93-0-331" class="d">-               &quot;sigColorBackgroundMain&quot; to 0xFFF1F1F1,
</a><a href="#h93-0-332" id="h93-0-332" class="d">-               &quot;sigColorBackgroundSurface&quot; to 0xFFF1F1F1,
</a><a href="#h93-0-333" id="h93-0-333" class="d">-               &quot;actionSheetBackgroundDrawable&quot; to 0xFFF1F1F1,
</a><a href="#h93-0-334" id="h93-0-334" class="d">-               &quot;sigColorChatChat&quot; to 0xFF333333,
</a><a href="#h93-0-335" id="h93-0-335" class="d">-               &quot;sigColorChatPendingSending&quot; to 0xFF333333,
</a><a href="#h93-0-336" id="h93-0-336" class="d">-               &quot;sigColorChatSnapWithSound&quot; to 0xFF333333,
</a><a href="#h93-0-337" id="h93-0-337" class="d">-               &quot;sigColorChatSnapWithoutSound&quot; to 0xFF333333,
</a><a href="#h93-0-338" id="h93-0-338" class="d">-               &quot;sigExceptionColorCameraGridLines&quot; to 0xFFF1F1F1
</a><a href="#h93-0-339" id="h93-0-339" class="d">-           ),
</a><a href="#h93-0-340" id="h93-0-340" class="d">-           &quot;spicy_chili&quot; to mapOf(
</a><a href="#h93-0-341" id="h93-0-341" class="d">-               &quot;sigColorTextPrimary&quot; to 0xFFF5F5F5,
</a><a href="#h93-0-342" id="h93-0-342" class="d">-               &quot;sigColorBackgroundMain&quot; to 0xFFC70039,
</a><a href="#h93-0-343" id="h93-0-343" class="d">-               &quot;sigColorBackgroundSurface&quot; to 0xFFC70039,
</a><a href="#h93-0-344" id="h93-0-344" class="d">-               &quot;actionSheetBackgroundDrawable&quot; to 0xFFC70039,
</a><a href="#h93-0-345" id="h93-0-345" class="d">-               &quot;sigColorChatChat&quot; to 0xFFF5F5F5,
</a><a href="#h93-0-346" id="h93-0-346" class="d">-               &quot;sigColorChatPendingSending&quot; to 0xFFF5F5F5,
</a><a href="#h93-0-347" id="h93-0-347" class="d">-               &quot;sigColorChatSnapWithSound&quot; to 0xFFF5F5F5,
</a><a href="#h93-0-348" id="h93-0-348" class="d">-               &quot;sigColorChatSnapWithoutSound&quot; to 0xFFF5F5F5,
</a><a href="#h93-0-349" id="h93-0-349" class="d">-               &quot;sigExceptionColorCameraGridLines&quot; to 0xFFC70039
</a><a href="#h93-0-350" id="h93-0-350" class="d">-           ),
</a><a href="#h93-0-351" id="h93-0-351" class="d">-           &quot;spring_meadow&quot; to mapOf(
</a><a href="#h93-0-352" id="h93-0-352" class="d">-               &quot;sigColorTextPrimary&quot; to 0xFF388E3C,
</a><a href="#h93-0-353" id="h93-0-353" class="d">-               &quot;sigColorBackgroundMain&quot; to 0xFFF5FBE0,
</a><a href="#h93-0-354" id="h93-0-354" class="d">-               &quot;sigColorBackgroundSurface&quot; to 0xFFF5FBE0,
</a><a href="#h93-0-355" id="h93-0-355" class="d">-               &quot;actionSheetBackgroundDrawable&quot; to 0xFFF5FBE0,
</a><a href="#h93-0-356" id="h93-0-356" class="d">-               &quot;sigColorChatChat&quot; to 0xFF388E3C,
</a><a href="#h93-0-357" id="h93-0-357" class="d">-               &quot;sigColorChatPendingSending&quot; to 0xFF388E3C,
</a><a href="#h93-0-358" id="h93-0-358" class="d">-               &quot;sigColorChatSnapWithSound&quot; to 0xFF388E3C,
</a><a href="#h93-0-359" id="h93-0-359" class="d">-               &quot;sigColorChatSnapWithoutSound&quot; to 0xFF388E3C,
</a><a href="#h93-0-360" id="h93-0-360" class="d">-               &quot;sigExceptionColorCameraGridLines&quot; to 0xFFF5FBE0
</a><a href="#h93-0-361" id="h93-0-361" class="d">-           ),
</a><a href="#h93-0-362" id="h93-0-362" class="d">-           &quot;midnight_library&quot; to mapOf(
</a><a href="#h93-0-363" id="h93-0-363" class="d">-               &quot;sigColorTextPrimary&quot; to 0xFFEAEAEA,
</a><a href="#h93-0-364" id="h93-0-364" class="d">-               &quot;sigColorBackgroundMain&quot; to 0xFF424242,
</a><a href="#h93-0-365" id="h93-0-365" class="d">-               &quot;sigColorBackgroundSurface&quot; to 0xFF424242,
</a><a href="#h93-0-366" id="h93-0-366" class="d">-               &quot;actionSheetBackgroundDrawable&quot; to 0xFF424242,
</a><a href="#h93-0-367" id="h93-0-367" class="d">-               &quot;sigColorChatChat&quot; to 0xFFEAEAEA,
</a><a href="#h93-0-368" id="h93-0-368" class="d">-               &quot;sigColorChatPendingSending&quot; to 0xFFEAEAEA,
</a><a href="#h93-0-369" id="h93-0-369" class="d">-               &quot;sigColorChatSnapWithSound&quot; to 0xFFEAEAEA,
</a><a href="#h93-0-370" id="h93-0-370" class="d">-               &quot;sigColorChatSnapWithoutSound&quot; to 0xFFEAEAEA,
</a><a href="#h93-0-371" id="h93-0-371" class="d">-               &quot;sigExceptionColorCameraGridLines&quot; to 0xFF424242
</a><a href="#h93-0-372" id="h93-0-372" class="d">-           ),
</a><a href="#h93-0-373" id="h93-0-373" class="d">-           &quot;lemon_sorbet&quot; to mapOf(
</a><a href="#h93-0-374" id="h93-0-374" class="d">-               &quot;sigColorTextPrimary&quot; to 0xFF000000,
</a><a href="#h93-0-375" id="h93-0-375" class="d">-               &quot;sigColorBackgroundMain&quot; to 0xFFFCFFE7,
</a><a href="#h93-0-376" id="h93-0-376" class="d">-               &quot;sigColorBackgroundSurface&quot; to 0xFFFCFFE7,
</a><a href="#h93-0-377" id="h93-0-377" class="d">-               &quot;actionSheetBackgroundDrawable&quot; to 0xFFFCFFE7,
</a><a href="#h93-0-378" id="h93-0-378" class="d">-               &quot;sigColorChatChat&quot; to 0xFF000000,
</a><a href="#h93-0-379" id="h93-0-379" class="d">-               &quot;sigColorChatPendingSending&quot; to 0xFF000000,
</a><a href="#h93-0-380" id="h93-0-380" class="d">-               &quot;sigColorChatSnapWithSound&quot; to 0xFF000000,
</a><a href="#h93-0-381" id="h93-0-381" class="d">-               &quot;sigColorChatSnapWithoutSound&quot; to 0xFF000000,
</a><a href="#h93-0-382" id="h93-0-382" class="d">-               &quot;sigExceptionColorCameraGridLines&quot; to 0xFFFCFFE7
</a><a href="#h93-0-383" id="h93-0-383" class="d">-           ),
</a><a href="#h93-0-384" id="h93-0-384" class="d">-           &quot;cosmic_night&quot; to mapOf(
</a><a href="#h93-0-385" id="h93-0-385" class="d">-               &quot;sigColorTextPrimary&quot; to 0xFFFFFFFF,
</a><a href="#h93-0-386" id="h93-0-386" class="d">-               &quot;sigColorBackgroundMain&quot; to 0xFF2F4F4F,
</a><a href="#h93-0-387" id="h93-0-387" class="d">-               &quot;sigColorBackgroundSurface&quot; to 0xFF2F4F4F,
</a><a href="#h93-0-388" id="h93-0-388" class="d">-               &quot;actionSheetBackgroundDrawable&quot; to 0xFF2F4F4F,
</a><a href="#h93-0-389" id="h93-0-389" class="d">-               &quot;sigColorChatChat&quot; to 0xFFFFFFFF,
</a><a href="#h93-0-390" id="h93-0-390" class="d">-               &quot;sigColorChatPendingSending&quot; to 0xFFFFFFFF,
</a><a href="#h93-0-391" id="h93-0-391" class="d">-               &quot;sigColorChatSnapWithSound&quot; to 0xFFFFFFFF,
</a><a href="#h93-0-392" id="h93-0-392" class="d">-               &quot;sigColorChatSnapWithoutSound&quot; to 0xFFFFFFFF,
</a><a href="#h93-0-393" id="h93-0-393" class="d">-               &quot;sigExceptionColorCameraGridLines&quot; to 0xFF2F4F4F
</a><a href="#h93-0-394" id="h93-0-394" class="d">-           ),
</a><a href="#h93-0-395" id="h93-0-395" class="d">-           &quot;spicy_mustard&quot; to mapOf(
</a><a href="#h93-0-396" id="h93-0-396" class="d">-               &quot;sigColorTextPrimary&quot; to 0xFFFFFFFF,
</a><a href="#h93-0-397" id="h93-0-397" class="d">-               &quot;sigColorBackgroundMain&quot; to 0xFFFCC01E,
</a><a href="#h93-0-398" id="h93-0-398" class="d">-               &quot;sigColorBackgroundSurface&quot; to 0xFFFCC01E,
</a><a href="#h93-0-399" id="h93-0-399" class="d">-               &quot;actionSheetBackgroundDrawable&quot; to 0xFFFCC01E,
</a><a href="#h93-0-400" id="h93-0-400" class="d">-               &quot;sigColorChatChat&quot; to 0xFFFFFFFF,
</a><a href="#h93-0-401" id="h93-0-401" class="d">-               &quot;sigColorChatPendingSending&quot; to 0xFFFFFFFF,
</a><a href="#h93-0-402" id="h93-0-402" class="d">-               &quot;sigColorChatSnapWithSound&quot; to 0xFFFFFFFF,
</a><a href="#h93-0-403" id="h93-0-403" class="d">-               &quot;sigColorChatSnapWithoutSound&quot; to 0xFFFFFFFF,
</a><a href="#h93-0-404" id="h93-0-404" class="d">-               &quot;sigExceptionColorCameraGridLines&quot; to 0xFFFCC01E
</a><a href="#h93-0-405" id="h93-0-405" class="d">-           ),
</a><a href="#h93-0-406" id="h93-0-406" class="d">-           &quot;peppermint_candy&quot; to mapOf(
</a><a href="#h93-0-407" id="h93-0-407" class="d">-               &quot;sigColorTextPrimary&quot; to 0xFF29ABCA,
</a><a href="#h93-0-408" id="h93-0-408" class="d">-               &quot;sigColorBackgroundMain&quot; to 0xFFFFDDCF,
</a><a href="#h93-0-409" id="h93-0-409" class="d">-               &quot;sigColorBackgroundSurface&quot; to 0xFFFFDDCF,
</a><a href="#h93-0-410" id="h93-0-410" class="d">-               &quot;actionSheetBackgroundDrawable&quot; to 0xFFFFDDCF,
</a><a href="#h93-0-411" id="h93-0-411" class="d">-               &quot;sigColorChatChat&quot; to 0xFF29ABCA,
</a><a href="#h93-0-412" id="h93-0-412" class="d">-               &quot;sigColorChatPendingSending&quot; to 0xFF29ABCA,
</a><a href="#h93-0-413" id="h93-0-413" class="d">-               &quot;sigColorChatSnapWithSound&quot; to 0xFF29ABCA,
</a><a href="#h93-0-414" id="h93-0-414" class="d">-               &quot;sigColorChatSnapWithoutSound&quot; to 0xFF29ABCA,
</a><a href="#h93-0-415" id="h93-0-415" class="d">-               &quot;sigExceptionColorCameraGridLines&quot; to 0xFFFFDDCF
</a><a href="#h93-0-416" id="h93-0-416" class="d">-           ),
</a><a href="#h93-0-417" id="h93-0-417" class="d">-           &quot;gingerbread_house&quot; to mapOf(
</a><a href="#h93-0-418" id="h93-0-418" class="d">-               &quot;sigColorTextPrimary&quot; to 0xFF333333,
</a><a href="#h93-0-419" id="h93-0-419" class="d">-               &quot;sigColorBackgroundMain&quot; to 0xFFCDB391,
</a><a href="#h93-0-420" id="h93-0-420" class="d">-               &quot;sigColorBackgroundSurface&quot; to 0xFFCDB391,
</a><a href="#h93-0-421" id="h93-0-421" class="d">-               &quot;actionSheetBackgroundDrawable&quot; to 0xFFCDB391,
</a><a href="#h93-0-422" id="h93-0-422" class="d">-               &quot;sigColorChatChat&quot; to 0xFF333333,
</a><a href="#h93-0-423" id="h93-0-423" class="d">-               &quot;sigColorChatPendingSending&quot; to 0xFF333333,
</a><a href="#h93-0-424" id="h93-0-424" class="d">-               &quot;sigColorChatSnapWithSound&quot; to 0xFF333333,
</a><a href="#h93-0-425" id="h93-0-425" class="d">-               &quot;sigColorChatSnapWithoutSound&quot; to 0xFF333333,
</a><a href="#h93-0-426" id="h93-0-426" class="d">-               &quot;sigExceptionColorCameraGridLines&quot; to 0xFFCDB391
</a><a href="#h93-0-427" id="h93-0-427" class="d">-           ),
</a><a href="#h93-0-428" id="h93-0-428" class="d">-           &quot;art_deco_glam&quot; to mapOf(
</a><a href="#h93-0-429" id="h93-0-429" class="d">-               &quot;sigColorTextPrimary&quot; to 0xFF000000,
</a><a href="#h93-0-430" id="h93-0-430" class="d">-               &quot;sigColorBackgroundMain&quot; to 0xFFF8F8F8,
</a><a href="#h93-0-431" id="h93-0-431" class="d">-               &quot;sigColorBackgroundSurface&quot; to 0xFFF8F8F8,
</a><a href="#h93-0-432" id="h93-0-432" class="d">-               &quot;actionSheetBackgroundDrawable&quot; to 0xFFF8F8F8,
</a><a href="#h93-0-433" id="h93-0-433" class="d">-               &quot;sigColorChatChat&quot; to 0xFF000000,
</a><a href="#h93-0-434" id="h93-0-434" class="d">-               &quot;sigColorChatPendingSending&quot; to 0xFF000000,
</a><a href="#h93-0-435" id="h93-0-435" class="d">-               &quot;sigColorChatSnapWithSound&quot; to 0xFF000000,
</a><a href="#h93-0-436" id="h93-0-436" class="d">-               &quot;sigColorChatSnapWithoutSound&quot; to 0xFF000000,
</a><a href="#h93-0-437" id="h93-0-437" class="d">-               &quot;sigExceptionColorCameraGridLines&quot; to 0xFFF8F8F8
</a><a href="#h93-0-438" id="h93-0-438" class="d">-           ),
</a><a href="#h93-0-439" id="h93-0-439" class="d">-           &quot;ocean_depths&quot; to mapOf(
</a><a href="#h93-0-440" id="h93-0-440" class="d">-               &quot;sigColorTextPrimary&quot; to 0xFFFFFFFF,
</a><a href="#h93-0-441" id="h93-0-441" class="d">-               &quot;sigColorBackgroundMain&quot; to 0xFF000080,
</a><a href="#h93-0-442" id="h93-0-442" class="d">-               &quot;sigColorBackgroundSurface&quot; to 0xFF000080,
</a><a href="#h93-0-443" id="h93-0-443" class="d">-               &quot;actionSheetBackgroundDrawable&quot; to 0xFF000080,
</a><a href="#h93-0-444" id="h93-0-444" class="d">-               &quot;sigColorChatChat&quot; to 0xFFFFFFFF,
</a><a href="#h93-0-445" id="h93-0-445" class="d">-               &quot;sigColorChatPendingSending&quot; to 0xFFFFFFFF,
</a><a href="#h93-0-446" id="h93-0-446" class="d">-               &quot;sigColorChatSnapWithSound&quot; to 0xFFFFFFFF,
</a><a href="#h93-0-447" id="h93-0-447" class="d">-               &quot;sigColorChatSnapWithoutSound&quot; to 0xFFFFFFFF,
</a><a href="#h93-0-448" id="h93-0-448" class="d">-               &quot;sigExceptionColorCameraGridLines&quot; to 0xFF000080
</a><a href="#h93-0-449" id="h93-0-449" class="d">-           ),
</a><a href="#h93-0-450" id="h93-0-450" class="d">-           &quot;bubblegum_pink&quot; to mapOf(
</a><a href="#h93-0-451" id="h93-0-451" class="d">-               &quot;sigColorTextPrimary&quot; to 0xFFFFFFFF,
</a><a href="#h93-0-452" id="h93-0-452" class="d">-               &quot;sigColorBackgroundMain&quot; to 0xFFFFC0CB,
</a><a href="#h93-0-453" id="h93-0-453" class="d">-               &quot;sigColorBackgroundSurface&quot; to 0xFFFFC0CB,
</a><a href="#h93-0-454" id="h93-0-454" class="d">-               &quot;actionSheetBackgroundDrawable&quot; to 0xFFFFC0CB,
</a><a href="#h93-0-455" id="h93-0-455" class="d">-               &quot;sigColorChatChat&quot; to 0xFFFFFFFF,
</a><a href="#h93-0-456" id="h93-0-456" class="d">-               &quot;sigColorChatPendingSending&quot; to 0xFFFFFFFF,
</a><a href="#h93-0-457" id="h93-0-457" class="d">-               &quot;sigColorChatSnapWithSound&quot; to 0xFFFFFFFF,
</a><a href="#h93-0-458" id="h93-0-458" class="d">-               &quot;sigColorChatSnapWithoutSound&quot; to 0xFFFFFFFF,
</a><a href="#h93-0-459" id="h93-0-459" class="d">-               &quot;sigExceptionColorCameraGridLines&quot; to 0xFFFFC0CB
</a><a href="#h93-0-460" id="h93-0-460" class="d">-           ),
</a><a href="#h93-0-461" id="h93-0-461" class="d">-           &quot;firefly_night&quot; to mapOf(
</a><a href="#h93-0-462" id="h93-0-462" class="d">-               &quot;sigColorTextPrimary&quot; to 0xFFFFFFF0,
</a><a href="#h93-0-463" id="h93-0-463" class="d">-               &quot;sigColorBackgroundMain&quot; to 0xFF222222,
</a><a href="#h93-0-464" id="h93-0-464" class="d">-               &quot;sigColorBackgroundSurface&quot; to 0xFF222222,
</a><a href="#h93-0-465" id="h93-0-465" class="d">-               &quot;actionSheetBackgroundDrawable&quot; to 0xFF222222,
</a><a href="#h93-0-466" id="h93-0-466" class="d">-               &quot;sigColorChatChat&quot; to 0xFFFFFFF0,
</a><a href="#h93-0-467" id="h93-0-467" class="d">-               &quot;sigColorChatPendingSending&quot; to 0xFFFFFFF0,
</a><a href="#h93-0-468" id="h93-0-468" class="d">-               &quot;sigColorChatSnapWithSound&quot; to 0xFFFFFFF0,
</a><a href="#h93-0-469" id="h93-0-469" class="d">-               &quot;sigColorChatSnapWithoutSound&quot; to 0xFFFFFFF0,
</a><a href="#h93-0-470" id="h93-0-470" class="d">-               &quot;sigExceptionColorCameraGridLines&quot; to 0xFF222222
</a><a href="#h93-0-471" id="h93-0-471" class="d">-           ),
</a><a href="#h93-0-472" id="h93-0-472" class="d">-           &quot;apple_orchard&quot; to mapOf(
</a><a href="#h93-0-473" id="h93-0-473" class="d">-               &quot;sigColorTextPrimary&quot; to 0xFF333333,
</a><a href="#h93-0-474" id="h93-0-474" class="d">-               &quot;sigColorBackgroundMain&quot; to 0xFFF4D35E,
</a><a href="#h93-0-475" id="h93-0-475" class="d">-               &quot;sigColorBackgroundSurface&quot; to 0xFFF4D35E,
</a><a href="#h93-0-476" id="h93-0-476" class="d">-               &quot;actionSheetBackgroundDrawable&quot; to 0xFFF4D35E,
</a><a href="#h93-0-477" id="h93-0-477" class="d">-               &quot;sigColorChatChat&quot; to 0xFF333333,
</a><a href="#h93-0-478" id="h93-0-478" class="d">-               &quot;sigColorChatPendingSending&quot; to 0xFF333333,
</a><a href="#h93-0-479" id="h93-0-479" class="d">-               &quot;sigColorChatSnapWithSound&quot; to 0xFF333333,
</a><a href="#h93-0-480" id="h93-0-480" class="d">-               &quot;sigColorChatSnapWithoutSound&quot; to 0xFF333333,
</a><a href="#h93-0-481" id="h93-0-481" class="d">-               &quot;sigExceptionColorCameraGridLines&quot; to 0xFFF4D35E
</a><a href="#h93-0-482" id="h93-0-482" class="d">-           ),
</a><a href="#h93-0-483" id="h93-0-483" class="d">-           &quot;lavender_field&quot; to mapOf(
</a><a href="#h93-0-484" id="h93-0-484" class="d">-               &quot;sigColorTextPrimary&quot; to 0xFF293145,
</a><a href="#h93-0-485" id="h93-0-485" class="d">-               &quot;sigColorBackgroundMain&quot; to 0xFFBDBDBD,
</a><a href="#h93-0-486" id="h93-0-486" class="d">-               &quot;sigColorBackgroundSurface&quot; to 0xFFBDBDBD,
</a><a href="#h93-0-487" id="h93-0-487" class="d">-               &quot;actionSheetBackgroundDrawable&quot; to 0xFFBDBDBD,
</a><a href="#h93-0-488" id="h93-0-488" class="d">-               &quot;sigColorChatChat&quot; to 0xFF293145,
</a><a href="#h93-0-489" id="h93-0-489" class="d">-               &quot;sigColorChatPendingSending&quot; to 0xFF293145,
</a><a href="#h93-0-490" id="h93-0-490" class="d">-               &quot;sigColorChatSnapWithSound&quot; to 0xFF293145,
</a><a href="#h93-0-491" id="h93-0-491" class="d">-               &quot;sigColorChatSnapWithoutSound&quot; to 0xFF293145,
</a><a href="#h93-0-492" id="h93-0-492" class="d">-               &quot;sigExceptionColorCameraGridLines&quot; to 0xFFBDBDBD
</a><a href="#h93-0-493" id="h93-0-493" class="d">-           ),
</a><a href="#h93-0-494" id="h93-0-494" class="d">-           &quot;lemon_drop&quot; to mapOf(
</a><a href="#h93-0-495" id="h93-0-495" class="d">-               &quot;sigColorTextPrimary&quot; to 0xFF000000,
</a><a href="#h93-0-496" id="h93-0-496" class="d">-               &quot;sigColorBackgroundMain&quot; to 0xFFFCE5C7,
</a><a href="#h93-0-497" id="h93-0-497" class="d">-               &quot;sigColorBackgroundSurface&quot; to 0xFFFCE5C7,
</a><a href="#h93-0-498" id="h93-0-498" class="d">-               &quot;actionSheetBackgroundDrawable&quot; to 0xFFFCE5C7,
</a><a href="#h93-0-499" id="h93-0-499" class="d">-               &quot;sigColorChatChat&quot; to 0xFF000000,
</a><a href="#h93-0-500" id="h93-0-500" class="d">-               &quot;sigColorChatPendingSending&quot; to 0xFF000000,
</a><a href="#h93-0-501" id="h93-0-501" class="d">-               &quot;sigColorChatSnapWithSound&quot; to 0xFF000000,
</a><a href="#h93-0-502" id="h93-0-502" class="d">-               &quot;sigColorChatSnapWithoutSound&quot; to 0xFF000000,
</a><a href="#h93-0-503" id="h93-0-503" class="d">-               &quot;sigExceptionColorCameraGridLines&quot; to 0xFFFCE5C7
</a><a href="#h93-0-504" id="h93-0-504" class="d">-           ),
</a><a href="#h93-0-505" id="h93-0-505" class="d">-           &quot;modern_farmhouse&quot; to mapOf(
</a><a href="#h93-0-506" id="h93-0-506" class="d">-               &quot;sigColorTextPrimary&quot; to 0xFF333333,
</a><a href="#h93-0-507" id="h93-0-507" class="d">-               &quot;sigColorBackgroundMain&quot; to 0xFFF2F2F2,
</a><a href="#h93-0-508" id="h93-0-508" class="d">-               &quot;sigColorBackgroundSurface&quot; to 0xFFF2F2F2,
</a><a href="#h93-0-509" id="h93-0-509" class="d">-               &quot;actionSheetBackgroundDrawable&quot; to 0xFFF2F2F2,
</a><a href="#h93-0-510" id="h93-0-510" class="d">-               &quot;sigColorChatChat&quot; to 0xFF333333,
</a><a href="#h93-0-511" id="h93-0-511" class="d">-               &quot;sigColorChatPendingSending&quot; to 0xFF333333,
</a><a href="#h93-0-512" id="h93-0-512" class="d">-               &quot;sigColorChatSnapWithSound&quot; to 0xFF333333,
</a><a href="#h93-0-513" id="h93-0-513" class="d">-               &quot;sigColorChatSnapWithoutSound&quot; to 0xFF333333,
</a><a href="#h93-0-514" id="h93-0-514" class="d">-               &quot;sigExceptionColorCameraGridLines&quot; to 0xFFF2F2F2
</a><a href="#h93-0-515" id="h93-0-515" class="d">-           ),
</a><a href="#h93-0-516" id="h93-0-516" class="d">-       ).mapValues { (_, attributes) -&gt;
</a><a href="#h93-0-517" id="h93-0-517" class="d">-            attributes.map { (key, value) -&gt;
</a><a href="#h93-0-518" id="h93-0-518" class="d">-                getAttribute(key) to value as Any
</a><a href="#h93-0-519" id="h93-0-519" class="d">-            }.toMap()
</a><a href="#h93-0-520" id="h93-0-520" class="d">-        }.toMutableMap()
</a><a href="#h93-0-521" id="h93-0-521" class="d">-    }
</a><a href="#h93-0-522" id="h93-0-522" class="d">-}
</a><b>diff --git a/<a id="h94" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/ui/DefaultVolumeControls.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/ui/DefaultVolumeControls.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/ui/DefaultVolumeControls.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/ui/DefaultVolumeControls.kt</a></b>
<a href="#h94-0" id="h94-0" class="h">@@ -2,17 +2,18 @@ package me.rhunk.snapenhance.core.features.impl.ui
</a> 
 import android.view.KeyEvent
 import me.rhunk.snapenhance.core.features.Feature
<a href="#h94-0-3" id="h94-0-3" class="d">-import me.rhunk.snapenhance.core.features.FeatureLoadParams
</a> import me.rhunk.snapenhance.core.util.hook.HookStage
 import me.rhunk.snapenhance.core.util.hook.hook
 
<a href="#h94-0-7" id="h94-0-7" class="d">-class DefaultVolumeControls : Feature(&quot;Default Volume Controls&quot;, loadParams = FeatureLoadParams.ACTIVITY_CREATE_SYNC) {
</a><a href="#h94-0-8" id="h94-0-8" class="d">-    override fun onActivityCreate() {
</a><a href="#h94-0-9" id="h94-0-9" class="i">+class DefaultVolumeControls : Feature(&quot;Default Volume Controls&quot;) {
</a><a href="#h94-0-10" id="h94-0-10" class="i">+    override fun init() {
</a>         if (!context.config.global.defaultVolumeControls.get()) return
<a href="#h94-0-12" id="h94-0-12" class="d">-        context.mainActivity!!::class.java.hook(&quot;onKeyDown&quot;, HookStage.BEFORE) { param -&gt;
</a><a href="#h94-0-13" id="h94-0-13" class="d">-            val keyCode = param.arg&lt;Int&gt;(0)
</a><a href="#h94-0-14" id="h94-0-14" class="d">-            if (keyCode == KeyEvent.KEYCODE_VOLUME_DOWN || keyCode == KeyEvent.KEYCODE_VOLUME_UP) {
</a><a href="#h94-0-15" id="h94-0-15" class="d">-                param.setResult(false)
</a><a href="#h94-0-16" id="h94-0-16" class="i">+        onNextActivityCreate { activity -&gt;
</a><a href="#h94-0-17" id="h94-0-17" class="i">+            activity::class.java.hook(&quot;onKeyDown&quot;, HookStage.BEFORE) { param -&gt;
</a><a href="#h94-0-18" id="h94-0-18" class="i">+                val keyCode = param.arg&lt;Int&gt;(0)
</a><a href="#h94-0-19" id="h94-0-19" class="i">+                if (keyCode == KeyEvent.KEYCODE_VOLUME_DOWN || keyCode == KeyEvent.KEYCODE_VOLUME_UP) {
</a><a href="#h94-0-20" id="h94-0-20" class="i">+                    param.setResult(false)
</a><a href="#h94-0-21" id="h94-0-21" class="i">+                }
</a>             }
         }
     }
<b>diff --git a/<a id="h95" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/ui/DisableConfirmationDialogs.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/ui/DisableConfirmationDialogs.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/ui/DisableConfirmationDialogs.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/ui/DisableConfirmationDialogs.kt</a></b>
<a href="#h95-0" id="h95-0" class="h">@@ -4,59 +4,60 @@ import android.view.View
</a> import android.widget.TextView
 import me.rhunk.snapenhance.core.event.events.impl.AddViewEvent
 import me.rhunk.snapenhance.core.features.Feature
<a href="#h95-0-3" id="h95-0-3" class="d">-import me.rhunk.snapenhance.core.features.FeatureLoadParams
</a> import me.rhunk.snapenhance.core.ui.children
 import me.rhunk.snapenhance.core.ui.triggerRootCloseTouchEvent
 import me.rhunk.snapenhance.core.util.ktx.getId
 import me.rhunk.snapenhance.core.util.ktx.getIdentifier
 import java.util.regex.Pattern
 
<a href="#h95-0-10" id="h95-0-10" class="d">-class DisableConfirmationDialogs : Feature(&quot;Disable Confirmation Dialogs&quot;, loadParams = FeatureLoadParams.ACTIVITY_CREATE_SYNC) {
</a><a href="#h95-0-11" id="h95-0-11" class="d">-    override fun onActivityCreate() {
</a><a href="#h95-0-12" id="h95-0-12" class="d">-        val disableConfirmationDialogs = context.config.global.disableConfirmationDialogs.get().takeIf { it.isNotEmpty() } ?: return
</a><a href="#h95-0-13" id="h95-0-13" class="d">-        val dialogContent = context.resources.getId(&quot;dialog_content&quot;)
</a><a href="#h95-0-14" id="h95-0-14" class="d">-        val alertDialogTitle = context.resources.getId(&quot;alert_dialog_title&quot;)
</a><a href="#h95-0-15" id="h95-0-15" class="i">+class DisableConfirmationDialogs : Feature(&quot;Disable Confirmation Dialogs&quot;) {
</a><a href="#h95-0-16" id="h95-0-16" class="i">+    override fun init() {
</a><a href="#h95-0-17" id="h95-0-17" class="i">+        onNextActivityCreate {
</a><a href="#h95-0-18" id="h95-0-18" class="i">+            val disableConfirmationDialogs = context.config.global.disableConfirmationDialogs.get().takeIf { it.isNotEmpty() } ?: return@onNextActivityCreate
</a><a href="#h95-0-19" id="h95-0-19" class="i">+            val dialogContent = context.resources.getId(&quot;dialog_content&quot;)
</a><a href="#h95-0-20" id="h95-0-20" class="i">+            val alertDialogTitle = context.resources.getId(&quot;alert_dialog_title&quot;)
</a> 
<a href="#h95-0-22" id="h95-0-22" class="d">-        val questions = listOf(
</a><a href="#h95-0-23" id="h95-0-23" class="d">-            &quot;erase_message&quot; to &quot;erase_learn_more_dialog_title&quot;,
</a><a href="#h95-0-24" id="h95-0-24" class="d">-            &quot;erase_message&quot; to &quot;erase_dialog_title&quot;,
</a><a href="#h95-0-25" id="h95-0-25" class="d">-            &quot;erase_message&quot; to &quot;snap_erase_dialog_title&quot;,
</a><a href="#h95-0-26" id="h95-0-26" class="d">-            &quot;erase_message&quot; to &quot;snap_erase_learn_more_dialog_title&quot;,
</a><a href="#h95-0-27" id="h95-0-27" class="d">-            &quot;remove_friend&quot; to &quot;action_menu_remove_friend_question&quot;,
</a><a href="#h95-0-28" id="h95-0-28" class="d">-            &quot;block_friend&quot; to &quot;action_menu_block_friend_question&quot;,
</a><a href="#h95-0-29" id="h95-0-29" class="d">-            &quot;ignore_friend&quot; to &quot;action_menu_ignore_friend_question&quot;,
</a><a href="#h95-0-30" id="h95-0-30" class="d">-            &quot;hide_friend&quot; to &quot;action_menu_hide_friend_question&quot;,
</a><a href="#h95-0-31" id="h95-0-31" class="d">-            &quot;hide_conversation&quot; to &quot;hide_or_block_clear_conversation_dialog_title&quot;,
</a><a href="#h95-0-32" id="h95-0-32" class="d">-            &quot;clear_conversation&quot; to &quot;action_menu_clear_conversation_dialog_title&quot;
</a><a href="#h95-0-33" id="h95-0-33" class="d">-        ).map { pair -&gt;
</a><a href="#h95-0-34" id="h95-0-34" class="d">-            pair.first to runCatching {
</a><a href="#h95-0-35" id="h95-0-35" class="d">-                Pattern.compile(
</a><a href="#h95-0-36" id="h95-0-36" class="d">-                    context.resources.getString(context.resources.getIdentifier(pair.second, &quot;string&quot;))
</a><a href="#h95-0-37" id="h95-0-37" class="d">-                        .split(&quot;%s&quot;).joinToString(&quot;.*&quot;) {
</a><a href="#h95-0-38" id="h95-0-38" class="d">-                            Pattern.quote(it)
</a><a href="#h95-0-39" id="h95-0-39" class="d">-                        }, Pattern.CASE_INSENSITIVE)
</a><a href="#h95-0-40" id="h95-0-40" class="d">-            }.onFailure {
</a><a href="#h95-0-41" id="h95-0-41" class="d">-                context.log.error(&quot;Failed to compile regex for ${pair.second}&quot;, it)
</a><a href="#h95-0-42" id="h95-0-42" class="d">-            }.getOrNull()
</a><a href="#h95-0-43" id="h95-0-43" class="d">-        }
</a><a href="#h95-0-44" id="h95-0-44" class="i">+            val questions = listOf(
</a><a href="#h95-0-45" id="h95-0-45" class="i">+                &quot;erase_message&quot; to &quot;erase_learn_more_dialog_title&quot;,
</a><a href="#h95-0-46" id="h95-0-46" class="i">+                &quot;erase_message&quot; to &quot;erase_dialog_title&quot;,
</a><a href="#h95-0-47" id="h95-0-47" class="i">+                &quot;erase_message&quot; to &quot;snap_erase_dialog_title&quot;,
</a><a href="#h95-0-48" id="h95-0-48" class="i">+                &quot;erase_message&quot; to &quot;snap_erase_learn_more_dialog_title&quot;,
</a><a href="#h95-0-49" id="h95-0-49" class="i">+                &quot;remove_friend&quot; to &quot;action_menu_remove_friend_question&quot;,
</a><a href="#h95-0-50" id="h95-0-50" class="i">+                &quot;block_friend&quot; to &quot;action_menu_block_friend_question&quot;,
</a><a href="#h95-0-51" id="h95-0-51" class="i">+                &quot;ignore_friend&quot; to &quot;action_menu_ignore_friend_question&quot;,
</a><a href="#h95-0-52" id="h95-0-52" class="i">+                &quot;hide_friend&quot; to &quot;action_menu_hide_friend_question&quot;,
</a><a href="#h95-0-53" id="h95-0-53" class="i">+                &quot;hide_conversation&quot; to &quot;hide_or_block_clear_conversation_dialog_title&quot;,
</a><a href="#h95-0-54" id="h95-0-54" class="i">+                &quot;clear_conversation&quot; to &quot;action_menu_clear_conversation_dialog_title&quot;
</a><a href="#h95-0-55" id="h95-0-55" class="i">+            ).map { pair -&gt;
</a><a href="#h95-0-56" id="h95-0-56" class="i">+                pair.first to runCatching {
</a><a href="#h95-0-57" id="h95-0-57" class="i">+                    Pattern.compile(
</a><a href="#h95-0-58" id="h95-0-58" class="i">+                        context.resources.getString(context.resources.getIdentifier(pair.second, &quot;string&quot;))
</a><a href="#h95-0-59" id="h95-0-59" class="i">+                            .split(&quot;%s&quot;).joinToString(&quot;.*&quot;) {
</a><a href="#h95-0-60" id="h95-0-60" class="i">+                                Pattern.quote(it)
</a><a href="#h95-0-61" id="h95-0-61" class="i">+                            }, Pattern.CASE_INSENSITIVE)
</a><a href="#h95-0-62" id="h95-0-62" class="i">+                }.onFailure {
</a><a href="#h95-0-63" id="h95-0-63" class="i">+                    context.log.error(&quot;Failed to compile regex for ${pair.second}&quot;, it)
</a><a href="#h95-0-64" id="h95-0-64" class="i">+                }.getOrNull()
</a><a href="#h95-0-65" id="h95-0-65" class="i">+            }
</a> 
<a href="#h95-0-67" id="h95-0-67" class="d">-        context.event.subscribe(AddViewEvent::class) { event -&gt;
</a><a href="#h95-0-68" id="h95-0-68" class="d">-            if (event.parent.id != dialogContent || !event.view::class.java.name.endsWith(&quot;SnapButtonView&quot;)) return@subscribe
</a><a href="#h95-0-69" id="h95-0-69" class="i">+            context.event.subscribe(AddViewEvent::class) { event -&gt;
</a><a href="#h95-0-70" id="h95-0-70" class="i">+                if (event.parent.id != dialogContent || !event.view::class.java.name.endsWith(&quot;SnapButtonView&quot;)) return@subscribe
</a> 
<a href="#h95-0-72" id="h95-0-72" class="d">-            val dialogTitle = event.parent.findViewById&lt;TextView&gt;(alertDialogTitle)?.text?.toString() ?: return@subscribe
</a><a href="#h95-0-73" id="h95-0-73" class="d">-            if (event.parent.children().count { it::class.java.name.endsWith(&quot;SnapButtonView&quot;) } != 0) return@subscribe
</a><a href="#h95-0-74" id="h95-0-74" class="i">+                val dialogTitle = event.parent.findViewById&lt;TextView&gt;(alertDialogTitle)?.text?.toString() ?: return@subscribe
</a><a href="#h95-0-75" id="h95-0-75" class="i">+                if (event.parent.children().count { it::class.java.name.endsWith(&quot;SnapButtonView&quot;) } != 0) return@subscribe
</a> 
<a href="#h95-0-77" id="h95-0-77" class="d">-            questions.forEach { (key, value) -&gt;
</a><a href="#h95-0-78" id="h95-0-78" class="d">-                if (!disableConfirmationDialogs.contains(key)) return@forEach
</a><a href="#h95-0-79" id="h95-0-79" class="i">+                questions.forEach { (key, value) -&gt;
</a><a href="#h95-0-80" id="h95-0-80" class="i">+                    if (!disableConfirmationDialogs.contains(key)) return@forEach
</a> 
<a href="#h95-0-82" id="h95-0-82" class="d">-                if (value?.matcher(dialogTitle)?.matches() == true) {
</a><a href="#h95-0-83" id="h95-0-83" class="d">-                    event.parent.visibility = View.INVISIBLE
</a><a href="#h95-0-84" id="h95-0-84" class="d">-                    event.parent.post {
</a><a href="#h95-0-85" id="h95-0-85" class="d">-                        event.view.callOnClick()
</a><a href="#h95-0-86" id="h95-0-86" class="i">+                    if (value?.matcher(dialogTitle)?.matches() == true) {
</a><a href="#h95-0-87" id="h95-0-87" class="i">+                        event.parent.visibility = View.INVISIBLE
</a><a href="#h95-0-88" id="h95-0-88" class="i">+                        event.parent.post {
</a><a href="#h95-0-89" id="h95-0-89" class="i">+                            event.view.callOnClick()
</a><a href="#h95-0-90" id="h95-0-90" class="i">+                        }
</a><a href="#h95-0-91" id="h95-0-91" class="i">+                        event.parent.postDelayed({
</a><a href="#h95-0-92" id="h95-0-92" class="i">+                            context.mainActivity!!.triggerRootCloseTouchEvent()
</a><a href="#h95-0-93" id="h95-0-93" class="i">+                        }, 400)
</a>                     }
<a href="#h95-0-95" id="h95-0-95" class="d">-                    event.parent.postDelayed({
</a><a href="#h95-0-96" id="h95-0-96" class="d">-                        context.mainActivity!!.triggerRootCloseTouchEvent()
</a><a href="#h95-0-97" id="h95-0-97" class="d">-                    }, 400)
</a>                 }
             }
         }
<b>diff --git a/<a id="h96" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/ui/EditTextOverride.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/ui/EditTextOverride.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/ui/EditTextOverride.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/ui/EditTextOverride.kt</a></b>
<a href="#h96-0" id="h96-0" class="h">@@ -5,30 +5,31 @@ import android.text.InputType
</a> import android.widget.EditText
 import android.widget.TextView
 import me.rhunk.snapenhance.core.features.Feature
<a href="#h96-0-3" id="h96-0-3" class="d">-import me.rhunk.snapenhance.core.features.FeatureLoadParams
</a> import me.rhunk.snapenhance.core.util.hook.HookStage
 import me.rhunk.snapenhance.core.util.hook.hook
 import me.rhunk.snapenhance.core.util.hook.hookConstructor
 
<a href="#h96-0-8" id="h96-0-8" class="d">-class EditTextOverride : Feature(&quot;Edit Text Override&quot;, loadParams = FeatureLoadParams.ACTIVITY_CREATE_SYNC) {
</a><a href="#h96-0-9" id="h96-0-9" class="d">-    override fun onActivityCreate() {
</a><a href="#h96-0-10" id="h96-0-10" class="i">+class EditTextOverride : Feature(&quot;Edit Text Override&quot;) {
</a><a href="#h96-0-11" id="h96-0-11" class="i">+    override fun init() {
</a>         val editTextOverride by context.config.userInterface.editTextOverride
         if (editTextOverride.isEmpty()) return
 
<a href="#h96-0-15" id="h96-0-15" class="d">-        if (editTextOverride.contains(&quot;bypass_text_input_limit&quot;)) {
</a><a href="#h96-0-16" id="h96-0-16" class="d">-            TextView::class.java.getMethod(&quot;setFilters&quot;, Array&lt;InputFilter&gt;::class.java)
</a><a href="#h96-0-17" id="h96-0-17" class="d">-                .hook(HookStage.BEFORE) { param -&gt;
</a><a href="#h96-0-18" id="h96-0-18" class="d">-                    param.setArg(0, param.arg&lt;Array&lt;InputFilter&gt;&gt;(0).filter {
</a><a href="#h96-0-19" id="h96-0-19" class="d">-                        it !is InputFilter.LengthFilter
</a><a href="#h96-0-20" id="h96-0-20" class="d">-                    }.toTypedArray())
</a><a href="#h96-0-21" id="h96-0-21" class="d">-                }
</a><a href="#h96-0-22" id="h96-0-22" class="d">-        }
</a><a href="#h96-0-23" id="h96-0-23" class="i">+        onNextActivityCreate {
</a><a href="#h96-0-24" id="h96-0-24" class="i">+            if (editTextOverride.contains(&quot;bypass_text_input_limit&quot;)) {
</a><a href="#h96-0-25" id="h96-0-25" class="i">+                TextView::class.java.getMethod(&quot;setFilters&quot;, Array&lt;InputFilter&gt;::class.java)
</a><a href="#h96-0-26" id="h96-0-26" class="i">+                    .hook(HookStage.BEFORE) { param -&gt;
</a><a href="#h96-0-27" id="h96-0-27" class="i">+                        param.setArg(0, param.arg&lt;Array&lt;InputFilter&gt;&gt;(0).filter {
</a><a href="#h96-0-28" id="h96-0-28" class="i">+                            it !is InputFilter.LengthFilter
</a><a href="#h96-0-29" id="h96-0-29" class="i">+                        }.toTypedArray())
</a><a href="#h96-0-30" id="h96-0-30" class="i">+                    }
</a><a href="#h96-0-31" id="h96-0-31" class="i">+            }
</a> 
<a href="#h96-0-33" id="h96-0-33" class="d">-        if (editTextOverride.contains(&quot;multi_line_chat_input&quot;)) {
</a><a href="#h96-0-34" id="h96-0-34" class="d">-            findClass(&quot;com.snap.messaging.chat.features.input.InputBarEditText&quot;).apply {
</a><a href="#h96-0-35" id="h96-0-35" class="d">-                hookConstructor(HookStage.AFTER) { param -&gt;
</a><a href="#h96-0-36" id="h96-0-36" class="d">-                    val editText = param.thisObject&lt;EditText&gt;()
</a><a href="#h96-0-37" id="h96-0-37" class="d">-                    editText.inputType = editText.inputType or InputType.TYPE_TEXT_FLAG_MULTI_LINE
</a><a href="#h96-0-38" id="h96-0-38" class="i">+            if (editTextOverride.contains(&quot;multi_line_chat_input&quot;)) {
</a><a href="#h96-0-39" id="h96-0-39" class="i">+                findClass(&quot;com.snap.messaging.chat.features.input.InputBarEditText&quot;).apply {
</a><a href="#h96-0-40" id="h96-0-40" class="i">+                    hookConstructor(HookStage.AFTER) { param -&gt;
</a><a href="#h96-0-41" id="h96-0-41" class="i">+                        val editText = param.thisObject&lt;EditText&gt;()
</a><a href="#h96-0-42" id="h96-0-42" class="i">+                        editText.inputType = editText.inputType or InputType.TYPE_TEXT_FLAG_MULTI_LINE
</a><a href="#h96-0-43" id="h96-0-43" class="i">+                    }
</a>                 }
             }
         }
<b>diff --git a/<a id="h97" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/ui/FriendFeedMessagePreview.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/ui/FriendFeedMessagePreview.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/ui/FriendFeedMessagePreview.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/ui/FriendFeedMessagePreview.kt</a></b>
<a href="#h97-0" id="h97-0" class="h">@@ -8,6 +8,7 @@ import android.graphics.drawable.shapes.Shape
</a> import android.text.TextPaint
 import android.view.View
 import android.view.ViewGroup
<a href="#h97-0-3" id="h97-0-3" class="i">+import androidx.core.content.res.use
</a> import kotlinx.coroutines.Dispatchers
 import kotlinx.coroutines.ExperimentalCoroutinesApi
 import kotlinx.coroutines.launch
<a href="#h97-1" id="h97-1" class="h">@@ -17,7 +18,6 @@ import me.rhunk.snapenhance.common.util.protobuf.ProtoReader
</a> import me.rhunk.snapenhance.core.event.events.impl.BindViewEvent
 import me.rhunk.snapenhance.core.event.events.impl.BuildMessageEvent
 import me.rhunk.snapenhance.core.features.Feature
<a href="#h97-1-3" id="h97-1-3" class="d">-import me.rhunk.snapenhance.core.features.FeatureLoadParams
</a> import me.rhunk.snapenhance.core.features.impl.experiments.EndToEndEncryption
 import me.rhunk.snapenhance.core.ui.addForegroundDrawable
 import me.rhunk.snapenhance.core.ui.removeForegroundDrawable
<a href="#h97-2" id="h97-2" class="h">@@ -29,7 +29,7 @@ import me.rhunk.snapenhance.core.wrapper.impl.getMessageText
</a> import java.util.WeakHashMap
 import kotlin.math.absoluteValue
 
<a href="#h97-2-3" id="h97-2-3" class="d">-class FriendFeedMessagePreview : Feature(&quot;FriendFeedMessagePreview&quot;, loadParams = FeatureLoadParams.ACTIVITY_CREATE_SYNC) {
</a><a href="#h97-2-4" id="h97-2-4" class="i">+class FriendFeedMessagePreview : Feature(&quot;FriendFeedMessagePreview&quot;) {
</a>     private val endToEndEncryption by lazy { context.feature(EndToEndEncryption::class) }
     @OptIn(ExperimentalCoroutinesApi::class)
     private val coroutineDispatcher = Dispatchers.IO.limitedParallelism(1)
<a href="#h97-3" id="h97-3" class="h">@@ -39,7 +39,7 @@ class FriendFeedMessagePreview : Feature(&quot;FriendFeedMessagePreview&quot;, loadParams 
</a>     private val sigColorTextPrimary by lazy {
         context.mainActivity!!.theme.obtainStyledAttributes(
             intArrayOf(context.resources.getIdentifier(&quot;sigColorTextPrimary&quot;, &quot;attr&quot;))
<a href="#h97-3-3" id="h97-3-3" class="d">-        ).getColor(0, 0)
</a><a href="#h97-3-4" id="h97-3-4" class="i">+        ).use { it.getColor(0, 0) }
</a>     }
 
     private val cachedLayouts = WeakHashMap&lt;String, View&gt;()
<a href="#h97-4" id="h97-4" class="h">@@ -73,82 +73,84 @@ class FriendFeedMessagePreview : Feature(&quot;FriendFeedMessagePreview&quot;, loadParams 
</a>         }
     }
 
<a href="#h97-4-3" id="h97-4-3" class="d">-    override fun onActivityCreate() {
</a><a href="#h97-4-4" id="h97-4-4" class="i">+    override fun init() {
</a>         if (setting.globalState != true) return
 
<a href="#h97-4-7" id="h97-4-7" class="d">-        val ffItemId = context.resources.getId(&quot;ff_item&quot;)
</a><a href="#h97-4-8" id="h97-4-8" class="i">+        onNextActivityCreate {
</a><a href="#h97-4-9" id="h97-4-9" class="i">+            val ffItemId = context.resources.getId(&quot;ff_item&quot;)
</a> 
<a href="#h97-4-11" id="h97-4-11" class="d">-        val secondaryTextSize = context.resources.getDimens(&quot;ff_feed_cell_secondary_text_size&quot;).toFloat()
</a><a href="#h97-4-12" id="h97-4-12" class="d">-        val ffSdlAvatarMargin = context.resources.getDimens(&quot;ff_sdl_avatar_margin&quot;)
</a><a href="#h97-4-13" id="h97-4-13" class="d">-        val ffSdlAvatarSize = context.resources.getDimens(&quot;ff_sdl_avatar_size&quot;)
</a><a href="#h97-4-14" id="h97-4-14" class="d">-        val ffSdlPrimaryTextStartMargin = context.resources.getDimens(&quot;ff_sdl_primary_text_start_margin&quot;).toFloat()
</a><a href="#h97-4-15" id="h97-4-15" class="i">+            val secondaryTextSize = context.resources.getDimens(&quot;ff_feed_cell_secondary_text_size&quot;).toFloat()
</a><a href="#h97-4-16" id="h97-4-16" class="i">+            val ffSdlAvatarMargin = context.resources.getDimens(&quot;ff_sdl_avatar_margin&quot;)
</a><a href="#h97-4-17" id="h97-4-17" class="i">+            val ffSdlAvatarSize = context.resources.getDimens(&quot;ff_sdl_avatar_size&quot;)
</a><a href="#h97-4-18" id="h97-4-18" class="i">+            val ffSdlPrimaryTextStartMargin = context.resources.getDimens(&quot;ff_sdl_primary_text_start_margin&quot;).toFloat()
</a> 
<a href="#h97-4-20" id="h97-4-20" class="d">-        val feedEntryHeight = ffSdlAvatarSize + ffSdlAvatarMargin * 2 + (4 * context.resources.displayMetrics.density).toInt()
</a><a href="#h97-4-21" id="h97-4-21" class="d">-        val separatorHeight = (context.resources.displayMetrics.density * 2).toInt()
</a><a href="#h97-4-22" id="h97-4-22" class="d">-        val avenirNextMedium = context.resources.getFont(context.resources.getIdentifier(&quot;avenir_next_medium&quot;, &quot;font&quot;))
</a><a href="#h97-4-23" id="h97-4-23" class="d">-        val textPaint = TextPaint().apply {
</a><a href="#h97-4-24" id="h97-4-24" class="d">-            textSize = secondaryTextSize
</a><a href="#h97-4-25" id="h97-4-25" class="d">-            typeface = avenirNextMedium
</a><a href="#h97-4-26" id="h97-4-26" class="d">-        }
</a><a href="#h97-4-27" id="h97-4-27" class="i">+            val feedEntryHeight = ffSdlAvatarSize + ffSdlAvatarMargin * 2 + (4 * context.resources.displayMetrics.density).toInt()
</a><a href="#h97-4-28" id="h97-4-28" class="i">+            val separatorHeight = (context.resources.displayMetrics.density * 2).toInt()
</a><a href="#h97-4-29" id="h97-4-29" class="i">+            val avenirNextMedium = context.resources.getFont(context.resources.getIdentifier(&quot;avenir_next_medium&quot;, &quot;font&quot;))
</a><a href="#h97-4-30" id="h97-4-30" class="i">+            val textPaint = TextPaint().apply {
</a><a href="#h97-4-31" id="h97-4-31" class="i">+                textSize = secondaryTextSize
</a><a href="#h97-4-32" id="h97-4-32" class="i">+                typeface = avenirNextMedium
</a><a href="#h97-4-33" id="h97-4-33" class="i">+            }
</a> 
<a href="#h97-4-35" id="h97-4-35" class="d">-        context.event.subscribe(BuildMessageEvent::class) { param -&gt;
</a><a href="#h97-4-36" id="h97-4-36" class="d">-            val conversationId = param.message.messageDescriptor?.conversationId?.toString() ?: return@subscribe
</a><a href="#h97-4-37" id="h97-4-37" class="d">-            val cachedView = cachedLayouts[conversationId] ?: return@subscribe
</a><a href="#h97-4-38" id="h97-4-38" class="d">-            context.coroutineScope.launch {
</a><a href="#h97-4-39" id="h97-4-39" class="d">-                fetchMessages(conversationId) {
</a><a href="#h97-4-40" id="h97-4-40" class="d">-                    cachedView.postInvalidateDelayed(100L)
</a><a href="#h97-4-41" id="h97-4-41" class="i">+            context.event.subscribe(BuildMessageEvent::class) { param -&gt;
</a><a href="#h97-4-42" id="h97-4-42" class="i">+                val conversationId = param.message.messageDescriptor?.conversationId?.toString() ?: return@subscribe
</a><a href="#h97-4-43" id="h97-4-43" class="i">+                val cachedView = cachedLayouts[conversationId] ?: return@subscribe
</a><a href="#h97-4-44" id="h97-4-44" class="i">+                context.coroutineScope.launch {
</a><a href="#h97-4-45" id="h97-4-45" class="i">+                    fetchMessages(conversationId) {
</a><a href="#h97-4-46" id="h97-4-46" class="i">+                        cachedView.postInvalidateDelayed(100L)
</a><a href="#h97-4-47" id="h97-4-47" class="i">+                    }
</a>                 }
             }
<a href="#h97-4-50" id="h97-4-50" class="d">-        }
</a> 
<a href="#h97-4-52" id="h97-4-52" class="d">-        context.event.subscribe(BindViewEvent::class) { param -&gt;
</a><a href="#h97-4-53" id="h97-4-53" class="d">-            param.friendFeedItem { conversationId -&gt;
</a><a href="#h97-4-54" id="h97-4-54" class="d">-                val frameLayout = param.view as ViewGroup
</a><a href="#h97-4-55" id="h97-4-55" class="d">-                val ffItem = frameLayout.findViewById&lt;View&gt;(ffItemId)
</a><a href="#h97-4-56" id="h97-4-56" class="i">+            context.event.subscribe(BindViewEvent::class) { param -&gt;
</a><a href="#h97-4-57" id="h97-4-57" class="i">+                param.friendFeedItem { conversationId -&gt;
</a><a href="#h97-4-58" id="h97-4-58" class="i">+                    val frameLayout = param.view as ViewGroup
</a><a href="#h97-4-59" id="h97-4-59" class="i">+                    val ffItem = frameLayout.findViewById&lt;View&gt;(ffItemId)
</a> 
<a href="#h97-4-61" id="h97-4-61" class="d">-                context.coroutineScope.launch(coroutineDispatcher) {
</a><a href="#h97-4-62" id="h97-4-62" class="d">-                    withContext(Dispatchers.Main) {
</a><a href="#h97-4-63" id="h97-4-63" class="d">-                        cachedLayouts.remove(conversationId)
</a><a href="#h97-4-64" id="h97-4-64" class="d">-                        frameLayout.removeForegroundDrawable(&quot;ffItem&quot;)
</a><a href="#h97-4-65" id="h97-4-65" class="d">-                    }
</a><a href="#h97-4-66" id="h97-4-66" class="i">+                    context.coroutineScope.launch(coroutineDispatcher) {
</a><a href="#h97-4-67" id="h97-4-67" class="i">+                        withContext(Dispatchers.Main) {
</a><a href="#h97-4-68" id="h97-4-68" class="i">+                            cachedLayouts.remove(conversationId)
</a><a href="#h97-4-69" id="h97-4-69" class="i">+                            frameLayout.removeForegroundDrawable(&quot;ffItem&quot;)
</a><a href="#h97-4-70" id="h97-4-70" class="i">+                        }
</a> 
<a href="#h97-4-72" id="h97-4-72" class="d">-                    fetchMessages(conversationId) {
</a><a href="#h97-4-73" id="h97-4-73" class="d">-                        var maxTextHeight = 0
</a><a href="#h97-4-74" id="h97-4-74" class="d">-                        val previewContainerHeight = messageCache[conversationId]?.sumOf { msg -&gt;
</a><a href="#h97-4-75" id="h97-4-75" class="d">-                            val rect = Rect()
</a><a href="#h97-4-76" id="h97-4-76" class="d">-                            textPaint.getTextBounds(msg, 0, msg.length, rect)
</a><a href="#h97-4-77" id="h97-4-77" class="d">-                            rect.height().also {
</a><a href="#h97-4-78" id="h97-4-78" class="d">-                                if (it &gt; maxTextHeight) maxTextHeight = it
</a><a href="#h97-4-79" id="h97-4-79" class="d">-                            }.plus(separatorHeight)
</a><a href="#h97-4-80" id="h97-4-80" class="d">-                        } ?: run {
</a><a href="#h97-4-81" id="h97-4-81" class="d">-                            ffItem.layoutParams = ffItem.layoutParams.apply {
</a><a href="#h97-4-82" id="h97-4-82" class="d">-                                height = ViewGroup.LayoutParams.MATCH_PARENT
</a><a href="#h97-4-83" id="h97-4-83" class="i">+                        fetchMessages(conversationId) {
</a><a href="#h97-4-84" id="h97-4-84" class="i">+                            var maxTextHeight = 0
</a><a href="#h97-4-85" id="h97-4-85" class="i">+                            val previewContainerHeight = messageCache[conversationId]?.sumOf { msg -&gt;
</a><a href="#h97-4-86" id="h97-4-86" class="i">+                                val rect = Rect()
</a><a href="#h97-4-87" id="h97-4-87" class="i">+                                textPaint.getTextBounds(msg, 0, msg.length, rect)
</a><a href="#h97-4-88" id="h97-4-88" class="i">+                                rect.height().also {
</a><a href="#h97-4-89" id="h97-4-89" class="i">+                                    if (it &gt; maxTextHeight) maxTextHeight = it
</a><a href="#h97-4-90" id="h97-4-90" class="i">+                                }.plus(separatorHeight)
</a><a href="#h97-4-91" id="h97-4-91" class="i">+                            } ?: run {
</a><a href="#h97-4-92" id="h97-4-92" class="i">+                                ffItem.layoutParams = ffItem.layoutParams.apply {
</a><a href="#h97-4-93" id="h97-4-93" class="i">+                                    height = ViewGroup.LayoutParams.MATCH_PARENT
</a><a href="#h97-4-94" id="h97-4-94" class="i">+                                }
</a><a href="#h97-4-95" id="h97-4-95" class="i">+                                return@fetchMessages
</a>                             }
<a href="#h97-4-97" id="h97-4-97" class="d">-                            return@fetchMessages
</a><a href="#h97-4-98" id="h97-4-98" class="d">-                        }
</a> 
<a href="#h97-4-100" id="h97-4-100" class="d">-                        ffItem.layoutParams = ffItem.layoutParams.apply {
</a><a href="#h97-4-101" id="h97-4-101" class="d">-                            height = feedEntryHeight + previewContainerHeight + separatorHeight
</a><a href="#h97-4-102" id="h97-4-102" class="d">-                        }
</a><a href="#h97-4-103" id="h97-4-103" class="i">+                            ffItem.layoutParams = ffItem.layoutParams.apply {
</a><a href="#h97-4-104" id="h97-4-104" class="i">+                                height = feedEntryHeight + previewContainerHeight + separatorHeight
</a><a href="#h97-4-105" id="h97-4-105" class="i">+                            }
</a> 
<a href="#h97-4-107" id="h97-4-107" class="d">-                        cachedLayouts[conversationId] = frameLayout
</a><a href="#h97-4-108" id="h97-4-108" class="d">-
</a><a href="#h97-4-109" id="h97-4-109" class="d">-                        frameLayout.addForegroundDrawable(&quot;ffItem&quot;, ShapeDrawable(object: Shape() {
</a><a href="#h97-4-110" id="h97-4-110" class="d">-                            override fun draw(canvas: Canvas, paint: Paint) {
</a><a href="#h97-4-111" id="h97-4-111" class="d">-                                val offsetY = canvas.height.toFloat() - previewContainerHeight
</a><a href="#h97-4-112" id="h97-4-112" class="d">-                                paint.textSize = secondaryTextSize
</a><a href="#h97-4-113" id="h97-4-113" class="d">-                                paint.color = sigColorTextPrimary
</a><a href="#h97-4-114" id="h97-4-114" class="d">-                                paint.typeface = avenirNextMedium
</a><a href="#h97-4-115" id="h97-4-115" class="d">-
</a><a href="#h97-4-116" id="h97-4-116" class="d">-                                messageCache[conversationId]?.forEachIndexed { index, messageString -&gt;
</a><a href="#h97-4-117" id="h97-4-117" class="d">-                                    canvas.drawText(messageString,
</a><a href="#h97-4-118" id="h97-4-118" class="d">-                                        feedEntryHeight + ffSdlPrimaryTextStartMargin,
</a><a href="#h97-4-119" id="h97-4-119" class="d">-                                        offsetY + index * maxTextHeight,
</a><a href="#h97-4-120" id="h97-4-120" class="d">-                                        paint
</a><a href="#h97-4-121" id="h97-4-121" class="d">-                                    )
</a><a href="#h97-4-122" id="h97-4-122" class="i">+                            cachedLayouts[conversationId] = frameLayout
</a><a href="#h97-4-123" id="h97-4-123" class="i">+
</a><a href="#h97-4-124" id="h97-4-124" class="i">+                            frameLayout.addForegroundDrawable(&quot;ffItem&quot;, ShapeDrawable(object: Shape() {
</a><a href="#h97-4-125" id="h97-4-125" class="i">+                                override fun draw(canvas: Canvas, paint: Paint) {
</a><a href="#h97-4-126" id="h97-4-126" class="i">+                                    val offsetY = canvas.height.toFloat() - previewContainerHeight
</a><a href="#h97-4-127" id="h97-4-127" class="i">+                                    paint.textSize = secondaryTextSize
</a><a href="#h97-4-128" id="h97-4-128" class="i">+                                    paint.color = sigColorTextPrimary
</a><a href="#h97-4-129" id="h97-4-129" class="i">+                                    paint.typeface = avenirNextMedium
</a><a href="#h97-4-130" id="h97-4-130" class="i">+
</a><a href="#h97-4-131" id="h97-4-131" class="i">+                                    messageCache[conversationId]?.forEachIndexed { index, messageString -&gt;
</a><a href="#h97-4-132" id="h97-4-132" class="i">+                                        canvas.drawText(messageString,
</a><a href="#h97-4-133" id="h97-4-133" class="i">+                                            feedEntryHeight + ffSdlPrimaryTextStartMargin,
</a><a href="#h97-4-134" id="h97-4-134" class="i">+                                            offsetY + index * maxTextHeight,
</a><a href="#h97-4-135" id="h97-4-135" class="i">+                                            paint
</a><a href="#h97-4-136" id="h97-4-136" class="i">+                                        )
</a><a href="#h97-4-137" id="h97-4-137" class="i">+                                    }
</a>                                 }
<a href="#h97-4-139" id="h97-4-139" class="d">-                            }
</a><a href="#h97-4-140" id="h97-4-140" class="d">-                        }))
</a><a href="#h97-4-141" id="h97-4-141" class="i">+                            }))
</a><a href="#h97-4-142" id="h97-4-142" class="i">+                        }
</a>                     }
                 }
             }
<b>diff --git a/<a id="h98" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/ui/HideFriendFeedEntry.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/ui/HideFriendFeedEntry.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/ui/HideFriendFeedEntry.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/ui/HideFriendFeedEntry.kt</a></b>
<a href="#h98-0" id="h98-0" class="h">@@ -2,7 +2,7 @@ package me.rhunk.snapenhance.core.features.impl.ui
</a> 
 import me.rhunk.snapenhance.common.data.MessagingRuleType
 import me.rhunk.snapenhance.common.data.RuleState
<a href="#h98-0-3" id="h98-0-3" class="d">-import me.rhunk.snapenhance.core.features.FeatureLoadParams
</a><a href="#h98-0-4" id="h98-0-4" class="i">+
</a> import me.rhunk.snapenhance.core.features.MessagingRuleFeature
 import me.rhunk.snapenhance.core.util.dataBuilder
 import me.rhunk.snapenhance.core.util.hook.HookStage
<a href="#h98-1" id="h98-1" class="h">@@ -11,7 +11,7 @@ import me.rhunk.snapenhance.core.util.ktx.getObjectField
</a> import me.rhunk.snapenhance.core.wrapper.impl.SnapUUID
 import me.rhunk.snapenhance.mapper.impl.CallbackMapper
 
<a href="#h98-1-3" id="h98-1-3" class="d">-class HideFriendFeedEntry : MessagingRuleFeature(&quot;HideFriendFeedEntry&quot;, ruleType = MessagingRuleType.HIDE_FRIEND_FEED, loadParams = FeatureLoadParams.INIT_SYNC) {
</a><a href="#h98-1-4" id="h98-1-4" class="i">+class HideFriendFeedEntry : MessagingRuleFeature(&quot;HideFriendFeedEntry&quot;, ruleType = MessagingRuleType.HIDE_FRIEND_FEED) {
</a>     private fun createDeletedFeedEntry(conversationIdInstance: Any) = findClass(&quot;com.snapchat.client.messaging.DeletedFeedEntry&quot;).dataBuilder {
         from(&quot;mFeedEntryIdentifier&quot;) {
             set(&quot;mConversationId&quot;, conversationIdInstance)
<b>diff --git a/<a id="h99" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/ui/HideQuickAddFriendFeed.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/ui/HideQuickAddFriendFeed.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/ui/HideQuickAddFriendFeed.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/ui/HideQuickAddFriendFeed.kt</a></b>
<a href="#h99-0" id="h99-0" class="h">@@ -1,22 +1,23 @@
</a> package me.rhunk.snapenhance.core.features.impl.ui
 
 import me.rhunk.snapenhance.core.features.Feature
<a href="#h99-0-3" id="h99-0-3" class="d">-import me.rhunk.snapenhance.core.features.FeatureLoadParams
</a> import me.rhunk.snapenhance.core.util.hook.HookStage
 import me.rhunk.snapenhance.core.util.hook.hookConstructor
 import me.rhunk.snapenhance.core.util.ktx.setObjectField
 import me.rhunk.snapenhance.mapper.impl.FriendingDataSourcesMapper
 
<a href="#h99-0-9" id="h99-0-9" class="d">-class HideQuickAddFriendFeed : Feature(&quot;HideQuickAddFriendFeed&quot;, loadParams = FeatureLoadParams.ACTIVITY_CREATE_SYNC) {
</a><a href="#h99-0-10" id="h99-0-10" class="d">-    override fun onActivityCreate() {
</a><a href="#h99-0-11" id="h99-0-11" class="i">+class HideQuickAddFriendFeed : Feature(&quot;HideQuickAddFriendFeed&quot;) {
</a><a href="#h99-0-12" id="h99-0-12" class="i">+    override fun init() {
</a>         if (!context.config.userInterface.hideQuickAddFriendFeed.get()) return
 
<a href="#h99-0-15" id="h99-0-15" class="d">-        context.mappings.useMapper(FriendingDataSourcesMapper::class) {
</a><a href="#h99-0-16" id="h99-0-16" class="d">-            classReference.getAsClass()?.hookConstructor(HookStage.AFTER) { param -&gt;
</a><a href="#h99-0-17" id="h99-0-17" class="d">-                param.thisObject&lt;Any&gt;().setObjectField(
</a><a href="#h99-0-18" id="h99-0-18" class="d">-                    quickAddSourceListField.get()!!,
</a><a href="#h99-0-19" id="h99-0-19" class="d">-                    arrayListOf&lt;Any&gt;()
</a><a href="#h99-0-20" id="h99-0-20" class="d">-                )
</a><a href="#h99-0-21" id="h99-0-21" class="i">+        onNextActivityCreate {
</a><a href="#h99-0-22" id="h99-0-22" class="i">+            context.mappings.useMapper(FriendingDataSourcesMapper::class) {
</a><a href="#h99-0-23" id="h99-0-23" class="i">+                classReference.getAsClass()?.hookConstructor(HookStage.AFTER) { param -&gt;
</a><a href="#h99-0-24" id="h99-0-24" class="i">+                    param.thisObject&lt;Any&gt;().setObjectField(
</a><a href="#h99-0-25" id="h99-0-25" class="i">+                        quickAddSourceListField.get()!!,
</a><a href="#h99-0-26" id="h99-0-26" class="i">+                        arrayListOf&lt;Any&gt;()
</a><a href="#h99-0-27" id="h99-0-27" class="i">+                    )
</a><a href="#h99-0-28" id="h99-0-28" class="i">+                }
</a>             }
         }
     }
<b>diff --git a/<a id="h100" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/ui/HideStreakRestore.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/ui/HideStreakRestore.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/ui/HideStreakRestore.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/ui/HideStreakRestore.kt</a></b>
<a href="#h100-0" id="h100-0" class="h">@@ -1,7 +1,6 @@
</a> package me.rhunk.snapenhance.core.features.impl.ui
 
 import me.rhunk.snapenhance.core.features.Feature
<a href="#h100-0-3" id="h100-0-3" class="d">-import me.rhunk.snapenhance.core.features.FeatureLoadParams
</a> import me.rhunk.snapenhance.core.features.impl.messaging.Messaging
 import me.rhunk.snapenhance.core.util.dataBuilder
 import me.rhunk.snapenhance.core.util.hook.HookStage
<a href="#h100-1" id="h100-1" class="h">@@ -11,7 +10,7 @@ import me.rhunk.snapenhance.core.util.ktx.getObjectFieldOrNull
</a> import me.rhunk.snapenhance.core.util.ktx.setObjectField
 import me.rhunk.snapenhance.core.wrapper.impl.SnapUUID
 
<a href="#h100-1-3" id="h100-1-3" class="d">-class HideStreakRestore : Feature(&quot;HideStreakRestore&quot;, loadParams = FeatureLoadParams.INIT_SYNC) {
</a><a href="#h100-1-4" id="h100-1-4" class="i">+class HideStreakRestore : Feature(&quot;HideStreakRestore&quot;) {
</a>     override fun init() {
         if (!context.config.userInterface.hideStreakRestore.get()) return
 
<b>diff --git a/<a id="h101" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/ui/MessageIndicators.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/ui/MessageIndicators.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/ui/MessageIndicators.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/ui/MessageIndicators.kt</a></b>
<a href="#h101-0" id="h101-0" class="h">@@ -26,119 +26,120 @@ import me.rhunk.snapenhance.common.ui.rememberAsyncMutableState
</a> import me.rhunk.snapenhance.common.util.protobuf.ProtoReader
 import me.rhunk.snapenhance.core.event.events.impl.BindViewEvent
 import me.rhunk.snapenhance.core.features.Feature
<a href="#h101-0-3" id="h101-0-3" class="d">-import me.rhunk.snapenhance.core.features.FeatureLoadParams
</a> import me.rhunk.snapenhance.core.ui.AppleLogo
 import me.rhunk.snapenhance.core.ui.removeForegroundDrawable
 import kotlin.random.Random
 
<a href="#h101-0-8" id="h101-0-8" class="d">-class MessageIndicators : Feature(&quot;Message Indicators&quot;, loadParams = FeatureLoadParams.ACTIVITY_CREATE_SYNC) {
</a><a href="#h101-0-9" id="h101-0-9" class="d">-    override fun onActivityCreate() {
</a><a href="#h101-0-10" id="h101-0-10" class="i">+class MessageIndicators : Feature(&quot;Message Indicators&quot;) {
</a><a href="#h101-0-11" id="h101-0-11" class="i">+    override fun init() {
</a>         val messageIndicatorsConfig = context.config.userInterface.messageIndicators.getNullable() ?: return
         if (messageIndicatorsConfig.isEmpty()) return
 
         val messageInfoTag = Random.nextLong().toString()
<a href="#h101-0-16" id="h101-0-16" class="d">-        val appleLogo = AppleLogo
</a><a href="#h101-0-17" id="h101-0-17" class="i">+        onNextActivityCreate {
</a><a href="#h101-0-18" id="h101-0-18" class="i">+            val appleLogo = AppleLogo
</a> 
<a href="#h101-0-20" id="h101-0-20" class="d">-        context.event.subscribe(BindViewEvent::class) { event -&gt;
</a><a href="#h101-0-21" id="h101-0-21" class="d">-            event.chatMessage { _, messageId -&gt;
</a><a href="#h101-0-22" id="h101-0-22" class="d">-                val parentLinearLayout = event.view.parent as? ViewGroup ?: return@subscribe
</a><a href="#h101-0-23" id="h101-0-23" class="d">-                parentLinearLayout.findViewWithTag&lt;View&gt;(messageInfoTag)?.let { parentLinearLayout.removeView(it) }
</a><a href="#h101-0-24" id="h101-0-24" class="i">+            context.event.subscribe(BindViewEvent::class) { event -&gt;
</a><a href="#h101-0-25" id="h101-0-25" class="i">+                event.chatMessage { _, messageId -&gt;
</a><a href="#h101-0-26" id="h101-0-26" class="i">+                    val parentLinearLayout = event.view.parent as? ViewGroup ?: return@subscribe
</a><a href="#h101-0-27" id="h101-0-27" class="i">+                    parentLinearLayout.findViewWithTag&lt;View&gt;(messageInfoTag)?.let { parentLinearLayout.removeView(it) }
</a> 
<a href="#h101-0-29" id="h101-0-29" class="d">-                event.view.removeForegroundDrawable(&quot;messageIndicators&quot;)
</a><a href="#h101-0-30" id="h101-0-30" class="i">+                    event.view.removeForegroundDrawable(&quot;messageIndicators&quot;)
</a> 
<a href="#h101-0-32" id="h101-0-32" class="d">-                val message = context.database.getConversationMessageFromId(messageId.toLong()) ?: return@chatMessage
</a><a href="#h101-0-33" id="h101-0-33" class="d">-                if (message.contentType != ContentType.SNAP.id &amp;&amp; message.contentType != ContentType.EXTERNAL_MEDIA.id) return@chatMessage
</a><a href="#h101-0-34" id="h101-0-34" class="d">-                val reader = ProtoReader(message.messageContent ?: return@chatMessage)
</a><a href="#h101-0-35" id="h101-0-35" class="i">+                    val message = context.database.getConversationMessageFromId(messageId.toLong()) ?: return@chatMessage
</a><a href="#h101-0-36" id="h101-0-36" class="i">+                    if (message.contentType != ContentType.SNAP.id &amp;&amp; message.contentType != ContentType.EXTERNAL_MEDIA.id) return@chatMessage
</a><a href="#h101-0-37" id="h101-0-37" class="i">+                    val reader = ProtoReader(message.messageContent ?: return@chatMessage)
</a> 
<a href="#h101-0-39" id="h101-0-39" class="d">-                createComposeView(event.view.context) {
</a><a href="#h101-0-40" id="h101-0-40" class="d">-                    Box(
</a><a href="#h101-0-41" id="h101-0-41" class="d">-                        modifier = Modifier
</a><a href="#h101-0-42" id="h101-0-42" class="d">-                            .fillMaxWidth()
</a><a href="#h101-0-43" id="h101-0-43" class="d">-                            .height(50.dp)
</a><a href="#h101-0-44" id="h101-0-44" class="d">-                            .padding(top = 4.dp, end = 1.dp),
</a><a href="#h101-0-45" id="h101-0-45" class="d">-                        contentAlignment = Alignment.TopEnd
</a><a href="#h101-0-46" id="h101-0-46" class="d">-                    ) {
</a><a href="#h101-0-47" id="h101-0-47" class="d">-                        val hasEncryption by rememberAsyncMutableState(defaultValue = false) {
</a><a href="#h101-0-48" id="h101-0-48" class="d">-                            reader.getByteArray(4, 3, 3) != null || reader.containsPath(3, 99, 3)
</a><a href="#h101-0-49" id="h101-0-49" class="d">-                        }
</a><a href="#h101-0-50" id="h101-0-50" class="d">-                        val sentFromIosDevice by rememberAsyncMutableState(defaultValue = false) {
</a><a href="#h101-0-51" id="h101-0-51" class="d">-                            if (reader.containsPath(4, 4, 3)) !reader.containsPath(4, 4, 3, 3, 17) else reader.getVarInt(4, 4, 11, 17, 7) != null
</a><a href="#h101-0-52" id="h101-0-52" class="d">-                        }
</a><a href="#h101-0-53" id="h101-0-53" class="d">-                        val sentFromWebApp by rememberAsyncMutableState(defaultValue = false) {
</a><a href="#h101-0-54" id="h101-0-54" class="d">-                            reader.getVarInt(4, 4, *(if (reader.containsPath(4, 4, 3)) intArrayOf(3, 3, 22, 1) else intArrayOf(11, 22, 1))) == 7L
</a><a href="#h101-0-55" id="h101-0-55" class="d">-                        }
</a><a href="#h101-0-56" id="h101-0-56" class="d">-                        val sentWithLocation by rememberAsyncMutableState(defaultValue = false) {
</a><a href="#h101-0-57" id="h101-0-57" class="d">-                            reader.getVarInt(4, 4, 11, 17, 5) != null
</a><a href="#h101-0-58" id="h101-0-58" class="d">-                        }
</a><a href="#h101-0-59" id="h101-0-59" class="d">-                        val sentUsingOvfEditor by rememberAsyncMutableState(defaultValue = false) {
</a><a href="#h101-0-60" id="h101-0-60" class="d">-                            (reader.getString(4, 4, 11, 12, 1) ?: reader.getString(4, 4, 11, 13, 4, 1, 2, 12, 20, 1)) == &quot;c13129f7-fe4a-44c4-9b9d-e0b26fee8f82&quot;
</a><a href="#h101-0-61" id="h101-0-61" class="d">-                        }
</a><a href="#h101-0-62" id="h101-0-62" class="d">-                        val sentUsingDirectorMode by rememberAsyncMutableState(defaultValue = false) {
</a><a href="#h101-0-63" id="h101-0-63" class="d">-                            reader.followPath(4, 4, 11, 28)?.let {
</a><a href="#h101-0-64" id="h101-0-64" class="d">-                                (it.getVarInt(1) to it.getVarInt(2)) == (0L to 0L)
</a><a href="#h101-0-65" id="h101-0-65" class="d">-                            } == true || reader.getByteArray(4, 4, 11, 13, 4, 1, 2, 12, 27, 1) != null
</a><a href="#h101-0-66" id="h101-0-66" class="d">-                        }
</a><a href="#h101-0-67" id="h101-0-67" class="d">-
</a><a href="#h101-0-68" id="h101-0-68" class="d">-                        Row(
</a><a href="#h101-0-69" id="h101-0-69" class="d">-                            verticalAlignment = Alignment.CenterVertically
</a><a href="#h101-0-70" id="h101-0-70" class="i">+                    createComposeView(event.view.context) {
</a><a href="#h101-0-71" id="h101-0-71" class="i">+                        Box(
</a><a href="#h101-0-72" id="h101-0-72" class="i">+                            modifier = Modifier
</a><a href="#h101-0-73" id="h101-0-73" class="i">+                                .fillMaxWidth()
</a><a href="#h101-0-74" id="h101-0-74" class="i">+                                .height(50.dp)
</a><a href="#h101-0-75" id="h101-0-75" class="i">+                                .padding(top = 4.dp, end = 1.dp),
</a><a href="#h101-0-76" id="h101-0-76" class="i">+                            contentAlignment = Alignment.TopEnd
</a>                         ) {
<a href="#h101-0-78" id="h101-0-78" class="d">-                            if (sentWithLocation &amp;&amp; messageIndicatorsConfig.contains(&quot;location_indicator&quot;)) {
</a><a href="#h101-0-79" id="h101-0-79" class="d">-                                Image(
</a><a href="#h101-0-80" id="h101-0-80" class="d">-                                    imageVector = Icons.Default.LocationOn,
</a><a href="#h101-0-81" id="h101-0-81" class="d">-                                    colorFilter = ColorFilter.tint(Color.Green),
</a><a href="#h101-0-82" id="h101-0-82" class="d">-                                    contentDescription = null,
</a><a href="#h101-0-83" id="h101-0-83" class="d">-                                    modifier = Modifier.size(15.dp)
</a><a href="#h101-0-84" id="h101-0-84" class="d">-                                )
</a><a href="#h101-0-85" id="h101-0-85" class="i">+                            val hasEncryption by rememberAsyncMutableState(defaultValue = false) {
</a><a href="#h101-0-86" id="h101-0-86" class="i">+                                reader.getByteArray(4, 3, 3) != null || reader.containsPath(3, 99, 3)
</a><a href="#h101-0-87" id="h101-0-87" class="i">+                            }
</a><a href="#h101-0-88" id="h101-0-88" class="i">+                            val sentFromIosDevice by rememberAsyncMutableState(defaultValue = false) {
</a><a href="#h101-0-89" id="h101-0-89" class="i">+                                if (reader.containsPath(4, 4, 3)) !reader.containsPath(4, 4, 3, 3, 17) else reader.getVarInt(4, 4, 11, 17, 7) != null
</a><a href="#h101-0-90" id="h101-0-90" class="i">+                            }
</a><a href="#h101-0-91" id="h101-0-91" class="i">+                            val sentFromWebApp by rememberAsyncMutableState(defaultValue = false) {
</a><a href="#h101-0-92" id="h101-0-92" class="i">+                                reader.getVarInt(4, 4, *(if (reader.containsPath(4, 4, 3)) intArrayOf(3, 3, 22, 1) else intArrayOf(11, 22, 1))) == 7L
</a>                             }
<a href="#h101-0-94" id="h101-0-94" class="d">-                            if (messageIndicatorsConfig.contains(&quot;platform_indicator&quot;)) {
</a><a href="#h101-0-95" id="h101-0-95" class="d">-                                Image(
</a><a href="#h101-0-96" id="h101-0-96" class="d">-                                    imageVector = when {
</a><a href="#h101-0-97" id="h101-0-97" class="d">-                                        sentFromWebApp -&gt; Icons.Default.Laptop
</a><a href="#h101-0-98" id="h101-0-98" class="d">-                                        sentFromIosDevice -&gt; appleLogo
</a><a href="#h101-0-99" id="h101-0-99" class="d">-                                        else -&gt; Icons.Default.Android
</a><a href="#h101-0-100" id="h101-0-100" class="d">-                                    },
</a><a href="#h101-0-101" id="h101-0-101" class="d">-                                    colorFilter = ColorFilter.tint(Color.Green),
</a><a href="#h101-0-102" id="h101-0-102" class="d">-                                    contentDescription = null,
</a><a href="#h101-0-103" id="h101-0-103" class="d">-                                    modifier = Modifier.size(15.dp)
</a><a href="#h101-0-104" id="h101-0-104" class="d">-                                )
</a><a href="#h101-0-105" id="h101-0-105" class="i">+                            val sentWithLocation by rememberAsyncMutableState(defaultValue = false) {
</a><a href="#h101-0-106" id="h101-0-106" class="i">+                                reader.getVarInt(4, 4, 11, 17, 5) != null
</a>                             }
<a href="#h101-0-108" id="h101-0-108" class="d">-                            if (hasEncryption &amp;&amp; messageIndicatorsConfig.contains(&quot;encryption_indicator&quot;)) {
</a><a href="#h101-0-109" id="h101-0-109" class="d">-                                Image(
</a><a href="#h101-0-110" id="h101-0-110" class="d">-                                    imageVector = Icons.Default.Lock,
</a><a href="#h101-0-111" id="h101-0-111" class="d">-                                    colorFilter = ColorFilter.tint(Color.Green),
</a><a href="#h101-0-112" id="h101-0-112" class="d">-                                    contentDescription = null,
</a><a href="#h101-0-113" id="h101-0-113" class="d">-                                    modifier = Modifier.size(15.dp)
</a><a href="#h101-0-114" id="h101-0-114" class="d">-                                )
</a><a href="#h101-0-115" id="h101-0-115" class="i">+                            val sentUsingOvfEditor by rememberAsyncMutableState(defaultValue = false) {
</a><a href="#h101-0-116" id="h101-0-116" class="i">+                                (reader.getString(4, 4, 11, 12, 1) ?: reader.getString(4, 4, 11, 13, 4, 1, 2, 12, 20, 1)) == &quot;c13129f7-fe4a-44c4-9b9d-e0b26fee8f82&quot;
</a>                             }
<a href="#h101-0-118" id="h101-0-118" class="d">-                            if (sentUsingDirectorMode &amp;&amp; messageIndicatorsConfig.contains(&quot;director_mode_indicator&quot;)) {
</a><a href="#h101-0-119" id="h101-0-119" class="d">-                                Image(
</a><a href="#h101-0-120" id="h101-0-120" class="d">-                                    imageVector = Icons.Default.Edit,
</a><a href="#h101-0-121" id="h101-0-121" class="d">-                                    colorFilter = ColorFilter.tint(Color.Red),
</a><a href="#h101-0-122" id="h101-0-122" class="d">-                                    contentDescription = null,
</a><a href="#h101-0-123" id="h101-0-123" class="d">-                                    modifier = Modifier.size(15.dp)
</a><a href="#h101-0-124" id="h101-0-124" class="d">-                                )
</a><a href="#h101-0-125" id="h101-0-125" class="i">+                            val sentUsingDirectorMode by rememberAsyncMutableState(defaultValue = false) {
</a><a href="#h101-0-126" id="h101-0-126" class="i">+                                reader.followPath(4, 4, 11, 28)?.let {
</a><a href="#h101-0-127" id="h101-0-127" class="i">+                                    (it.getVarInt(1) to it.getVarInt(2)) == (0L to 0L)
</a><a href="#h101-0-128" id="h101-0-128" class="i">+                                } == true || reader.getByteArray(4, 4, 11, 13, 4, 1, 2, 12, 27, 1) != null
</a>                             }
<a href="#h101-0-130" id="h101-0-130" class="d">-                            if (sentUsingOvfEditor &amp;&amp; messageIndicatorsConfig.contains(&quot;ovf_editor_indicator&quot;)) {
</a><a href="#h101-0-131" id="h101-0-131" class="d">-                                Text(
</a><a href="#h101-0-132" id="h101-0-132" class="d">-                                    text = &quot;OVF&quot;,
</a><a href="#h101-0-133" id="h101-0-133" class="d">-                                    color = Color.Red,
</a><a href="#h101-0-134" id="h101-0-134" class="d">-                                    fontWeight = FontWeight.ExtraBold,
</a><a href="#h101-0-135" id="h101-0-135" class="d">-                                    fontSize = 10.sp,
</a><a href="#h101-0-136" id="h101-0-136" class="d">-                                )
</a><a href="#h101-0-137" id="h101-0-137" class="i">+
</a><a href="#h101-0-138" id="h101-0-138" class="i">+                            Row(
</a><a href="#h101-0-139" id="h101-0-139" class="i">+                                verticalAlignment = Alignment.CenterVertically
</a><a href="#h101-0-140" id="h101-0-140" class="i">+                            ) {
</a><a href="#h101-0-141" id="h101-0-141" class="i">+                                if (sentWithLocation &amp;&amp; messageIndicatorsConfig.contains(&quot;location_indicator&quot;)) {
</a><a href="#h101-0-142" id="h101-0-142" class="i">+                                    Image(
</a><a href="#h101-0-143" id="h101-0-143" class="i">+                                        imageVector = Icons.Default.LocationOn,
</a><a href="#h101-0-144" id="h101-0-144" class="i">+                                        colorFilter = ColorFilter.tint(Color.Green),
</a><a href="#h101-0-145" id="h101-0-145" class="i">+                                        contentDescription = null,
</a><a href="#h101-0-146" id="h101-0-146" class="i">+                                        modifier = Modifier.size(15.dp)
</a><a href="#h101-0-147" id="h101-0-147" class="i">+                                    )
</a><a href="#h101-0-148" id="h101-0-148" class="i">+                                }
</a><a href="#h101-0-149" id="h101-0-149" class="i">+                                if (messageIndicatorsConfig.contains(&quot;platform_indicator&quot;)) {
</a><a href="#h101-0-150" id="h101-0-150" class="i">+                                    Image(
</a><a href="#h101-0-151" id="h101-0-151" class="i">+                                        imageVector = when {
</a><a href="#h101-0-152" id="h101-0-152" class="i">+                                            sentFromWebApp -&gt; Icons.Default.Laptop
</a><a href="#h101-0-153" id="h101-0-153" class="i">+                                            sentFromIosDevice -&gt; appleLogo
</a><a href="#h101-0-154" id="h101-0-154" class="i">+                                            else -&gt; Icons.Default.Android
</a><a href="#h101-0-155" id="h101-0-155" class="i">+                                        },
</a><a href="#h101-0-156" id="h101-0-156" class="i">+                                        colorFilter = ColorFilter.tint(Color.Green),
</a><a href="#h101-0-157" id="h101-0-157" class="i">+                                        contentDescription = null,
</a><a href="#h101-0-158" id="h101-0-158" class="i">+                                        modifier = Modifier.size(15.dp)
</a><a href="#h101-0-159" id="h101-0-159" class="i">+                                    )
</a><a href="#h101-0-160" id="h101-0-160" class="i">+                                }
</a><a href="#h101-0-161" id="h101-0-161" class="i">+                                if (hasEncryption &amp;&amp; messageIndicatorsConfig.contains(&quot;encryption_indicator&quot;)) {
</a><a href="#h101-0-162" id="h101-0-162" class="i">+                                    Image(
</a><a href="#h101-0-163" id="h101-0-163" class="i">+                                        imageVector = Icons.Default.Lock,
</a><a href="#h101-0-164" id="h101-0-164" class="i">+                                        colorFilter = ColorFilter.tint(Color.Green),
</a><a href="#h101-0-165" id="h101-0-165" class="i">+                                        contentDescription = null,
</a><a href="#h101-0-166" id="h101-0-166" class="i">+                                        modifier = Modifier.size(15.dp)
</a><a href="#h101-0-167" id="h101-0-167" class="i">+                                    )
</a><a href="#h101-0-168" id="h101-0-168" class="i">+                                }
</a><a href="#h101-0-169" id="h101-0-169" class="i">+                                if (sentUsingDirectorMode &amp;&amp; messageIndicatorsConfig.contains(&quot;director_mode_indicator&quot;)) {
</a><a href="#h101-0-170" id="h101-0-170" class="i">+                                    Image(
</a><a href="#h101-0-171" id="h101-0-171" class="i">+                                        imageVector = Icons.Default.Edit,
</a><a href="#h101-0-172" id="h101-0-172" class="i">+                                        colorFilter = ColorFilter.tint(Color.Red),
</a><a href="#h101-0-173" id="h101-0-173" class="i">+                                        contentDescription = null,
</a><a href="#h101-0-174" id="h101-0-174" class="i">+                                        modifier = Modifier.size(15.dp)
</a><a href="#h101-0-175" id="h101-0-175" class="i">+                                    )
</a><a href="#h101-0-176" id="h101-0-176" class="i">+                                }
</a><a href="#h101-0-177" id="h101-0-177" class="i">+                                if (sentUsingOvfEditor &amp;&amp; messageIndicatorsConfig.contains(&quot;ovf_editor_indicator&quot;)) {
</a><a href="#h101-0-178" id="h101-0-178" class="i">+                                    Text(
</a><a href="#h101-0-179" id="h101-0-179" class="i">+                                        text = &quot;OVF&quot;,
</a><a href="#h101-0-180" id="h101-0-180" class="i">+                                        color = Color.Red,
</a><a href="#h101-0-181" id="h101-0-181" class="i">+                                        fontWeight = FontWeight.ExtraBold,
</a><a href="#h101-0-182" id="h101-0-182" class="i">+                                        fontSize = 10.sp,
</a><a href="#h101-0-183" id="h101-0-183" class="i">+                                    )
</a><a href="#h101-0-184" id="h101-0-184" class="i">+                                }
</a>                             }
                         }
<a href="#h101-0-187" id="h101-0-187" class="i">+                    }.apply {
</a><a href="#h101-0-188" id="h101-0-188" class="i">+                        tag = messageInfoTag
</a><a href="#h101-0-189" id="h101-0-189" class="i">+                        addOnLayoutChangeListener { _, left, _, right, _, _, _, _, _ -&gt;
</a><a href="#h101-0-190" id="h101-0-190" class="i">+                            layout(left, 0, right, 0)
</a><a href="#h101-0-191" id="h101-0-191" class="i">+                        }
</a><a href="#h101-0-192" id="h101-0-192" class="i">+                        setPadding(0, 0, 0, -(50 * event.view.resources.displayMetrics.density).toInt())
</a><a href="#h101-0-193" id="h101-0-193" class="i">+                        layoutParams = LinearLayout.LayoutParams(
</a><a href="#h101-0-194" id="h101-0-194" class="i">+                            LinearLayout.LayoutParams.MATCH_PARENT,
</a><a href="#h101-0-195" id="h101-0-195" class="i">+                            LinearLayout.LayoutParams.WRAP_CONTENT
</a><a href="#h101-0-196" id="h101-0-196" class="i">+                        )
</a><a href="#h101-0-197" id="h101-0-197" class="i">+                        parentLinearLayout.addView(this)
</a>                     }
<a href="#h101-0-199" id="h101-0-199" class="d">-                }.apply {
</a><a href="#h101-0-200" id="h101-0-200" class="d">-                    tag = messageInfoTag
</a><a href="#h101-0-201" id="h101-0-201" class="d">-                    addOnLayoutChangeListener { _, left, _, right, _, _, _, _, _ -&gt;
</a><a href="#h101-0-202" id="h101-0-202" class="d">-                        layout(left, 0, right, 0)
</a><a href="#h101-0-203" id="h101-0-203" class="d">-                    }
</a><a href="#h101-0-204" id="h101-0-204" class="d">-                    setPadding(0, 0, 0, -(50 * event.view.resources.displayMetrics.density).toInt())
</a><a href="#h101-0-205" id="h101-0-205" class="d">-                    layoutParams = LinearLayout.LayoutParams(
</a><a href="#h101-0-206" id="h101-0-206" class="d">-                        LinearLayout.LayoutParams.MATCH_PARENT,
</a><a href="#h101-0-207" id="h101-0-207" class="d">-                        LinearLayout.LayoutParams.WRAP_CONTENT
</a><a href="#h101-0-208" id="h101-0-208" class="d">-                    )
</a><a href="#h101-0-209" id="h101-0-209" class="d">-                    parentLinearLayout.addView(this)
</a>                 }
             }
         }
<b>diff --git a/<a id="h102" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/ui/OldBitmojiSelfie.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/ui/OldBitmojiSelfie.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/ui/OldBitmojiSelfie.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/ui/OldBitmojiSelfie.kt</a></b>
<a href="#h102-0" id="h102-0" class="h">@@ -4,9 +4,8 @@ import android.net.Uri
</a> import me.rhunk.snapenhance.common.util.snap.BitmojiSelfie
 import me.rhunk.snapenhance.core.event.events.impl.NetworkApiRequestEvent
 import me.rhunk.snapenhance.core.features.Feature
<a href="#h102-0-3" id="h102-0-3" class="d">-import me.rhunk.snapenhance.core.features.FeatureLoadParams
</a> 
<a href="#h102-0-5" id="h102-0-5" class="d">-class OldBitmojiSelfie : Feature(&quot;OldBitmojiSelfie&quot;, loadParams = FeatureLoadParams.INIT_SYNC) {
</a><a href="#h102-0-6" id="h102-0-6" class="i">+class OldBitmojiSelfie : Feature(&quot;OldBitmojiSelfie&quot;) {
</a>     override fun init() {
         val urlPrefixes = arrayOf(&quot;https://images.bitmoji.com/3d/render/&quot;, &quot;https://cf-st.sc-cdn.net/3d/render/&quot;)
         val oldBitmojiSelfie = context.config.userInterface.oldBitmojiSelfie.getNullable() ?: return
<b>diff --git a/<a id="h103" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/ui/PinConversations.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/ui/PinConversations.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/ui/PinConversations.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/ui/PinConversations.kt</a></b>
<a href="#h103-0" id="h103-0" class="h">@@ -2,7 +2,6 @@ package me.rhunk.snapenhance.core.features.impl.ui
</a> 
 import me.rhunk.snapenhance.common.data.MessagingRuleType
 import me.rhunk.snapenhance.common.data.RuleState
<a href="#h103-0-3" id="h103-0-3" class="d">-import me.rhunk.snapenhance.core.features.FeatureLoadParams
</a> import me.rhunk.snapenhance.core.features.MessagingRuleFeature
 import me.rhunk.snapenhance.core.util.hook.HookStage
 import me.rhunk.snapenhance.core.util.hook.Hooker
<a href="#h103-1" id="h103-1" class="h">@@ -12,8 +11,8 @@ import me.rhunk.snapenhance.core.util.ktx.getObjectField
</a> import me.rhunk.snapenhance.core.util.ktx.setObjectField
 import me.rhunk.snapenhance.core.wrapper.impl.SnapUUID
 
<a href="#h103-1-3" id="h103-1-3" class="d">-class PinConversations : MessagingRuleFeature(&quot;PinConversations&quot;, MessagingRuleType.PIN_CONVERSATION, loadParams = FeatureLoadParams.ACTIVITY_CREATE_SYNC) {
</a><a href="#h103-1-4" id="h103-1-4" class="d">-    override fun onActivityCreate() {
</a><a href="#h103-1-5" id="h103-1-5" class="i">+class PinConversations : MessagingRuleFeature(&quot;PinConversations&quot;, MessagingRuleType.PIN_CONVERSATION) {
</a><a href="#h103-1-6" id="h103-1-6" class="i">+    override fun init() {
</a>         if (!context.config.messaging.unlimitedConversationPinning.get()) return
 
         context.classCache.feedManager.hook(&quot;setPinnedConversationStatus&quot;, HookStage.BEFORE) { param -&gt;
<b>diff --git a/<a id="h104" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/ui/SnapPreview.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/ui/SnapPreview.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/ui/SnapPreview.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/ui/SnapPreview.kt</a></b>
<a href="#h104-0" id="h104-0" class="h">@@ -10,7 +10,6 @@ import me.rhunk.snapenhance.common.data.ContentType
</a> import me.rhunk.snapenhance.common.util.protobuf.ProtoReader
 import me.rhunk.snapenhance.core.event.events.impl.BindViewEvent
 import me.rhunk.snapenhance.core.features.Feature
<a href="#h104-0-3" id="h104-0-3" class="d">-import me.rhunk.snapenhance.core.features.FeatureLoadParams
</a> import me.rhunk.snapenhance.core.ui.addForegroundDrawable
 import me.rhunk.snapenhance.core.ui.removeForegroundDrawable
 import me.rhunk.snapenhance.core.util.EvictingMap
<a href="#h104-1" id="h104-1" class="h">@@ -22,7 +21,7 @@ import me.rhunk.snapenhance.core.util.media.PreviewUtils
</a> import me.rhunk.snapenhance.mapper.impl.CallbackMapper
 import java.io.File
 
<a href="#h104-1-3" id="h104-1-3" class="d">-class SnapPreview : Feature(&quot;SnapPreview&quot;, loadParams = FeatureLoadParams.INIT_SYNC or FeatureLoadParams.ACTIVITY_CREATE_SYNC) {
</a><a href="#h104-1-4" id="h104-1-4" class="i">+class SnapPreview : Feature(&quot;SnapPreview&quot;) {
</a>     private val mediaFileCache = EvictingMap&lt;String, File&gt;(500) // mMediaId =&gt; mediaFile
     private val bitmapCache = EvictingMap&lt;String, Bitmap&gt;(50) // filePath =&gt; bitmap
 
<a href="#h104-2" id="h104-2" class="h">@@ -44,48 +43,46 @@ class SnapPreview : Feature(&quot;SnapPreview&quot;, loadParams = FeatureLoadParams.INIT_S
</a>                 mediaFileCache[mediaId.substringAfter(&quot;-&quot;)] = File(filePath.toString())
             }
         }
<a href="#h104-2-3" id="h104-2-3" class="d">-    }
</a> 
<a href="#h104-2-5" id="h104-2-5" class="d">-    @SuppressLint(&quot;DiscouragedApi&quot;)
</a><a href="#h104-2-6" id="h104-2-6" class="d">-    override fun onActivityCreate() {
</a><a href="#h104-2-7" id="h104-2-7" class="d">-        if (!isEnabled) return
</a><a href="#h104-2-8" id="h104-2-8" class="d">-        val chatMediaCardHeight = context.resources.getDimens(&quot;chat_media_card_height&quot;)
</a><a href="#h104-2-9" id="h104-2-9" class="d">-        val chatMediaCardSnapMargin = context.resources.getDimens(&quot;chat_media_card_snap_margin&quot;)
</a><a href="#h104-2-10" id="h104-2-10" class="d">-        val chatMediaCardSnapMarginStartSdl = context.resources.getDimens(&quot;chat_media_card_snap_margin_start_sdl&quot;)
</a><a href="#h104-2-11" id="h104-2-11" class="i">+        onNextActivityCreate {
</a><a href="#h104-2-12" id="h104-2-12" class="i">+            val chatMediaCardHeight = context.resources.getDimens(&quot;chat_media_card_height&quot;)
</a><a href="#h104-2-13" id="h104-2-13" class="i">+            val chatMediaCardSnapMargin = context.resources.getDimens(&quot;chat_media_card_snap_margin&quot;)
</a><a href="#h104-2-14" id="h104-2-14" class="i">+            val chatMediaCardSnapMarginStartSdl = context.resources.getDimens(&quot;chat_media_card_snap_margin_start_sdl&quot;)
</a> 
<a href="#h104-2-16" id="h104-2-16" class="d">-        fun decodeMedia(file: File) = runCatching {
</a><a href="#h104-2-17" id="h104-2-17" class="d">-            bitmapCache.getOrPut(file.absolutePath) {
</a><a href="#h104-2-18" id="h104-2-18" class="d">-                PreviewUtils.resizeBitmap(
</a><a href="#h104-2-19" id="h104-2-19" class="d">-                    PreviewUtils.createPreviewFromFile(file) ?: return@runCatching null,
</a><a href="#h104-2-20" id="h104-2-20" class="d">-                    chatMediaCardHeight - chatMediaCardSnapMargin,
</a><a href="#h104-2-21" id="h104-2-21" class="d">-                    chatMediaCardHeight - chatMediaCardSnapMargin
</a><a href="#h104-2-22" id="h104-2-22" class="d">-                )
</a><a href="#h104-2-23" id="h104-2-23" class="d">-            }
</a><a href="#h104-2-24" id="h104-2-24" class="d">-        }.getOrNull()
</a><a href="#h104-2-25" id="h104-2-25" class="i">+            fun decodeMedia(file: File) = runCatching {
</a><a href="#h104-2-26" id="h104-2-26" class="i">+                bitmapCache.getOrPut(file.absolutePath) {
</a><a href="#h104-2-27" id="h104-2-27" class="i">+                    PreviewUtils.resizeBitmap(
</a><a href="#h104-2-28" id="h104-2-28" class="i">+                        PreviewUtils.createPreviewFromFile(file) ?: return@runCatching null,
</a><a href="#h104-2-29" id="h104-2-29" class="i">+                        chatMediaCardHeight - chatMediaCardSnapMargin,
</a><a href="#h104-2-30" id="h104-2-30" class="i">+                        chatMediaCardHeight - chatMediaCardSnapMargin
</a><a href="#h104-2-31" id="h104-2-31" class="i">+                    )
</a><a href="#h104-2-32" id="h104-2-32" class="i">+                }
</a><a href="#h104-2-33" id="h104-2-33" class="i">+            }.getOrNull()
</a> 
<a href="#h104-2-35" id="h104-2-35" class="d">-        context.event.subscribe(BindViewEvent::class) { event -&gt;
</a><a href="#h104-2-36" id="h104-2-36" class="d">-            event.chatMessage { _, messageId -&gt;
</a><a href="#h104-2-37" id="h104-2-37" class="d">-                event.view.removeForegroundDrawable(&quot;snapPreview&quot;)
</a><a href="#h104-2-38" id="h104-2-38" class="i">+            context.event.subscribe(BindViewEvent::class) { event -&gt;
</a><a href="#h104-2-39" id="h104-2-39" class="i">+                event.chatMessage { _, messageId -&gt;
</a><a href="#h104-2-40" id="h104-2-40" class="i">+                    event.view.removeForegroundDrawable(&quot;snapPreview&quot;)
</a> 
<a href="#h104-2-42" id="h104-2-42" class="d">-                val message = context.database.getConversationMessageFromId(messageId.toLong()) ?: return@chatMessage
</a><a href="#h104-2-43" id="h104-2-43" class="d">-                val messageReader = ProtoReader(message.messageContent ?: return@chatMessage)
</a><a href="#h104-2-44" id="h104-2-44" class="d">-                val contentType = ContentType.fromMessageContainer(messageReader.followPath(4, 4))
</a><a href="#h104-2-45" id="h104-2-45" class="i">+                    val message = context.database.getConversationMessageFromId(messageId.toLong()) ?: return@chatMessage
</a><a href="#h104-2-46" id="h104-2-46" class="i">+                    val messageReader = ProtoReader(message.messageContent ?: return@chatMessage)
</a><a href="#h104-2-47" id="h104-2-47" class="i">+                    val contentType = ContentType.fromMessageContainer(messageReader.followPath(4, 4))
</a> 
<a href="#h104-2-49" id="h104-2-49" class="d">-                if (contentType != ContentType.SNAP || message.isSaved == 1) return@chatMessage
</a><a href="#h104-2-50" id="h104-2-50" class="i">+                    if (contentType != ContentType.SNAP || message.isSaved == 1) return@chatMessage
</a> 
<a href="#h104-2-52" id="h104-2-52" class="d">-                val mediaIdKey = messageReader.getString(4, 5, 1, 3, 2, 2) ?: return@chatMessage
</a><a href="#h104-2-53" id="h104-2-53" class="i">+                    val mediaIdKey = messageReader.getString(4, 5, 1, 3, 2, 2) ?: return@chatMessage
</a> 
<a href="#h104-2-55" id="h104-2-55" class="d">-                event.view.addForegroundDrawable(&quot;snapPreview&quot;, ShapeDrawable(object: Shape() {
</a><a href="#h104-2-56" id="h104-2-56" class="d">-                    override fun draw(canvas: Canvas, paint: Paint) {
</a><a href="#h104-2-57" id="h104-2-57" class="d">-                        val bitmap = mediaFileCache[mediaIdKey]?.let { decodeMedia(it) } ?: return
</a><a href="#h104-2-58" id="h104-2-58" class="i">+                    event.view.addForegroundDrawable(&quot;snapPreview&quot;, ShapeDrawable(object: Shape() {
</a><a href="#h104-2-59" id="h104-2-59" class="i">+                        override fun draw(canvas: Canvas, paint: Paint) {
</a><a href="#h104-2-60" id="h104-2-60" class="i">+                            val bitmap = mediaFileCache[mediaIdKey]?.let { decodeMedia(it) } ?: return
</a> 
<a href="#h104-2-62" id="h104-2-62" class="d">-                        canvas.drawBitmap(bitmap,
</a><a href="#h104-2-63" id="h104-2-63" class="d">-                            canvas.width.toFloat() - bitmap.width - chatMediaCardSnapMarginStartSdl.toFloat() - chatMediaCardSnapMargin.toFloat(),
</a><a href="#h104-2-64" id="h104-2-64" class="d">-                            (canvas.height - bitmap.height) / 2f,
</a><a href="#h104-2-65" id="h104-2-65" class="d">-                            null
</a><a href="#h104-2-66" id="h104-2-66" class="d">-                        )
</a><a href="#h104-2-67" id="h104-2-67" class="d">-                    }
</a><a href="#h104-2-68" id="h104-2-68" class="d">-                }))
</a><a href="#h104-2-69" id="h104-2-69" class="i">+                            canvas.drawBitmap(bitmap,
</a><a href="#h104-2-70" id="h104-2-70" class="i">+                                canvas.width.toFloat() - bitmap.width - chatMediaCardSnapMarginStartSdl.toFloat() - chatMediaCardSnapMargin.toFloat(),
</a><a href="#h104-2-71" id="h104-2-71" class="i">+                                (canvas.height - bitmap.height) / 2f,
</a><a href="#h104-2-72" id="h104-2-72" class="i">+                                null
</a><a href="#h104-2-73" id="h104-2-73" class="i">+                            )
</a><a href="#h104-2-74" id="h104-2-74" class="i">+                        }
</a><a href="#h104-2-75" id="h104-2-75" class="i">+                    }))
</a><a href="#h104-2-76" id="h104-2-76" class="i">+                }
</a>             }
         }
     }
<b>diff --git a/<a id="h105" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/ui/SpotlightCommentsUsername.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/ui/SpotlightCommentsUsername.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/ui/SpotlightCommentsUsername.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/ui/SpotlightCommentsUsername.kt</a></b>
<a href="#h105-0" id="h105-0" class="h">@@ -7,47 +7,48 @@ import kotlinx.coroutines.launch
</a> import kotlinx.coroutines.withContext
 import me.rhunk.snapenhance.core.event.events.impl.BindViewEvent
 import me.rhunk.snapenhance.core.features.Feature
<a href="#h105-0-3" id="h105-0-3" class="d">-import me.rhunk.snapenhance.core.features.FeatureLoadParams
</a> import me.rhunk.snapenhance.core.features.impl.messaging.Messaging
 import me.rhunk.snapenhance.core.util.EvictingMap
 import me.rhunk.snapenhance.core.util.ktx.getId
 
<a href="#h105-0-8" id="h105-0-8" class="d">-class SpotlightCommentsUsername : Feature(&quot;SpotlightCommentsUsername&quot;, loadParams =  FeatureLoadParams.ACTIVITY_CREATE_SYNC) {
</a><a href="#h105-0-9" id="h105-0-9" class="i">+class SpotlightCommentsUsername : Feature(&quot;SpotlightCommentsUsername&quot;) {
</a>     private val usernameCache = EvictingMap&lt;String, String&gt;(150)
 
     @SuppressLint(&quot;SetTextI18n&quot;)
<a href="#h105-0-13" id="h105-0-13" class="d">-    override fun onActivityCreate() {
</a><a href="#h105-0-14" id="h105-0-14" class="i">+    override fun init() {
</a>         if (!context.config.global.spotlightCommentsUsername.get()) return
 
<a href="#h105-0-17" id="h105-0-17" class="d">-        val messaging = context.feature(Messaging::class)
</a><a href="#h105-0-18" id="h105-0-18" class="d">-        val commentsCreatorBadgeTimestampId = context.resources.getId(&quot;comments_creator_badge_timestamp&quot;)
</a><a href="#h105-0-19" id="h105-0-19" class="i">+        onNextActivityCreate(defer = true) {
</a><a href="#h105-0-20" id="h105-0-20" class="i">+            val messaging = context.feature(Messaging::class)
</a><a href="#h105-0-21" id="h105-0-21" class="i">+            val commentsCreatorBadgeTimestampId = context.resources.getId(&quot;comments_creator_badge_timestamp&quot;)
</a> 
<a href="#h105-0-23" id="h105-0-23" class="d">-        context.event.subscribe(BindViewEvent::class) { event -&gt;
</a><a href="#h105-0-24" id="h105-0-24" class="d">-            val commentsCreatorBadgeTimestamp = event.view.findViewById&lt;TextView&gt;(commentsCreatorBadgeTimestampId) ?: return@subscribe
</a><a href="#h105-0-25" id="h105-0-25" class="i">+            context.event.subscribe(BindViewEvent::class) { event -&gt;
</a><a href="#h105-0-26" id="h105-0-26" class="i">+                val commentsCreatorBadgeTimestamp = event.view.findViewById&lt;TextView&gt;(commentsCreatorBadgeTimestampId) ?: return@subscribe
</a> 
<a href="#h105-0-28" id="h105-0-28" class="d">-            val posterUserId = event.prevModel.toString().takeIf { it.startsWith(&quot;Comment&quot;) }
</a><a href="#h105-0-29" id="h105-0-29" class="d">-                ?.substringAfter(&quot;posterUserId=&quot;)?.substringBefore(&quot;,&quot;)?.substringBefore(&quot;)&quot;) ?: return@subscribe
</a><a href="#h105-0-30" id="h105-0-30" class="i">+                val posterUserId = event.prevModel.toString().takeIf { it.startsWith(&quot;Comment&quot;) }
</a><a href="#h105-0-31" id="h105-0-31" class="i">+                    ?.substringAfter(&quot;posterUserId=&quot;)?.substringBefore(&quot;,&quot;)?.substringBefore(&quot;)&quot;) ?: return@subscribe
</a> 
<a href="#h105-0-33" id="h105-0-33" class="d">-            fun setUsername(username: String) {
</a><a href="#h105-0-34" id="h105-0-34" class="d">-                usernameCache[posterUserId] = username
</a><a href="#h105-0-35" id="h105-0-35" class="d">-                if (commentsCreatorBadgeTimestamp.text.contains(username)) return
</a><a href="#h105-0-36" id="h105-0-36" class="d">-                commentsCreatorBadgeTimestamp.text = &quot; (${username})&quot; + commentsCreatorBadgeTimestamp.text.toString()
</a><a href="#h105-0-37" id="h105-0-37" class="d">-            }
</a><a href="#h105-0-38" id="h105-0-38" class="i">+                fun setUsername(username: String) {
</a><a href="#h105-0-39" id="h105-0-39" class="i">+                    usernameCache[posterUserId] = username
</a><a href="#h105-0-40" id="h105-0-40" class="i">+                    if (commentsCreatorBadgeTimestamp.text.contains(username)) return
</a><a href="#h105-0-41" id="h105-0-41" class="i">+                    commentsCreatorBadgeTimestamp.text = &quot; (${username})&quot; + commentsCreatorBadgeTimestamp.text.toString()
</a><a href="#h105-0-42" id="h105-0-42" class="i">+                }
</a> 
<a href="#h105-0-44" id="h105-0-44" class="d">-            usernameCache[posterUserId]?.let {
</a><a href="#h105-0-45" id="h105-0-45" class="d">-                setUsername(it)
</a><a href="#h105-0-46" id="h105-0-46" class="d">-                return@subscribe
</a><a href="#h105-0-47" id="h105-0-47" class="d">-            }
</a><a href="#h105-0-48" id="h105-0-48" class="i">+                usernameCache[posterUserId]?.let {
</a><a href="#h105-0-49" id="h105-0-49" class="i">+                    setUsername(it)
</a><a href="#h105-0-50" id="h105-0-50" class="i">+                    return@subscribe
</a><a href="#h105-0-51" id="h105-0-51" class="i">+                }
</a> 
<a href="#h105-0-53" id="h105-0-53" class="d">-            context.coroutineScope.launch {
</a><a href="#h105-0-54" id="h105-0-54" class="d">-                val username = runCatching {
</a><a href="#h105-0-55" id="h105-0-55" class="d">-                    messaging.fetchSnapchatterInfos(listOf(posterUserId)).firstOrNull()
</a><a href="#h105-0-56" id="h105-0-56" class="d">-                }.onFailure {
</a><a href="#h105-0-57" id="h105-0-57" class="d">-                    context.log.error(&quot;Failed to fetch snapchatter info for user $posterUserId&quot;, it)
</a><a href="#h105-0-58" id="h105-0-58" class="d">-                }.getOrNull()?.username ?: return@launch
</a><a href="#h105-0-59" id="h105-0-59" class="i">+                context.coroutineScope.launch {
</a><a href="#h105-0-60" id="h105-0-60" class="i">+                    val username = runCatching {
</a><a href="#h105-0-61" id="h105-0-61" class="i">+                        messaging.fetchSnapchatterInfos(listOf(posterUserId)).firstOrNull()
</a><a href="#h105-0-62" id="h105-0-62" class="i">+                    }.onFailure {
</a><a href="#h105-0-63" id="h105-0-63" class="i">+                        context.log.error(&quot;Failed to fetch snapchatter info for user $posterUserId&quot;, it)
</a><a href="#h105-0-64" id="h105-0-64" class="i">+                    }.getOrNull()?.username ?: return@launch
</a> 
<a href="#h105-0-66" id="h105-0-66" class="d">-                withContext(Dispatchers.Main) {
</a><a href="#h105-0-67" id="h105-0-67" class="d">-                    setUsername(username)
</a><a href="#h105-0-68" id="h105-0-68" class="i">+                    withContext(Dispatchers.Main) {
</a><a href="#h105-0-69" id="h105-0-69" class="i">+                        setUsername(username)
</a><a href="#h105-0-70" id="h105-0-70" class="i">+                    }
</a>                 }
             }
         }
<b>diff --git a/<a id="h106" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/ui/StealthModeIndicator.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/ui/StealthModeIndicator.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/ui/StealthModeIndicator.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/ui/StealthModeIndicator.kt</a></b>
<a href="#h106-0" id="h106-0" class="h">@@ -4,12 +4,12 @@ import android.graphics.Canvas
</a> import android.graphics.Paint
 import android.graphics.drawable.ShapeDrawable
 import android.graphics.drawable.shapes.Shape
<a href="#h106-0-3" id="h106-0-3" class="i">+import androidx.core.content.res.use
</a> import kotlinx.coroutines.Dispatchers
 import kotlinx.coroutines.launch
 import kotlinx.coroutines.withContext
 import me.rhunk.snapenhance.core.event.events.impl.BindViewEvent
 import me.rhunk.snapenhance.core.features.Feature
<a href="#h106-0-9" id="h106-0-9" class="d">-import me.rhunk.snapenhance.core.features.FeatureLoadParams
</a> import me.rhunk.snapenhance.core.features.impl.spying.StealthMode
 import me.rhunk.snapenhance.core.ui.addForegroundDrawable
 import me.rhunk.snapenhance.core.ui.removeForegroundDrawable
<a href="#h106-1" id="h106-1" class="h">@@ -17,7 +17,7 @@ import me.rhunk.snapenhance.core.util.EvictingMap
</a> import me.rhunk.snapenhance.core.util.ktx.getDimens
 import me.rhunk.snapenhance.core.util.ktx.getIdentifier
 
<a href="#h106-1-3" id="h106-1-3" class="d">-class StealthModeIndicator : Feature(&quot;StealthModeIndicator&quot;, loadParams = FeatureLoadParams.ACTIVITY_CREATE_SYNC) {
</a><a href="#h106-1-4" id="h106-1-4" class="i">+class StealthModeIndicator : Feature(&quot;StealthModeIndicator&quot;) {
</a>     private val stealthMode by lazy { context.feature(StealthMode::class) }
     private val listeners = EvictingMap&lt;String, (Boolean) -&gt; Unit&gt;(100)
 
<a href="#h106-2" id="h106-2" class="h">@@ -30,46 +30,48 @@ class StealthModeIndicator : Feature(&quot;StealthModeIndicator&quot;, loadParams = Featur
</a>         }
     }
 
<a href="#h106-2-3" id="h106-2-3" class="d">-    override fun onActivityCreate() {
</a><a href="#h106-2-4" id="h106-2-4" class="i">+    override fun init() {
</a>         if (!context.config.userInterface.stealthModeIndicator.get()) return
 
<a href="#h106-2-7" id="h106-2-7" class="d">-        val secondaryTextSize = context.resources.getDimens(&quot;ff_feed_cell_secondary_text_size&quot;).toFloat()
</a><a href="#h106-2-8" id="h106-2-8" class="d">-        val sigColorTextPrimary = context.mainActivity!!.obtainStyledAttributes(
</a><a href="#h106-2-9" id="h106-2-9" class="d">-            intArrayOf(context.resources.getIdentifier(&quot;sigColorTextPrimary&quot;, &quot;attr&quot;))
</a><a href="#h106-2-10" id="h106-2-10" class="d">-        ).use { it.getColor(0, 0) }
</a><a href="#h106-2-11" id="h106-2-11" class="i">+        onNextActivityCreate {
</a><a href="#h106-2-12" id="h106-2-12" class="i">+            val secondaryTextSize = context.resources.getDimens(&quot;ff_feed_cell_secondary_text_size&quot;).toFloat()
</a><a href="#h106-2-13" id="h106-2-13" class="i">+            val sigColorTextPrimary = context.mainActivity!!.obtainStyledAttributes(
</a><a href="#h106-2-14" id="h106-2-14" class="i">+                intArrayOf(context.resources.getIdentifier(&quot;sigColorTextPrimary&quot;, &quot;attr&quot;))
</a><a href="#h106-2-15" id="h106-2-15" class="i">+            ).use { it.getColor(0, 0) }
</a> 
<a href="#h106-2-17" id="h106-2-17" class="d">-        stealthMode.addStateListener { conversationId, state -&gt;
</a><a href="#h106-2-18" id="h106-2-18" class="d">-            runCatching {
</a><a href="#h106-2-19" id="h106-2-19" class="d">-                listeners[conversationId]?.invoke(state)
</a><a href="#h106-2-20" id="h106-2-20" class="d">-            }.onFailure {
</a><a href="#h106-2-21" id="h106-2-21" class="d">-                context.log.error(&quot;Failed to update stealth mode indicator&quot;, it)
</a><a href="#h106-2-22" id="h106-2-22" class="d">-            }
</a><a href="#h106-2-23" id="h106-2-23" class="d">-        }
</a><a href="#h106-2-24" id="h106-2-24" class="d">-
</a><a href="#h106-2-25" id="h106-2-25" class="d">-        context.event.subscribe(BindViewEvent::class) { event -&gt;
</a><a href="#h106-2-26" id="h106-2-26" class="d">-            fun updateStealthIndicator(isStealth: Boolean = true) {
</a><a href="#h106-2-27" id="h106-2-27" class="d">-                event.view.removeForegroundDrawable(&quot;stealthModeIndicator&quot;)
</a><a href="#h106-2-28" id="h106-2-28" class="d">-                if (!isStealth || !event.view.isAttachedToWindow) return
</a><a href="#h106-2-29" id="h106-2-29" class="d">-                event.view.addForegroundDrawable(&quot;stealthModeIndicator&quot;, ShapeDrawable(object : Shape() {
</a><a href="#h106-2-30" id="h106-2-30" class="d">-                    override fun draw(canvas: Canvas, paint: Paint) {
</a><a href="#h106-2-31" id="h106-2-31" class="d">-                        paint.textSize = secondaryTextSize
</a><a href="#h106-2-32" id="h106-2-32" class="d">-                        paint.color = sigColorTextPrimary
</a><a href="#h106-2-33" id="h106-2-33" class="d">-                        canvas.drawText(
</a><a href="#h106-2-34" id="h106-2-34" class="d">-                            &quot;\uD83D\uDC7B&quot;,
</a><a href="#h106-2-35" id="h106-2-35" class="d">-                            0f,
</a><a href="#h106-2-36" id="h106-2-36" class="d">-                            canvas.height.toFloat() - secondaryTextSize / 2,
</a><a href="#h106-2-37" id="h106-2-37" class="d">-                            paint
</a><a href="#h106-2-38" id="h106-2-38" class="d">-                        )
</a><a href="#h106-2-39" id="h106-2-39" class="d">-                    }
</a><a href="#h106-2-40" id="h106-2-40" class="d">-                }))
</a><a href="#h106-2-41" id="h106-2-41" class="i">+            stealthMode.addStateListener { conversationId, state -&gt;
</a><a href="#h106-2-42" id="h106-2-42" class="i">+                runCatching {
</a><a href="#h106-2-43" id="h106-2-43" class="i">+                    listeners[conversationId]?.invoke(state)
</a><a href="#h106-2-44" id="h106-2-44" class="i">+                }.onFailure {
</a><a href="#h106-2-45" id="h106-2-45" class="i">+                    context.log.error(&quot;Failed to update stealth mode indicator&quot;, it)
</a><a href="#h106-2-46" id="h106-2-46" class="i">+                }
</a>             }
 
<a href="#h106-2-49" id="h106-2-49" class="d">-            event.friendFeedItem { conversationId -&gt;
</a><a href="#h106-2-50" id="h106-2-50" class="d">-                listeners[conversationId] = addStateListener@{ stealth -&gt;
</a><a href="#h106-2-51" id="h106-2-51" class="d">-                    updateStealthIndicator(stealth)
</a><a href="#h106-2-52" id="h106-2-52" class="i">+            context.event.subscribe(BindViewEvent::class) { event -&gt;
</a><a href="#h106-2-53" id="h106-2-53" class="i">+                fun updateStealthIndicator(isStealth: Boolean = true) {
</a><a href="#h106-2-54" id="h106-2-54" class="i">+                    event.view.removeForegroundDrawable(&quot;stealthModeIndicator&quot;)
</a><a href="#h106-2-55" id="h106-2-55" class="i">+                    if (!isStealth || !event.view.isAttachedToWindow) return
</a><a href="#h106-2-56" id="h106-2-56" class="i">+                    event.view.addForegroundDrawable(&quot;stealthModeIndicator&quot;, ShapeDrawable(object : Shape() {
</a><a href="#h106-2-57" id="h106-2-57" class="i">+                        override fun draw(canvas: Canvas, paint: Paint) {
</a><a href="#h106-2-58" id="h106-2-58" class="i">+                            paint.textSize = secondaryTextSize
</a><a href="#h106-2-59" id="h106-2-59" class="i">+                            paint.color = sigColorTextPrimary
</a><a href="#h106-2-60" id="h106-2-60" class="i">+                            canvas.drawText(
</a><a href="#h106-2-61" id="h106-2-61" class="i">+                                &quot;\uD83D\uDC7B&quot;,
</a><a href="#h106-2-62" id="h106-2-62" class="i">+                                0f,
</a><a href="#h106-2-63" id="h106-2-63" class="i">+                                canvas.height.toFloat() - secondaryTextSize / 2,
</a><a href="#h106-2-64" id="h106-2-64" class="i">+                                paint
</a><a href="#h106-2-65" id="h106-2-65" class="i">+                            )
</a><a href="#h106-2-66" id="h106-2-66" class="i">+                        }
</a><a href="#h106-2-67" id="h106-2-67" class="i">+                    }))
</a>                 }
<a href="#h106-2-69" id="h106-2-69" class="d">-                fetchStealthState(conversationId) { isStealth -&gt;
</a><a href="#h106-2-70" id="h106-2-70" class="d">-                    updateStealthIndicator(isStealth)
</a><a href="#h106-2-71" id="h106-2-71" class="i">+
</a><a href="#h106-2-72" id="h106-2-72" class="i">+                event.friendFeedItem { conversationId -&gt;
</a><a href="#h106-2-73" id="h106-2-73" class="i">+                    listeners[conversationId] = addStateListener@{ stealth -&gt;
</a><a href="#h106-2-74" id="h106-2-74" class="i">+                        updateStealthIndicator(stealth)
</a><a href="#h106-2-75" id="h106-2-75" class="i">+                    }
</a><a href="#h106-2-76" id="h106-2-76" class="i">+                    fetchStealthState(conversationId) { isStealth -&gt;
</a><a href="#h106-2-77" id="h106-2-77" class="i">+                        updateStealthIndicator(isStealth)
</a><a href="#h106-2-78" id="h106-2-78" class="i">+                    }
</a>                 }
             }
         }
<b>diff --git a/<a id="h107" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/ui/ViewAppearanceHelper.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/ui/ViewAppearanceHelper.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/ui/ViewAppearanceHelper.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/ui/ViewAppearanceHelper.kt</a></b>
<a href="#h107-0" id="h107-0" class="h">@@ -19,6 +19,7 @@ import android.view.View
</a> import android.view.ViewGroup
 import android.widget.Switch
 import android.widget.TextView
<a href="#h107-0-3" id="h107-0-3" class="i">+import androidx.core.content.res.use
</a> import me.rhunk.snapenhance.core.SnapEnhance
 import me.rhunk.snapenhance.core.util.ktx.getDimens
 import me.rhunk.snapenhance.core.util.ktx.getDimensFloat
<a href="#h107-1" id="h107-1" class="h">@@ -136,10 +137,10 @@ object ViewAppearanceHelper {
</a> 
         val sigColorTextPrimary = component.context.theme.obtainStyledAttributes(
             intArrayOf(resources.getIdentifier(&quot;sigColorTextPrimary&quot;, &quot;attr&quot;))
<a href="#h107-1-3" id="h107-1-3" class="d">-        ).getColor(0, 0)
</a><a href="#h107-1-4" id="h107-1-4" class="i">+        ).use { it.getColor(0, 0) }
</a>         val sigColorBackgroundSurface = component.context.theme.obtainStyledAttributes(
             intArrayOf(resources.getIdentifier(&quot;sigColorBackgroundSurface&quot;, &quot;attr&quot;))
<a href="#h107-1-7" id="h107-1-7" class="d">-        ).getColor(0, 0)
</a><a href="#h107-1-8" id="h107-1-8" class="i">+        ).use { it.getColor(0, 0) }
</a> 
         val actionSheetDefaultCellHeight = resources.getDimens(&quot;action_sheet_default_cell_height&quot;)
         val actionSheetCornerRadius = resources.getDimensFloat(&quot;action_sheet_corner_radius&quot;)
<b>diff --git a/<a id="h108" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/ui/menu/MenuViewInjector.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/ui/menu/MenuViewInjector.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/ui/menu/MenuViewInjector.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/ui/menu/MenuViewInjector.kt</a></b>
<a href="#h108-0" id="h108-0" class="h">@@ -9,7 +9,6 @@ import android.widget.LinearLayout
</a> import android.widget.ScrollView
 import me.rhunk.snapenhance.core.event.events.impl.AddViewEvent
 import me.rhunk.snapenhance.core.features.Feature
<a href="#h108-0-3" id="h108-0-3" class="d">-import me.rhunk.snapenhance.core.features.FeatureLoadParams
</a> import me.rhunk.snapenhance.core.features.impl.COFOverride
 import me.rhunk.snapenhance.core.features.impl.messaging.Messaging
 import me.rhunk.snapenhance.core.ui.findParent
<a href="#h108-1" id="h108-1" class="h">@@ -18,7 +17,7 @@ import me.rhunk.snapenhance.core.util.ktx.getIdentifier
</a> import kotlin.reflect.KClass
 
 @SuppressLint(&quot;DiscouragedApi&quot;)
<a href="#h108-1-3" id="h108-1-3" class="d">-class MenuViewInjector : Feature(&quot;MenuViewInjector&quot;, loadParams = FeatureLoadParams.ACTIVITY_CREATE_ASYNC) {
</a><a href="#h108-1-4" id="h108-1-4" class="i">+class MenuViewInjector : Feature(&quot;MenuViewInjector&quot;) {
</a>     private val menuMap by lazy {
         arrayOf(
             NewChatActionMenu(),
<a href="#h108-2" id="h108-2" class="h">@@ -40,113 +39,115 @@ class MenuViewInjector : Feature(&quot;MenuViewInjector&quot;, loadParams = FeatureLoadPar
</a>         return menuMap[menuClass] as? T
     }
 
<a href="#h108-2-3" id="h108-2-3" class="d">-    override fun asyncOnActivityCreate() {
</a><a href="#h108-2-4" id="h108-2-4" class="d">-        menuMap.forEach { it.value.init() }
</a><a href="#h108-2-5" id="h108-2-5" class="d">-
</a><a href="#h108-2-6" id="h108-2-6" class="d">-        val messaging = context.feature(Messaging::class)
</a><a href="#h108-2-7" id="h108-2-7" class="d">-
</a><a href="#h108-2-8" id="h108-2-8" class="d">-        val actionSheetItemsContainerLayoutId = context.resources.getIdentifier(&quot;action_sheet_items_container&quot;, &quot;id&quot;)
</a><a href="#h108-2-9" id="h108-2-9" class="d">-        val actionMenuTitle = context.resources.getIdentifier(&quot;action_menu_title&quot;, &quot;id&quot;)
</a><a href="#h108-2-10" id="h108-2-10" class="d">-        val actionMenu = context.resources.getIdentifier(&quot;action_menu&quot;, &quot;id&quot;)
</a><a href="#h108-2-11" id="h108-2-11" class="d">-        val componentsHolder = context.resources.getIdentifier(&quot;components_holder&quot;, &quot;id&quot;)
</a><a href="#h108-2-12" id="h108-2-12" class="d">-        val feedNewChat = context.resources.getIdentifier(&quot;feed_new_chat&quot;, &quot;id&quot;)
</a><a href="#h108-2-13" id="h108-2-13" class="d">-        val contextMenuButtonIconView = context.resources.getIdentifier(&quot;context_menu_button_icon_view&quot;, &quot;id&quot;)
</a><a href="#h108-2-14" id="h108-2-14" class="d">-        val chatActionMenu = context.resources.getIdentifier(&quot;chat_action_menu&quot;, &quot;id&quot;)
</a><a href="#h108-2-15" id="h108-2-15" class="d">-
</a><a href="#h108-2-16" id="h108-2-16" class="d">-        val hasV2ActionMenu = { context.feature(COFOverride::class).hasActionMenuV2 }
</a><a href="#h108-2-17" id="h108-2-17" class="d">-
</a><a href="#h108-2-18" id="h108-2-18" class="d">-        context.event.subscribe(AddViewEvent::class) { event -&gt;
</a><a href="#h108-2-19" id="h108-2-19" class="d">-            val originalAddView: (View) -&gt; Unit = {
</a><a href="#h108-2-20" id="h108-2-20" class="d">-                event.adapter.invokeOriginal(arrayOf(it, -1,
</a><a href="#h108-2-21" id="h108-2-21" class="d">-                    FrameLayout.LayoutParams(
</a><a href="#h108-2-22" id="h108-2-22" class="d">-                        ViewGroup.LayoutParams.MATCH_PARENT,
</a><a href="#h108-2-23" id="h108-2-23" class="d">-                        ViewGroup.LayoutParams.MATCH_PARENT
</a><a href="#h108-2-24" id="h108-2-24" class="d">-                    ))
</a><a href="#h108-2-25" id="h108-2-25" class="d">-                )
</a><a href="#h108-2-26" id="h108-2-26" class="d">-            }
</a><a href="#h108-2-27" id="h108-2-27" class="i">+    override fun init() {
</a><a href="#h108-2-28" id="h108-2-28" class="i">+        onNextActivityCreate(defer = true) {
</a><a href="#h108-2-29" id="h108-2-29" class="i">+            menuMap.forEach { it.value.init() }
</a> 
<a href="#h108-2-31" id="h108-2-31" class="d">-            val viewGroup: ViewGroup = event.parent
</a><a href="#h108-2-32" id="h108-2-32" class="d">-            val childView: View = event.view
</a><a href="#h108-2-33" id="h108-2-33" class="d">-            menuMap[OperaContextActionMenu::class]!!.inject(viewGroup, childView, originalAddView)
</a><a href="#h108-2-34" id="h108-2-34" class="i">+            val messaging = context.feature(Messaging::class)
</a> 
<a href="#h108-2-36" id="h108-2-36" class="d">-            if (event.view.id == actionSheetItemsContainerLayoutId) {
</a><a href="#h108-2-37" id="h108-2-37" class="d">-                event.view.post {
</a><a href="#h108-2-38" id="h108-2-38" class="d">-                    if (event.parent.findParent(4) {
</a><a href="#h108-2-39" id="h108-2-39" class="d">-                        it.findViewById&lt;View&gt;(actionMenuTitle) != null
</a><a href="#h108-2-40" id="h108-2-40" class="d">-                    } == null) return@post
</a><a href="#h108-2-41" id="h108-2-41" class="i">+            val actionSheetItemsContainerLayoutId = context.resources.getIdentifier(&quot;action_sheet_items_container&quot;, &quot;id&quot;)
</a><a href="#h108-2-42" id="h108-2-42" class="i">+            val actionMenuTitle = context.resources.getIdentifier(&quot;action_menu_title&quot;, &quot;id&quot;)
</a><a href="#h108-2-43" id="h108-2-43" class="i">+            val actionMenu = context.resources.getIdentifier(&quot;action_menu&quot;, &quot;id&quot;)
</a><a href="#h108-2-44" id="h108-2-44" class="i">+            val componentsHolder = context.resources.getIdentifier(&quot;components_holder&quot;, &quot;id&quot;)
</a><a href="#h108-2-45" id="h108-2-45" class="i">+            val feedNewChat = context.resources.getIdentifier(&quot;feed_new_chat&quot;, &quot;id&quot;)
</a><a href="#h108-2-46" id="h108-2-46" class="i">+            val contextMenuButtonIconView = context.resources.getIdentifier(&quot;context_menu_button_icon_view&quot;, &quot;id&quot;)
</a><a href="#h108-2-47" id="h108-2-47" class="i">+            val chatActionMenu = context.resources.getIdentifier(&quot;chat_action_menu&quot;, &quot;id&quot;)
</a> 
<a href="#h108-2-49" id="h108-2-49" class="d">-                    val views = mutableListOf&lt;View&gt;()
</a><a href="#h108-2-50" id="h108-2-50" class="d">-                    menuMap[FriendFeedInfoMenu::class]?.inject(event.parent, event.view) {
</a><a href="#h108-2-51" id="h108-2-51" class="d">-                        views.add(it)
</a><a href="#h108-2-52" id="h108-2-52" class="d">-                    }
</a><a href="#h108-2-53" id="h108-2-53" class="d">-                    views.reversed().forEach { (event.view as ViewGroup).addView(it, 0) }
</a><a href="#h108-2-54" id="h108-2-54" class="i">+            val hasV2ActionMenu = { context.feature(COFOverride::class).hasActionMenuV2 }
</a><a href="#h108-2-55" id="h108-2-55" class="i">+
</a><a href="#h108-2-56" id="h108-2-56" class="i">+            context.event.subscribe(AddViewEvent::class) { event -&gt;
</a><a href="#h108-2-57" id="h108-2-57" class="i">+                val originalAddView: (View) -&gt; Unit = {
</a><a href="#h108-2-58" id="h108-2-58" class="i">+                    event.adapter.invokeOriginal(arrayOf(it, -1,
</a><a href="#h108-2-59" id="h108-2-59" class="i">+                        FrameLayout.LayoutParams(
</a><a href="#h108-2-60" id="h108-2-60" class="i">+                            ViewGroup.LayoutParams.MATCH_PARENT,
</a><a href="#h108-2-61" id="h108-2-61" class="i">+                            ViewGroup.LayoutParams.MATCH_PARENT
</a><a href="#h108-2-62" id="h108-2-62" class="i">+                        ))
</a><a href="#h108-2-63" id="h108-2-63" class="i">+                    )
</a>                 }
<a href="#h108-2-65" id="h108-2-65" class="d">-            }
</a> 
<a href="#h108-2-67" id="h108-2-67" class="d">-            if (childView.id == contextMenuButtonIconView) {
</a><a href="#h108-2-68" id="h108-2-68" class="d">-                menuMap[OperaViewerIcons::class]!!.inject(viewGroup, childView, originalAddView)
</a><a href="#h108-2-69" id="h108-2-69" class="d">-            }
</a><a href="#h108-2-70" id="h108-2-70" class="i">+                val viewGroup: ViewGroup = event.parent
</a><a href="#h108-2-71" id="h108-2-71" class="i">+                val childView: View = event.view
</a><a href="#h108-2-72" id="h108-2-72" class="i">+                menuMap[OperaContextActionMenu::class]!!.inject(viewGroup, childView, originalAddView)
</a> 
<a href="#h108-2-74" id="h108-2-74" class="d">-            if (event.parent.id == componentsHolder &amp;&amp; childView.id == feedNewChat) {
</a><a href="#h108-2-75" id="h108-2-75" class="d">-                menuMap[SettingsGearInjector::class]!!.inject(viewGroup, childView, originalAddView)
</a><a href="#h108-2-76" id="h108-2-76" class="d">-                return@subscribe
</a><a href="#h108-2-77" id="h108-2-77" class="d">-            }
</a><a href="#h108-2-78" id="h108-2-78" class="i">+                if (event.view.id == actionSheetItemsContainerLayoutId) {
</a><a href="#h108-2-79" id="h108-2-79" class="i">+                    event.view.post {
</a><a href="#h108-2-80" id="h108-2-80" class="i">+                        if (event.parent.findParent(4) {
</a><a href="#h108-2-81" id="h108-2-81" class="i">+                                it.findViewById&lt;View&gt;(actionMenuTitle) != null
</a><a href="#h108-2-82" id="h108-2-82" class="i">+                            } == null) return@post
</a> 
<a href="#h108-2-84" id="h108-2-84" class="d">-            if (viewGroup !is LinearLayout &amp;&amp; childView.id == chatActionMenu &amp;&amp; context.isDeveloper) {
</a><a href="#h108-2-85" id="h108-2-85" class="d">-                event.view = LinearLayout(childView.context).apply {
</a><a href="#h108-2-86" id="h108-2-86" class="d">-                    orientation = LinearLayout.VERTICAL
</a><a href="#h108-2-87" id="h108-2-87" class="d">-                    addView(
</a><a href="#h108-2-88" id="h108-2-88" class="d">-                        (menuMap[NewChatActionMenu::class]!! as NewChatActionMenu).createDebugInfoView(childView.context)
</a><a href="#h108-2-89" id="h108-2-89" class="d">-                    )
</a><a href="#h108-2-90" id="h108-2-90" class="d">-                    addView(event.view)
</a><a href="#h108-2-91" id="h108-2-91" class="i">+                        val views = mutableListOf&lt;View&gt;()
</a><a href="#h108-2-92" id="h108-2-92" class="i">+                        menuMap[FriendFeedInfoMenu::class]?.inject(event.parent, event.view) {
</a><a href="#h108-2-93" id="h108-2-93" class="i">+                            views.add(it)
</a><a href="#h108-2-94" id="h108-2-94" class="i">+                        }
</a><a href="#h108-2-95" id="h108-2-95" class="i">+                        views.reversed().forEach { (event.view as ViewGroup).addView(it, 0) }
</a><a href="#h108-2-96" id="h108-2-96" class="i">+                    }
</a>                 }
<a href="#h108-2-98" id="h108-2-98" class="d">-            }
</a> 
<a href="#h108-2-100" id="h108-2-100" class="d">-            if (childView.javaClass.name.endsWith(&quot;ChatActionMenuComponent&quot;) &amp;&amp; hasV2ActionMenu()) {
</a><a href="#h108-2-101" id="h108-2-101" class="d">-                (menuMap[NewChatActionMenu::class]!! as NewChatActionMenu).handle(event)
</a><a href="#h108-2-102" id="h108-2-102" class="d">-                return@subscribe
</a><a href="#h108-2-103" id="h108-2-103" class="d">-            }
</a><a href="#h108-2-104" id="h108-2-104" class="i">+                if (childView.id == contextMenuButtonIconView) {
</a><a href="#h108-2-105" id="h108-2-105" class="i">+                    menuMap[OperaViewerIcons::class]!!.inject(viewGroup, childView, originalAddView)
</a><a href="#h108-2-106" id="h108-2-106" class="i">+                }
</a> 
<a href="#h108-2-108" id="h108-2-108" class="d">-            if (viewGroup.javaClass.name.endsWith(&quot;ActionMenuChatItemContainer&quot;) &amp;&amp; !hasV2ActionMenu()) {
</a><a href="#h108-2-109" id="h108-2-109" class="d">-                if (viewGroup.parent == null || viewGroup.parent.parent == null) return@subscribe
</a><a href="#h108-2-110" id="h108-2-110" class="d">-                menuMap[ChatActionMenu::class]!!.inject(viewGroup, childView, originalAddView)
</a><a href="#h108-2-111" id="h108-2-111" class="d">-                return@subscribe
</a><a href="#h108-2-112" id="h108-2-112" class="d">-            }
</a><a href="#h108-2-113" id="h108-2-113" class="i">+                if (event.parent.id == componentsHolder &amp;&amp; childView.id == feedNewChat) {
</a><a href="#h108-2-114" id="h108-2-114" class="i">+                    menuMap[SettingsGearInjector::class]!!.inject(viewGroup, childView, originalAddView)
</a><a href="#h108-2-115" id="h108-2-115" class="i">+                    return@subscribe
</a><a href="#h108-2-116" id="h108-2-116" class="i">+                }
</a> 
<a href="#h108-2-118" id="h108-2-118" class="d">-            if (viewGroup !is LinearLayout &amp;&amp; childView.id == actionMenu &amp;&amp; messaging.lastFocusedConversationType == 1) {
</a><a href="#h108-2-119" id="h108-2-119" class="d">-                val injectedLayout = LinearLayout(childView.context).apply {
</a><a href="#h108-2-120" id="h108-2-120" class="d">-                    orientation = LinearLayout.VERTICAL
</a><a href="#h108-2-121" id="h108-2-121" class="d">-                    gravity = Gravity.BOTTOM
</a><a href="#h108-2-122" id="h108-2-122" class="d">-                    layoutParams = ViewGroup.LayoutParams(ViewGroup.LayoutParams.MATCH_PARENT, ViewGroup.LayoutParams.MATCH_PARENT)
</a><a href="#h108-2-123" id="h108-2-123" class="d">-                    addView(childView)
</a><a href="#h108-2-124" id="h108-2-124" class="i">+                if (viewGroup !is LinearLayout &amp;&amp; childView.id == chatActionMenu &amp;&amp; context.isDeveloper) {
</a><a href="#h108-2-125" id="h108-2-125" class="i">+                    event.view = LinearLayout(childView.context).apply {
</a><a href="#h108-2-126" id="h108-2-126" class="i">+                        orientation = LinearLayout.VERTICAL
</a><a href="#h108-2-127" id="h108-2-127" class="i">+                        addView(
</a><a href="#h108-2-128" id="h108-2-128" class="i">+                            (menuMap[NewChatActionMenu::class]!! as NewChatActionMenu).createDebugInfoView(childView.context)
</a><a href="#h108-2-129" id="h108-2-129" class="i">+                        )
</a><a href="#h108-2-130" id="h108-2-130" class="i">+                        addView(event.view)
</a><a href="#h108-2-131" id="h108-2-131" class="i">+                    }
</a>                 }
 
<a href="#h108-2-134" id="h108-2-134" class="d">-                event.parent.post {
</a><a href="#h108-2-135" id="h108-2-135" class="d">-                    injectedLayout.addView(ScrollView(injectedLayout.context).apply {
</a><a href="#h108-2-136" id="h108-2-136" class="d">-                        layoutParams = LinearLayout.LayoutParams(
</a><a href="#h108-2-137" id="h108-2-137" class="d">-                            ViewGroup.LayoutParams.MATCH_PARENT,
</a><a href="#h108-2-138" id="h108-2-138" class="d">-                            ViewGroup.LayoutParams.WRAP_CONTENT
</a><a href="#h108-2-139" id="h108-2-139" class="d">-                        ).apply {
</a><a href="#h108-2-140" id="h108-2-140" class="d">-                            weight = 1f;
</a><a href="#h108-2-141" id="h108-2-141" class="d">-                            setMargins(0, 100, 0, 0)
</a><a href="#h108-2-142" id="h108-2-142" class="d">-                        }
</a><a href="#h108-2-143" id="h108-2-143" class="i">+                if (childView.javaClass.name.endsWith(&quot;ChatActionMenuComponent&quot;) &amp;&amp; hasV2ActionMenu()) {
</a><a href="#h108-2-144" id="h108-2-144" class="i">+                    (menuMap[NewChatActionMenu::class]!! as NewChatActionMenu).handle(event)
</a><a href="#h108-2-145" id="h108-2-145" class="i">+                    return@subscribe
</a><a href="#h108-2-146" id="h108-2-146" class="i">+                }
</a> 
<a href="#h108-2-148" id="h108-2-148" class="d">-                        addView(LinearLayout(context).apply {
</a><a href="#h108-2-149" id="h108-2-149" class="d">-                            orientation = LinearLayout.VERTICAL
</a><a href="#h108-2-150" id="h108-2-150" class="d">-                            menuMap[FriendFeedInfoMenu::class]?.inject(event.parent, injectedLayout) { view -&gt;
</a><a href="#h108-2-151" id="h108-2-151" class="d">-                                view.layoutParams = LinearLayout.LayoutParams(
</a><a href="#h108-2-152" id="h108-2-152" class="d">-                                    ViewGroup.LayoutParams.MATCH_PARENT,
</a><a href="#h108-2-153" id="h108-2-153" class="d">-                                    ViewGroup.LayoutParams.WRAP_CONTENT
</a><a href="#h108-2-154" id="h108-2-154" class="d">-                                ).apply {
</a><a href="#h108-2-155" id="h108-2-155" class="d">-                                    setMargins(0, 5, 0, 5)
</a><a href="#h108-2-156" id="h108-2-156" class="d">-                                }
</a><a href="#h108-2-157" id="h108-2-157" class="d">-                                addView(view)
</a><a href="#h108-2-158" id="h108-2-158" class="d">-                            }
</a><a href="#h108-2-159" id="h108-2-159" class="d">-                        })
</a><a href="#h108-2-160" id="h108-2-160" class="d">-                    }, 0)
</a><a href="#h108-2-161" id="h108-2-161" class="i">+                if (viewGroup.javaClass.name.endsWith(&quot;ActionMenuChatItemContainer&quot;) &amp;&amp; !hasV2ActionMenu()) {
</a><a href="#h108-2-162" id="h108-2-162" class="i">+                    if (viewGroup.parent == null || viewGroup.parent.parent == null) return@subscribe
</a><a href="#h108-2-163" id="h108-2-163" class="i">+                    menuMap[ChatActionMenu::class]!!.inject(viewGroup, childView, originalAddView)
</a><a href="#h108-2-164" id="h108-2-164" class="i">+                    return@subscribe
</a>                 }
 
<a href="#h108-2-167" id="h108-2-167" class="d">-                event.view = injectedLayout
</a><a href="#h108-2-168" id="h108-2-168" class="i">+                if (viewGroup !is LinearLayout &amp;&amp; childView.id == actionMenu &amp;&amp; messaging.lastFocusedConversationType == 1) {
</a><a href="#h108-2-169" id="h108-2-169" class="i">+                    val injectedLayout = LinearLayout(childView.context).apply {
</a><a href="#h108-2-170" id="h108-2-170" class="i">+                        orientation = LinearLayout.VERTICAL
</a><a href="#h108-2-171" id="h108-2-171" class="i">+                        gravity = Gravity.BOTTOM
</a><a href="#h108-2-172" id="h108-2-172" class="i">+                        layoutParams = ViewGroup.LayoutParams(ViewGroup.LayoutParams.MATCH_PARENT, ViewGroup.LayoutParams.MATCH_PARENT)
</a><a href="#h108-2-173" id="h108-2-173" class="i">+                        addView(childView)
</a><a href="#h108-2-174" id="h108-2-174" class="i">+                    }
</a><a href="#h108-2-175" id="h108-2-175" class="i">+
</a><a href="#h108-2-176" id="h108-2-176" class="i">+                    event.parent.post {
</a><a href="#h108-2-177" id="h108-2-177" class="i">+                        injectedLayout.addView(ScrollView(injectedLayout.context).apply {
</a><a href="#h108-2-178" id="h108-2-178" class="i">+                            layoutParams = LinearLayout.LayoutParams(
</a><a href="#h108-2-179" id="h108-2-179" class="i">+                                ViewGroup.LayoutParams.MATCH_PARENT,
</a><a href="#h108-2-180" id="h108-2-180" class="i">+                                ViewGroup.LayoutParams.WRAP_CONTENT
</a><a href="#h108-2-181" id="h108-2-181" class="i">+                            ).apply {
</a><a href="#h108-2-182" id="h108-2-182" class="i">+                                weight = 1f;
</a><a href="#h108-2-183" id="h108-2-183" class="i">+                                setMargins(0, 100, 0, 0)
</a><a href="#h108-2-184" id="h108-2-184" class="i">+                            }
</a><a href="#h108-2-185" id="h108-2-185" class="i">+
</a><a href="#h108-2-186" id="h108-2-186" class="i">+                            addView(LinearLayout(context).apply {
</a><a href="#h108-2-187" id="h108-2-187" class="i">+                                orientation = LinearLayout.VERTICAL
</a><a href="#h108-2-188" id="h108-2-188" class="i">+                                menuMap[FriendFeedInfoMenu::class]?.inject(event.parent, injectedLayout) { view -&gt;
</a><a href="#h108-2-189" id="h108-2-189" class="i">+                                    view.layoutParams = LinearLayout.LayoutParams(
</a><a href="#h108-2-190" id="h108-2-190" class="i">+                                        ViewGroup.LayoutParams.MATCH_PARENT,
</a><a href="#h108-2-191" id="h108-2-191" class="i">+                                        ViewGroup.LayoutParams.WRAP_CONTENT
</a><a href="#h108-2-192" id="h108-2-192" class="i">+                                    ).apply {
</a><a href="#h108-2-193" id="h108-2-193" class="i">+                                        setMargins(0, 5, 0, 5)
</a><a href="#h108-2-194" id="h108-2-194" class="i">+                                    }
</a><a href="#h108-2-195" id="h108-2-195" class="i">+                                    addView(view)
</a><a href="#h108-2-196" id="h108-2-196" class="i">+                                }
</a><a href="#h108-2-197" id="h108-2-197" class="i">+                            })
</a><a href="#h108-2-198" id="h108-2-198" class="i">+                        }, 0)
</a><a href="#h108-2-199" id="h108-2-199" class="i">+                    }
</a><a href="#h108-2-200" id="h108-2-200" class="i">+
</a><a href="#h108-2-201" id="h108-2-201" class="i">+                    event.view = injectedLayout
</a><a href="#h108-2-202" id="h108-2-202" class="i">+                }
</a>             }
         }
     }
<b>diff --git a/<a id="h109" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/ui/menu/impl/FriendFeedInfoMenu.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/ui/menu/impl/FriendFeedInfoMenu.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/ui/menu/impl/FriendFeedInfoMenu.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/ui/menu/impl/FriendFeedInfoMenu.kt</a></b>
<a href="#h109-0" id="h109-0" class="h">@@ -33,6 +33,7 @@ import androidx.compose.ui.text.font.FontWeight
</a> import androidx.compose.ui.text.style.TextAlign
 import androidx.compose.ui.unit.dp
 import androidx.compose.ui.unit.sp
<a href="#h109-0-3" id="h109-0-3" class="i">+import androidx.core.content.res.use
</a> import kotlinx.coroutines.Dispatchers
 import kotlinx.coroutines.launch
 import kotlinx.coroutines.withContext
<a href="#h109-1" id="h109-1" class="h">@@ -74,12 +75,12 @@ class FriendFeedInfoMenu : AbstractMenu() {
</a>     private val sigColorTextPrimary by lazy {
         context.androidContext.theme.obtainStyledAttributes(
             intArrayOf(context.resources.getIdentifier(&quot;sigColorTextPrimary&quot;, &quot;attr&quot;))
<a href="#h109-1-3" id="h109-1-3" class="d">-        ).getColor(0, 0)
</a><a href="#h109-1-4" id="h109-1-4" class="i">+        ).use { it.getColor(0, 0) }
</a>     }
     private val sigColorBackgroundSurface by lazy {
         context.androidContext.theme.obtainStyledAttributes(
             intArrayOf(context.resources.getIdentifier(&quot;sigColorBackgroundSurface&quot;, &quot;attr&quot;))
<a href="#h109-1-9" id="h109-1-9" class="d">-        ).getColor(0, 0)
</a><a href="#h109-1-10" id="h109-1-10" class="i">+        ).use { it.getColor(0, 0) }
</a>     }
 
     private fun getImageDrawable(url: String): Drawable {
<b>diff --git a/<a id="h110" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/ui/menu/impl/OperaContextActionMenu.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/ui/menu/impl/OperaContextActionMenu.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/ui/menu/impl/OperaContextActionMenu.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/ui/menu/impl/OperaContextActionMenu.kt</a></b>
<a href="#h110-0" id="h110-0" class="h">@@ -21,6 +21,7 @@ import androidx.compose.ui.Modifier
</a> import androidx.compose.ui.graphics.Color
 import androidx.compose.ui.text.style.TextAlign
 import androidx.compose.ui.unit.dp
<a href="#h110-0-3" id="h110-0-3" class="i">+import androidx.core.content.res.use
</a> import me.rhunk.snapenhance.common.ui.createComposeView
 import me.rhunk.snapenhance.core.features.impl.OperaViewerParamsOverride
 import me.rhunk.snapenhance.core.features.impl.downloader.MediaDownloader
<a href="#h110-1" id="h110-1" class="h">@@ -170,7 +171,7 @@ class OperaContextActionMenu : AbstractMenu() {
</a>                             color = remember {
                                 view.context.theme.obtainStyledAttributes(
                                     intArrayOf(view.context.resources.getIdentifier(&quot;sigColorTextPrimary&quot;, &quot;attr&quot;))
<a href="#h110-1-3" id="h110-1-3" class="d">-                                ).getColor(0, 0).let { Color(it) }
</a><a href="#h110-1-4" id="h110-1-4" class="i">+                                ).use { Color(it.getColor(0, 0)) }
</a>                             },
                             textAlign = TextAlign.Center,
                             modifier = Modifier.fillMaxWidth()
<b>diff --git a/<a id="h111" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/ui/menu/impl/SettingsGearInjector.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/ui/menu/impl/SettingsGearInjector.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/ui/menu/impl/SettingsGearInjector.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/ui/menu/impl/SettingsGearInjector.kt</a></b>
<a href="#h111-0" id="h111-0" class="h">@@ -5,6 +5,7 @@ import android.view.View
</a> import android.view.ViewGroup
 import android.widget.FrameLayout
 import android.widget.ImageView
<a href="#h111-0-3" id="h111-0-3" class="i">+import androidx.core.content.res.use
</a> import me.rhunk.snapenhance.common.ui.OverlayType
 import me.rhunk.snapenhance.core.ui.menu.AbstractMenu
 import me.rhunk.snapenhance.core.util.ktx.getDimens
<a href="#h111-1" id="h111-1" class="h">@@ -65,8 +66,8 @@ class SettingsGearInjector : AbstractMenu() {
</a>                     gravity = android.view.Gravity.CENTER
                 }
                 setImageDrawable(context.resources.getDrawable(&quot;svg_settings_32x32&quot;, context.theme))
<a href="#h111-1-3" id="h111-1-3" class="d">-                context.resources.getStyledAttributes(&quot;headerButtonOpaqueIconTint&quot;, context.theme).getColorStateList(0)?.let {
</a><a href="#h111-1-4" id="h111-1-4" class="d">-                    imageTintList = it
</a><a href="#h111-1-5" id="h111-1-5" class="i">+                context.resources.getStyledAttributes(&quot;headerButtonOpaqueIconTint&quot;, context.theme).use {
</a><a href="#h111-1-6" id="h111-1-6" class="i">+                    imageTintList = it.getColorStateList(0)
</a>                 }
             })
         })
<b>diff --git a/<a id="h112" href="../file/native/jni/src/common.h.html">native/jni/src/common.h</a> b/<a href="../file/native/jni/src/common.h.html">native/jni/src/common.h</a></b>
<a href="#h112-0" id="h112-0" class="h">@@ -13,7 +13,6 @@ typedef struct {
</a>     bool disable_bitmoji;
     bool disable_metrics;
     bool composer_hooks;
<a href="#h112-0-3" id="h112-0-3" class="d">-    bool remap_executable;
</a>     char custom_emoji_font_path[256];
 } native_config_t;
 
<b>diff --git a/<a id="h113" href="../file/native/jni/src/dobby_helper.h.html">native/jni/src/dobby_helper.h</a> b/<a href="../file/native/jni/src/dobby_helper.h.html">native/jni/src/dobby_helper.h</a></b>
<a href="#h113-0" id="h113-0" class="h">@@ -9,8 +9,5 @@ static pthread_mutex_t hook_mutex = PTHREAD_MUTEX_INITIALIZER;
</a> static void inline SafeHook(void *addr, void *hook, void **original) {
     pthread_mutex_lock(&amp;hook_mutex);
     DobbyHook(addr, hook, original);
<a href="#h113-0-3" id="h113-0-3" class="d">-    if (common::native_config-&gt;remap_executable) {
</a><a href="#h113-0-4" id="h113-0-4" class="d">-        mprotect((void *)((uintptr_t) *original &amp; PAGE_MASK), PAGE_SIZE, PROT_EXEC);
</a><a href="#h113-0-5" id="h113-0-5" class="d">-    }
</a>     pthread_mutex_unlock(&amp;hook_mutex);
 } 
\ No newline at end of file
<b>diff --git a/<a id="h114" href="../file/native/jni/src/hooks/linker_hook.h.html">native/jni/src/hooks/linker_hook.h</a> b/<a href="../file/native/jni/src/hooks/linker_hook.h.html">native/jni/src/hooks/linker_hook.h</a></b>
<a href="#h114-0" id="h114-0" class="h">@@ -0,0 +1,54 @@
</a><a href="#h114-0-0" id="h114-0-0" class="i">+#pragma once
</a><a href="#h114-0-1" id="h114-0-1" class="i">+
</a><a href="#h114-0-2" id="h114-0-2" class="i">+#include &lt;map&gt;
</a><a href="#h114-0-3" id="h114-0-3" class="i">+
</a><a href="#h114-0-4" id="h114-0-4" class="i">+namespace LinkerHook {
</a><a href="#h114-0-5" id="h114-0-5" class="i">+    static auto linker_openat_hooks = std::map&lt;std::string, std::pair&lt;uintptr_t, size_t&gt;&gt;();
</a><a href="#h114-0-6" id="h114-0-6" class="i">+
</a><a href="#h114-0-7" id="h114-0-7" class="i">+    void JNICALL addLinkerSharedLibrary(JNIEnv *env, jobject, jstring path, jbyteArray content) {
</a><a href="#h114-0-8" id="h114-0-8" class="i">+        const char *path_str = env-&gt;GetStringUTFChars(path, nullptr);
</a><a href="#h114-0-9" id="h114-0-9" class="i">+        jsize content_len = env-&gt;GetArrayLength(content);
</a><a href="#h114-0-10" id="h114-0-10" class="i">+        jbyte *content_ptr = env-&gt;GetByteArrayElements(content, nullptr);
</a><a href="#h114-0-11" id="h114-0-11" class="i">+
</a><a href="#h114-0-12" id="h114-0-12" class="i">+        auto allocated_content = (jbyte *) malloc(content_len);
</a><a href="#h114-0-13" id="h114-0-13" class="i">+        memcpy(allocated_content, content_ptr, content_len);
</a><a href="#h114-0-14" id="h114-0-14" class="i">+        linker_openat_hooks[path_str] = std::make_pair((uintptr_t) allocated_content, content_len);
</a><a href="#h114-0-15" id="h114-0-15" class="i">+
</a><a href="#h114-0-16" id="h114-0-16" class="i">+        LOGD(&quot;added linker hook for %s, size=%d&quot;, path_str, content_len);
</a><a href="#h114-0-17" id="h114-0-17" class="i">+
</a><a href="#h114-0-18" id="h114-0-18" class="i">+        env-&gt;ReleaseStringUTFChars(path, path_str);
</a><a href="#h114-0-19" id="h114-0-19" class="i">+        env-&gt;ReleaseByteArrayElements(content, content_ptr, JNI_ABORT);
</a><a href="#h114-0-20" id="h114-0-20" class="i">+    }
</a><a href="#h114-0-21" id="h114-0-21" class="i">+
</a><a href="#h114-0-22" id="h114-0-22" class="i">+    HOOK_DEF(int, linker_openat, int dirfd, const char *pathname, int flags, mode_t mode) {
</a><a href="#h114-0-23" id="h114-0-23" class="i">+        for (const auto &amp;item: linker_openat_hooks) {
</a><a href="#h114-0-24" id="h114-0-24" class="i">+            if (strstr(pathname, item.first.c_str())) {
</a><a href="#h114-0-25" id="h114-0-25" class="i">+                LOGD(&quot;found openat hook for %s&quot;, pathname);
</a><a href="#h114-0-26" id="h114-0-26" class="i">+                static auto memfd_create = (int (*)(const char *, unsigned int)) DobbySymbolResolver(&quot;libc.so&quot;, &quot;memfd_create&quot;);
</a><a href="#h114-0-27" id="h114-0-27" class="i">+                auto fd = memfd_create(&quot;me.rhunk.snapenhance&quot;, 0);
</a><a href="#h114-0-28" id="h114-0-28" class="i">+                LOGD(&quot;memfd created: %d&quot;, fd);
</a><a href="#h114-0-29" id="h114-0-29" class="i">+
</a><a href="#h114-0-30" id="h114-0-30" class="i">+                if (fd == -1) {
</a><a href="#h114-0-31" id="h114-0-31" class="i">+                    LOGE(&quot;memfd_create failed: %d&quot;, errno);
</a><a href="#h114-0-32" id="h114-0-32" class="i">+                    return -1;
</a><a href="#h114-0-33" id="h114-0-33" class="i">+                }
</a><a href="#h114-0-34" id="h114-0-34" class="i">+                if (write(fd, (void *) item.second.first, item.second.second) == -1) {
</a><a href="#h114-0-35" id="h114-0-35" class="i">+                    LOGE(&quot;write failed: %d&quot;, errno);
</a><a href="#h114-0-36" id="h114-0-36" class="i">+                    return -1;
</a><a href="#h114-0-37" id="h114-0-37" class="i">+                }
</a><a href="#h114-0-38" id="h114-0-38" class="i">+                lseek(fd, 0, SEEK_SET);
</a><a href="#h114-0-39" id="h114-0-39" class="i">+
</a><a href="#h114-0-40" id="h114-0-40" class="i">+                free((void *) item.second.first);
</a><a href="#h114-0-41" id="h114-0-41" class="i">+                linker_openat_hooks.erase(item.first);
</a><a href="#h114-0-42" id="h114-0-42" class="i">+
</a><a href="#h114-0-43" id="h114-0-43" class="i">+                LOGD(&quot;memfd written&quot;);
</a><a href="#h114-0-44" id="h114-0-44" class="i">+                return fd;
</a><a href="#h114-0-45" id="h114-0-45" class="i">+            }
</a><a href="#h114-0-46" id="h114-0-46" class="i">+        }
</a><a href="#h114-0-47" id="h114-0-47" class="i">+        return linker_openat_original(dirfd, pathname, flags, mode);
</a><a href="#h114-0-48" id="h114-0-48" class="i">+    }
</a><a href="#h114-0-49" id="h114-0-49" class="i">+
</a><a href="#h114-0-50" id="h114-0-50" class="i">+    void init() {
</a><a href="#h114-0-51" id="h114-0-51" class="i">+        DobbyHook((void *) DobbySymbolResolver(ARM64 ? &quot;linker64&quot; : &quot;linker&quot;, &quot;__dl___openat&quot;), (void *) linker_openat, (void **) &amp;linker_openat_original);
</a><a href="#h114-0-52" id="h114-0-52" class="i">+    }
</a><a href="#h114-0-53" id="h114-0-53" class="i">+}</a><a href="#h114-0-54" id="h114-0-54" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h115" href="../file/native/jni/src/library.cpp.html">native/jni/src/library.cpp</a> b/<a href="../file/native/jni/src/library.cpp.html">native/jni/src/library.cpp</a></b>
<a href="#h115-0" id="h115-0" class="h">@@ -7,6 +7,7 @@
</a> #include &quot;logger.h&quot;
 #include &quot;common.h&quot;
 #include &quot;dobby_helper.h&quot;
<a href="#h115-0-3" id="h115-0-3" class="i">+#include &quot;hooks/linker_hook.h&quot;
</a> #include &quot;hooks/unary_call.h&quot;
 #include &quot;hooks/fstat_hook.h&quot;
 #include &quot;hooks/sqlite_mutex.h&quot;
<a href="#h115-1" id="h115-1" class="h">@@ -17,9 +18,6 @@
</a> bool JNICALL init(JNIEnv *env, jobject clazz) {
     LOGD(&quot;Initializing native&quot;);
     using namespace common;
<a href="#h115-1-3" id="h115-1-3" class="d">-    util::remap_sections([](const std::string &amp;line, size_t size) {
</a><a href="#h115-1-4" id="h115-1-4" class="d">-        return line.find(BUILD_PACKAGE) != std::string::npos;
</a><a href="#h115-1-5" id="h115-1-5" class="d">-    }, native_config-&gt;remap_executable);
</a> 
     native_lib_object = env-&gt;NewGlobalRef(clazz);
     client_module = util::get_module(&quot;libclient.so&quot;);
<a href="#h115-2" id="h115-2" class="h">@@ -66,7 +64,6 @@ void JNICALL load_config(JNIEnv *env, jobject, jobject config_object) {
</a>     native_config-&gt;disable_bitmoji = GET_CONFIG_BOOL(&quot;disableBitmoji&quot;);
     native_config-&gt;disable_metrics = GET_CONFIG_BOOL(&quot;disableMetrics&quot;);
     native_config-&gt;composer_hooks = GET_CONFIG_BOOL(&quot;composerHooks&quot;);
<a href="#h115-2-3" id="h115-2-3" class="d">-    native_config-&gt;remap_executable = GET_CONFIG_BOOL(&quot;remapExecutable&quot;);
</a> 
     memset(native_config-&gt;custom_emoji_font_path, 0, sizeof(native_config-&gt;custom_emoji_font_path));
     auto custom_emoji_font_path = env-&gt;GetObjectField(config_object, env-&gt;GetFieldID(native_config_clazz, &quot;customEmojiFontPath&quot;, &quot;Ljava/lang/String;&quot;));
<a href="#h115-3" id="h115-3" class="h">@@ -97,15 +94,6 @@ void JNICALL lock_database(JNIEnv *env, jobject, jstring database_name, jobject 
</a>     }
 }
 
<a href="#h115-3-3" id="h115-3-3" class="d">-void JNICALL hide_anonymous_dex_files(JNIEnv *, jobject) {
</a><a href="#h115-3-4" id="h115-3-4" class="d">-    util::remap_sections([](const std::string &amp;line, size_t size) {
</a><a href="#h115-3-5" id="h115-3-5" class="d">-        return (
</a><a href="#h115-3-6" id="h115-3-6" class="d">-            (common::native_config-&gt;remap_executable &amp;&amp; size == PAGE_SIZE &amp;&amp; line.find(&quot;r-xp 00000000 00&quot;) != std::string::npos &amp;&amp; line.find(&quot;[v&quot;) == std::string::npos) ||
</a><a href="#h115-3-7" id="h115-3-7" class="d">-            line.find(&quot;dalvik-DEX&quot;) != std::string::npos ||
</a><a href="#h115-3-8" id="h115-3-8" class="d">-            line.find(&quot;dalvik-classes&quot;) != std::string::npos
</a><a href="#h115-3-9" id="h115-3-9" class="d">-        );
</a><a href="#h115-3-10" id="h115-3-10" class="d">-    }, common::native_config-&gt;remap_executable);
</a><a href="#h115-3-11" id="h115-3-11" class="d">-}
</a> 
 extern &quot;C&quot; JNIEXPORT jint JNICALL JNI_OnLoad(JavaVM *vm, void *_) {
     common::java_vm = vm;
<a href="#h115-4" id="h115-4" class="h">@@ -118,7 +106,9 @@ extern &quot;C&quot; JNIEXPORT jint JNICALL JNI_OnLoad(JavaVM *vm, void *_) {
</a>     methods.push_back({&quot;lockDatabase&quot;, &quot;(Ljava/lang/String;Ljava/lang/Runnable;)V&quot;, (void *)lock_database});
     methods.push_back({&quot;setComposerLoader&quot;, &quot;(Ljava/lang/String;)V&quot;, (void *) ComposerHook::setComposerLoader});
     methods.push_back({&quot;composerEval&quot;, &quot;(Ljava/lang/String;)Ljava/lang/String;&quot;,(void *) ComposerHook::composerEval});
<a href="#h115-4-3" id="h115-4-3" class="d">-    methods.push_back({&quot;hideAnonymousDexFiles&quot;, &quot;()V&quot;, (void *)hide_anonymous_dex_files});
</a><a href="#h115-4-4" id="h115-4-4" class="i">+    methods.push_back({&quot;addLinkerSharedLibrary&quot;, &quot;(Ljava/lang/String;[B)V&quot;, (void *) LinkerHook::addLinkerSharedLibrary});
</a><a href="#h115-4-5" id="h115-4-5" class="i">+
</a><a href="#h115-4-6" id="h115-4-6" class="i">+    LinkerHook::init();
</a> 
     env-&gt;RegisterNatives(env-&gt;FindClass(std::string(BUILD_NAMESPACE &quot;/NativeLib&quot;).c_str()), methods.data(), methods.size());
     return JNI_VERSION_1_6;
<b>diff --git a/<a id="h116" href="../file/native/jni/src/util.h.html">native/jni/src/util.h</a> b/<a href="../file/native/jni/src/util.h.html">native/jni/src/util.h</a></b>
<a href="#h116-0" id="h116-0" class="h">@@ -52,46 +52,6 @@ namespace util {
</a>         return { start_offset, end_offset - start_offset };
     }
 
<a href="#h116-0-3" id="h116-0-3" class="d">-    static void remap_sections(std::function&lt;bool(const std::string &amp;, size_t)&gt; filter, bool remove_read_permission) {
</a><a href="#h116-0-4" id="h116-0-4" class="d">-        char buff[256];
</a><a href="#h116-0-5" id="h116-0-5" class="d">-        auto maps = fopen(&quot;/proc/self/maps&quot;, &quot;rt&quot;);
</a><a href="#h116-0-6" id="h116-0-6" class="d">-
</a><a href="#h116-0-7" id="h116-0-7" class="d">-        while (fgets(buff, sizeof buff, maps) != NULL) {
</a><a href="#h116-0-8" id="h116-0-8" class="d">-            int len = strlen(buff);
</a><a href="#h116-0-9" id="h116-0-9" class="d">-            if (len &gt; 0 &amp;&amp; buff[len - 1] == &#39;\n&#39;) buff[--len] = &#39;\0&#39;;
</a><a href="#h116-0-10" id="h116-0-10" class="d">-
</a><a href="#h116-0-11" id="h116-0-11" class="d">-            size_t start, end, offset;
</a><a href="#h116-0-12" id="h116-0-12" class="d">-            char flags[4];
</a><a href="#h116-0-13" id="h116-0-13" class="d">-
</a><a href="#h116-0-14" id="h116-0-14" class="d">-            if (sscanf(buff, &quot;%zx-%zx %c%c%c%c %zx&quot;, &amp;start, &amp;end,
</a><a href="#h116-0-15" id="h116-0-15" class="d">-                       &amp;flags[0], &amp;flags[1], &amp;flags[2], &amp;flags[3], &amp;offset) != 7) continue;
</a><a href="#h116-0-16" id="h116-0-16" class="d">-
</a><a href="#h116-0-17" id="h116-0-17" class="d">-            if (!filter(buff, end - start)) continue;
</a><a href="#h116-0-18" id="h116-0-18" class="d">-
</a><a href="#h116-0-19" id="h116-0-19" class="d">-            auto section_size = end - start;
</a><a href="#h116-0-20" id="h116-0-20" class="d">-            auto section_ptr = mmap(0, section_size, PROT_READ | PROT_EXEC | PROT_WRITE, MAP_PRIVATE | MAP_ANONYMOUS, -1, 0);
</a><a href="#h116-0-21" id="h116-0-21" class="d">-
</a><a href="#h116-0-22" id="h116-0-22" class="d">-            if (section_ptr == MAP_FAILED) {
</a><a href="#h116-0-23" id="h116-0-23" class="d">-                LOGE(&quot;mmap failed: %s&quot;, strerror(errno));
</a><a href="#h116-0-24" id="h116-0-24" class="d">-                break;
</a><a href="#h116-0-25" id="h116-0-25" class="d">-            }
</a><a href="#h116-0-26" id="h116-0-26" class="d">-
</a><a href="#h116-0-27" id="h116-0-27" class="d">-            memcpy(section_ptr, (void *)start, section_size);
</a><a href="#h116-0-28" id="h116-0-28" class="d">-
</a><a href="#h116-0-29" id="h116-0-29" class="d">-            if (mremap(section_ptr, section_size, section_size, MREMAP_MAYMOVE | MREMAP_FIXED, start) == MAP_FAILED) {
</a><a href="#h116-0-30" id="h116-0-30" class="d">-                LOGE(&quot;mremap failed: %s&quot;, strerror(errno));
</a><a href="#h116-0-31" id="h116-0-31" class="d">-                break;
</a><a href="#h116-0-32" id="h116-0-32" class="d">-            }
</a><a href="#h116-0-33" id="h116-0-33" class="d">-
</a><a href="#h116-0-34" id="h116-0-34" class="d">-            auto new_prot = (flags[0] == &#39;r&#39; ? PROT_READ : 0) | (flags[1] == &#39;w&#39; ? PROT_WRITE : 0) | (flags[2] == &#39;x&#39; ? PROT_EXEC : 0);
</a><a href="#h116-0-35" id="h116-0-35" class="d">-            if (remove_read_permission &amp;&amp; flags[0] == &#39;r&#39; &amp;&amp; flags[2] == &#39;x&#39;) {
</a><a href="#h116-0-36" id="h116-0-36" class="d">-                new_prot &amp;= ~PROT_READ;
</a><a href="#h116-0-37" id="h116-0-37" class="d">-            }
</a><a href="#h116-0-38" id="h116-0-38" class="d">-            mprotect((void *)start, section_size, new_prot);
</a><a href="#h116-0-39" id="h116-0-39" class="d">-        }
</a><a href="#h116-0-40" id="h116-0-40" class="d">-        fclose(maps);
</a><a href="#h116-0-41" id="h116-0-41" class="d">-    }
</a><a href="#h116-0-42" id="h116-0-42" class="d">-
</a>     static uintptr_t find_signature(uintptr_t module_base, uintptr_t size, const std::string &amp;pattern, int offset = 0) {
         std::vector&lt;char&gt; bytes;
         std::vector&lt;char&gt; mask;
<b>diff --git a/<a id="h117" href="../file/native/src/main/kotlin/me/rhunk/snapenhance/nativelib/NativeConfig.kt.html">native/src/main/kotlin/me/rhunk/snapenhance/nativelib/NativeConfig.kt</a> b/<a href="../file/native/src/main/kotlin/me/rhunk/snapenhance/nativelib/NativeConfig.kt.html">native/src/main/kotlin/me/rhunk/snapenhance/nativelib/NativeConfig.kt</a></b>
<a href="#h117-0" id="h117-0" class="h">@@ -8,7 +8,5 @@ data class NativeConfig(
</a>     @JvmField
     val composerHooks: Boolean = false,
     @JvmField
<a href="#h117-0-3" id="h117-0-3" class="d">-    val remapExecutable: Boolean = false,
</a><a href="#h117-0-4" id="h117-0-4" class="d">-    @JvmField
</a>     val customEmojiFontPath: String? = null,
 ) 
\ No newline at end of file
<b>diff --git a/<a id="h118" href="../file/native/src/main/kotlin/me/rhunk/snapenhance/nativelib/NativeLib.kt.html">native/src/main/kotlin/me/rhunk/snapenhance/nativelib/NativeLib.kt</a> b/<a href="../file/native/src/main/kotlin/me/rhunk/snapenhance/nativelib/NativeLib.kt.html">native/src/main/kotlin/me/rhunk/snapenhance/nativelib/NativeLib.kt</a></b>
<a href="#h118-0" id="h118-0" class="h">@@ -1,6 +1,9 @@
</a> package me.rhunk.snapenhance.nativelib
 
<a href="#h118-0-2" id="h118-0-2" class="i">+import android.annotation.SuppressLint
</a> import android.util.Log
<a href="#h118-0-4" id="h118-0-4" class="i">+import kotlin.math.absoluteValue
</a><a href="#h118-0-5" id="h118-0-5" class="i">+import kotlin.random.Random
</a> 
 @Suppress(&quot;KotlinJniMissingFunction&quot;)
 class NativeLib {
<a href="#h118-1" id="h118-1" class="h">@@ -11,19 +14,21 @@ class NativeLib {
</a>             private set
     }
 
<a href="#h118-1-3" id="h118-1-3" class="d">-    fun initOnce(callback: NativeLib.() -&gt; Unit) {
</a><a href="#h118-1-4" id="h118-1-4" class="i">+    fun initOnce(callback: NativeLib.() -&gt; Unit): () -&gt; Unit {
</a>         if (initialized) throw IllegalStateException(&quot;NativeLib already initialized&quot;)
<a href="#h118-1-6" id="h118-1-6" class="d">-        runCatching {
</a><a href="#h118-1-7" id="h118-1-7" class="i">+        return runCatching {
</a>             System.loadLibrary(BuildConfig.NATIVE_NAME)
             initialized = true
             callback(this)
<a href="#h118-1-11" id="h118-1-11" class="d">-            if (!init()) {
</a><a href="#h118-1-12" id="h118-1-12" class="d">-                throw IllegalStateException(&quot;NativeLib init failed. Check logcat for more info&quot;)
</a><a href="#h118-1-13" id="h118-1-13" class="i">+            return@runCatching {
</a><a href="#h118-1-14" id="h118-1-14" class="i">+                if (!init()) {
</a><a href="#h118-1-15" id="h118-1-15" class="i">+                    throw IllegalStateException(&quot;NativeLib init failed. Check logcat for more info&quot;)
</a><a href="#h118-1-16" id="h118-1-16" class="i">+                }
</a>             }
         }.onFailure {
             initialized = false
             Log.e(&quot;SnapEnhance&quot;, &quot;NativeLib init failed&quot;, it)
<a href="#h118-1-21" id="h118-1-21" class="d">-        }
</a><a href="#h118-1-22" id="h118-1-22" class="i">+        }.getOrThrow()
</a>     }
 
     @Suppress(&quot;unused&quot;)
<a href="#h118-2" id="h118-2" class="h">@@ -54,10 +59,18 @@ class NativeLib {
</a>         }
     }
 
<a href="#h118-2-3" id="h118-2-3" class="i">+    @SuppressLint(&quot;UnsafeDynamicallyLoadedCode&quot;)
</a><a href="#h118-2-4" id="h118-2-4" class="i">+    fun loadSharedLibrary(content: ByteArray) {
</a><a href="#h118-2-5" id="h118-2-5" class="i">+        if (!initialized) throw IllegalStateException(&quot;NativeLib not initialized&quot;)
</a><a href="#h118-2-6" id="h118-2-6" class="i">+        val generatedPath = &quot;/data/app/${Random.nextLong().absoluteValue.toString(16)}.so&quot;
</a><a href="#h118-2-7" id="h118-2-7" class="i">+        addLinkerSharedLibrary(generatedPath, content)
</a><a href="#h118-2-8" id="h118-2-8" class="i">+        System.load(generatedPath)
</a><a href="#h118-2-9" id="h118-2-9" class="i">+    }
</a><a href="#h118-2-10" id="h118-2-10" class="i">+
</a>     private external fun init(): Boolean
     private external fun loadConfig(config: NativeConfig)
     private external fun lockDatabase(name: String, callback: Runnable)
     external fun setComposerLoader(code: String)
     external fun composerEval(code: String): String?
<a href="#h118-2-16" id="h118-2-16" class="d">-    external fun hideAnonymousDexFiles()
</a><a href="#h118-2-17" id="h118-2-17" class="i">+    private external fun addLinkerSharedLibrary(path: String, content: ByteArray)
</a> } 
\ No newline at end of file
</pre>
</div>
</body>
</html>
